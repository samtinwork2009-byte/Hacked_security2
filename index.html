<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <!-- ===== 2. CSS 樣式注入 ===== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>對戰模式第二季 • 執法對決 SEASON 2 | Cyber Attack Simulation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== 基礎重置 ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', 'Consolas', 'Monaco', monospace;
        }

        body {
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 100%);
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }
        

        /* ===== 終端動效與新樣式 ===== */
        .terminal-line {
            overflow: hidden;
            white-space: pre-wrap;
            border-right: .15em solid transparent;
            animation: typing 1.5s steps(40, end);
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #6ab0ff);
            width: 0%;
            transition: width 0.3s ease;
        }

        .node-action-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .node-action-btn {
            padding: 5px 12px;
            border-radius: 4px;
            border: 1px solid #4a90d9;
            background: rgba(74, 144, 217, 0.1);
            color: #4a90d9;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .node-action-btn:hover {
            background: #4a90d9;
            color: #000;
        }

        /* ===== 屏幕效果 ===== */
        .screen-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .scanlines {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 100, 255, 0.03) 50%
            );
            background-size: 100% 4px;
        }

        /* ===== 頁面管理 ===== */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            transition: opacity 0.3s ease;
            display: none;
        }

        .page.active {
            display: block;
            opacity: 1;
            position: relative;
            z-index: 2;
        }

        .page.hidden {
            display: none;
            opacity: 0;
        }

        /* ===== 導航欄樣式 ===== */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(10, 10, 30, 0.95));
            border-bottom: 2px solid rgba(0, 100, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 100, 255, 0.2);
        }

        .nav-logo {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4a90d9;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px rgba(74, 144, 217, 0.5);
            white-space: nowrap;
            min-width: fit-content;
        }

        .nav-logo:hover {
            filter: drop-shadow(0 0 15px rgba(74, 144, 217, 0.7));
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            list-style: none;
            margin: 0;
            padding: 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-menu li a {
            color: #aaa;
            text-decoration: none;
            font-size: 0.95rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 4px;
        }

        .nav-menu li a:hover {
            color: #4a90d9;
            background: rgba(74, 144, 217, 0.1);
            box-shadow: 0 0 10px rgba(74, 144, 217, 0.3);
        }

        .nav-menu li a.active {
            color: #4a90d9;
            border-bottom: 2px solid #4a90d9;
        }

        /* ===== 漢堡菜單樣式 ===== */
        .hamburger-menu {
            display: none;
            flex-direction: column;
            cursor: pointer;
            gap: 6px;
            z-index: 1001;
            background: none;
            border: none;
            padding: 5px;
            margin: 0;
        }

        .hamburger-menu span {
            width: 25px;
            height: 3px;
            background: #4a90d9;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger-menu.active span:nth-child(1) {
            transform: rotate(45deg) translate(8px, 8px);
        }

        .hamburger-menu.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        /* 移動端導航菜單 */
        .nav-menu-mobile {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 30, 0.98), rgba(5, 5, 15, 0.98));
            border-bottom: 2px solid rgba(0, 100, 255, 0.3);
            flex-direction: column;
            padding: 15px 0;
            z-index: 999;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
            max-height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .nav-menu-mobile.active {
            display: flex;
        }

        .nav-menu-mobile li {
            list-style: none;
            border-bottom: 1px solid rgba(74, 144, 217, 0.1);
        }

        .nav-menu-mobile li:last-child {
            border-bottom: none;
        }

        .nav-menu-mobile li a {
            display: block;
            padding: 12px 20px;
            color: #aaa;
            text-decoration: none;
            font-size: 0.95rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-menu-mobile li a:hover {
            color: #4a90d9;
            background: rgba(74, 144, 217, 0.1);
            padding-left: 25px;
        }

        .nav-menu-mobile li a.active {
            color: #4a90d9;
            background: rgba(74, 144, 217, 0.15);
            border-left: 3px solid #4a90d9;
            padding-left: 17px;
        }


        
    /* 暗網聯絡站升級樣式 */
    .darknet-layout {
        display: grid;
        grid-template-columns: 300px 1fr 300px;
        gap: 20px;
        height: 700px;
        margin-top: 20px;
    }

    .darknet-sidebar {
        background: rgba(0, 20, 0, 0.8);
        border: 1px solid #00ff41;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .darknet-chat-area {
        background: rgba(0, 10, 0, 0.9);
        border: 1px solid #00ff41;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    .darknet-chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: #00ff41;
    }

    .chat-msg {
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(0, 255, 65, 0.1);
        padding-bottom: 8px;
    }

    .chat-user {
        font-weight: bold;
        margin-right: 10px;
        color: #fff;
        text-shadow: 0 0 5px #00ff41;
    }

    .chat-time {
        font-size: 0.7rem;
        color: #008800;
        float: right;
    }

    .darknet-chat-input {
        padding: 15px;
        background: rgba(0, 40, 0, 0.8);
        border-top: 1px solid #00ff41;
        display: flex;
        gap: 10px;
    }

    .darknet-input {
        flex: 1;
        background: #000;
        border: 1px solid #00ff41;
        color: #00ff41;
        padding: 8px 12px;
        border-radius: 4px;
        outline: none;
    }

    .darknet-send-btn {
        background: #00ff41;
        color: #000;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

    .darknet-contact-item {
        padding: 10px;
        border: 1px solid rgba(0, 255, 65, 0.3);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .darknet-contact-item:hover {
        background: rgba(0, 255, 65, 0.1);
        border-color: #00ff41;
    }

    .darknet-contact-item.active {
        background: rgba(0, 255, 65, 0.2);
        border-color: #00ff41;
        box-shadow: inset 0 0 10px rgba(0, 255, 65, 0.2);
    }

    .chat-text {
        word-break: break-all;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #00ff41;
        box-shadow: 0 0 5px #00ff41;
    }

    .darknet-market-panel {
        background: rgba(20, 0, 20, 0.8);
        border: 1px solid #bc13fe;
        border-radius: 8px;
        padding: 15px;
        color: #bc13fe;
    }

    .market-item {
        padding: 10px;
        border-bottom: 1px solid rgba(188, 19, 254, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
    }

    .market-buy-btn {
        background: transparent;
        border: 1px solid #bc13fe;
        color: #bc13fe;
        padding: 3px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.75rem;
    }

    .market-buy-btn:hover {
        background: #bc13fe;
        color: #000;
    }
    
/* ===== 暗網聯絡站樣式 ===== */
        #darknet-hub-page {
            background: linear-gradient(135deg, #050505 0%, #0a0a0a 100%);
            padding: 80px 20px 40px;
            min-height: 100vh;
        }

        .darknet-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .darknet-header {
            text-align: center;
            margin-bottom: 50px;
            padding: 30px;
            border: 2px solid #00ff41;
            border-radius: 10px;
            background: rgba(0, 255, 65, 0.05);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .darknet-title {
            font-size: 2.5rem;
            color: #00ff41;
            text-shadow: 0 0 15px #00ff41;
            margin-bottom: 10px;
            letter-spacing: 3px;
            font-family: 'Courier New', monospace;
        }

        .darknet-subtitle {
            color: #00aa00;
            font-size: 0.9rem;
            letter-spacing: 2px;
        }

        .darknet-services {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .service-card {
            background: rgba(0, 255, 65, 0.05);
            border: 2px solid #00ff41;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.1);
        }

        .service-card:hover {
            background: rgba(0, 255, 65, 0.15);
            box-shadow: 0 0 25px rgba(0, 255, 65, 0.3);
            transform: translateY(-5px);
        }

        .service-icon {
            font-size: 2.5rem;
            color: #00ff41;
            margin-bottom: 15px;
        }

        .service-name {
            font-size: 1.2rem;
            color: #00ff41;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .service-desc {
            color: #00aa00;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .service-price {
            color: #ffff00;
            font-size: 1rem;
            font-weight: bold;
        }

        /* ===== 操作指南頁面樣式 ===== */
        #guide-page {
            background: linear-gradient(135deg, #0a0a1a 0%, #050510 100%);
            padding: 80px 20px 40px;
            min-height: 100vh;
        }

        .guide-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .guide-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .guide-title {
            font-size: 2.5rem;
            color: #4a90d9;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(74, 144, 217, 0.5);
        }

        .guide-sections {
            display: grid;
            gap: 30px;
        }

        .guide-section {
            background: rgba(25, 25, 40, 0.8);
            border-left: 4px solid #4a90d9;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .guide-section-title {
            font-size: 1.5rem;
            color: #4a90d9;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .guide-section-content {
            color: #ccc;
            line-height: 1.8;
            font-size: 0.95rem;
        }

        .guide-step {
            margin: 15px 0;
            padding: 10px;
            background: rgba(74, 144, 217, 0.05);
            border-radius: 4px;
            border-left: 3px solid #4a90d9;
            padding-left: 15px;
        }

        .guide-step-title {
            color: #4a90d9;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* ===== 優化商店頁面樣式 ===== */
        #shop-page {
            background: linear-gradient(135deg, #0a0a1a 0%, #050510 100%);
            padding: 80px 20px 40px;
            min-height: 100vh;
        }

        .shop-container-full {
            max-width: 1200px;
            margin: 0 auto;
        }

        .shop-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .shop-title {
            font-size: 2.5rem;
            color: #ff9900;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        }

        .shop-categories-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-btn {
            padding: 10px 20px;
            background: rgba(255, 153, 0, 0.1);
            border: 2px solid #ff9900;
            color: #ff9900;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .category-btn:hover,
        .category-btn.active {
            background: #ff9900;
            color: #000;
        }

        .shop-items-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .shop-item-full {
            background: rgba(25, 25, 40, 0.9);
            border: 2px solid rgba(255, 153, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .shop-item-full:hover {
            border-color: #ff9900;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.3);
            transform: translateY(-5px);
        }

        .shop-item-icon-full {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ff9900;
        }

        .shop-item-name-full {
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .shop-item-desc-full {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 15px;
            min-height: 40px;
        }

        .shop-item-price-full {
            color: #ffff00;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .shop-item-buy-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #ff9900, #ff6600);
            border: none;
            color: #000;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .shop-item-buy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
        }

        /* ===== 平板設備媒體查詢 (768px - 1024px) ===== */
        @media (max-width: 1024px) and (min-width: 769px) {
            nav {
                padding: 0 15px;
                height: 55px;
            }

            .nav-menu {
                gap: 15px;
            }

            .nav-menu li a {
                font-size: 0.85rem;
                padding: 6px 12px;
            }

            .nav-logo {
                font-size: 1.1rem;
                letter-spacing: 1px;
            }

            .main-logo {
                font-size: 2.5rem;
            }

            .special-skills-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ===== 手機設備媒體查詢 (最大768px) ===== */
        @media (max-width: 768px) {
            /* 導航欄調整 */
            nav {
                height: 50px;
                padding: 0 15px;
            }

            .nav-logo {
                font-size: 1rem;
                letter-spacing: 1px;
            }

            .nav-menu {
                display: none;
                gap: 0;
            }

            .hamburger-menu {
                display: flex;
            }

            .hamburger-menu span {
                width: 22px;
                height: 2.5px;
            }

            .nav-menu-mobile li a {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            /* 主頁面調整 */
            #main-page {
                padding: 70px 15px 30px;
            }

            .main-logo {
                font-size: 2rem;
                letter-spacing: 2px;
            }

            .season-badge {
                font-size: 0.8rem;
                padding: 6px 15px;
            }

            /* 標題調整 */
            .darknet-title {
                font-size: 1.5rem;
            }
            .guide-title {
                font-size: 1.5rem;
            }
            .shop-title {
                font-size: 1.5rem;
            }

            /* 網格布局調整 */
            .darknet-services {
                grid-template-columns: 1fr;
            }
            .shop-items-display {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            /* 特殊技能調整 */
            .special-skills-grid {
                grid-template-columns: 1fr;
            }

            .special-skill-card {
                min-height: 150px;
                padding: 15px;
            }

            /* 暗網佈局調整 */
            .darknet-layout {
                grid-template-columns: 1fr;
                height: auto;
                gap: 15px;
            }

            .darknet-sidebar {
                max-height: 300px;
            }

            .darknet-chat-area {
                height: 400px;
            }

            /* 按鈕調整 */
            button {
                padding: 8px 12px !important;
                font-size: 0.85rem;
            }
        }

        /* ===== 小屏幕手機媒體查詢 (最大480px) ===== */
        @media (max-width: 480px) {
            nav {
                height: 50px;
                padding: 0 10px;
            }

            .nav-logo {
                font-size: 0.9rem;
            }

            .main-logo {
                font-size: 1.5rem;
                letter-spacing: 1px;
            }

            .season-badge {
                font-size: 0.7rem;
                padding: 5px 12px;
            }

            #main-page {
                padding: 60px 10px 20px;
            }

            .main-header {
                margin-bottom: 20px;
            }

            .darknet-title,
            .guide-title,
            .shop-title {
                font-size: 1.2rem;
            }

            .special-skills-panel {
                padding: 15px;
                margin-top: 15px;
            }

            .special-skill-card {
                min-height: 140px;
                padding: 12px;
            }

            .special-skill-card .tool-icon {
                font-size: 1.5rem;
            }

            .special-skill-card .tool-name {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }

            .darknet-chat-area {
                height: 350px;
            }
        }

        @media (max-width: 768px) {
            .darknet-title {
                font-size: 1.8rem;
            }
            .guide-title {
                font-size: 1.8rem;
            }
            .shop-title {
                font-size: 1.8rem;
            }
            .darknet-services {
                grid-template-columns: 1fr;
            }
            .shop-items-display {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        /* ===== 主頁面樣式 ===== */
        #main-page {
            background: linear-gradient(135deg, #0a0a1a 0%, #050510 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px 40px;
        }

        .main-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 0 20px;
        }

        .season-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff9900 0%, #ff6600 100%);
            color: #000;
            font-weight: bold;
            padding: 8px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
            text-transform: uppercase;
        }

        .main-logo {
            font-size: 3.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #4a90d9 0%, #357abd 25%, #6ab0ff 50%, #4a90d9 75%, #7bbfff 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(74, 144, 217, 0.6), 0 0 40px rgba(74, 144, 217, 0.3);
            margin-bottom: 20px;
            letter-spacing: 4px;
            animation: logoShine 4s ease-in-out infinite;
            text-align: center;
            filter: drop-shadow(0 0 25px rgba(74, 144, 217, 0.5));
        }

        @keyframes logoShine {
            0%, 100% {
                background-position: 0% 50%;
                filter: drop-shadow(0 0 25px rgba(74, 144, 217, 0.5));
            }
            50% {
                background-position: 100% 50%;
                filter: drop-shadow(0 0 40px rgba(74, 144, 217, 0.7));
            }
        }

        .main-subtitle {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 10px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-align: center;
        }

        .main-tagline {
            color: #666;
            font-size: 1rem;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto 40px;
            text-align: center;
        }

        /* ===== 模式選擇 ===== */
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            padding: 0 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .mode-selection {
                grid-template-columns: 1fr;
                max-width: 500px;
            }
        }

        .mode-card {
            background: rgba(25, 25, 40, 0.95);
            border-radius: 15px;
            padding: 35px 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .mode-card:hover::before {
            left: 100%;
        }

        .mode-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
        }

        .mode-card.hacker {
            border-color: #00ff41;
            box-shadow: 0 0 25px rgba(0, 255, 65, 0.2);
        }

        .mode-card.hacker:hover {
            box-shadow: 0 0 40px rgba(0, 255, 65, 0.4);
        }

        .mode-card.law-enforcement {
            border-color: #4a90d9;
            box-shadow: 0 0 25px rgba(74, 144, 217, 0.2);
        }

        .mode-card.law-enforcement:hover {
            box-shadow: 0 0 40px rgba(74, 144, 217, 0.4);
        }

        .mode-icon {
            font-size: 3.5rem;
            margin-bottom: 25px;
            text-align: center;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-card.hacker .mode-icon {
            color: #00ff41;
        }

        .mode-card.law-enforcement .mode-icon {
            color: #4a90d9;
        }

        .mode-title {
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .mode-card.hacker .mode-title {
            color: #00ff41;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .mode-card.law-enforcement .mode-title {
            color: #4a90d9;
            text-shadow: 0 0 10px rgba(74, 144, 217, 0.5);
        }

        .mode-description {
            color: #bbb;
            line-height: 1.7;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.05rem;
        }

        .mode-features {
            list-style: none;
            margin-bottom: 30px;
        }

        .mode-features li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            padding-left: 30px;
            display: flex;
            align-items: center;
        }

        .mode-features li:before {
            content: "⟩";
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .mode-card.hacker .mode-features li:before {
            color: #00ff41;
        }

        .mode-card.law-enforcement .mode-features li:before {
            color: #4a90d9;
        }

        .feature-icon {
            margin-right: 12px;
            font-size: 1rem;
            width: 22px;
            text-align: center;
        }

        .select-btn {
            display: block;
            width: 100%;
            padding: 18px;
            text-align: center;
            border-radius: 10px;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .select-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .select-btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .hacker-btn {
            background: rgba(0, 255, 65, 0.15);
            color: #00ff41;
            border: 2px solid #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .hacker-btn:hover {
            background: rgba(0, 255, 65, 0.25);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.5), inset 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .law-enforcement-btn {
            background: rgba(74, 144, 217, 0.15);
            color: #4a90d9;
            border: 2px solid #4a90d9;
            box-shadow: 0 0 20px rgba(74, 144, 217, 0.2);
        }

        .law-enforcement-btn:hover {
            background: rgba(74, 144, 217, 0.25);
            box-shadow: 0 0 30px rgba(74, 144, 217, 0.5), inset 0 0 20px rgba(74, 144, 217, 0.1);
        }

        /* ===== 對戰設置頁面 ===== */
        #season2-setup-page .main-header {
            margin-bottom: 30px;
        }

        .setup-container {
            background: rgba(25, 25, 40, 0.95);
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 40px;
            border: 2px solid rgba(74, 144, 217, 0.3);
            box-shadow: 0 0 30px rgba(74, 144, 217, 0.2);
        }

        .setup-title {
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-align: center;
            color: #4a90d9;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .setup-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setup-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #4a90d9;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 1.05rem;
        }

        .setting-input {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(74, 144, 217, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .setting-input:focus {
            outline: none;
            border-color: #4a90d9;
            box-shadow: 0 0 10px rgba(74, 144, 217, 0.3);
        }

        .setting-input::placeholder {
            color: #666;
        }

        .setting-note {
            color: #888;
            font-size: 0.9rem;
            margin-top: 8px;
            line-height: 1.5;
        }

        .difficulty-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .difficulty-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(74, 144, 217, 0.2);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .difficulty-card:hover {
            background: rgba(74, 144, 217, 0.1);
            border-color: rgba(74, 144, 217, 0.5);
        }

        .difficulty-card.selected {
            background: rgba(74, 144, 217, 0.2);
            border-color: #4a90d9;
            box-shadow: 0 0 15px rgba(74, 144, 217, 0.4);
        }

        .difficulty-level {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4a90d9;
        }

        .difficulty-desc {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .difficulty-time {
            color: #ff9900;
            font-weight: bold;
        }

        /* ===== 遊戲頁面通用樣式 ===== */
        .game-container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 80px 20px 20px;
            min-height: 100vh;
        }

        /* 黑客模式主題 */
        .hacker-ui {
            --primary-color: #00ff41;
            --secondary-color: #0088ff;
            --danger-color: #ff3333;
            --bg-color: rgba(10, 30, 20, 0.95);
            --panel-bg: rgba(5, 15, 10, 0.9);
            --text-color: #e0ffe0;
        }

        /* 執法部門主題 */
        .law-enforcement-ui {
            --primary-color: #4a90d9;
            --secondary-color: #6ab0ff;
            --danger-color: #ff3333;
            --bg-color: rgba(20, 20, 40, 0.95);
            --panel-bg: rgba(15, 15, 30, 0.9);
            --text-color: #e0e0ff;
        }

        /* 遊戲頭部 */
        .game-header {
            background: var(--bg-color);
            border-radius: 15px;
            padding: 25px 30px;
            margin-bottom: 30px;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .game-title-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .game-mode-icon {
            font-size: 3rem;
            color: var(--primary-color);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
            letter-spacing: 2px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff41;
            animation: pulse 2s infinite;
        }
            /* Additional styles for status indicator */
            .status-indicator.active {
                background: #00ff41;
            }
            .status-indicator.disconnected {
                background: #ff3333;
                animation: none;
            }
        .status-indicator.disconnected {
            background: #ff3333;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .target-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
        }

        .target-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .target-ip {
            font-family: 'Monaco', monospace;
            color: var(--primary-color);
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .game-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
            width: 100%;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px 25px;
            border: 1px solid var(--primary-color);
            min-width: 180px;
            flex: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* 執法部門專用統計卡片 */
        .evidence-stat {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px 25px;
            border: 1px solid #4a90d9;
            min-width: 180px;
            flex: 1;
        }

        .evidence-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .evidence-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4a90d9;
        }

        /* 主遊戲區域 */
        .game-main {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1400px) {
            .game-main {
                grid-template-columns: 1fr;
            }
        }

        /* 左側主面板 */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Make tools and special skills panels flow vertically and scroll internally to avoid overlap */
        .left-panel > .tools-panel, .left-panel > .special-skills-panel {
            max-height: 520px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 終端機 */
        .terminal-container {
            background: rgba(5, 5, 5, 0.95);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }

        .terminal-header {
            background: linear-gradient(90deg, 
                rgba(0, 0, 0, 0.8), 
                rgba(20, 20, 30, 0.8));
            padding: 20px;
            border-bottom: 1px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .terminal-status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .terminal-body {
            padding: 25px;
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            max-height: 500px;
        }

        .terminal-body::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .terminal-body::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .terminal-output {
            flex: 1;
            margin-bottom: 20px;
        }

        .terminal-line {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.3s ease;
            word-break: break-word;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .terminal-line.command {
            color: var(--primary-color);
            font-weight: bold;
            border-left: 3px solid var(--primary-color);
        }

        .terminal-line.response {
            color: var(--secondary-color);
        }

        .terminal-line.success {
            color: #00ff88;
            border-left: 3px solid #00ff88;
        }

        .terminal-line.error {
            color: #ff5555;
            border-left: 3px solid #ff5555;
        }

        .terminal-line.warning {
            color: #ffaa00;
            border-left: 3px solid #ffaa00;
        }

        .terminal-line.system {
            color: #aaa;
            font-style: italic;
        }

        .terminal-line.alert {
            color: #ff3333;
            background: rgba(255, 51, 51, 0.1);
            border-left: 3px solid #ff3333;
            animation: alertPulse 1s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .terminal-input-container {
            display: flex;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .terminal-prompt {
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 15px;
            min-width: 150px;
            font-family: 'Monaco', monospace;
        }

        .terminal-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.1rem;
            flex: 1;
            outline: none;
            caret-color: var(--primary-color);
            font-family: 'Monaco', monospace;
        }

        .input-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .suggestion-btn {
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: #ccc;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* 工具面板 */
        .tools-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
            min-height: 300px;
            /* ensure tools-panel stays in normal flow and is above special skills panel */
            position: relative !important;
            z-index: 3 !important;
            margin-bottom: 12px !important;
        }

        .tools-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tools-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn.active {
            background: var(--primary-color);
            color: black;
            border-color: var(--primary-color);
        }

        .category-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .tool-card {
            background: linear-gradient(135deg, rgba(0, 150, 255, 0.3), rgba(0, 100, 200, 0.3));
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #0099ff;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 150, 255, 0.5);
            background: linear-gradient(135deg, rgba(0, 180, 255, 0.5), rgba(0, 130, 230, 0.5));
            border-color: #00ccff;
        }

        .tool-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tool-card.disabled:hover {
            transform: none;
            box-shadow: none;
            background: rgba(30, 30, 40, 0.8);
        }

        .law-enforcement-ui .tool-card {
            background: linear-gradient(135deg, rgba(74, 144, 217, 0.3), rgba(53, 122, 189, 0.3));
            border-color: #4a90d9;
        }

        .law-enforcement-ui .tool-card:hover {
            border-color: #6ab0ff;
            box-shadow: 0 0 20px rgba(74, 144, 217, 0.7);
            background: linear-gradient(135deg, rgba(100, 170, 255, 0.5), rgba(74, 144, 217, 0.5));
        }

        .tool-icon {
            font-size: 2.5rem;
            color: #00ff99;
            margin-bottom: 15px;
        }

        /* ===== 特殊技能面板 ===== */
    .special-skills-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #ff9900;
            margin-top: 20px;
            min-height: 200px;
            /* Ensure panel participates in normal flow to avoid overlapping tools-panel */
            position: relative !important;
            z-index: 2 !important;
            margin-top: 8px !important;
        }

        /* Stronger selectors to prevent other rules/scripts from causing overlap */
        .left-panel > .tools-panel {
            position: relative !important;
            z-index: 1000 !important;
        }

        .left-panel > .special-skills-panel {
            position: relative !important;
            z-index: 900 !important;
        }

        .special-skills-panel .tools-title {
            color: #ff9900;
        }

        .special-skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .special-skill-card {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.3), rgba(255, 102, 0, 0.3));
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #ff9900;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .special-skill-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 153, 0, 0.5);
            background: linear-gradient(135deg, rgba(255, 180, 0, 0.5), rgba(255, 130, 0, 0.5));
            border-color: #ffcc00;
        }

        .special-skill-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .special-skill-card.disabled:hover {
            transform: none;
            box-shadow: none;
            background: rgba(30, 30, 40, 0.8);
        }

        .special-skill-card .tool-icon {
            color: #ffcc00;
        }

        .special-skill-card .tool-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }

        .special-skill-card .tool-desc {
            font-size: 0.85rem;
            color: #ccc;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        .special-skill-card .skill-cost {
            font-size: 0.9rem;
            color: #ffcc00;
            font-weight: bold;
        }

        .special-skill-card .cooldown-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .law-enforcement-ui .tool-icon {
            color: #6ab0ff;
        }

        .tool-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffffff;
            font-size: 1.1rem;
            text-shadow: 0 0 5px rgba(0, 255, 153, 0.5);
        }

        .law-enforcement-ui .tool-name {
            color: #ffffff;
            text-shadow: 0 0 5px rgba(74, 144, 217, 0.5);
        }

        .tool-desc {
            color: #cccccc;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .tool-cooldown {
            font-size: 0.8rem;
            color: #ffaa00;
            margin-top: 10px;
        }

        /* 右側面板 */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 對戰信息面板 */
        .battle-info {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
        }

        .battle-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .opponent-info {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .opponent-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .opponent-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .detail-value {
            font-family: 'Monaco', monospace;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* 證據面板（執法部門專用） */
        .evidence-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
        }

        .evidence-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .evidence-chain {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
            max-height: 250px;
            overflow-y: auto;
        }

        .evidence-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 4px solid #4a90d9;
            transition: all 0.3s;
        }

        .evidence-item.contaminated {
            border-left-color: #ff3333;
            background: rgba(255, 51, 51, 0.1);
        }

        .evidence-item.critical {
            border-left-color: #ff9900;
            background: rgba(255, 153, 0, 0.1);
        }

        .evidence-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #fff;
        }

        .evidence-desc {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .evidence-status {
            font-size: 0.8rem;
            color: #4a90d9;
        }

        .evidence-status.contaminated {
            color: #ff3333;
        }

        /* 身份鎖定面板（執法部門專用） */
        .identity-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
        }

        .identity-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .identity-tiers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .identity-tier {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--secondary-color);
        }

        .tier-name {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .tier-progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .tier-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #6ab0ff);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .tier-percentage {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .tier-requirement {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        /* 逮捕令面板 */
        .warrant-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .warrant-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .warrant-label {
            font-size: 1rem;
            color: #aaa;
        }

        .warrant-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9900;
        }

        .warrant-progress {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .warrant-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9900, #ffcc00);
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .warrant-actions {
            display: flex;
            gap: 10px;
        }

        /* 控制按鈕 */
        .game-controls {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn { transition: all 0.3s; position: relative; overflow: hidden; 
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid;
            font-size: 1rem;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.3);
        }

        .btn:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 15px currentColor;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(255, 51, 51, 0.2);
            color: #ff3333;
            border-color: #ff3333;
        }

        .btn-success {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
            border-color: #00ff41;
        }

        .btn-warning {
            background: rgba(255, 153, 0, 0.2);
            color: #ff9900;
            border-color: #ff9900;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: #666;
        }

        /* 通知系統 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 30, 0.95);
            border-left: 4px solid;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.hacker {
            border-left-color: #00ff41;
        }

        .notification.law-enforcement {
            border-left-color: #4a90d9;
        }

        .notification.warning {
            border-left-color: #ffaa00;
        }

        .notification.danger {
            border-left-color: #ff3333;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-message {
            color: #ccc;
            line-height: 1.5;
        }

        /* ===== 響應式設計 ===== */
        @media (max-width: 1200px) {
            .game-main {
                grid-template-columns: 1fr;
            }
            
            .identity-tiers {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-logo {
                font-size: 2.5rem;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
                max-width: 500px;
                margin: 0 auto 30px;
            }

            .mode-card {
                padding: 25px 20px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .game-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .game-stats {
                justify-content: center;
            }
            
            .stat-card, .evidence-stat {
                min-width: 140px;
            }
            
            .tools-grid {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                justify-content: center;
            }
            
            .difficulty-options {
                grid-template-columns: 1fr;
            }
            
            nav {
                padding: 0 15px;
            }
            
            .nav-menu {
                gap: 15px;
            }
            
            .nav-menu li a {
                padding: 6px 10px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .main-logo {
                font-size: 2rem;
            }
            
            .mode-title {
                font-size: 1.5rem;
            }
            
            .game-title {
                font-size: 1.8rem;
            }
            
            .stat-card, .evidence-stat {
                min-width: 100%;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .setup-container {
                padding: 20px;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
                padding: 0 10px;
            }
            
            .terminal-container {
                min-height: 300px;
            }
            
            .game-main {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .tools-grid {
                grid-template-columns: 1fr;
            }
            
            .game-header {
                flex-direction: column;
                padding: 15px 20px;
            }
            
            nav {
                padding: 0 10px;
                height: 50px;
            }
            
            .nav-menu {
                gap: 8px;
            }
            
            .nav-menu li a {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .modal-box {
                max-width: 95%;
                padding: 15px;
            }
        }

        /* ===== 自定義模態框 ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 2px solid #4a90d9;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(74, 144, 217, 0.3);
            position: relative;
        }

        .modal-title {
            color: #4a90d9;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-message {
            color: #ccc;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-input {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(74, 144, 217, 0.5);
            border-radius: 8px;
            color: #4a90d9;
            font-family: inherit;
            font-size: 16px;
            margin-bottom: 25px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #4a90d9;
            box-shadow: 0 0 10px rgba(74, 144, 217, 0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .modal-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .modal-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%);
            color: #fff;
        }

        .modal-btn-confirm:hover {
            box-shadow: 0 0 15px rgba(74, 144, 217, 0.5);
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
            color: #fff;
        }

        .modal-btn-danger:hover {
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.5);
        }

        /* ===== 結果頁面 ===== */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .result-overlay.active {
            display: flex;
        }

        .result-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 95%;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.7);
            border: 3px solid;
            animation: resultPulse 2s infinite;
        }

        @keyframes resultPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(74, 144, 217, 0.5); }
            50% { box-shadow: 0 0 50px rgba(74, 144, 217, 0.8); }
        }

        .result-box.victory {
            border-color: #00ff41;
        }

        .result-box.defeat {
            border-color: #ff3333;
        }

        .result-box.arrest {
            border-color: #4a90d9;
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 15px currentColor);
        }

        .result-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .result-box.victory .result-title {
            color: #00ff41;
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .result-box.defeat .result-title {
            color: #ff3333;
            text-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
        }

        .result-box.arrest .result-title {
            color: #4a90d9;
            text-shadow: 0 0 20px rgba(74, 144, 217, 0.5);
        }

        .result-message {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .result-stats {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
        }

        .result-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-stat:last-child {
            border-bottom: none;
        }

        .result-stat-label {
            color: #aaa;
        }

        .result-stat-value {
            color: #fff;
            font-weight: bold;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .result-btn {
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            border: 2px solid;
        }

        .result-btn-primary {
            background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%);
            color: #fff;
            border-color: #4a90d9;
        }

        .result-btn-primary:hover {
            box-shadow: 0 0 20px rgba(74, 144, 217, 0.5);
        }

        .result-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: #666;
        }

        .result-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 新增加的樣式 */
        .department-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .department-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .department-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-active {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }

        .status-inactive {
            background: rgba(255, 51, 51, 0.2);
            color: #ff3333;
        }

        .department-resources {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .resource-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .resource-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .resource-value {
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
        }

        .critical-evidence {
            background: rgba(255, 153, 0, 0.2);
            border-left: 4px solid #ff9900;
            animation: pulseCritical 2s infinite;
        }

        @keyframes pulseCritical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .evidence-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .evidence-action-btn {
            padding: 5px 10px;
            background: rgba(74, 144, 217, 0.3);
            border: 1px solid #4a90d9;
            border-radius: 4px;
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .evidence-action-btn:hover {
            background: rgba(74, 144, 217, 0.5);
        }

        .arrest-countdown {
            background: rgba(255, 153, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            animation: pulseArrest 1s infinite;
        }

        @keyframes pulseArrest {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 153, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 153, 0, 0.8); }
        }

        .arrest-timer {
            font-size: 2rem;
            font-weight: bold;
            color: #ff9900;
            margin: 10px 0;
        }

        .server-health {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .health-bar {
            flex: 1;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff41, #00aa00);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .health-text {
            font-size: 0.9rem;
            color: #fff;
            min-width: 40px;
        }

        .investigation-report {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }

        .report-line {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .evidence-quality {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .quality-indicator {
            height: 8px;
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff3333, #ff9900, #00ff41);
            border-radius: 4px;
        }

        /* 新功能樣式 */
        .dynamic-intel-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .intel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .intel-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .intel-verification {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }

        .intel-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .intel-item {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid #4a90d9;
        }

        .intel-item.fake {
            border-left-color: #ff3333;
            background: rgba(255, 51, 51, 0.1);
        }

        .compromised-device {
            background: rgba(255, 153, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ff9900;
        }

        .device-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 4px;
        }

        .info-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 3px;
        }

        .info-value {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #fff;
        }

        .decryption-panel {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ff9900;
        }

        .decryption-progress {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .decryption-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9900, #ffcc00);
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .network-sweep {
            background: rgba(74, 144, 217, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #4a90d9;
            animation: networkSweepPulse 2s infinite;
        }

        @keyframes networkSweepPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(74, 144, 217, 0.5); }
            50% { box-shadow: 0 0 20px rgba(74, 144, 217, 0.8); }
        }

        .fake-command-log {
            background: rgba(255, 51, 51, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ff3333;
            max-height: 150px;
            overflow-y: auto;
        }

        .command-entry {
            padding: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Monaco', monospace;
            font-size: 0.85rem;
        }

        .command-entry.fake {
            color: #ff3333;
        }

        .command-entry.real {
            color: #00ff41;
        }

        .advanced-tool-card {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.3), rgba(255, 102, 0, 0.3));
            border-color: #ff9900;
        }

        .advanced-tool-card:hover {
            border-color: #ffcc00;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.7);
            background: linear-gradient(135deg, rgba(255, 180, 0, 0.5), rgba(255, 130, 0, 0.5));
        }

        .darknet-market {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #00ff41;
        }

        .market-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: rgba(0, 255, 65, 0.1);
            border-radius: 4px;
        }

        .gps-tracker {
            background: rgba(0, 150, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #0096ff;
        }

        .tracker-map {
            height: 100px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .tracker-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff3333;
            animation: trackerPulse 1s infinite;
        }

        @keyframes trackerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        .signal-jammer {
            background: rgba(255, 0, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ff00ff;
            animation: jammerPulse 1.5s infinite;
        }

        @keyframes jammerPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 255, 0.8); }
        }

        /* 截圖風格的版面樣式 */
        .target-system-info {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .system-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .system-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
        }

        .system-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .system-value {
            font-family: 'Monaco', monospace;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .attack-path-visualization {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--primary-color);
        }

        .path-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .path-timeline {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .path-event {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .path-time {
            color: #aaa;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .path-action {
            color: var(--primary-color);
            font-weight: bold;
        }

        .system-status-bars {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .status-label {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .status-percentage {
            font-size: 0.8rem;
            color: #ff9900;
            margin-top: 5px;
        }

        /* 商店系統增強 */
        .shop-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        .shop-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .shop-category {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shop-category.active {
            background: #4a90d9;
            color: #000;
            border-color: #4a90d9;
        }

        .shop-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shop-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .shop-item-name {
            color: #fff;
            font-weight: bold;
        }

        .shop-item-price {
            color: #ff9900;
            font-weight: bold;
        }

        .shop-item-desc {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .shop-item-effect {
            color: #00ff41;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        /* 充值系統 */
        .topup-section {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #ff9900;
        }

        .topup-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .topup-option {
            background: rgba(255, 153, 0, 0.2);
            border: 1px solid #ff9900;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .topup-option:hover {
            background: rgba(255, 153, 0, 0.4);
        }

        .topup-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9900;
        }

        .topup-price {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 5px;
        }

        /* 交易歷史 */
        .transaction-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .transaction-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }

        .transaction-type {
            font-weight: bold;
        }

        .transaction-type.purchase {
            color: #00ff41;
        }

        .transaction-type.topup {
            color: #ff9900;
        }

        .transaction-amount {
            color: #fff;
        }

        .transaction-time {
            color: #aaa;
            font-size: 0.8rem;
        }

        /* 任務目標面板 */
        .mission-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .mission-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mission-item {
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mission-name {
            color: #ccc;
        }

        .mission-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .mission-complete {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }

        .mission-incomplete {
            background: rgba(255, 153, 0, 0.2);
            color: #ff9900;
        }

        /* 攻擊/防禦視覺化 */
        .attack-defense-visualization {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--primary-color);
        }

        .visualization-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-label {
            width: 120px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .progress-container {
            flex: 1;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .attack-progress {
            background: linear-gradient(90deg, #ff3333, #ff9900);
        }

        .defense-progress {
            background: linear-gradient(90deg, #4a90d9, #6ab0ff);
        }

        .stealth-progress {
            background: linear-gradient(90deg, #00ff41, #00aa00);
        }

        /* 擴充的系統健康視覺化 */
        .health-visualization {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .health-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .health-card-title {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .health-card-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .health-card.high {
            border: 1px solid #00ff41;
            color: #00ff41;
        }

        .health-card.medium {
            border: 1px solid #ff9900;
            color: #ff9900;
        }

        .health-card.low {
            border: 1px solid #ff3333;
            color: #ff3333;
        }

        /* 實時目標信息顯示增強 */
        .target-realtime-info {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--secondary-color);
        }

        .realtime-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .realtime-name {
            color: var(--primary-color);
            font-weight: bold;
        }

        .realtime-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }

        .realtime-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .realtime-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .realtime-label {
            font-size: 0.7rem;
            color: #aaa;
            margin-bottom: 3px;
        }

        .realtime-value {
            font-size: 0.9rem;
            color: #fff;
            font-weight: bold;
        }
    
        /* 新增功能樣式 */
        .step-window {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            background: rgba(10, 10, 25, 0.98);
            border: 2px solid #4a90d9;
            border-radius: 10px;
            z-index: 2000;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.5);
            display: none;
        }
        .step-window.active { display: block; }
        .step-header { font-size: 1.2rem; color: #4a90d9; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .step-content { margin-bottom: 20px; }
        .step-item { margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; }
        .step-progress-container { height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .step-progress-fill { height: 100%; width: 0%; background: #4a90d9; transition: width 0.3s; }
        .step-btn { background: #4a90d9; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .step-btn:disabled { background: #555; cursor: not-allowed; }
        .step-progress-container { height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .step-progress-fill { height: 100%; width: 0%; background: #4a90d9; transition: width 0.3s; }
        
        /* 網絡拓撲圖樣式 */
        .network-topology {
            width: 100%;
            height: 250px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #333;
            border-radius: 8px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
        }
        .node {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #1a1a3a;
            border: 2px solid #4a90d9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            transition: all 0.3s;
        }
        .node:hover { transform: scale(1.2); box-shadow: 0 0 15px #4a90d9; }
        .node.hacker { border-color: #00ff41; }
        .node.target { border-color: #ff3333; }
        .node-label { position: absolute; bottom: -20px; font-size: 0.7rem; white-space: nowrap; }

        /* ===== 全螢幕戰況地圖 ===== */
        .battle-map-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 2500;
            display: flex;
            flex-direction: column;
        }

        .battle-map-header {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(10, 10, 30, 0.95));
            border-bottom: 2px solid rgba(0, 100, 255, 0.3);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 20px rgba(0, 100, 255, 0.2);
        }

        .map-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a90d9;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .map-title i {
            color: #00ff41;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .map-controls {
            display: flex;
            gap: 10px;
        }

        .map-btn {
            background: rgba(74, 144, 217, 0.1);
            border: 1px solid #4a90d9;
            color: #4a90d9;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .map-btn:hover {
            background: rgba(74, 144, 217, 0.3);
            box-shadow: 0 0 10px rgba(74, 144, 217, 0.5);
        }

        .map-btn.active {
            background: #4a90d9;
            color: white;
        }

        .map-btn-close {
            background: rgba(255, 59, 59, 0.1);
            border-color: #ff3b3b;
            color: #ff3b3b;
        }

        .map-btn-close:hover {
            background: rgba(255, 59, 59, 0.3);
            box-shadow: 0 0 10px rgba(255, 59, 59, 0.5);
        }

        .battle-map-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .map-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: radial-gradient(ellipse at center, #0a0a1a 0%, #000000 100%);
        }

        .map-view.active {
            display: block;
        }

        /* 網絡拓撲視圖 */
        .topology-canvas {
            width: 100%;
            height: 100%;
            position: relative;
            background: transparent;
        }

        .topology-node {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            animation: nodeGlow 3s infinite alternate;
        }

        @keyframes nodeGlow {
            0% { box-shadow: 0 0 10px rgba(74, 144, 217, 0.5); }
            100% { box-shadow: 0 0 20px rgba(74, 144, 217, 0.8); }
        }

        .topology-node.hacker {
            background: linear-gradient(135deg, rgba(0, 255, 65, 0.2), rgba(0, 200, 50, 0.4));
            border: 3px solid #00ff41;
        }

        .topology-node.law-enforcement {
            background: linear-gradient(135deg, rgba(74, 144, 217, 0.2), rgba(50, 120, 200, 0.4));
            border: 3px solid #4a90d9;
        }

        .topology-node.target {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.2), rgba(200, 50, 50, 0.4));
            border: 3px solid #ff6464;
            animation: targetAlert 1s infinite alternate;
        }

        @keyframes targetAlert {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        .topology-node:hover {
            transform: scale(1.2);
        }

        .node-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        .node-label {
            font-size: 0.7rem;
            text-align: center;
            font-weight: bold;
            color: white;
        }

        .node-status {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #00ff41;
            border: 2px solid #000;
        }

        .node-status.offline {
            background: #ff4444;
        }

        .node-status.warning {
            background: #ffaa00;
        }

        .topology-connection {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #4a90d9, #00ff41);
            z-index: 5;
            opacity: 0.7;
            animation: connectionFlow 2s infinite linear;
        }

        @keyframes connectionFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .topology-connection.attack {
            background: linear-gradient(90deg, #ff4444, #ffaa00);
            height: 3px;
            animation: attackFlow 1s infinite linear;
        }

        @keyframes attackFlow {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }

        .topology-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .legend-color.hacker-node {
            background: #00ff41;
        }

        .legend-color.le-node {
            background: #4a90d9;
        }

        .legend-color.attack-path {
            background: linear-gradient(90deg, #ff4444, #ffaa00);
            border-radius: 0;
            width: 30px;
            height: 3px;
        }

        .legend-color.defense-zone {
            background: rgba(74, 144, 217, 0.3);
            border: 2px solid #4a90d9;
        }

        /* 設備狀態視圖 */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .device-card {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.9), rgba(10, 10, 30, 0.9));
            border: 2px solid #4a90d9;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 144, 217, 0.3);
        }

        .device-card.hacked {
            border-color: #00ff41;
            background: linear-gradient(135deg, rgba(0, 40, 0, 0.9), rgba(0, 20, 0, 0.9));
        }

        .device-card.compromised {
            border-color: #ffaa00;
            background: linear-gradient(135deg, rgba(40, 20, 0, 0.9), rgba(20, 10, 0, 0.9));
        }

        .device-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .device-icon {
            font-size: 2rem;
            color: #4a90d9;
        }

        .device-info h3 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
        }

        .device-info p {
            margin: 5px 0 0 0;
            color: #aaa;
            font-size: 0.9rem;
        }

        .device-specs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .spec-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .spec-label {
            color: #aaa;
            display: block;
        }

        .spec-value {
            color: white;
            font-weight: bold;
        }

        .device-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-online {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
            border: 1px solid #00ff41;
        }

        .status-hacked {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
            border: 1px solid #00ff41;
        }

        .status-compromised {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            border: 1px solid #ffaa00;
        }

        .status-offline {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: 1px solid #ff4444;
        }

        /* 情報監控視圖 */
        .intel-dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            padding: 20px;
            height: 100%;
        }

        .intel-panel {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.9), rgba(10, 10, 30, 0.9));
            border: 2px solid #4a90d9;
            border-radius: 12px;
            overflow: hidden;
        }

        .panel-header {
            background: rgba(74, 144, 217, 0.1);
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4a90d9;
            font-weight: bold;
        }

        .intel-stream {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
        }

        .intel-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #4a90d9;
            animation: intelFadeIn 0.5s ease-in;
        }

        @keyframes intelFadeIn {
            0% { opacity: 0; transform: translateX(-20px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        .intel-item.hacker {
            border-left-color: #00ff41;
        }

        .intel-item.law-enforcement {
            border-left-color: #4a90d9;
        }

        .intel-item.warning {
            border-left-color: #ffaa00;
            background: rgba(255, 170, 0, 0.1);
        }

        .intel-item.danger {
            border-left-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .intel-timestamp {
            color: #aaa;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .intel-content {
            color: white;
            font-size: 0.9rem;
        }

        .personal-data {
            padding: 15px;
            height: 400px;
            overflow-y: auto;
        }

        .personal-section {
            margin-bottom: 20px;
        }

        .personal-section h4 {
            color: #4a90d9;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .personal-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #222;
        }

        .personal-label {
            color: #aaa;
        }

        .personal-value {
            color: white;
            font-weight: bold;
        }

        /* 地圖狀態欄 */
        .map-status-bar {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(10, 10, 30, 0.95));
            border-top: 2px solid rgba(0, 100, 255, 0.3);
            padding: 10px 30px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .status-label {
            color: #4a90d9;
        }

        .status-value {
            color: white;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        .connection-line {
            position: absolute;
            height: 2px;
            background: rgba(74, 144, 217, 0.3);
            transform-origin: left center;
            z-index: 1;
        }
        .connection-line.active { background: #ff3333; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        /* 日誌監控面板樣式 */
        .log-monitor {
            background: #050505;
            border: 1px solid #333;
            border-radius: 8px;
            height: 200px;
            display: flex;
            flex-direction: column;
            margin-top: 15px;
        }
        .log-tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
        .log-tab { padding: 5px 15px; cursor: pointer; font-size: 0.8rem; color: #888; }
        .log-tab.active { background: #222; color: #4a90d9; border-bottom: 2px solid #4a90d9; }
        .log-display { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.75rem; color: #00ff41; font-family: monospace; }
        .log-filter { padding: 5px; background: #111; border-top: 1px solid #333; display: flex; }
        .log-filter input { background: #000; border: 1px solid #333; color: #fff; font-size: 0.7rem; padding: 2px 5px; flex: 1; }
    
    
        /* 擴展功能樣式 */
        .resource-bar { height: 8px; background: #222; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .resource-fill { height: 100%; background: #ffcc00; transition: width 0.3s; }
        .reputation-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; background: #4a90d9; color: #fff; margin-left: 10px; }
        .identity-card { background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .court-evidence-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #222; font-size: 0.85rem; }
        .contamination-warning { color: #ff3333; font-size: 0.7rem; animation: blink 1s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    
        /* ===== 戰況地圖樣式 ===== */
        /* 嵌入式地圖樣式 */
        .embedded-battle-map {
            width: 100%;
            height: 400px;
            background: #000;
            border: 1px solid rgba(0, 100, 255, 0.3);
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        .embedded-battle-map svg {
            width: 100%;
            height: 100%;
        }
    
        .battle-map-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: #000;
            overflow: hidden;
        }

        .map-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid rgba(0, 100, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 10;
        }

        .map-title {
            color: #4a90d9;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .map-controls {
            display: flex;
            gap: 15px;
        }

        .map-btn {
            background: rgba(74, 144, 217, 0.1);
            border: 1px solid #4a90d9;
            color: #4a90d9;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .map-btn:hover {
            background: rgba(74, 144, 217, 0.2);
            box-shadow: 0 0 10px rgba(74, 144, 217, 0.3);
        }

        .map-btn.back-btn {
            background: rgba(255, 51, 51, 0.1);
            border-color: #ff3333;
            color: #ff3333;
        }

        .map-btn.back-btn:hover {
            background: rgba(255, 51, 51, 0.2);
            box-shadow: 0 0 10px rgba(255, 51, 51, 0.3);
        }

        /* 狀態欄 */
        .map-status-bar {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid rgba(0, 100, 255, 0.3);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 20px;
            z-index: 15;
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .status-label {
            font-size: 0.75rem;
            color: #aaa;
        }

        .status-value {
            font-size: 0.9rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .status-value.threat-level {
            color: #ff9900;
        }

        .status-value.health-status {
            color: #00ff41;
        }

        .status-value.evidence-integrity {
            color: #4a90d9;
        }

        .status-value.resource-usage {
            color: #ff9900;
        }

        .status-value.active-connections {
            color: #00ff41;
        }

        .network-map {
            position: absolute;
            top: 100px;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 100%);
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            stroke-width: 4;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .connection {
            stroke-linecap: round;
        }

        .attack-path {
            stroke-dasharray: 10, 5;
            animation: attackFlow 1s linear infinite;
        }

        @keyframes attackFlow {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: -15; }
        }

        /* 設備資訊面板 */
        .device-info-panel {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 350px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #4a90d9;
            border-radius: 10px;
            z-index: 20;
            max-height: 80vh;
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #333;
            background: rgba(74, 144, 217, 0.1);
        }

        .panel-header span {
            color: #4a90d9;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #fff;
        }

        .panel-content {
            padding: 15px;
        }

        .device-specs, .personal-data {
            margin-bottom: 20px;
        }

        .spec-item, .data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #222;
        }

        .spec-label, .data-label {
            color: #aaa;
            font-size: 0.9rem;
        }

        .spec-value, .data-value {
            color: #fff;
            font-weight: bold;
        }

        .personal-data h4 {
            color: #4a90d9;
            margin-bottom: 10px;
            border-bottom: 1px solid #4a90d9;
            padding-bottom: 5px;
        }

        /* 即時監控 */
        .live-monitoring {
            position: absolute;
            top: 80px;
            left: 20px;
            width: 400px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff41;
            border-radius: 10px;
            z-index: 20;
            max-height: 80vh;
            overflow: hidden;
        }

        .monitoring-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #333;
            background: rgba(0, 255, 65, 0.1);
        }

        .monitoring-header span {
            color: #00ff41;
            font-weight: bold;
        }

        .monitoring-content {
            padding: 15px;
        }

        .camera-feeds {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .feed-item {
            background: #111;
            border-radius: 5px;
            overflow: hidden;
        }

        .feed-label {
            background: #333;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: #aaa;
            border-bottom: 1px solid #444;
        }

        .feed-screen {
            height: 150px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .screen-placeholder {
            color: #666;
            text-align: center;
        }

        .screen-placeholder i {
            font-size: 2rem;
            margin-bottom: 5px;
            display: block;
        }

        /* 情報流 */
        .intelligence-stream {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 200px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff9900;
            border-radius: 10px;
            z-index: 20;
            overflow: hidden;
        }

        .stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            background: rgba(255, 153, 0, 0.1);
        }

        .stream-header span {
            color: #ff9900;
            font-weight: bold;
        }

        .stream-content {
            height: calc(100% - 50px);
            overflow-y: auto;
            padding: 10px;
        }

        .stream-message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            display: flex;
            gap: 10px;
        }

        .stream-message.incoming {
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid #00ff41;
        }

        .stream-message.outgoing {
            background: rgba(74, 144, 217, 0.1);
            border-left: 3px solid #4a90d9;
        }

        .stream-message.alert {
            background: rgba(255, 51, 51, 0.1);
            border-left: 3px solid #ff3333;
            animation: alertPulse 1s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .message-time {
            color: #888;
            font-size: 0.75rem;
            min-width: 60px;
        }

        .message-content {
            flex: 1;
            color: #fff;
        }

        /* 增強的地圖元素 */
        .threat-zone {
            filter: blur(1px);
        }

        .defense-zone {
            filter: blur(0.5px);
        }

        .data-packet {
            opacity: 0.7;
        }

        .node text {
            pointer-events: none;
            user-select: none;
        }

        .evidence-point {
            cursor: pointer;
            filter: drop-shadow(0 0 5px currentColor);
        }

        .evidence-point:hover {
            r: 12;
        }

        .tool-indicator {
            opacity: 0.8;
        }

        /* 威脅分析面板 */
        .threat-analysis-panel {
            position: absolute;
            top: 100px;
            left: 20px;
            width: 380px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff9900;
            border-radius: 10px;
            z-index: 20;
            max-height: 70vh;
            overflow-y: auto;
        }

        .threat-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .metric-label {
            color: #aaa;
            font-size: 0.85rem;
        }

        .metric-value {
            font-weight: bold;
            color: #4a90d9;
        }

        .metric-value.threat-high {
            color: #ff3333;
        }

        .metric-value.defense-good {
            color: #00ff41;
        }

        .threat-chart h4, .active-threats h4 {
            color: #ff9900;
            margin-bottom: 10px;
            border-bottom: 1px solid #ff9900;
            padding-bottom: 5px;
        }

        .chart-container {
            background: #111;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .threat-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .threat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 3px solid #4a90d9;
        }

        .threat-item.critical {
            border-left-color: #ff3333;
            background: rgba(255, 51, 51, 0.1);
        }

        .threat-item.high {
            border-left-color: #ff9900;
            background: rgba(255, 153, 0, 0.1);
        }

        .threat-item.medium {
            border-left-color: #4a90d9;
        }

        .threat-type {
            color: #fff;
            font-weight: bold;
        }

        .threat-severity {
            color: #aaa;
            font-size: 0.8rem;
        }

        .threat-time {
            color: #888;
            font-size: 0.75rem;
        }

        /* 資源監控面板 */
        .resource-monitor-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff41;
            border-radius: 10px;
            z-index: 20;
            max-height: 60vh;
            overflow-y: auto;
        }

        .resource-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .resource-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 5px;
        }

        .resource-label {
            color: #aaa;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .resource-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-bottom: 5px;
            overflow: hidden;
        }

        .resource-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff41 0%, #4a90d9 100%);
            transition: width 0.3s ease;
        }

        .cpu-fill {
            background: linear-gradient(90deg, #ff9900 0%, #ff6600 100%);
        }

        .memory-fill {
            background: linear-gradient(90deg, #4a90d9 0%, #357abd 100%);
        }

        .network-fill {
            background: linear-gradient(90deg, #ff3333 0%, #cc0000 100%);
        }

        .storage-fill {
            background: linear-gradient(90deg, #00ff41 0%, #009933 100%);
        }

        .resource-value {
            color: #fff;
            font-size: 0.9rem;
            font-weight: bold;
            text-align: right;
        }

        .system-services h4, .performance-metrics h4 {
            color: #00ff41;
            margin-bottom: 10px;
            border-bottom: 1px solid #00ff41;
            padding-bottom: 5px;
        }

        .service-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            border-left: 3px solid #00ff41;
        }

        .service-item.warning {
            border-left-color: #ff9900;
        }

        .service-name {
            color: #fff;
        }

        .service-status {
            color: #00ff41;
            font-size: 0.8rem;
        }

        .service-item.warning .service-status {
            color: #ff9900;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .metric-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .metric-title {
            color: #aaa;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .metric-box .metric-value {
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
        }

        /* 響應式設計增強 */
        @media (max-width: 768px) {
            .map-status-bar {
                flex-wrap: wrap;
                height: auto;
                padding: 10px;
                gap: 10px;
            }

            .status-item {
                min-width: 80px;
            }

            .threat-analysis-panel, .resource-monitor-panel {
                width: 90%;
                left: 5%;
                transform: none;
            }

            .resource-monitor-panel {
                bottom: 10px;
                left: 5%;
                width: 90%;
            }

            .threat-metrics {
                grid-template-columns: 1fr;
            }

            .resource-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    
    
        /* ===== 新增快捷功能樣式 ===== */
        .quick-actions-panel {
            grid-column: 1 / -1;
            background: rgba(10, 10, 20, 0.95);
            border: 1px solid rgba(0, 100, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .quick-action-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .group-title {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-left: 3px solid #4a90d9;
            padding-left: 10px;
            margin-bottom: 5px;
        }

        .group-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .quick-btn {
            padding: 10px 18px;
            background: rgba(30, 30, 60, 0.6);
            border: 1px solid rgba(74, 144, 217, 0.4);
            color: #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
            position: relative;
            overflow: hidden;
        }

        .quick-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: 0.5s;
        }

        .quick-btn:hover::after {
            left: 100%;
        }

        .quick-btn.executing {
            pointer-events: none;
            opacity: 0.8;
            filter: brightness(1.2);
        }

        .quick-btn.executing i {
            animation: fa-spin 1s infinite linear;
        }

        .quick-btn.success {
            border-color: #00ff41 !important;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.4);
        }

        .quick-btn.error {
            border-color: #ff4444 !important;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
        }

        .quick-btn:hover {
            background: rgba(74, 144, 217, 0.3);
            border-color: #4a90d9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 217, 0.2);
        }

        .quick-btn i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .quick-btn.hacker-only { border-color: #00ff41; }
        .quick-btn.hacker-only:hover { background: rgba(0, 255, 65, 0.2); }
        .quick-btn.le-only { border-color: #4a90d9; }
        .quick-btn.le-only:hover { background: rgba(74, 144, 217, 0.2); }
        .quick-btn.special { border-color: #ff9900; }
        .quick-btn.special:hover { background: rgba(255, 153, 0, 0.2); }

        .mode-selector-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
        }

        .mode-option {
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .mode-option.active {
            background: #4a90d9;
            color: #000;
            font-weight: bold;
        }
        
        .hacker-ui .mode-option.active {
            background: #00ff41;
        }

        /* 彈窗增強 */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 4px;
        }
        
        .info-label { color: #aaa; font-size: 0.75rem; }
        .info-value { color: #fff; font-weight: bold; font-size: 0.9rem; }
    
        /* ===== 案件詳細資訊樣式 ===== */
        .case-detail-item {
            padding: 10px;
            margin: 8px 0;
            background: rgba(74, 144, 217, 0.08);
            border-left: 3px solid #4a90d9;
            border-radius: 3px;
            font-size: 0.9rem;
            color: #ddd;
        }

        .case-detail-item ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }

        .case-detail-item li {
            margin: 4px 0;
            color: #aaa;
        }

        .report-section {
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid #ffaa00;
            border-radius: 3px;
            margin: 10px 0;
        }

        .report-section strong {
            color: #ffaa00;
        }

        .report-section ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }

        .report-section li {
            margin: 5px 0;
            color: #ccc;
            font-size: 0.9rem;
        }

        .dept-collab {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .dept-item {
            background: rgba(74, 144, 217, 0.1);
            border-left: 3px solid #4a90d9;
            padding: 12px;
            border-radius: 4px;
            color: #ddd;
        }

        .dept-item strong {
            color: #4a90d9;
            font-size: 0.95rem;
        }

        .alert-box {
            background: rgba(255, 102, 102, 0.1);
            border-left: 3px solid #ff6666;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .danger-box {
            background: rgba(255, 0, 0, 0.15);
            border-left: 4px solid #ff0000;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .warning-box {
            background: rgba(255, 170, 0, 0.1);
            border-left: 3px solid #ff6666;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .botnet-status {
            background: rgba(0, 255, 65, 0.1);
            border-left: 3px solid #00ff41;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 0.85rem;
        }

        .terminal-output {
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }
    
        /* ===== 深度優化樣式 ===== */
        .deep-monitor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .monitor-card {
            background: rgba(10, 10, 25, 0.9);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .le-ui .monitor-card { border-color: rgba(74, 144, 217, 0.3); }

        .monitor-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #00ff41;
        }
        
        .le-ui .monitor-title { color: #4a90d9; }

        .device-specs-list {
            font-size: 0.8rem;
            color: #ccc;
            line-height: 1.6;
        }

        .spec-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding: 4px 0;
        }

        .browser-live-preview {
            width: 100%;
            height: 120px;
            background: #000;
            border: 1px solid #333;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #666;
        }

        .browser-live-preview::after {
            content: "LIVE STREAMING";
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ff3333;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        .traffic-chart-container {
            height: 100px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
            padding-top: 10px;
        }

        .traffic-bar {
            flex: 1;
            background: #00ff41;
            min-height: 2px;
            transition: height 0.3s ease;
        }
        
        .le-ui .traffic-bar { background: #4a90d9; }

        .packet-sniffer {
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            border: 1px solid #222;
            margin-top: 10px;
        }

        .packet-line {
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .packet-in { color: #00ff41; }
        .packet-out { color: #4a90d9; }
        .packet-alert { color: #ff3333; font-weight: bold; }

        .security-status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-safe { background: rgba(0, 255, 65, 0.2); color: #00ff41; border: 1px solid #00ff41; }
        .status-danger { background: rgba(255, 51, 51, 0.2); color: #ff3333; border: 1px solid #ff3333; animation: pulse-red 2s infinite; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 51, 51, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); }
        }
    
    
        
        /* 響應式修復 */
        #fullscreen-command-hub {
            padding: 15px; /* 減少邊距 */
            overflow-y: auto; /* 允許垂直捲動 */
        }

        .hub-main {
            display: flex;
            flex-direction: column; /* 手機端預設垂直排列 */
            gap: 20px;
            height: auto;
            overflow: visible;
        }

        @media (min-width: 1024px) {
            .hub-main {
                display: grid;
                grid-template-columns: 300px 1fr 350px;
                height: calc(100vh - 150px);
            }
        }

        .hub-panel {
            min-height: 200px;
            height: auto;
        }

        .execute-btn-large {
            width: 100%;
            padding: 20px;
            margin-top: 20px;
            white-space: normal; /* 允許文字換行 */
            line-height: 1.4;
        }

        /* 修正按鈕文字旋轉問題 (如果有) */
        .execute-btn-large span {
            display: block;
        }

        /* 商店樣式 */
        .shop-item-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 5px;
        }

        .shop-item-card:hover {
            border-color: #4a90d9;
            background: rgba(74, 144, 217, 0.1);
        }
    
        /* 全螢幕操作艙樣式 */
        #fullscreen-command-hub {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(5, 5, 15, 0.98);
            z-index: 20000;
            display: none;
            flex-direction: column;
            padding: 40px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(74, 144, 217, 0.3);
            animation: fadeIn 0.3s ease;
        }

        .hub-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4a90d9;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .hub-main {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 30px;
            flex: 1;
            overflow: hidden;
        }

        .hub-panel {
            background: rgba(20, 20, 40, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .hub-title {
            font-size: 1.2rem;
            color: #4a90d9;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
        }

        .status-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #4a90d9;
        }

        .config-option-group {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .back-btn {
            background: transparent;
            color: #888;
            border: 1px solid #444;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            color: #fff;
            border-color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .execute-btn-large {
            background: linear-gradient(135deg, #4a90d9, #357abd);
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            margin-top: auto;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .execute-btn-large:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(74, 144, 217, 0.5);
        }
    
    
        /* 視覺強化：節點狀態閃光 */
        @keyframes redPulse {
            0% { box-shadow: 0 0 5px #ff3333; border-color: #ff3333; }
            50% { box-shadow: 0 0 20px #ff3333; border-color: #ff0000; }
            100% { box-shadow: 0 0 5px #ff3333; border-color: #ff3333; }
        }
        @keyframes blueShield {
            0% { box-shadow: 0 0 5px #4a90d9; border-color: #4a90d9; }
            50% { box-shadow: 0 0 20px #4a90d9; border-color: #0066ff; transform: scale(1.05); }
            100% { box-shadow: 0 0 5px #4a90d9; border-color: #4a90d9; }
        }
        .node-detected { animation: redPulse 1s infinite !important; }
        .node-defended { animation: blueShield 1.5s infinite !important; }

        /* 視覺強化：攻擊路徑分層 */
        .path-ddos { stroke: #ff3333 !important; stroke-dasharray: 5, 5; animation: ddosNoise 0.2s infinite; }
        @keyframes ddosNoise {
            0% { stroke-width: 4; opacity: 0.8; }
            50% { stroke-width: 8; opacity: 1; }
            100% { stroke-width: 4; opacity: 0.8; }
        }
        .path-exploit { stroke: #00ff41 !important; stroke-dasharray: 10, 2; animation: exploitFlow 1s infinite linear; }
        @keyframes exploitFlow {
            from { stroke-dashoffset: 20; }
            to { stroke-dashoffset: 0; }
        }
        .node-shatter { animation: shatter 0.5s ease-out forwards; }
        @keyframes shatter {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; filter: blur(2px); }
            100% { transform: scale(0.8); opacity: 1; }
        }

        /* 視覺強化：終端反饋 */
        .code-waterfall {
            color: #00ff41;
            text-shadow: 0 0 5px #00ff41;
            overflow: hidden;
            border-right: 2px solid #00ff41;
            white-space: nowrap;
            animation: waterfall 0.5s steps(30, end);
        }
        @keyframes waterfall {
            from { width: 0; }
            to { width: 100%; }
        }
        .confirm-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #4a90d9;
            color: #fff;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 10px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .error-flash {
            border: 1px solid #ff3333;
            background: rgba(255, 51, 51, 0.1);
            animation: flashRed 0.5s 2;
        }
        @keyframes flashRed {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; background: rgba(255, 51, 51, 0.3); }
        }
        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
    
    
        /* ===== 協作與網絡分析優化樣式 ===== */
        .collaboration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .collaboration-panel {
            width: 80%;
            max-width: 900px;
            background: #0a0a1a;
            border: 2px solid #4a90d9;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(74, 144, 217, 0.3);
            position: relative;
            animation: panelSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes panelSlideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(74, 144, 217, 0.3);
            padding-bottom: 15px;
        }

        .panel-title {
            font-size: 1.8rem;
            color: #4a90d9;
            text-transform: uppercase;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-panel {
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-panel:hover { color: #fff; }

        .collab-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .collab-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .section-title {
            font-size: 1.1rem;
            color: #aaa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .member-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border-left: 3px solid #4a90d9;
        }

        .member-info { display: flex; align-items: center; gap: 10px; }
        .member-status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-online { background: #00ff41; box-shadow: 0 0 5px #00ff41; }
        .status-busy { background: #ff9900; box-shadow: 0 0 5px #ff9900; }

        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item {
            padding: 12px;
            background: rgba(74, 144, 217, 0.05);
            border: 1px solid rgba(74, 144, 217, 0.2);
            border-radius: 6px;
        }

        .task-progress-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: #4a90d9;
            width: 0%;
            transition: width 0.5s ease;
        }

        /* 網絡分析儀表板 */
        .network-dashboard {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: rgba(5, 5, 15, 0.95);
            border: 1px solid #4a90d9;
            border-radius: 10px;
            z-index: 1500;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            overflow: hidden;
        }

        .dashboard-header {
            padding: 12px 15px;
            background: rgba(74, 144, 217, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(74, 144, 217, 0.3);
        }

        .dashboard-content { padding: 15px; }

        .traffic-chart {
            height: 120px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .traffic-bar {
            flex: 1;
            background: #4a90d9;
            min-height: 2px;
            transition: height 0.3s ease;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .stat-label { color: #888; }
        .stat-value { color: #4a90d9; font-weight: bold; }

        /* 工具視覺反饋 */
        .tool-executing-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #4a90d9;
            z-index: 3000;
            display: none;
            text-align: center;
            min-width: 300px;
        }

        .tool-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(74, 144, 217, 0.3);
            border-top-color: #4a90d9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    
    
/* 案件管理面板樣式 */
#case-management-panel {
    background: rgba(10, 20, 40, 0.9);
    border: 1px solid #4a90d9;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    color: #fff;
}

.case-file {
    border: 1px solid rgba(74, 144, 217, 0.3);
    border-radius: 4px;
    overflow: hidden;
}

.case-header {
    background: rgba(74, 144, 217, 0.2);
    padding: 10px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
}

.case-body {
    padding: 15px;
    font-size: 0.9rem;
    line-height: 1.6;
}

.badge {
    background: #ff9900;
    color: #000;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
}

/* 雷達掃描效果 */
#radar-scan-effect {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100vw;
    height: 100vh;
    pointer-events: none;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.radar-circle {
    width: 10px;
    height: 10px;
    border: 2px solid #4a90d9;
    border-radius: 50%;
    animation: radar-expand 3s ease-out forwards;
}

@keyframes radar-expand {
    0% { width: 0; height: 0; opacity: 1; }
    100% { width: 200vw; height: 200vw; opacity: 0; border-width: 10px; }
}

/* 黑客警告樣式 */
.hacker-scan-warning {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 0, 0, 0.8);
    color: white;
    padding: 20px 40px;
    border: 2px solid white;
    border-radius: 10px;
    z-index: 10000;
    text-align: center;
    font-weight: bold;
    animation: blink 0.5s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* 全網圍捕警示 */
.global-manhunt-alert {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(139, 0, 0, 0.9);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
}

.alert-content h1 {
    font-size: 3rem;
    margin-bottom: 20px;
    text-shadow: 0 0 20px black;
}

.countdown {
    font-size: 5rem;
    font-weight: bold;
    margin-top: 30px;
}


        /* 擴展樣式 */
        .objective-panel {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid #4a90d9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .objective-title {
            font-weight: bold;
            color: #4a90d9;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .objective-item {
            font-size: 0.85rem;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }
        .status-tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        .status-pending { background: rgba(255, 165, 0, 0.2); color: orange; }
        .status-complete { background: rgba(0, 255, 0, 0.2); color: #00ff41; }
        
        .identity-lock-container {
            margin-top: 10px;
        }
        .identity-lock-bar {
            height: 8px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #444;
        }
        .identity-lock-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600);
            width: 0%;
            transition: width 0.5s ease;
        }
    
    
        .identity-stage-panel {
            background: rgba(10, 20, 40, 0.9);
            border: 1px solid #4a90d9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(74, 144, 217, 0.3);
        }
        .step-dot.active {
            box-shadow: 0 0 10px currentColor;
        }
    
    
        .budget-dashboard {
            background: linear-gradient(135deg, #1a2a4a 0%, #0a1a2a 100%);
            border: 2px solid #4a90d9;
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 20px rgba(74, 144, 217, 0.4);
        }
        .budget-amount {
            font-size: 1.8rem;
            font-weight: 900;
            color: #00ff41;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        .shop-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .shop-item:hover:not(.purchased) {
            background: rgba(74, 144, 217, 0.1);
            border-color: #4a90d9;
            transform: translateY(-2px);
        }
        .shop-item.purchased {
            opacity: 0.6;
            cursor: default;
            border-color: #00ff41;
        }
        .shop-item-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            color: #4a90d9;
        }
        .shop-item-info { flex: 1; }
        .shop-item-name { font-weight: bold; font-size: 0.9rem; }
        .shop-item-desc { font-size: 0.7rem; color: #aaa; }
        .shop-item-cost { font-weight: bold; color: #ff9900; font-size: 0.9rem; }
    
    
/* 通信攔截樣式 */
.intercept-layout {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 20px;
    height: 600px;
    margin-top: 20px;
}

.intercept-sidebar {
    background: rgba(10, 30, 60, 0.4);
    border: 1px solid #4a90d9;
    border-radius: 8px;
    padding: 15px;
    display: flex;
    flex-direction: column;
}

.channel-list {
    flex: 1;
    overflow-y: auto;
    margin: 15px 0;
}

.channel-item {
    padding: 10px;
    border: 1px solid rgba(74, 144, 217, 0.3);
    margin-bottom: 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
}

.channel-item:hover {
    background: rgba(74, 144, 217, 0.1);
}

.channel-item.active {
    background: rgba(74, 144, 217, 0.2);
    border-color: #4a90d9;
}

.intercept-main {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.intercept-monitor {
    flex: 1;
    background: #000;
    border: 1px solid #4a90d9;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.monitor-header {
    padding: 10px 15px;
    background: rgba(74, 144, 217, 0.2);
    border-bottom: 1px solid #4a90d9;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.intercept-log {
    flex: 1;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    overflow-y: auto;
    color: #4a90d9;
}

.log-entry { margin-bottom: 5px; }
.log-entry.system { color: #aaa; font-style: italic; }
.log-entry.intercepted { color: #00ff41; }

.crack-panel {
    background: rgba(10, 30, 60, 0.4);
    border: 1px solid #4a90d9;
    border-radius: 8px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
}

.crack-info { flex: 1; }
.crack-btn {
    padding: 15px 30px;
    background: #4a90d9;
    color: #000;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
}

.crack-btn:disabled {
    background: #333;
    color: #666;
    cursor: not-allowed;
}

/* 網絡陷阱樣式 */
.trap-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.trap-card {
    background: rgba(10, 30, 60, 0.4);
    border: 1px solid #4a90d9;
    border-radius: 8px;
    padding: 25px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.trap-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(74, 144, 217, 0.3);
    background: rgba(74, 144, 217, 0.1);
}

.trap-card i {
    font-size: 3rem;
    color: #4a90d9;
    margin-bottom: 15px;
}

.trap-stats {
    margin-top: 15px;
    font-size: 0.8rem;
    color: #aaa;
}

.active-traps-section {
    margin-top: 40px;
}

.trap-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.trap-table th, .trap-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid rgba(74, 144, 217, 0.2);
}

.status-active { color: #00ff41; }
.status-triggered { color: #ff3e3e; font-weight: bold; }

/* 證據庫樣式 */
.evidence-layout {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-top: 20px;
}

.evidence-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

.stat-box {
    background: rgba(74, 144, 217, 0.1);
    border: 1px solid #4a90d9;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}

.stat-label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }
.stat-value { font-size: 1.5rem; font-weight: bold; color: #4a90d9; }

.evidence-main {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 20px;
    height: 500px;
}

.evidence-list-container {
    background: rgba(10, 20, 40, 0.6);
    border: 1px solid #4a90d9;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.evidence-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.evidence-item {
    padding: 12px;
    border: 1px solid rgba(74, 144, 217, 0.2);
    margin-bottom: 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s;
}

.evidence-item:hover { background: rgba(74, 144, 217, 0.1); }
.evidence-item.active { border-color: #4a90d9; background: rgba(74, 144, 217, 0.2); }

.evidence-item .type { font-size: 0.7rem; color: #4a90d9; text-transform: uppercase; }
.evidence-item .time { float: right; font-size: 0.7rem; color: #666; }
.evidence-item .title { display: block; margin-top: 5px; font-weight: bold; }

.evidence-detail-panel {
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid #4a90d9;
    border-radius: 8px;
    padding: 20px;
    overflow-y: auto;
}

.detail-content { font-family: 'Courier New', monospace; line-height: 1.6; }
.detail-header { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
.detail-row { margin-bottom: 10px; }
.detail-label { color: #aaa; width: 100px; display: inline-block; }
.detail-value { color: #fff; }
.detail-body { background: rgba(0, 255, 65, 0.05); padding: 15px; border-radius: 4px; border-left: 3px solid #00ff41; }

/* 實體化操作樣式優化 */
.config-step {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
}

.config-label { display: block; margin-bottom: 10px; font-weight: bold; color: #4a90d9; }
.config-input-group { display: flex; gap: 10px; }
.config-input {
    background: #000;
    border: 1px solid #4a90d9;
    color: #fff;
    padding: 8px;
    border-radius: 4px;
    flex: 1;
}

/* AI 狀態指示器 */
#ai-status-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(255, 0, 0, 0.1);
    border: 1px solid #ff3e3e;
    padding: 10px 15px;
    border-radius: 4px;
    font-size: 0.8rem;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 10px;
}

.ai-pulse {
    width: 10px;
    height: 10px;
    background: #ff3e3e;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.5); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
}

/* 技能樹樣式 */
#skill-tree-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.skill-card {
    background: rgba(10, 30, 60, 0.4);
    border: 1px solid #4a90d9;
    border-radius: 8px;
    padding: 20px;
    display: flex;
    gap: 15px;
    transition: all 0.3s;
}

.skill-card:hover {
    background: rgba(74, 144, 217, 0.1);
    transform: translateY(-3px);
}

.skill-card.maxed {
    border-color: #00ff41;
    background: rgba(0, 255, 65, 0.05);
}

.skill-icon {
    font-size: 2rem;
    color: #4a90d9;
    display: flex;
    align-items: center;
}

.skill-info { flex: 1; }
.skill-info h4 { margin-bottom: 5px; display: flex; justify-content: space-between; }
.skill-info p { font-size: 0.85rem; color: #aaa; margin-bottom: 15px; }
.lvl { font-size: 0.7rem; color: #4a90d9; }

.upgrade-btn {
    width: 100%;
    padding: 8px;
    background: #4a90d9;
    color: #000;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
}

.upgrade-btn:hover { background: #6ab0ff; }
.max-tag { color: #00ff41; font-weight: bold; font-size: 0.9rem; }

/* 執法中心專屬樣式 */
.le-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #4a90d9; padding-bottom: 10px; }
.le-tab-btn { background: none; border: none; color: #aaa; padding: 10px 20px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
.le-tab-btn.active { color: #4a90d9; border-bottom: 2px solid #4a90d9; }
.le-tab-content { display: none; }
.le-tab-content.active { display: block; }

.le-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 500px; }
.le-panel { background: rgba(10, 20, 40, 0.6); border: 1px solid #4a90d9; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
.le-list { flex: 1; overflow-y: auto; padding: 10px; }

.case-item { padding: 12px; border: 1px solid rgba(74, 144, 217, 0.2); margin-bottom: 10px; border-radius: 4px; cursor: pointer; }
.case-item:hover { background: rgba(74, 144, 217, 0.1); }
.case-item.active { border-color: #4a90d9; background: rgba(74, 144, 217, 0.2); }
.case-status { font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; float: right; }
.status-open { background: rgba(255, 165, 0, 0.2); color: orange; }
.status-closed { background: rgba(0, 255, 0, 0.2); color: #00ff41; }

.dossier-content { padding: 20px; font-family: 'Courier New', monospace; }
.dossier-header { border-bottom: 2px solid #4a90d9; padding-bottom: 15px; margin-bottom: 15px; }

.intel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
.intel-card { background: rgba(0, 0, 0, 0.8); border: 1px solid #ff3e3e; border-radius: 8px; padding: 20px; position: relative; overflow: hidden; }
.intel-card::before { content: "TOP SECRET"; position: absolute; top: 10px; right: -30px; background: #ff3e3e; color: #000; padding: 2px 40px; transform: rotate(45deg); font-size: 0.6rem; font-weight: bold; }

.collab-container { display: flex; flex-direction: column; gap: 20px; }
.collab-item { background: rgba(74, 144, 217, 0.1); border: 1px solid #4a90d9; padding: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
.collab-info { flex: 1; margin-right: 20px; }

.report-builder { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; color: #4a90d9; font-weight: bold; }
.preview-paper { background: #fff; color: #333; padding: 40px; min-height: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.5); font-family: 'Times New Roman', serif; }
.evidence-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
.ev-tag { background: #4a90d9; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }

.case-item.closed { opacity: 0.6; border-left: 4px solid #00ff41; }
.case-logs { margin-top: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; font-size: 0.8rem; }
.case-logs ul { margin-left: 20px; color: #aaa; }
.dossier-body { padding: 15px; }

/* Ensure tools panel stays above special skills and avoid overlap */
.left-panel > .tools-panel { position: relative !important; z-index: 1500 !important; pointer-events: auto; }
.left-panel > .special-skills-panel { position: relative !important; z-index: 1100 !important; pointer-events: auto; }
/* Wider rule to catch any special skills cards placed later */
.special-skills-panel, .special-skills-panel * { z-index: 1000 !important; }

        /* 響應式：在窄螢幕時，改為一欄排列 darknet 佈局 */
        @media (max-width: 900px) {
            .darknet-layout { grid-template-columns: 1fr !important; height: auto !important; }
        }

/* mode-card select button: prettier and animated */
.mode-card .select-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 18px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); cursor: pointer; transition: transform 180ms cubic-bezier(.2,.9,.3,1), box-shadow 180ms; }
.mode-card .select-btn i { transform: translateY(0); transition: transform 180ms; }
.mode-card .select-btn:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
.mode-card .select-btn:hover i { transform: rotate(-8deg) translateY(-2px); }
.mode-card .select-btn:active { transform: translateY(-2px) scale(0.995); }
</style>
</head>
<body>
    <!-- 導航欄 -->
    <nav id="navbar">
        <div id="security-status-indicator" style="font-size:0.8rem; margin-right:20px;"></div><div class="nav-logo" onclick="goToMainPage()">
            <p> <i class="fas fa-gavel"></i>&nbsp;</p>
            <p>Hacker VS</p>
<p>&nbsp;Law enforcement agency</p>
<p>&nbsp;執法對決 SEASON 2 </p>
        </div>
        <ul class="nav-menu">
            <li><a onclick="goToMainPage()" id="nav-home">主頁</a></li>
            <li><a onclick="showSetupPage()" id="nav-season2">開始第二季對戰</a></li>
            <li><a onclick="showBattleMap()" id="nav-battlemap">戰況地圖</a></li>
            <li><a onclick="showDeviceNetworkMonitor()" id="nav-monitor">📊 監控系統</a></li>
            

        </div>
        <!-- 漢堡菜單按鈕 -->
        <div class="hamburger-menu" id="hamburger-menu" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <!-- 移動端菜單 -->
    <ul class="nav-menu-mobile" id="nav-menu-mobile">
        <li><a onclick="goToMainPage(); closeMobileMenu()" id="nav-home-mobile">主頁</a></li>
        <li><a onclick="showSetupPage(); closeMobileMenu()" id="nav-season2-mobile">開始第二季對戰</a></li>
        <li><a onclick="showBattleMap(); closeMobileMenu()" id="nav-battlemap-mobile">戰況地圖</a></li>
        <li><a onclick="showInterceptPage(); closeMobileMenu()" id="nav-intercept-mobile">通信攔截</a></li>
        <li><a onclick="showTrapPage(); closeMobileMenu()" id="nav-trap-mobile">網絡陷阱</a></li>
        <li><a onclick="showDeviceNetworkMonitor(); closeMobileMenu()" id="nav-monitor-mobile">📊 監控系統</a></li>
        <li><a onclick="showTargetIntelligence(); closeMobileMenu()" id="nav-intelligence-mobile">🎯 目標情報(執法)</a></li>
        <li><a onclick="showDarknetMarketplace(); closeMobileMenu()" id="nav-marketplace-mobile">🕵️ 暗網市場(黑客)</a></li>
        <li><a onclick="showLECenter(); closeMobileMenu()" id="nav-le-center-mobile">執法指揮中心</a></li>
        <li><a onclick="showEvidencePage(); closeMobileMenu()" id="nav-evidence-mobile">證據庫</a></li>
        <li><a onclick="showGuide(); closeMobileMenu()" id="nav-guide-mobile">操作指南</a></li>
        <li><a onclick="openDarknetHub(); closeMobileMenu()" id="nav-darknet-mobile">暗網聯絡站</a></li>
        <li><a onclick="openShop(); closeMobileMenu()" id="nav-shop-mobile">商店</a></li>
    <li><a onclick="openTransactionHistory(); closeMobileMenu()" id="nav-history-mobile">交易記錄</a></li>
    </ul>

    <!-- 屏幕效果 -->
    <div class="screen-effects">
        <div class="scanlines"></div>
    </div>

    <!-- 通知系統 -->
    
    <!-- 分步操作彈窗 -->
    <div id="step-modal" class="step-window">
        <div class="step-header">
            <span id="step-modal-title">工具操作</span>
            <i class="fas fa-times" onclick="closeStepModal()" style="cursor:pointer"></i>
        </div>
        <div id="step-modal-content" class="step-content">
            <!-- 動態生成內容 -->
        </div>
        <div class="modal-buttons" id="step-modal-buttons">
            <!-- 動態生成按鈕 -->
        </div>
    </div>

    <!-- 全螢幕戰況地圖 -->
    <div id="battle-map-modal" class="battle-map-overlay" style="display:none;">
        <div class="battle-map-header">
            <div class="map-title">
                <i class="fas fa-globe"></i>
                <span>全螢幕戰況地圖 • LIVE MONITORING</span>
            </div>
            <div class="map-controls">
                <button class="map-btn" onclick="toggleMapView('network')" id="network-view-btn">
                    <i class="fas fa-network-wired"></i> 網絡拓撲
                </button>
                <button class="map-btn" onclick="toggleMapView('devices')" id="devices-view-btn">
                    <i class="fas fa-desktop"></i> 設備狀態
                </button>
                <button class="map-btn" onclick="toggleMapView('intel')" id="intel-view-btn">
                    <i class="fas fa-eye"></i> 情報監控
                </button>
                <button class="map-btn map-btn-close" onclick="closeBattleMap()">
                    <i class="fas fa-times"></i> 關閉
                </button>
            </div>
        </div>
        
        <div class="battle-map-content">
            <!-- 網絡拓撲視圖 -->
            <div id="network-topology-view" class="map-view active">
                <div class="topology-canvas" id="topology-canvas">
                    <!-- 動態生成的網絡節點和連線 -->
                </div>
                <div class="topology-legend">
                    <div class="legend-item">
                        <div class="legend-color hacker-node"></div>
                        <span>黑客節點</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color le-node"></div>
                        <span>執法節點</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color attack-path"></div>
                        <span>攻擊路徑</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color defense-zone"></div>
                        <span>防禦範圍</span>
                    </div>
                </div>
            </div>
            
            <!-- 設備狀態視圖 -->
            <div id="devices-status-view" class="map-view">
                <div class="devices-grid" id="devices-grid">
                    <!-- 動態生成的設備狀態 -->
                </div>
            </div>
            
            <!-- 情報監控視圖 -->
            <div id="intel-monitoring-view" class="map-view">
                <div class="intel-dashboard">
                    <div class="intel-panel">
                        <div class="panel-header">
                            <i class="fas fa-satellite"></i>
                            <span>即時情報流</span>
                        </div>
                        <div class="intel-stream" id="intel-stream">
                            <!-- 動態情報流 -->
                        </div>
                    </div>
                    <div class="intel-panel">
                        <div class="panel-header">
                            <i class="fas fa-user-secret"></i>
                            <span>目標個人資料</span>
                        </div>
                        <div class="personal-data" id="personal-data">
                            <!-- 個人資料顯示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 地圖狀態欄 -->
        <div class="map-status-bar">
            <div class="status-item">
                <span class="status-label">遊戲時間:</span>
                <span class="status-value" id="map-game-time">00:00</span>
            </div>
            <div class="status-item">
                <span class="status-label">活躍節點:</span>
                <span class="status-value" id="map-active-nodes">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">攻擊路徑:</span>
                <span class="status-value" id="map-attack-paths">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">情報更新:</span>
                <span class="status-value" id="map-intel-updates">0</span>
            </div>
        </div>
    </div>

    <!-- 進階調查工具包彈窗 -->
    <div id="investigation-toolkit-modal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <div class="modal-title">
                <i class="fas fa-toolbox"></i> 進階調查工具包
            </div>
            <div class="modal-content" id="investigation-toolkit-content">
                <div class="toolkit-tabs">
                    <button class="btn btn-secondary" onclick="showToolkitTab('overview')">總覽</button>
                    <button class="btn btn-secondary" onclick="showToolkitTab('timeline')">時間軸</button>
                    <button class="btn btn-secondary" onclick="showToolkitTab('sna')">社交網絡</button>
                    <button class="btn btn-secondary" onclick="showToolkitTab('geo')">地理定位</button>
                    <button class="btn btn-secondary" onclick="showToolkitTab('sandbox')">沙箱</button>
                </div>
                <div id="toolkit-body" style="margin-top:12px;">
                    <!-- 動態內容由 JS 注入 -->
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="closeInvestigationToolkit()">關閉</button>
            </div>
        </div>
    </div>

    <!-- 勝負結算動畫 -->
    <div id="game-result-animation" class="result-overlay" style="display:none; z-index: 3000;">
        <div class="result-box" id="victory-box">
            <div id="victory-animation-content"></div>
            <div id="victory-report-content" style="text-align:left; margin-top:20px; max-height:400px; overflow-y:auto; background:rgba(0,0,0,0.5); padding:15px; border-radius:5px; font-size:0.9rem;"></div>
            <div class="result-actions">
                <button class="result-btn result-btn-primary" onclick="location.reload()">返回主頁</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        <div class="notification-title" id="notification-title">
            <i class="fas fa-info-circle"></i>
            <span id="notification-title-text">系統通知</span>
        </div>
        <div class="notification-message" id="notification-message"></div>
    </div>

    <!-- 主頁面 -->
    <div id="main-page" class="page active">
        <div class="main-header">
            <div class="season-badge">SEASON 2 • 執法對決</div>
            <div class="main-logo">
              <p>黑客 vs 執法部門&nbsp;</p>
              <p><strong>網絡大戰場 第二季 </strong></p>
               <p><strong>Cyber Attack Simulation Platform </strong></p>
            </div>
            <div class="main-subtitle"></div>
            <div class="main-tagline">
                延續第一季的激烈對戰，第二季帶來全新的角色「黑客 vs 執法部門」對決！
                黑客需要隱藏身份逃脫追捕，執法部門則需調查證據鎖定身份。雙方都有強大的專屬工具和策略系統。
            </div>
        </div>

        <!-- 隱藏功能提示區（執法部門專屬） -->
        <div id="hidden-features-hint" style="display: none; background: linear-gradient(135deg, rgba(74, 144, 217, 0.15), rgba(0, 255, 65, 0.05)); border: 2px solid #4a90d9; border-radius: 12px; padding: 20px; margin: 20px auto; max-width: 800px;">
            <div style="display: flex; align-items: start; gap: 15px;">
                <div style="font-size: 2rem;">🔐</div>
                <div>
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 10px;">【執法部門專屬】隱藏功能發現</div>
                    <div style="color: #ccc; font-size: 0.9rem; line-height: 1.6;">
                        <p><strong>以下是你可以訪問的執法部門特殊工具和功能區域：</strong></p>
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin: 10px 0;">
                            <strong style="color: #00ff41;">📊 監控系統</strong> → 監控導航菜單<br>
                            <span style="color: #999;">查看自己和對手的實時設備狀態、網絡活動、流量分析</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin: 10px 0;">
                            <strong style="color: #ff6600;">🎯 詳細目標情報</strong> → 角色工具 > 目標情報<br>
                            <span style="color: #999;">AI對手的完整身份檔案、犯罪紀錄、分析報告、防禦建議</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin: 10px 0;">
                            <strong style="color: #4a90d9;">🛡️ 商店優惠</strong> → 菜單 > 商店<br>
                            <span style="color: #999;">大部分調查工具預設已購買，無需額外費用。可購買高級分析工具</span>
                        </div>
                        <p style="margin-top: 15px; color: #999;">更多隱藏功能將在進行調查時逐步解鎖。保持警惕！</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 黑客隱藏功能提示 -->
        <div id="hacker-features-hint" style="display: none; background: linear-gradient(135deg, rgba(0, 255, 65, 0.15), rgba(188, 19, 254, 0.05)); border: 2px solid #00ff41; border-radius: 12px; padding: 20px; margin: 20px auto; max-width: 800px;">
            <div style="display: flex; align-items: start; gap: 15px;">
                <div style="font-size: 2rem;">🌑</div>
                <div>
                    <div style="color: #00ff41; font-weight: bold; margin-bottom: 10px;">【黑客專屬】隱藏功能發現</div>
                    <div style="color: #ccc; font-size: 0.9rem; line-height: 1.6;">
                        <p><strong>以下是你可以訪問的黑客特殊工具和功能區域：</strong></p>
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin: 10px 0;">
                            <strong style="color: #00ff41;">📊 監控系統</strong> → 監控導航菜單<br>
                            <span style="color: #999;">查看自己和追捕者的設備狀態、網絡防禦強度、攔截風險</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin: 10px 0;">
                            <strong style="color: #bc13fe;">🕵️ 暗網市場</strong> → 角色工具 > 暗網市場<br>
                            <span style="color: #999;">購買漏洞、勒索軟體、代理服務。聯絡行家、分享情報、黑市交易</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; margin: 10px 0;">
                            <strong style="color: #ff6600;">💰 商店</strong> → 菜單 > 商店<br>
                            <span style="color: #999;">購買工具和服務。大多數需要付費，但能大幅提升攻擊能力</span>
                        </div>
                        <p style="margin-top: 15px; color: #999;">謹慎使用！每次購買都會增加被發現的風險。</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模式選擇 -->
        <div class="mode-selection">
            <!-- 黑客模式卡片 -->
            <div class="mode-card hacker">
                <div class="mode-icon">
                    <i class="fas fa-user-secret"></i>
                </div>
                <div class="mode-title">扮演黑客</div>
                <div class="mode-description">
                    作為頂尖黑客，你需要隱藏身份、清除數碼足跡、反制調查，並在必要時發動反擊。
                    使用全新專屬工具保護自己，逃脫執法部門的追捕。
                </div>
                <ul class="mode-features">
                    <li>
                        <span class="feature-icon"><i class="fas fa-eraser"></i></span>
                        <span>清除數碼足跡與流量偽裝</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-virus-slash"></i></span>
                        <span>證據污染與數據注入攻擊</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-mask"></i></span>
                        <span>身份隱藏與動態跳板網絡</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-bug"></i></span>
                        <span>干擾執法部門分析工具</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-skull-crossbones"></i></span>
                        <span>反擊執法部門系統</span>
                    </li>
                </ul>
                <button class="select-btn hacker-btn" onclick="selectRole('hacker')">
                    <i class="fas fa-skull-crossbones"></i>
                    <span>選擇黑客角色</span>
                </button>
                <!-- 角色工具（黑客） -->
                <div style="position: relative; margin-top: 10px;">
                    <a href="javascript:void(0)" id="hacker-role-tools" onclick="toggleRoleMenuFor('hacker-role-submenu')">🔧 角色工具 ▼</a>
                    <div id="hacker-role-submenu" style="display: none; position: absolute; top: 100%; left: 0; background: rgba(0,0,0,0.95); border: 1px solid #00ff41; border-radius:6px; z-index: 1100; min-width: 220px;">
                        <a onclick="showDarknetMarketplace(); closeRoleMenuFor('hacker-role-submenu')" style="display:block;padding:8px 12px;color:#00ff41;cursor:pointer;">🕵️ 暗網市場(黑客)</a>
                        <a onclick="openDarknetHub(); closeRoleMenuFor('hacker-role-submenu')" style="display:block;padding:8px 12px;color:#9b59b6;cursor:pointer;">🔗 暗網聯絡站</a>
                    </div>
                </div>
            </div>

            <!-- 執法部門模式卡片 -->
            <div class="mode-card law-enforcement">
                <div class="mode-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="mode-title">執法部門</div>
                <div class="mode-description">
                    作為網絡安全執法部門，你需要調查黑客身份、收集證據鏈、鎖定目標，
                    並申請逮捕令進行最終拘捕。使用先進的調查工具和分析系統。
                </div>
                <ul class="mode-features">
                    <li>
                        <span class="feature-icon"><i class="fas fa-search"></i></span>
                        <span>高強度調查與證據分析</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-fingerprint"></i></span>
                        <span>三階層身份鎖定機制</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-users-cog"></i></span>
                        <span>跨部門協作與資源管理</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-file-contract"></i></span>
                        <span>逮捕令申請與執行系統</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-server"></i></span>
                        <span>指揮中心與證據庫防禦</span>
                    </li>
                </ul>
                <button class="select-btn law-enforcement-btn" onclick="selectRole('law_enforcement')">
                    <i class="fas fa-shield-alt"></i>
                    <span>選擇執法部門角色</span>
                </button>
                <!-- 角色工具（執法） -->
                <div style="position: relative; margin-top: 10px;">
                    <a href="javascript:void(0)" id="le-role-tools" onclick="toggleRoleMenuFor('le-role-submenu')">🔧 角色工具 ▼</a>
                    <div id="le-role-submenu" style="display: none; position: absolute; top: 100%; left: 0; background: rgba(10,10,30,0.98); border: 1px solid #4a90d9; border-radius:6px; z-index: 1100; min-width:220px;">
                        <a onclick="showTargetIntelligence(); closeRoleMenuFor('le-role-submenu')" style="display:block;padding:8px 12px;color:#4a90d9;cursor:pointer;">🎯 目標情報(執法)</a>
                        <a onclick="showLECenter(); closeRoleMenuFor('le-role-submenu')" style="display:block;padding:8px 12px;color:#00aaff;cursor:pointer;">🏢 執法指揮中心</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 版權聲明 -->
        <div class="copyright" style="text-align: center; padding: 40px 20px 20px; color: #666; font-size: 0.9rem; max-width: 800px; margin: 0 auto;">
            <div style="background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.2); border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center; color: #ff5555; font-size: 0.9rem; line-height: 1.5;">
              <h3> <strong>⚠️ 重要聲明：</strong>
                    <br>
                  <p>這是純粹的網絡安全教育模擬平台，所有操作均為模擬效果，不會影響真實系統。&nbsp;</p>
                <p>&nbsp;平台不會收集任何個人或私隱資料，也不建議進行真實的非法黑客行為。
                  模擬器旨在幫助了解網絡攻防流程與執法調查過程。 </p>
            </div>
            
            <h3>
                <h3>© 2026 Create By【 Sam. T 】</h3>
                <h3>Copyright © 2026 Sam. T. All rights reserved.</h3>
                <h3>版權所有© 2026 Sam. T 
                <h3>此平台已受版權所有</h3>
            </h3>
        </div>

    <!-- 對戰設置頁面 -->
    <div id="season2-setup-page" class="page">
        <div class="main-header">
            <div class="season-badge">SEASON 2 • 設置對戰</div>
            <div class="main-logo" id="setup-title">對戰設置</div>
            <div class="main-subtitle" id="setup-subtitle">配置你的第二季對戰參數</div>
        </div>

        <div class="setup-container">
            <div class="setup-title">
                <i class="fas fa-cogs"></i>
                <span>第二季對戰設置</span>
            </div>

            <!-- 角色選擇確認 -->
            <div class="setup-section">
                <div class="section-title">
                    <i class="fas fa-user-tag"></i>
                    <span>已選擇角色</span>
                </div>
                <div class="setting-group">
                    <div id="selected-role-display" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #4a90d9;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px; color: #4a90d9;">
                            <i class="fas fa-question-circle"></i>
                            <span id="selected-role-name">尚未選擇角色</span>
                        </div>
                        <div style="color: #aaa; font-size: 0.95rem;" id="selected-role-desc">
                            請返回主頁選擇角色
                        </div>
                    </div>
                </div>
            </div>

            <!-- 對戰設置 -->
            <div class="setup-section">
                <div class="section-title">
                    <i class="fas fa-network-wired"></i>
                    <span>網絡設置</span>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">你的虛擬IP地址：</label>
                    <input type="text" id="player-ip" class="setting-input" value="192.168.1.100" readonly>
                    <div class="setting-note">
                        這是你的唯一識別ID，在對戰中將用於識別你的設備。
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">對手IP地址：</label>
                    <input type="text" id="opponent-ip" class="setting-input" placeholder="輸入對手IP地址 (例: 192.168.1.200)">
                    <div class="setting-note">
                        輸入對手的虛擬IP地址開始對戰。你可以選擇與AI對戰或與朋友對戰。
                    </div>
                </div>
            </div>

            <!-- AI難度設置 -->
            <div class="setup-section">
                <div class="section-title">
                    <i class="fas fa-robot"></i>
                    <span>AI對手難度</span>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">選擇AI難度級別：</label>
                    <div class="difficulty-options">
                        <div class="difficulty-card" data-level="rookie" onclick="selectDifficulty('rookie', this)">
                            <div class="difficulty-level" style="color: #00ff41;">新手級</div>
                            <div class="difficulty-desc">AI反應較慢，適合學習玩法</div>
                            <div class="difficulty-time">對戰時間: 30分鐘</div>
                        </div>
                        
                        <div class="difficulty-card selected" data-level="professional" onclick="selectDifficulty('professional', this)">
                            <div class="difficulty-level" style="color: #4a90d9;">專業級</div>
                            <div class="difficulty-desc">標準AI對手，平衡的挑戰性</div>
                            <div class="difficulty-time">對戰時間: 25分鐘</div>
                        </div>
                        
                        <div class="difficulty-card" data-level="elite" onclick="selectDifficulty('elite', this)">
                            <div class="difficulty-level" style="color: #ff9900;">精英級</div>
                            <div class="difficulty-desc">AI反應迅速，具有侵略性</div>
                            <div class="difficulty-time">對戰時間: 20分鐘</div>
                        </div>
                        
                        <div class="difficulty-card" data-level="legendary" onclick="selectDifficulty('legendary', this)">
                            <div class="difficulty-level" style="color: #ff3333;">傳奇級</div>
                            <div class="difficulty-desc">最高難度，AI使用高級策略</div>
                            <div class="difficulty-time">對戰時間: 15分鐘</div>
                        </div>
                    </div>
                    <div class="setting-note">
                        難度越高，AI對手的反應速度越快，使用的策略也越複雜。
                    </div>
                </div>
            </div>

            <!-- 開始對戰按鈕 -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="startSeason2Battle()" style="padding: 18px 50px; font-size: 1.2rem;">
                    <i class="fas fa-play-circle"></i>
                    <span>開始第二季對戰</span>
                </button>
                <div style="margin-top: 20px;">
                    <button class="btn back-btn" onclick="goToMainPage()">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回主頁</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 遊戲頁面 -->
    <div id="game-page" class="page"></div>

    <!-- 戰況地圖頁面 -->
    <div id="battle-map-page" class="page">
        <div class="battle-map-container">
            <!-- 地圖標題 -->
            <div class="map-header">
                <div class="map-title">
                    <i class="fas fa-globe"></i>
                    <span>全螢幕戰況地圖</span>
                </div>
                <div class="map-controls">
                    <button class="map-btn" onclick="toggleLiveMonitoring()">
                        <i class="fas fa-video"></i> 即時監控
                    </button>
                    <button class="map-btn" onclick="toggleIntelligenceStream()">
                        <i class="fas fa-stream"></i> 情報流
                    </button>
                    <button class="map-btn" onclick="toggleThreatAnalysis()">
                        <i class="fas fa-chart-line"></i> 威脅分析
                    </button>
                    <button class="map-btn" onclick="toggleResourceMonitor()">
                        <i class="fas fa-server"></i> 資源監控
                    </button>
                    <button class="map-btn back-btn" onclick="goToMainPage()">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                </div>
            </div>

            <!-- 狀態欄 -->
            <div class="map-status-bar">
                <div class="status-item">
                    <span class="status-label">威脅等級:</span>
                    <span class="status-value threat-level" id="threat-level">中等</span>
                </div>
                <div class="status-item">
                    <span class="status-label">系統健康度:</span>
                    <span class="status-value health-status" id="system-health">95%</span>
                </div>
                <div class="status-item">
                    <span class="status-label">證據完整性:</span>
                    <span class="status-value evidence-integrity" id="evidence-integrity">98%</span>
                </div>
                <div class="status-item">
                    <span class="status-label">資源使用率:</span>
                    <span class="status-value resource-usage" id="resource-usage">67%</span>
                </div>
                <div class="status-item">
                    <span class="status-label">活躍連接:</span>
                    <span class="status-value active-connections" id="active-connections">12</span>
                </div>
            </div>

            <!-- 網絡地圖區域 -->
            <div class="network-map">
                <svg id="network-svg" width="100%" height="100%" viewBox="0 0 1200 800">
                    <!-- 背景網格 -->
                    <defs>
                        <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                            <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(0,100,255,0.1)" stroke-width="1"/>
                        </pattern>
                        <!-- 攻擊效果 -->
                        <radialGradient id="attackGradient" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#ff3333;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#ff3333;stop-opacity:0" />
                        </radialGradient>
                        <!-- 防禦效果 -->
                        <radialGradient id="defenseGradient" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#00ff41;stop-opacity:0.6" />
                            <stop offset="100%" style="stop-color:#00ff41;stop-opacity:0" />
                        </radialGradient>
                        <!-- 威脅指示器 -->
                        <filter id="threatGlow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge> 
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />

                    <!-- 威脅區域覆蓋 -->
                    <circle cx="900" cy="400" r="200" fill="url(#attackGradient)" opacity="0.3" class="threat-zone opponent-threat">
                        <animate attributeName="opacity" values="0.1;0.4;0.1" dur="3s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="300" cy="400" r="180" fill="url(#defenseGradient)" opacity="0.2" class="defense-zone player-defense">
                        <animate attributeName="opacity" values="0.1;0.3;0.1" dur="4s" repeatCount="indefinite"/>
                    </circle>

                    <!-- 防禦範圍 -->
                    <circle cx="300" cy="400" r="150" fill="none" stroke="rgba(0,255,0,0.3)" stroke-width="2" stroke-dasharray="5,5" class="defense-range player-defense">
                        <animate attributeName="r" values="150;160;150" dur="2s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="900" cy="400" r="150" fill="none" stroke="rgba(255,0,0,0.3)" stroke-width="2" stroke-dasharray="5,5" class="defense-range opponent-defense">
                        <animate attributeName="r" values="150;160;150" dur="2s" repeatCount="indefinite"/>
                    </circle>

                    <!-- 數據包流動動畫 -->
                    <g class="data-packets">
                        <!-- 玩家到對手的數據包 -->
                        <circle cx="300" cy="400" r="3" fill="#00ff41" class="data-packet player-packet">
                            <animateMotion dur="2s" repeatCount="indefinite">
                                <path d="M 0 0 L 600 0"/>
                            </animateMotion>
                        </circle>
                        <circle cx="300" cy="400" r="3" fill="#00ff41" class="data-packet player-packet">
                            <animateMotion dur="2.5s" repeatCount="indefinite" begin="0.5s">
                                <path d="M 0 0 L 600 0"/>
                            </animateMotion>
                        </circle>
                        <!-- 對手到玩家的數據包 -->
                        <circle cx="900" cy="400" r="3" fill="#ff3333" class="data-packet opponent-packet">
                            <animateMotion dur="2s" repeatCount="indefinite">
                                <path d="M 0 0 L -600 0"/>
                            </animateMotion>
                        </circle>
                        <circle cx="900" cy="400" r="3" fill="#ff3333" class="data-packet opponent-packet">
                            <animateMotion dur="2.5s" repeatCount="indefinite" begin="0.7s">
                                <path d="M 0 0 L -600 0"/>
                            </animateMotion>
                        </circle>
                    </g>

                    <!-- 網絡節點 -->
                    <!-- 玩家側節點 -->
                    <g class="player-nodes">
                        <circle cx="300" cy="400" r="20" fill="#00ff41" stroke="#fff" stroke-width="3" class="node player-node main-node" data-device="pc" data-status="active">
                            <animate attributeName="r" values="20;25;20" dur="1s" repeatCount="indefinite"/>
                        </circle>
                        <text x="300" y="405" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">PC</text>
                        
                        <circle cx="200" cy="300" r="15" fill="#4a90d9" stroke="#fff" stroke-width="2" class="node player-node" data-device="browser" data-status="active">
                            <animate attributeName="r" values="15;18;15" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                        <text x="200" y="305" text-anchor="middle" fill="#fff" font-size="8">瀏覽器</text>
                        
                        <circle cx="400" cy="300" r="15" fill="#4a90d9" stroke="#fff" stroke-width="2" class="node player-node" data-device="router" data-status="active">
                            <animate attributeName="r" values="15;18;15" dur="1.2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="400" y="305" text-anchor="middle" fill="#fff" font-size="8">路由器</text>
                        
                        <circle cx="250" cy="500" r="12" fill="#888" stroke="#fff" stroke-width="2" class="node player-node" data-device="mobile" data-status="warning">
                            <animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="250" y="505" text-anchor="middle" fill="#fff" font-size="8">手機</text>
                        
                        <circle cx="150" cy="450" r="10" fill="#ff9900" stroke="#fff" stroke-width="2" class="node player-node" data-device="server" data-status="active">
                            <animate attributeName="r" values="10;13;10" dur="1.8s" repeatCount="indefinite"/>
                        </circle>
                        <text x="150" y="455" text-anchor="middle" fill="#fff" font-size="7">伺服器</text>
                    </g>

                    <!-- 對手側節點 -->
                    <g class="opponent-nodes">
                        <circle cx="900" cy="400" r="20" fill="#ff3333" stroke="#fff" stroke-width="3" class="node opponent-node main-node" data-device="pc" data-status="threat">
                            <animate attributeName="r" values="20;25;20" dur="1s" repeatCount="indefinite"/>
                            <animate attributeName="fill" values="#ff3333;#ff6666;#ff3333" dur="0.5s" repeatCount="indefinite"/>
                        </circle>
                        <text x="900" y="405" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">PC</text>
                        
                        <circle cx="800" cy="300" r="15" fill="#ff9900" stroke="#fff" stroke-width="2" class="node opponent-node" data-device="browser" data-status="threat">
                            <animate attributeName="r" values="15;18;15" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                        <text x="800" y="305" text-anchor="middle" fill="#fff" font-size="8">瀏覽器</text>
                        
                        <circle cx="1000" cy="300" r="15" fill="#ff9900" stroke="#fff" stroke-width="2" class="node opponent-node" data-device="router" data-status="active">
                            <animate attributeName="r" values="15;18;15" dur="1.2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="1000" y="305" text-anchor="middle" fill="#fff" font-size="8">路由器</text>
                        
                        <circle cx="850" cy="500" r="12" fill="#888" stroke="#fff" stroke-width="2" class="node opponent-node" data-device="mobile" data-status="active">
                            <animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="850" y="505" text-anchor="middle" fill="#fff" font-size="8">手機</text>
                        
                        <circle cx="1050" cy="450" r="10" fill="#ff6666" stroke="#fff" stroke-width="2" class="node opponent-node" data-device="proxy" data-status="threat">
                            <animate attributeName="r" values="10;13;10" dur="1.8s" repeatCount="indefinite"/>
                        </circle>
                        <text x="1050" y="455" text-anchor="middle" fill="#fff" font-size="7">代理</text>
                    </g>

                    <!-- 連接線 -->
                    <g class="connections">
                        <!-- 玩家內部連接 -->
                        <line x1="300" y1="400" x2="200" y2="300" stroke="#00ff41" stroke-width="3" class="connection player-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </line>
                        <line x1="300" y1="400" x2="400" y2="300" stroke="#00ff41" stroke-width="3" class="connection player-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </line>
                        <line x1="300" y1="400" x2="250" y2="500" stroke="#00ff41" stroke-width="3" class="connection player-connection warning">
                            <animate attributeName="stroke-opacity" values="0.2;0.8;0.2" dur="1.5s" repeatCount="indefinite"/>
                        </line>
                        <line x1="300" y1="400" x2="150" y2="450" stroke="#00ff41" stroke-width="2" class="connection player-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2.5s" repeatCount="indefinite"/>
                        </line>

                        <!-- 對手內部連接 -->
                        <line x1="900" y1="400" x2="800" y2="300" stroke="#ff3333" stroke-width="3" class="connection opponent-connection threat">
                            <animate attributeName="stroke-opacity" values="0.5;1;0.5" dur="1.5s" repeatCount="indefinite"/>
                        </line>
                        <line x1="900" y1="400" x2="1000" y2="300" stroke="#ff3333" stroke-width="3" class="connection opponent-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </line>
                        <line x1="900" y1="400" x2="850" y2="500" stroke="#ff3333" stroke-width="3" class="connection opponent-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </line>
                        <line x1="900" y1="400" x2="1050" y2="450" stroke="#ff3333" stroke-width="2" class="connection opponent-connection threat">
                            <animate attributeName="stroke-opacity" values="0.5;1;0.5" dur="1.8s" repeatCount="indefinite"/>
                        </line>

                        <!-- 攻擊路徑 -->
                        <line x1="400" y1="300" x2="800" y2="300" stroke="#ffff00" stroke-width="4" class="attack-path active" style="display: block;">
                            <animate attributeName="stroke-dasharray" values="0,20;20,0" dur="0.5s" repeatCount="indefinite"/>
                        </line>
                        <line x1="250" y1="500" x2="850" y2="500" stroke="#ffff00" stroke-width="4" class="attack-path active" style="display: block;">
                            <animate attributeName="stroke-dasharray" values="0,20;20,0" dur="0.5s" repeatCount="indefinite"/>
                        </line>
                        <line x1="150" y1="450" x2="1050" y2="450" stroke="#ff6600" stroke-width="3" class="attack-path potential" style="display: block; opacity: 0.5;">
                            <animate attributeName="stroke-dasharray" values="0,15;15,0" dur="1s" repeatCount="indefinite"/>
                        </line>
                    </g>

                    <!-- 證據收集點 -->
                    <g class="evidence-points">
                        <circle cx="350" cy="350" r="8" fill="#ffff00" stroke="#fff" stroke-width="2" class="evidence-point collected" data-type="ip_logs">
                            <animate attributeName="r" values="8;12;8" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="350" y="355" text-anchor="middle" fill="#000" font-size="8" font-weight="bold">證</text>
                        
                        <circle cx="950" cy="350" r="8" fill="#ff6600" stroke="#fff" stroke-width="2" class="evidence-point available" data-type="malware_sample">
                            <animate attributeName="r" values="8;12;8" dur="2.5s" repeatCount="indefinite"/>
                        </circle>
                        <text x="950" y="355" text-anchor="middle" fill="#000" font-size="8" font-weight="bold">證</text>
                    </g>

                    <!-- 工具使用指示器 -->
                    <g class="tool-indicators">
                        <rect x="320" y="380" width="20" height="4" fill="#00ff41" class="tool-indicator active" data-tool="firewall">
                            <animate attributeName="width" values="20;30;20" dur="1s" repeatCount="indefinite"/>
                        </rect>
                        <rect x="920" y="380" width="20" height="4" fill="#ff3333" class="tool-indicator active" data-tool="ddos">
                            <animate attributeName="width" values="20;30;20" dur="1s" repeatCount="indefinite"/>
                        </rect>
                    </g>
                </svg>
            </div>

            <!-- 設備資訊面板 -->
            <div class="device-info-panel" id="device-info-panel" style="display: none;">
                <div class="panel-header">
                    <i class="fas fa-info-circle"></i>
                    <span>設備規格資訊</span>
                    <button class="close-btn" onclick="closeDeviceInfo()">&times;</button>
                </div>
                <div class="panel-content">
                    <div class="device-specs">
                        <div class="spec-item">
                            <span class="spec-label">設備類型:</span>
                            <span class="spec-value" id="device-type">-</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">作業系統:</span>
                            <span class="spec-value" id="os-info">-</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">處理器:</span>
                            <span class="spec-value" id="cpu-info">-</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">記憶體:</span>
                            <span class="spec-value" id="ram-info">-</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">網路狀態:</span>
                            <span class="spec-value" id="network-status">-</span>
                        </div>
                    </div>
                    <div class="personal-data">
                        <h4>個人資料</h4>
                        <div class="data-item">
                            <span class="data-label">用戶名稱:</span>
                            <span class="data-value" id="user-name">-</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">IP位置:</span>
                            <span class="data-value" id="ip-location">-</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">活動時間:</span>
                            <span class="data-value" id="activity-time">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 即時監控畫面 -->
            <div class="live-monitoring" id="live-monitoring" style="display: none;">
                <div class="monitoring-header">
                    <i class="fas fa-video"></i>
                    <span>即時監控畫面</span>
                    <button class="close-btn" onclick="closeLiveMonitoring()">&times;</button>
                </div>
                <div class="monitoring-content">
                    <div class="camera-feeds">
                        <div class="feed-item">
                            <div class="feed-label">玩家設備監控</div>
                            <div class="feed-screen" id="player-feed">
                                <div class="screen-placeholder">
                                    <i class="fas fa-desktop"></i>
                                    <span>監控中...</span>
                                </div>
                            </div>
                        </div>
                        <div class="feed-item">
                            <div class="feed-label">對手設備監控</div>
                            <div class="feed-screen" id="opponent-feed">
                                <div class="screen-placeholder">
                                    <i class="fas fa-desktop"></i>
                                    <span>監控中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 情報流 -->
            <div class="intelligence-stream" id="intelligence-stream" style="display: none;">
                <div class="stream-header">
                    <i class="fas fa-stream"></i>
                    <span>情報流</span>
                    <button class="close-btn" onclick="closeIntelligenceStream()">&times;</button>
                </div>
                <div class="stream-content" id="stream-messages">
                    <div class="stream-message incoming">
                        <div class="message-time">14:32:15</div>
                        <div class="message-content">偵測到對手嘗試連接埠掃描</div>
                    </div>
                    <div class="stream-message outgoing">
                        <div class="message-time">14:32:18</div>
                        <div class="message-content">防火牆已攔截可疑流量</div>
                    </div>
                    <div class="stream-message alert">
                        <div class="message-time">14:32:22</div>
                        <div class="message-content">警告：對手發起DDoS攻擊</div>
                    </div>
                </div>
            </div>

            <!-- 威脅分析面板 -->
            <div class="threat-analysis-panel" id="threat-analysis-panel" style="display: none;">
                <div class="panel-header">
                    <i class="fas fa-chart-line"></i>
                    <span>威脅分析儀表板</span>
                    <button class="close-btn" onclick="closeThreatAnalysis()">&times;</button>
                </div>
                <div class="panel-content">
                    <div class="threat-metrics">
                        <div class="metric-item">
                            <span class="metric-label">即時威脅等級:</span>
                            <span class="metric-value threat-high" id="realtime-threat">高</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">攻擊嘗試頻率:</span>
                            <span class="metric-value" id="attack-frequency">12/分鐘</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">防禦有效性:</span>
                            <span class="metric-value defense-good" id="defense-effectiveness">85%</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">預測下次攻擊:</span>
                            <span class="metric-value" id="next-attack-prediction">2分鐘內</span>
                        </div>
                    </div>
                    
                    <div class="threat-chart">
                        <h4>威脅趨勢圖</h4>
                        <div class="chart-container">
                            <canvas id="threat-chart" width="300" height="150"></canvas>
                        </div>
                    </div>
                    
                    <div class="active-threats">
                        <h4>活躍威脅</h4>
                        <div class="threat-list" id="active-threats-list">
                            <div class="threat-item critical">
                                <span class="threat-type">DDoS攻擊</span>
                                <span class="threat-severity">關鍵</span>
                                <span class="threat-time">進行中</span>
                            </div>
                            <div class="threat-item high">
                                <span class="threat-type">連接埠掃描</span>
                                <span class="threat-severity">高</span>
                                <span class="threat-time">1分鐘前</span>
                            </div>
                            <div class="threat-item medium">
                                <span class="threat-type">可疑流量</span>
                                <span class="threat-severity">中</span>
                                <span class="threat-time">3分鐘前</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 資源監控面板 -->
            <div class="resource-monitor-panel" id="resource-monitor-panel" style="display: none;">
                <div class="panel-header">
                    <i class="fas fa-server"></i>
                    <span>資源監控中心</span>
                    <button class="close-btn" onclick="closeResourceMonitor()">&times;</button>
                </div>
                <div class="panel-content">
                    <div class="resource-grid">
                        <div class="resource-item">
                            <div class="resource-label">CPU使用率</div>
                            <div class="resource-bar">
                                <div class="resource-fill cpu-fill" style="width: 67%"></div>
                            </div>
                            <div class="resource-value">67%</div>
                        </div>
                        
                        <div class="resource-item">
                            <div class="resource-label">記憶體使用率</div>
                            <div class="resource-bar">
                                <div class="resource-fill memory-fill" style="width: 45%"></div>
                            </div>
                            <div class="resource-value">45%</div>
                        </div>
                        
                        <div class="resource-item">
                            <div class="resource-label">網路頻寬</div>
                            <div class="resource-bar">
                                <div class="resource-fill network-fill" style="width: 78%"></div>
                            </div>
                            <div class="resource-value">78%</div>
                        </div>
                        
                        <div class="resource-item">
                            <div class="resource-label">儲存空間</div>
                            <div class="resource-bar">
                                <div class="resource-fill storage-fill" style="width: 32%"></div>
                            </div>
                            <div class="resource-value">32%</div>
                        </div>
                    </div>
                    
                    <div class="system-services">
                        <h4>系統服務狀態</h4>
                        <div class="service-list">
                            <div class="service-item active">
                                <span class="service-name">防火牆</span>
                                <span class="service-status">運行中</span>
                            </div>
                            <div class="service-item active">
                                <span class="service-name">入侵偵測</span>
                                <span class="service-status">運行中</span>
                            </div>
                            <div class="service-item warning">
                                <span class="service-name">日誌系統</span>
                                <span class="service-status">警告</span>
                            </div>
                            <div class="service-item active">
                                <span class="service-name">備份系統</span>
                                <span class="service-status">運行中</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="performance-metrics">
                        <h4>效能指標</h4>
                        <div class="metrics-grid">
                            <div class="metric-box">
                                <div class="metric-title">響應時間</div>
                                <div class="metric-value">45ms</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-title">吞吐量</div>
                                <div class="metric-value">1.2GB/s</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-title">錯誤率</div>
                                <div class="metric-value">0.02%</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-title">可用性</div>
                                <div class="metric-value">99.98%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定義模態框 -->
    <div class="modal-overlay" id="custom-modal">
        <div class="modal-box">
            <div class="modal-title">
                <i class="fas fa-terminal"></i>
                <span id="modal-title-text">系統提示</span>
            </div>
            <div class="modal-message" id="modal-message"></div>
            <input type="text" class="modal-input" id="modal-input" style="display: none;">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">取消</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">確定</button>
            </div>
        </div>
    </div>

    <!-- 結果頁面 -->
    <div class="result-overlay" id="result-overlay">
        <div class="result-box" id="result-box">
            <div class="result-icon" id="result-icon"></div>
            <div class="result-title" id="result-title"></div>
            <div class="result-message" id="result-message"></div>
            <div class="result-stats" id="result-stats"></div>
            <div class="result-actions">
                <button class="result-btn result-btn-primary" onclick="goToMainPage()">
                    <i class="fas fa-home"></i> 返回主頁
                </button>
                <button class="result-btn result-btn-secondary" onclick="showSetupPage()">
                    <i class="fas fa-redo"></i> 重新對戰
                </button>
            </div>
        </div>
    </div>

    <!-- 商店頁面 -->
    <div class="modal-overlay" id="shop-modal">
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-title">
                <i class="fas fa-shopping-cart"></i>
                <span id="shop-title">商店</span>
            </div>
            <div class="modal-message" id="shop-message"></div>
        </div>
    </div>

    <!-- 交易歷史頁面 -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-title">
                <i class="fas fa-history"></i>
                <span>交易歷史記錄</span>
            </div>
            <div class="modal-message" id="history-message"></div>
        </div>
    </div>

    <script>
        
        // AI 隊伍協作邏輯（使用 aiParams 調整靈敏度與決策間隔）
        function processAITeamLogic() {
            if (!GameState.gameActive) return;
            if (!GameState.aiTeams) return; // 防禦性檢查，避免未定義情況下錯誤

            const now = Date.now();
            const params = GameState.aiParams || { decisionInterval: 1.5, collaborationChance: 0.05 };
            if (now - (params.lastDecisionTime || 0) < (params.decisionInterval || 1) * 1000) return;
            params.lastDecisionTime = now;
            GameState.aiParams = params;

            const roles = ['law_enforcement', 'hacker'];
            roles.forEach(role => {
                const team = GameState.aiTeams[role];

                // 協作冷卻處理（考慮反應倍率）
                if (team.collaborationCooldown > 0) {
                    team.collaborationCooldown = Math.max(0, team.collaborationCooldown - Math.max(1, Math.round(params.reactionMultiplier)));
                    return;
                }

                // 檢查是否需要增援（使用 reinforcementThreshold）
                const activeMembers = team.members.filter(m => m.status === 'active');
                if (activeMembers.length <= team.members.length * (params.reinforcementThreshold || 0.5)) {
                    requestReinforcements(role);
                }

                // 協作觸發機率由 aiParams 控制
                if (Math.random() < (params.collaborationChance || 0.05)) {
                    executeCollaborativeCommand(role);
                }
            });
        }

        function executeCollaborativeCommand(role) {
            const team = GameState.aiTeams[role];
            let command = '';
            let effect = '';

            if (role === 'law_enforcement') {
                command = '全網圍捕';
                effect = '指揮中心發布指令，鑑識科啟動證據驗證，特警隊發動突襲！';
                GameState.playerData.law_enforcement.investigationProgress += 10;
                GameState.opponentData.hacker.stealth -= 15;
            } else {
                command = 'DDoS 掩護攻擊';
                effect = '主黑客發動攻擊，跳板管理員部署臨時跳板，技術支援強化工具！';
                GameState.playerData.hacker.controlProgress += 10;
                GameState.playerData.hacker.stealth += 10;
            }

            team.collaborationCooldown = 60; // 統一冷卻時間
            addTerminalLine(`[協作] ${team.name} 啟動指令鏈: ${command}`, 'alert');
            addTerminalLine(`[效果] ${effect}`, 'info');
            showNotification(`${team.name} 協作`, command, 'warning');
        }

        function requestReinforcements(role) {
            const team = GameState.aiTeams[role];
            const reinforcementName = role === 'law_enforcement' ? '臨時特警隊' : '臨時技術支援';
            
            const newMember = { 
                id: 'reinforcement_' + Date.now(), 
                role: reinforcementName, 
                function: '緊急增援', 
                status: 'active', 
                health: 100 
            };
            
            team.members.push(newMember);
            addTerminalLine(`[增援] ${team.name} 損耗過大，${reinforcementName} 已加入戰場！`, 'success');
        }

        // 依難度調整 AI 靈敏度參數
        function adjustAISensitivity(level) {
            const mapping = {
                rookie: { decisionInterval: 2.5, collaborationChance: 0.02, reinforcementThreshold: 0.6, messageChance: 0.02, reactionMultiplier: 0.6, accuracy: 0.6 },
                professional: { decisionInterval: 1.5, collaborationChance: 0.05, reinforcementThreshold: 0.5, messageChance: 0.03, reactionMultiplier: 1.0, accuracy: 0.8 },
                elite: { decisionInterval: 1.0, collaborationChance: 0.10, reinforcementThreshold: 0.45, messageChance: 0.05, reactionMultiplier: 1.4, accuracy: 0.9 },
                legendary: { decisionInterval: 0.6, collaborationChance: 0.18, reinforcementThreshold: 0.4, messageChance: 0.07, reactionMultiplier: 1.8, accuracy: 0.98 }
            };
            const params = mapping[level] || mapping.professional;
            GameState.aiParams = Object.assign(GameState.aiParams || {}, params, { lastDecisionTime: GameState.aiParams ? GameState.aiParams.lastDecisionTime : 0 });
            addTerminalLine(`[AI] 已將 AI 靈敏度調整為 ${level} 模式`, 'info');
        }

    // quickAction consolidated later in the file (single canonical implementation)

        function confirmQuickAction(actionId) {
            const qcm = document.getElementById('quick-config-modal'); if (qcm) qcm.remove();
            addTerminalLine('[執行] 參數校準完成，正式啟動: ' + actionId, 'success');
            // 這裡調用原始的執行邏輯 (為了保持兼容，我們調用一個重命名的原始函數)
            if (typeof originalQuickActionExecute === 'function') {
                    if (typeof originalQuickActionExecute === 'function') {
                        originalQuickActionExecute(actionId);
                    } else if (typeof executeCommand === 'function') {
                        console.warn('originalQuickActionExecute not defined, using executeCommand fallback');
                        executeCommand(actionId);
                    } else {
                        console.warn('No quick action executor available for', actionId);
                    }
            } else {
                console.warn('originalQuickActionExecute is not defined, fallback to executeCommand');
                if (typeof executeCommand === 'function') executeCommand(actionId);
            }
        }
    
        
        const ActionConfigs = {
            'scan_target': {
                title: '網絡掃描設定',
                options: [
                    { label: '掃描深度', type: 'select', id: 'scan_depth', values: ['快速掃描', '深度掃描', '全端口掃描'] },
                    { label: '隱蔽模式', type: 'checkbox', id: 'stealth_mode', default: true }
                ],
                duration: 5000
            },
            'crack_password': {
                title: '密碼破解方案',
                options: [
                    { label: '破解字典', type: 'select', id: 'dict_type', values: ['常用密碼', '暴力窮舉', '社會工程字典'] },
                    { label: '線程數量', type: 'range', id: 'threads', min: 1, max: 16, default: 4 }
                ],
                duration: 8000
            },
            'ip_tracking': {
                title: 'IP 追蹤與反制',
                options: [
                    { label: '追蹤精度', type: 'range', id: 'precision', min: 1, max: 100, default: 70 },
                    { label: '反制措施', type: 'select', id: 'counter_measure', values: ['切換VPN節點', '發送虛假IP包', '流量混淆'] }
                ],
                duration: 6000
            },
            'traffic_analysis': {
                title: '流量監聽分析儀',
                options: [
                    { label: '監聽協議', type: 'select', id: 'protocol', values: ['HTTP/HTTPS', 'TCP/UDP', 'ICMP'] },
                    { label: '數據包過濾', type: 'text', id: 'filter', placeholder: 'e.g. port 80' }
                ],
                duration: 4000
            },
            'evidence_collection': {
                title: '證據收集設定',
                options: [
                    { label: '收集來源', type: 'select', id: 'source', values: ['系統日誌', '內存鏡像', '磁盤殘留'] },
                    { label: '收集精度', type: 'range', id: 'accuracy', min: 1, max: 100, default: 85 }
                ],
                duration: 7000
            }
        };
    
        // 全局執行狀態
        let currentExecutingAction = null;

    // quickAction consolidated later in the file (single canonical implementation)

        function showActionConfigModal(actionId, config) {
            let optionsHtml = '';
            config.options.forEach(opt => {
                optionsHtml += `<div style="margin-bottom:12px;">
                    <label style="display:block; font-size:0.8rem; color:#888; margin-bottom:4px;">${opt.label}</label>`;
                if (opt.type === 'select') {
                    optionsHtml += `<select id="cfg_${opt.id}" style="width:100%; background:#222; color:#fff; border:1px solid #444; padding:5px;">
                        ${opt.values.map(v => `<option value="${v}">${v}</option>`).join('')}
                    </select>`;
                } else if (opt.type === 'range') {
                    optionsHtml += `<input type="range" id="cfg_${opt.id}" min="${opt.min}" max="${opt.max}" value="${opt.default}" style="width:100%;">`;
                } else if (opt.type === 'checkbox') {
                    optionsHtml += `<input type="checkbox" id="cfg_${opt.id}" ${opt.default ? 'checked' : ''}> <span style="font-size:0.8rem; color:#ccc;">啟用</span>`;
                } else if (opt.type === 'text') {
                    optionsHtml += `<input type="text" id="cfg_${opt.id}" placeholder="${opt.placeholder}" style="width:100%; background:#222; color:#fff; border:1px solid #444; padding:5px;">`;
                }
                optionsHtml += `</div>`;
            });

            const modalHtml = `
                <div id="action-config-modal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(10,10,20,0.95); border:2px solid #4a90d9; padding:25px; z-index:10000; width:350px; box-shadow:0 0 40px rgba(0,0,0,0.8); backdrop-filter:blur(10px);">
                    <h3 style="color:#4a90d9; margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span><i class="fas fa-cog"></i> ${config.title}</span>
                        <i class="fas fa-times" onclick="closeActionModal()" style="cursor:pointer; font-size:1rem; color:#666;"></i>
                    </h3>
                    <div id="config-fields">${optionsHtml}</div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button onclick="startActionExecution('${actionId}')" style="flex:1; background:#4a90d9; color:#000; border:none; padding:10px; cursor:pointer; font-weight:bold; text-transform:uppercase; letter-spacing:1px;">確認執行</button>
                    </div>
                </div>
            `;
            
            const div = document.createElement('div');
            div.id = 'modal-container';
            div.innerHTML = modalHtml;
            document.body.appendChild(div);
        }

        function closeActionModal() {
            const modal = document.getElementById('modal-container');
            if (modal) modal.remove();
        }

        function startActionExecution(actionId) {
            const config = ActionConfigs[actionId] || { duration: 5000 };
            closeActionModal();

            // 創建進度條 UI
            const progressHtml = `
                <div id="action-progress-overlay" style="position:fixed; bottom:100px; left:50%; transform:translateX(-50%); width:400px; background:rgba(0,0,0,0.8); border:1px solid #4a90d9; padding:15px; z-index:9999; text-align:center;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.8rem;">
                        <span style="color:#4a90d9;">正在執行: ${actionId}</span>
                        <span id="progress-percent" style="color:#fff;">0%</span>
                    </div>
                    <div style="width:100%; height:6px; background:#222; border-radius:3px; overflow:hidden; margin-bottom:10px;">
                        <div id="progress-bar-fill" style="width:0%; height:100%; background:linear-gradient(90deg, #4a90d9, #6ab0ff); transition:width 0.1s linear;"></div>
                    </div>
                    <button onclick="cancelActionExecution()" style="background:rgba(255,0,0,0.2); color:#ff4444; border:1px solid #ff4444; padding:4px 12px; font-size:0.7rem; cursor:pointer;">取消執行</button>
                </div>
            `;
            const div = document.createElement('div');
            div.id = 'progress-container';
            div.innerHTML = progressHtml;
            document.body.appendChild(div);

            let progress = 0;
            const interval = 100; // 每 0.1 秒更新一次
            const step = (interval / config.duration) * 100;

            currentExecutingAction = setInterval(() => {
                progress += step;
                if (progress >= 100) {
                    progress = 100;
                    finishActionExecution(actionId);
                }
                document.getElementById('progress-bar-fill').style.width = progress + '%';
                document.getElementById('progress-percent').innerText = Math.floor(progress) + '%';
            }, interval);
        }

        function cancelActionExecution() {
            if (currentExecutingAction) {
                clearInterval(currentExecutingAction);
                currentExecutingAction = null;
                addTerminalLine('[系統] 操作已由用戶手動取消', 'warning');
                document.getElementById('progress-container').remove();
            }
        }

        function finishActionExecution(actionId) {
            clearInterval(currentExecutingAction);
            currentExecutingAction = null;
            setTimeout(() => {
                const container = document.getElementById('progress-container');
                if (container) container.remove();
                addTerminalLine('[成功] 功能執行完畢: ' + actionId, 'success');
                if (typeof originalQuickActionExecute === 'function') {
                    originalQuickActionExecute(actionId);
                } else if (typeof executeCommand === 'function') {
                    console.warn('originalQuickActionExecute not defined, using executeCommand fallback');
                    executeCommand(actionId);
                } else {
                    console.warn('No quick action executor available for', actionId);
                }
            }, 500);
        }
    
        // 初始化資源與權限
        function initRoleResources() {
            if (GameState.currentRole === 'law_enforcement') {
                // 執法部門預設解鎖大部分工具
                GameState.playerData.law_enforcement.money = 999999; // 預設資金充足
                GameState.playerData.law_enforcement.tools = ['network_scanner', 'forensics_kit', 'ip_tracker', 'traffic_analyzer', 'big_data_analyser'];
                addTerminalLine('[系統] 執法部門權限已激活，預設工具已就緒', 'success');
            } else {
                // 黑客初始資源較少
                GameState.playerData.hacker.money = 15000; 
                GameState.playerData.hacker.tools = ['basic_scanner'];
                addTerminalLine('[系統] 黑客初始資源受限，請透過暗網獲取高級工具', 'warning');
            }
        }

        // 危險/安全狀態顯示
        function updateSecurityStatus() {
            const role = GameState.currentRole;
            const statusEl = document.getElementById('security-status-indicator');
            if (!statusEl) return;

            let dangerLevel = 0;
            if (role === 'hacker') {
                dangerLevel = 100 - GameState.playerData.hacker.stealth;
            } else {
                dangerLevel = GameState.opponentData.hacker.controlProgress;
            }

            let statusText = dangerLevel > 70 ? '極度危險' : (dangerLevel > 30 ? '警戒狀態' : '安全');
            let statusColor = dangerLevel > 70 ? '#ff0000' : (dangerLevel > 30 ? '#ff9900' : '#00ff41');
            
            statusEl.innerHTML = `<span style="color:${statusColor}; font-weight:bold;">[${statusText}]</span> 威脅指數: ${Math.floor(dangerLevel)}%`;
        }
    
        
        function showFullscreenHub(actionId) {
            const hub = document.getElementById('fullscreen-command-hub');
            const config = ActionConfigs[actionId] || { title: '高級功能執行', options: [], duration: 5000 };
            
            document.getElementById('hub-main-title').innerText = config.title;
            hub.style.display = 'flex';
            
            // 填充設定內容
            let optionsHtml = '';
            config.options.forEach(opt => {
                optionsHtml += `
                    <div class="config-option-group">
                        <label style="display:block; margin-bottom:10px; color:#4a90d9; font-weight:bold;">${opt.label}</label>
                        ${renderHubOption(opt)}
                    </div>
                `;
            });
            document.getElementById('hub-config-content').innerHTML = optionsHtml;
            
            // 綁定執行按鈕
            document.getElementById('hub-execute-btn').onclick = () => startActionExecution(actionId);
            
            // 更新實時數據
            updateHubRealtimeData();
            updateImpactPreview(actionId);
        }

        function renderHubOption(opt) {
            if (opt.type === 'select') {
                return `<select id="hub_cfg_${opt.id}" class="hub-input" style="width:100%; background:#111; color:#fff; border:1px solid #4a90d9; padding:10px;">
                    ${opt.values.map(v => `<option value="${v}">${v}</option>`).join('')}
                </select>`;
            } else if (opt.type === 'range') {
                return `<input type="range" id="hub_cfg_${opt.id}" min="${opt.min}" max="${opt.max}" value="${opt.default}" style="width:100%;" oninput="updateImpactPreview()">`;
            }
            return `<input type="text" id="hub_cfg_${opt.id}" style="width:100%; background:#111; color:#fff; border:1px solid #4a90d9; padding:10px;">`;
        }

        function updateHubRealtimeData() {
            const role = GameState.currentRole;
            const myData = GameState.playerData[role];
            const oppData = GameState.opponentData[role === 'hacker' ? 'law_enforcement' : 'hacker'];

            // 本地狀態
            document.getElementById('local-device-status').innerHTML = `
                <div class="status-item">CPU 負載: ${Math.floor(Math.random()*30 + 10)}%</div>
                <div class="status-item">內存佔用: ${Math.floor(Math.random()*20 + 40)}%</div>
                <div class="status-item">加密強度: ${myData.encryptionLevel || 100}%</div>
                <div class="status-item">隱蔽等級: ${myData.stealth || 100}%</div>
            `;

            // 對手活動
            const activities = [
                `偵測到來自 ${GameState.opponentIP} 的異常流量`,
                `對手正在嘗試訪問 ${role === 'hacker' ? '證據庫' : '跳板節點'}`,
                `網絡延遲: ${Math.floor(Math.random()*50 + 20)}ms`,
                `對手防火牆狀態: ${oppData.defensePower > 50 ? '高' : '中'}`
            ];
            document.getElementById('opponent-activity-log').innerHTML = activities.map(a => `<div style="margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:4px;">> ${a}</div>`).join('');
        }

        function updateImpactPreview(actionId) {
            const preview = document.getElementById('impact-preview');
            if (GameState.currentRole === 'hacker') {
                preview.innerHTML = "預期影響：<br>• 自身隱蔽度 +15%<br>• 對手追蹤難度提升<br>• 系統負載增加 5%";
            } else {
                preview.innerHTML = "預期影響：<br>• 證據完整性 +20%<br>• 對手隱蔽度 -10%<br>• 法律效力提升";
            }
        }

        function closeFullscreenHub() {
            document.getElementById('fullscreen-command-hub').style.display = 'none';
        }

        // 覆蓋原有的 quickAction
        // Fallback executor for quick actions in case originalQuickActionExecute isn't defined
        if (typeof window.originalQuickActionExecute !== 'function') {
            window.originalQuickActionExecute = function(actionId) {
                addTerminalLine(`[快捷-預設] 執行 ${actionId}`, 'info');
                if (ActionConfigs && ActionConfigs[actionId]) {
                    // open hub and start execution after 300ms as a sensible default
                    showFullscreenHub(actionId);
                    setTimeout(() => startActionExecution(actionId), 500);
                } else {
                    // fallback to command-based execution
                    executeCommand(actionId);
                }
            };
        }

    // quickAction consolidated later in the file (single canonical implementation)
    
        
        // 商店數據
        const ShopItems = [
            { id: 'adv_vpn', name: '高級隱匿VPN', price: 5000, effect: { stealth: 20 }, desc: '大幅提升隱蔽等級' },
            { id: 'cpu_boost', name: '超頻處理器', price: 8000, effect: { attack: 15 }, desc: '提升攻擊執行速度' },
            { id: 'firewall_v2', name: '量子防火牆', price: 12000, effect: { defense: 25 }, desc: '強化系統防禦力' },
            { id: 'ai_analyser', name: 'AI行為分析儀', price: 10000, effect: { investigation: 20 }, desc: '提升證據收集效率' }
        ];

    function openShop() { ShopSystem.open(); }

    function rechargeMoney() { ShopSystem.open(); }

    function buyItem(itemId) { ShopSystem.buy(itemId); }

        // 修改原本的 openUpgradeSystem 導向商店
        function openUpgradeSystem() {
            openShop();
        }
    
        
        ActionConfigs['antivirus'] = { title: '防毒掃毒系統', options: [{label:'掃描強度', type:'range', id:'power', min:1, max:100, default:80}], duration: 5000 };
        ActionConfigs['device_status'] = { title: '裝置詳細狀態分析', options: [{label:'分析深度', type:'select', id:'depth', values:['硬體層','內核層','應用層']}], duration: 3000 };
        ActionConfigs['reverse_injection'] = { title: '反向注入攻擊', options: [{label:'注入載荷', type:'select', id:'payload', values:['Shellcode','Rootkit','Logic Bomb']}], duration: 10000 };
        ActionConfigs['honeypot_gen'] = { title: '誘捕網絡生成器', options: [{label:'偽裝類型', type:'select', id:'type', values:['Web Server','Database','SSH Service']}], duration: 6000 };
        ActionConfigs['darknet_hub'] = { title: '暗網中介聯絡站', options: [{label:'加密頻道', type:'select', id:'channel', values:['Tor','I2P','ZeroNet']}], duration: 4000 };
    
    // ===== 全局變量 =====
    window.GameState = window.GameState || {
            currentRole: null,
            currentPage: 'main',
            gameActive: false,
            connectionStatus: 'disconnected',
            playerIP: '192.168.1.100',
            opponentIP: '',
            difficulty: 'professional',
            // AI 動態參數（由難度調整）
            aiParams: {
                decisionInterval: 1.5, // seconds between AI decision cycles
                collaborationChance: 0.05, // base chance per decision to trigger collaboration
                reinforcementThreshold: 0.5, // fraction of members active before reinforcements
                messageChance: 0.03, // chance of ambient AI messages
                reactionMultiplier: 1.0, // scales how fast cooldowns decrease / reaction speed
                accuracy: 0.8,
                lastDecisionTime: 0
            },
            gameMode: 'season2',
            currentStepTask: null,
            logs: { system: [], security: [], communication: [] },
            missionSteps: {},
            topologyNodes: [],
            reputation: { hacker: 0, le: 0 },
            resources: { hacker: 1000, le: 1000 },
            identities: [], // 黑客虛擬身份
            courtPhase: false,
            internationalSupport: false,
            
            // 交易記錄
            transactionHistory: [],
            
            // ===== 新系統屬性 =====
            // ===== AI 隊伍分工體系 =====
            aiTeams: {
                law_enforcement: {
                    name: '執法AI隊伍',
                    members: [
                        { id: 'le_cmd', role: '指揮中心', function: '發布指令', status: 'active', health: 100 },
                        { id: 'le_forensics', role: '數位鑑識科', function: '證據修復', status: 'active', health: 100 },
                        { id: 'le_swat', role: '網絡特警隊', function: '主動攻擊', status: 'active', health: 100 }
                    ],
                    collaborationCooldown: 0,
                    lastAction: ''
                },
                hacker: {
                    name: '黑客AI隊伍',
                    members: [
                        { id: 'h_leader', role: '主黑客', function: '發動攻擊', status: 'active', health: 100 },
                        { id: 'h_proxy', role: '跳板管理員', function: '維護隱蔽', status: 'active', health: 100 },
                        { id: 'h_support', role: '暗網技術支援', function: '工具升級', status: 'active', health: 100 }
                    ],
                    collaborationCooldown: 0,
                    lastAction: ''
                }
            },
    
            // 技能樹系統
            skillTrees: {
                hacker: {
                    stealth: { level: 1, maxLevel: 5, cost: 5000, effect: '+10% 隱蔽度' },
                    encryption: { level: 1, maxLevel: 5, cost: 6000, effect: '+15% 加密強度' },
                    evasion: { level: 1, maxLevel: 5, cost: 7000, effect: '+20% 躲避偵測' },
                    counter_forensics: { level: 1, maxLevel: 5, cost: 8000, effect: '+25% 反取證能力' },
                    attack_power: { level: 1, maxLevel: 5, cost: 10000, effect: '+15% 攻擊力' }
                },
                law_enforcement: {
                    investigation: { level: 1, maxLevel: 5, cost: 5000, effect: '+10% 調查速度' },
                    tracking: { level: 1, maxLevel: 5, cost: 6000, effect: '+15% 追蹤精度' },
                    forensics: { level: 1, maxLevel: 5, cost: 7000, effect: '+20% 鑑識能力' },
                    collaboration: { level: 1, maxLevel: 5, cost: 8000, effect: '+25% 協作效率' },
                    defense: { level: 1, maxLevel: 5, cost: 10000, effect: '+15% 防禦力' }
                }
            },
            
            // 高階特殊技能系統
            specialSkills: {
                hacker: {
                    digital_evaporation: {
                        name: '數位蒸發',
                        description: '清除過去72小時內所有可追蹤的數位足跡',
                        cooldown: 1800, // 30分鐘
                        lastUsed: 0,
                        effect: 'clear_all_footprints',
                        cost: 50000
                    },
                    evidence_pollution_wave: {
                        name: '證據污染波',
                        description: '對特定類別證據進行大範圍數據注入',
                        cooldown: 900, // 15分鐘
                        lastUsed: 0,
                        effect: 'mass_evidence_pollution',
                        cost: 30000
                    },
                    channel_hijack: {
                        name: '協作頻道劫持',
                        description: '模仿指揮系統，發送虛假指令',
                        cooldown: 1200, // 20分鐘
                        lastUsed: 0,
                        effect: 'fake_command_injection',
                        cost: 40000
                    }
                },
                law_enforcement: {
                    net_capture_order: {
                        name: '全網圍捕令',
                        description: '強制要求ISP配合，大範圍壓縮匿名網路',
                        cooldown: 0, // 一次性使用
                        used: false,
                        effect: 'global_net_sweep',
                        cost: 100000
                    },
                    time_trap: {
                        name: '時間陷阱',
                        description: '偽裝系統漏洞，引誘黑客深入蜜罐',
                        cooldown: 600, // 10分鐘
                        lastUsed: 0,
                        effect: 'honeypot_deception',
                        cost: 25000
                    },
                    physical_digital_raid: {
                        name: '物理-數位同步突襲',
                        description: '同時進行網路斷流與實體抓捕',
                        cooldown: 0, // 條件觸發
                        lastUsed: 0,
                        effect: 'synchronized_arrest',
                        cost: 75000
                    }
                }
            },
            
            // 裝備系統
            equipmentSlots: {
                hacker: {
                    armor: null, // 隱蔽斗篷、防火牆等
                    weapon: null, // 攻擊工具
                    accessory: null // 輔助工具
                },
                law_enforcement: {
                    armor: null, // 防禦套件
                    weapon: null, // 攻擊工具
                    accessory: null // 輔助工具
                }
            },
            
            equipmentPool: [
                { id: 'stealth_cloak', type: 'armor', role: 'hacker', name: '隱蔽斗篷', bonus: '+15% 隱蔽度', cost: 30000 },
                { id: 'zero_day_kit', type: 'weapon', role: 'hacker', name: '零日工具包', bonus: '+25% 攻擊力', cost: 50000 },
                { id: 'proxy_chain', type: 'accessory', role: 'hacker', name: '代理鏈', bonus: '+10% 躲避', cost: 20000 },
                { id: 'defense_wall', type: 'armor', role: 'law_enforcement', name: '防禦牆', bonus: '+20% 防禦', cost: 40000 },
                { id: 'counter_strike', type: 'weapon', role: 'law_enforcement', name: '反擊工具', bonus: '+30% 攻擊力', cost: 55000 },
                { id: 'tracking_beacon', type: 'accessory', role: 'law_enforcement', name: '追蹤信標', bonus: '+15% 追蹤精度', cost: 25000 }
            ],
            
            // 聲望/等級系統
            playerLevel: {
                hacker: { level: 1, experience: 0, nextLevelExp: 1000, reputation: 0, title: '初級駭客' },
                law_enforcement: { level: 1, experience: 0, nextLevelExp: 1000, reputation: 0, title: '初級調查員' }
            },
            
            // 證據完整性系統
            evidenceIntegrity: {
                md5Hash: {},
                sha256Hash: {},
                timestamp: {},
                digitalSignature: {},
                chainOfCustody: []
            },
            
            // 搜查令申請系統
            searchWarrants: {
                requested: false,
                requirementsMet: false,
                requiredEvidence: 3,
                requiredLockLevel: 80,
                approvalStatus: 'pending', // pending, approved, denied
                timeline: []
            },
            
            // 聯合任務中心
            jointOperationCenter: {
                operationId: null,
                participatingDepts: [],
                sharedResources: {},
                operationPhase: 'planning', // planning, execution, completion
                timeline: []
            },
            
            // 自動存檔
            autoSaveInterval: null,
            lastSaveTime: null,
            
            // 玩家數據
            playerData: {
                hacker: {
                    money: 150000,
                    stealth: 60,
                    encryptionLevel: 40,
                    tools: [],
                    cooldowns: {},
                    attackPower: 15,
                    defensePower: 10,
                    controlProgress: 0,
                    digitalFootprints: 5,
                    compromisedEvidence: 0,
                    serverHealth: 100,
                    deviceHealth: 100,
                    criticalSystems: ['command_center', 'evidence_library', 'network_infrastructure'],
                    stolenDocuments: [],
                    decryptionProgress: 0,
                    compromisedDevices: [],
                    darknetCredits: 0,
                    activeVpnNodes: 3,
                    signalJamming: false,
                    realtimeIntel: [],
                    shopItems: [
                        { id: 'vpn_chain', name: '高級VPN鏈', price: 20000, effect: '+20%隱蔽度', category: 'stealth' },
                        { id: 'zero_day', name: '零日漏洞利用', price: 50000, effect: '+40攻擊力', category: 'attack' },
                        { id: 'crypto_mixer', name: '加密貨幣混合器', price: 30000, effect: '資金追蹤干擾', category: 'stealth' },
                        { id: 'ai_evasion', name: 'AI逃避工具', price: 40000, effect: '降低被偵測機率', category: 'stealth' },
                        { id: 'memory_attack', name: '記憶體無檔案攻擊套件', price: 60000, effect: '無痕跡攻擊', category: 'attack' },
                        { id: 'dynamic_proxy', name: '動態跳板網絡', price: 45000, effect: '隨機路由隱藏', category: 'stealth' },
                        { id: 'bait_server', name: '誘餌伺服器', price: 35000, effect: '誤導追蹤', category: 'counter' },
                        { id: 'fake_fingerprint', name: '偽造攻擊指紋工具', price: 55000, effect: '偽裝攻擊來源', category: 'counter' },
                        { id: 'signal_jammer', name: '協作頻道干擾器', price: 40000, effect: '阻斷通訊', category: 'counter' },
                        { id: 'darknet_access', name: '暗網委託市場介面', price: 70000, effect: '購買黑市工具', category: 'advanced' },
                        { id: 'phishing_kit', name: '社會工程釣魚生成器', price: 30000, effect: '欺騙目標', category: 'infiltration' },
                        { id: 'vulnerability_storage', name: '零漏洞儲存與部署模組', price: 80000, effect: '儲存攻擊工具', category: 'attack' },
                        { id: 'encryption_relay', name: '加密通道中繼器', price: 35000, effect: '加強加密通訊', category: 'stealth' },
                        { id: 'hardware_spoof', name: '硬體指紋偽造器', price: 50000, effect: '偽造設備識別', category: 'stealth' },
                        { id: 'node_crippler', name: '網路節點癱瘓工具', price: 65000, effect: '癱瘓網絡節點', category: 'attack' },
                        { id: 'ransomware', name: '高級勒索軟件', price: 75000, effect: '加密目標文件勒索', category: 'attack' },
                        { id: 'traffic_encryptor', name: '流量加密器', price: 45000, effect: '完全加密所有流量', category: 'stealth' },
                        { id: 'location_blur', name: '物理位置模糊器', icon: 'fa-braille', desc: '模糊真實物理定位', cooldown: 40, effect: 'blur', cost: 25000 },
                        { id: 'signal_spoof', name: '信號源偽造器', icon: 'fa-broadcast-tower', desc: '偽造無線信號來源', cooldown: 35, effect: 'spoof', cost: 18000 },
                        { id: 'identity_hider', name: '身份隱藏器', price: 55000, effect: '完全隱藏真實身份', category: 'stealth' },
                        { id: 'file_wiper', name: '文件擦除器', price: 40000, effect: '完全刪除痕跡', category: 'counter' },
                        { id: 'backdoor_implant', name: '持久後門植入', price: 60000, effect: '永久系統訪問', category: 'infiltration' }
                    ]
                },
                law_enforcement: {
                    budget: 1000000,
                    investigationProgress: 0,
                    evidenceChain: [],
                    criticalEvidence: [],
                    identityLock: {
                        technical: 0,
                        social: 0,
                        physical: 0
                    },
                    warrantProgress: 0,
                    warrantIssued: false,
                    arrestCountdown: null,
                    departments: {
                        cyber: { name: '網絡安全調查部門', active: true, resources: 100 },
                        criminal: { name: '刑事偵緝科', active: false, resources: 0 },
                        antiTerror: { name: '互聯網反恐科', active: false, resources: 0 },
                        forensic: { name: '數碼鑑證科', active: true, resources: 100 }
                    },
                    serverHealth: 100,
                    evidenceLibraryHealth: 100,
                    analysisToolsHealth: 100,
                    tools: [],
                    cooldowns: {},
                    dynamicIntel: [],
                    verifiedIntel: [],
                    networkSweepActive: false,
                    activeHoneypots: 0,
                    compromisedDevices: [],
                    gpsTracking: false,
                    signalBlocking: false,
                    realtimeTracking: [],
                    shopItems: [
                        { id: 'ai_analyst', name: 'AI分析師', price: 30000, effect: '+15%調查速度', category: 'investigation' },
                        { id: 'forensic_suite', name: '高級鑑識套件', price: 50000, effect: '證據質量提升', category: 'investigation' },
                        { id: 'interpol_access', name: '國際刑警資料庫訪問', price: 40000, effect: '全球追蹤能力', category: 'tracking' },
                        { id: 'cyber_swat', name: '網絡特警隊', price: 60000, effect: '即時反應部隊', category: 'defense' },
                        { id: 'digital_sandbox', name: '數碼鑑識沙盒', price: 55000, effect: '深度惡意軟件分析', category: 'investigation' },
                        { id: 'network_mapper', name: '網路流量繪圖儀', price: 45000, effect: '可視化流量分析', category: 'tracking' },
                        { id: 'social_analyzer', name: '社交圖譜分析器', price: 40000, effect: '社交網絡關聯分析', category: 'investigation' },
                        { id: 'threat_sensor', name: '全網威脅感測器', price: 60000, effect: '實時威脅檢測', category: 'defense' },
                        { id: 'emergency_shutdown', name: '緊急斷流', price: 35000, effect: '切斷網絡連接', category: 'defense' },
                        { id: 'intercept_key', name: '合法攔截密鑰', price: 70000, effect: '解密密碼通訊', category: 'decryption' },
                        { id: 'command_panel', name: '跨部門指揮面板', price: 50000, effect: '協調多部門行動', category: 'collaboration' },
                        { id: 'signal_blocker', name: '阻擋防止幹擾信號', price: 45000, effect: '防止通訊干擾', category: 'defense' },
                        { id: 'gps_tracker', name: '超強GPS衛星定位', price: 65000, effect: '精確位置追蹤', category: 'tracking' },
                        { id: 'cctv_access', name: '收集CCTV系統訪問', price: 40000, effect: '監控錄像分析', category: 'tracking' },
                        { id: 'password_cracker', name: '破解裝置加密密碼', price: 75000, effect: '強制解密密碼', category: 'decryption' },
                        { id: 'memory_forensics', name: '內存取證工具', price: 60000, effect: '分析內存攻擊痕跡', category: 'investigation' },
                        { id: 'blockchain_tracker', name: '區塊鏈追蹤系統', price: 80000, effect: '追蹤加密貨幣流向', category: 'tracking' },
                        { id: 'ai_predictor', name: 'AI行為預測系統', price: 90000, effect: '預測黑客行動', category: 'defense' },
                        { id: 'evidence_protector', name: '證據保護系統', price: 55000, effect: '防止證據污染', category: 'defense' },
                        { id: 'rapid_response', name: '快速反應小組', price: 70000, effect: '立即行動能力', category: 'defense' }
                    ]
                }
            },
            
            // 對手數據 (AI)
            opponentData: {
                hacker: {
                    money: 180000,
                    stealth: 70,
                    encryptionLevel: 50,
                    tools: ['nmap', 'metasploit', 'log_cleaner', 'spoofing', 'ddos'],
                    attackPattern: 'aggressive',
                    defenseLevel: 50,
                    digitalFootprints: 5,
                    compromisedEvidence: 0,
                    stolenDocuments: [],
                    activeVpnNodes: 4,
                    signalJamming: false,
                    serverHealth: 100,
                    deviceHealth: 100
                },
                law_enforcement: {
                    budget: 1000000,
                    investigationProgress: 0,
                    evidenceChain: [],
                    identityLock: {
                        technical: 0,
                        social: 0,
                        physical: 0
                    },
                    departments: {
                        cyber: { active: true, resources: 100 },
                        criminal: { active: true, resources: 80 },
                        antiTerror: { active: false, resources: 0 },
                        forensic: { active: true, resources: 90 }
                    },
                    aggressionLevel: 40,
                    dynamicIntel: [],
                    networkSweepActive: false,
                    serverHealth: 100,
                    evidenceLibraryHealth: 100,
                    analysisToolsHealth: 100
                }
            },
            
            // 遊戲時間
            gameStartTime: null,
            gameTimeLimit: 1500, // 25分鐘 (預設更長時間)
            gameTimer: null,
            
            // 專屬工具配置 (增強版)
            tools: {
                hacker: {
                    reconnaissance: [
                        { id: "fake_fingerprint", name: "虛假指紋注入器", icon: "fa-fingerprint", desc: "注入虛假數碼指紋，大幅混淆執法部門的身份鎖定進度", cooldown: 18, effect: "fake_fingerprint_effect", cost: 18000 },
                        { id: "darknet_delegator", name: "暗網任務委託器", icon: "fa-tasks", desc: "委託暗網黑客執行次要任務，自動增加控制進度並分散注意力", cooldown: 25, effect: "darknet_delegator_effect", cost: 25000 },
                        { id: "traffic_analyzer", name: "網絡流量分析儀", icon: "fa-chart-line", desc: "實時顯示對方網絡活動，幫助判斷對方策略", cooldown: 10, effect: "analyze", cost: 20000 },
                        { id: "emergency_repair", name: "應急維修工具", icon: "fa-tools", desc: "快速修復自身受損系統，恢復30%健康值", cooldown: 25, effect: "repair", cost: 25000 },
                        { id: "nmap", name: "Nmap掃描器", icon: "fa-search", desc: "掃描目標網絡拓撲和開放端口", cooldown: 5, effect: "scan", cost: 1000 },
                        { id: "whois", name: "Whois深度查詢", icon: "fa-address-card", desc: "查詢目標域名註冊信息及歷史記錄", cooldown: 3, effect: "info", cost: 800 },
                        { id: "dns_enum", name: "DNS深度枚舉", icon: "fa-sitemap", desc: "枚舉目標DNS記錄、子域名和關聯服務", cooldown: 4, effect: "info", cost: 1200 },
                        { id: "device_scanner", name: "設備掃描器", icon: "fa-mobile-alt", desc: "掃描目標網絡中的連接設備", cooldown: 6, effect: "scan", cost: 2000 },
                        { id: "port_scanner", name: "端口掃描器", icon: "fa-plug", desc: "深度掃描目標開放端口及服務", cooldown: 7, effect: "scan", cost: 1500 }
                    ],
                    stealth: [
                        { id: "log_cleaner", name: "智能日誌清理工具", icon: "fa-eraser", desc: "清除系統日誌、訪問記錄及審計追蹤", cooldown: 8, effect: "stealth", cost: 5000 },
                        { id: "traffic_disguise", name: "AI流量偽裝器", icon: "fa-mask", desc: "使用AI算法偽裝攻擊流量為正常業務流量", cooldown: 10, effect: "stealth", cost: 8000 },
                        { id: "proxy_chain", name: "多重動態代理鏈", icon: "fa-link", desc: "通過7層動態代理隱藏真實IP地址", cooldown: 6, effect: "stealth", cost: 6000 },
                        { id: "traffic_hider", name: "流量/身份隱藏器", icon: "fa-eye-slash", desc: "完全隱藏網絡流量和身份信息", cooldown: 12, effect: "stealth", cost: 15000 },
                        { id: "dynamic_jumpnet", name: "動態跳板網絡", icon: "fa-random", desc: "建立隨機路由的跳板網絡隱藏真實位置", cooldown: 15, effect: "stealth", cost: 20000 },
                        { id: "identity_hider", name: "身份隱藏器", icon: "fa-user-secret", desc: "完全隱藏真實身份信息", cooldown: 18, effect: "stealth", cost: 25000 },
                        { id: "traffic_encryptor", name: "流量加密器", icon: "fa-lock", desc: "完全加密所有網絡流量", cooldown: 14, effect: "stealth", cost: 22000 }
                    ],
                    counter_investigation: [
                        { id: "traffic_analyzer", name: "網絡流量分析儀", icon: "fa-chart-line", desc: "實時顯示對方網絡活動，幫助判斷對方策略", cooldown: 10, effect: "analyze", cost: 20000 },
                        { id: "emergency_repair", name: "應急維修工具", icon: "fa-tools", desc: "快速修復自身受損系統，恢復30%健康值", cooldown: 25, effect: "repair", cost: 25000 },
                        { id: "evidence_pollution", name: "智能證據污染攻擊", icon: "fa-virus", desc: "污染執法部門證據庫並植入混淆數據", cooldown: 15, effect: "counter", cost: 12000 },
                        { id: "analysis_jamming", name: "高級分析工具干擾", icon: "fa-bug", desc: "干擾執法部門的AI分析系統和機器學習模型", cooldown: 12, effect: "counter", cost: 10000 },
                        { id: "fake_command", name: "跨部門偽造協作指令", icon: "fa-file-signature", desc: "模仿執法系統向多部門發送虛假指令", cooldown: 20, effect: "counter", cost: 15000 },
                        { id: "data_injection", name: "數據注入攻擊", icon: "fa-syringe", desc: "向證據庫注入偽造數據污染證據鏈", cooldown: 18, effect: "counter", cost: 14000 },
                        { id: "signal_jammer", name: "協作頻道/信號干擾器", icon: "fa-wifi-slash", desc: "干擾執法部門的通訊和協作頻道", cooldown: 14, effect: "counter", cost: 16000 },
                        { id: "file_wiper", name: "文件擦除器", icon: "fa-trash", desc: "完全刪除系統痕跡和日誌", cooldown: 16, effect: "counter", cost: 18000 },
                        { id: "evidence_protector_breach", name: "證據保護系統破解", icon: "fa-shield-alt", desc: "破解證據保護系統", cooldown: 20, effect: "counter", cost: 20000 },
                        { id: "mass_contamination", name: "大規模證據污染攻擊", icon: "fa-biohazard", desc: "執行高級持久性污染攻擊污染所有證據", cooldown: 25, effect: "counter", cost: 30000 },
                        { id: "evidence_wiper", name: "證據徹底抹除器", icon: "fa-fire", desc: "徹底銷毀關鍵證據無法恢復", cooldown: 30, effect: "counter", cost: 40000 }
                    ],
                    attack: [
                        { id: "metasploit", name: "Metasploit框架", icon: "fa-crosshairs", desc: "利用已知系統漏洞進行精準攻擊", cooldown: 10, effect: "attack", cost: 10000 },
                        { id: "ddos", name: "DDoS攻擊集群", icon: "fa-bolt", desc: "發動大規模分散式阻斷服務攻擊", cooldown: 18, effect: "attack", cost: 20000 },
                        { id: "backdoor", name: "持久性後門植入", icon: "fa-door-open", desc: "創建多重隱藏後門維持持久訪問", cooldown: 15, effect: "attack", cost: 15000 },
                        { id: "data_wipe", name: "數據擦除攻擊", icon: "fa-trash", desc: "定向擦除執法部門證據庫數據", cooldown: 25, effect: "attack", cost: 30000 },
                        { id: "memory_attack", name: "記憶體無檔案攻擊套件", icon: "fa-memory", desc: "在記憶體中執行攻擊不留痕跡", cooldown: 20, effect: "attack", cost: 25000 },
                        { id: "server_cripple", name: "伺服器癱瘓攻擊", icon: "fa-server", desc: "針對性癱瘓執法部門伺服器", cooldown: 30, effect: "attack", cost: 40000 },
                        { id: "node_crippler", name: "網路節點癱瘓工具", icon: "fa-network-wired", desc: "癱瘓關鍵網絡節點和路由", cooldown: 22, effect: "attack", cost: 28000 },
                        { id: "ransomware", name: "高級勒索軟件", icon: "fa-lock", desc: "加密目標文件進行勒索", cooldown: 25, effect: "attack", cost: 35000 }
                    ],
                    infiltration: [
                        { id: "device_hack", name: "設備入侵", icon: "fa-laptop-code", desc: "入侵執法部門電腦和移動設備", cooldown: 16, effect: "infiltrate", cost: 18000 },
                        { id: "document_steal", name: "機密文件竊取", icon: "fa-file-steal", desc: "竊取執法部門機密文件和數據", cooldown: 20, effect: "infiltrate", cost: 22000 },
                        { id: "decryption_attack", name: "加密破解攻擊", icon: "fa-unlock-alt", desc: "破解加密文件和通訊", cooldown: 25, effect: "infiltrate", cost: 30000 },
                        { id: "browser_exploit", name: "瀏覽器漏洞利用", icon: "fa-window-maximize", desc: "利用瀏覽器漏洞獲取信息", cooldown: 14, effect: "infiltrate", cost: 16000 },
                        { id: "server_infiltration", name: "伺服器滲透", icon: "fa-server", desc: "深度滲透目標伺服器系統", cooldown: 22, effect: "infiltrate", cost: 28000 },
                        { id: "backdoor_implant", name: "持久後門植入", icon: "fa-door-closed", desc: "植入永久性後門系統", cooldown: 30, effect: "infiltrate", cost: 40000 }
                    ],
                    advanced: [
                        { id: "bait_server", name: "誘餌伺服器", icon: "fa-honey-pot", desc: "設置誘餌伺服器誤導追蹤", cooldown: 18, effect: "advanced", cost: 20000 },
                        { id: "fake_fingerprint", name: "偽造攻擊指紋工具", icon: "fa-fingerprint", desc: "偽造攻擊指紋和工具特徵", cooldown: 15, effect: "advanced", cost: 18000 },
                        { id: "phishing_generator", name: "社會工程釣魚生成器", icon: "fa-fish", desc: "生成釣魚攻擊和社會工程工具", cooldown: 12, effect: "advanced", cost: 15000 },
                        { id: "encryption_relay", name: "加密通道中繼器", icon: "fa-exchange-alt", desc: "建立加密中繼通道保護通訊", cooldown: 10, effect: "advanced", cost: 12000 },
                        { id: "hardware_spoof", name: "硬體指紋偽造器", icon: "fa-microchip", desc: "偽造硬體指紋和設備識別", cooldown: 16, effect: "advanced", cost: 22000 },
                        { id: "darknet_market", name: "暗網委託市場", icon: "fa-shopping-bag", desc: "訪問暗網市場購買黑市工具", cooldown: 30, effect: "advanced", cost: 50000 }
                    ],
                    server_management: [
                        { id: "server_console", name: "伺服器控制台", icon: "fa-terminal", desc: "打開伺服器管理控制台", cooldown: 3, effect: "server_mgmt", cost: 500 },
                        { id: "server_status", name: "系統資源監控", icon: "fa-chart-line", desc: "查看 CPU、內存、磁碟使用狀況", cooldown: 2, effect: "server_mgmt", cost: 300 },
                        { id: "server_logs", name: "伺服器日誌查詢", icon: "fa-file-alt", desc: "查詢伺服器訪問記錄和錯誤日誌", cooldown: 3, effect: "server_mgmt", cost: 600 },
                        { id: "server_terminal", name: "終端指令模擬", icon: "fa-code", desc: "執行模擬 Linux/Windows 指令", cooldown: 2, effect: "server_mgmt", cost: 400 },
                        { id: "service_control", name: "服務管理", icon: "fa-cogs", desc: "啟動/停止伺服器服務", cooldown: 5, effect: "server_mgmt", cost: 800 },
                        { id: "process_monitor", name: "進程監控", icon: "fa-tasks", desc: "查看和管理運行中的進程", cooldown: 3, effect: "server_mgmt", cost: 700 },
                        { id: "network_monitor", name: "網絡連接監控", icon: "fa-network-wired", desc: "查看網絡連接和端口狀況", cooldown: 3, effect: "server_mgmt", cost: 600 }
                    ]
                },
                law_enforcement: {
                    investigation: [
                        { id: "evidence_verifier", name: "證據完整性驗證工具及備份系統", icon: "fa-shield-virus", desc: "驗證證據完整性並建立加密備份，防止黑客污染或銷毀證據", cooldown: 20, effect: "evidence_verifier_effect", cost: 22000 },
                        { id: "emergency_dispatch", name: "緊急調度支援儀", icon: "fa-truck-emergency", desc: "調動特種技術小組支援，瞬間提升調查進度並修復受損系統", cooldown: 30, effect: "emergency_dispatch_effect", cost: 35000 },
                        { id: "vpn_tracker", name: "VPN節點跟蹤器", icon: "fa-map-marker-alt", desc: "穿透多層 VPN 代理，直接追蹤黑客的真實物理跳板位置", cooldown: 15, effect: "vpn_tracker_effect", cost: 28000 },
                        { id: "traffic_analyzer", name: "網絡流量分析儀", icon: "fa-chart-line", desc: "實時顯示對方網絡活動，幫助判斷對方策略", cooldown: 10, effect: "analyze", cost: 20000 },
                        { id: "emergency_repair", name: "應急維修工具", icon: "fa-tools", desc: "快速修復自身受損系統，恢復30%健康值", cooldown: 25, effect: "repair", cost: 25000 },
                        { id: "digital_forensics", name: "高級數碼鑑識沙盒", icon: "fa-search", desc: "深度分析惡意軟件、攻擊工具及行為模式", cooldown: 5, effect: "investigate", cost: 8000 },
                        { id: "network_mapping", name: "實時網絡流量繪圖儀", icon: "fa-project-diagram", desc: "可視化網絡流量、連接關係及異常模式", cooldown: 6, effect: "investigate", cost: 10000 },
                        { id: "log_analyzer", name: "AI日誌分析系統", icon: "fa-file-alt", desc: "使用AI分析系統日誌尋找異常行為", cooldown: 4, effect: "investigate", cost: 6000 },
                        { id: "memory_forensics", name: "內存取證分析", icon: "fa-memory", desc: "分析系統內存中的惡意代碼殘留", cooldown: 7, effect: "investigate", cost: 12000 },
                        { id: "social_analyzer", name: "社交圖譜分析器", icon: "fa-users", desc: "分析社交網絡關聯和行為模式", cooldown: 8, effect: "investigate", cost: 15000 },
                        { id: "behavior_analysis", name: "行為模式分析", icon: "fa-brain", desc: "分析黑客行為模式預測下一步", cooldown: 9, effect: "investigate", cost: 13000 }
                    ],
                    tracking: [
                        { id: "social_graph", name: "社交圖譜關聯分析器", icon: "fa-users", desc: "分析社交網絡關聯、時間線及行為模式", cooldown: 8, effect: "track", cost: 15000 },
                        { id: "ip_tracker", name: "全球IP追蹤系統", icon: "fa-map-marker-alt", desc: "追蹤IP地址的地理位置、ISP及歷史記錄", cooldown: 7, effect: "track", cost: 12000 },
                        { id: "crypto_tracker", name: "區塊鏈加密貨幣追蹤", icon: "fa-coins", desc: "追蹤加密貨幣交易記錄及資金流向", cooldown: 10, effect: "track", cost: 20000 },
                        { id: "osint_collector", name: "OSINT情報收集器", icon: "fa-globe", desc: "收集公開來源情報及網絡足跡", cooldown: 5, effect: "track", cost: 8000 },
                        { id: "gps_tracker", name: "超強GPS衛星定位", icon: "fa-satellite", desc: "精確追蹤目標地理位置", cooldown: 12, effect: "track", cost: 25000 },
                        { id: "cctv_access", name: "CCTV監控訪問", icon: "fa-video", desc: "訪問和分析監控錄像", cooldown: 10, effect: "track", cost: 18000 },
                        { id: "blockchain_tracker", name: "區塊鏈追蹤系統", icon: "fa-link", desc: "深度追蹤加密貨幣交易鏈", cooldown: 15, effect: "track", cost: 30000 }
                    ],
                    defense: [
                        { id: "honeypot", name: "智能主動蜜罐系統", icon: "fa-bug", desc: "部署陷阱伺服器誘捕黑客並收集攻擊特徵", cooldown: 12, effect: "defend", cost: 25000 },
                        { id: "network_sweep", name: "網絡圍捕行動", icon: "fa-network-wired", desc: "壓縮黑客可用匿名節點及跳板網絡", cooldown: 15, effect: "defend", cost: 30000 },
                        { id: "traffic_intercept", name: "合法流量深度攔截", icon: "fa-shield-alt", desc: "攔截和分析可疑流量進行取證", cooldown: 8, effect: "defend", cost: 18000 },
                        { id: "server_hardening", name: "指揮中心強化", icon: "fa-server", desc: "加強指揮中心伺服器安全防護", cooldown: 10, effect: "defend", cost: 20000 },
                        { id: "signal_blocker", name: "阻擋防止幹擾信號", icon: "fa-wifi", desc: "防止通訊干擾和信號阻斷", cooldown: 14, effect: "defend", cost: 22000 },
                        { id: "emergency_shutdown", name: "緊急斷流", icon: "fa-power-off", desc: "緊急切斷可疑網絡連接", cooldown: 20, effect: "defend", cost: 28000 },
                        { id: "evidence_protector", name: "證據保護系統", icon: "fa-shield-alt", desc: "保護證據庫免受污染", cooldown: 16, effect: "defend", cost: 24000 },
                        { id: "ai_predictor", name: "AI行為預測系統", icon: "fa-robot", desc: "預測黑客下一步行動", cooldown: 18, effect: "defend", cost: 32000 },
                        { id: "contamination_detector", name: "智能污染檢測系統", icon: "fa-microscope", desc: "實時監測證據污染並生成警報", cooldown: 10, effect: "defend", cost: 22000 },
                        { id: "evidence_cleanser", name: "證據清潔與恢復系統", icon: "fa-droplet", desc: "深度清潔和恢復污染證據", cooldown: 18, effect: "defend", cost: 28000 },
                        { id: "identity_lock_enhancer", name: "三階層身份鎖定強化", icon: "fa-lock", desc: "強化技術/社交/實體三階層身份鎖定", cooldown: 12, effect: "defend", cost: 25000 }
                    ],
                    collaboration: [
                        { id: "department_coord", name: "跨部門指揮協調面板", icon: "fa-users-cog", desc: "協調多部門聯合調查與資源共享", cooldown: 10, effect: "collaborate", cost: 15000 },
                        { id: "interpol_request", name: "國際刑警協作請求", icon: "fa-globe", desc: "請求國際執法部門協助及資料共享", cooldown: 20, effect: "interpol_request", cost: 35000 },
                        { id: "warrant_request", name: "逮捕令申請系統", icon: "fa-file-contract", desc: "申請正式逮捕令及司法授權", cooldown: 25, effect: "collaborate", cost: 40000 },
                        { id: "joint_operation", name: "聯合行動協調", icon: "fa-handshake", desc: "組織跨部門聯合執法行動", cooldown: 30, effect: "collaborate", cost: 50000 },
                        { id: "command_panel", name: "跨部門指揮面板", icon: "fa-tv", desc: "協調多部門指揮和資源分配", cooldown: 12, effect: "collaborate", cost: 18000 },
                        { id: "resource_allocator", name: "資源分配系統", icon: "fa-cogs", desc: "智能分配部門資源", cooldown: 14, effect: "collaborate", cost: 20000 },
                        { id: "joc_center", name: "聯合任務中心", icon: "fa-building", desc: "啟動多部門聯合任務中心", cooldown: 30, effect: "collaborate", cost: 45000 }
                    ],
                    forensics: [
                        { id: "evidence_hash_verify", name: "證據完整性驗證", icon: "fa-certificate", desc: "計算並驗證MD5/SHA256哈希值確保證據完整", cooldown: 10, effect: "forensics", cost: 12000 },
                        { id: "chain_of_custody", name: "監管鏈記錄系統", icon: "fa-link", desc: "記錄證據從收集到呈堂的完整監管日誌", cooldown: 12, effect: "forensics", cost: 15000 },
                        { id: "contamination_prevention", name: "主動污染防護", icon: "fa-shield-virus", desc: "啟動實時監控防止證據被污染", cooldown: 15, effect: "forensics", cost: 18000 },
                        { id: "wireshark_simulator", name: "Wireshark網路分析", icon: "fa-ethernet", desc: "進行即時網路封包分析和取證", cooldown: 16, effect: "forensics", cost: 22000 },
                        { id: "ftk_forensics", name: "FTK數碼鑑識", icon: "fa-hard-drive", desc: "使用FTK進行高級數碼取證分析", cooldown: 18, effect: "forensics", cost: 28000 }
                    ],
                    skills: [
                        { id: "skill_upgrade", name: "技能升級面板", icon: "fa-trophy", desc: "升級個人技能提升調查和防禦能力", cooldown: 20, effect: "skills", cost: 25000 },
                        { id: "equipment_management", name: "裝備管理系統", icon: "fa-toolbox", desc: "查看、購買和裝備專業工具和防衛裝備", cooldown: 15, effect: "skills", cost: 20000 },
                        { id: "level_up_check", name: "等級晉升檢驗", icon: "fa-graduation-cap", desc: "檢查升級進度和解鎖新能力", cooldown: 10, effect: "skills", cost: 10000 }
                    ],
                    decryption: [
                        { id: "password_cracker", name: "破解裝置加密密碼", icon: "fa-unlock", desc: "強制破解加密設備和文件", cooldown: 18, effect: "decrypt", cost: 32000 },
                        { id: "intercept_key", name: "合法攔截密鑰", icon: "fa-key", desc: "獲取合法攔截加密通訊的權限", cooldown: 25, effect: "decrypt", cost: 45000 },
                        { id: "decryption_suite", name: "高級解密套件", icon: "fa-code", desc: "解密各類加密文件和通訊", cooldown: 20, effect: "decrypt", cost: 38000 },
                        { id: "threat_analysis", name: "全網威脅感測器", icon: "fa-radar", desc: "檢測和分析全網威脅", cooldown: 15, effect: "decrypt", cost: 28000 },
                        { id: "encryption_breaker", name: "加密破解系統", icon: "fa-unlock-alt", desc: "深度破解高級加密系統", cooldown: 22, effect: "decrypt", cost: 40000 }
                    ],
                    attack: [
                        { id: "counter_attack", name: "反擊系統", icon: "fa-crosshairs", desc: "對黑客發動反擊", cooldown: 30, effect: "attack", cost: 50000 },
                        { id: "backtrace", name: "反向追蹤攻擊", icon: "fa-search-location", desc: "反向追蹤黑客位置", cooldown: 25, effect: "attack", cost: 45000 },
                        { id: "system_lockdown", name: "系統鎖定", icon: "fa-lock", desc: "鎖定黑客系統", cooldown: 20, effect: "attack", cost: 35000 },
                        { id: "rapid_response", name: "快速反應攻擊", icon: "fa-bolt", desc: "快速反應對黑客系統造成傷害", cooldown: 18, effect: "attack", cost: 30000 }
                    ],
                    server_management: [
                        { id: "server_console", name: "指揮中心控制台", icon: "fa-terminal", desc: "打開指揮中心管理控制台", cooldown: 3, effect: "server_mgmt", cost: 500 },
                        { id: "server_status", name: "系統資源監控", icon: "fa-chart-line", desc: "查看 CPU、內存、磁碟使用狀況", cooldown: 2, effect: "server_mgmt", cost: 300 },
                        { id: "server_logs", name: "系統日誌查詢", icon: "fa-file-alt", desc: "查詢系統訪問記錄和事件日誌", cooldown: 3, effect: "server_mgmt", cost: 600 },
                        { id: "server_terminal", name: "終端指令模擬", icon: "fa-code", desc: "執行模擬系統指令", cooldown: 2, effect: "server_mgmt", cost: 400 },
                        { id: "service_control", name: "服務管理", icon: "fa-cogs", desc: "啟動/停止系統服務", cooldown: 5, effect: "server_mgmt", cost: 800 },
                        { id: "process_monitor", name: "進程監控", icon: "fa-tasks", desc: "查看和管理系統進程", cooldown: 3, effect: "server_mgmt", cost: 700 },
                        { id: "network_monitor", name: "網絡連接監控", icon: "fa-network-wired", desc: "查看網絡連接和端口狀況", cooldown: 3, effect: "server_mgmt", cost: 600 }
                    ]
                }
            },
            
            // 證據類型定義
            evidenceTypes: [
                { id: 'ip_logs', name: 'IP訪問日誌', category: 'technical', critical: false, value: 5 },
                { id: 'malware_sample', name: '惡意軟件樣本', category: 'technical', critical: true, value: 15 },
                { id: 'vpn_logs', name: 'VPN連接記錄', category: 'technical', critical: false, value: 8 },
                { id: 'social_post', name: '社交媒體發文', category: 'social', critical: false, value: 7 },
                { id: 'online_profile', name: '網絡身份檔案', category: 'social', critical: true, value: 12 },
                { id: 'crypto_transaction', name: '加密貨幣交易', category: 'social', critical: true, value: 18 },
                { id: 'device_fingerprint', name: '設備指紋', category: 'physical', critical: false, value: 10 },
                { id: 'location_data', name: '地理位置數據', category: 'physical', critical: true, value: 20 },
                { id: 'payment_record', name: '支付記錄', category: 'physical', critical: true, value: 25 },
                { id: 'browser_history', name: '瀏覽器歷史記錄', category: 'technical', critical: false, value: 6 },
                { id: 'email_record', name: '電子郵件記錄', category: 'social', critical: true, value: 15 },
                { id: 'device_spec', name: '設備規格信息', category: 'technical', critical: false, value: 8 },
                { id: 'network_traffic', name: '網絡流量數據', category: 'technical', critical: true, value: 22 },
                { id: 'encryption_key', name: '加密密鑰片段', category: 'technical', critical: true, value: 30 }
            ],
            
            // 動態情報類型
            intelTypes: [
                { id: 'ip_leak', name: 'IP地址洩露', category: 'technical', real: true },
                { id: 'social_leak', name: '社交媒體活動', category: 'social', real: true },
                { id: 'device_info', name: '設備信息', category: 'technical', real: true },
                { id: 'location_hint', name: '位置提示', category: 'physical', real: true },
                { id: 'fake_ip', name: '偽造IP地址', category: 'technical', real: false },
                { id: 'fake_social', name: '偽造社交資料', category: 'social', real: false },
                { id: 'fake_device', name: '偽造設備信息', category: 'technical', real: false },
                { id: 'fake_location', name: '偽造位置信息', category: 'physical', real: false }
            ],
            
            // 機密文件類型
            documentTypes: [
                { id: 'investigation_report', name: '調查報告', value: 50, encrypted: true },
                { id: 'warrant_docs', name: '逮捕令文件', value: 75, encrypted: true },
                { id: 'agent_list', name: '特工名單', value: 100, encrypted: true },
                { id: 'system_blueprint', name: '系統藍圖', value: 60, encrypted: true },
                { id: 'encryption_keys', name: '加密密鑰庫', value: 90, encrypted: true },
                { id: 'operation_plans', name: '行動計劃', value: 80, encrypted: true }
            ],
            
            // 被入侵設備類型
            deviceTypes: [
                { id: 'police_laptop', name: '警用筆記本電腦', os: 'Windows 11', specs: 'i7, 16GB RAM, 512GB SSD' },
                { id: 'server_rack', name: '伺服器機架', os: 'Linux Server', specs: 'Dual Xeon, 64GB RAM, 10TB RAID' },
                { id: 'mobile_device', name: '移動設備', os: 'Android/iOS', specs: 'Various models' },
                { id: 'network_router', name: '網絡路由器', os: 'Custom Firmware', specs: 'Enterprise grade' },
                { id: 'surveillance_cam', name: '監控攝像頭', os: 'Embedded Linux', specs: '4K, Night vision' }
            ],
            
            // 任務目標
            missions: {
                hacker: [
                    { id: 'stealth_high', name: '保持隱蔽度 > 80%', status: 'incomplete' },
                    { id: 'footprints_low', name: '數碼足跡 < 3', status: 'incomplete' },
                    { id: 'decrypt_docs', name: '解密至少2份機密文件', status: 'incomplete' },
                    { id: 'compromise_devices', name: '入侵至少3台設備', status: 'incomplete' },
                    { id: 'pollute_evidence', name: '污染至少5項證據', status: 'incomplete' }
                ],
                law_enforcement: [
                    { id: 'identity_lock', name: '三階層身份鎖定 > 80%', status: 'incomplete' },
                    { id: 'critical_evidence', name: '收集至少3項關鍵證據', status: 'incomplete' },
                    { id: 'verify_intel', name: '驗證至少5條情報', status: 'incomplete' },
                    { id: 'coordinate_depts', name: '協調所有部門', status: 'incomplete' },
                    { id: 'arrest_warrant', name: '申請逮捕令', status: 'incomplete' }
                ]
            }
        };

        // ===== 頁面導航函數 =====
        function goToMainPage() {
            showPage('main-page');
            GameState.currentPage = 'main';
            updateNavActive();
        }

        function showSetupPage() {
            if (!GameState.currentRole) {
                showNotification('請先選擇角色', '請返回主頁選擇黑客或執法部門角色。', 'warning');
                return;
            }
            
            showPage('season2-setup-page');
            GameState.currentPage = 'setup';
            updateNavActive();
            updateSetupPage();
        }

        // 設備與網絡監控頁面
        function showDeviceNetworkMonitor() {
            if (!GameState.currentRole) {
                showNotification('請先選擇角色', '請返回主頁選擇角色。', 'warning');
                return;
            }
            showPage('device-network-monitor-page');
            GameState.currentPage = 'monitor';
            updateNavActive();
            updateDeviceMonitorUI();
        }

        // 目標情報頁面（執法部門專屬）
        function showTargetIntelligence() {
            if (GameState.currentRole !== 'law_enforcement') {
                showNotification('權限不足', '此功能僅限執法部門人員使用', 'warning');
                addTerminalLine('[權限拒絕] 嘗試訪問執法部門專屬功能: 目標情報', 'error');
                return;
            }
            showPage('target-intelligence-page');
            GameState.currentPage = 'intelligence';
            updateNavActive();
            addTerminalLine('[訪問] 已打開詳細目標情報分析頁面', 'info');
        }

        // 暗網市場頁面（黑客專屬）
        function showDarknetMarketplace() {
            if (GameState.currentRole !== 'hacker') {
                showNotification('權限不足', '此功能僅限黑客使用', 'warning');
                addTerminalLine('[權限拒絕] 嘗試訪問黑客專屬功能: 暗網市場', 'error');
                return;
            }
            showPage('darknet-marketplace-page');
            GameState.currentPage = 'darknet-market';
            updateNavActive();
            addTerminalLine('[訪問] 已進入暗網中介聯絡站', 'info');
        }

        // 角色菜單控制
        function toggleRoleMenu() {
            const menu = document.getElementById('role-submenu');
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        function closeRoleMenu() {
            const menu = document.getElementById('role-submenu');
            if (menu) {
                menu.style.display = 'none';
            }
        }

        // per-card toggles
        function toggleRoleMenuFor(id) {
            const menu = document.getElementById(id);
            if (!menu) return;
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function closeRoleMenuFor(id) {
            const menu = document.getElementById(id);
            if (menu) menu.style.display = 'none';
        }

        // 點擊頁面其他地方關閉菜單
        document.addEventListener('click', (e) => {
            // close legacy top nav menu if present
            const menu = document.getElementById('role-submenu');
            const toggle = document.getElementById('nav-role-tools');
            if (menu && toggle && !menu.contains(e.target) && !toggle.contains(e.target)) {
                menu.style.display = 'none';
            }
            // close per-card menus if clicking outside
            ['hacker-role-submenu','le-role-submenu'].forEach(id => {
                const m = document.getElementById(id);
                const t = document.getElementById(id.replace('-submenu','-tools'));
                if (m && t && !m.contains(e.target) && !t.contains(e.target)) {
                    m.style.display = 'none';
                }
            });
        });

        // 更新設備監控UI
        function updateDeviceMonitorUI() {
            const role = GameState.currentRole;
            let monitorInterval;
            
            // 動態更新自己的設備信息
            if (role === 'hacker') {
                // 黑客設備信息
                document.getElementById('my-device-status').innerHTML = '●隱蔽中';
                document.getElementById('my-device-status').style.color = '#ffaa00';
                document.getElementById('my-device-status').style.fontWeight = 'bold';
            } else {
                // 執法部門設備信息
                document.getElementById('my-device-status').innerHTML = '●防禦中';
                document.getElementById('my-device-status').style.color = '#4a90d9';
                document.getElementById('my-device-status').style.fontWeight = 'bold';
            }
            
            // 設置實時更新監控數據 (3秒更新一次)
            if (GameState.deviceMonitorInterval) {
                clearInterval(GameState.deviceMonitorInterval);
            }
            
            GameState.deviceMonitorInterval = setInterval(() => {
                try {
                    // 隨機生成現實的設備數據
                    const threatLevel = Math.floor(Math.random() * 40) + 50;
                    const ramUsage = Math.floor(Math.random() * 50) + 40;
                    const cpuUsage = Math.floor(Math.random() * 60) + 20;
                    const uploadSpeed = Math.floor(Math.random() * 600) + 600;
                    const downloadSpeed = Math.floor(Math.random() * 800) + 800;
                    const activeConnections = Math.floor(Math.random() * 30) + 15;
                    const anomalies = Math.floor(Math.random() * 5);
                    
                    // 更新對手設備信息卡片
                    const opponentCards = document.querySelectorAll('.device-info-card');
                    if (opponentCards.length > 8) {
                        // 對手威脅等級
                        opponentCards[8].querySelector('.device-stat-value')?.textContent || 'N/A';
                        const threatBar = opponentCards[8].querySelector('[style*="width"]');
                        if (threatBar) threatBar.style.width = threatLevel + '%';
                        
                        // 對手RAM使用
                        opponentCards[9].querySelector('.device-stat-value')?.textContent || 'N/A';
                        const ramBar = opponentCards[9].querySelector('[style*="width"]');
                        if (ramBar) ramBar.style.width = ramUsage + '%';
                    }
                    
                    // 更新網絡活動指標卡片
                    const metricCards = document.querySelectorAll('.metric-card');
                    if (metricCards.length >= 4) {
                        // 上傳速度
                        metricCards[0].querySelector('.metric-value')?.textContent || 'N/A';
                        // 下載速度
                        metricCards[1].querySelector('.metric-value')?.textContent || 'N/A';
                        // 活躍連接數
                        metricCards[2].querySelector('.metric-value')?.textContent || 'N/A';
                        // 異常檢測
                        metricCards[3].querySelector('.metric-value')?.textContent || 'N/A';
                    }
                    
                    // 更新威脅等級顏色
                    const opponentStatus = document.getElementById('opponent-device-status');
                    if (opponentStatus) {
                        if (threatLevel > 80) {
                            opponentStatus.innerHTML = '●嚴重威脅';
                            opponentStatus.style.color = '#ff3333';
                        } else if (threatLevel > 60) {
                            opponentStatus.innerHTML = '●中等威脅';
                            opponentStatus.style.color = '#ffaa00';
                        } else {
                            opponentStatus.innerHTML = '●低威脅';
                            opponentStatus.style.color = '#00ff41';
                        }
                    }
                } catch (e) {
                    console.log('[監控系統] 數據更新異常:', e.message);
                }
            }, 3000);
        }

        function showGamePage() {
            showPage('game-page');
            GameState.currentPage = 'game';
            updateNavActive();
        }

        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.add('active');
                page.style.display = 'block';
                window.scrollTo(0, 0);
            }
        }

        function updateNavActive() {
            const navItems = document.querySelectorAll('.nav-menu li a');
            navItems.forEach(item => item.classList.remove('active'));
            
            switch(GameState.currentPage) {
                case 'main':
                    document.getElementById('nav-home').classList.add('active');
                    break;
                case 'setup':
                    document.getElementById('nav-season2').classList.add('active');
                    break;
                case 'battlemap':
                    document.getElementById('nav-battlemap').classList.add('active');
                    break;
                case 'game':
                    document.getElementById('nav-season2').classList.add('active');
                    break;
            }
    }

        // ===== 漢堡菜單控制 =====
        function toggleMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const mobileMenu = document.getElementById('nav-menu-mobile');
            
            hamburger.classList.toggle('active');
            mobileMenu.classList.toggle('active');
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('hamburger-menu');
            const mobileMenu = document.getElementById('nav-menu-mobile');
            
            hamburger.classList.remove('active');
            mobileMenu.classList.remove('active');
        }

        // 點擊頁面其他地方時關閉菜單
        document.addEventListener('click', function(event) {
            const hamburger = document.getElementById('hamburger-menu');
            const mobileMenu = document.getElementById('nav-menu-mobile');
            
            if (!hamburger.contains(event.target) && !mobileMenu.contains(event.target)) {
                hamburger.classList.remove('active');
                mobileMenu.classList.remove('active');
            }
    });

        // ===== 戰況地圖函數 =====
        function showBattleMap() {
            showPage('battle-map-page');
            GameState.currentPage = 'battlemap';
            updateNavActive();
            initializeBattleMap();
        }

        function initializeBattleMap() {
            // 初始化地圖動畫
            startNetworkAnimation();
            
            // 模擬攻擊路徑
            setTimeout(() => {
                showAttackPaths();
            }, 3000);
            
            // 添加節點點擊事件
            addNodeClickEvents();
            
            // 啟動情報流
            startIntelligenceStream();
            
            // 啟動狀態欄更新
            updateMapStatusBar();
            setInterval(updateMapStatusBar, 5000);
            
            // 啟動數據包動畫
            startDataPacketAnimation();
        }

        function startNetworkAnimation() {
            // 節點閃爍動畫已在CSS中定義
            // 可以添加更多動態效果
            const nodes = document.querySelectorAll('.node');
            nodes.forEach((node, index) => {
                setTimeout(() => {
                    node.style.animationDelay = `${index * 0.2}s`;
                }, index * 200);
            });
        }

        function startDataPacketAnimation() {
            // 數據包動畫已在SVG中定義，這裡可以添加額外的邏輯
            setInterval(() => {
                // 隨機改變數據包數量和速度
                const packets = document.querySelectorAll('.data-packet');
                packets.forEach(packet => {
                    const speed = 1.5 + Math.random() * 1.5;
                    packet.style.animationDuration = `${speed}s`;
                });
            }, 10000);
        }

        function showAttackPaths() {
            const attackPaths = document.querySelectorAll('.attack-path');
            attackPaths.forEach((path, index) => {
                setTimeout(() => {
                    path.style.display = 'block';
                }, index * 1000);
            });
        }

        function addNodeClickEvents() {
            const nodes = document.querySelectorAll('.node');
            nodes.forEach(node => {
                node.addEventListener('click', (e) => {
                    const deviceType = e.target.getAttribute('data-device');
                    showDeviceInfo(deviceType, e.target.classList.contains('opponent-node'));
                });
            });
        }

        function showDeviceInfo(deviceType, isOpponent) {
            const panel = document.getElementById('device-info-panel');
            const deviceTypeEl = document.getElementById('device-type');
            const osInfoEl = document.getElementById('os-info');
            const cpuInfoEl = document.getElementById('cpu-info');
            const ramInfoEl = document.getElementById('ram-info');
            const networkStatusEl = document.getElementById('network-status');
            const userNameEl = document.getElementById('user-name');
            const ipLocationEl = document.getElementById('ip-location');
            const activityTimeEl = document.getElementById('activity-time');
            
            // 模擬設備資訊
            const deviceData = {
                pc: {
                    type: '個人電腦',
                    os: isOpponent ? 'Windows 11 Pro' : 'Windows 10 Home',
                    cpu: isOpponent ? 'Intel Core i7-11700K' : 'AMD Ryzen 5 5600X',
                    ram: isOpponent ? '32GB DDR4' : '16GB DDR4',
                    network: '高速寬頻 (100Mbps)',
                    user: isOpponent ? 'target_user' : 'player_user',
                    location: isOpponent ? '中國北京' : '台灣台北',
                    activity: new Date().toLocaleTimeString()
                },
                browser: {
                    type: '網頁瀏覽器',
                    os: isOpponent ? 'Chrome 120.0.6099.109' : 'Firefox 121.0',
                    cpu: 'N/A',
                    ram: isOpponent ? '2.1GB' : '1.8GB',
                    network: 'HTTPS加密連接',
                    user: isOpponent ? 'target_session' : 'player_session',
                    location: isOpponent ? '中國北京' : '台灣台北',
                    activity: new Date().toLocaleTimeString()
                },
                router: {
                    type: '路由器/網路設備',
                    os: isOpponent ? 'Cisco IOS 15.4' : 'TP-Link Archer C7',
                    cpu: '嵌入式處理器',
                    ram: '256MB',
                    network: 'WiFi 6 / 5GHz',
                    user: 'admin',
                    location: isOpponent ? '中國北京' : '台灣台北',
                    activity: '24/7 在線'
                },
                mobile: {
                    type: '行動裝置',
                    os: isOpponent ? 'Android 13' : 'iOS 17.2',
                    cpu: isOpponent ? 'Snapdragon 8 Gen 2' : 'A16 Bionic',
                    ram: isOpponent ? '12GB' : '8GB',
                    network: '5G LTE',
                    user: isOpponent ? 'mobile_target' : 'mobile_player',
                    location: isOpponent ? '中國北京' : '台灣台北',
                    activity: new Date().toLocaleTimeString()
                }
            };
            
            const data = deviceData[deviceType] || deviceData.pc;
            
            deviceTypeEl.textContent = data.type;
            osInfoEl.textContent = data.os;
            cpuInfoEl.textContent = data.cpu;
            ramInfoEl.textContent = data.ram;
            networkStatusEl.textContent = data.network;
            userNameEl.textContent = data.user;
            ipLocationEl.textContent = data.location;
            activityTimeEl.textContent = data.activity;
            
            panel.style.display = 'block';
        }

        function closeDeviceInfo() {
            document.getElementById('device-info-panel').style.display = 'none';
        }

        function toggleLiveMonitoring() {
            const monitoring = document.getElementById('live-monitoring');
            if (monitoring.style.display === 'block') {
                monitoring.style.display = 'none';
            } else {
                monitoring.style.display = 'block';
                // 模擬監控畫面更新
                updateMonitoringFeeds();
            }
        }

        function updateMonitoringFeeds() {
            // 模擬監控畫面內容更新
            setInterval(() => {
                const playerFeed = document.getElementById('player-feed');
                const opponentFeed = document.getElementById('opponent-feed');
                
                // 隨機更新狀態
                const activities = [
                    '鍵盤輸入中...',
                    '瀏覽網頁...',
                    '檔案傳輸...',
                    '系統監控...',
                    '網路連接...'
                ];
                
                playerFeed.innerHTML = `
                    <div class="screen-placeholder">
                        <i class="fas fa-desktop"></i>
                        <span>${activities[Math.floor(Math.random() * activities.length)]}</span>
                    </div>
                `;
                
                opponentFeed.innerHTML = `
                    <div class="screen-placeholder">
                        <i class="fas fa-desktop"></i>
                        <span>${activities[Math.floor(Math.random() * activities.length)]}</span>
                    </div>
                `;
            }, 3000);
        }

        function closeLiveMonitoring() {
            document.getElementById('live-monitoring').style.display = 'none';
        }

        function toggleIntelligenceStream() {
            const stream = document.getElementById('intelligence-stream');
            if (stream.style.display === 'block') {
                stream.style.display = 'none';
            } else {
                stream.style.display = 'block';
            }
        }

        function closeIntelligenceStream() {
            document.getElementById('intelligence-stream').style.display = 'none';
        }

        function startIntelligenceStream() {
            // 模擬情報流訊息
            const messages = [
                { type: 'incoming', content: '偵測到對手嘗試連接埠掃描' },
                { type: 'outgoing', content: '防火牆已攔截可疑流量' },
                { type: 'alert', content: '警告：對手發起DDoS攻擊' },
                { type: 'incoming', content: '發現對手使用Tor網絡' },
                { type: 'outgoing', content: '啟動追蹤模式' },
                { type: 'alert', content: '緊急：對手嘗試入侵核心系統' },
                { type: 'incoming', content: '對手IP位置已鎖定' },
                { type: 'outgoing', content: '申請逮捕令中...' }
            ];
            
            let messageIndex = 0;
            const streamContent = document.getElementById('stream-messages');
            
            const addMessage = () => {
                if (messageIndex < messages.length) {
                    const msg = messages[messageIndex];
                    const messageEl = document.createElement('div');
                    messageEl.className = `stream-message ${msg.type}`;
                    messageEl.innerHTML = `
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                        <div class="message-content">${msg.content}</div>
                    `;
                    streamContent.appendChild(messageEl);
                    streamContent.scrollTop = streamContent.scrollHeight;
                    messageIndex++;
                    
                    setTimeout(addMessage, 2000 + Math.random() * 3000);
                }
            };
            
            addMessage();
        }

        function toggleThreatAnalysis() {
            const panel = document.getElementById('threat-analysis-panel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                updateThreatAnalysis();
                initializeThreatChart();
            }
        }

        function closeThreatAnalysis() {
            document.getElementById('threat-analysis-panel').style.display = 'none';
        }

        function updateThreatAnalysis() {
            // 模擬即時更新威脅分析數據
            const threatLevels = ['低', '中', '高', '關鍵'];
            const frequencies = ['3/分鐘', '8/分鐘', '12/分鐘', '25/分鐘'];
            const effectiveness = ['65%', '78%', '85%', '92%'];
            const predictions = ['5分鐘內', '3分鐘內', '2分鐘內', '立即'];
            
            document.getElementById('realtime-threat').textContent = threatLevels[Math.floor(Math.random() * threatLevels.length)];
            document.getElementById('attack-frequency').textContent = frequencies[Math.floor(Math.random() * frequencies.length)];
            document.getElementById('defense-effectiveness').textContent = effectiveness[Math.floor(Math.random() * effectiveness.length)];
            document.getElementById('next-attack-prediction').textContent = predictions[Math.floor(Math.random() * predictions.length)];
            
            // 更新活躍威脅列表
            updateActiveThreats();
        }

        function updateActiveThreats() {
            const threatsList = document.getElementById('active-threats-list');
            const threatTypes = [
                { type: 'DDoS攻擊', severity: 'critical', time: '進行中' },
                { type: '連接埠掃描', severity: 'high', time: '1分鐘前' },
                { type: 'SQL注入嘗試', severity: 'high', time: '2分鐘前' },
                { type: '可疑流量', severity: 'medium', time: '3分鐘前' },
                { type: '暴力破解', severity: 'medium', time: '5分鐘前' }
            ];
            
            threatsList.innerHTML = '';
            const activeThreats = threatTypes.slice(0, 3 + Math.floor(Math.random() * 2));
            
            activeThreats.forEach(threat => {
                const threatEl = document.createElement('div');
                threatEl.className = `threat-item ${threat.severity}`;
                threatEl.innerHTML = `
                    <span class="threat-type">${threat.type}</span>
                    <span class="threat-severity">${threat.severity === 'critical' ? '關鍵' : threat.severity === 'high' ? '高' : '中'}</span>
                    <span class="threat-time">${threat.time}</span>
                `;
                threatsList.appendChild(threatEl);
            });
        }

        function initializeThreatChart() {
            // 簡單的Canvas圖表模擬
            const canvas = document.getElementById('threat-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製簡單的威脅趨勢線
            ctx.strokeStyle = '#ff9900';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const points = [20, 40, 60, 30, 80, 90, 120, 70, 160, 100, 200, 80, 240, 110, 280, 95];
            points.forEach((point, index) => {
                const x = (index / (points.length - 1)) * (canvas.width - 40) + 20;
                const y = canvas.height - point - 20;
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // 添加網格線
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = (i / 5) * (canvas.height - 40) + 20;
                ctx.beginPath();
                ctx.moveTo(20, y);
                ctx.lineTo(canvas.width - 20, y);
                ctx.stroke();
            }
        }

        function toggleResourceMonitor() {
            const panel = document.getElementById('resource-monitor-panel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                updateResourceMonitor();
                startResourceUpdates();
            }
        }

        function closeResourceMonitor() {
            document.getElementById('resource-monitor-panel').style.display = 'none';
        }

        function updateResourceMonitor() {
            // 更新資源使用率
            const cpuUsage = 60 + Math.random() * 20;
            const memoryUsage = 30 + Math.random() * 30;
            const networkUsage = 50 + Math.random() * 40;
            const storageUsage = 20 + Math.random() * 30;
            
            document.querySelector('.cpu-fill').style.width = `${cpuUsage}%`;
            document.querySelector('.memory-fill').style.width = `${memoryUsage}%`;
            document.querySelector('.network-fill').style.width = `${networkUsage}%`;
            document.querySelector('.storage-fill').style.width = `${storageUsage}%`;
            
            document.querySelector('.resource-item:nth-child(1) .resource-value').textContent = `${Math.round(cpuUsage)}%`;
            document.querySelector('.resource-item:nth-child(2) .resource-value').textContent = `${Math.round(memoryUsage)}%`;
            document.querySelector('.resource-item:nth-child(3) .resource-value').textContent = `${Math.round(networkUsage)}%`;
            document.querySelector('.resource-item:nth-child(4) .resource-value').textContent = `${Math.round(storageUsage)}%`;
            
            // 更新狀態欄
            document.getElementById('resource-usage').textContent = `${Math.round((cpuUsage + memoryUsage + networkUsage + storageUsage) / 4)}%`;
        }

        function startResourceUpdates() {
            // 每3秒更新一次資源數據
            setInterval(() => {
                updateResourceMonitor();
            }, 3000);
        }

        function updateMapStatusBar() {
            // 更新狀態欄數據
            const threatLevels = ['低', '中', '高', '關鍵'];
            const healthLevels = ['85%', '90%', '95%', '98%'];
            const integrityLevels = ['92%', '95%', '98%', '99%'];
            const connections = ['8', '12', '15', '18'];
            
            document.getElementById('threat-level').textContent = threatLevels[Math.floor(Math.random() * threatLevels.length)];
            document.getElementById('system-health').textContent = healthLevels[Math.floor(Math.random() * healthLevels.length)];
            document.getElementById('evidence-integrity').textContent = integrityLevels[Math.floor(Math.random() * integrityLevels.length)];
            document.getElementById('active-connections').textContent = connections[Math.floor(Math.random() * connections.length)];
            
            // 更新威脅等級顏色
            const threatEl = document.getElementById('threat-level');
            const threatText = threatEl.textContent;
            threatEl.className = 'status-value threat-level';
            if (threatText === '關鍵') {
                threatEl.style.color = '#ff3333';
            } else if (threatText === '高') {
                threatEl.style.color = '#ff9900';
            } else if (threatText === '中') {
                threatEl.style.color = '#ffcc00';
            } else {
                threatEl.style.color = '#00ff41';
            }
        }

        // ===== 角色選擇函數 =====
        function selectRole(role) {
            GameState.currentRole = role;
            initRoleResources();
            
            // 隱藏所有隱藏功能提示
            const leHint = document.getElementById('hidden-features-hint');
            const hackerHint = document.getElementById('hacker-features-hint');
            if (leHint) leHint.style.display = 'none';
            if (hackerHint) hackerHint.style.display = 'none';
            
            if (role === 'hacker') {
                showNotification('角色選擇確認', '你已選擇扮演黑客。你的目標是隱藏身份、反制調查，並逃脫執法部門的追捕。', 'hacker');
                // 顯示黑客隱藏功能提示
                if (hackerHint) hackerHint.style.display = 'block';
            } else if (role === 'law_enforcement') {
                showNotification('角色選擇確認', '你已選擇扮演執法部門。你的目標是調查黑客身份、收集證據鏈，並申請逮捕令進行拘捕。', 'law_enforcement');
                // 顯示執法部門隱藏功能提示
                if (leHint) leHint.style.display = 'block';
            }
            
            showSetupPage();
        }

        // ===== 設置頁面更新 =====
        function updateSetupPage() {
            const roleDisplay = document.getElementById('selected-role-display');
            const roleName = document.getElementById('selected-role-name');
            const roleDesc = document.getElementById('selected-role-desc');
            const setupTitle = document.getElementById('setup-title');
            const setupSubtitle = document.getElementById('setup-subtitle');
            
            if (GameState.currentRole === 'hacker') {
                roleDisplay.style.borderColor = '#00ff41';
                roleName.innerHTML = '<i class="fas fa-user-secret"></i> 黑客角色';
                roleName.style.color = '#00ff41';
                roleDesc.textContent = '隱藏身份、清除足跡、反制調查、逃脫追捕、入侵系統';
                setupTitle.textContent = '黑客對戰設置';
                setupSubtitle.textContent = '配置你的黑客對戰參數';
            } else if (GameState.currentRole === 'law_enforcement') {
                roleDisplay.style.borderColor = '#4a90d9';
                roleName.innerHTML = '<i class="fas fa-shield-alt"></i> 執法部門角色';
                roleName.style.color = '#4a90d9';
                roleDesc.textContent = '調查身份、收集證據、鎖定目標、申請逮捕令、保護系統';
                setupTitle.textContent = '執法部門對戰設置';
                setupSubtitle.textContent = '配置你的執法調查參數';
            } else {
                roleDisplay.style.borderColor = '#666';
                roleName.innerHTML = '<i class="fas fa-question-circle"></i> 尚未選擇角色';
                roleName.style.color = '#666';
                roleDesc.textContent = '請返回主頁選擇角色';
            }
            
            // 設置預設對手IP
            if (GameState.currentRole === 'hacker') {
                document.getElementById('opponent-ip').value = '10.0.0.1';
                document.getElementById('opponent-ip').placeholder = '執法部門指揮中心 IP (例: 10.0.0.1)';
            } else {
                document.getElementById('opponent-ip').value = '192.168.1.200';
                document.getElementById('opponent-ip').placeholder = '黑客IP地址 (例: 192.168.1.200)';
            }
            
            // 選擇難度
            selectDifficulty('professional');
        }

        // ===== 數值驗證與限制函數 =====
        function clampValue(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function validateGameStats() {
            const hacker = GameState.playerData.hacker;
            const le = GameState.playerData.law_enforcement;
            
            // 黑客數據驗證
            hacker.stealth = Math.max(0, Math.min(100, hacker.stealth));
            hacker.encryptionLevel = Math.max(0, Math.min(100, hacker.encryptionLevel));
            hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints);
            hacker.serverHealth = Math.max(0, Math.min(100, hacker.serverHealth));
            hacker.deviceHealth = Math.max(0, Math.min(100, hacker.deviceHealth));
            hacker.controlProgress = Math.max(0, Math.min(100, hacker.controlProgress));
            
            // 執法部門數據驗證
            le.investigationProgress = Math.max(0, Math.min(100, le.investigationProgress));
            le.identityLock.technical = Math.max(0, Math.min(100, le.identityLock.technical));
            le.identityLock.social = Math.max(0, Math.min(100, le.identityLock.social));
            le.identityLock.physical = Math.max(0, Math.min(100, le.identityLock.physical));
            le.warrantProgress = Math.max(0, Math.min(100, le.warrantProgress));
            le.serverHealth = Math.max(0, Math.min(100, le.serverHealth));
            le.evidenceLibraryHealth = Math.max(0, Math.min(100, le.evidenceLibraryHealth));
            le.analysisToolsHealth = Math.max(0, Math.min(100, le.analysisToolsHealth));
        }

        function selectDifficulty(level, el) {
            const cards = document.querySelectorAll('.difficulty-card');
            cards.forEach(card => card.classList.remove('selected'));

            // If an element is provided (from onclick), mark it selected; otherwise find by data-level
            if (el && el.classList) {
                el.classList.add('selected');
            } else {
                const target = document.querySelector('.difficulty-card[data-level="' + level + '"]');
                if (target) target.classList.add('selected');
            }

            GameState.difficulty = level;
            // 將難度同步到 AI 參數
            if (typeof adjustAISensitivity === 'function') adjustAISensitivity(level);

            // 延長遊戲時間：20-30分鐘
            switch(level) {
                case 'rookie':
                    GameState.gameTimeLimit = 1800; // 30分鐘
                    break;
                case 'professional':
                    GameState.gameTimeLimit = 1500; // 25分鐘
                    break;
                case 'elite':
                    GameState.gameTimeLimit = 1200; // 20分鐘
                    break;
                case 'legendary':
                    GameState.gameTimeLimit = 900; // 15分鐘
                    break;
            }
        }

        // ===== 開始對戰函數 =====
        function startSeason2Battle() {
            const opponentIP = document.getElementById('opponent-ip').value.trim();
            
            if (!opponentIP) {
                showNotification('輸入錯誤', '請輸入對手的IP地址。', 'warning');
                return;
            }
            
            if (!GameState.currentRole) {
                showNotification('角色未選擇', '請返回主頁選擇角色。', 'warning');
                return;
            }
            
            GameState.opponentIP = opponentIP;
            GameState.gameActive = true; GameState.logs = { system: [], security: [], communication: [] }; GameState.topologyNodes = [];
            GameState.gameStartTime = Date.now();
            GameState.connectionStatus = 'connected';
            // 根據當前難度調整 AI 反應與靈敏度
            if (typeof adjustAISensitivity === 'function') adjustAISensitivity(GameState.difficulty || 'professional');
            
            // 根據角色初始化遊戲數據
            if (GameState.currentRole === 'hacker') {
                GameState.playerData.hacker.money = 150000;
                GameState.playerData.hacker.stealth = 60;
                GameState.playerData.hacker.encryptionLevel = 40;
                GameState.playerData.hacker.digitalFootprints = 5;
                GameState.playerData.hacker.compromisedEvidence = 0;
                GameState.playerData.hacker.controlProgress = 0;
                GameState.playerData.hacker.serverHealth = 100;
                GameState.playerData.hacker.deviceHealth = 100;
                GameState.playerData.hacker.stolenDocuments = [];
                GameState.playerData.hacker.decryptionProgress = 0;
                GameState.playerData.hacker.compromisedDevices = [];
                GameState.playerData.hacker.darknetCredits = 0;
                GameState.playerData.hacker.activeVpnNodes = 3;
                GameState.playerData.hacker.signalJamming = false;
                GameState.playerData.hacker.realtimeIntel = [];
                
                // 初始化任務
                GameState.missions.hacker.forEach(mission => mission.status = 'incomplete');
                
                // 初始化對手數據 (執法部門AI)
                GameState.opponentData.law_enforcement.budget = 200000;
                GameState.opponentData.law_enforcement.investigationProgress = 0;
                GameState.opponentData.law_enforcement.identityLock = { technical: 0, social: 0, physical: 0 };
                GameState.opponentData.law_enforcement.evidenceChain = [];
                GameState.opponentData.law_enforcement.warrantProgress = 0;
                GameState.opponentData.law_enforcement.warrantIssued = false;
                GameState.opponentData.law_enforcement.serverHealth = 100;
                GameState.opponentData.law_enforcement.evidenceLibraryHealth = 100;
                GameState.opponentData.law_enforcement.analysisToolsHealth = 100;
                GameState.opponentData.law_enforcement.dynamicIntel = [];
                GameState.opponentData.law_enforcement.networkSweepActive = false;
            } else {
                GameState.playerData.law_enforcement.budget = 200000;
                GameState.playerData.law_enforcement.investigationProgress = 0;
                GameState.playerData.law_enforcement.identityLock = { technical: 0, social: 0, physical: 0 };
                GameState.playerData.law_enforcement.evidenceChain = [];
                GameState.playerData.law_enforcement.criticalEvidence = [];
                GameState.playerData.law_enforcement.warrantProgress = 0;
                GameState.playerData.law_enforcement.warrantIssued = false;
                GameState.playerData.law_enforcement.serverHealth = 100;
                GameState.playerData.law_enforcement.evidenceLibraryHealth = 100;
                GameState.playerData.law_enforcement.analysisToolsHealth = 100;
                GameState.playerData.law_enforcement.dynamicIntel = [];
                GameState.playerData.law_enforcement.verifiedIntel = [];
                GameState.playerData.law_enforcement.networkSweepActive = false;
                GameState.playerData.law_enforcement.activeHoneypots = 0;
                GameState.playerData.law_enforcement.compromisedDevices = [];
                GameState.playerData.law_enforcement.gpsTracking = false;
                GameState.playerData.law_enforcement.signalBlocking = false;
                GameState.playerData.law_enforcement.realtimeTracking = [];
                
                // 初始化任務
                GameState.missions.law_enforcement.forEach(mission => mission.status = 'incomplete');
                
                // 初始化對手數據 (黑客AI)
                GameState.opponentData.hacker.money = 180000;
                GameState.opponentData.hacker.stealth = 70;
                GameState.opponentData.hacker.encryptionLevel = 50;
                GameState.opponentData.hacker.digitalFootprints = 5;
                GameState.opponentData.hacker.compromisedEvidence = 0;
                GameState.opponentData.hacker.controlProgress = 0;
                GameState.opponentData.hacker.serverHealth = 100;
                GameState.opponentData.hacker.deviceHealth = 100;
                GameState.opponentData.hacker.stolenDocuments = [];
                GameState.opponentData.hacker.activeVpnNodes = 4;
            }
            
            showGamePage();
            initializeGameUI(); initNetworkTopology();
            startGameTimer();
            
            // 顯示歡迎訊息
            if (GameState.currentRole === 'hacker') {
                addTerminalLine('[系統] 第二季對戰開始 - 黑客模式', 'system');
                addTerminalLine('[系統] 目標: 執法部門指揮中心 (' + GameState.opponentIP + ')', 'system');
                addTerminalLine('[系統] 你的任務: 隱藏身份、清除數碼足跡、逃脫追捕、入侵系統', 'system');
                addTerminalLine('[提示] 使用工具分類中的工具執行操作', 'warning');
                addTerminalLine('[提示] 倒計時: ' + Math.floor(GameState.gameTimeLimit / 60) + '分鐘', 'alert');
            } else {
                addTerminalLine('[系統] 第二季對戰開始 - 執法部門模式', 'system');
                addTerminalLine('[系統] 目標: 黑客 (' + GameState.opponentIP + ')', 'system');
                addTerminalLine('[系統] 你的任務: 調查黑客身份、收集證據、申請逮捕令、保護系統', 'system');
                addTerminalLine('[提示] 使用工具分類中的工具執行調查', 'warning');
                addTerminalLine('[提示] 倒計時: ' + Math.floor(GameState.gameTimeLimit / 60) + '分鐘', 'alert');
            }
            
            // 生成初始動態情報
            generateDynamicIntel();
            
            // 初始目標信息
            updateTargetRealtimeInfo();
            
            // ===== 初始化新系統 =====
            initializeSkillTree();
            initializeEquipmentSystem();
            initializeAutoSave();
            initializeEvidenceIntegrity();
            
            addTerminalLine('[系統] 新系統已激活: 技能樹、裝備系統、自動存檔、證據驗證', 'success');
        }

        // ===== 遊戲UI初始化 =====
        function addTerminalLine(message, type = 'response', hasProgress = false) {
            const output = document.getElementById('terminal-output');
            if (!output) return;
            
            const line = document.createElement('div');
            line.className = 'terminal-line ' + (type || 'response') + (type === 'command' ? ' code-waterfall' : '') + (type === 'error' ? ' error-flash' : '');
            
            if (hasProgress) {
                line.innerHTML = `<div>${message}</div><div class="progress-bar-container"><div class="progress-bar-fill"></div></div>`;
            } else {
                line.textContent = message;
            }
            
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;

            if (hasProgress) {
                const fill = line.querySelector('.progress-bar-fill');
                setTimeout(() => { fill.style.width = '100%'; }, 100);
            }
            return line;
        }

        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            const titleEl = document.getElementById('notification-title-text');
            const messageEl = document.getElementById('notification-message');
            
            if (titleEl) titleEl.textContent = title;
            if (messageEl) messageEl.textContent = message;
            
            notification.className = 'notification show ' + type;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // --- 國際協作系統 ---
        function requestInternationalSupport() {
            const le = GameState.playerData.law_enforcement;
            const hacker = GameState.playerData.hacker;
            
            if (le.budget < 35000) {
                showNotification('預算不足', '請求國際協作需要 35,000 預算。', 'warning');
                return;
            }
            
            openStepModal('國際刑警 (Interpol) 協作請求', [
                { name: '選擇協作機構', type: 'select', options: [
                    {label:'國際刑警 (Interpol) - 全球追蹤', value:'interpol'}, 
                    {label:'歐洲刑警 (Europol) - 數據共享', value:'europol'},
                    {label:'亞洲警察協作組 - 實體定位', value:'asia_police'}
                ] },
                { name: '發送情報共享請求', type: 'progress', duration: 3000 },
                { name: '全球數據庫比對 (I-24/7)', type: 'progress', duration: 5000 },
                { name: '獲取跨境追蹤權限', type: 'result', content: '協作成功！正在同步全球黑客活動數據...' }
            ], (data) => {
                le.budget -= 35000;
                GameState.internationalSupport = true;
                
                // 實現真實的數據共享效果
                const agency = data.selectedValue;
                let bonusText = "";
                
                if (agency === 'interpol') {
                    le.identityLock.technical += 25;
                    hacker.stealth = Math.max(0, hacker.stealth - 20);
                    bonusText = "獲取黑客跨境 VPN 節點真實來源，隱蔽度大幅下降。";
                } else if (agency === 'europol') {
                    le.investigationProgress += 20;
                    bonusText = "獲得歐洲地區相關網絡犯罪數據庫訪問權限。";
                } else {
                    le.identityLock.physical += 15;
                    bonusText = "鎖定黑客在亞洲地區的跳板物理位置。";
                }
                
                addTerminalLine(`[國際協作] ${agency.toUpperCase()} 已介入：${bonusText}`, 'success');
                addGameLog('system', '國際協作機構：' + agency + ' 已啟動跨區域數據共享流程');
                updateGameStats();
            });
        }

        // --- 虛擬身份模擬系統 ---
        function createVirtualIdentity() {
            const hacker = GameState.playerData.hacker;
            if (hacker.money < 20000) {
                showNotification('資金不足', '創建虛擬身份需要 20,000 資金。', 'warning');
                return;
            }
            openStepModal('創建多重虛擬身份', [
                { name: '配置身份背景', type: 'form', fields: [{id:'alias', label:'代號'}, {id:'region', label:'虛擬地區'}] },
                { name: '生成社交足跡', type: 'progress', duration: 4000 },
                { name: '注入虛假數據', type: 'progress', duration: 3000 },
                { name: '身份激活', type: 'result', content: '虛擬身份已就緒，將有效分散執法部門調查壓力。' }
            ], (data) => {
                hacker.money -= 20000;
                const newId = { alias: data.formData.alias, stealth: 30 };
                GameState.identities.push(newId);
                hacker.stealth += 15;
                addTerminalLine('虛擬身份「' + data.formData.alias + '」已激活。', 'success');
            });
        }

        // --- 法庭證據提交系統 ---
        function startCourtPhase() {
            const le = GameState.playerData.law_enforcement;
            if (le.evidenceChain.length < 5) {
                showNotification('證據不足', '提交法庭至少需要 5 件證據。', 'warning');
                return;
            }
            GameState.courtPhase = true;
            openStepModal('法庭證據提交與審核', [
                { name: '整理證據鏈', type: 'check', items: le.evidenceChain.map(e => ({id: e.id, label: e.name, checked: true})) },
                { name: '法庭辯論模擬', type: 'progress', duration: 6000 },
                { name: '法官最終裁定', type: 'result', content: '證據確鑿，法庭簽發最終逮捕執行令！' }
            ], (data) => {
                if (le.identityLock.physical >= 80) {
                    endGameWithAnimation('law_enforcement', '法庭審核通過：黑客已被依法定罪並逮捕。');
                } else {
                    addTerminalLine('法庭審核通過，但仍需鎖定黑客物理位置。', 'info');
                }
            });
        }

        // --- 數據污染偵測 ---
        function detectContamination() {
            const le = GameState.playerData.law_enforcement;
            addTerminalLine('啟動數據污染偵測系統...', 'info');
            setTimeout(() => {
                const contaminated = le.evidenceChain.filter(e => e.contaminated);
                if (contaminated.length > 0) {
                    showNotification('偵測到污染', `發現 ${contaminated.length} 件證據已被黑客污染！`, 'danger');
                    contaminated.forEach(e => e.name += ' [已污染]');
                } else {
                    showNotification('系統安全', '未發現證據污染跡象。', 'success');
                }
                updateSpecialPanel(); addNodeClickEvents();
            }, 2000);
        }

        // --- 證據清潔與恢復系統 ---
        function cleanseEvidence() {
            const le = GameState.playerData.law_enforcement;
            const toolData = { id: "evidence_cleanser", name: "證據清潔與恢復系統", effect: "defend", cost: 0 };
            implementToolEffect('evidence_cleanser', toolData, le, GameState.playerData.hacker);
        }

        // --- 突發事件系統 ---
        function triggerRandomEvent() {
            if (!GameState.gameActive) return;
            const events = [
                { name: '服務器故障', effect: () => { GameState.playerData.law_enforcement.serverHealth -= 10; addTerminalLine('突發：執法部門服務器出現硬件故障！', 'warning'); } },
                { name: '線人情報', effect: () => { GameState.playerData.law_enforcement.investigationProgress += 15; addTerminalLine('突發：匿名線人提供了關鍵情報！', 'success'); } },
                { name: '網絡風暴', effect: () => { GameState.playerData.hacker.stealth -= 10; addTerminalLine('突發：全球網絡波動，黑客隱蔽度下降！', 'warning'); } }
            ];
            if (Math.random() < 0.05) { // 5% 機率觸發
                const event = events[Math.floor(Math.random() * events.length)];
                event.effect();
            }
        }

        
        function updateReputation() {
            const hacker = GameState.playerData.hacker;
            const le = GameState.playerData.law_enforcement;
            GameState.reputation.hacker = Math.floor(hacker.compromisedDevices.length * 10 + hacker.stolenDocuments.length * 20);
            GameState.reputation.le = Math.floor(le.evidenceChain.length * 5 + (le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3);
            const repEl = document.getElementById('reputation-display');
            if (repEl) repEl.innerText = '聲譽: ' + (GameState.currentRole === 'hacker' ? GameState.reputation.hacker : GameState.reputation.le);
        }
        // --- 資源消耗機制 ---
        function consumeResource(role, amount) {
            GameState.resources[role] -= amount;
            if (GameState.resources[role] < 0) GameState.resources[role] = 0;
            updateResourceUI(); updateSpecialSkillsGrid();
        }

        function updateResourceUI() {
            const hackerRes = document.getElementById('hacker-resource-fill');
            const leRes = document.getElementById('le-resource-fill');
            if (hackerRes) hackerRes.style.width = (GameState.resources.hacker / 10) + '%';
            if (leRes) leRes.style.width = (GameState.resources.le / 10) + '%';
        }
    
        // --- 分步流程工具邏輯 ---
        function openStepModal(title, steps, onComplete) {
            const modal = document.getElementById('step-modal');
            const titleEl = document.getElementById('step-modal-title');
            const contentEl = document.getElementById('step-modal-content');
            const buttonsEl = document.getElementById('step-modal-buttons');
            
            GameState.currentStepTask = { steps, currentStep: 0, onComplete };
            titleEl.innerText = title;
            modal.classList.add('active');
            renderStep();
        }

        // 新增: 簡化的模態框顯示函數
        function showStepModal(title, content, buttons = []) {
            const modal = document.getElementById('step-modal');
            const titleEl = document.getElementById('step-modal-title');
            const contentEl = document.getElementById('step-modal-content');
            const buttonsEl = document.getElementById('step-modal-buttons');
            
            // 設置標題
            titleEl.innerText = title;
            
            // 設置內容
            if (typeof content === 'string') {
                contentEl.innerHTML = content;
            } else {
                contentEl.appendChild(content);
            }
            
            // 設置按鈕
            buttonsEl.innerHTML = '';
            buttons.forEach(btn => {
                const btnEl = document.createElement('button');
                btnEl.className = 'modal-btn modal-btn-confirm';
                btnEl.innerText = btn.text;
                btnEl.onclick = () => {
                    if (typeof btn.onclick === 'string') {
                        eval(btn.onclick);
                    } else if (typeof btn.onclick === 'function') {
                        btn.onclick();
                    }
                };
                buttonsEl.appendChild(btnEl);
            });
            
            // 如果沒有按鈕，添加默認的關閉按鈕
            if (buttons.length === 0) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'modal-btn modal-btn-confirm';
                closeBtn.innerText = '關閉';
                closeBtn.onclick = closeStepModal;
                buttonsEl.appendChild(closeBtn);
            }
            
            // 顯示模態框
            modal.classList.add('active');
        }

        function closeStepModal() {
            document.getElementById('step-modal').classList.remove('active');
            GameState.currentStepTask = null;
        }

        // ===== 全螢幕戰況地圖函數 =====
        function openBattleMap() {
            const modal = document.getElementById('battle-map-modal');
            modal.style.display = 'flex';
            
            // 初始化地圖
            initializeBattleMap();
            updateBattleMap();
            
            // 開始即時更新
            startMapUpdates();
        }

        function closeBattleMap() {
            const modal = document.getElementById('battle-map-modal');
            modal.style.display = 'none';
            
            // 停止更新
            stopMapUpdates();
        }

        function toggleMapView(viewType) {
            // 移除所有活動狀態
            document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.map-view').forEach(view => view.classList.remove('active'));
            
            // 激活選中的視圖
            document.getElementById(viewType + '-view-btn').classList.add('active');
            document.getElementById(viewType + '-view').classList.add('active');
            
            // 更新內容
            updateMapView(viewType);
        }

        function initializeBattleMap() {
            // 設置默認視圖
            toggleMapView('network');
        }

        function updateBattleMap() {
            updateMapStatusBar();
            updateMapView('network'); // 更新當前活動視圖
        }

        function updateMapView(viewType) {
            switch(viewType) {
                case 'network':
                    updateNetworkTopology();
                    break;
                case 'devices':
                    updateDevicesStatus();
                    break;
                case 'intel':
                    updateIntelMonitoring();
                    break;
            }
        }

        function updateNetworkTopology() {
            const canvas = document.getElementById('topology-canvas');
            if (!canvas) return;
            
            // 清除現有內容
            canvas.innerHTML = '';
            
            // 生成網絡節點
            const nodes = generateNetworkNodes();
            const connections = generateNetworkConnections(nodes);
            
            // 渲染節點
            nodes.forEach(node => {
                const nodeElement = document.createElement('div');
                nodeElement.className = `topology-node ${node.type}`;
                nodeElement.style.left = node.x + 'px';
                nodeElement.style.top = node.y + 'px';
                
                nodeElement.innerHTML = `
                    <div class="node-icon">
                        <i class="fas ${node.icon}"></i>
                    </div>
                    <div class="node-label">${node.label}</div>
                    <div class="node-status ${node.status}"></div>
                `;
                
                nodeElement.onclick = () => showNodeDetails(node);
                canvas.appendChild(nodeElement);
            });
            
            // 渲染連線
            connections.forEach(conn => {
                const connectionElement = document.createElement('div');
                connectionElement.className = `topology-connection ${conn.type}`;
                
                const fromNode = nodes.find(n => n.id === conn.from);
                const toNode = nodes.find(n => n.id === conn.to);
                
                if (fromNode && toNode) {
                    const dx = toNode.x - fromNode.x;
                    const dy = toNode.y - fromNode.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    connectionElement.style.width = distance + 'px';
                    connectionElement.style.left = (fromNode.x + 30) + 'px';
                    connectionElement.style.top = (fromNode.y + 30) + 'px';
                    connectionElement.style.transform = `rotate(${angle}deg)`;
                    
                    canvas.appendChild(connectionElement);
                }
            });
        }

        function generateNetworkNodes() {
            const canvasWidth = 1200;
            const canvasHeight = 600;
            
            return [
                // 黑客節點
                { id: 'hacker_pc', type: 'hacker', label: '黑客PC', icon: 'fa-laptop', x: 100, y: 200, status: 'online' },
                { id: 'hacker_vpn', type: 'hacker', label: 'VPN伺服器', icon: 'fa-shield-alt', x: 250, y: 150, status: 'online' },
                { id: 'proxy_chain', type: 'hacker', label: '代理鏈', icon: 'fa-link', x: 400, y: 100, status: 'online' },
                { id: 'botnet', type: 'hacker', label: '殭屍網路', icon: 'fa-skull', x: 550, y: 200, status: 'warning' },
                
                // 目標節點
                { id: 'target_firewall', type: 'target', label: '防火牆', icon: 'fa-shield-alt', x: 700, y: 150, status: 'warning' },
                { id: 'target_server', type: 'target', label: '目標伺服器', icon: 'fa-server', x: 850, y: 200, status: 'online' },
                { id: 'evidence_db', type: 'target', label: '證據庫', icon: 'fa-database', x: 1000, y: 250, status: 'compromised' },
                
                // 執法部門節點
                { id: 'le_command', type: 'law-enforcement', label: '指揮中心', icon: 'fa-building', x: 850, y: 400, status: 'online' },
                { id: 'le_firewall', type: 'law-enforcement', label: '防禦系統', icon: 'fa-shield-alt', x: 700, y: 450, status: 'warning' },
                { id: 'le_monitor', type: 'law-enforcement', label: '監控中心', icon: 'fa-eye', x: 550, y: 500, status: 'online' }
            ];
        }

        function generateNetworkConnections(nodes) {
            return [
                { from: 'hacker_pc', to: 'hacker_vpn', type: '' },
                { from: 'hacker_vpn', to: 'proxy_chain', type: '' },
                { from: 'proxy_chain', to: 'botnet', type: '' },
                { from: 'botnet', to: 'target_firewall', type: 'attack' },
                { from: 'target_firewall', to: 'target_server', type: 'attack' },
                { from: 'target_server', to: 'evidence_db', type: 'attack' },
                { from: 'le_command', to: 'le_firewall', type: '' },
                { from: 'le_firewall', to: 'le_monitor', type: '' },
                { from: 'le_monitor', to: 'target_firewall', type: '' }
            ];
        }

        function showNodeDetails(node) {
            const details = getNodeDetails(node);
            const role = GameState.currentRole;
            let actionsHtml = '<div class="node-action-panel">';
            
            if (role === 'hacker') {
                if (node.type === 'target' || node.type === 'law-enforcement') {
                    actionsHtml += `<button class="node-action-btn" onclick="executeNodeAction('${node.id}', 'scan')">掃描漏洞</button>`;
                    actionsHtml += `<button class="node-action-btn" onclick="executeNodeAction('${node.id}', 'attack')">發動攻擊</button>`;
                } else if (node.type === 'hacker') {
                    actionsHtml += `<button class="node-action-btn" onclick="executeNodeAction('${node.id}', 'defend')">加固防禦</button>`;
                }
            } else {
                if (node.type === 'hacker' || node.type === 'target') {
                    actionsHtml += `<button class="node-action-btn" onclick="executeNodeAction('${node.id}', 'investigate')">收集證據</button>`;
                    actionsHtml += `<button class="node-action-btn" onclick="executeNodeAction('${node.id}', 'track')">追蹤來源</button>`;
                } else if (node.type === 'law-enforcement') {
                    actionsHtml += `<button class="node-action-btn" onclick="executeNodeAction('${node.id}', 'defend')">系統維護</button>`;
                }
            }
            actionsHtml += '</div>';
            
            showStepModal(`節點詳情: ${node.label}`, `<pre>${details}</pre>${actionsHtml}`, [{text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function executeNodeAction(nodeId, actionType) {
            closeStepModal();
            const node = generateNetworkNodes().find(n => n.id === nodeId);
            addTerminalLine(`[指令] 對節點 ${node.label} 執行 ${actionType}...`, 'command', true);
            
            setTimeout(() => {
                const toolData = { name: actionType.toUpperCase(), cooldown: 5, cost: 100, effect: actionType };
                implementToolEffect(actionType, toolData, GameState.playerData[GameState.currentRole], GameState.playerData[GameState.currentRole === 'hacker' ? 'law_enforcement' : 'hacker']);
                updateGameStats();
            }, 2000);
        }

        function getNodeDetails(node) {
            const details = {
                'hacker_pc': '作業系統: Windows 11\nCPU: Intel i7-11700K\nRAM: 32GB\n網路: 1Gbps\n狀態: 活躍攻擊中',
                'hacker_vpn': '位置: 荷蘭阿姆斯特丹\n加密: AES-256\n節點數: 15\n流量: 500Mbps',
                'proxy_chain': '鏈長: 7層\n國家: 5個\n延遲: 45ms\n成功率: 98%',
                'botnet': '規模: 50,000設備\nDDoS功率: 100Gbps\n活躍率: 85%',
                'target_firewall': '廠商: Cisco ASA\n版本: 9.12\n漏洞: 已利用\n狀態: 被突破',
                'target_server': 'OS: Ubuntu 20.04\n服務: Apache, MySQL\n權限: Root\n數據: 已竊取',
                'evidence_db': '類型: PostgreSQL\n記錄: 10,000條\n加密: 已破解\n狀態: 數據污染',
                'le_command': '人員: 25名\n系統: 指揮平台\n狀態: 高度警戒',
                'le_firewall': '廠商: Palo Alto\n威脅等級: 紅色\n攔截: 1,200次',
                'le_monitor': '攝像頭: 50個\nAI分析: 啟動\n偵測率: 95%'
            };
            return details[node.id] || '無詳細信息';
        }

        function updateDevicesStatus() {
            const grid = document.getElementById('devices-grid');
            if (!grid) return;
            
            const devices = generateDeviceList();
            
            grid.innerHTML = devices.map(device => `
                <div class="device-card ${device.status}">
                    <div class="device-header">
                        <div class="device-icon">
                            <i class="fas ${device.icon}"></i>
                        </div>
                        <div class="device-info">
                            <h3>${device.name}</h3>
                            <p>${device.type} • ${device.location}</p>
                        </div>
                    </div>
                    
                    <div class="device-specs">
                        <div class="spec-item">
                            <span class="spec-label">作業系統</span>
                            <span class="spec-value">${device.os}</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">處理器</span>
                            <span class="spec-value">${device.cpu}</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">記憶體</span>
                            <span class="spec-value">${device.ram}</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">存儲</span>
                            <span class="spec-value">${device.storage}</span>
                        </div>
                    </div>
                    
                    <div class="device-status">
                        <div class="status-indicator status-${device.status}">
                            ${device.statusText}
                        </div>
                        <div class="device-actions">
                            <button class="map-btn" onclick="scanDevice('${device.id}')">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateDeviceList() {
            return [
                {
                    id: 'hacker_laptop',
                    name: '黑客筆記本',
                    type: '個人電腦',
                    location: '未知位置',
                    icon: 'fa-laptop',
                    os: 'Kali Linux',
                    cpu: 'Intel i7-11800H',
                    ram: '32GB DDR4',
                    storage: '1TB NVMe SSD',
                    status: 'hacked',
                    statusText: '已入侵'
                },
                {
                    id: 'target_server',
                    name: '證據庫伺服器',
                    type: '企業伺服器',
                    location: '數據中心',
                    icon: 'fa-server',
                    os: 'Ubuntu 22.04 LTS',
                    cpu: 'AMD EPYC 7742',
                    ram: '256GB',
                    storage: '10TB RAID',
                    status: 'compromised',
                    statusText: '已入侵'
                },
                {
                    id: 'le_workstation',
                    name: '調查員工作站',
                    type: '辦公電腦',
                    location: '執法大樓',
                    icon: 'fa-desktop',
                    os: 'Windows 11 Pro',
                    cpu: 'Intel i5-12400',
                    ram: '16GB',
                    storage: '512GB SSD',
                    status: 'online',
                    statusText: '在線'
                },
                {
                    id: 'mobile_device',
                    name: '目標手機',
                    type: '智能手機',
                    location: '移動中',
                    icon: 'fa-mobile-alt',
                    os: 'Android 13',
                    cpu: 'Snapdragon 8 Gen 2',
                    ram: '12GB',
                    storage: '256GB',
                    status: 'online',
                    statusText: '在線'
                },
                {
                    id: 'router',
                    name: '網絡路由器',
                    type: '網絡設備',
                    location: '目標網絡',
                    icon: 'fa-router',
                    os: 'Cisco IOS',
                    cpu: '多核處理器',
                    ram: '4GB',
                    storage: '256MB Flash',
                    status: 'compromised',
                    statusText: '已入侵'
                },
                {
                    id: 'surveillance_cam',
                    name: '監控攝像頭',
                    type: 'IoT設備',
                    location: '公共區域',
                    icon: 'fa-video',
                    os: '嵌入式Linux',
                    cpu: 'ARM Cortex-A7',
                    ram: '512MB',
                    storage: '32GB',
                    status: 'offline',
                    statusText: '離線'
                }
            ];
        }

        function updateIntelMonitoring() {
            updateIntelStream();
            updatePersonalData();
        }

        function updateIntelStream() {
            const stream = document.getElementById('intel-stream');
            if (!stream) return;
            
            const intelItems = generateIntelItems();
            
            stream.innerHTML = intelItems.map(item => `
                <div class="intel-item ${item.type} ${item.priority}">
                    <div class="intel-timestamp">${item.timestamp}</div>
                    <div class="intel-content">${item.content}</div>
                </div>
            `).join('');
            
            // 滾動到底部
            stream.scrollTop = stream.scrollHeight;
        }

        function generateIntelItems() {
            const now = new Date();
            return [
                {
                    timestamp: now.toLocaleTimeString(),
                    content: '偵測到來自荷蘭的異常VPN連接',
                    type: 'hacker',
                    priority: 'warning'
                },
                {
                    timestamp: new Date(now.getTime() - 30000).toLocaleTimeString(),
                    content: '證據庫訪問日誌顯示可疑IP: 192.168.1.100',
                    type: 'law-enforcement',
                    priority: 'danger'
                },
                {
                    timestamp: new Date(now.getTime() - 60000).toLocaleTimeString(),
                    content: '黑客使用零日漏洞成功入侵防火牆',
                    type: 'hacker',
                    priority: 'danger'
                },
                {
                    timestamp: new Date(now.getTime() - 90000).toLocaleTimeString(),
                    content: 'AI分析系統偵測到DDoS攻擊模式',
                    type: 'law-enforcement',
                    priority: ''
                },
                {
                    timestamp: new Date(now.getTime() - 120000).toLocaleTimeString(),
                    content: '加密貨幣錢包收到可疑轉帳: 0.5 BTC',
                    type: 'hacker',
                    priority: 'warning'
                },
                {
                    timestamp: new Date(now.getTime() - 150000).toLocaleTimeString(),
                    content: '社交媒體分析發現目標使用假身份',
                    type: 'law-enforcement',
                    priority: ''
                }
            ];
        }

        function updatePersonalData() {
            const dataDiv = document.getElementById('personal-data');
            if (!dataDiv) return;
            
            const personalData = generatePersonalData();
            
            dataDiv.innerHTML = `
                <div class="personal-section">
                    <h4><i class="fas fa-user"></i> 基本信息</h4>
                    ${personalData.basic.map(item => `
                        <div class="personal-item">
                            <span class="personal-label">${item.label}</span>
                            <span class="personal-value">${item.value}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="personal-section">
                    <h4><i class="fas fa-map-marker-alt"></i> 位置信息</h4>
                    ${personalData.location.map(item => `
                        <div class="personal-item">
                            <span class="personal-label">${item.label}</span>
                            <span class="personal-value">${item.value}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="personal-section">
                    <h4><i class="fas fa-coins"></i> 金融信息</h4>
                    ${personalData.financial.map(item => `
                        <div class="personal-item">
                            <span class="personal-label">${item.label}</span>
                            <span class="personal-value">${item.value}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generatePersonalData() {
            return {
                basic: [
                    { label: '真實姓名', value: '張三' },
                    { label: '化名', value: 'ShadowHunter' },
                    { label: '年齡', value: '28歲' },
                    { label: '職業', value: '自由程式設計師' },
                    { label: '教育程度', value: '計算機科學碩士' }
                ],
                location: [
                    { label: '當前位置', value: '估計: 東亞地區' },
                    { label: 'IP地址', value: '動態變換' },
                    { label: '時區', value: 'UTC+8' },
                    { label: '語言', value: '中文/英文' },
                    { label: 'ISP', value: '未知' }
                ],
                financial: [
                    { label: '加密貨幣餘額', value: '≈ 50 BTC' },
                    { label: '銀行帳戶', value: '多個離岸帳戶' },
                    { label: '月收入', value: '未知' },
                    { label: '交易平台', value: '多個暗網交易所' }
                ]
            };
        }

        function updateMapStatusBar() {
            const gameTime = document.getElementById('map-game-time');
            const activeNodes = document.getElementById('map-active-nodes');
            const attackPaths = document.getElementById('map-attack-paths');
            const intelUpdates = document.getElementById('map-intel-updates');
            
            if (GameState.gameActive) {
                const timeLeft = GameState.gameTimeLimit - Math.floor((Date.now() - GameState.gameStartTime) / 1000);
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                gameTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                gameTime.textContent = '00:00';
            }
            
            activeNodes.textContent = Math.floor(Math.random() * 20) + 10;
            attackPaths.textContent = Math.floor(Math.random() * 15) + 5;
            intelUpdates.textContent = Math.floor(Math.random() * 50) + 20;
        }

        let mapUpdateInterval;

        function startMapUpdates() {
            mapUpdateInterval = setInterval(() => {
                if (document.getElementById('battle-map-modal').style.display !== 'none') {
                    updateBattleMap();
                }
            }, 2000); // 每2秒更新一次
        }

        function stopMapUpdates() {
            if (mapUpdateInterval) {
                clearInterval(mapUpdateInterval);
                mapUpdateInterval = null;
            }
        }

        function scanDevice(deviceId) {
            showNotification('設備掃描', `正在掃描設備 ${deviceId}...`, 'info');
            // 這裡可以添加更詳細的掃描邏輯
        }

        function renderStep() {
            const task = GameState.currentStepTask;
            const step = task.steps[task.currentStep];
            const contentEl = document.getElementById('step-modal-content');
            const buttonsEl = document.getElementById('step-modal-buttons');
            
            let html = `<div class="step-item">
                <div style="margin-bottom:10px;"><strong>步驟 ${task.currentStep + 1}/${task.steps.length}: ${step.name}</strong></div>
                <div id="step-action-area">`;
            
            if (step.type === 'select') {
                html += `<select id="step-select" class="setting-input" style="width:100%">
                    ${step.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                </select>`;
            } else if (step.type === 'progress') {
                html += `<div class="step-progress-container"><div id="step-progress-fill" class="step-progress-fill"></div></div>
                         <div id="step-progress-text" style="font-size:0.8rem; text-align:center;">準備中...</div>`;
            } else if (step.type === 'form') {
                html += step.fields.map(f => `
                    <div style="margin-bottom:10px;">
                        <label style="font-size:0.8rem;">${f.label}</label>
                        <input type="${f.inputType || 'text'}" id="step-field-${f.id}" class="setting-input" style="width:100%" value="${f.value || ''}">
                    </div>
                `).join('');
            } else if (step.type === 'check') {
                html += step.items.map(item => `
                    <div style="margin-bottom:5px;">
                        <input type="checkbox" id="step-check-${item.id}" ${item.checked ? 'checked' : ''}>
                        <label style="font-size:0.8rem;">${item.label}</label>
                    </div>
                `).join('');
            } else if (step.type === 'result') {
                html += `<div style="color:#00ff41; font-family:monospace;">${step.content}</div>`;
            }
            
            html += `</div></div>`;
            contentEl.innerHTML = html;
            
            buttonsEl.innerHTML = `
                <button class="modal-btn modal-btn-confirm" id="step-next-btn" onclick="processCurrentStep()">
                    ${task.currentStep === task.steps.length - 1 ? '完成' : '下一步'}
                </button>
            `;
            
            if (step.type === 'progress') {
                document.getElementById('step-next-btn').disabled = true;
                simulateProgress(step.duration || 2000, () => {
                    document.getElementById('step-next-btn').disabled = false;
                });
            }
        }

        function simulateProgress(duration, callback) {
            const fill = document.getElementById('step-progress-fill');
            const text = document.getElementById('step-progress-text');
            let start = null;
            function animate(timestamp) {
                if (!start) start = timestamp;
                let progress = (timestamp - start) / duration;
                if (progress > 1) progress = 1;
                if (fill) fill.style.width = (progress * 100) + '%';
                if (text) text.innerText = Math.floor(progress * 100) + '%';
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    if (callback) callback();
                }
            }
            requestAnimationFrame(animate);
        }

        function processCurrentStep() {
            const task = GameState.currentStepTask;
            const step = task.steps[task.currentStep];
            
            // 收集數據
            if (step.type === 'select') {
                step.selectedValue = document.getElementById('step-select').value;
            } else if (step.type === 'form') {
                step.formData = {};
                step.fields.forEach(f => {
                    step.formData[f.id] = document.getElementById('step-field-' + f.id).value;
                });
            } else if (step.type === 'check') {
                step.checkedItems = step.items.filter(item => document.getElementById('step-check-' + item.id).checked);
            }
            
            if (task.currentStep < task.steps.length - 1) {
                task.currentStep++;
                renderStep();
            } else {
                const finalData = task.steps.reduce((acc, s) => ({...acc, ...s}), {});
                task.onComplete(finalData);
                closeStepModal();
            }
        }

        // --- 網絡拓撲圖邏輯 ---
        function initNetworkTopology() {
            const container = document.getElementById('network-topology-container');
            if (!container) return;
            
            const nodes = [
                { id: 'hacker_vpn', label: 'VPN節點', x: 50, y: 50, type: 'hacker' },
                { id: 'hacker_jump', label: '跳板伺服器', x: 150, y: 100, type: 'hacker' },
                { id: 'le_center', label: '指揮中心', x: 350, y: 150, type: 'le' },
                { id: 'le_db', label: '證據庫', x: 450, y: 50, type: 'le' }
            ];
            
            GameState.topologyNodes = nodes;
            renderTopology();
        }

        function renderTopology() {
            const container = document.getElementById('network-topology-container');
            if (!container) return;
            container.innerHTML = '';
            
            GameState.topologyNodes.forEach(node => {
                const nodeEl = document.createElement('div');
                nodeEl.className = `node ${node.type === 'hacker' ? 'hacker' : ''}`;
                nodeEl.style.left = node.x + 'px';
                nodeEl.style.top = node.y + 'px';
                nodeEl.innerHTML = `<i class="fas ${node.type === 'hacker' ? 'fa-user-secret' : 'fa-shield-alt'}"></i>
                                    <div class="node-label">${node.label}</div>`;
                nodeEl.onclick = () => showNotification(node.label, `IP: 10.0.0.${Math.floor(Math.random()*255)}\n狀態: 運行中\n資源佔用: ${Math.floor(Math.random()*40+10)}%`);
                container.appendChild(nodeEl);
            });
        }

        function triggerTopologyEffect(fromId, toId) {
            const container = document.getElementById('network-topology-container');
            const from = GameState.topologyNodes.find(n => n.id === fromId);
            const to = GameState.topologyNodes.find(n => n.id === toId);
            if (!from || !to) return;
            
            const line = document.createElement('div');
            line.className = 'connection-line active';
            const dx = to.x - from.x;
            const dy = to.y - from.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            line.style.width = dist + 'px';
            line.style.left = (from.x + 20) + 'px';
            line.style.top = (from.y + 20) + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            container.appendChild(line);
            setTimeout(() => line.remove(), 2000);
        }

        // --- 日誌監控邏輯 ---
        function addGameLog(type, message) {
            const time = new Date().toLocaleTimeString();
            const logEntry = `[${time}] ${message}`;
            GameState.logs[type].push(logEntry);
            if (GameState.logs[type].length > 50) GameState.logs[type].shift();
            
            const activeTab = document.querySelector('.log-tab.active');
            if (activeTab && activeTab.dataset.type === type) {
                updateLogDisplay(type);
            }
        }

        
        function updateLogDisplay(type) {
            const display = document.getElementById('log-display');
            if (!display) return;
            if (!GameState.logs[type]) GameState.logs[type] = []; // 確保初始化
            const filter = document.getElementById('log-filter-input') ? document.getElementById('log-filter-input').value.toLowerCase() : '';
            const filteredLogs = GameState.logs[type].filter(log => log.toLowerCase().includes(filter));
            display.innerHTML = filteredLogs.length > 0 ? filteredLogs.join('<br>') : '<div style="color:#666;text-align:center;padding:20px;">暫無日誌數據</div>';
            display.scrollTop = display.scrollHeight;
        }
    

        function switchLogTab(type) {
            document.querySelectorAll('.log-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type); if(tab.classList.contains('active')) updateLogDisplay(type);
            });
            updateLogDisplay(type);
        }

        // --- 勝負判定邏輯 ---
        function updateMissions() {
            const role = GameState.currentRole;
            const playerData = GameState.playerData[role];
            
            // 動態分支目標邏輯
            if (!GameState.activeBranch) {
                if (playerData.controlProgress > 30 || playerData.investigationProgress > 30) {
                    GameState.activeBranch = true;
                    const options = role === 'hacker' ? 
                        [{text: '癱瘓監控 (降低發現率)', id: 'disable_cam'}, {text: '強攻數據庫 (速度+20%)', id: 'brute_force'}] :
                        [{text: '申請搜查令 (合法性+)', id: 'warrant'}, {text: '緊急攔截 (速度+)', id: 'intercept'}];
                    
                    const content = `
                        <div class="step-description">偵測到戰況進入關鍵階段，請選擇行動分支：</div>
                        <div class="node-action-panel">
                            ${options.map(opt => `<button class="node-action-btn" onclick="selectBranch('${opt.id}')">${opt.text}</button>`).join('')}
                        </div>
                    `;
                    showStepModal('戰略分支選擇', content, []);
                }
            }
        }

        function selectBranch(branchId) {
            closeStepModal();
            GameState.selectedBranch = branchId;
            addTerminalLine(`[分支] 已選擇戰略路徑: ${branchId}`, 'success');
            
            if (branchId === 'brute_force') {
                GameState.playerData.hacker.controlProgress += 10;
            } else if (branchId === 'disable_cam') {
                GameState.playerData.hacker.stealth += 20;
            }
        }

        function checkWinConditions() {
            if (!GameState.gameActive) return;
            
            const le = GameState.playerData.law_enforcement;
            const hacker = GameState.playerData.hacker;
            const timeLeft = GameState.gameTimeLimit - (Math.floor((Date.now() - GameState.gameStartTime) / 1000));

            // 執法部門勝利條件
            if (le.identityLock.physical >= 95) {
                endGameWithAnimation('law_enforcement', '實體定位完成：黑客真實身份已被鎖定並拘捕。');
                return;
            }
            
            if (timeLeft <= 0) {
                // 檢查核心證據是否被保護
                const hasCleanEvidence = le.evidenceChain.some(e => e.critical && !e.contaminated);
                if (le.serverHealth > 0 && le.evidenceLibraryHealth > 0 && hasCleanEvidence) {
                    endGameWithAnimation('law_enforcement', '時間耗盡：指揮中心與證據庫未被癱瘓，至少一份核心證據保持完整。');
                } else {
                    endGameWithAnimation('hacker', '時間耗盡：黑客成功污染或銷毀所有關鍵證據，並逃脫追捕。');
                }
                return;
            }

            // 黑客勝利條件
            if (le.serverHealth <= 0 || le.evidenceLibraryHealth <= 0) {
                endGameWithAnimation('hacker', '核心系統癱瘓：指揮中心或證據庫已被徹底破壞。');
                return;
            }
            
            // 檢查是否所有關鍵證據都被污染或銷毀
            const criticalEvidence = le.evidenceChain.filter(e => e.critical);
            const allCriticalCompromised = criticalEvidence.length > 0 && criticalEvidence.every(e => e.contaminated || e.destroyed);
            if (allCriticalCompromised && timeLeft < 600) { // 最後10分鐘
                endGameWithAnimation('hacker', '證據銷毀：所有關鍵證據已被污染或徹底銷毀，黑客成功脫身。');
                return;
            }
            
            // 黑客完美逃脫 (隱蔽度極高且足跡為0)
            if (hacker.stealth >= 95 && hacker.digitalFootprints === 0 && timeLeft < 300) {
                endGameWithAnimation('hacker', '完美犯罪：黑客已徹底消滅所有網絡痕跡，執法部門無法追蹤。');
                return;
            }
        }

        function endGameWithAnimation(winner, reason) {
            GameState.gameActive = false;
            clearInterval(GameState.gameTimer);
            
            const overlay = document.getElementById('game-result-animation');
            const animContent = document.getElementById('victory-animation-content');
            const reportContent = document.getElementById('victory-report-content');
            
            overlay.style.display = 'flex';
            
            if (winner === 'law_enforcement') {
                animContent.innerHTML = `<h1 style="color:#4a90d9; font-size:3rem; text-shadow:0 0 20px #4a90d9;">案件已結案</h1>
                                         <div style="font-size:1.5rem; margin-top:10px;">CASE CLOSED</div>
                                         <i class="fas fa-gavel" style="font-size:5rem; margin-top:20px; color:#4a90d9;"></i>`;
                reportContent.innerHTML = `
                    <h3>執法行動報告</h3>
                    <p><strong>結案原因:</strong> ${reason}</p>
                    <p><strong>逮捕對象:</strong> 匿名黑客 (IP: ${GameState.opponentIP})</p>
                    <p><strong>證據鏈完整度:</strong> ${GameState.playerData.law_enforcement.evidenceChain.length * 10}%</p>
                    <p><strong>定罪摘要:</strong> 根據《網絡安全法》，嫌疑人涉嫌非法入侵政府系統、竊取機密數據及破壞公共設施。現場搜獲多台加密伺服器及物理證據。</p>
                `;
            } else {
                animContent.innerHTML = `<h1 style="color:#00ff41; font-size:3rem; text-shadow:0 0 20px #00ff41;">任務成功</h1>
                                         <div style="font-size:1.5rem; margin-top:10px;">MISSION ACCOMPLISHED</div>
                                         <i class="fas fa-skull-crossbones" style="font-size:5rem; margin-top:20px; color:#00ff41;"></i>`;
                reportContent.innerHTML = `
                    <h3>黑客行動總結</h3>
                    <p><strong>成果:</strong> ${reason}</p>
                    <p><strong>目標狀態:</strong> ${GameState.playerData.law_enforcement.serverHealth <= 0 ? '徹底癱瘓' : '數據外洩'}</p>
                    <p><strong>暗網交易:</strong> 已確認。資金已轉入加密匿名錢包。</p>
                    <p><strong>痕跡清理:</strong> ${GameState.playerData.hacker.digitalFootprints === 0 ? '完美清理' : '部分殘留'}</p>
                `;
            }
        }

        // 更新角色特定按鈕的顯示/隱藏
        function updateRoleSpecificButtons() {
            const role = GameState.currentRole;
            
            // 黑客專用按鈕組 - 只在黑客角色時顯示
            const hackerGroups = ['hacker-action-group', 'hacker-crypto-group', 'hacker-darknet-group'];
            hackerGroups.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (role === 'hacker') {
                        el.style.display = 'flex';
                        el.classList.remove('hidden-group');
                    } else {
                        el.style.display = 'none';
                        el.classList.add('hidden-group');
                    }
                }
            });
            
            // 執法部門專用按鈕組 - 只在執法部門角色時顯示
            const leGroups = ['le-action-group', 'le-advanced-group'];
            leGroups.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (role === 'law_enforcement') {
                        el.style.display = 'flex';
                        el.classList.remove('hidden-group');
                    } else {
                        el.style.display = 'none';
                        el.classList.add('hidden-group');
                    }
                }
            });
            // 顯示一次性的隱藏功能提示，幫助使用者尋找被隱藏的專屬功能
            try { showHiddenFeaturesHintForRole(role); } catch(e) { /* ignore if function not present */ }
        }
    
        function initializeGameUI() {
            // 驗證遊戲數據
            validateGameStats();
            
            const gamePage = document.getElementById('game-page');
            gamePage.innerHTML = '';
            
            // 根據角色確定UI主題
            const uiClass = GameState.currentRole === 'hacker' ? 'hacker-ui' : 'law-enforcement-ui';
            const primaryColor = GameState.currentRole === 'hacker' ? '#00ff41' : '#4a90d9';
            const roleName = GameState.currentRole === 'hacker' ? '黑客' : '執法部門';
            const opponentName = GameState.currentRole === 'hacker' ? '執法部門' : '黑客';
            
            // 構建遊戲界面
            gamePage.className = 'page active ' + uiClass;
            gamePage.innerHTML = `
                <div class="game-container">
                    <!-- 遊戲頭部 -->
                    <div class="game-header">
                        <div class="game-title-container">
                            <div class="game-mode-icon">
                                <i class="fas ${GameState.currentRole === 'hacker' ? 'fa-user-secret' : 'fa-shield-alt'}"></i>
                            </div>
                            <div class="game-title">${roleName} • 對戰模式第二季</div>
                        </div>
                        
                        <div class="connection-status">
                            <div class="status-indicator ${GameState.connectionStatus === 'connected' ? '' : 'disconnected'}"></div>
                            <span>${GameState.connectionStatus === 'connected' ? '已連接' : '未連接'}</span>
                        </div>
                        
                        <div class="target-info">
                            <div class="target-label">目標</div>
                            <div class="target-ip">${GameState.opponentIP} (${opponentName})</div>
                        </div>
                        <div style="margin-left:18px; display:flex; gap:8px; align-items:center;">
                            <button class="btn-primary" onclick="openEvidenceGraph()">證據鏈視覺</button>
                            <button class="btn-primary" onclick="toggleHackerVisuals()">黑客視覺</button>
                            <button class="btn-primary" onclick="openMonitoringPanel()">監控面板</button>
                            <button class="btn-primary" onclick="openLegalTools()">法律工具</button>
                            <button class="btn-primary" onclick="openDefenseTools()">防禦與隱匿</button>
                            <button class="btn-primary" onclick="openDarknetOps()">暗網操作</button>
                        </div>
                    </div>
                    
                    <!-- 截圖風格的目標系統信息 -->
                    <div class="target-system-info">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="color: ${primaryColor}; font-weight: bold; font-size: 1.1rem;">目標信息</div>
                                <div style="color: #aaa; font-size: 0.9rem;">${GameState.currentRole === 'hacker' ? '執法部門指揮中心' : '黑客網絡系統'}</div>
                            </div>
                            <div style="padding: 5px 10px; background: rgba(0,255,65,0.2); border-radius: 12px; color: #00ff41; font-size: 0.8rem;">
                                在線
                            </div>
                        </div>
                        
                        <div class="system-details" id="system-details">
                            <!-- 系統詳細信息將由JavaScript動態生成 -->
                        </div>
                    </div>
                    
                    <!-- 攻擊路徑視覺化 -->
                    <div class="attack-path-visualization">
                        <div class="path-title">
                            <i class="fas fa-project-diagram"></i>
                            <span>攻擊路徑視覺化</span>
                        </div>
                        <div class="path-timeline" id="attack-path-timeline">
                            <!-- 攻擊路徑時間線將由JavaScript動態生成 -->
                        </div>
                    </div>
                    
                    <!-- 實戰地圖 (嵌入式) -->
                    <div class="embedded-battle-map">
                        <div class="path-title" style="padding: 10px; background: rgba(0,0,0,0.5); border-bottom: 1px solid rgba(0,100,255,0.2); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <i class="fas fa-map-marked-alt"></i>
                                <span>實戰網絡地圖</span>
                            </div>
                            <div style="font-size: 0.8rem; color: #aaa;">點擊節點查看詳情</div>
                        </div>
                        <svg id="network-svg" width="100%" height="100%" viewBox="0 0 1200 800">
                    <!-- 背景網格 -->
                    <defs>
                        <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                            <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(0,100,255,0.1)" stroke-width="1"/>
                        </pattern>
                        <!-- 攻擊效果 -->
                        <radialGradient id="attackGradient" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#ff3333;stop-opacity:0.8" />
                            <stop offset="100%" style="stop-color:#ff3333;stop-opacity:0" />
                        </radialGradient>
                        <!-- 防禦效果 -->
                        <radialGradient id="defenseGradient" cx="50%" cy="50%" r="50%">
                            <stop offset="0%" style="stop-color:#00ff41;stop-opacity:0.6" />
                            <stop offset="100%" style="stop-color:#00ff41;stop-opacity:0" />
                        </radialGradient>
                        <!-- 威脅指示器 -->
                        <filter id="threatGlow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge> 
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />

                    <!-- 威脅區域覆蓋 -->
                    <circle cx="900" cy="400" r="200" fill="url(#attackGradient)" opacity="0.3" class="threat-zone opponent-threat">
                        <animate attributeName="opacity" values="0.1;0.4;0.1" dur="3s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="300" cy="400" r="180" fill="url(#defenseGradient)" opacity="0.2" class="defense-zone player-defense">
                        <animate attributeName="opacity" values="0.1;0.3;0.1" dur="4s" repeatCount="indefinite"/>
                    </circle>

                    <!-- 防禦範圍 -->
                    <circle cx="300" cy="400" r="150" fill="none" stroke="rgba(0,255,0,0.3)" stroke-width="2" stroke-dasharray="5,5" class="defense-range player-defense">
                        <animate attributeName="r" values="150;160;150" dur="2s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="900" cy="400" r="150" fill="none" stroke="rgba(255,0,0,0.3)" stroke-width="2" stroke-dasharray="5,5" class="defense-range opponent-defense">
                        <animate attributeName="r" values="150;160;150" dur="2s" repeatCount="indefinite"/>
                    </circle>

                    <!-- 數據包流動動畫 -->
                    <g class="data-packets">
                        <!-- 玩家到對手的數據包 -->
                        <circle cx="300" cy="400" r="3" fill="#00ff41" class="data-packet player-packet">
                            <animateMotion dur="2s" repeatCount="indefinite">
                                <path d="M 0 0 L 600 0"/>
                            </animateMotion>
                        </circle>
                        <circle cx="300" cy="400" r="3" fill="#00ff41" class="data-packet player-packet">
                            <animateMotion dur="2.5s" repeatCount="indefinite" begin="0.5s">
                                <path d="M 0 0 L 600 0"/>
                            </animateMotion>
                        </circle>
                        <!-- 對手到玩家的數據包 -->
                        <circle cx="900" cy="400" r="3" fill="#ff3333" class="data-packet opponent-packet">
                            <animateMotion dur="2s" repeatCount="indefinite">
                                <path d="M 0 0 L -600 0"/>
                            </animateMotion>
                        </circle>
                        <circle cx="900" cy="400" r="3" fill="#ff3333" class="data-packet opponent-packet">
                            <animateMotion dur="2.5s" repeatCount="indefinite" begin="0.7s">
                                <path d="M 0 0 L -600 0"/>
                            </animateMotion>
                        </circle>
                    </g>

                    <!-- 網絡節點 -->
                    <!-- 玩家側節點 -->
                    <g class="player-nodes">
                        <circle cx="300" cy="400" r="20" fill="#00ff41" stroke="#fff" stroke-width="3" class="node player-node main-node" data-device="pc" data-status="active">
                            <animate attributeName="r" values="20;25;20" dur="1s" repeatCount="indefinite"/>
                        </circle>
                        <text x="300" y="405" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">PC</text>
                        
                        <circle cx="200" cy="300" r="15" fill="#4a90d9" stroke="#fff" stroke-width="2" class="node player-node" data-device="browser" data-status="active">
                            <animate attributeName="r" values="15;18;15" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                        <text x="200" y="305" text-anchor="middle" fill="#fff" font-size="8">瀏覽器</text>
                        
                        <circle cx="400" cy="300" r="15" fill="#4a90d9" stroke="#fff" stroke-width="2" class="node player-node" data-device="router" data-status="active">
                            <animate attributeName="r" values="15;18;15" dur="1.2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="400" y="305" text-anchor="middle" fill="#fff" font-size="8">路由器</text>
                        
                        <circle cx="250" cy="500" r="12" fill="#888" stroke="#fff" stroke-width="2" class="node player-node" data-device="mobile" data-status="warning">
                            <animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="250" y="505" text-anchor="middle" fill="#fff" font-size="8">手機</text>
                        
                        <circle cx="150" cy="450" r="10" fill="#ff9900" stroke="#fff" stroke-width="2" class="node player-node" data-device="server" data-status="active">
                            <animate attributeName="r" values="10;13;10" dur="1.8s" repeatCount="indefinite"/>
                        </circle>
                        <text x="150" y="455" text-anchor="middle" fill="#fff" font-size="7">伺服器</text>
                    </g>

                    <!-- 對手側節點 -->
                    <g class="opponent-nodes">
                        <circle cx="900" cy="400" r="20" fill="#ff3333" stroke="#fff" stroke-width="3" class="node opponent-node main-node" data-device="pc" data-status="threat">
                            <animate attributeName="r" values="20;25;20" dur="1s" repeatCount="indefinite"/>
                            <animate attributeName="fill" values="#ff3333;#ff6666;#ff3333" dur="0.5s" repeatCount="indefinite"/>
                        </circle>
                        <text x="900" y="405" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">PC</text>
                        
                        <circle cx="800" cy="300" r="15" fill="#ff9900" stroke="#fff" stroke-width="2" class="node opponent-node" data-device="browser" data-status="threat">
                            <animate attributeName="r" values="15;18;15" dur="1.5s" repeatCount="indefinite"/>
                        </circle>
                        <text x="800" y="305" text-anchor="middle" fill="#fff" font-size="8">瀏覽器</text>
                        
                        <circle cx="1000" cy="300" r="15" fill="#ff9900" stroke="#fff" stroke-width="2" class="node opponent-node" data-device="router" data-status="active">
                            <animate attributeName="r" values="15;18;15" dur="1.2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="1000" y="305" text-anchor="middle" fill="#fff" font-size="8">路由器</text>
                        
                        <circle cx="850" cy="500" r="12" fill="#888" stroke="#fff" stroke-width="2" class="node opponent-node" data-device="mobile" data-status="active">
                            <animate attributeName="r" values="12;15;12" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="850" y="505" text-anchor="middle" fill="#fff" font-size="8">手機</text>
                        
                        <circle cx="1050" cy="450" r="10" fill="#ff6666" stroke="#fff" stroke-width="2" class="node opponent-node" data-device="proxy" data-status="threat">
                            <animate attributeName="r" values="10;13;10" dur="1.8s" repeatCount="indefinite"/>
                        </circle>
                        <text x="1050" y="455" text-anchor="middle" fill="#fff" font-size="7">代理</text>
                    </g>

                    <!-- 連接線 -->
                    <g class="connections">
                        <!-- 玩家內部連接 -->
                        <line x1="300" y1="400" x2="200" y2="300" stroke="#00ff41" stroke-width="3" class="connection player-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </line>
                        <line x1="300" y1="400" x2="400" y2="300" stroke="#00ff41" stroke-width="3" class="connection player-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </line>
                        <line x1="300" y1="400" x2="250" y2="500" stroke="#00ff41" stroke-width="3" class="connection player-connection warning">
                            <animate attributeName="stroke-opacity" values="0.2;0.8;0.2" dur="1.5s" repeatCount="indefinite"/>
                        </line>
                        <line x1="300" y1="400" x2="150" y2="450" stroke="#00ff41" stroke-width="2" class="connection player-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2.5s" repeatCount="indefinite"/>
                        </line>

                        <!-- 對手內部連接 -->
                        <line x1="900" y1="400" x2="800" y2="300" stroke="#ff3333" stroke-width="3" class="connection opponent-connection threat">
                            <animate attributeName="stroke-opacity" values="0.5;1;0.5" dur="1.5s" repeatCount="indefinite"/>
                        </line>
                        <line x1="900" y1="400" x2="1000" y2="300" stroke="#ff3333" stroke-width="3" class="connection opponent-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </line>
                        <line x1="900" y1="400" x2="850" y2="500" stroke="#ff3333" stroke-width="3" class="connection opponent-connection active">
                            <animate attributeName="stroke-opacity" values="0.3;1;0.3" dur="2s" repeatCount="indefinite"/>
                        </line>
                        <line x1="900" y1="400" x2="1050" y2="450" stroke="#ff3333" stroke-width="2" class="connection opponent-connection threat">
                            <animate attributeName="stroke-opacity" values="0.5;1;0.5" dur="1.8s" repeatCount="indefinite"/>
                        </line>

                        <!-- 攻擊路徑 -->
                        <line x1="400" y1="300" x2="800" y2="300" stroke="#ffff00" stroke-width="4" class="attack-path active" style="display: block;">
                            <animate attributeName="stroke-dasharray" values="0,20;20,0" dur="0.5s" repeatCount="indefinite"/>
                        </line>
                        <line x1="250" y1="500" x2="850" y2="500" stroke="#ffff00" stroke-width="4" class="attack-path active" style="display: block;">
                            <animate attributeName="stroke-dasharray" values="0,20;20,0" dur="0.5s" repeatCount="indefinite"/>
                        </line>
                        <line x1="150" y1="450" x2="1050" y2="450" stroke="#ff6600" stroke-width="3" class="attack-path potential" style="display: block; opacity: 0.5;">
                            <animate attributeName="stroke-dasharray" values="0,15;15,0" dur="1s" repeatCount="indefinite"/>
                        </line>
                    </g>

                    <!-- 證據收集點 -->
                    <g class="evidence-points">
                        <circle cx="350" cy="350" r="8" fill="#ffff00" stroke="#fff" stroke-width="2" class="evidence-point collected" data-type="ip_logs">
                            <animate attributeName="r" values="8;12;8" dur="2s" repeatCount="indefinite"/>
                        </circle>
                        <text x="350" y="355" text-anchor="middle" fill="#000" font-size="8" font-weight="bold">證</text>
                        
                        <circle cx="950" cy="350" r="8" fill="#ff6600" stroke="#fff" stroke-width="2" class="evidence-point available" data-type="malware_sample">
                            <animate attributeName="r" values="8;12;8" dur="2.5s" repeatCount="indefinite"/>
                        </circle>
                        <text x="950" y="355" text-anchor="middle" fill="#000" font-size="8" font-weight="bold">證</text>
                    </g>

                    <!-- 工具使用指示器 -->
                    <g class="tool-indicators">
                        <rect x="320" y="380" width="20" height="4" fill="#00ff41" class="tool-indicator active" data-tool="firewall">
                            <animate attributeName="width" values="20;30;20" dur="1s" repeatCount="indefinite"/>
                        </rect>
                        <rect x="920" y="380" width="20" height="4" fill="#ff3333" class="tool-indicator active" data-tool="ddos">
                            <animate attributeName="width" values="20;30;20" dur="1s" repeatCount="indefinite"/>
                        </rect>
                    </g>
                </svg>
                    </div>
    
                    <!-- 遊戲統計 -->
                    <div class="game-stats" id="game-stats">
                        <!-- 統計卡片將由JavaScript動態生成 -->
                    </div>
                    
                    <!-- 系統狀態條 -->
                    <div class="system-status-bars" id="system-status-bars">
                        <!-- 系統狀態條將由JavaScript動態生成 -->
                    </div>
                    
                    <!-- 主遊戲區域 -->
                    <div class="game-main">
                        <!-- 左側面板 -->
                        <div class="left-panel">
                            <!-- 終端機 -->
                            <div class="terminal-container">
                                <div class="terminal-header">
                                    <div class="terminal-title">
                                        <i class="fas fa-terminal"></i>
                                        <span>${GameState.currentRole === 'hacker' ? 'CMD COMMAND Prompt 6.6.0' : 'LAW ENFORCEMENT COMMAND v3.0'}</span>
                                    </div>
                                    <div class="terminal-status">
                                        <i class="fas fa-clock"></i>
                                        <span id="game-timer">${Math.floor(GameState.gameTimeLimit / 60).toString().padStart(2, '0')}:00</span>
                                    </div>
                                </div>
                                <div class="terminal-body">
                                    <div class="terminal-output" id="terminal-output"></div>
                                    <div class="terminal-input-container">
                                        <div class="terminal-prompt">${GameState.currentRole === 'hacker' ? 'C:\\>' : 'investigator@le:~#'}</div>
                                        <input type="text" class="terminal-input" id="terminal-input" placeholder="輸入指令或使用工具...">
                                    </div>
                                    <div class="input-suggestions" id="input-suggestions">
                                        <!-- 輸入建議將由JavaScript動態生成 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 工具面板 -->
                            <div class="tools-panel">
                                <div class="tools-title">
                                    <i class="fas fa-tools"></i>
                                    <span>專屬工具庫</span>
                                </div>
                                    <div style="margin-top:10px; margin-bottom:12px;">
                                        <input id="tool-quick-find" placeholder="快速搜尋工具或技能..." style="width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:#fff;" />
                                    </div>
                                    <div class="tools-categories" id="tool-categories">
                                    <!-- 工具分類將由JavaScript動態生成 -->
                                </div>
                                <div class="tools-grid" id="tools-grid">
                                    <!-- 工具將由JavaScript動態生成 -->
                                </div>
                            </div>
                            
                            <!-- 特殊技能面板 -->
                            <div class="special-skills-panel">
                                <div class="tools-title">
                                    <i class="fas fa-star"></i>
                                    <span>高階特殊技能</span>
                                </div>
                                <div class="special-skills-grid" id="special-skills-grid">
                                    <!-- 特殊技能將由JavaScript動態生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右側面板 -->
                        <div class="right-panel">
                            <!-- 任務目標面板 -->
                            <div class="mission-panel">
                                <div class="mission-title">
                                    <i class="fas fa-bullseye"></i>
                                    <span>任務目標</span>
                                </div>
                                <div class="mission-list" id="mission-list">
                                    <!-- 任務列表將由JavaScript動態生成 -->
                                </div>
                            </div>
                            
                            <!-- 攻擊/防禦視覺化 -->
                            <div class="attack-defense-visualization">
                                <div class="visualization-title">
                                    <i class="fas fa-chart-line"></i>
                                    <span>對抗狀態</span>
                                </div>
                                <div class="progress-bars" id="attack-defense-bars">
                                    <!-- 進度條將由JavaScript動態生成 -->
                                </div>
                            </div>
                            
                            <!-- 系統健康視覺化 -->
                            <div class="health-visualization" id="health-visualization">
                                <!-- 健康卡片將由JavaScript動態生成 -->
                            </div>
                            
                            <!-- 對戰信息面板 -->
                            <div class="battle-info">
                                <div class="battle-title">
                                    <i class="fas fa-info-circle"></i>
                                    <span>對戰信息</span>
                                </div>
                                
                                <!-- 實時目標信息顯示 -->
                                <div class="target-realtime-info" id="target-realtime-info">
                                    <!-- 實時目標信息將由JavaScript動態生成 -->
                                </div>
                                
                                <div id="special-panel">
        <div class="network-topology">
            <div class="tools-title"><i class="fas fa-project-diagram"></i> 網絡可視化面板</div>
            <div id="network-topology-container" style="position:relative; width:100%; height:210px;"></div>
        </div>
        <div class="log-monitor">
            <div class="log-tabs">
                <div class="log-tab active" data-type="system" onclick="switchLogTab('system')">系統日誌</div>
                <div class="log-tab" data-type="security" onclick="switchLogTab('security')">安全日誌</div>
                <div class="log-tab" data-type="communication" onclick="switchLogTab('communication')">通信日誌</div>
            </div>
            <div id="log-display" class="log-display"></div>
            <div class="log-filter">
                <input type="text" id="log-filter-input" placeholder="過濾關鍵詞..." oninput="updateLogDisplay(document.querySelector('.log-tab.active').dataset.type)">
            </div>
        </div>
    
                                    <!-- 特殊面板將根據角色顯示 -->
                                </div>
                            </div>
                            
                            <!-- 控制面板 -->
                            <div class="game-controls">
                                <div class="control-group">
                                    <button class="btn btn-primary" onclick="connectToTarget()">
                                        <i class="fas fa-plug"></i>
                                        <span>連接目標</span>
                                    </button>
                                    <button class="btn btn-secondary" onclick="disconnectFromTarget()">
                                        <i class="fas fa-plug"></i>
                                        <span>斷開連接</span>
                                    </button>
                                    ${GameState.currentRole === 'hacker' ? 
                                        '<button class="btn btn-warning" onclick="openHackerShop()"><i class="fas fa-shopping-cart"></i><span>黑客商店</span></button>' :
                                        '<button class="btn btn-warning" onclick="openLEShop()"><i class="fas fa-shopping-cart"></i><span>執法商店</span></button>'
                                    }
                                </div>
                                <div class="control-group">
                                    <button class="btn btn-warning" onclick="pauseGame()">
                                        <i class="fas fa-pause"></i>
                                        <span>暫停遊戲</span>
                                    </button>
                                    <button class="btn back-btn" onclick="goToMainPage()">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>退出對戰</span>
                                    </button>
                                </div>
                            </div>
                        
                    <!-- 快捷功能按鈕區 -->
                    
                    <!-- 深度監控面板 -->
                    <div class="deep-monitor-grid">
                        <!-- 設備資訊狀態 -->
                        <div class="monitor-card">
                            <div class="monitor-title"><i class="fas fa-desktop"></i> 設備實時狀態</div>
                            <div id="my-security-status" class="security-status-badge status-safe">安全</div>
                            <div class="device-specs-list" id="my-device-specs">
                                <!-- 由 JS 動態填充 -->
                            </div>
                            <div class="browser-live-preview" id="browser-preview">
                                <div style="text-align:center">
                                    <i class="fas fa-globe" style="font-size:2rem; margin-bottom:5px;"></i><br>
                                    瀏覽器實況預覽中...
                                </div>
                            </div>
                        </div>

                        <!-- 網絡活動監控 -->
                        <div class="monitor-card">
                            <div class="monitor-title"><i class="fas fa-network-wired"></i> 網絡活動監控</div>
                            <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#aaa;">
                                <span>上傳: <span id="upload-speed">0 KB/s</span></span>
                                <span>下載: <span id="download-speed">0 KB/s</span></span>
                            </div>
                            <div class="traffic-chart-container" id="traffic-chart">
                                <!-- 由 JS 動態填充 -->
                            </div>
                            <div class="packet-sniffer" id="packet-sniffer">
                                <div class="packet-line">[系統] 封包分析器已啟動...</div>
                            </div>
                        </div>
                    </div>
    
                    <div class="quick-actions-panel">
                        <!-- 攻擊類功能 - 黑客專用 -->
                        <div class="quick-action-group hacker-action-group" id="hacker-action-group" style="display: none;">
                            <div class="group-title"><i class="fas fa-crosshairs"></i> 攻擊模組 / Hacker Offensive</div>
                            <div class="group-btns">
                                <button class="quick-btn hacker-only" onclick="quickAction('auto_attack', this)">
                                    <i class="fas fa-robot"></i> 自動化攻擊
                                </button>
                                <button class="quick-btn hacker-only" onclick="quickAction('direct_attack', this)">
                                    <i class="fas fa-bomb"></i> 直接攻擊
                                </button>
                                <button class="quick-btn hacker-only" onclick="quickAction('progressive_attack', this)">
                                    <i class="fas fa-stairs"></i> 循序漸進攻擊
                                </button>
                                <button class="quick-btn hacker-only" onclick="quickAction('zombie_attack', this)">
                                    <i class="fas fa-virus"></i> 殭屍級攻擊
                                </button>
                                <button class="quick-btn hacker-only" onclick="quickAction('signal_jammer', this)">
                                    <i class="fas fa-broadcast-tower"></i> 信號幹擾器
                                </button>
                                <button class="quick-btn hacker-only" onclick="quickAction('emergency_erase', this)">
                                    <i class="fas fa-fire"></i> 緊急快速清除痕跡
                                </button>
                            </div>
                        </div>

                        <!-- 執法部門專用功能 -->
                        <div class="quick-action-group le-action-group" id="le-action-group" style="display: none;">
                            <div class="group-title"><i class="fas fa-gavel"></i> 執法專務 / LE Operations</div>
                            <div class="group-btns">
                                <button class="quick-btn le-only" onclick="quickAction('case_details', this)">
                                    <i class="fas fa-file-contract"></i> 案件詳細資料
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('case_report', this)">
                                    <i class="fas fa-file-alt"></i> 案件詳細回報
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('target_intel', this)">
                                    <i class="fas fa-user-shield"></i> 目標情報
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('inter_dept_report', this)">
                                    <i class="fas fa-network-wired"></i> 跨部門協作進度報告
                                </button>
                            </div>
                        </div>

                        <!-- 執法部門高級工具 -->
                        <div class="quick-action-group le-advanced-group" id="le-advanced-group" style="display: none;">
                            <div class="group-title"><i class="fas fa-hammer"></i> 高級工具 / LE Advanced Tools</div>
                            <div class="group-btns">
                                <!-- 執法快速啟動功能 -->
                                <button class="quick-btn le-only" onclick="quickAction('open_forensics', this)">
                                    <i class="fas fa-magnifying-glass-chart"></i> 數位鑑識室
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('open_warrant', this)">
                                    <i class="fas fa-file-contract"></i> 搜索令系統
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('gen_summary', this)">
                                    <i class="fas fa-clipboard"></i> 產生執法摘要
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('encryption_analysis', this)">
                                    <i class="fas fa-microchip"></i> 高級數據加密分析
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('behavior_analysis', this)">
                                    <i class="fas fa-brain"></i> 智能行為分析系統
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('instant_tracker', this)">
                                    <i class="fas fa-bolt"></i> 瞬時網絡追蹤器
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('vuln_scanner', this)">
                                    <i class="fas fa-search"></i> 跨平台漏洞掃描器
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('timeline_analyzer', this)">
                                    <i class="fas fa-stream"></i> 時間軸分析器
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('social_network_analysis', this)">
                                    <i class="fas fa-project-diagram"></i> 社交網絡分析
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('geoip_mapping', this)">
                                    <i class="fas fa-map-marker-alt"></i> 地理定位追蹤
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('tls_decode', this)">
                                    <i class="fas fa-lock-open"></i> 加密流量解碼模擬
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('threat_intel_panel', this)">
                                    <i class="fas fa-bell"></i> 實時威脅情報面板
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('cve_lookup', this)">
                                    <i class="fas fa-book"></i> CVE 查詢
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('sandbox_analyze', this)">
                                    <i class="fas fa-flask"></i> 惡意軟體沙箱
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('ai_attack_match', this)">
                                    <i class="fas fa-robot"></i> AI 攻擊模式匹配
                                </button>
                                <!-- 缺失的執法專業工具 -->
                                <button class="quick-btn le-only" onclick="quickAction('forensic_toolkit', this)">
                                    <i class="fas fa-microchip"></i> 數位鑑識工具套件
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('chain_of_custody', this)">
                                    <i class="fas fa-link"></i> 取證鏈管理系統
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('legal_doc_gen', this)">
                                    <i class="fas fa-file-pdf"></i> 法律文書生成器
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('witness_mgmt', this)">
                                    <i class="fas fa-users"></i> 證人/線人管理系統
                                </button>
                                <!-- 調查流程功能 -->
                                <button class="quick-btn le-only" onclick="quickAction('case_management', this)">
                                    <i class="fas fa-folder-open"></i> 案件管理系統
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('task_dispatch', this)">
                                    <i class="fas fa-tasks"></i> 任務分派機制
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('timeline_viz', this)">
                                    <i class="fas fa-chart-gantt"></i> 調查時間線視覺化
                                </button>
                                <button class="quick-btn le-only" onclick="quickAction('report_template', this)">
                                    <i class="fas fa-file-alt"></i> 報告模板庫
                                </button>
                            </div>
                        </div>

                        <!-- 雙方共有的防禦類功能 -->
                        <div class="quick-action-group">
                            <div class="group-title"><i class="fas fa-shield-alt"></i> 防禦防護 / Shared Defense</div>
                            <div class="group-btns">
                                <button class="quick-btn" onclick="quickAction('crack_password', this)">
                                    <i class="fas fa-key"></i> 破解密碼
                                </button>
                                <button class="quick-btn" onclick="quickAction('antivirus', this)">
                                    <i class="fas fa-shield-virus"></i> 防毒掃毒程式
                                </button>
                                <button class="quick-btn" onclick="quickAction('vpn_protection', this)">
                                    <i class="fas fa-lock"></i> VPN 保障
                                </button>
                                <button class="quick-btn" onclick="quickAction('reverse_injection', this)">
                                    <i class="fas fa-syringe"></i> 反向注入
                                </button>
                            </div>
                        </div>

                        <!-- 黑客特有的加密/解密功能 -->
                        <div class="quick-action-group hacker-crypto-group" id="hacker-crypto-group" style="display: none;">
                            <div class="group-title"><i class="fas fa-lock"></i> 密碼學工具 / Hacker Crypto</div>
                            <div class="group-btns">
                                <button class="quick-btn hacker-only" onclick="quickAction('encrypt_file', this)">
                                    <i class="fas fa-lock"></i> 加密文件
                                </button>
                                <button class="quick-btn hacker-only" onclick="quickAction('decrypt_file', this)">
                                    <i class="fas fa-unlock"></i> 解密文件
                                </button>
                                <button class="quick-btn hacker-only" onclick="quickAction('honeypot_gen', this)">
                                    <i class="fas fa-spider"></i> 誘捕網絡生成器
                                </button>
                            </div>
                        </div>

                        <!-- 雙方共有的偵測監控類功能 -->
                        <div class="quick-action-group">
                            <div class="group-title"><i class="fas fa-search"></i> 偵測監控 / Shared Intel & Monitoring</div>
                            <div class="group-btns">
                                <button class="quick-btn" onclick="quickAction('scan_target', this)">
                                    <i class="fas fa-search"></i> 掃描目標
                                </button>
                                <button class="quick-btn" onclick="quickAction('traffic_analysis', this)">
                                    <i class="fas fa-chart-area"></i> 流量監聽分析儀
                                </button>
                                <button class="quick-btn" onclick="quickAction('ip_tracking', this)">
                                    <i class="fas fa-map-marker-alt"></i> IP 追蹤系統
                                </button>
                            </div>
                        </div>

                        <!-- 黑客暗網與系統功能 -->
                        <div class="quick-action-group hacker-darknet-group" id="hacker-darknet-group" style="display: none;">
                            <div class="group-title"><i class="fas fa-user-secret"></i> 暗網 / Hacker Network</div>
                            <div class="group-btns">
                                <button class="quick-btn hacker-only" onclick="quickAction('darknet_hub', this)">
                                    <i class="fas fa-user-secret"></i> 暗網中介聯絡站
                                </button>
                            </div>
                        </div>

                        <!-- 共有課金系統 -->
                        <div class="quick-action-group">
                            <div class="group-title"><i class="fas fa-coins"></i> 系統 / System</div>
                            <div class="group-btns">
                                <button class="quick-btn special" onclick="openUpgradeSystem()">
                                    <i class="fas fa-shopping-cart"></i> 課金系統
                                </button>
                            </div>
                        </div>
                    </div>
    
                    </div>
                </div>
            `;
            
            // 初始化遊戲UI組件
            updateSystemDetails(); updateSecurityStatus();
            updateAttackPathTimeline();
            updateGameStats(); checkWinConditions(); updateReputation(); triggerRandomEvent(); updateResourceUI(); updateSpecialSkillsGrid(); if(GameState.gameActive && Math.random() < 0.1) addGameLog("system", "背景流量監控中...");
            updateSystemStatusBars();
            updateMissionList();
            updateAttackDefenseBars();
            updateHealthVisualization();
            updateTargetRealtimeInfo();
            updateToolCategories();
            updateToolsGrid(GameState.currentRole === 'hacker' ? 'reconnaissance' : 'investigation');
            updateSpecialSkillsGrid();
            updateSpecialPanel(); addNodeClickEvents();
            updateRoleSpecificButtons();
            // 初始化快速搜尋輸入
            if (typeof initQuickFind === 'function') initQuickFind();
            // 強制將面板保持在正常文檔流中，避免被覆蓋
            if (typeof enforcePanelFlow === 'function') enforcePanelFlow();
            
            // 設置終端輸入事件
            const terminalInput = document.getElementById('terminal-input');
            if (terminalInput) {
                terminalInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const command = this.value.trim();
                        if (command) {
                            executeCommand(command);
                            this.value = '';
                            // 清除建議
                            updateInputSuggestions('');
                        }
                    }
                });
                terminalInput.addEventListener('input', function() {
                    updateInputSuggestions(this.value.trim().toLowerCase());
                });
                terminalInput.addEventListener('focus', function() {
                    updateInputSuggestions(this.value.trim().toLowerCase());
                });
            }
        }

        // ===== 系統詳細信息更新 =====
        function updateSystemDetails() {
            const detailsContainer = document.getElementById('system-details');
            if (!detailsContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                detailsContainer.innerHTML = `
                    <div class="system-detail">
                        <div class="system-label">你的ID</div>
                        <div class="system-value">${GameState.playerIP}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">目標ID</div>
                        <div class="system-value">${GameState.opponentIP}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">隱蔽等級</div>
                        <div class="system-value">${hacker.stealth}%</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">加密等級</div>
                        <div class="system-value">${hacker.encryptionLevel}%</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">VPN節點</div>
                        <div class="system-value">${hacker.activeVpnNodes}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">數碼足跡</div>
                        <div class="system-value">${hacker.digitalFootprints}</div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                detailsContainer.innerHTML = `
                    <div class="system-detail">
                        <div class="system-label">你的ID</div>
                        <div class="system-value">${GameState.playerIP}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">目標ID</div>
                        <div class="system-value">${GameState.opponentIP}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">調查進度</div>
                        <div class="system-value">${le.investigationProgress}%</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">身份鎖定</div>
                        <div class="system-value">${Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3)}%</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">關鍵證據</div>
                        <div class="system-value">${le.criticalEvidence.length}/3</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">待驗證情報</div>
                        <div class="system-value">${le.dynamicIntel.length}</div>
                    </div>
                `;
            }
        }

        // ===== 攻擊路徑時間線更新 =====
        function updateAttackPathTimeline() {
            const timelineContainer = document.getElementById('attack-path-timeline');
            if (!timelineContainer) return;
            
            // 模擬攻擊路徑事件
            const now = new Date();
            const events = [
                { time: `${now.getHours().toString().padStart(2, '0')}:${(now.getMinutes()-2).toString().padStart(2, '0')}`, action: '初始連接建立' },
                { time: `${now.getHours().toString().padStart(2, '0')}:${(now.getMinutes()-1).toString().padStart(2, '0')}`, action: '端口掃描完成' },
                { time: `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`, action: '漏洞評估進行中' }
            ];
            
            timelineContainer.innerHTML = '';
            events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'path-event';
                eventElement.innerHTML = `
                    <div class="path-time">${event.time}</div>
                    <div class="path-action">${event.action}</div>
                `;
                timelineContainer.appendChild(eventElement);
            });
        }

        // ===== 遊戲統計更新 =====
        function updateGameStats() {
            const statsContainer = document.getElementById('game-stats');
            if (!statsContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                statsContainer.innerHTML = `
                    
        <div class="stat-card">
            <div class="stat-label">資源點數 <span class="reputation-badge" id="reputation-display">聲譽: 0</span></div>
            <div class="resource-bar"><div id="${GameState.currentRole}-resource-fill" class="resource-fill" style="width:100%"></div></div>
        </div>
    
                    <div class="stat-card">
                        <div class="stat-label">資金</div>
                        <div class="stat-value">$${hacker.money.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">隱蔽度</div>
                        <div class="stat-value">${hacker.stealth}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">數碼足跡</div>
                        <div class="stat-value">${hacker.digitalFootprints}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">入侵設備</div>
                        <div class="stat-value">${hacker.compromisedDevices.length}</div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                const identityAvg = Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3);
                
                statsContainer.innerHTML = `
                    <div class="evidence-stat">
                        <div class="evidence-label">調查預算</div>
                        <div class="evidence-value">$${le.budget.toLocaleString()}</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="evidence-label">身份鎖定</div>
                        <div class="evidence-value">${identityAvg}%</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="evidence-label">關鍵證據</div>
                        <div class="evidence-value">${le.criticalEvidence.length}</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="evidence-label">伺服器健康</div>
                        <div class="evidence-value">${le.serverHealth}%</div>
                    </div>
                `;
            }
        }

        // ===== 系統狀態條更新 =====
        function updateSystemStatusBars() {
            const statusBarsContainer = document.getElementById('system-status-bars');
            if (!statusBarsContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                statusBarsContainer.innerHTML = `
                    <div class="status-bar">
                        <div class="status-label">攻擊路徑</div>
                        <div class="status-value">7.5%</div>
                        <div class="status-percentage">進度</div>
                    </div>
                    <div class="status-bar">
                        <div class="status-label">加密等級</div>
                        <div class="status-value">${hacker.encryptionLevel}%</div>
                        <div class="status-percentage">強度</div>
                    </div>
                    <div class="status-bar">
                        <div class="status-label">檢測風險</div>
                        <div class="status-value">${100 - hacker.stealth}%</div>
                        <div class="status-percentage">風險</div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                statusBarsContainer.innerHTML = `
                    <div class="status-bar">
                        <div class="status-label">調查進度</div>
                        <div class="status-value">${le.investigationProgress}%</div>
                        <div class="status-percentage">進度</div>
                    </div>
                    <div class="status-bar">
                        <div class="status-label">證據質量</div>
                        <div class="status-value">${le.evidenceChain.length > 0 ? Math.min(100, le.evidenceChain.filter(e => !e.contaminated).length * 20) : 0}%</div>
                        <div class="status-percentage">質量</div>
                    </div>
                    <div class="status-bar">
                        <div class="status-label">系統防護</div>
                        <div class="status-value">${Math.round((le.serverHealth + le.evidenceLibraryHealth + le.analysisToolsHealth) / 3)}%</div>
                        <div class="status-percentage">防護</div>
                    </div>
                `;
            }
        }

        // ===== 任務列表更新 =====
        function updateMissionList() {
            const missionListContainer = document.getElementById('mission-list');
            if (!missionListContainer) return;
            
            const missions = GameState.missions[GameState.currentRole];
            missionListContainer.innerHTML = '';
            
            missions.forEach(mission => {
                const missionElement = document.createElement('div');
                missionElement.className = 'mission-item';
                missionElement.innerHTML = `
                    <div class="mission-name">${mission.name}</div>
                    <div class="mission-status ${mission.status === 'complete' ? 'mission-complete' : 'mission-incomplete'}">
                        ${mission.status === 'complete' ? '完成' : '進行中'}
                    </div>
                `;
                missionListContainer.appendChild(missionElement);
            });
        }

        // ===== 攻擊/防禦進度條更新 =====
        function updateAttackDefenseBars() {
            const barsContainer = document.getElementById('attack-defense-bars');
            if (!barsContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                const opponent = GameState.opponentData.law_enforcement;
                
                barsContainer.innerHTML = `
                    <div class="progress-item">
                        <div class="progress-label">攻擊強度</div>
                        <div class="progress-container">
                            <div class="progress-fill attack-progress" style="width: ${hacker.attackPower}%">${hacker.attackPower}%</div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">隱蔽等級</div>
                        <div class="progress-container">
                            <div class="progress-fill stealth-progress" style="width: ${hacker.stealth}%">${hacker.stealth}%</div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">調查壓力</div>
                        <div class="progress-container">
                            <div class="progress-fill defense-progress" style="width: ${opponent.investigationProgress}%">${opponent.investigationProgress}%</div>
                        </div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                const opponent = GameState.opponentData.hacker;
                
                barsContainer.innerHTML = `
                    <div class="progress-item">
                        <div class="progress-label">調查進度</div>
                        <div class="progress-container">
                            <div class="progress-fill attack-progress" style="width: ${le.investigationProgress}%">${le.investigationProgress}%</div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">系統防護</div>
                        <div class="progress-container">
                            <div class="progress-fill defense-progress" style="width: ${Math.round((le.serverHealth + le.evidenceLibraryHealth) / 2)}%">${Math.round((le.serverHealth + le.evidenceLibraryHealth) / 2)}%</div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">黑客隱蔽</div>
                        <div class="progress-container">
                            <div class="progress-fill stealth-progress" style="width: ${opponent.stealth}%">${opponent.stealth}%</div>
                        </div>
                    </div>
                `;
            }
        }

        // ===== 健康視覺化更新 =====
        function updateHealthVisualization() {
            const healthContainer = document.getElementById('health-visualization');
            if (!healthContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                
                // 確定健康等級
                const getHealthClass = (value) => {
                    if (value >= 70) return 'high';
                    if (value >= 40) return 'medium';
                    return 'low';
                };
                
                healthContainer.innerHTML = `
                    <div class="health-card ${getHealthClass(hacker.serverHealth)}">
                        <div class="health-card-title">主伺服器</div>
                        <div class="health-card-value">${hacker.serverHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(hacker.deviceHealth)}">
                        <div class="health-card-title">設備健康</div>
                        <div class="health-card-value">${hacker.deviceHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(hacker.stealth)}">
                        <div class="health-card-title">隱蔽系統</div>
                        <div class="health-card-value">${hacker.stealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(hacker.encryptionLevel)}">
                        <div class="health-card-title">加密系統</div>
                        <div class="health-card-value">${hacker.encryptionLevel}%</div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                
                // 確定健康等級
                const getHealthClass = (value) => {
                    if (value >= 70) return 'high';
                    if (value >= 40) return 'medium';
                    return 'low';
                };
                
                healthContainer.innerHTML = `
                    <div class="health-card ${getHealthClass(le.serverHealth)}">
                        <div class="health-card-title">指揮中心</div>
                        <div class="health-card-value">${le.serverHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(le.evidenceLibraryHealth)}">
                        <div class="health-card-title">證據庫</div>
                        <div class="health-card-value">${le.evidenceLibraryHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(le.analysisToolsHealth)}">
                        <div class="health-card-title">分析工具</div>
                        <div class="health-card-value">${le.analysisToolsHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3))}">
                        <div class="health-card-title">身份鎖定</div>
                        <div class="health-card-value">${Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3)}%</div>
                    </div>
                `;
            }
        }

        // ===== 實時目標信息更新 =====
        function updateTargetRealtimeInfo() {
            const realtimeInfoContainer = document.getElementById('target-realtime-info');
            if (!realtimeInfoContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const opponent = GameState.opponentData.law_enforcement;
                const identityAvg = Math.round((opponent.identityLock.technical + opponent.identityLock.social + opponent.identityLock.physical) / 3);
                
                realtimeInfoContainer.innerHTML = `
                    <div class="realtime-title">
                        <div class="realtime-name">執法部門指揮中心</div>
                        <div class="realtime-status">在線</div>
                    </div>
                    <div class="realtime-details">
                        <div class="realtime-detail">
                            <div class="realtime-label">調查預算</div>
                            <div class="realtime-value">$${(opponent.budget/1000).toFixed(0)}K</div>
                        </div>
                        <div class="realtime-detail">
                            <div class="realtime-label">身份鎖定</div>
                            <div class="realtime-value">${identityAvg}%</div>
                        </div>
                        <div class="realtime-detail">
                            <div class="realtime-label">伺服器健康</div>
                            <div class="realtime-value">${opponent.serverHealth}%</div>
                        </div>
                    </div>
                `;
            } else {
                const opponent = GameState.opponentData.hacker;
                
                realtimeInfoContainer.innerHTML = `
                    <div class="realtime-title">
                        <div class="realtime-name">黑客網絡系統</div>
                        <div class="realtime-status">在線</div>
                    </div>
                    <div class="realtime-details">
                        <div class="realtime-detail">
                            <div class="realtime-label">隱蔽等級</div>
                            <div class="realtime-value">${opponent.stealth}%</div>
                        </div>
                        <div class="realtime-detail">
                            <div class="realtime-label">VPN節點</div>
                            <div class="realtime-value">${opponent.activeVpnNodes}</div>
                        </div>
                        <div class="realtime-detail">
                            <div class="realtime-label">數碼足跡</div>
                            <div class="realtime-value">${opponent.digitalFootprints}</div>
                        </div>
                    </div>
                `;
            }
        }

        // ===== 工具系統 =====
        function updateToolCategories() {
            const categoriesContainer = document.getElementById('tool-categories');
            if (!categoriesContainer) return;
            
            const toolCategories = GameState.currentRole === 'hacker' 
                ? ['reconnaissance', 'stealth', 'counter_investigation', 'attack', 'infiltration', 'server_management', 'advanced']
                : ['investigation', 'tracking', 'defense', 'collaboration', 'forensics', 'skills', 'decryption', 'server_management', 'attack'];
            
            const categoryNames = {
                reconnaissance: { name: '偵察工具', icon: 'fa-binoculars' },
                stealth: { name: '隱蔽工具', icon: 'fa-mask' },
                counter_investigation: { name: '反制調查', icon: 'fa-virus-slash' },
                attack: { name: '攻擊工具', icon: 'fa-crosshairs' },
                infiltration: { name: '入侵工具', icon: 'fa-user-ninja' },
                advanced: { name: '高級工具', icon: 'fa-cogs' },
                investigation: { name: '調查工具', icon: 'fa-search' },
                tracking: { name: '追蹤工具', icon: 'fa-map-marker-alt' },
                defense: { name: '防禦工具', icon: 'fa-shield-alt' },
                collaboration: { name: '協作工具', icon: 'fa-users-cog' },
                forensics: { name: '數位鑑識', icon: 'fa-certificate' },
                skills: { name: '技能與裝備', icon: 'fa-graduation-cap' },
                decryption: { name: '解密工具', icon: 'fa-unlock-alt' },
                server_management: { name: '伺服器管理', icon: 'fa-server' }
            };
            
            categoriesContainer.innerHTML = '';
            toolCategories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = `<i class="fas ${categoryNames[category].icon}"></i> ${categoryNames[category].name}`;
                btn.onclick = () => updateToolsGrid(category);
                if (category === 'reconnaissance' || category === 'investigation') {
                    btn.classList.add('active');
                }
                categoriesContainer.appendChild(btn);
            });
        }

        function updateToolsGrid(category) {
            const toolsGrid = document.getElementById('tools-grid');
            if (!toolsGrid) return;
            
            const tools = GameState.tools[GameState.currentRole][category];
            if (!tools) return;
            
            toolsGrid.innerHTML = '';
            tools.forEach(tool => {
                const toolCard = document.createElement('div');
                toolCard.className = 'tool-card';
                toolCard.innerHTML = `
                    <div class="tool-icon"><i class="fas ${tool.icon || 'fa-cog'}"></i></div>
                    <div class="tool-name">${tool.name}</div>
                    <div class="tool-desc">${tool.desc}</div>
                    <div class="tool-cooldown">冷卻: ${tool.cooldown}秒 | 費用: $${tool.cost}</div>
                `;
                toolCard.style.cursor = 'pointer';
                toolCard.style.transition = 'all 0.3s ease';
                
                // 添加懸停效果
                toolCard.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 10px 30px rgba(74, 144, 217, 0.4)';
                    this.style.borderColor = '#6ab0ff';
                });
                
                toolCard.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 0 10px rgba(74, 144, 217, 0.2)';
                    this.style.borderColor = '#4a90d9';
                });
                
                toolCard.addEventListener('click', function() {
                    // 添加點擊動畫
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'translateY(0) scale(1)';
                    }, 100);
                    
                    // 執行工具
                    useTool(tool.id, tool);
                });
                
                toolsGrid.appendChild(toolCard);
            });
        }

        // ===== 特殊技能網格更新 =====
        function updateSpecialSkillsGrid() {
            const skillsGrid = document.getElementById('special-skills-grid');
            if (!skillsGrid) return;
            
            const skills = GameState.specialSkills[GameState.currentRole];
            if (!skills) return;
            
            skillsGrid.innerHTML = '';
            Object.entries(skills).forEach(([skillId, skill]) => {
                const now = Date.now() / 1000;
                const isOnCooldown = skill.cooldown > 0 && now - skill.lastUsed < skill.cooldown;
                const isUsed = skillId === 'net_capture_order' && skill.used;
                const isDisabled = isOnCooldown || isUsed;
                
                const skillCard = document.createElement('div');
                skillCard.className = `special-skill-card ${isDisabled ? 'disabled' : ''}`;
                
                let cooldownText = '';
                if (isOnCooldown) {
                    const remaining = Math.ceil(skill.cooldown - (now - skill.lastUsed));
                    cooldownText = `<div class="cooldown-indicator">${Math.floor(remaining/60)}:${(remaining%60).toString().padStart(2,'0')}</div>`;
                } else if (isUsed) {
                    cooldownText = `<div class="cooldown-indicator">已使用</div>`;
                }
                
                skillCard.innerHTML = `
                    ${cooldownText}
                    <div class="tool-icon"><i class="fas fa-star"></i></div>
                    <div class="tool-name">${skill.name}</div>
                    <div class="tool-desc">${skill.description}</div>
                    <div class="skill-cost">費用: $${skill.cost.toLocaleString()}</div>
                `;
                
                if (!isDisabled) {
                    skillCard.onclick = () => activateSpecialSkill(skillId);
                }
                
                skillsGrid.appendChild(skillCard);
            });
        }

        // ===== 工具使用函數 =====
        function useTool(toolId, toolData) {
            if (!GameState.gameActive) return;
            
            const role = GameState.currentRole;
            const playerData = GameState.playerData[role];
            const opponentData = GameState.playerData[role === 'hacker' ? 'law_enforcement' : 'hacker'];
            
            // 檢查冷卻時間和資源
            if (toolData.cooldown > 0) {
                // 簡單的冷卻檢查 (實際實現需要更複雜的冷卻系統)
                const lastUsed = playerData.cooldowns[toolId] || 0;
                const now = Date.now() / 1000;
                if (now - lastUsed < toolData.cooldown) {
                    showNotification('工具冷卻中', '請等待冷卻時間結束', 'warning');
                    return;
                }
                playerData.cooldowns[toolId] = now;
            }
            
            if (toolData.cost > 0) {
                const costField = role === 'hacker' ? 'money' : 'budget';
                
                // 執法部門預算審核邏輯
                if (role === 'law_enforcement' && toolData.cost > 5000) {
                    if (Math.random() < 0.2) { // 20% 概率審核失敗
                        addTerminalLine('[拒絕] 預算審核未通過：該操作成本過高，請先提升聲望。', 'error');
                        return;
                    }
                }

                if (playerData[costField] < toolData.cost) {
                    // 黑客自製工具邏輯：如果錢不夠，可以消耗「控制進度」來抵扣 (代表自研工具)
                    if (role === 'hacker' && playerData.controlProgress > 20) {
                        playerData.controlProgress -= 10;
                        addTerminalLine('[自研] 資金不足，消耗系統控制權限以自製臨時工具。', 'warning');
                    } else {
                        showNotification('資源不足', '需要 $' + toolData.cost, 'warning');
                        return;
                    }
                } else {
                    playerData[costField] -= toolData.cost;
                }
            }
            
            showNotification('工具已激活', '工具「' + toolData.name + '」正在執行...', 'success');
            addTerminalLine('[執行] 啟動工具: ' + toolData.name, 'command');
            
            // 添加詳細的資源消耗信息
            if (toolData.cost > 0) {
                const costField = role === 'hacker' ? '資金' : '預算';
                const remaining = role === 'hacker' ? playerData.money : playerData.budget;
                addTerminalLine(`[費用] 消耗 $${toolData.cost} ${costField}，剩餘 $${remaining}`, 'info');
            }
            
            // 添加工具效果描述
            if (toolData.effect) {
                const effectDescriptions = {
                    'scan': '正在掃描目標系統...',
                    'attack': '正在發動攻擊...',
                    'defend': '正在加固防禦...',
                    'stealth': '正在提升隱蔽度...',
                    'counter': '正在部署反制措施...',
                    'analyze': '正在分析流量...',
                    'repair': '正在修復系統...'
                };
                const desc = effectDescriptions[toolData.effect] || '正在執行操作...';
                addTerminalLine(`[狀態] ${desc}`, 'processing');
            }
            
            // 實現工具效果
            implementToolEffect(toolId, toolData, playerData, opponentData);
            // 視覺強化觸發
            if (toolData.effect === 'attack' || toolData.effect === 'infiltrate') {
                const nodes = document.querySelectorAll('.topology-node.target, .node.opponent-node');
                nodes.forEach(n => {
                    n.classList.add('node-detected', 'node-shatter');
                    setTimeout(() => n.classList.remove('node-detected', 'node-shatter'), 2000);
                });
                // 攻擊路徑動效
                const paths = document.querySelectorAll('.attack-path, .topology-connection.attack');
                paths.forEach(p => {
                    const typeClass = toolId === 'ddos' ? 'path-ddos' : 'path-exploit';
                    p.classList.add(typeClass);
                    setTimeout(() => p.classList.remove(typeClass), 3000);
                });
            }
            if (toolData.effect === 'defend' || toolData.effect === 'repair') {
                const nodes = document.querySelectorAll('.topology-node.hacker, .topology-node.law-enforcement, .node.player-node');
                nodes.forEach(n => {
                    n.classList.add('node-defended');
                    setTimeout(() => n.classList.remove('node-defended'), 2000);
                });
            }
    
            
            // 更新UI
            updateGameStats();
            updateSystemStatusBars();
            updateAttackDefenseBars();
            updateHealthVisualization();
        }
        
        // ===== 增強的工具執行函數 - 添加視覺效果與動畫 =====
        function executeToolWithVisualEffect(toolId, toolData, playerData, opponentData) {
            const role = GameState.currentRole;
            const container = document.getElementById('tool-execution-panel');
            
            // 創建執行面板（如果不存在）
            if (!document.getElementById('tool-execution-panel')) {
                const panel = document.createElement('div');
                panel.id = 'tool-execution-panel';
                panel.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    width: 350px;
                    background: rgba(10, 10, 30, 0.95);
                    border: 2px solid #4a90d9;
                    border-radius: 8px;
                    padding: 15px;
                    z-index: 1000;
                    box-shadow: 0 0 20px rgba(74, 144, 217, 0.3);
                    font-size: 0.85rem;
                    max-height: 300px;
                    overflow-y: auto;
                `;
                document.body.appendChild(panel);
            }
            
            const panel = document.getElementById('tool-execution-panel');
            
            // 執行動畫
            const executionId = 'exec_' + Date.now();
            const executionDiv = document.createElement('div');
            executionDiv.id = executionId;
            executionDiv.style.cssText = `
                margin-bottom: 10px;
                padding: 10px;
                background: rgba(74, 144, 217, 0.1);
                border-left: 3px solid #4a90d9;
                border-radius: 4px;
                animation: slideIn 0.3s ease;
            `;
            
            const toolName = toolData.name || toolId;
            executionDiv.innerHTML = `
                <div style="color: #4a90d9; font-weight: bold; margin-bottom: 5px;">
                    <i class="fas fa-cog" style="animation: spin 1s linear infinite;"></i> ${toolName}
                </div>
                <div style="font-size: 0.75rem; color: #aaa; margin-bottom: 5px;" id="${executionId}-status">初始化中...</div>
                <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden;">
                    <div id="${executionId}-progress" style="height: 100%; background: linear-gradient(90deg, #4a90d9, #6ab0ff); width: 0%; transition: width 0.3s ease;"></div>
                </div>
            `;
            panel.insertBefore(executionDiv, panel.firstChild);
            
            // 模擬執行進度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 100) progress = 100;
                
                const progressBar = document.getElementById(executionId + '-progress');
                const statusDiv = document.getElementById(executionId + '-status');
                if (progressBar) progressBar.style.width = progress + '%';
                if (statusDiv) statusDiv.textContent = '執行中... ' + Math.floor(progress) + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    if (statusDiv) statusDiv.textContent = '✓ 執行完成';
                    if (progressBar) progressBar.style.background = 'linear-gradient(90deg, #00ff41, #00aa00)';
                    
                    // 3秒後移除
                    setTimeout(() => {
                        if (executionDiv.parentNode) {
                            executionDiv.style.animation = 'slideOut 0.3s ease';
                            setTimeout(() => executionDiv.remove(), 300);
                        }
                    }, 3000);
                }
            }, 200);
            
            // 添加 CSS 動畫
            if (!document.getElementById('tool-execution-styles')) {
                const style = document.createElement('style');
                style.id = 'tool-execution-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(400px); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(400px); opacity: 0; }
                    }
                    @keyframes spin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.2); }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function implementToolEffect(toolId, toolData, playerData, opponentData) {
            const role = GameState.currentRole;
            
            // 執行視覺效果
            executeToolWithVisualEffect(toolId, toolData, playerData, opponentData);
            
            // 添加詳細的效果日誌
            const effectLog = {
                'fake_fingerprint_effect': `[成功] 虛假指紋已注入！隱蔽度 +20%，目標身份鎖定進度 -15%`,
                'darknet_delegator_effect': `[成功] 暗網任務已委託！控制進度 +15%，隱蔽度 +5%`,
                'evidence_verifier_effect': `[成功] 證據完整性已驗證！備份系統已同步`,
                'emergency_dispatch_effect': `[成功] 緊急調度支援已到達！調查進度 +20%`,
                'vpn_tracker_effect': `[成功] VPN 節點已穿透！目標隱蔽度 -15%`,
                'scan': `[掃描完成] 發現新目標，控制進度 +5%`,
                'stealth': `[隱蔽強化] 隱蔽度提升 +10%，減少被偵測風險`,
                'attack': `[攻擊發動] 對目標系統發動全面攻擊`,
                'defend': `[防禦加固] 系統防禦已加固，健康值 +30%`,
                'repair': `[系統修復] 關鍵組件已恢復，系統運行恢復正常`,
                'analyze': `[流量分析] 對方活動已同步至終端`,
                'counter': `[反制部署] 反制措施已部署`
            };
            
            if (effectLog[toolData.effect]) {
                addTerminalLine(effectLog[toolData.effect], 'success');
            }
            
            // 顯示數據變化
            setTimeout(() => {
                const changes = [];
                if (playerData.stealth !== undefined) {
                    changes.push(`隱蔽度: ${Math.min(100, playerData.stealth)}%`);
                }
                if (playerData.controlProgress !== undefined) {
                    changes.push(`控制進度: ${Math.min(100, playerData.controlProgress)}%`);
                }
                if (playerData.serverHealth !== undefined) {
                    changes.push(`系統健康: ${Math.min(100, playerData.serverHealth)}%`);
                }
                if (playerData.investigationProgress !== undefined) {
                    changes.push(`調查進度: ${Math.min(100, playerData.investigationProgress)}%`);
                }
                if (changes.length > 0) {
                    addTerminalLine(`[數據] ${changes.join(' | ')}`, 'data');
                }
            }, 800);
            
            switch(toolData.effect) {

                
                
                case 'fake_fingerprint_effect':
                    playerData.stealth = Math.min(100, playerData.stealth + 20);
                    opponentData.identityLock.technical = Math.max(0, opponentData.identityLock.technical - 15);
                    opponentData.identityLock.social = Math.max(0, opponentData.identityLock.social - 10);
                    addTerminalLine('[成功] 虛假指紋已注入，執法部門的身份鎖定進度已倒退。', 'success');
                    showNotification('指紋注入成功', '身份鎖定威脅已降低', 'success');
                    // UI 觸發：更新並顯示特殊面板
                    updateSpecialPanel();
                    break;
                
                
                case 'darknet_delegator_effect':
                    playerData.controlProgress = Math.min(100, playerData.controlProgress + 15);
                    playerData.stealth = Math.min(100, playerData.stealth + 5);
                    addTerminalLine('[成功] 暗網任務已委託，自動化攻擊正在進行中。', 'success');
                    showNotification('任務委託成功', '控制進度已提升', 'success');
                    // UI 觸發：彈出黑客商店（模擬暗網市場）
                    openHackerShop();
                    break;
                
                
                case 'evidence_verifier_effect':
                    playerData.evidenceLibraryHealth = 100;
                    playerData.serverHealth = Math.min(100, playerData.serverHealth + 10);
                    addTerminalLine('[成功] 證據完整性已驗證，備份系統已同步，系統防禦增強。', 'success');
                    showNotification('證據驗證完成', '備份系統已就緒', 'success');
                    // UI 觸發：彈出案件管理面板
                    document.getElementById('case-management-panel').style.display = 'block';
                    if (typeof updateCaseStatus === 'function') {
                        updateCaseStatus('安全防禦中', '執行證據完整性驗證，備份系統已同步。');
                    }
                    break;
                
                
                case 'emergency_dispatch_effect':
                    playerData.investigationProgress = Math.min(100, playerData.investigationProgress + 20);
                    playerData.analysisToolsHealth = 100;
                    addTerminalLine('[成功] 緊急調度支援已到達，調查進度大幅提升。', 'success');
                    showNotification('緊急支援到達', '調查效率顯著提升', 'success');
                    // UI 觸發：彈出案件管理面板
                    document.getElementById('case-management-panel').style.display = 'block';
                    if (typeof updateCaseStatus === 'function') {
                        updateCaseStatus('高強度調查', '緊急調度支援小組已介入，調查進度顯著提升。');
                    }
                    break;
                
                
                case 'vpn_tracker_effect':
                    playerData.investigationProgress = Math.min(100, playerData.investigationProgress + 10);
                    opponentData.stealth = Math.max(0, opponentData.stealth - 15);
                    addTerminalLine('[成功] VPN 節點已穿透，黑客真實路徑已暴露。', 'success');
                    showNotification('VPN 追蹤成功', '黑客隱蔽度已下降', 'success');
                    // 自動立案：攔截通信
                    if (typeof LE_SYSTEM !== 'undefined' && LE_SYSTEM.autoDetectionEnabled) {
                        LE_SYSTEM.triggerInterceptCase(
                            GameState.opponentIP || '未知IP',
                            '目標伺服器',
                            'VPN加密通信'
                        );
                    }
                    // UI 觸發：彈出戰況地圖
                    showBattleMap();
                    if (typeof updateTopology === 'function') updateTopology();
                    break;
                
                case 'interpol_request':
                    requestInternationalSupport();
                    break;
                
                case 'analyze':
                    const targetRole = role === 'hacker' ? 'law_enforcement' : 'hacker';
                    const targetData = GameState.playerData[targetRole];
                    const activity = targetRole === 'hacker' ? '攻擊頻率: 高, 資源消耗: 65%' : '調查進度: ' + targetData.investigationProgress.toFixed(0) + '%, 資源消耗: 40%';
                    addTerminalLine('[分析] ' + activity, 'success');
                    showNotification('流量分析完成', '對方活動已同步至終端', 'success');
                    break;
                    
                case 'repair':
                    if (role === 'hacker') {
                        playerData.serverHealth = Math.min(100, playerData.serverHealth + 30);
                        playerData.deviceHealth = Math.min(100, playerData.deviceHealth + 30);
                    } else {
                        playerData.serverHealth = Math.min(100, playerData.serverHealth + 30);
                        playerData.analysisToolsHealth = Math.min(100, playerData.analysisToolsHealth + 30);
                    }
                    addTerminalLine('[維修] 系統修復完成，健康值恢復 30%', 'success');
                    showNotification('系統修復', '關鍵組件已恢復', 'success');
                    break;
    
                // 黑客工具效果
                case 'scan':
                    if (role === 'hacker') {
                        playerData.controlProgress += 5;
                        addTerminalLine('[掃描] 發現新目標，控制進度 +5%', 'success');
                    }
                    break;
                    
                case 'stealth':
                    if (role === 'hacker') {
                        playerData.stealth += 10;
                        addTerminalLine('[隱蔽] 隱蔽度提升，減少被偵測風險', 'success');
                    }
                    break;
                    
                case 'counter':
                    if (role === 'hacker') {
                        if (toolId === 'evidence_wiper') {
                            // 徹底銷毀證據
                            const destroyCount = Math.min(3, opponentData.evidenceChain.length);
                            for (let i = 0; i < destroyCount; i++) {
                                if (opponentData.evidenceChain[i]) {
                                    opponentData.evidenceChain[i].destroyed = true;
                                    opponentData.evidenceChain[i].name += ' [已銷毀]';
                                }
                            }
                            addTerminalLine(`[銷毀] 已徹底銷毀 ${destroyCount} 項證據！`, 'success');
                            // 執法部門自動立案：發現證據銷毀行為
                            if (typeof LE_SYSTEM !== 'undefined' && LE_SYSTEM.autoDetectionEnabled && role !== 'law_enforcement') {
                                LE_SYSTEM.triggerForensicCase(
                                    '證據銷毀攻擊',
                                    `偵測到惡意證據銷毀行為，${destroyCount} 項證據受影響`
                                );
                            }
                        } else if (toolId === 'data_injection') {
                            // 污染證據
                            if (opponentData.evidenceChain.length > 0) {
                                const targetIndex = Math.floor(Math.random() * opponentData.evidenceChain.length);
                                opponentData.evidenceChain[targetIndex].contaminated = true;
                                opponentData.evidenceChain[targetIndex].name += ' [已污染]';
                                addTerminalLine('[污染] 證據數據已被注入偽造信息', 'success');
                                // 執法部門自動立案：發現證據污染
                                if (typeof LE_SYSTEM !== 'undefined' && LE_SYSTEM.autoDetectionEnabled && role !== 'law_enforcement') {
                                    LE_SYSTEM.triggerForensicCase(
                                        '證據污染攻擊',
                                        '偵測到證據庫被注入偽造數據'
                                    );
                                }
                            }
                        }
                    } else {
                        // 執法部門使用防禦工具時，可能觸發蜜罐
                        if (toolId === 'honeypot' || toolId === 'trap_node') {
                            // 模擬黑客觸發蜜罐
                            if (Math.random() > 0.4 && typeof LE_SYSTEM !== 'undefined') {
                                LE_SYSTEM.triggerTrapCase(
                                    '蜜罐系統',
                                    { ip: GameState.opponentIP || '未知IP', method: '暴力破解' }
                                );
                            }
                        }
                    }
                    break;
                    
                case 'attack':
                    if (role === 'hacker') {
                        if (toolId === 'data_wipe') {
                            opponentData.evidenceLibraryHealth -= 15;
                            addTerminalLine('[攻擊] 證據庫數據擦除攻擊成功', 'success');
                        } else if (toolId === 'ransomware') {
                            opponentData.serverHealth -= 25;
                            addTerminalLine('[勒索] 勒索軟件已部署，系統功能受限', 'success');
                        }
                    }
                    break;
                    
                // 執法部門工具效果
                case 'investigate':
                    if (role === 'law_enforcement') {
                        playerData.investigationProgress += 8;
                        addTerminalLine('[調查] 收集到新情報，調查進度 +8%', 'success');
                    }
                    break;
                    
                case 'track':
                    if (role === 'law_enforcement') {
                        if (toolId === 'gps_tracker') {
                            // GPS 衛星定位：黑客反制邏輯
                            addTerminalLine('[GPS] 正在請求衛星定位授權...', 'info');
                            setTimeout(() => {
                                const hackerStealth = opponentData.stealth;
                                const counterChance = hackerStealth / 100; // 隱蔽度越高，反制機率越高
                                
                                if (Math.random() < counterChance) {
                                    const counterType = Math.random() > 0.5 ? 'spoof' : 'block';
                                    if (counterType === 'spoof') {
                                        addTerminalLine('[警告] 偵測到信號干擾：黑客已偽造地理位置坐標！', 'error');
                                        showNotification('定位失敗', '黑客成功偽造了位置信息', 'danger');
                                        playerData.identityLock.technical = Math.max(0, playerData.identityLock.technical - 5);
                                    } else {
                                        addTerminalLine('[警告] 定位中斷：黑客已關閉定位設備並屏蔽信號。', 'warning');
                                        showNotification('信號屏蔽', '目標已從衛星監控中消失', 'warning');
                                    }
                                } else {
                                    playerData.identityLock.technical += 15;
                                    playerData.identityLock.physical += 10;
                                    addTerminalLine('[成功] GPS 精確鎖定：目標物理坐標已同步至指揮中心。', 'success');
                                    showNotification('定位成功', '已獲取黑客精確地理位置', 'success');
                                }
                                updateGameStats();
                            }, 2000);
                        } else {
                            const lockIncrease = 10;
                            playerData.identityLock.technical += lockIncrease;
                            addTerminalLine(`[追蹤] 身份鎖定進度提升 ${lockIncrease}%`, 'success');
                        }
                    }
                    break;
                    
                case 'defend':
                    if (role === 'law_enforcement') {
                        if (toolId === 'evidence_protector') {
                            // 保護證據
                            opponentData.evidenceChain.forEach(e => {
                                if (!e.contaminated) e.protected = true;
                            });
                            addTerminalLine('[防禦] 證據保護系統已啟動', 'success');
                        } else if (toolId === 'emergency_shutdown') {
                            // 應急斷流：後門重連風險
                            addTerminalLine('[斷流] 正在強制切斷可疑網絡連接...', 'warning');
                            playerData.serverHealth = Math.min(100, playerData.serverHealth + 10);
                            
                            setTimeout(() => {
                                const backtraceChance = 0.4; // 40% 機率有後門
                                if (Math.random() < backtraceChance) {
                                    addTerminalLine('[警告] 偵測到後門：黑客利用預留的 SSH 隧道重新建立了連接！', 'error');
                                    showNotification('斷流失敗', '黑客已通過後門重連', 'danger');
                                    opponentData.controlProgress += 10;
                                    playerData.serverHealth -= 15;
                                } else {
                                    addTerminalLine('[成功] 網絡已隔離：所有未授權連接已切斷。', 'success');
                                    showNotification('斷流成功', '已暫時切斷黑客攻擊路徑', 'success');
                                    opponentData.controlProgress = Math.max(0, opponentData.controlProgress - 15);
                                }
                                updateGameStats();
                            }, 2500);
                        } else if (toolId === 'ai_predictor') {
                            // AI 行為預測：隨機性干擾
                            addTerminalLine('[AI] 正在分析黑客行為模式並生成預測模型...', 'info');
                            setTimeout(() => {
                                const randomness = Math.random();
                                if (randomness < 0.2) { // 20% 誤報
                                    addTerminalLine('[AI] 預測完成：偵測到黑客即將發動大規模 DDoS 攻擊（置信度 92%）。', 'warning');
                                    addTerminalLine('[系統] 警告：這可能是一個誘敵信號，黑客行為表現出高度隨機性。', 'info');
                                } else if (randomness < 0.4) { // 20% 漏報
                                    addTerminalLine('[AI] 預測完成：黑客目前處於靜默狀態，威脅等級：低。', 'success');
                                    addTerminalLine('[警告] 偵測到異常流量：AI 未能識別黑客的非線性攻擊行為！', 'error');
                                } else {
                                    playerData.investigationProgress += 10;
                                    addTerminalLine('[AI] 預測成功：已識別黑客的下一步攻擊目標為證據庫。', 'success');
                                    showNotification('預測成功', '已獲取黑客行動預測報告', 'success');
                                }
                                updateGameStats();
                            }, 3000);
                        } else if (toolId === 'evidence_cleanser') {
                            // 證據清潔系統：不可逆損壞風險
                            const contaminated = playerData.evidenceChain.filter(e => e.contaminated);
                            if (contaminated.length > 0) {
                                addTerminalLine('[清潔] 啟動深度證據清潔與恢復程序...', 'info');
                                let successCount = 0;
                                let damageCount = 0;
                                
                                contaminated.forEach(e => {
                                    if (Math.random() < 0.25) { // 25% 損壞機率
                                        e.name += ' [永久損壞]';
                                        e.contaminated = false;
                                        e.damaged = true;
                                        damageCount++;
                                    } else {
                                        e.contaminated = false;
                                        e.name = e.name.replace(' [已污染]', '');
                                        successCount++;
                                    }
                                });
                                
                                if (successCount > 0) addTerminalLine(`[成功] 已恢復 ${successCount} 件證據的原始數據。`, 'success');
                                if (damageCount > 0) {
                                    addTerminalLine(`[嚴重] ${damageCount} 件證據在清潔過程中發生不可逆損壞！`, 'error');
                                    showNotification('證據損壞', '部分證據在恢復過程中丟失', 'danger');
                                }
                            } else {
                                addTerminalLine('[系統] 未發現需要清潔的污染證據。', 'info');
                            }
                        }
                    }
                    break;
                    
                default:
                    addTerminalLine('[結果] 工具執行成功，冷卻時間: ' + toolData.cooldown + '秒', 'success');
            }
        }

        // ===== 遊戲更新循環 =====
        function updateGameLoop() {
            if (!GameState.gameActive) return;
            validateGameStats();
            checkWinConditions();
            updateMissions();
            updateReputation();
            triggerRandomEvent();
            updateResourceUI(); updateSpecialSkillsGrid();
        
            // AI 對手動態行為 (狀態機 AI)
            const role = GameState.currentRole;
            const opponentRole = role === 'hacker' ? 'law_enforcement' : 'hacker';
            const opponentData = GameState.playerData[opponentRole];
            const playerData = GameState.playerData[role];
            
            if (!opponentData.aiState) opponentData.aiState = 'normal';

            if (opponentRole === 'hacker') {
                // 黑客 AI 邏輯
                if (playerData.investigationProgress > 70) {
                    opponentData.aiState = 'panic';
                    opponentData.controlProgress += Math.random() * 1.5; // 瘋狂進攻
                    opponentData.stealth -= 0.5; // 暴露風險增加
                } else if (playerData.investigationProgress < 30) {
                    opponentData.aiState = 'stealth';
                    opponentData.stealth = Math.min(100, opponentData.stealth + 0.8); // 專注隱蔽
                } else {
                    opponentData.aiState = 'normal';
                    opponentData.controlProgress += Math.random() * 0.6;
                }
            } else {
                // 執法 AI 邏輯
                if (playerData.controlProgress > 70) {
                    opponentData.aiState = 'aggressive';
                    opponentData.investigationProgress += Math.random() * 1.2; // 加快調查
                } else {
                    opponentData.aiState = 'normal';
                    opponentData.investigationProgress += Math.random() * 0.5;
                }
            }

            // 隨機提示 AI 狀態
            if (Math.random() < 0.03) {
                const stateMsgs = {
                    'panic': '警告：偵測到黑客正在進行自殺式攻擊！',
                    'stealth': '提示：黑客似乎進入了深度隱蔽模式，追蹤難度增加。',
                    'aggressive': '警告：執法部門已啟動緊急追捕協議！'
                };
                if (stateMsgs[opponentData.aiState]) addGameLog('security', stateMsgs[opponentData.aiState]);
            }
    }

    

        // ===== 遊戲計時器 =====
        function startGameTimer() {
            let timeLeft = GameState.gameTimeLimit;
            GameState.gameTimer = setInterval(() => {
                if (!GameState.gameActive) {
                    clearInterval(GameState.gameTimer);
                    return;
                }
                
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                const timerEl = document.getElementById('game-timer');
                if (timerEl) {
                    timerEl.textContent = minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                }
                
                if (timeLeft <= 0) {
                    GameState.gameActive = false;
                    clearInterval(GameState.gameTimer);
                    checkWinConditions();
                }
                
                updateGameLoop(); processAITeamLogic();
            }, 1000);
        }

        // ===== 終端命令執行 =====
        function executeCommand(command) {
            addTerminalLine('$ ' + command, 'command');
            if (command.toLowerCase() === 'help') {
                addTerminalLine('可用指令: scan, attack, defend, status, tools', 'response');
            } else if (command.toLowerCase() === 'status') {
                updateGameStats();
                addTerminalLine('[狀態] 遊戲數據已更新', 'success');
            } else {
                addTerminalLine('[系統] 指令未識別，輸入 help 查看可用指令', 'error');
            }
            // 執行完畢後清除即時建議
            if (typeof updateInputSuggestions === 'function') updateInputSuggestions('');
        }

        // ===== 連接/斷開目標 =====
        function connectToTarget() {
            GameState.connectionStatus = 'connected';
            addTerminalLine('[系統] 已連接到目標: ' + GameState.opponentIP, 'success');
            showNotification('連接成功', '已連接到對手系統', 'success');
        }

        // ===== 終端輸入建議系統 =====
        function updateInputSuggestions(query) {
            const container = document.getElementById('input-suggestions');
            if (!container) return;
        
        // ===== 測試與驗證工具 =====
        // 模擬 AI 行為以便驗證不同難度下行為差異
        async function simulateAIBehavior({ difficulty = 'professional', ticks = 40, tickInterval = 50 } = {}) {
            addTerminalLine(`[測試] 開始 AI 模擬 (難度: ${difficulty}, ticks: ${ticks})`, 'info');
            // 設定難度
            if (typeof adjustAISensitivity === 'function') adjustAISensitivity(difficulty);
            GameState.difficulty = difficulty;

            const results = { law_enforcement: { collaborations: 0, reinforcements: 0 }, hacker: { collaborations: 0, reinforcements: 0 } };

            // 暫時 patch 函數以計數
            const origExecCollab = window.executeCollaborativeCommand;
            const origRequestReinforce = window.requestReinforcements;

            window.executeCollaborativeCommand = function(role) {
                results[role].collaborations++;
                addTerminalLine(`[測試-記錄] ${role} 協作觸發`, 'debug');
                if (origExecCollab) origExecCollab(role);
            };
            window.requestReinforcements = function(role) {
                results[role].reinforcements++;
                addTerminalLine(`[測試-記錄] ${role} 增援請求`, 'debug');
                if (origRequestReinforce) origRequestReinforce(role);
            };

            // 讓 aiParams 能夠快速做決策以便於測試
            const savedInterval = GameState.aiParams.decisionInterval;
            GameState.aiParams.decisionInterval = 0; // 允許每次調用都做決策

            for (let i = 0; i < ticks; i++) {
                processAITeamLogic();
                await new Promise(r => setTimeout(r, tickInterval));
            }

            // restore
            GameState.aiParams.decisionInterval = savedInterval;
            window.executeCollaborativeCommand = origExecCollab;
            window.requestReinforcements = origRequestReinforce;

            addTerminalLine(`[測試結果] difficulty=${difficulty} => LE.collab:${results.law_enforcement.collaborations}, LE.reinforce:${results.law_enforcement.reinforcements}; H.collab:${results.hacker.collaborations}, H.reinforce:${results.hacker.reinforcements}`, 'success');
            return results;
        }

        // 驗證輸入建議系統
        function testInputSuggestions() {
            addTerminalLine('[測試] 開始輸入建議測試', 'info');
            updateInputSuggestions('');
            const container = document.getElementById('input-suggestions');
            const emptyOk = container && container.children.length > 0;
            updateInputSuggestions('sc');
            const filteredOk = container && Array.from(container.children).some(c => c.textContent.toLowerCase().includes('sc'));
            addTerminalLine(`[測試結果] 空輸入建議顯示:${emptyOk}、打字自動篩選:${filteredOk}`, filteredOk && emptyOk ? 'success' : 'error');
            // 點擊第一個建議模擬
            if (container && container.children[0]) {
                const s = container.children[0].textContent.trim();
                onSuggestionClick(s);
                addTerminalLine(`[測試] 已點擊建議: ${s}`,'info');
            }
        }

        // 驗證購買並部署裝備
        function testBuyAndDeploy(equipId='super_computer') {
            addTerminalLine('[測試] 開始購買並部署裝備測試', 'info');
            GameState.currentRole = 'law_enforcement';
            const le = GameState.playerData.law_enforcement;
            const origBudget = le.budget;
            // 確保有足夠預算
            le.budget = Math.max(le.budget, 1000000);
            buyEquipment(equipId);
            const purchased = le.purchasedEquip.includes(equipId);
            if (!purchased) { addTerminalLine('[測試結果] 購買失敗', 'error'); return false; }
            equipItem(equipId);
            const deployed = le.deployedEquip.includes(equipId);
            const effectSeen = (equipId === 'city_surveillance') ? le.identityLockProgress >= 20 : (equipId === 'super_computer') ? (le.investigationSpeedBoost || 0) >= 50 : true;
            addTerminalLine(`[測試結果] 購買:${purchased} 部署:${deployed} 效果:${effectSeen ? 'Yes' : 'No'}`, (purchased && deployed && effectSeen) ? 'success' : 'error');
            // restore
            le.budget = origBudget;
            return purchased && deployed && effectSeen;
        }

            const commands = ['help','status','scan','attack','defend','monitor','forensics','crack','ddos','sqli','ip_tracking','open_shop','buy','equip','unequip','connect','disconnect'];
            const suggestions = [];

            // 推薦常用指令
            if (!query) {
                suggestions.push('help','status','open_shop','scan','monitor');
            } else {
                suggestions.push(...commands.filter(c => c.indexOf(query) === 0 || c.includes(query)).slice(0,8));
            }

            // 從工具庫補充推薦
            try {
                const role = GameState.currentRole;
                const tools = (GameState.playerData[role] && GameState.playerData[role].tools) || [];
                tools.forEach(t => { if (!suggestions.includes(t)) suggestions.push(t); });
            } catch(e) {}

            renderInputSuggestions(suggestions.slice(0,8));
        }

        function renderInputSuggestions(list) {
            const container = document.getElementById('input-suggestions');
            if (!container) return;
            container.innerHTML = list.map(s => `<button class="suggestion-btn" onclick="onSuggestionClick('${s.replace(/'/g, "\\'")}')">${s}</button>`).join(' ');
        }

        function onSuggestionClick(s) {
            const input = document.getElementById('terminal-input');
            if (!input) return;
            input.value = s;
            input.focus();
            // 常見指令直接執行
            const autoExec = ['help','status','open_shop','connect','disconnect'];
            if (autoExec.includes(s)) {
                executeCommand(s);
                input.value = '';
                updateInputSuggestions('');
            }
        }

        // ===== 自動化測試執行器 =====
        window.runAllTests = async function() {
            addTerminalLine('[測試] 開始自動化測試套件 (AI 模擬、輸入建議、購買部署)', 'info');
            const difficulties = ['rookie','professional','legendary'];
            const aiResults = {};
            for (const d of difficulties) {
                try {
                    aiResults[d] = await (typeof simulateAIBehavior === 'function' ? simulateAIBehavior({ difficulty: d, ticks: 60, tickInterval: 10 }) : Promise.resolve(null));
                } catch(e) {
                    addTerminalLine(`[測試錯誤] AI 模擬 (${d}) 發生例外: ${e.message}`, 'error');
                    aiResults[d] = null;
                }
            }

            try {
                if (typeof testInputSuggestions === 'function') testInputSuggestions();
            } catch(e) {
                addTerminalLine('[測試錯誤] 輸入建議測試發生例外: ' + e.message, 'error');
            }

            let buyDeployOk = false;
            try {
                if (typeof testBuyAndDeploy === 'function') buyDeployOk = !!testBuyAndDeploy('super_computer');
            } catch(e) {
                addTerminalLine('[測試錯誤] 購買並部署測試發生例外: ' + e.message, 'error');
            }

            addTerminalLine('[測試-總結] AI 模擬結果: ' + JSON.stringify(aiResults), 'info');
            addTerminalLine('[測試-總結] 購買並部署測試: ' + (buyDeployOk ? '成功' : '失敗'), buyDeployOk ? 'success' : 'error');
            addTerminalLine('[測試] 自動化測試套件執行完畢', 'success');
            return { aiResults, buyDeployOk };
        }

        // 自動執行一次（頁面載入後延遲觸發）
        if (!window.__autoTestsTriggered) {
            window.__autoTestsTriggered = true;
            setTimeout(() => {
                try {
                    if (typeof window.runAllTests === 'function') {
                        console.log('Auto-triggering runAllTests');
                        addTerminalLine && addTerminalLine('[自動測試] 自動觸發 runAllTests()', 'info');
                        window.runAllTests().then(r => {
                            console.log('AutoRunAllTests result', r);
                            addTerminalLine && addTerminalLine('[自動測試] 已完成', 'success');
                        }).catch(e => {
                            console.error('AutoRunAllTests error', e);
                            addTerminalLine && addTerminalLine('[自動測試] 自動執行失敗: ' + (e.message || e), 'error');
                        });
                    }
                } catch(e) { console.error('AutoRunAllTests trigger error', e); }
            }, 500);
        }

        function disconnectFromTarget() {
            GameState.connectionStatus = 'disconnected';
            addTerminalLine('[系統] 已斷開連接', 'warning');
            showNotification('連接已斷開', '已斷開與對手系統的連接', 'warning');
        }

        // ===== 特殊技能系統 =====
        function activateSpecialSkill(skillId) {
            const role = GameState.currentRole;
            const skill = GameState.specialSkills[role][skillId];
            
            if (!skill) {
                showNotification('技能錯誤', '無效的技能ID', 'warning');
                return;
            }
            
            const now = Date.now() / 1000;
            
            // 檢查冷卻時間
            if (skill.cooldown > 0 && now - skill.lastUsed < skill.cooldown) {
                const remaining = Math.ceil(skill.cooldown - (now - skill.lastUsed));
                showNotification('技能冷卻中', `還需 ${Math.floor(remaining/60)} 分鐘 ${remaining%60} 秒`, 'warning');
                return;
            }
            
            // 檢查一次性技能
            if (skillId === 'net_capture_order' && skill.used) {
                showNotification('技能已使用', '全網圍捕令只能使用一次', 'warning');
                return;
            }
            
            // 檢查資金
            const playerData = GameState.playerData[role];
            const costField = role === 'hacker' ? 'money' : 'budget';
            if (playerData[costField] < skill.cost) {
                showNotification('資金不足', `需要 $${skill.cost.toLocaleString()}`, 'warning');
                return;
            }
            
            // 扣除資金
            playerData[costField] -= skill.cost;
            
            // 執行技能效果
            executeSpecialSkill(skillId);
            
            // 更新冷卻時間
            skill.lastUsed = now;
            if (skillId === 'net_capture_order') skill.used = true;
            
            // 更新UI
            updateGameStats();
            addTerminalLine(`[特殊技能] ${skill.name} 已激活！`, 'success');
            addGameLog('system', `特殊技能 ${skill.name} 被使用`);
        }
        
        function executeSpecialSkill(skillId) {
            const role = GameState.currentRole;
            const opponentRole = role === 'hacker' ? 'law_enforcement' : 'hacker';
            const playerData = GameState.playerData[role];
            const opponentData = GameState.playerData[opponentRole];
            
            switch(skillId) {
                case 'digital_evaporation':
                    // 清除所有數碼足跡
                    playerData.digitalFootprints = 0;
                    playerData.stealth += 30;
                    // 清除已被追蹤的證據
                    opponentData.evidenceChain = opponentData.evidenceChain.filter(e => !e.tracked);
                    addTerminalLine('[數位蒸發] 所有數碼足跡已清除，隱蔽度大幅提升！', 'success');
                    break;
                    
                case 'evidence_pollution_wave':
                    // 大規模證據污染
                    const pollutionCount = Math.min(5, opponentData.evidenceChain.length);
                    for (let i = 0; i < pollutionCount; i++) {
                        if (opponentData.evidenceChain[i]) {
                            opponentData.evidenceChain[i].contaminated = true;
                            opponentData.evidenceChain[i].name += ' [已污染]';
                        }
                    }
                    addTerminalLine(`[證據污染波] 已污染 ${pollutionCount} 項關鍵證據！`, 'success');
                    break;
                    
                case 'channel_hijack':
                    // 發送虛假指令
                    addTerminalLine('[協作頻道劫持] 正在注入虛假指令到對方系統...', 'info');
                    setTimeout(() => {
                        opponentData.serverHealth -= 20;
                        opponentData.analysisToolsHealth -= 15;
                        addTerminalLine('[協作頻道劫持] 虛假指令已執行，對方系統混亂！', 'success');
                    }, 3000);
                    break;
                    
                case 'net_capture_order':
                    // 全網圍捕
                    playerData.networkSweepActive = true;
                    opponentData.stealth -= 40;
                    opponentData.activeVpnNodes = Math.max(0, opponentData.activeVpnNodes - 3);
                    addTerminalLine('[全網圍捕令] ISP已配合，匿名網絡大幅壓縮！', 'success');
                    break;
                    
                case 'time_trap':
                    // 時間陷阱
                    addTerminalLine('[時間陷阱] 正在部署蜜罐系統...', 'info');
                    setTimeout(() => {
                        if (opponentData.controlProgress > 30) {
                            opponentData.controlProgress -= 25;
                            playerData.investigationProgress += 30;
                            addTerminalLine('[時間陷阱] 黑客已上鉤！獲得大量攻擊情報。', 'success');
                        } else {
                            addTerminalLine('[時間陷阱] 黑客未上鉤，蜜罐系統待機。', 'info');
                        }
                    }, 5000);
                    break;
                    
                case 'physical_digital_raid':
                    // 同步突襲 (需要高身份鎖定)
                    if (opponentData.identityLock.physical >= 90) {
                        addTerminalLine('[物理-數位同步突襲] 正在協調實體抓捕隊伍...', 'info');
                        setTimeout(() => {
                            endGameWithAnimation('law_enforcement', '同步突襲成功：網路斷流與實體抓捕同時執行，黑客已被逮捕。');
                        }, 2000);
                    } else {
                        addTerminalLine('[物理-數位同步突襲] 身份鎖定不足，無法執行同步突襲。', 'warning');
                    }
                    break;
            }
        }

        // ===== 商店相關函數 =====
        function openHackerShop() {
            showNotification('黑客商店', '黑客專用工具商店已開啟', 'hacker');
            openShop();
        }

        function openLEShop() {
            showNotification('執法商店', '執法部門專用工具商店已開啟', 'law_enforcement');
            openShop();
        }

    // global tool version
    const TOOL_VERSION = '5.5.0';

    function openShop() {
            const shopModal = document.getElementById('shop-modal');
            if (!shopModal) return;
            const role = GameState.currentRole;
            
            // 定義角色特定的商店物品（每個工具皆標示版本）
            const shopItems = {
                law_enforcement: [
                    { id: 'firewall_pro', name: '企業級防火牆', price: 0, effect: '預設已購買 - 阻擋99%惡意流量', tier: 'premium', version: TOOL_VERSION },
                    { id: 'edm_system', name: '端點檢測與響應(EDR)', price: 0, effect: '預設已購買 - 實時威脅檢測和隔離', tier: 'premium', version: TOOL_VERSION },
                    { id: 'threat_intelligence', name: '威脅情報平台', price: 0, effect: '預設已購買 - 接收全球威脅數據', tier: 'premium', version: TOOL_VERSION },
                    { id: 'advanced_analytics', name: '大數據行為分析工具', price: 0, effect: '預設已購買 - AI驅動的異常檢測', tier: 'premium', version: TOOL_VERSION },
                    { id: 'forensics_toolkit', name: '數位鑑識實驗室系統', price: 0, effect: '預設已購買 - 含記憶體轉儲、硬碟映像驗證、網路封包重組等模組 (v' + TOOL_VERSION + ')', tier: 'premium', version: TOOL_VERSION, features: ['memory_dump','disk_verify','packet_reassembly','timeline_analysis','signature_verifier','legal_simulator','warrant_simulator'] },
                    { id: 'warrant_system', name: '搜索令申請系統 (模擬)', price: 0, effect: '模擬搜索令申請、法官批准進度與法律要件檢查', tier: 'premium', version: TOOL_VERSION },
                    { id: 'judge_approval_monitor', name: '法官批准進度系統', price: 0, effect: '追蹤搜索令與授權流程進度', tier: 'premium', version: TOOL_VERSION },
                    { id: 'legal_checklist_tool', name: '法律要件檢查清單', price: 0, effect: '協助檢查證據鏈與程序合規性', tier: 'premium', version: TOOL_VERSION },
                    { id: 'trial_readiness', name: '庭審準備度評估', price: 0, effect: '評估證據採納性與庭審準備狀態', tier: 'premium', version: TOOL_VERSION },
                    { id: 'drone_tracking', name: '無人機追蹤系統', price: 50000, effect: '追蹤目標物理位置 - 增加定位成功率50%', tier: 'advanced', version: TOOL_VERSION },
                    { id: 'satellite_imaging', name: '衛星影像掃描', price: 80000, effect: '實時衛星覆蓋 - 監控大範圍區域', tier: 'advanced', version: TOOL_VERSION }
                ],
                hacker: [
                    { id: 'basic_scanner', name: '基礎網絡掃描器', price: 0, effect: '預設已購買 - 基本端口掃描', tier: 'free', version: TOOL_VERSION },
                    { id: 'vuln_scanner', name: '漏洞掃描工具', price: 5000, effect: '自動檢測常見漏洞', tier: 'basic', version: TOOL_VERSION },
                    { id: 'proxy_chain', name: '多層代理鏈工具', price: 8000, effect: '隱蔽度+30%，增加追蹤難度', tier: 'intermediate', version: TOOL_VERSION },
                    { id: 'exploit_kit', name: '漏洞利用框架', price: 15000, effect: '包含50個常用漏洞利用', tier: 'advanced', version: TOOL_VERSION },
                    { id: 'malware_builder', name: '惡意軟體生成器', price: 25000, effect: '定制化勒索軟體和木馬', tier: 'advanced', version: TOOL_VERSION },
                    { id: 'ddos_botnet', name: 'DDoS 殭屍網絡訪問', price: 12000, effect: '每月租賃 - 控制10萬台設備', tier: 'advanced', version: TOOL_VERSION },
                    { id: 'ransomware_premium', name: '頂級勒索軟體變種', price: 35000, effect: '軍事級加密 + 雙層勒索機制', tier: 'elite', version: TOOL_VERSION }
                ]
            };
            
            const items = shopItems[role] || [];
            const player = GameState.playerData[role === 'hacker' ? 'hacker' : 'law_enforcement'];
            const budgetLabel = role === 'hacker' ? '金額' : '預算';
            const currentBalance = role === 'hacker' ? player.money : player.budget;
            
            let html = `
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 6px;">
                    <strong>當前${budgetLabel}: $${currentBalance}</strong>
                    <div style="font-size: 0.85rem; color: #999; margin-top: 5px;">
                        ${role === 'law_enforcement' 
                            ? '✓ 大部分工具預設已購買，無需額外費用' 
                            : '⚠️ 大多數工具需要購買，請量入為出'}
                    </div>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
            `;
            
            items.forEach(item => {
                const canAfford = currentBalance >= item.price;
                const statusColor = item.price === 0 ? '#00ff41' : (canAfford ? '#4a90d9' : '#ff3333');
                const statusText = item.price === 0 ? '已擁有' : (canAfford ? '可購買' : '資金不足');

                html += `
                    <div style="padding: 12px; border: 1px solid ${statusColor}; margin: 8px 0; border-radius: 4px; background: rgba(0,0,0,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <strong style="color: ${statusColor};">${item.name}</strong>
                                <div style="color: #999; font-size: 0.9rem; margin-top: 5px;">${item.effect}</div>
                            </div>
                            <div style="text-align: right;">
                                ${item.price > 0 ? `<div style="color: #ffff00; font-weight: bold;">$${item.price}</div>` : '<div style="color: #00ff41;">FREE</div>'}
                                <div style="color: ${statusColor}; font-size: 0.85rem; margin-top: 5px;">${statusText}</div>
                            </div>
                        </div>
                        ${item.price > 0 ? `<button class="btn btn-primary" onclick="buyItem('${item.id}', ${item.price})" style="margin-top: 10px; width: 100%; padding: 8px; ${!canAfford ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${!canAfford ? 'disabled' : ''}>購買</button>` : ''}
                        ${item.id === 'vuln_scanner' ? `<button class="btn btn-success" onclick="autoDetectVulnerabilities('${item.id}')" style="margin-top: 8px; width: 100%; padding: 8px;">啟動自動檢測</button>` : ''}
                        ${item.id === 'forensics_toolkit' ? `<button class="btn btn-warning" onclick="openForensicsLab()" style="margin-top: 8px; width: 100%; padding: 8px;">開啟數位鑑識實驗室</button>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('shop-message').innerHTML = html;
            shopModal.classList.add('active');
            
            // 添加日誌
            addTerminalLine(`[${new Date().toLocaleTimeString('zh-TW')}] [商店] ${role === 'hacker' ? '黑客' : '執法部門'}商店已打開`, 'info');
        }

    // Delegate generic buy action to ShopSystem
    function buyItem(itemId, price) { ShopSystem.buy(itemId, price); }

        function openTransactionHistory() {
            const historyModal = document.getElementById('history-modal');
            if (!historyModal) return;
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            if (GameState.transactionHistory.length === 0) {
                html += '<p>暫無交易記錄</p>';
            } else {
                GameState.transactionHistory.forEach(trans => {
                    html += `<div style="padding: 10px; border-bottom: 1px solid #333;">
                        <strong>${trans.type}</strong> - ${trans.amount}<br>
                        <small>${trans.time}</small>
                    </div>`;
                });
            }
            html += '</div>';
            document.getElementById('history-message').innerHTML = html;
            historyModal.classList.add('active');
        }

        // ===== 暫停遊戲 =====
        function pauseGame() {
            GameState.gameActive = false;
            showNotification('遊戲已暫停', '遊戲已暫停，點擊恢復按鈕繼續', 'warning');
        }

        // ===== 自動檢測（漏洞掃描）功能 =====
        function autoDetectVulnerabilities(itemId) {
            // Safe guards: ensure GameState and player ownership checks exist
            try {
                const role = GameState.currentRole || 'hacker';
                const player = GameState.playerData ? (role === 'hacker' ? GameState.playerData.hacker : GameState.playerData.law_enforcement) : null;

                // If player data not available, just simulate and log
                if (!player) {
                    addTerminalLine('[自動檢測] 找不到玩家狀態，執行模擬掃描...', 'warning');
                    simulateScan();
                    return;
                }

                const owns = player.inventory && player.inventory.includes(itemId) || (player.ownedItems && player.ownedItems.includes(itemId));
                if (!owns && (player.money || player.budget) !== undefined) {
                    // If not owned, but free item (price 0), allow; otherwise prompt purchase
                    const isFree = (function() {
                        try {
                            // attempt to find item in local shop definition
                            return false; // default: force purchase requirement if not owned
                        } catch (e) { return false; }
                    })();
                    if (!isFree) {
                        showNotification('需要購買', '請先在商店購買漏洞掃描工具，然後再啟動自動檢測', 'warning');
                        addTerminalLine('[自動檢測] 嘗試啟動失敗：尚未購買漏洞掃描工具', 'error');
                        return;
                    }
                }

                // Start simulated scan UI/progress
                showNotification('自動檢測啟動', '漏洞自動檢測已啟動，請稍候...', 'law_enforcement');
                addTerminalLine(`[${new Date().toLocaleTimeString('zh-TW')}] [自動檢測] 已啟動漏洞掃描`, 'command');
                simulateScan();

            } catch (err) {
                console.error('autoDetectVulnerabilities error', err);
                addTerminalLine('[自動檢測] 發生錯誤，請查看控制台', 'error');
            }
        }

        function simulateScan() {
            // create a temporary modal-like progress inside shop-message if available
            const container = document.getElementById('shop-message') || document.body;
            const progressId = 'auto-detect-progress';
            const existing = document.getElementById(progressId);
            if (existing) return; // already running

            const progressWrap = document.createElement('div');
            progressWrap.id = progressId;
            progressWrap.style.padding = '12px';
            progressWrap.style.marginTop = '10px';
            progressWrap.style.background = 'rgba(0,0,0,0.4)';
            progressWrap.style.border = '1px solid #4a90d9';
            progressWrap.style.borderRadius = '6px';

            progressWrap.innerHTML = `
                <div style="color:#4a90d9; font-weight:bold; margin-bottom:8px;">自動檢測進行中...</div>
                <div class="progress-bar-container"><div class="progress-bar-fill" id="auto-detect-fill" style="width:0%"></div></div>
                <div id="auto-detect-log" style="color:#ccc; margin-top:8px; font-size:0.9rem; max-height:120px; overflow:auto;"></div>
            `;

            container.appendChild(progressWrap);

            const fill = document.getElementById('auto-detect-fill');
            const log = document.getElementById('auto-detect-log');
            let pct = 0;
            const interval = setInterval(() => {
                pct += Math.floor(Math.random() * 15) + 5;
                if (pct > 100) pct = 100;
                if (fill) fill.style.width = pct + '%';
                if (log) {
                    const line = document.createElement('div');
                    line.textContent = `[${new Date().toLocaleTimeString('zh-TW')}] 掃描進度 ${pct}%`;
                    log.appendChild(line);
                    log.scrollTop = log.scrollHeight;
                }
                addTerminalLine(`[自動檢測] 進度 ${pct}%`, 'system');
                if (pct >= 100) {
                    clearInterval(interval);
                    if (log) {
                        const res = document.createElement('div');
                        res.style.color = '#00ff41';
                        res.textContent = `[${new Date().toLocaleTimeString('zh-TW')}] 掃描完成：發現數個低危漏洞並生成報告。`;
                        log.appendChild(res);
                        log.scrollTop = log.scrollHeight;
                    }
                    addTerminalLine('[自動檢測] 掃描完成，報告已輸出', 'success');
                    showNotification('掃描完成', '自動檢測已完成，請查看報告', 'law_enforcement');
                    // remove progress after short delay
                    setTimeout(() => { try { progressWrap.remove(); } catch(e){} }, 5000);
                }
            }, 800);
        }

        // ensure addTerminalLine and showNotification exist; if not, provide simple fallbacks
        if (typeof addTerminalLine !== 'function') {
            window.addTerminalLine = function(msg, cls) { console.log('[TERM]', cls || '', msg); };
        }

        if (typeof showNotification !== 'function') {
            window.showNotification = function(title, message, type) { console.log('[NOTIF]', title, message, type); };
        }

        // ===== 顯示操作指南 =====
        function showGuide() {
            showGuideFullPage();
        }

        // ===== 暗網聯絡站 =====
        function openDarknetHub() {
            showPage('darknet-hub-page');
            GameState.currentPage = 'darknet';
            updateNavActive();
        }

        // --- 暗網聯絡站邏輯 ---
        let currentDarknetChannel = 'global';
        const darknetBots = [
            { name: 'Ghost_Zero', style: 'cautious' },
            { name: 'Crypto_Queen', style: 'technical' },
            { name: 'Root_Access', style: 'aggressive' },
            { name: 'Anon_Shadow', style: 'mysterious' }
        ];

        function switchDarknetChannel(channel) {
            currentDarknetChannel = channel;
            document.querySelectorAll('.darknet-contact-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const chatMessages = document.getElementById('darknet-chat-messages');
            chatMessages.innerHTML = `<div class="chat-msg"><span class="chat-time">${new Date().toLocaleTimeString()}</span><span class="chat-user" style="color: #ff00ff;">[System]</span><span class="chat-text">已切換至頻道: #${channel}</span></div>`;
            
            if (channel === 'mixer') {
                addDarknetMessage('System', '歡迎使用門羅幣混幣器。請輸入您要洗白的金額。手續費 10%。', '#ff00ff');
            } else if (channel === 'intel') {
                addDarknetMessage('System', '情報交易中心：在這裡您可以購買執法部門的絕密情報。', '#ff00ff');
            }
        }

        function sendDarknetMessage() {
            const input = document.getElementById('darknet-user-input');
            const text = input.value.trim();
            if (!text) return;

            addDarknetMessage('You', text, '#00ff41');
            input.value = '';

            // 模擬 AI 回覆
            setTimeout(() => {
                const bot = darknetBots[Math.floor(Math.random() * darknetBots.length)];
                const responses = [
                    "聽起來很有趣，但我現在正忙著滲透一個數據中心。",
                    "你有沒有試過用新的零日漏洞？我這裡有貨。",
                    "執法部門最近盯得很緊，大家小心點。",
                    "誰有最新的執法部門 IP 名單？我願意出高價。",
                    "剛完成一筆大單，準備去混幣器洗一下。"
                ];
                addDarknetMessage(bot.name, responses[Math.floor(Math.random() * responses.length)]);
            }, 1500);
        }

        function addDarknetMessage(user, text, color = '#fff') {
            const chatMessages = document.getElementById('darknet-chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-msg';
            msgDiv.innerHTML = `
                <span class="chat-time">${new Date().toLocaleTimeString()}</span>
                <span class="chat-user" style="color: ${color}">${user}</span>
                <span class="chat-text">${text}</span>
            `;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function buyDarknetService(serviceId, cost) {
            const hacker = GameState.playerData.hacker;
            if (hacker.money < cost) {
                showNotification('資金不足', `需要 $${cost.toLocaleString()} 才能購買此服務。`, 'warning');
                return;
            }

            hacker.money -= cost;
            updateGameStats();

            switch(serviceId) {
                case 'le_intel':
                    GameState.playerData.law_enforcement.investigationProgress = Math.max(0, GameState.playerData.law_enforcement.investigationProgress - 15);
                    addTerminalLine('[暗網] 購買情報成功：已干擾執法部門的調查進度。', 'success');
                    addDarknetMessage('System', '情報已送達：執法部門的調查方向已被誤導。', '#ff00ff');
                    break;
                case 'zero_day':
                    hacker.controlProgress = Math.min(100, hacker.controlProgress + 25);
                    addTerminalLine('[暗網] 購買零日漏洞成功：系統控制權大幅提升。', 'success');
                    addDarknetMessage('System', '漏洞利用程式已下載，正在注入目標系統...', '#ff00ff');
                    break;
                case 'hire_distraction':
                    document.getElementById('hired-status').innerHTML = '<span style="color: #00ff41;">活躍中: 誘餌攻擊執行中</span>';
                    GameState.playerData.law_enforcement.serverHealth -= 20;
                    setTimeout(() => {
                        document.getElementById('hired-status').innerText = '目前無活躍僱傭任務';
                    }, 30000);
                    addTerminalLine('[暗網] 僱傭成功：其他黑客正在發動誘餌攻擊分散執法部門注意力。', 'success');
                    break;
            }
        }

        function startMoneyLaundering() {
            const hacker = GameState.playerData.hacker;
            if (hacker.money < 1000) {
                showNotification('金額太小', '混幣器至少需要 $1,000 才能運作。', 'warning');
                return;
            }

            openStepModal('門羅幣混幣器 (XMR Mixer)', [
                { name: '存入非法資金', type: 'progress', duration: 2000 },
                { name: '多重地址跳轉', type: 'progress', duration: 4000 },
                { name: '混入合法流量', type: 'progress', duration: 3000 },
                { name: '提取乾淨資金', type: 'result', content: '洗錢完成！資金已轉入您的安全帳戶。' }
            ], (data) => {
                const fee = Math.floor(hacker.money * 0.1);
                const cleanMoney = hacker.money - fee;
                addTerminalLine(`[洗錢] 成功洗白 $${hacker.money.toLocaleString()}，扣除手續費 $${fee.toLocaleString()}。`, 'success');
                hacker.stealth = Math.min(100, hacker.stealth + 10);
                updateGameStats();
            });
        }

        // ===== 操作指南 =====
        function showGuideFullPage() {
            showPage('guide-page');
            GameState.currentPage = 'guide';
            updateNavActive();
        }

        // ===== 優化商店 =====
        function openShopFullPage() {
            showPage('shop-page');
            GameState.currentPage = 'shop';
            updateNavActive();
            populateShopItems();
        }

        function populateShopItems() {
            const shopDisplay = document.getElementById('shop-items-display');
            if (!shopDisplay) return;

            const shopItems = [
                { id: 'nmap', name: 'Nmap 掃描器', icon: 'fa-search', desc: '高級網路掃描工具', price: 5000, category: 'tools' },
                { id: 'metasploit', name: 'Metasploit 框架', icon: 'fa-bomb', desc: '漏洞利用框架', price: 8000, category: 'tools' },
                { id: 'wireshark', name: 'Wireshark', icon: 'fa-wifi', desc: '網路流量分析工具', price: 4000, category: 'tools' },
                { id: 'burp', name: 'Burp Suite', icon: 'fa-shield-alt', desc: 'Web 應用測試工具', price: 6000, category: 'tools' },
                { id: 'vpn_pro', name: 'VPN Pro 升級', icon: 'fa-lock', desc: '軍用級加密 VPN', price: 3000, category: 'upgrades' },
                { id: 'proxy_net', name: '代理網路升級', icon: 'fa-network-wired', desc: '多層代理網路', price: 4500, category: 'upgrades' },
                { id: 'encryption', name: '加密升級', icon: 'fa-key', desc: '增強數據加密', price: 2500, category: 'upgrades' },
                { id: 'firewall', name: '防火牆升級', icon: 'fa-fire', desc: '高級防火牆系統', price: 5500, category: 'upgrades' },
                { id: 'ddos_service', name: 'DDoS 服務', icon: 'fa-bolt', desc: '租用 DDoS 攻擊', price: 10000, category: 'services' },
                { id: 'intel_service', name: '情報服務', icon: 'fa-eye', desc: '購買情報信息', price: 7000, category: 'services' },
                { id: 'premium_tools', name: '高級工具包', icon: 'fa-star', desc: '所有高級工具', price: 25000, category: 'premium' },
                { id: 'elite_access', name: '精英訪問權限', icon: 'fa-crown', desc: '解鎖所有功能', price: 50000, category: 'premium' },
                { id: 'hardware_spoof', name: '硬體指紋偽造器', icon: 'fa-microchip', desc: '偽造設備底層標識符', price: 15000, category: 'premium' },
                { id: 'memory_attack', name: '記憶體無檔案攻擊套件', icon: 'fa-memory', desc: '不留痕跡的記憶體注入', price: 20000, category: 'premium' },
                { id: 'zero_day', name: '零日漏洞利用', icon: 'fa-bug', desc: '利用未公開的高級漏洞', price: 35000, category: 'premium' }
            ];

            let html = '';
            shopItems.forEach(item => {
                html += `
                    <div class="shop-item-full">
                        <div class="shop-item-icon-full"><i class="fas ${item.icon}"></i></div>
                        <div class="shop-item-name-full">${item.name}</div>
                        <div class="shop-item-desc-full">${item.desc}</div>
                        <div class="shop-item-price-full">$${item.price.toLocaleString()}</div>
                        <button class="shop-item-buy-btn" onclick="buyShopItem('${item.id}', ${item.price})">
                            <i class="fas fa-shopping-cart"></i> 購買
                        </button>
                    </div>
                `;
            });

            shopDisplay.innerHTML = html;
        }

        function filterShopItems(category) {
            // 更新分類按鈕狀態
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 這裡可以添加實際的過濾邏輯
            showNotification('過濾', `已切換到 ${category} 分類`, 'info');
        }

    // Delegate purchases to the unified ShopSystem
    function buyShopItem(itemId, price) { ShopSystem.buy(itemId, price); }

        // ===== 更新導航活動狀態 =====
        function updateNavActiveExtended() {
            const navItems = document.querySelectorAll('.nav-menu li a, .nav-menu-mobile li a');
            navItems.forEach(item => item.classList.remove('active'));
            
            switch(GameState.currentPage) {
                case 'main':
                    document.getElementById('nav-home')?.classList.add('active');
                    document.getElementById('nav-home-mobile')?.classList.add('active');
                    break;
                case 'setup':
                    document.getElementById('nav-season2')?.classList.add('active');
                    document.getElementById('nav-season2-mobile')?.classList.add('active');
                    break;
                case 'battlemap':
                    document.getElementById('nav-battlemap')?.classList.add('active');
                    document.getElementById('nav-battlemap-mobile')?.classList.add('active');
                    break;
                case 'guide':
                    document.getElementById('nav-guide')?.classList.add('active');
                    document.getElementById('nav-guide-mobile')?.classList.add('active');
                    break;
                case 'darknet':
                    document.getElementById('nav-darknet-mobile')?.classList.add('active');
                    break;
                case 'shop':
                    document.getElementById('nav-shop')?.classList.add('active');
                    document.getElementById('nav-shop-mobile')?.classList.add('active');
                    break;
                case 'game':
                    document.getElementById('nav-season2')?.classList.add('active');
                    document.getElementById('nav-season2-mobile')?.classList.add('active');
                    break;
            }
        }

        // 覆蓋原有的 updateNavActive 函數
        const originalUpdateNavActive = updateNavActive;
        updateNavActive = function() {
            originalUpdateNavActive();
            updateNavActiveExtended();
        };


        // ===== 初始化函數（缺失的） =====
        function initializeSkillTree() {
            addGameLog('system', '技能樹系統已初始化');
        }

        function initializeEquipmentSystem() {
            addGameLog('system', '裝備系統已初始化');
        }

        function initializeAutoSave() {
            GameState.autoSaveInterval = setInterval(() => {
                localStorage.setItem('gameState', JSON.stringify(GameState));
                GameState.lastSaveTime = new Date();
            }, 30000);
        }

        function initializeEvidenceIntegrity() {
            addGameLog('system', '證據完整性驗證系統已初始化');
        }

        // ===== 動態情報生成 =====
        function generateDynamicIntel() {
            const le = GameState.playerData.law_enforcement;
            for (let i = 0; i < 5; i++) {
                const intelTypes = GameState.intelTypes;
                const randomIntel = intelTypes[Math.floor(Math.random() * intelTypes.length)];
                le.dynamicIntel.push(randomIntel);
            }
            addGameLog('system', '動態情報已生成');
        }

        // ===== 更新特殊面板 =====
        function updateSpecialPanel() {
            const specialPanel = document.getElementById('special-panel');
            if (!specialPanel) return;
            
            if (GameState.currentRole === 'hacker') {
                specialPanel.innerHTML = '<div style="color: #00ff41; padding: 10px;">黑客專用面板 - 隱蔽度/足跡管理</div>';
            } else {
                specialPanel.innerHTML = '<div style="color: #4a90d9; padding: 10px;">執法部門專用面板 - 證據/身份鎖定</div>';
            }
        }
    
        
        // ===== 深度優化邏輯 =====
        
        // 1. 角色平衡設定
        function applyRoleBalance() {
            const role = GameState.currentRole;
            if (role === 'law_enforcement') {
                // 執法部門：預設解鎖大部分工具，費用極低
                Object.keys(GameState.tools.law_enforcement).forEach(cat => {
                    GameState.tools.law_enforcement[cat].forEach(tool => {
                        tool.cost = Math.floor(tool.cost * 0.1); // 費用降至 10%
                        tool.unlocked = true;
                    });
                });
                addTerminalLine('[系統] 執法部門權限已激活：所有工具預設解鎖，預算消耗最小化。', 'success');
            } else {
                // 黑客：小部分解鎖，其餘需課金
                Object.keys(GameState.tools.hacker).forEach(cat => {
                    GameState.tools.hacker[cat].forEach((tool, index) => {
                        if (index > 1) tool.unlocked = false; // 每個分類只解鎖前兩個
                        else tool.unlocked = true;
                    });
                });
                addTerminalLine('[系統] 黑客模式：部分高級工具需透過暗網商店解鎖。', 'warning');
            }
        }

        // 2. 設備資訊更新
        function updateDeviceSpecs() {
            const role = GameState.currentRole;
            const specsContainer = document.getElementById('my-device-specs');
            if (!specsContainer) return;

            const specs = role === 'hacker' ? {
                os: 'Kali Linux v2024.1',
                cpu: 'AMD Ryzen 9 7950X (16 Cores)',
                ram: '64GB DDR5 6000MHz',
                gpu: 'RTX 4090 24GB (Hash Cracking)',
                net: '10Gbps Fiber (Encrypted VPN)',
                status: '隱蔽中'
            } : {
                os: 'Windows 11 Enterprise (LE Edition)',
                cpu: 'Dual Intel Xeon Platinum 8480+',
                ram: '256GB ECC Registered',
                gpu: 'NVIDIA A100 80GB (AI Analysis)',
                net: 'Gov-Net Dedicated (Fiber)',
                status: '監控中'
            };

            specsContainer.innerHTML = `
                <div class="spec-row"><span>作業系統</span><span>${specs.os}</span></div>
                <div class="spec-row"><span>處理器</span><span>${specs.cpu}</span></div>
                <div class="spec-row"><span>記憶體</span><span>${specs.ram}</span></div>
                <div class="spec-row"><span>顯示卡</span><span>${specs.gpu}</span></div>
                <div class="spec-row"><span>網絡連接</span><span>${specs.net}</span></div>
                <div class="spec-row"><span>當前狀態</span><span style="color:#00ff41">${specs.status}</span></div>
            `;

            // after render, run verification for role tools
            try { verifyRoleToolsApplied(); } catch(e) { console.warn('verifyRoleToolsApplied missing', e); }
        }

        // Verify that each role's tools from GameState are present in the UI
        function verifyRoleToolsApplied() {
            const missing = { hacker: [], law_enforcement: [] };
            try {
                const hackerTools = GameState.playerData.hacker.tools || [];
                const leTools = GameState.playerData.law_enforcement.tools || [];
                // helper to check DOM for tool ids in tools-grid
                function domHasTool(id) {
                    return !!document.querySelector(`#tools-grid .tool-card[data-tool-id="${id}"]`);
                }
                hackerTools.forEach(t => { if (!domHasTool(t)) missing.hacker.push(t); });
                leTools.forEach(t => { if (!domHasTool(t)) missing.law_enforcement.push(t); });
            } catch(e) {
                console.warn('verifyRoleToolsApplied error', e);
            }
            console.group('Role Tools Verification');
            console.log('Hacker missing tools:', missing.hacker);
            console.log('Law Enforcement missing tools:', missing.law_enforcement);
            console.groupEnd();
            // If missing, show a brief in-UI toast
            if ((missing.hacker && missing.hacker.length) || (missing.law_enforcement && missing.law_enforcement.length)) {
                showNotification('工具同步問題', '偵測到部分角色專屬工具尚未渲染，請查看 console 以取得詳情', 'warning');
            }
        }

        // 3. 網絡監控模擬
        let trafficData = Array(30).fill(0);
        function updateNetworkMonitor() {
            const uploadEl = document.getElementById('upload-speed');
            const downloadEl = document.getElementById('download-speed');
            const chartContainer = document.getElementById('traffic-chart');
            const sniffer = document.getElementById('packet-sniffer');

            if (!chartContainer) return;

            // 模擬速度
            const up = Math.floor(Math.random() * 500) + 50;
            const down = Math.floor(Math.random() * 2000) + 200;
            if (uploadEl) uploadEl.innerText = up + ' KB/s';
            if (downloadEl) downloadEl.innerText = down + ' KB/s';

            // 更新圖表
            trafficData.shift();
            trafficData.push(Math.min(100, (up + down) / 25));
            chartContainer.innerHTML = trafficData.map(h => `<div class="traffic-bar" style="height: ${h}%"></div>`).join('');

            // 模擬封包
            if (Math.random() > 0.7) {
                const protocols = ['TCP', 'UDP', 'HTTP', 'HTTPS', 'SSH', 'DNS'];
                const proto = protocols[Math.floor(Math.random() * protocols.length)];
                const src = '192.168.' + Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255);
                const dst = GameState.opponentIP;
                const isAlert = Math.random() > 0.9;
                
                const line = document.createElement('div');
                line.className = 'packet-line' + (isAlert ? ' packet-alert' : (Math.random() > 0.5 ? ' packet-in' : ' packet-out'));
                line.innerText = `[${new Date().toLocaleTimeString()}] ${proto} ${src} -> ${dst} ${isAlert ? '!!! THREAT DETECTED !!!' : 'LEN=' + Math.floor(Math.random() * 1500)}`;
                
                sniffer.appendChild(line);
                sniffer.scrollTop = sniffer.scrollHeight;
                if (sniffer.childNodes.length > 50) sniffer.removeChild(sniffer.firstChild);
                
                // 如果有威脅，更新安全狀態
                if (isAlert) {
                    const badge = document.getElementById('my-security-status');
                    if (badge) {
                        badge.innerText = '危險';
                        badge.className = 'security-status-badge status-danger';
                        setTimeout(() => {
                            badge.innerText = '安全';
                            badge.className = 'security-status-badge status-safe';
                        }, 5000);
                    }
                }
            }
        }

        // 4. 瀏覽器實況模擬
        function updateBrowserPreview() {
            const preview = document.getElementById('browser-preview');
            if (!preview) return;

            const hackerSites = ['https://dark-forum.onion', 'https://crypto-mixer.io', 'https://exploit-db.com', 'https://github.com/hacker/tools'];
            const leSites = ['https://le-command.gov', 'https://interpol.int/database', 'https://fbi.gov/wanted', 'https://cctv-monitor.local'];
            
            const sites = GameState.currentRole === 'hacker' ? hackerSites : leSites;
            const currentSite = sites[Math.floor(Math.random() * sites.length)];

            if (Math.random() > 0.8) {
                preview.innerHTML = `
                    <div style="width:100%; padding:10px; font-size:0.65rem;">
                        <div style="background:#333; padding:2px 5px; margin-bottom:5px; border-radius:3px;">URL: ${currentSite}</div>
                        <div style="height:60px; border:1px dashed #444; display:flex; align-items:center; justify-content:center;">
                            [ 頁面內容加載中... ]
                        </div>
                    </div>
                `;
            }
        }

        // 整合到 initializeGameUI 的後續處理
        const originalInitializeGameUI = initializeGameUI;
        initializeGameUI = function() {
            originalInitializeGameUI();
            applyRoleBalance();
            updateDeviceSpecs();
            setInterval(updateNetworkMonitor, 1000);
            setInterval(updateBrowserPreview, 3000);
        };
    
        // ===== 擴充功能邏輯 =====
        GameState.attackMode = 'zombie';
        
        function changeAttackMode(mode) {
            GameState.attackMode = mode;
            const modes = {
                zombie: '直接殭屍化攻擊',
                step_by_step: '循序漸進',
                ransom: '要求勒索金',
                worm: '自動化蠕蟲'
            };
            addTerminalLine('[系統] 攻擊模式已切換為: ' + modes[mode], 'warning');
            showNotification('模式切換', '當前模式: ' + modes[mode], 'info');
        }

        function openUpgradeSystem() {
            if (GameState.currentRole === 'hacker') openHackerShop();
            else openLEShop();
            showNotification('課金系統', '歡迎來到裝備升級中心', 'success');
        }

        function quickAction(actionId, btnElement) {
            if (!GameState.gameActive) {
                showNotification('遊戲未開始', '請先連接到目標', 'warning');
                addTerminalLine('[錯誤] 遊戲未開始，無法執行快捷功能', 'error');
                return;
            }

            const role = GameState.currentRole;
            
            // 權限攔截邏輯
            const hackerOnly = ['one_click_attack', 'auto_attack', 'direct_attack', 'progressive_attack', 'zombie_attack', 'signal_jammer', 'emergency_erase', 'encrypt_file', 'decrypt_file', 'honeypot_gen', 'darknet_hub'];
            const leOnly = ['case_details', 'case_report', 'inter_dept_report', 'target_intel', 'encryption_analysis', 'behavior_analysis', 'instant_tracker', 'vuln_scanner', 'timeline_analyzer', 'social_network_analysis', 'geoip_mapping', 'tls_decode', 'threat_intel_panel', 'cve_lookup', 'sandbox_analyze', 'ai_attack_match', 'open_forensics', 'open_warrant', 'gen_summary', 'forensic_toolkit', 'chain_of_custody', 'legal_doc_gen', 'witness_mgmt', 'case_management', 'task_dispatch', 'timeline_viz', 'report_template'];
            
            if (hackerOnly.includes(actionId) && role !== 'hacker') {
                showNotification('權限不足', '此功能僅限黑客使用', 'error');
                if (btnElement) {
                    btnElement.classList.add('error');
                    setTimeout(() => btnElement.classList.remove('error'), 1000);
                }
                return;
            }
            
            if (leOnly.includes(actionId) && role !== 'law_enforcement') {
                showNotification('權限不足', '此功能僅限執法部門使用', 'error');
                if (btnElement) {
                    btnElement.classList.add('error');
                    setTimeout(() => btnElement.classList.remove('error'), 1000);
                }
                return;
            }

            // 視覺回饋
            if (btnElement) {
                btnElement.classList.add('executing');
                btnElement.style.transform = 'scale(1.05)';
            }
            
            addTerminalLine('[執行] 啟動快捷功能: ' + actionId, 'command');
            
            // 添加快捷功能的詳細描述
            const actionDescriptions = {
                'one_click_attack': '一鍵式攻擊 - 自動掃描並發動全面攻擊',
                'auto_attack': '自動化攻擊 - 已預設基本攻擊設定',
                'direct_attack': '直接攻擊 - 直接癱瘓目標伺服器或裝置',
                'progressive_attack': '循序漸進攻擊 - 一步一步攻擊目標裝置',
                'zombie_attack': '殭屍級攻擊 - 控制大量被感染病毒的設備',
                'signal_jammer': '信號幹擾器 - 幹擾目標的網絡或接收訊號',
                'emergency_erase': '緊急快速清除痕跡 - 清除所有網絡足跡及活動',
                'case_details': '案件詳細資料 - 查看詳細案件信息',
                'case_report': '案件詳細回報 - 生成和提交案件回報',
                'inter_dept_report': '跨部門協作進度報告 - 查看部門協作進度',
                'scan_target': '掃描目標 - 收集目標系統信息',
                'crack_password': '破解密碼 - 嘗試破解目標密碼',
                'vpn_protection': 'VPN 保障 - 使用不同強度VPN選擇',
                'encrypt_file': '加密文件 - 加密本地敏感文件',
                'decrypt_file': '解密文件 - 解密加密的文件',
                'honeypot_gen': '誘捕網絡生成器 - 用來主動製造假目標、誤導追蹤者',
                'target_intel': '目標情報 - 獲取目標詳細信息',
                'antivirus': '防毒掃毒 - 掃描並清除病毒',
                'device_status': '裝置詳細狀態 - 查看系統詳細狀態',
                'ip_tracking': 'IP追蹤系統 - 追蹤目標IP位置',
                'traffic_analysis': '流量監聽分析儀 - 分析網絡流量',
                'reverse_injection': '反向注入 - 被攻擊的設備主動連接到攻擊者的技術',
                'darknet_hub': '暗網中介聯絡站 - 連接暗網市場',
                'encryption_analysis': '高級數據加密分析工具 - 分析加密算法與破解點',
                'behavior_analysis': '智能行為分析系統 - AI預測攻擊行為與時間',
                'instant_tracker': '瞬時網絡追蹤器 - 追蹤目標真實地理位置',
                'vuln_scanner': '跨平台漏洞掃描器 - 掃描系統漏洞與CVE',
                'timeline_analyzer': '時間軸分析器 - 關聯事件的時間順序和因果關係',
                'social_network_analysis': '社交網絡分析 - 分析目標的社交關係網絡',
                'geoip_mapping': '地理定位追蹤 - 地圖上追蹤IP地址位置',
                'tls_decode': '加密流量解碼模擬 - 分析和模擬TLS/SSL加密解碼',
                'threat_intel_panel': '實時威脅情報面板 - 實時顯示網絡威脅信息',
                'cve_lookup': 'CVE查詢 - 查詢已知的漏洞數據庫',
                'sandbox_analyze': '惡意軟體沙箱 - 在隔離環境中分析惡意軟體',
                'ai_attack_match': 'AI攻擊模式匹配 - 使用AI識別已知攻擊模式',
                'open_forensics': '數位鑑識室 - 打開數位鑑識分析工具',
                'open_warrant': '搜索令系統 - 打開法律搜索令申請系統',
                'gen_summary': '產生執法摘要 - 生成案件執法摘要報告',
                'forensic_toolkit': '數位鑑識工具套件 - 硬碟映像、記憶體轉儲分析',
                'chain_of_custody': '取證鏈管理系統 - 證據監管鏈記錄',
                'legal_doc_gen': '法律文書生成器 - 搜索令、法院文件自動生成',
                'witness_mgmt': '證人/線人管理系統 - 管理證人訊息和線人資料',
                'case_management': '案件管理系統 - 案件編號、優先級分配和進度跟蹤',
                'task_dispatch': '任務分派機制 - 為團隊成員分派和管理調查任務',
                'timeline_viz': '調查時間線視覺化 - 甘特圖式進度追蹤和事件關聯',
                'report_template': '報告模板庫 - 標準調查報告格式和自動生成'
            };
            const desc = actionDescriptions[actionId] || '執行快捷功能';
            addTerminalLine(`[說明] ${desc}`, 'info');

            // 模擬執行延遲以提供視覺回饋
            setTimeout(() => {
                try {
                    switch(actionId) {
                        case 'one_click_attack':
                            executeOneClickAttack();
                            break;
                        case 'auto_attack':
                            executeAutoAttack();
                            break;
                        case 'direct_attack':
                            executeDirectAttack();
                            break;
                        case 'progressive_attack':
                            executeProgressiveAttack();
                            break;
                        case 'zombie_attack':
                            executeZombieAttack();
                            break;
                        case 'signal_jammer':
                            executeSignalJammer();
                            break;
                        case 'emergency_erase':
                            executeEmergencyErase();
                            break;
                        case 'case_details':
                            showCaseDetails();
                            break;
                        case 'case_report':
                            showCaseReport();
                            break;
                        case 'inter_dept_report':
                            showInterDeptReport();
                            break;
                        case 'encryption_analysis':
                            showEncryptionAnalysisTool();
                            break;
                        case 'behavior_analysis':
                            showBehaviorAnalysisTool();
                            break;
                        case 'instant_tracker':
                            showInstantNetworkTracker();
                            break;
                        case 'vuln_scanner':
                            showVulnerabilityScanner();
                            break;
                        case 'timeline_analyzer':
                            showTimelineAnalyzer();
                            break;
                        case 'social_network_analysis':
                            showSocialNetworkAnalysis();
                            break;
                        case 'geoip_mapping':
                            showGeoIPMapping();
                            break;
                        case 'tls_decode':
                            showTLSDecoder();
                            break;
                        case 'threat_intel_panel':
                            showThreatIntelPanel();
                            break;
                        case 'cve_lookup':
                            showCVELookup();
                            break;
                        case 'sandbox_analyze':
                            showSandboxAnalyzer();
                            break;
                        case 'ai_attack_match':
                            showAIAttackMatcher();
                            break;
                        case 'open_forensics':
                            openForensicsLab && openForensicsLab();
                            break;
                        case 'open_warrant':
                            openWarrantSystem && openWarrantSystem();
                            break;
                        case 'gen_summary':
                            renderForensicsSide && renderForensicsSide('快速面板：產生執法摘要（模擬）');
                            break;
                        case 'forensic_toolkit':
                            showForensicToolkit();
                            break;
                        case 'chain_of_custody':
                            showChainOfCustody();
                            break;
                        case 'legal_doc_gen':
                            showLegalDocGenerator();
                            break;
                        case 'witness_mgmt':
                            showWitnessManagement();
                            break;
                        case 'case_management':
                            showCaseManagement();
                            break;
                        case 'task_dispatch':
                            showTaskDispatch();
                            break;
                        case 'timeline_viz':
                            showTimelineVisualization();
                            break;
                        case 'report_template':
                            showReportTemplate();
                            break;
                        case 'scan_target':
                            useTool('network_scanner', {name: '網絡掃描', cost: 500, cooldown: 10});
                            break;
                        case 'crack_password':
                            showPasswordCracker();
                            break;
                        case 'vpn_protection':
                            showVPNSettings();
                            break;
                        case 'encrypt_file':
                            executeFileOperation('encrypt');
                            break;
                        case 'decrypt_file':
                            executeFileOperation('decrypt');
                            break;
                        case 'target_intel':
                            showTargetIntel();
                            break;
                        case 'antivirus':
                            executeAntivirusScan();
                            break;
                        case 'device_status':
                            showDeviceDashboard();
                            break;
                        case 'ip_tracking':
                            executeIPTracking();
                            break;
                        case 'traffic_analysis':
                            showTrafficMonitor();
                            break;
                        case 'reverse_injection':
                            executeReverseInjection();
                            break;
                        case 'honeypot_gen':
                            executeHoneypotDeployment();
                            break;
                        case 'darknet_hub':
                            showDarknetHub();
                            break;
                    }
                    
                    if (btnElement) {
                        btnElement.classList.remove('executing');
                        btnElement.classList.add('success');
                        btnElement.style.transform = 'scale(1)';
                        
                        // 添加成功動畫
                        const icon = btnElement.querySelector('i');
                        if (icon) {
                            icon.style.animation = 'pulse 0.5s ease';
                        }
                        
                        setTimeout(() => {
                            btnElement.classList.remove('success');
                            if (icon) icon.style.animation = '';
                        }, 1500);
                    }
                    
                    // 添加成功通知
                    addTerminalLine(`[✓ 完成] 快捷功能 "${actionId}" 已成功執行`, 'success');
                } catch (err) {
                    console.error(err);
                    if (btnElement) {
                        btnElement.classList.remove('executing');
                        btnElement.classList.add('error');
                        btnElement.style.transform = 'scale(1)';
                        
                        setTimeout(() => {
                            btnElement.classList.remove('error');
                        }, 1500);
                    }
                    
                    // 添加錯誤通知
                    addTerminalLine(`[✗ 錯誤] 快捷功能執行失敗: ${err.message}`, 'error');
                }
            }, 600);
        }

        function executeOneClickAttack() {
            const mode = GameState.attackMode;
            const content = `
                <div class="setup-section">
                    <div class="setting-group">
                        <label class="setting-label">攻擊強度</label>
                        <select class="setting-input" id="attack-intensity">
                            <option value="low">低強度 (隱蔽性高)</option>
                            <option value="medium" selected>中強度 (平衡)</option>
                            <option value="high">高強度 (威力大，易被發現)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">目標重點</label>
                        <select class="setting-input" id="attack-focus">
                            <option value="data">數據竊取/破壞</option>
                            <option value="system">系統癱瘓</option>
                            <option value="stealth">清除足跡</option>
                        </select>
                    </div>
                </div>
            `;
            
            showStepModal('一鍵式攻擊策略設定', content, [
                {text: '確認執行', onclick: `confirmQuickAttack('${mode}')`},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function confirmQuickAttack(mode) {
            const intensity = document.getElementById('attack-intensity').value;
            const focus = document.getElementById('attack-focus').value;
            closeStepModal();
            
            addTerminalLine(`[策略] 啟動 ${intensity} 強度攻擊，重點: ${focus}...`, 'alert', true);
            
            setTimeout(() => {
                let bonus = intensity === 'high' ? 20 : (intensity === 'medium' ? 15 : 10);
                if (GameState.currentRole === 'hacker') {
                    GameState.playerData.hacker.controlProgress += bonus;
                    if (intensity === 'high') GameState.playerData.hacker.stealth -= 15;
                    addTerminalLine(`[成功] 攻擊完成，控制進度 +${bonus}%`, 'success');
                } else {
                    GameState.playerData.law_enforcement.investigationProgress += bonus;
                    addTerminalLine(`[成功] 調查完成，進度 +${bonus}%`, 'success');
                }
                updateGameStats();
            }, 2500);
        }

        // 初始化快速搜尋輸入與過濾邏輯
        function initQuickFind() {
            const input = document.getElementById('tool-quick-find');
            if (!input) return;
            input.addEventListener('input', function() {
                const q = this.value.trim().toLowerCase();
                filterToolsOrSkills(q);
            });
            // 支援按下 Enter 快速聚焦第一項
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const firstTool = document.querySelector('#tools-grid .tool-card, #special-skills-grid .special-skill-card');
                    if (firstTool) firstTool.scrollIntoView({behavior: 'smooth', block: 'center'});
                }
            });
        }

        // 防止其他程式或樣式動態把面板設為絕對或改變 z-index
        function enforcePanelFlow() {
            const tools = document.querySelector('.tools-panel');
            const skills = document.querySelector('.special-skills-panel');
            // apply multiple times to override other scripts that may run later
            for (let i=0;i<4;i++) {
                if (tools) {
                    tools.style.setProperty('position', 'relative', 'important');
                    tools.style.setProperty('z-index', '3', 'important');
                }
                if (skills) {
                    skills.style.setProperty('position', 'relative', 'important');
                    skills.style.setProperty('z-index', '2', 'important');
                }
            }
            // debug info
            try {
                if (tools) console.log('tools-panel computed:', window.getComputedStyle(tools).position, window.getComputedStyle(tools).zIndex);
                if (skills) console.log('special-skills-panel computed:', window.getComputedStyle(skills).position, window.getComputedStyle(skills).zIndex);
            } catch(e) {}
            // Setup MutationObserver to guard against later script changes
            try {
                const observerCallback = function(mutationsList) {
                    for (const m of mutationsList) {
                        if (m.type === 'attributes' && (m.attributeName === 'style' || m.attributeName === 'class')) {
                            // reapply enforcement
                            for (let i=0;i<2;i++) {
                                if (tools) {
                                    tools.style.setProperty('position', 'relative', 'important');
                                    tools.style.setProperty('z-index', '1000', 'important');
                                }
                                if (skills) {
                                    skills.style.setProperty('position', 'relative', 'important');
                                    skills.style.setProperty('z-index', '900', 'important');
                                }
                            }
                        }
                    }
                };
                const obs = new MutationObserver(observerCallback);
                if (tools) obs.observe(tools, { attributes: true, attributeFilter: ['style','class'] });
                if (skills) obs.observe(skills, { attributes: true, attributeFilter: ['style','class'] });
            } catch(e) { }
        }

        // runtime diagnostics: detect if any element is visually covering the tools panel
        function diagnoseOverlap() {
            const tools = document.querySelector('.left-panel > .tools-panel');
            if (!tools) return;
            const toolsRect = tools.getBoundingClientRect();
            const toolsZ = parseInt(window.getComputedStyle(tools).zIndex) || 0;
            // scan all elements to find any with higher z-index and overlapping rect
            const all = document.body.getElementsByTagName('*');
            for (let i=0;i<all.length;i++) {
                const el = all[i];
                if (el === tools) continue;
                try {
                    const style = window.getComputedStyle(el);
                    const z = parseInt(style.zIndex) || 0;
                    if (z > toolsZ) {
                        const r = el.getBoundingClientRect();
                        const overlap = !(r.right < toolsRect.left || r.left > toolsRect.right || r.bottom < toolsRect.top || r.top > toolsRect.bottom);
                        if (overlap) {
                            console.warn('diagnoseOverlap: element likely covering tools-panel', el, 'zIndex=', z);
                            // briefly outline offending element in bright red to help visually locate it
                            const prev = el.style.outline;
                            el.style.outline = '3px solid rgba(255,0,0,0.9)';
                            setTimeout(()=>{ try{ el.style.outline = prev; }catch(e){} }, 3000);
                        }
                    }
                } catch(e) {}
            }
        }

        function filterToolsOrSkills(query) {
            const tools = document.querySelectorAll('#tools-grid .tool-card');
            const skills = document.querySelectorAll('#special-skills-grid .special-skill-card');

            if (query === '') {
                tools.forEach(t => t.style.display = 'flex');
                skills.forEach(s => s.style.display = 'flex');
                return;
            }

            tools.forEach(t => {
                const name = (t.querySelector('.tool-name') && t.querySelector('.tool-name').innerText.toLowerCase()) || '';
                const desc = (t.querySelector('.tool-desc') && t.querySelector('.tool-desc').innerText.toLowerCase()) || '';
                t.style.display = (name.indexOf(query) > -1 || desc.indexOf(query) > -1) ? 'flex' : 'none';
            });

            skills.forEach(s => {
                const name = (s.querySelector('.tool-name') && s.querySelector('.tool-name').innerText.toLowerCase()) || '';
                const desc = (s.querySelector('.tool-desc') && s.querySelector('.tool-desc').innerText.toLowerCase()) || '';
                s.style.display = (name.indexOf(query) > -1 || desc.indexOf(query) > -1) ? 'flex' : 'none';
            });
        }

        // 顯示隱藏功能提示（可被 updateRoleSpecificButtons 觸發）
        function showHiddenFeaturesHintForRole(role) {
            const hid = role === 'law_enforcement' ? 'hidden-features-hint' : 'hacker-features-hint';
            const el = document.getElementById(hid);
            if (!el) return;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 10000);
        }

        function showPasswordCracker() {
            const content = `
                <div class="step-description">選擇破解強度與技術：</div>
                <div class="info-grid">
                    <button class="btn btn-secondary" onclick="startCracking('brute_force')">暴力破解 (快速/低成功率)</button>
                    <button class="btn btn-secondary" onclick="startCracking('dictionary')">字典攻擊 (中速/中成功率)</button>
                    <button class="btn btn-primary" onclick="startCracking('rainbow_table')">彩虹表破解 (慢速/高成功率)</button>
                </div>
            `;
            showStepModal('破解密碼系統', content, []);
        }

        function startCracking(tech) {
            closeStepModal();
            addTerminalLine('[破解] 使用 ' + tech + ' 技術嘗試破解密碼...', 'command');
            setTimeout(() => {
                const success = Math.random() > 0.4;
                if (success) {
                    addTerminalLine('[成功] 密碼已破解！獲得系統權限。', 'success');
                    if (GameState.currentRole === 'hacker') GameState.playerData.hacker.controlProgress += 20;
                    else GameState.playerData.law_enforcement.investigationProgress += 20;
                } else {
                    addTerminalLine('[失敗] 破解嘗試被攔截。', 'error');
                }
                updateGameStats();
            }, 2000);
        }

        function executeFileOperation(op) {
            const opName = op === 'encrypt' ? '加密' : '解密';
            addTerminalLine('[文件] 正在執行' + opName + '操作...', 'command');
            setTimeout(() => {
                addTerminalLine('[成功] 文件已' + opName + '。算法: AES-256', 'success');
                showNotification('文件操作', '操作成功完成', 'success');
            }, 1500);
        }

        function showTargetIntel() {
            const opponent = GameState.opponentData.hacker;
            const content = `
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">代號</div><div class="info-value">Unknown Hacker</div></div>
                    <div class="info-item"><div class="info-label">威脅等級</div><div class="info-value">CRITICAL</div></div>
                    <div class="info-item"><div class="info-label">過往紀錄</div><div class="info-value">3次銀行入侵, 1次政府滲透</div></div>
                    <div class="info-item"><div class="info-label">常用IP</div><div class="info-value">${GameState.opponentIP}</div></div>
                    <div class="info-item"><div class="info-label">隱蔽技術</div><div class="info-value">多重VPN, 洋蔥路由</div></div>
                    <div class="info-item"><div class="info-label">心理分析</div><div class="info-value">極度謹慎, 具有高度技術自信</div></div>
                </div>
            `;
            showStepModal('詳細目標情報 *執法部門專屬*', content, [{text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function executeAntivirusScan() {
            addTerminalLine('[掃毒] 正在掃描裝置及網絡...', 'command');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 25;
                addTerminalLine('[掃毒] 進度: ' + progress + '%', 'response');
                if (progress >= 100) {
                    clearInterval(interval);
                    addTerminalLine('[完成] 掃描完畢。威脅已清除，VPN 已重置，反追蹤工具已激活。', 'success');
                    if (GameState.currentRole === 'hacker') GameState.playerData.hacker.stealth = 100;
                    updateGameStats();
                }
            }, 500);
        }

        function showDeviceDashboard() {
            const content = `
                <div class="info-grid">
                    <div class="info-item"><div class="info-label">CPU 使用率</div><div class="info-value">42%</div></div>
                    <div class="info-item"><div class="info-label">記憶體</div><div class="info-value">8.4GB / 16GB</div></div>
                    <div class="info-item"><div class="info-label">網絡延遲</div><div class="info-value">15ms</div></div>
                    <div class="info-item"><div class="info-label">加密狀態</div><div class="info-value">AES-NI 已啟用</div></div>
                    <div class="info-item"><div class="info-label">防火牆</div><div class="info-value">ACTIVE</div></div>
                    <div class="info-item"><div class="info-label">匿名層</div><div class="info-value">3層 (Tor + VPN)</div></div>
                </div>
            `;
            showStepModal('裝置詳細狀態儀表板', content, [{text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function executeIPTracking() {
            addTerminalLine('[追蹤] 啟動 IP 追蹤系統...', 'command');
            setTimeout(() => {
                addTerminalLine('[追蹤] 正在通過 12 個節點進行三角定位...', 'response');
                setTimeout(() => {
                    addTerminalLine('[成功] 目標大致地理位置已鎖定。精確度: 85%', 'success');
                }, 1500);
            }, 1000);
        }

        function showTrafficMonitor() {
            addTerminalLine('[監聽] 流量監聽分析儀已啟動。', 'success');
            addTerminalLine('[監聽] 正在標記可疑連接...', 'response');
            setTimeout(() => {
                addTerminalLine('[警告] 發現異常流量來源: 192.168.x.x', 'alert');
            }, 2000);
        }

        function executeReverseInjection() {
            addTerminalLine('[反向注入] 正在生成偽裝連結並內嵌追蹤腳本...', 'command');
            setTimeout(() => {
                addTerminalLine('[成功] 誘餌已部署。一旦點擊，將自動上傳對方設備資訊。', 'success');
            }, 1500);
        }

        function executeHoneypotDeployment() {
            addTerminalLine('[誘捕] 正在部署虛擬「假企業網絡」...', 'command');
            setTimeout(() => {
                addTerminalLine('[成功] 誘捕網絡已上線。正在等待黑客攻擊以收集工具樣本。', 'success');
            }, 2000);
        }

        function showDarknetHub() {
            const content = `
                <div class="darknet-hub-enhanced" style="max-height: 600px; overflow-y: auto;">
                    <!-- 暗網標題 -->
                    <div style="border-bottom: 2px solid #00ff41; padding-bottom: 15px; margin-bottom: 20px; text-align: center;">
                        <h3 style="margin: 0; letter-spacing: 3px; color: #00ff41; font-size: 1.3rem;">⚫ 暗 網 中 介 聯 絡 站 ⚫</h3>
                        <small style="color: #008800; display: block; margin-top: 5px;">加密通信: AES-256 | 節點: Tor-Relay-7721 | 狀態: 🟢 ONLINE</small>
                    </div>

                    <!-- 暗網菜單標籤 -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #00aa00; padding-bottom: 10px;">
                        <button class="darknet-tab" data-tab="market" onclick="switchDarknetTab('market')" style="flex: 1; padding: 8px; background: rgba(0,255,65,0.2); border: 1px solid #00ff41; color: #00ff41; cursor: pointer; font-weight: bold;">市場</button>
                        <button class="darknet-tab" data-tab="contacts" onclick="switchDarknetTab('contacts')" style="flex: 1; padding: 8px; background: transparent; border: 1px solid #00aa00; color: #00aa00; cursor: pointer;">聯繫人</button>
                        <button class="darknet-tab" data-tab="messages" onclick="switchDarknetTab('messages')" style="flex: 1; padding: 8px; background: transparent; border: 1px solid #00aa00; color: #00aa00; cursor: pointer;">消息</button>
                        <button class="darknet-tab" data-tab="forum" onclick="switchDarknetTab('forum')" style="flex: 1; padding: 8px; background: transparent; border: 1px solid #00aa00; color: #00aa00; cursor: pointer;">論壇</button>
                    </div>

                    <!-- 市場版面 -->
                    <div id="darknet-market-tab" style="display: block;">
                        <div style="color: #00ff41; font-weight: bold; margin-bottom: 10px;">[市場] 可用商品</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div class="darknet-opt" style="border: 1px solid #00ff41; padding: 12px; cursor: pointer; background: rgba(0,255,65,0.08);" onclick="buyDarknetIntel('vuln')">
                                <div style="font-weight: bold; color: #00ff41;">[🔓 漏洞情報]</div>
                                <div style="font-size: 0.75rem; color: #00aa00; margin-top: 5px;">最新 0-day 漏洞<br>$5,000</div>
                            </div>
                            <div class="darknet-opt" style="border: 1px solid #00ff41; padding: 12px; cursor: pointer; background: rgba(0,255,65,0.08);" onclick="buyDarknetIntel('le')">
                                <div style="font-weight: bold; color: #00ff41;">[🚨 執法情報]</div>
                                <div style="font-size: 0.75rem; color: #00aa00; margin-top: 5px;">LE行動代號<br>$3,000</div>
                            </div>
                            <div class="darknet-opt" style="border: 1px solid #00ff41; padding: 12px; cursor: pointer; background: rgba(0,255,65,0.08);" onclick="buyDarknetIntel('clean')">
                                <div style="font-weight: bold; color: #00ff41;">[💰 資金清洗]</div>
                                <div style="font-size: 0.75rem; color: #00aa00; margin-top: 5px;">轉化非法所得<br>手續費 15%</div>
                            </div>
                            <div class="darknet-opt" style="border: 1px solid #00ff41; padding: 12px; cursor: pointer; background: rgba(0,255,65,0.08);" onclick="buyDarknetIntel('hire')">
                                <div style="font-weight: bold; color: #00ff41;">[👥 僱用幫手]</div>
                                <div style="font-size: 0.75rem; color: #00aa00; margin-top: 5px;">+20% 攻擊強度<br>$10,000</div>
                            </div>
                            <div class="darknet-opt" style="border: 1px solid #00ff41; padding: 12px; cursor: pointer; background: rgba(0,255,65,0.08);" onclick="buyDarknetIntel('malware')">
                                <div style="font-weight: bold; color: #00ff41;">[🦠 惡意軟體]</div>
                                <div style="font-size: 0.75rem; color: #00aa00; margin-top: 5px;">高級木馬程式<br>$8,000</div>
                            </div>
                            <div class="darknet-opt" style="border: 1px solid #00ff41; padding: 12px; cursor: pointer; background: rgba(0,255,65,0.08);" onclick="buyDarknetIntel('proxy')">
                                <div style="font-weight: bold; color: #00ff41;">[🌐 代理服務]</div>
                                <div style="font-size: 0.75rem; color: #00aa00; margin-top: 5px;">隱匿IP地址<br>$2,000/月</div>
                            </div>
                        </div>
                    </div>

                    <!-- 聯繫人版面 -->
                    <div id="darknet-contacts-tab" style="display: none;">
                        <div style="color: #00ff41; font-weight: bold; margin-bottom: 10px;">[聯繫人] 活躍 Hacker</div>
                        <div style="background: rgba(0,20,0,0.5); border: 1px solid #00aa00; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                            <div style="padding: 8px; border-bottom: 1px solid #00aa00; color: #00ff41; cursor: pointer; display: flex; justify-content: space-between;" onclick="openDarknetChat('ShadowCoder')">
                                <span>🔴 ShadowCoder</span>
                                <span style="color: #00aa00; font-size: 0.8rem;">線上</span>
                            </div>
                            <div style="padding: 8px; border-bottom: 1px solid #00aa00; color: #00ff41; cursor: pointer; display: flex; justify-content: space-between;" onclick="openDarknetChat('CryptoMaster')">
                                <span>🔴 CryptoMaster</span>
                                <span style="color: #00aa00; font-size: 0.8rem;">線上</span>
                            </div>
                            <div style="padding: 8px; border-bottom: 1px solid #00aa00; color: #00ff41; cursor: pointer; display: flex; justify-content: space-between;" onclick="openDarknetChat('PhantomNet')">
                                <span>🔴 PhantomNet</span>
                                <span style="color: #00aa00; font-size: 0.8rem;">線上</span>
                            </div>
                            <div style="padding: 8px; border-bottom: 1px solid #00aa00; color: #00ff41; cursor: pointer; display: flex; justify-content: space-between;" onclick="openDarknetChat('ZeroBreach')">
                                <span>🟡 ZeroBreach</span>
                                <span style="color: #ffaa00; font-size: 0.8rem;">3分鐘前</span>
                            </div>
                            <div style="padding: 8px; color: #00ff41; cursor: pointer; display: flex; justify-content: space-between;" onclick="openDarknetChat('NovaAttack')">
                                <span>⚫ NovaAttack</span>
                                <span style="color: #aa0000; font-size: 0.8rem;">離線</span>
                            </div>
                        </div>
                    </div>

                    <!-- 消息版面 -->
                    <div id="darknet-messages-tab" style="display: none;">
                        <div style="color: #00ff41; font-weight: bold; margin-bottom: 10px;">[消息] 最近通信</div>
                        <div style="background: rgba(0,20,0,0.5); border: 1px solid #00aa00; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto; font-size: 0.85rem;">
                            <div style="color: #00ff41; margin-bottom: 8px;"><strong>ShadowCoder:</strong> 有新的0-day嗎？</div>
                            <div style="color: #00aa00; margin-bottom: 8px;"><strong>You:</strong> 等等，有三個漏洞...</div>
                            <div style="color: #00ff41; margin-bottom: 8px;"><strong>CryptoMaster:</strong> 我在做新的加密破解工具</div>
                            <div style="color: #00aa00; margin-bottom: 8px;"><strong>You:</strong> 感興趣，報價多少？</div>
                            <div style="color: #ffaa00; margin-bottom: 8px;"><strong>PhantomNet:</strong> 執法部門最近加強防線...</div>
                        </div>
                        <input type="text" placeholder="輸入消息..." style="width: 100%; margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid #00aa00; color: #00ff41; font-size: 0.85rem;" />
                    </div>

                    <!-- 論壇版面 -->
                    <div id="darknet-forum-tab" style="display: none;">
                        <div style="color: #00ff41; font-weight: bold; margin-bottom: 10px;">[論壇] 技術討論</div>
                        <div style="background: rgba(0,20,0,0.5); border: 1px solid #00aa00; border-radius: 4px; padding: 10px; max-height: 300px; overflow-y: auto; font-size: 0.85rem;">
                            <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #00ff41;">
                                <div style="color: #00ff41; font-weight: bold;">【求助】如何繞過最新的防火牆？</div>
                                <div style="color: #00aa00; font-size: 0.8rem;">由 ShadowCoder 發佈</div>
                            </div>
                            <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #00ff41;">
                                <div style="color: #00ff41; font-weight: bold;">【分享】新型勒索軟體分析報告</div>
                                <div style="color: #00aa00; font-size: 0.8rem;">由 CryptoMaster 發佈</div>
                            </div>
                            <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid #00ff41;">
                                <div style="color: #00ff41; font-weight: bold;">【警告】執法部門新追蹤技術</div>
                                <div style="color: #00aa00; font-size: 0.8rem;">由 PhantomNet 發佈</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showStepModal('暗網中介聯絡站 ⚫ 黑客專屬', content, [{text: '關閉連線', onclick: 'closeStepModal()'}]);
        }

        function switchDarknetTab(tabName) {
            // 隱藏所有標籤
            document.getElementById('darknet-market-tab').style.display = 'none';
            document.getElementById('darknet-contacts-tab').style.display = 'none';
            document.getElementById('darknet-messages-tab').style.display = 'none';
            document.getElementById('darknet-forum-tab').style.display = 'none';
            
            // 顯示選定的標籤
            if (tabName === 'market') {
                document.getElementById('darknet-market-tab').style.display = 'block';
            } else if (tabName === 'contacts') {
                document.getElementById('darknet-contacts-tab').style.display = 'block';
            } else if (tabName === 'messages') {
                document.getElementById('darknet-messages-tab').style.display = 'block';
            } else if (tabName === 'forum') {
                document.getElementById('darknet-forum-tab').style.display = 'block';
            }
            
            // 更新按鈕樣式
            document.querySelectorAll('.darknet-tab').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.style.background = 'rgba(0,255,65,0.2)';
                    btn.style.color = '#00ff41';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = '#00aa00';
                }
            });
        }

        function openDarknetChat(hackerName) {
            addTerminalLine(`[暗網] 正在連接 ${hackerName}...`, 'command');
            setTimeout(() => {
                addTerminalLine(`[✓] 已連接 ${hackerName}`, 'success');
                const messages = {
                    'ShadowCoder': '嘿，你對最新的漏洞感興趣嗎？',
                    'CryptoMaster': '我剛完成了新的加密破解工具！',
                    'PhantomNet': '執法部門在加強防線，要小心。',
                    'ZeroBreach': '有新的僱傭任務嗎？',
                    'NovaAttack': '我正在開發自動化攻擊框架'
                };
                const message = messages[hackerName] || '你好，有什麼需要幫助嗎？';
                showNotification(hackerName, message, 'success');
            }, 1000);
        }

        window.buyDarknetIntel = function(type) {
            const role = GameState.currentRole;
            const data = GameState.playerData[role];
            
            addTerminalLine('[暗網] 正在處理交易請求...', 'command');
            
            setTimeout(() => {
                switch(type) {
                    case 'vuln':
                        if (data.money >= 5000) {
                            data.money -= 5000;
                            addTerminalLine('[情報] 成功獲取目標 SQL 注入漏洞！', 'success');
                            showNotification('交易成功', '已獲取系統漏洞情報', 'success');
                        } else {
                            addTerminalLine('[錯誤] 資金不足，交易取消。', 'error');
                        }
                        break;
                    case 'le':
                        if (data.money >= 3000) {
                            data.money -= 3000;
                            addTerminalLine('[情報] 執法部門行動代號: "Blue Storm"', 'success');
                            showNotification('交易成功', '已獲取執法部門情報', 'success');
                        } else {
                            addTerminalLine('[錯誤] 資金不足，交易取消。', 'error');
                        }
                        break;
                    case 'clean':
                        addTerminalLine('[系統] 正在清洗資金，預計耗時 30 秒...', 'info');
                        setTimeout(() => {
                            addTerminalLine('[系統] 資金清洗完成，可用餘額增加。', 'success');
                        }, 5000);
                        break;
                    case 'hire':
                        if (data.money >= 10000) {
                            data.money -= 10000;
                            data.attackPower = (data.attackPower || 100) * 1.2;
                            addTerminalLine('[系統] 幫手已就位，攻擊力提升 20%！', 'success');
                            showNotification('交易成功', '攻擊力已提升', 'success');
                        } else {
                            addTerminalLine('[錯誤] 資金不足，交易取消。', 'error');
                        }
                        break;
                    case 'malware':
                        if (data.money >= 8000) {
                            data.money -= 8000;
                            addTerminalLine('[惡意軟體] 高級木馬程式已下載！', 'success');
                            showNotification('交易成功', '獲得高級木馬程式', 'success');
                        } else {
                            addTerminalLine('[錯誤] 資金不足，交易取消。', 'error');
                        }
                        break;
                    case 'proxy':
                        if (data.money >= 2000) {
                            data.money -= 2000;
                            addTerminalLine('[代理] 您已獲得 12 個月的匿名代理服務！', 'success');
                            showNotification('交易成功', '代理服務已啟用', 'success');
                        } else {
                            addTerminalLine('[錯誤] 資金不足，交易取消。', 'error');
                        }
                        break;
                }
                updateResourceUI();
            }, 1000);
        }
    
        // ===== 黑客專屬功能實作 =====
        
        function executeAutoAttack() {
            const content = `
                <div class="setup-section">
                    <div class="terminal-output" style="color: #00ff41; font-size: 0.85rem; margin-bottom: 10px;">
                        [系統] 自動化攻擊已預設基本攻擊設定
                        <br>[狀態] 掃描中... 偵測到 ${Math.floor(Math.random() * 10) + 5} 個潛在入口點
                        <br>[準備] 攻擊模型已加載，即將執行...
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">攻擊優先級</label>
                        <select class="setting-input" id="auto-priority">
                            <option value="speed">速度優先 (快速佈署)</option>
                            <option value="stealth" selected>隱蔽優先 (低檢測率)</option>
                            <option value="damage">破壞優先 (最大傷害)</option>
                        </select>
                    </div>
                </div>
            `;
            
            showStepModal('自動化攻擊', content, [
                {text: '啟動攻擊', onclick: `confirmAutoAttack()`},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function confirmAutoAttack() {
            closeStepModal();
            const priority = document.getElementById('auto-priority')?.value || 'stealth';
            addTerminalLine(`[攻擊] 自動化攻擊模組已啟動 (優先級: ${priority})...`, 'alert', true);
            
            setTimeout(() => {
                GameState.playerData.hacker.controlProgress += 12;
                addTerminalLine(`[✓] 自動化攻擊完成，控制進度 +12%`, 'success');
                updateGameStats();
                showNotification('攻擊成功', '自動化模組已執行', 'success');
            }, 2000);
        }

        function executeDirectAttack() {
            const content = `
                <div class="setup-section">
                    <div class="alert-box" style="color: #ff6666; margin-bottom: 10px;">
                        ⚠️ 警告: 直接攻擊風險高，易被偵測！
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">目標系統選擇</label>
                        <select class="setting-input" id="direct-target">
                            <option value="server">主伺服器 (高風險/高收益)</option>
                            <option value="gateway">網關設備 (中風險/中收益)</option>
                            <option value="endpoint" selected>端點設備 (低風險/低收益)</option>
                        </select>
                    </div>
                </div>
            `;
            
            showStepModal('直接攻擊 ⚡', content, [
                {text: '執行直接攻擊', onclick: `confirmDirectAttack()`},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function confirmDirectAttack() {
            closeStepModal();
            const target = document.getElementById('direct-target')?.value || 'endpoint';
            addTerminalLine(`[攻擊] 發起直接攻擊 (目標: ${target})...`, 'alert', true);
            
            setTimeout(() => {
                GameState.playerData.hacker.controlProgress += 25;
                GameState.playerData.hacker.stealth -= 20;
                addTerminalLine(`[✓] 直接攻擊完成！控制 +25% (隱蔽性 -20%)`, 'success');
                updateGameStats();
                showNotification('直接攻擊成功', '目標系統已癱瘓', 'success');
            }, 2500);
        }

        function executeProgressiveAttack() {
            const content = `
                <div class="setup-section">
                    <div class="terminal-output" style="color: #ffaa00; font-size: 0.85rem; margin-bottom: 10px;">
                        [規劃] 多階段攻擊策略
                        <br>第一階段: 偵測目標 (5分鐘)
                        <br>第二階段: 尋找漏洞 (10分鐘)
                        <br>第三階段: 部署惡意程式 (15分鐘)
                        <br>第四階段: 獲取控制 (10分鐘)
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">執行模式</label>
                        <select class="setting-input" id="progressive-mode">
                            <option value="slow" selected>緩慢 (低檢測/慢速)</option>
                            <option value="balanced">平衡 (中等)</option>
                            <option value="fast">快速 (高檢測/快速)</option>
                        </select>
                    </div>
                </div>
            `;
            
            showStepModal('循序漸進攻擊', content, [
                {text: '開始攻擊', onclick: `confirmProgressiveAttack()`},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function confirmProgressiveAttack() {
            closeStepModal();
            const mode = document.getElementById('progressive-mode')?.value || 'slow';
            addTerminalLine(`[攻擊] 循序漸進攻擊已啟動 (模式: ${mode})...`, 'alert', true);
            
            setTimeout(() => {
                GameState.playerData.hacker.controlProgress += 18;
                addTerminalLine(`[✓] 第一階段完成 (偵測)`, 'success');
                setTimeout(() => {
                    addTerminalLine(`[✓] 第二階段完成 (漏洞發現)`, 'success');
                    GameState.playerData.hacker.controlProgress += 18;
                    updateGameStats();
                }, 1500);
            }, 2000);
        }

        function executeZombieAttack() {
            const content = `
                <div class="setup-section">
                    <div class="botnet-status" style="color: #00ff41; margin-bottom: 10px;">
                        [殭屍網絡] 當前已感染設備: <span style="color: #ffaa00;">847 台</span>
                        <br>[狀態] 準備就緒，可隨時動員
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">動員殭屍數量</label>
                        <select class="setting-input" id="zombie-count">
                            <option value="50">50 台設備</option>
                            <option value="200" selected>200 台設備</option>
                            <option value="500">500 台設備</option>
                            <option value="all">全部動員 (847 台)</option>
                        </select>
                    </div>
                </div>
            `;
            
            showStepModal('殭屍級攻擊 🧟', content, [
                {text: '動員殭屍大軍', onclick: `confirmZombieAttack()`},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function confirmZombieAttack() {
            closeStepModal();
            const count = document.getElementById('zombie-count')?.value || '200';
            addTerminalLine(`[殭屍] 動員 ${count} 台殭屍設備進行分散式拒絕服務攻擊...`, 'alert', true);
            
            setTimeout(() => {
                GameState.playerData.hacker.controlProgress += 30;
                GameState.playerData.hacker.stealth -= 30;
                addTerminalLine(`[✓] 殭屍大軍攻擊完成！控制 +30% (易被檢測)`, 'success');
                updateGameStats();
                showNotification('殭屍攻擊成功', '分散式拒絕服務已執行', 'success');
            }, 2000);
        }

        function executeSignalJammer() {
            const content = `
                <div class="setup-section">
                    <div class="warning-box" style="color: #ff6666; margin-bottom: 10px;">
                        🔴 干擾即將開始 - 檢測設備信號將被屏蔽
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">干擾頻譜</label>
                        <select class="setting-input" id="jammer-spectrum">
                            <option value="wifi">Wi-Fi (2.4 GHz)</option>
                            <option value="cellular" selected>行動網絡 (4G/5G)</option>
                            <option value="gps">GPS 信號</option>
                            <option value="all">全頻段 (完全隔絕)</option>
                        </select>
                    </div>
                </div>
            `;
            
            showStepModal('信號幹擾器', content, [
                {text: '啟動干擾', onclick: `confirmSignalJammer()`},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function confirmSignalJammer() {
            closeStepModal();
            const spectrum = document.getElementById('jammer-spectrum')?.value || 'cellular';
            addTerminalLine(`[干擾] 啟動信號幹擾器 (頻譜: ${spectrum})...`, 'alert', true);
            
            setTimeout(() => {
                GameState.playerData.hacker.stealth += 15;
                addTerminalLine(`[✓] 信號干擾成功 (隱蔽性 +15%)`, 'success');
                updateGameStats();
                showNotification('干擾成功', '目標信號已被屏蔽', 'success');
            }, 1500);
        }

        function executeEmergencyErase() {
            const content = `
                <div class="setup-section">
                    <div class="danger-box" style="color: #ff0000; margin-bottom: 10px; font-weight: bold;">
                        ⚠️ 緊急清除模式 - 將徹底抹除所有痕跡
                        此操作不可撤銷！
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">清除範圍</label>
                        <select class="setting-input" id="erase-scope">
                            <option value="current">當前設備</option>
                            <option value="network" selected>整個網絡</option>
                            <option value="complete">完全清除 (所有備份)</option>
                        </select>
                    </div>
                </div>
            `;
            
            showStepModal('緊急快速清除痕跡 🔥', content, [
                {text: '執行清除', onclick: `confirmEmergencyErase()`},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function confirmEmergencyErase() {
            closeStepModal();
            const scope = document.getElementById('erase-scope')?.value || 'network';
            addTerminalLine(`[清除] 啟動緊急清除程序 (範圍: ${scope})...`, 'alert', true);
            addTerminalLine(`[清除] 正在刪除日誌檔案...`, 'command');
            
            setTimeout(() => {
                addTerminalLine(`[清除] 覆蓋網絡路由記錄...`, 'command');
                addTerminalLine(`[清除] 清空緩存數據...`, 'command');
            }, 800);
            
            setTimeout(() => {
                addTerminalLine(`[✓] 所有痕跡已清除 (隱蔽性 +30%)`, 'success');
                GameState.playerData.hacker.stealth += 30;
                updateGameStats();
                showNotification('清除成功', '網絡足跡已徹底清除', 'success');
            }, 2000);
        }

        // ===== 執法部門專屬功能實作 =====

        function showCaseDetails() {
            const content = `
                <div class="setup-section" style="max-height: 400px; overflow-y: auto;">
                    <div class="case-detail-item">
                        <strong>案件編號：</strong> CASE-2024-001847
                    </div>
                    <div class="case-detail-item">
                        <strong>案件名稱：</strong> 大規模網絡詐騙案
                    </div>
                    <div class="case-detail-item">
                        <strong>狀態：</strong> <span style="color: #ffaa00;">調查中</span>
                    </div>
                    <div class="case-detail-item">
                        <strong>嫌疑人：</strong> 黑客幫派 - Shadow Cyber
                    </div>
                    <div class="case-detail-item">
                        <strong>受害者人數：</strong> 342 人
                    </div>
                    <div class="case-detail-item">
                        <strong>詐騙金額：</strong> $487,250 USD
                    </div>
                    <div class="case-detail-item">
                        <strong>主要特徵：</strong> 
                        <ul style="margin-top: 5px;">
                            <li>使用加密通訊工具</li>
                            <li>多層代理服務器</li>
                            <li>暗網交易點</li>
                            <li>自動化釣魚郵件</li>
                        </ul>
                    </div>
                    <div class="case-detail-item">
                        <strong>優先級：</strong> <span style="color: #ff6666;">高</span>
                    </div>
                    <div class="case-detail-item">
                        <strong>分配偵探：</strong> 張警官, 李警官, 王警官
                    </div>
                </div>
            `;
            
            showStepModal('案件詳細資料 📋', content, [{text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function showCaseReport() {
            const content = `
                <div class="setup-section" style="max-height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #4a90d9; padding-bottom: 10px;">
                        <strong>案件進展報告</strong> - 報告時間: ${new Date().toLocaleString('zh-TW')}
                    </div>
                    <div class="report-section">
                        <strong>本週進展：</strong>
                        <ul>
                            <li>✓ 已追蹤 3 個主要伺服器位置</li>
                            <li>✓ 確認 7 個嫌疑人身份</li>
                            <li>✓ 凍結 5 個非法帳戶</li>
                            <li>○ 正在破解加密通訊</li>
                        </ul>
                    </div>
                    <div class="report-section" style="margin-top: 10px;">
                        <strong>關鍵發現：</strong>
                        <ul>
                            <li>發現新的暗網市場連接點</li>
                            <li>追蹤到資金洗錢渠道</li>
                            <li>識別可疑的加密錢包地址</li>
                        </ul>
                    </div>
                    <div class="report-section" style="margin-top: 10px;">
                        <strong>下階段計畫：</strong>
                        <ul>
                            <li>部署蜜罐陷阱</li>
                            <li>與國際部門協作</li>
                            <li>申請通信監聽授權</li>
                        </ul>
                    </div>
                </div>
            `;
            
            showStepModal('案件詳細回報 📊', content, [{text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function showInterDeptReport() {
            const content = `
                <div class="setup-section" style="max-height: 400px; overflow-y: auto;">
                    <div style="margin-bottom: 15px; border-bottom: 1px solid #4a90d9; padding-bottom: 10px;">
                        <strong>跨部門協作進度報告</strong>
                    </div>
                    <div class="dept-collab">
                        <div class="dept-item">
                            <strong>🔐 網絡安全部</strong>
                            <div style="font-size: 0.85rem; color: #aaa; margin-top: 5px;">
                                進度: <span style="color: #4a90d9;">████████░░</span> 80%
                                <br>負責人: 陳主任
                                <br>狀態: ✓ 活躍
                            </div>
                        </div>
                        <div class="dept-item">
                            <strong>💼 金融詐騙調查科</strong>
                            <div style="font-size: 0.85rem; color: #aaa; margin-top: 5px;">
                                進度: <span style="color: #4a90d9;">██████░░░░</span> 60%
                                <br>負責人: 黃隊長
                                <br>狀態: ✓ 活躍
                            </div>
                        </div>
                        <div class="dept-item">
                            <strong>🌐 國際聯繫組</strong>
                            <div style="font-size: 0.85rem; color: #aaa; margin-top: 5px;">
                                進度: <span style="color: #4a90d9;">█████░░░░░</span> 50%
                                <br>負責人: 國際部
                                <br>狀態: ⏳ 等待回覆
                            </div>
                        </div>
                        <div class="dept-item">
                            <strong>⚖️ 法律支援室</strong>
                            <div style="font-size: 0.85rem; color: #aaa; margin-top: 5px;">
                                進度: <span style="color: #4a90d9;">███░░░░░░░</span> 30%
                                <br>負責人: 法務部
                                <br>狀態: ⏳ 文件審核中
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #4a90d9;">
                        <strong>整體進度：</strong> <span style="color: #4a90d9;">████████░░</span> <span>72%</span>
                    </div>
                </div>
            `;
            
            showStepModal('跨部門協作進度報告 🤝', content, [{text: '關閉', onclick: 'closeStepModal()'}]);
        }

        // ===== 執法部門高級工具實作 =====

        function showEncryptionAnalysisTool() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🔐 高級數據加密分析工具
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-bottom: 15px;">
                        [系統] 掃描中... 偵測到 7 個加密算法
                        <br>[算法 1] RSA-2048 - 強度: ████████░░ 85%
                        <br>[算法 2] AES-256 - 強度: ██████████ 95%
                        <br>[算法 3] ECC-384 - 強度: █████████░ 90%
                        <br>[量子加密] QKD-衍生 - 分析中...
                    </div>
                    <div style="background: rgba(74, 144, 217, 0.1); border-left: 3px solid #4a90d9; padding: 10px; margin-bottom: 10px;">
                        <strong>分析結果:</strong>
                        <ul style="margin: 8px 0 0 20px; color: #aaa;">
                            <li>檢測到 2 個潛在破解點</li>
                            <li>建議部署側通道攻擊防禦</li>
                            <li>密鑰交換協議: 安全</li>
                        </ul>
                    </div>
                </div>
            `;
            showStepModal('高級數據加密分析 🔐', content, [{text: '開始分析', onclick: 'startEncryptionAnalysis()'}, {text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function startEncryptionAnalysis() {
            closeStepModal();
            addTerminalLine('[加密分析] 啟動高級加密算法破解分析...', 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 15;
                addTerminalLine('[✓] 已識別 3 個加密弱點', 'success');
                addTerminalLine('[情報] 目標使用過期的 RSA-1024 密鑰', 'success');
                updateGameStats();
                showNotification('分析完成', '已識別加密弱點', 'success');
            }, 2000);
        }

        function showBehaviorAnalysisTool() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🧠 智能行為分析系統
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-bottom: 15px;">
                        [AI] 分析黑客行為模式...
                        <br>[模式 1] 攻擊時間: 晚間 19:00-03:00 - 置信度 92%
                        <br>[模式 2] 目標選擇: 金融系統優先 - 置信度 88%
                        <br>[模式 3] 攻擊手法: 漸進式滲透 - 置信度 95%
                        <br>[預測] 下一步行動: SQL 注入攻擊 - 概率 78%
                    </div>
                    <div style="background: rgba(74, 144, 217, 0.1); border-left: 3px solid #4a90d9; padding: 10px;">
                        <strong>預測分析:</strong>
                        <ul style="margin: 8px 0 0 20px; color: #aaa;">
                            <li>🔴 高風險攻擊窗口即將開啟</li>
                            <li>建議部署響應式防禦</li>
                            <li>攻擊者可能在 12 小時內發動進攻</li>
                        </ul>
                    </div>
                </div>
            `;
            showStepModal('智能行為分析系統 🧠', content, [{text: '啟動預測', onclick: 'startBehaviorAnalysis()'}, {text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function startBehaviorAnalysis() {
            closeStepModal();
            addTerminalLine('[行為分析] 啟動 AI 機器學習模型...', 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 18;
                addTerminalLine('[✓] 已識別黑客行為特徵', 'success');
                addTerminalLine('[預測] 預計 12 小時內發動攻擊', 'success');
                addTerminalLine('[建議] 提前部署防禦措施', 'info');
                updateGameStats();
                showNotification('預測完成', '已預測下一步行動', 'success');
            }, 2500);
        }

        function showInstantNetworkTracker() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        ⚡ 瞬時網絡追蹤器
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-bottom: 15px;">
                        [追蹤] 啟動即時 IP 鎖定...
                        <br>[節點 1] 入口節點: 192.168.1.100
                        <br>[節點 2] Proxy-層 1: 東京代理伺服器
                        <br>[節點 3] Proxy-層 2: 莫斯科中繼站
                        <br>[節點 4] VPN 出口: 冰島服務器
                        <br>[鎖定] 真實 IP: 追蹤成功！ ███████████ 100%
                    </div>
                    <div style="background: rgba(74, 144, 217, 0.1); border-left: 3px solid #4a90d9; padding: 10px;">
                        <strong>追蹤結果:</strong>
                        <ul style="margin: 8px 0 0 20px; color: #aaa;">
                            <li>真實位置: 上海，浦東新區</li>
                            <li>ISP: 中國移動</li>
                            <li>精確度: 99.7%</li>
                            <li>物理地址已鎖定，可進行取證</li>
                        </ul>
                    </div>
                </div>
            `;
            showStepModal('瞬時網絡追蹤器 ⚡', content, [{text: '鎖定位置', onclick: 'lockHackerLocation()'}, {text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function lockHackerLocation() {
            closeStepModal();
            addTerminalLine('[追蹤] 啟動瞬時網絡追蹤...', 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 25;
                addTerminalLine('[✓] 已鎖定黑客位置！', 'success');
                addTerminalLine('[位置] 上海浦東新區 - 精確度 99.7%', 'success');
                addTerminalLine('[行動] 可以啟動逮捕行動！', 'success');
                updateGameStats();
                showNotification('追蹤成功', '已鎖定黑客位置', 'success');
            }, 2500);
        }

        function showVulnerabilityScanner() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🔍 跨平台漏洞掃描器
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-bottom: 15px;">
                        [掃描] 檢查 Windows Server 2019...
                        <br>├─ 發現 5 個高危漏洞
                        <br>├─ CVE-2021-44228 (Log4j) - CRITICAL
                        <br>├─ CVE-2023-21674 (Windows Privilege Escalation) - HIGH
                        <br>[掃描] 檢查 Linux Ubuntu 20.04...
                        <br>├─ 發現 3 個高危漏洞
                        <br>[掃描] 檢查 macOS Ventura...
                        <br>├─ 發現 2 個中危漏洞
                    </div>
                    <div style="background: rgba(74, 144, 217, 0.1); border-left: 3px solid #4a90d9; padding: 10px;">
                        <strong>掃描摘要:</strong>
                        <ul style="margin: 8px 0 0 20px; color: #aaa;">
                            <li>🔴 高危: 10 個漏洞 - 立即修補</li>
                            <li>🟠 中危: 5 個漏洞 - 本周修補</li>
                            <li>🟡 低危: 8 個漏洞 - 預期修補</li>
                            <li>已生成修補報告</li>
                        </ul>
                    </div>
                </div>
            `;
            showStepModal('跨平台漏洞掃描器 🔍', content, [{text: '修補漏洞', onclick: 'patchVulnerabilities()'}, {text: '關閉', onclick: 'closeStepModal()'}]);
        }

        function patchVulnerabilities() {
            closeStepModal();
            addTerminalLine('[掃描] 啟動跨平台漏洞掃描...', 'command');
            addTerminalLine('[檢查] Windows Server - 發現 5 個高危漏洞', 'warning');
            addTerminalLine('[檢查] Linux Ubuntu - 發現 3 個高危漏洞', 'warning');
            setTimeout(() => {
                GameState.playerData.law_enforcement.security += 20;
                addTerminalLine('[✓] 已識別所有平台漏洞', 'success');
                addTerminalLine('[✓] 修補計劃已生成', 'success');
                addTerminalLine('[建議] 優先修補 CVE-2021-44228', 'info');
                updateGameStats();
                showNotification('掃描完成', '已識別並生成修補計劃', 'success');
            }, 2000);
        }

        function showTimelineAnalyzer() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        📅 時間軸分析器
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">選擇事件類型</label>
                        <select class="setting-input" id="timeline-type">
                            <option value="attack">攻擊事件</option>
                            <option value="network">網絡活動</option>
                            <option value="financial">金融交易</option>
                            <option value="communication">通訊記錄</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">時間範圍</label>
                        <input type="date" class="setting-input" id="timeline-start" value="2025-01-01">
                        <input type="date" class="setting-input" id="timeline-end" value="2025-01-28">
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px; margin-bottom: 15px;">
                        [準備] 時間軸數據尚未加載，請點擊「分析」開始
                    </div>
                </div>
            `;
            showStepModal('時間軸分析器 📅', content, [
                {text: '分析', onclick: 'analyzeTimeline()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function analyzeTimeline() {
            const type = document.getElementById('timeline-type')?.value || 'attack';
            const start = document.getElementById('timeline-start')?.value || '';
            const end = document.getElementById('timeline-end')?.value || '';
            closeStepModal();
            addTerminalLine(`[時間軸] 分析 ${type} 事件 (${start} 至 ${end})...`, 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 20;
                addTerminalLine('[✓] 已建立事件時間軸', 'success');
                addTerminalLine('[關聯] 發現 7 個相關事件', 'success');
                addTerminalLine('[因果] 確認攻擊發生順序', 'success');
                updateGameStats();
                showNotification('分析完成', '時間軸已建立', 'success');
            }, 2200);
        }

        function showSocialNetworkAnalysis() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🕸️ 社交網絡分析
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">目標用戶或組織</label>
                        <input type="text" class="setting-input" id="target-username" placeholder="輸入用戶名或組織代碼" value="hacker_group_2025">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">分析深度</label>
                        <select class="setting-input" id="network-depth">
                            <option value="1">一層 (直接聯繫)</option>
                            <option value="2" selected>兩層 (朋友的朋友)</option>
                            <option value="3">三層 (完整網絡)</option>
                        </select>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [準備] 網絡數據尚未加載，請點擊「掃描」開始
                    </div>
                </div>
            `;
            showStepModal('社交網絡分析 🕸️', content, [
                {text: '掃描', onclick: 'scanSocialNetwork()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function scanSocialNetwork() {
            const username = document.getElementById('target-username')?.value || 'unknown';
            const depth = document.getElementById('network-depth')?.value || '2';
            closeStepModal();
            addTerminalLine(`[網絡] 掃描 "${username}" 的社交網絡 (深度: ${depth}層)...`, 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 18;
                addTerminalLine('[✓] 已映射社交網絡', 'success');
                addTerminalLine('[節點] 發現 23 個關聯用戶', 'success');
                addTerminalLine('[關鍵] 發現 3 個核心成員', 'success');
                updateGameStats();
                showNotification('掃描完成', '社交網絡已映射', 'success');
            }, 2300);
        }

        function showGeoIPMapping() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🗺️ 地理定位追蹤
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">IP 地址或範圍</label>
                        <input type="text" class="setting-input" id="geoip-address" placeholder="e.g. 192.168.1.1" value="203.0.113.45">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">包含歷史軌跡</label>
                        <input type="checkbox" class="setting-input" id="geoip-history" checked style="width: auto;">
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [準備] 地理位置數據尚未加載
                    </div>
                </div>
            `;
            showStepModal('地理定位追蹤 🗺️', content, [
                {text: '追蹤', onclick: 'trackGeoIP()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function trackGeoIP() {
            const address = document.getElementById('geoip-address')?.value || 'unknown';
            closeStepModal();
            addTerminalLine(`[地理] 追蹤 IP: ${address}...`, 'command');
            addTerminalLine('[查詢] 連接到地理數據庫...', 'info');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 16;
                addTerminalLine('[✓] 位置已確定: 香港', 'success');
                addTerminalLine('[詳情] 座標: 22.3193°N, 114.1694°E', 'success');
                addTerminalLine('[ISP] 服務商: 香港寬頻', 'success');
                updateGameStats();
                showNotification('追蹤成功', '地理位置已確定', 'success');
            }, 2200);
        }

        function showTLSDecoder() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🔐 加密流量解碼模擬
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">加密協議</label>
                        <select class="setting-input" id="tls-protocol">
                            <option value="tls12">TLS 1.2</option>
                            <option value="tls13" selected>TLS 1.3</option>
                            <option value="ssl3">SSL 3.0 (已棄用)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">加密演算法</label>
                        <select class="setting-input" id="cipher-suite">
                            <option value="aes256">AES-256-GCM</option>
                            <option value="aes128">AES-128-GCM</option>
                            <option value="chacha">ChaCha20-Poly1305</option>
                        </select>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [準備] 流量解碼模擬已就緒
                    </div>
                </div>
            `;
            showStepModal('加密流量解碼模擬 🔐', content, [
                {text: '開始分析', onclick: 'analyzeTLSTraffic()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function analyzeTLSTraffic() {
            const protocol = document.getElementById('tls-protocol')?.value || 'tls13';
            const cipher = document.getElementById('cipher-suite')?.value || 'aes256';
            closeStepModal();
            addTerminalLine(`[TLS] 分析 ${protocol} 流量 (${cipher})...`, 'command');
            addTerminalLine('[握手] 監聽 TLS 握手過程...', 'info');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 17;
                addTerminalLine('[✓] 已捕獲加密握手', 'success');
                addTerminalLine('[分析] 識別密鑰交換方法', 'success');
                addTerminalLine('[模擬] 流量簽名分析完成', 'success');
                updateGameStats();
                showNotification('分析完成', 'TLS 流量已分析', 'success');
            }, 2400);
        }

        function showThreatIntelPanel() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #ff4444; font-weight: bold; margin-bottom: 15px;">
                        🚨 實時威脅情報面板
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="background: rgba(255, 68, 68, 0.1); border-left: 3px solid #ff4444; padding: 10px; margin-bottom: 10px;">
                            <strong style="color: #ff4444;">【致命】DDoS 攻擊</strong>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #aaa;">進行中 | 目標: API 伺服器 | 強度: 250Gbps</div>
                        </div>
                        <div style="background: rgba(255, 165, 0, 0.1); border-left: 3px solid #ffaa00; padding: 10px; margin-bottom: 10px;">
                            <strong style="color: #ffaa00;">【高度】勒索軟體活動</strong>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #aaa;">檢測到 | 變種: LockBit 3.0 | 受害組織: 5</div>
                        </div>
                        <div style="background: rgba(0, 200, 100, 0.1); border-left: 3px solid #00c864; padding: 10px;">
                            <strong style="color: #00c864;">【已修復】暗網市場關閉</strong>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #aaa;">已監控 | 市場名稱: Black Market 2.0 | 已破獲</div>
                        </div>
                    </div>
                </div>
            `;
            showStepModal('實時威脅情報面板 🚨', content, [
                {text: '刷新', onclick: 'refreshThreatIntel()'},
                {text: '關閉', onclick: 'closeStepModal()'}
            ]);
        }

        function refreshThreatIntel() {
            addTerminalLine('[威脅] 刷新實時威脅情報...', 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 10;
                addTerminalLine('[✓] 威脅情報已更新', 'success');
                updateGameStats();
                showNotification('更新完成', '威脅情報已更新', 'success');
                showThreatIntelPanel();
            }, 1200);
        }

        function showCVELookup() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        📚 CVE 查詢
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">搜尋 CVE 編號或關鍵字</label>
                        <input type="text" class="setting-input" id="cve-search" placeholder="e.g. CVE-2023-44487 或 Log4j" value="CVE-2023-44487">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">最小嚴重程度</label>
                        <select class="setting-input" id="cve-severity">
                            <option value="all">全部</option>
                            <option value="low">低度</option>
                            <option value="medium">中度</option>
                            <option value="high" selected>高度</option>
                            <option value="critical">致命</option>
                        </select>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [準備] CVE 數據庫已連接
                    </div>
                </div>
            `;
            showStepModal('CVE 查詢 📚', content, [
                {text: '搜尋', onclick: 'searchCVE()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function searchCVE() {
            const search = document.getElementById('cve-search')?.value || 'unknown';
            const severity = document.getElementById('cve-severity')?.value || 'all';
            closeStepModal();
            addTerminalLine(`[CVE] 搜尋: "${search}" (嚴重程度: ${severity})...`, 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 15;
                addTerminalLine('[✓] 找到 3 個相關漏洞', 'success');
                addTerminalLine('[詳情] CVE-2023-44487 - HTTP/2 快速重置攻擊 [高]', 'success');
                addTerminalLine('[詳情] CVE-2023-39615 - Nginx 內存洩露 [中]', 'success');
                updateGameStats();
                showNotification('查詢完成', '已找到相關漏洞', 'success');
            }, 1800);
        }

        function showSandboxAnalyzer() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🏜️ 惡意軟體沙箱
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">上傳檔案名稱</label>
                        <input type="text" class="setting-input" id="sandbox-filename" placeholder="e.g. malware.exe" value="suspicious_payload.exe">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">沙箱環境</label>
                        <select class="setting-input" id="sandbox-os">
                            <option value="win10">Windows 10</option>
                            <option value="win11" selected>Windows 11</option>
                            <option value="linux">Linux Ubuntu 22.04</option>
                        </select>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [準備] 沙箱環境已就緒
                    </div>
                </div>
            `;
            showStepModal('惡意軟體沙箱 🏜️', content, [
                {text: '執行分析', onclick: 'analyzeMalware()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function analyzeMalware() {
            const filename = document.getElementById('sandbox-filename')?.value || 'malware.exe';
            const os = document.getElementById('sandbox-os')?.value || 'win11';
            closeStepModal();
            addTerminalLine(`[沙箱] 上傳 "${filename}" 至 ${os} 沙箱...`, 'command');
            addTerminalLine('[執行] 啟動樣本分析...', 'info');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 22;
                addTerminalLine('[✓] 樣本已執行', 'success');
                addTerminalLine('[行為] 檢測到檔案系統修改', 'warning');
                addTerminalLine('[行為] 檢測到網絡連接嘗試', 'warning');
                addTerminalLine('[結論] 惡意軟體 - 分類: Trojan.Win32.Generic', 'alert');
                updateGameStats();
                showNotification('分析完成', '惡意軟體已分類', 'success');
            }, 2600);
        }

        function showAIAttackMatcher() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🤖 AI 攻擊模式匹配
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">攻擊指標 (IOC)</label>
                        <textarea class="setting-input" id="ai-ioc" style="height: 80px;" placeholder="輸入 IP、域名或文件哈希">203.0.113.45
example-malware.com
d41d8cd98f00b204e9800998ecf8427e</textarea>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">攻擊框架</label>
                        <select class="setting-input" id="ai-framework">
                            <option value="mitre">MITRE ATT&CK</option>
                            <option value="kill">Kill Chain</option>
                            <option value="cyber" selected>網絡殺傷鏈</option>
                        </select>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [準備] AI 模型已加載
                    </div>
                </div>
            `;
            showStepModal('AI 攻擊模式匹配 🤖', content, [
                {text: '匹配', onclick: 'matchAttackPattern()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function matchAttackPattern() {
            closeStepModal();
            addTerminalLine('[AI] 啟動攻擊模式匹配...', 'command');
            addTerminalLine('[ML] 分析 IOC 指標...', 'info');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 21;
                addTerminalLine('[✓] 已識別攻擊類型', 'success');
                addTerminalLine('[模式] 匹配到已知 APT 攻擊組織', 'warning');
                addTerminalLine('[評分] 相似度: 89.7%', 'success');
                addTerminalLine('[推薦] 可能與 APT28 相關', 'alert');
                updateGameStats();
                showNotification('匹配完成', '攻擊模式已識別', 'success');
            }, 2500);
        }

        function showForensicToolkit() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🖥️ 數位鑑識工具套件
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">選擇鑑識方法</label>
                        <select class="setting-input" id="forensic-method">
                            <option value="disk">硬碟映像取證</option>
                            <option value="memory" selected>記憶體轉儲分析</option>
                            <option value="network">網絡封包分析</option>
                            <option value="registry">系統登錄分析</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">目標裝置</label>
                        <input type="text" class="setting-input" id="forensic-device" placeholder="e.g. /dev/sda1 或 C:" value="E:">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">輸出格式</label>
                        <select class="setting-input" id="forensic-format">
                            <option value="dd">DD 格式 (.dd)</option>
                            <option value="ewf" selected>EWF 格式 (.E01)</option>
                            <option value="raw">Raw 格式 (.raw)</option>
                        </select>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [準備] 鑑識工具套件已加載
                    </div>
                </div>
            `;
            showStepModal('數位鑑識工具套件 🖥️', content, [
                {text: '開始採集', onclick: 'startForensicCollection()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function startForensicCollection() {
            const method = document.getElementById('forensic-method')?.value || 'memory';
            const device = document.getElementById('forensic-device')?.value || 'unknown';
            const format = document.getElementById('forensic-format')?.value || 'ewf';
            closeStepModal();
            addTerminalLine(`[鑑識] 開始 ${method} 採集 (裝置: ${device}, 格式: ${format})...`, 'command');
            addTerminalLine('[準備] 正在初始化採集引擎...', 'info');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 25;
                addTerminalLine('[✓] 採集完成', 'success');
                addTerminalLine(`[大小] 採集文件: forensic_image_${Date.now()}.${format.toLowerCase()}`, 'success');
                addTerminalLine('[哈希] SHA-256: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6', 'success');
                addTerminalLine('[狀態] 證據完整性已驗證', 'success');
                updateGameStats();
                showNotification('採集完成', '數位證據已採集', 'success');
            }, 3000);
        }

        function showChainOfCustody() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        🔗 取證鏈管理系統
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">證據編號</label>
                        <input type="text" class="setting-input" id="evidence-number" placeholder="自動生成" readonly value="EV-${Math.floor(Math.random()*900000+100000)}">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">證據描述</label>
                        <textarea class="setting-input" id="evidence-description" style="height: 80px;" placeholder="詳細記錄證據信息">硬碟映像檔案 - 懷疑包含非法活動證據</textarea>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">移交人</label>
                        <input type="text" class="setting-input" id="custody-handler" placeholder="例: Officer Smith" value="法醫技術員">
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [系統] 取證鏈記錄系統已準備就緒
                    </div>
                </div>
            `;
            showStepModal('取證鏈管理系統 🔗', content, [
                {text: '建檔', onclick: 'createCustodyRecord()'},
                {text: '查詢記錄', onclick: 'queryCustodyLog()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function createCustodyRecord() {
            const evidNum = document.getElementById('evidence-number')?.value || 'unknown';
            const desc = document.getElementById('evidence-description')?.value || '';
            const handler = document.getElementById('custody-handler')?.value || 'unknown';
            closeStepModal();
            addTerminalLine(`[取證鏈] 建檔證據: ${evidNum}...`, 'command');
            addTerminalLine(`[描述] ${desc}`, 'info');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 12;
                addTerminalLine('[✓] 取證鏈記錄已建檔', 'success');
                addTerminalLine(`[編號] 證據編號: ${evidNum}`, 'success');
                addTerminalLine(`[移交人] ${handler} | 時間: ${new Date().toLocaleString('zh-HK')}`, 'success');
                addTerminalLine('[狀態] 完整性鏈已生成', 'success');
                updateGameStats();
                showNotification('記錄建檔', '取證鏈記錄已完成', 'success');
            }, 1800);
        }

        function queryCustodyLog() {
            closeStepModal();
            addTerminalLine('[查詢] 正在檢索取證鏈記錄...', 'command');
            setTimeout(() => {
                addTerminalLine('[記錄 1] EV-284756 - 硬碟映像 | 2025-01-28 14:30 | 採集者: Tech Team', 'info');
                addTerminalLine('[記錄 2] EV-284756 - 轉移至鑑識部門 | 2025-01-28 15:00 | 移交人: Officer Chen', 'info');
                addTerminalLine('[記錄 3] EV-284756 - 法庭提交 | 2025-01-28 16:30 | 提交人: Attorney Lee', 'success');
                addTerminalLine('[✓] 所有操作已審計記錄', 'success');
                showNotification('查詢完成', '取證鏈記錄已顯示', 'success');
            }, 1500);
        }

        function showLegalDocGenerator() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        📋 法律文書生成器
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">文書類型</label>
                        <select class="setting-input" id="doc-type">
                            <option value="warrant" selected>搜索令申請書</option>
                            <option value="arrest">逮捕令</option>
                            <option value="affidavit">誓詞書 (Affidavit)</option>
                            <option value="subpoena">傳票 (Subpoena)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">申請人</label>
                        <input type="text" class="setting-input" id="applicant-name" placeholder="例: Detective Smith" value="警官陳">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">案件編號</label>
                        <input type="text" class="setting-input" id="case-number" placeholder="例: CASE-2025-001" value="CASE-2025-001">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">理由/依據</label>
                        <textarea class="setting-input" id="doc-reason" style="height: 80px;" placeholder="詳細說明申請理由">懷疑嫌疑人進行非法網絡活動，需要搜索其電子設備以獲取證據</textarea>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [系統] 法律文書模板已加載
                    </div>
                </div>
            `;
            showStepModal('法律文書生成器 📋', content, [
                {text: '生成文書', onclick: 'generateLegalDocument()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function generateLegalDocument() {
            const docType = document.getElementById('doc-type')?.value || 'warrant';
            const applicant = document.getElementById('applicant-name')?.value || 'unknown';
            const caseNum = document.getElementById('case-number')?.value || 'unknown';
            closeStepModal();
            
            const docTypeLabel = {warrant: '搜索令', arrest: '逮捕令', affidavit: '誓詞書', subpoena: '傳票'}[docType];
            addTerminalLine(`[生成] 正在生成 ${docTypeLabel}...`, 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 18;
                const docName = `${docType}_${caseNum}_${Date.now()}.pdf`;
                addTerminalLine('[✓] 文書已生成', 'success');
                addTerminalLine(`[檔案] ${docName}`, 'success');
                addTerminalLine(`[申請人] ${applicant}`, 'success');
                addTerminalLine('[狀態] 文書已準備好提交法院', 'success');
                updateGameStats();
                showNotification('生成完成', `${docTypeLabel}已生成`, 'success');
            }, 2200);
        }

        function showWitnessManagement() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        👥 證人/線人管理系統
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">管理操作</label>
                        <select class="setting-input" id="witness-action">
                            <option value="add" selected>新增證人/線人</option>
                            <option value="view">查詢記錄</option>
                            <option value="schedule">安排作證</option>
                            <option value="protection">證人保護計劃</option>
                        </select>
                    </div>
                    <div id="witness-form" style="display: block;">
                        <div class="setting-group">
                            <label class="setting-label">姓名</label>
                            <input type="text" class="setting-input" id="witness-name" placeholder="例: John Doe">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">身份</label>
                            <select class="setting-input" id="witness-type">
                                <option value="witness">目擊證人</option>
                                <option value="informant">線人</option>
                                <option value="expert">專家證人</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">聯絡方式</label>
                            <input type="text" class="setting-input" id="witness-contact" placeholder="電話或電郵">
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">案件關聯</label>
                            <input type="text" class="setting-input" id="witness-case" placeholder="案件編號" value="CASE-2025-001">
                        </div>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [系統] 證人管理系統已初始化
                    </div>
                </div>
            `;
            showStepModal('證人/線人管理系統 👥', content, [
                {text: '提交', onclick: 'submitWitnessInfo()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function submitWitnessInfo() {
            const action = document.getElementById('witness-action')?.value || 'add';
            const name = document.getElementById('witness-name')?.value || 'unknown';
            const type = document.getElementById('witness-type')?.value || 'witness';
            const contact = document.getElementById('witness-contact')?.value || 'unknown';
            const caseNum = document.getElementById('witness-case')?.value || 'unknown';
            
            closeStepModal();
            
            if (action === 'add') {
                addTerminalLine(`[註冊] 新增 ${type === 'witness' ? '證人' : type === 'informant' ? '線人' : '專家證人'}: ${name}...`, 'command');
                setTimeout(() => {
                    GameState.playerData.law_enforcement.investigationProgress += 14;
                    const witnessId = 'WIT-' + Math.floor(Math.random()*900000+100000);
                    addTerminalLine('[✓] 證人已登記', 'success');
                    addTerminalLine(`[編號] ${witnessId}`, 'success');
                    addTerminalLine(`[案件] ${caseNum}`, 'success');
                    addTerminalLine('[狀態] 記錄已加入系統', 'success');
                    updateGameStats();
                    showNotification('登記完成', '證人/線人已登記', 'success');
                }, 1800);
            } else if (action === 'view') {
                addTerminalLine('[查詢] 檢索證人記錄...', 'command');
                setTimeout(() => {
                    addTerminalLine('[記錄 1] WIT-512847 - John Doe (目擊證人) | CASE-2025-001', 'info');
                    addTerminalLine('[記錄 2] WIT-512848 - Jane Smith (線人) | CASE-2025-001', 'info');
                    addTerminalLine('[✓] 共 2 筆相關記錄', 'success');
                    showNotification('查詢完成', '證人記錄已顯示', 'success');
                }, 1200);
            } else if (action === 'schedule') {
                addTerminalLine('[安排] 為證人安排作證時間...', 'command');
                setTimeout(() => {
                    addTerminalLine('[法庭] 香港高等法院 - 法庭 3 號', 'success');
                    addTerminalLine('[日期] 2025-02-15 10:00 AM', 'success');
                    addTerminalLine('[通知] 已發送傳票至證人', 'success');
                    showNotification('安排完成', '作證時間已排定', 'success');
                }, 1500);
            } else if (action === 'protection') {
                addTerminalLine('[保護] 啟動證人保護計劃...', 'command');
                setTimeout(() => {
                    addTerminalLine('[安排] 臨時住所已預訂', 'success');
                    addTerminalLine('[警衛] 24小時安全護衛已部署', 'success');
                    addTerminalLine('[身份] 臨時身份已準備', 'success');
                    showNotification('保護就位', '證人保護計劃已啟動', 'success');
                }, 1800);
            }
        }

        function showCaseManagement() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        📁 案件管理系統
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">操作類型</label>
                        <select class="setting-input" id="case-operation">
                            <option value="create" selected>建檔新案件</option>
                            <option value="view">查詢案件</option>
                            <option value="update">更新進度</option>
                            <option value="reassign">重新分配優先級</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">案件名稱/編號</label>
                        <input type="text" class="setting-input" id="case-name" placeholder="e.g. 網絡詐騙案件-2025" value="CASE-2025-001">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">優先級</label>
                        <select class="setting-input" id="case-priority">
                            <option value="low">低 (3 天內結案)</option>
                            <option value="medium" selected>中 (24 小時內結案)</option>
                            <option value="high">高 (立即行動)</option>
                            <option value="critical">致命 (總監直接監督)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">主要調查員</label>
                        <input type="text" class="setting-input" id="case-lead" placeholder="例: Detective Chen" value="Detective Chen">
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [系統] 案件管理系統已初始化
                    </div>
                </div>
            `;
            showStepModal('案件管理系統 📁', content, [
                {text: '提交', onclick: 'submitCaseManagement()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function submitCaseManagement() {
            const operation = document.getElementById('case-operation')?.value || 'create';
            const caseName = document.getElementById('case-name')?.value || 'unknown';
            const priority = document.getElementById('case-priority')?.value || 'medium';
            const lead = document.getElementById('case-lead')?.value || 'unknown';
            closeStepModal();
            
            if (operation === 'create') {
                addTerminalLine(`[案件] 建檔新案件: ${caseName}...`, 'command');
                addTerminalLine(`[優先級] ${priority.toUpperCase()}`, 'info');
                setTimeout(() => {
                    GameState.playerData.law_enforcement.investigationProgress += 10;
                    const caseId = 'CASE-' + Math.floor(Math.random()*900000+100000);
                    addTerminalLine('[✓] 案件已建檔', 'success');
                    addTerminalLine(`[編號] ${caseId}`, 'success');
                    addTerminalLine(`[主控] ${lead}`, 'success');
                    updateGameStats();
                    showNotification('建檔完成', '新案件已建檔', 'success');
                }, 1500);
            } else if (operation === 'view') {
                addTerminalLine('[查詢] 檢索案件列表...', 'command');
                setTimeout(() => {
                    addTerminalLine('[案件 1] CASE-2025-001 - 網絡詐騙 | 優先級: 高 | 進度: 75%', 'info');
                    addTerminalLine('[案件 2] CASE-2025-002 - 駭客入侵 | 優先級: 致命 | 進度: 90%', 'info');
                    addTerminalLine('[案件 3] CASE-2025-003 - 數據竊取 | 優先級: 中 | 進度: 40%', 'info');
                    addTerminalLine('[✓] 共 3 筆活躍案件', 'success');
                    showNotification('查詢完成', '案件清單已顯示', 'success');
                }, 1200);
            } else if (operation === 'update') {
                addTerminalLine(`[更新] 更新 ${caseName} 進度...`, 'command');
                setTimeout(() => {
                    GameState.playerData.law_enforcement.investigationProgress += 8;
                    addTerminalLine('[✓] 進度已更新: 85%', 'success');
                    addTerminalLine('[狀態] 等待法庭審裁', 'success');
                    updateGameStats();
                    showNotification('更新完成', '案件進度已更新', 'success');
                }, 1300);
            } else if (operation === 'reassign') {
                addTerminalLine(`[重新分配] 優先級改為: ${priority}...`, 'command');
                setTimeout(() => {
                    addTerminalLine('[✓] 優先級已變更', 'success');
                    addTerminalLine('[通知] 已通知所有相關人員', 'success');
                    showNotification('分配完成', '優先級已重新分配', 'success');
                }, 1200);
            }
        }

        function showTaskDispatch() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        ✓ 任務分派機制
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">任務類型</label>
                        <select class="setting-input" id="task-type">
                            <option value="evidence">證據蒐集</option>
                            <option value="interview" selected>證人訊問</option>
                            <option value="surveillance">監視跟蹤</option>
                            <option value="analysis">數據分析</option>
                            <option value="report">報告撰寫</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">分配給</label>
                        <select class="setting-input" id="task-assignee">
                            <option value="chen">陳警官</option>
                            <option value="lee" selected>李警官</option>
                            <option value="wang">王警官</option>
                            <option value="team">專案小組</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">截止日期</label>
                        <input type="date" class="setting-input" id="task-deadline" value="2025-02-15">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">優先級</label>
                        <select class="setting-input" id="task-priority">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-top: 15px;">
                        [系統] 任務分派系統已準備就緒
                    </div>
                </div>
            `;
            showStepModal('任務分派機制 ✓', content, [
                {text: '分派', onclick: 'submitTaskDispatch()'},
                {text: '查詢任務', onclick: 'queryTasks()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function submitTaskDispatch() {
            const taskType = document.getElementById('task-type')?.value || 'analysis';
            const assignee = document.getElementById('task-assignee')?.value || 'lee';
            const deadline = document.getElementById('task-deadline')?.value || '';
            closeStepModal();
            addTerminalLine(`[分派] 分派 ${taskType} 任務給 ${assignee}...`, 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 12;
                const taskId = 'TASK-' + Math.floor(Math.random()*900000+100000);
                addTerminalLine('[✓] 任務已分派', 'success');
                addTerminalLine(`[編號] ${taskId}`, 'success');
                addTerminalLine(`[截止] ${deadline}`, 'success');
                addTerminalLine('[通知] 已發送任務通知', 'success');
                updateGameStats();
                showNotification('分派完成', '任務已分派', 'success');
            }, 1600);
        }

        function queryTasks() {
            closeStepModal();
            addTerminalLine('[查詢] 檢索進行中的任務...', 'command');
            setTimeout(() => {
                addTerminalLine('[任務 1] TASK-512847 - 證人訊問 | 指派: 李警官 | 進度: 60%', 'info');
                addTerminalLine('[任務 2] TASK-512848 - 監視跟蹤 | 指派: 陳警官 | 進度: 40%', 'info');
                addTerminalLine('[任務 3] TASK-512849 - 數據分析 | 指派: 王警官 | 進度: 80%', 'info');
                addTerminalLine('[✓] 共 3 筆進行中任務', 'success');
                showNotification('查詢完成', '任務清單已顯示', 'success');
            }, 1300);
        }

        function showTimelineVisualization() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        📊 調查時間線視覺化
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">檢視方式</label>
                        <select class="setting-input" id="timeline-view">
                            <option value="gantt" selected>甘特圖</option>
                            <option value="timeline">時間軸</option>
                            <option value="milestone">里程碑</option>
                            <option value="dependency">任務依賴</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">時間範圍</label>
                        <select class="setting-input" id="timeline-range">
                            <option value="week">本週</option>
                            <option value="month" selected>本月</option>
                            <option value="quarter">本季</option>
                            <option value="custom">自訂範圍</option>
                        </select>
                    </div>
                    <div style="background: rgba(74, 144, 217, 0.1); border-left: 3px solid #4a90d9; padding: 10px; margin-top: 15px;">
                        <div style="font-size: 0.85rem; color: #aaa;">
                            <div style="margin-bottom: 8px;">📅 <strong>時間軸示例:</strong></div>
                            <div>▓▓▓▓▓░░ 證據蒐集 (2025-01-28 ~ 2025-02-05) 75%</div>
                            <div>░░░░░░░░ 證人訊問 (2025-02-06 ~ 2025-02-15) 0%</div>
                            <div>░░░░░░░░ 數據分析 (2025-02-16 ~ 2025-02-28) 0%</div>
                        </div>
                    </div>
                </div>
            `;
            showStepModal('調查時間線視覺化 📊', content, [
                {text: '生成視圖', onclick: 'generateTimelineView()'},
                {text: '導出報告', onclick: 'exportTimeline()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function generateTimelineView() {
            const view = document.getElementById('timeline-view')?.value || 'gantt';
            closeStepModal();
            addTerminalLine(`[視覺化] 生成 ${view} 視圖...`, 'command');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 14;
                addTerminalLine('[✓] 視圖已生成', 'success');
                addTerminalLine('[進度] 整體案件進度: 65%', 'success');
                addTerminalLine('[關鍵路徑] 證人訊問為下一個關鍵步驟', 'success');
                updateGameStats();
                showNotification('生成完成', '時間線視圖已生成', 'success');
            }, 1800);
        }

        function exportTimeline() {
            closeStepModal();
            addTerminalLine('[導出] 正在導出時間線報告...', 'command');
            setTimeout(() => {
                addTerminalLine('[✓] 報告已生成', 'success');
                addTerminalLine('[檔案] investigation_timeline_' + Date.now() + '.pdf', 'success');
                addTerminalLine('[大小] 2.3 MB', 'success');
                showNotification('導出完成', '時間線報告已導出', 'success');
            }, 1500);
        }

        function showReportTemplate() {
            const content = `
                <div class="setup-section" style="max-height: 500px; overflow-y: auto;">
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 15px;">
                        📋 報告模板庫
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">報告類型</label>
                        <select class="setting-input" id="report-type">
                            <option value="investigation" selected>調查報告</option>
                            <option value="summary">案件摘要</option>
                            <option value="forensic">鑑識報告</option>
                            <option value="court">法庭陳述書</option>
                            <option value="progress">進度報告</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">案件編號</label>
                        <input type="text" class="setting-input" id="report-case" placeholder="e.g. CASE-2025-001" value="CASE-2025-001">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">起草人</label>
                        <input type="text" class="setting-input" id="report-author" placeholder="例: Detective Chen" value="Detective Chen">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">包含內容</label>
                        <div style="margin-top: 8px;">
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" checked style="margin-right: 5px;"> 案件背景
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" checked style="margin-right: 5px;"> 調查過程
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" checked style="margin-right: 5px;"> 證據清單
                            </label>
                            <label style="display: block; margin: 5px 0;">
                                <input type="checkbox" style="margin-right: 5px;"> 建議措施
                            </label>
                        </div>
                    </div>
                </div>
            `;
            showStepModal('報告模板庫 📋', content, [
                {text: '生成報告', onclick: 'generateReport()'},
                {text: '查詢範本', onclick: 'queryTemplates()'},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function generateReport() {
            const reportType = document.getElementById('report-type')?.value || 'investigation';
            const caseNum = document.getElementById('report-case')?.value || 'unknown';
            const author = document.getElementById('report-author')?.value || 'unknown';
            closeStepModal();
            addTerminalLine(`[報告] 生成 ${reportType} 類型報告...`, 'command');
            addTerminalLine(`[案件] ${caseNum} | [作者] ${author}`, 'info');
            setTimeout(() => {
                GameState.playerData.law_enforcement.investigationProgress += 16;
                const reportId = 'RPT-' + Math.floor(Math.random()*900000+100000);
                addTerminalLine('[✓] 報告已生成', 'success');
                addTerminalLine(`[編號] ${reportId}`, 'success');
                addTerminalLine('[格式] PDF | Word | 列印版本', 'success');
                addTerminalLine('[狀態] 準備簽核和提交', 'success');
                updateGameStats();
                showNotification('生成完成', '調查報告已生成', 'success');
            }, 2000);
        }

        function queryTemplates() {
            closeStepModal();
            addTerminalLine('[查詢] 檢索可用報告模板...', 'command');
            setTimeout(() => {
                addTerminalLine('[模板 1] 標準調查報告 (10 頁) - 適用於大多數案件', 'info');
                addTerminalLine('[模板 2] 快速摘要 (2 頁) - 用於初步報告', 'info');
                addTerminalLine('[模板 3] 法庭陳述書 (15 頁) - 用於訴訟', 'info');
                addTerminalLine('[模板 4] 進度報告 (5 頁) - 用於定期更新', 'info');
                addTerminalLine('[✓] 共 4 個標準模板可用', 'success');
                showNotification('查詢完成', '模板清單已顯示', 'success');
            }, 1400);
        }

        // ===== 共用功能實作 =====

        function showVPNSettings() {
            const content = `
                <div class="setup-section">
                    <div class="terminal-output" style="color: #4a90d9; font-size: 0.85rem; margin-bottom: 10px;">
                        [VPN] 當前連線狀態: 已連接
                        <br>[速度] 連線速度: 98 Mbps
                        <br>[安全] 加密強度: AES-256
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">VPN 強度選擇</label>
                        <select class="setting-input" id="vpn-strength">
                            <option value="basic">基礎保護 (快速/中等安全)</option>
                            <option value="standard" selected>標準保護 (平衡)</option>
                            <option value="military">軍事級加密 (慢速/最高安全)</option>
                        </select>
                    </div>
                </div>
            `;
            
            showStepModal('VPN 保障設定 🔒', content, [
                {text: '應用設定', onclick: `applyVPNSettings()`},
                {text: '取消', onclick: 'closeStepModal()'}
            ]);
        }

        function applyVPNSettings() {
            const strength = document.getElementById('vpn-strength')?.value || 'standard';
            closeStepModal();
            addTerminalLine(`[VPN] 應用 ${strength} 保護設定...`, 'command');
            
            setTimeout(() => {
                GameState.playerData[GameState.currentRole].security += 15;
                addTerminalLine(`[✓] VPN 保護已應用 (安全性 +15%)`, 'success');
                updateGameStats();
                showNotification('VPN 成功', '保護設定已應用', 'success');
            }, 1000);
        }
    
        // ===== 優化功能實作 =====
        
        // 協作面板控制
        function openCollabPanel() {
            const overlay = document.getElementById('collaboration-overlay');
            overlay.style.display = 'flex';
            updateCollabUI();
        }

        function closeCollabPanel() {
            document.getElementById('collaboration-overlay').style.display = 'none';
        }

        function updateCollabUI() {
            const role = GameState.currentRole;
            const team = GameState.aiTeams[role];
            
            // 更新成員列表
            const memberList = document.getElementById('collab-member-list');
            memberList.innerHTML = team.members.map(m => `
                <div class="member-item">
                    <div class="member-info">
                        <div class="member-status-dot ${m.status === 'active' ? 'status-online' : 'status-busy'}"></div>
                        <span>${m.name}</span>
                    </div>
                    <span style="font-size:0.8rem; color:#888;">${m.role}</span>
                </div>
            `).join('');

            // 更新任務列表
            const taskList = document.getElementById('collab-task-list');
            const tasks = [
                { name: '數據包攔截', progress: 65 },
                { name: '系統漏洞掃描', progress: 30 },
                { name: '加密協議破解', progress: 10 }
            ];
            taskList.innerHTML = tasks.map(t => `
                <div class="task-item">
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                        <span>${t.name}</span>
                        <span>${t.progress}%</span>
                    </div>
                    <div class="task-progress-container">
                        <div class="task-progress-fill" style="width: ${t.progress}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function executeCollabAction() {
            closeCollabPanel();
            showToolFeedback('跨部門聯合行動', ['同步時鐘', '分配目標', '啟動攔截', '完成'], () => {
                addTerminalLine('[協作] 聯合行動執行成功！所有部門效率提升 25%', 'success');
                showNotification('協作成功', '跨部門聯合行動已生效', 'success');
            });
        }

        // 網絡分析儀表板
        let dashboardInterval;
        function initNetworkDashboard() {
            const dashboard = document.getElementById('network-dashboard');
            dashboard.style.display = 'flex';
            
            const chart = document.getElementById('traffic-chart');
            chart.innerHTML = Array(20).fill(0).map(() => '<div class="traffic-bar" style="height: 5px"></div>').join('');
            
            if (dashboardInterval) clearInterval(dashboardInterval);
            dashboardInterval = setInterval(updateDashboardData, 1000);
        }

        function updateDashboardData() {
            const bars = document.querySelectorAll('.traffic-bar');
            bars.forEach((bar, i) => {
                if (i < bars.length - 1) {
                    bar.style.height = bars[i+1].style.height;
                } else {
                    const h = Math.random() * 80 + 10;
                    bar.style.height = h + '%';
                }
            });

            document.getElementById('inbound-traffic').textContent = (Math.random() * 500 + 100).toFixed(1) + ' KB/s';
            document.getElementById('outbound-traffic').textContent = (Math.random() * 200 + 50).toFixed(1) + ' KB/s';
            if (Math.random() < 0.1) {
                const count = document.getElementById('anomaly-count');
                count.textContent = parseInt(count.textContent) + 1;
            }
        }

        function toggleDashboardMin() {
            const content = document.querySelector('.dashboard-content');
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }

        // 工具執行視覺反饋
        function showToolFeedback(name, steps, callback) {
            const overlay = document.getElementById('tool-executing-overlay');
            const nameEl = document.getElementById('tool-executing-name');
            const statusEl = document.getElementById('tool-executing-status');
            const progressEl = document.getElementById('tool-executing-progress');
            
            overlay.style.display = 'block';
            nameEl.textContent = name;
            
            let currentStep = 0;
            const totalSteps = steps.length;
            
            const interval = setInterval(() => {
                if (currentStep >= totalSteps) {
                    clearInterval(interval);
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        if (callback) callback();
                    }, 500);

        // ===== 初始化優化功能 =====
        function initializeOptimizations() {
            // 初始化漢堡菜單
            const hamburger = document.getElementById('hamburger-menu');
            const mobileMenu = document.getElementById('nav-menu-mobile');
            
            if (hamburger && mobileMenu) {
                console.log('✓ 漢堡菜單已初始化');
            }

            // 初始化新頁面
            const newPages = ['darknet-hub-page', 'guide-page', 'shop-page'];
            newPages.forEach(pageId => {
                const page = document.getElementById(pageId);
                if (page) {
                    console.log(`✓ 頁面 ${pageId} 已初始化`);
                }
            });

            // 初始化商店
            if (document.getElementById('shop-items-display')) {
                populateShopItems();
                console.log('✓ 商店已初始化');
            }
        }

        // 在頁面加載完成後初始化
        window.addEventListener('load', function() {
            setTimeout(initializeOptimizations, 500);
        });
                    return;
                }
                
                statusEl.textContent = steps[currentStep] + '...';
                const progress = ((currentStep + 1) / totalSteps) * 100;
                progressEl.style.width = progress + '%';
                
                currentStep++;
            }, 800);
        }

        // 修改原有的 useTool 函數以整合視覺反饋
        const originalUseTool = useTool;
        useTool = function(toolId, toolData) {
            // 確保 toolData 存在，如果不存在則嘗試從 GameState 中查找
            let tool = toolData;
            if (!tool) {
                const role = GameState.currentRole;
                // 從各個可能的工具庫中查找
                for (const cat in GameState.tools[role]) {
                    const found = GameState.tools[role][cat].find(t => t.id === toolId);
                    if (found) { tool = found; break; }
                }
                if (!tool && GameState.specialSkills[role][toolId]) {
                    tool = GameState.specialSkills[role][toolId];
                }
            }
            
            if (!tool) {
                console.error("Tool not found:", toolId);
                return originalUseTool(toolId, toolData);
            }

            // 針對特定工具顯示視覺反饋
            if (toolId === 'network_mapping' || toolId === 'network_monitor' || toolId === 'network_scanner') {
                showToolFeedback(tool.name, ['掃描端口', '分析流量', '繪製拓撲', '完成'], () => {
                    initNetworkDashboard();
                    originalUseTool(toolId, tool);
                });
            } else if (toolId === 'department_coord' || toolId === 'command_panel' || toolId === 'department_sync') {
                showToolFeedback(tool.name, ['建立加密頻道', '同步部門數據', '授權訪問', '完成'], () => {
                    openCollabPanel();
                    originalUseTool(toolId, tool);
                });
            } else if (toolId === 'forensics_kit' || toolId === 'data_recovery') {
                showToolFeedback(tool.name, ['掃描磁區', '提取特徵碼', '重組數據', '完成'], () => {
                    originalUseTool(toolId, tool);
                });
            } else {
                // 通用工具反饋
                showToolFeedback(tool.name, ['初始化', '執行中', '完成'], () => {
                    originalUseTool(toolId, tool);
                });
            }
        };
    
    </script>

    <div id="fullscreen-command-hub">
        <div class="hub-header">
            <div style="display:flex; align-items:center; gap:20px;">
                <button class="back-btn" onclick="closeFullscreenHub()">
                    <i class="fas fa-arrow-left"></i> 返回上一頁
                </button>
                <h1 id="hub-main-title" style="font-size:1.8rem; letter-spacing:3px; color:#fff;">系統操作艙</h1>
            </div>
            <div id="hub-security-indicator"></div>
        </div>

        <div class="hub-main">
            <!-- 左側：自我設備狀態 -->
            <div class="hub-panel">
                <div class="hub-title"><i class="fas fa-microchip"></i> 本地設備實時狀態</div>
                <div class="status-grid" id="local-device-status">
                    <!-- 動態填充 -->
                </div>
                <div style="margin-top:20px; flex:1;">
                    <div class="hub-title" style="font-size:1rem;"><i class="fas fa-project-diagram"></i> 資源佔用率</div>
                    <canvas id="resource-chart" style="width:100%; height:150px;"></canvas>
                </div>
            </div>

            <!-- 中間：功能設定區 -->
            <div class="hub-panel" style="background: rgba(10, 10, 30, 0.8);">
                <div class="hub-title"><i class="fas fa-sliders-h"></i> 執行參數校準</div>
                <div id="hub-config-content" style="overflow-y:auto; padding-right:10px;">
                    <!-- 動態填充 -->
                </div>
                <button id="hub-execute-btn" class="execute-btn-large">確認並啟動執行序列</button>
            </div>

            <!-- 右側：對手網絡活動監控 -->
            <div class="hub-panel">
                <div class="hub-title"><i class="fas fa-satellite-dish"></i> 對手網絡活動監控</div>
                <div id="opponent-activity-log" style="font-size:0.8rem; color:#aaa; flex:1; overflow-y:auto; background:rgba(0,0,0,0.4); padding:10px; border-radius:5px;">
                    <!-- 動態填充 -->
                </div>
                <div style="margin-top:20px;">
                    <div class="hub-title" style="font-size:1rem;"><i class="fas fa-shield-alt"></i> 聯動預期影響</div>
                    <div id="impact-preview" style="font-size:0.85rem; color:#4a90d9; padding:10px; border:1px dashed #4a90d9;">
                        等待參數設定...
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!-- 協作工具跨部門面板 -->
    <div id="collaboration-overlay" class="collaboration-overlay">
        <div class="collaboration-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-users-cog"></i>
                    <span id="collab-panel-title">跨部門協作指揮中心</span>
                </div>
                <i class="fas fa-times close-panel" onclick="closeCollabPanel()"></i>
            </div>
            <div class="collab-grid">
                <div class="collab-section">
                    <div class="section-title"><i class="fas fa-user-friends"></i> 在線成員</div>
                    <div id="collab-member-list" class="member-list">
                        <!-- 動態生成 -->
                    </div>
                </div>
                <div class="collab-section">
                    <div class="section-title"><i class="fas fa-tasks"></i> 當前任務分配</div>
                    <div id="collab-task-list" class="task-list">
                        <!-- 動態生成 -->
                    </div>
                </div>
            </div>
            <div style="margin-top: 25px; text-align: right;">
                <button class="node-action-btn" onclick="executeCollabAction()">啟動聯合行動</button>
            </div>
        </div>
    </div>

    <!-- 網絡分析儀表板 -->
    <div id="network-dashboard" class="network-dashboard">
        <div class="dashboard-header">
            <span><i class="fas fa-chart-line"></i> 實時網絡分析</span>
            <i class="fas fa-minus" style="cursor:pointer" onclick="toggleDashboardMin()"></i>
        </div>
        <div class="dashboard-content">
            <div id="traffic-chart" class="traffic-chart"></div>
            <div class="stat-row">
                <span class="stat-label">入站流量</span>
                <span id="inbound-traffic" class="stat-value">0 KB/s</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">出站流量</span>
                <span id="outbound-traffic" class="stat-value">0 KB/s</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">異常連接</span>
                <span id="anomaly-count" class="stat-value" style="color:#ff3333">0</span>
            </div>
        </div>
    </div>

    <!-- 工具執行視覺反饋 -->
    <div id="tool-executing-overlay" class="tool-executing-overlay">
        <div class="tool-spinner"></div>
        <div id="tool-executing-name" style="font-size: 1.2rem; margin-bottom: 10px; color: #4a90d9;">正在執行工具...</div>
        <div class="progress-bar-container">
            <div id="tool-executing-progress" class="progress-bar-fill" style="width: 0%"></div>
        </div>
        <div id="tool-executing-status" style="font-size: 0.9rem; color: #888; margin-top: 10px;">初始化環境...</div>
    </div>
    

    <!-- 執法部門案件管理面板 -->
    <div id="case-management-panel" style="display: none; position: fixed; top: 100px; right: 20px; width: 350px; z-index: 1000;">
        <div class="panel-header" style="background: #4a90d9; color: white; padding: 10px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between;">
            <span><i class="fas fa-file-invoice"></i> 案件調查管理系統</span>
            <i class="fas fa-times" onclick="document.getElementById('case-management-panel').style.display='none'" style="cursor: pointer;"></i>
        </div>
        <div id="case-management-content" style="background: rgba(0,0,0,0.9); border: 1px solid #4a90d9; border-top: none; padding: 15px; border-radius: 0 0 8px 8px; max-height: 500px; overflow-y: auto;">
            <p style="color: #888; text-align: center;">尚未建立案件</p>
        </div>
    </div>
    

    <script>
    
// ===== 擴展功能：事件池系統 =====
GameState.eventPool = [
    { id: 'darknet_help', name: '暗網幫派支援', description: '暗網幫派臨時提供黑客資源，隱蔽度提升 20%', role: 'hacker', effect: (gs) => { gs.playerData.hacker.stealth += 20; } },
    { id: 'interpol_support', name: '國際刑警支援', description: '國際刑警追加調查支援，調查進度提升 15%', role: 'law_enforcement', effect: (gs) => { gs.playerData.law_enforcement.investigationProgress += 15; } },
    { id: 'isp_leak', name: 'ISP 數據洩漏', description: 'ISP 意外洩漏流量數據，黑客足跡增加', role: 'law_enforcement', effect: (gs) => { gs.playerData.hacker.digitalFootprints += 2; } },
    { id: 'zero_day_leak', name: '零日漏洞公開', description: '新的零日漏洞被公開，雙方攻擊力提升', role: 'both', effect: (gs) => { gs.playerData.hacker.attackPower += 10; gs.playerData.law_enforcement.budget -= 5000; } }
];

function triggerRandomEvent() {
    if (!GameState.gameActive) return;
    if (Math.random() > 0.05) return; // 5% 觸發機率

    const events = GameState.eventPool.filter(e => e.role === 'both' || e.role === GameState.currentRole);
    const event = events[Math.floor(Math.random() * events.length)];
    
    event.effect(GameState);
    showNotification('突發事件：' + event.name, event.description, 'info');
    addTerminalLine(`[事件] ${event.name}: ${event.description}`, 'warning');
}

// ===== 擴展功能：執法部門案件管理系統 =====
GameState.investigationSystem = {
    cases: [],
    activeCase: null
};

function createNewCase(targetName) {
    const caseId = 'CASE-' + Math.floor(1000 + Math.random() * 9000);
    const newCase = {
        id: caseId,
        target: targetName,
        targetIP: GameState.opponentIP || '103.24.201.' + Math.floor(Math.random() * 255),
        status: '調查中',
        startTime: new Date().toLocaleString(),
        updates: ['案件已建立，初步調查啟動。'],
        details: {
            origin: '偵測到異常流量來源於匿名網絡節點。',
            process: '正在進行多維度身份鎖定...',
            result: '尚未結案'
        }
    };
    GameState.investigationSystem.cases.push(newCase);
    GameState.investigationSystem.activeCase = newCase;
    updateCaseUI();
}

function updateCaseStatus(status, updateMsg) {
    if (GameState.investigationSystem.activeCase) {
        GameState.investigationSystem.activeCase.status = status;
        GameState.investigationSystem.activeCase.updates.push(updateMsg);
        updateCaseUI();
    }
}

function updateCaseUI() {
    const container = document.getElementById('case-management-content');
    if (!container || !GameState.investigationSystem.activeCase) return;
    
    const c = GameState.investigationSystem.activeCase;
    container.innerHTML = `
        <div class="case-file">
            <div class="case-header">案件編號: ${c.id} <span class="badge">${c.status}</span></div>
            <div class="case-body">
                <p><strong>目標人物:</strong> ${c.target}</p>
                <p><strong>目標 IP:</strong> ${c.targetIP}</p>
                <p><strong>建立時間:</strong> ${c.startTime}</p>
                <hr>
                <p><strong>起因:</strong> ${c.details.origin}</p>
                <p><strong>經過:</strong> ${c.details.process}</p>
                <p><strong>結果:</strong> ${c.details.result}</p>
                <hr>
                <p><strong>最新進展:</strong></p>
                <ul>
                    ${c.updates.map(u => `<li>${u}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;
}

// ===== 擴展功能：視覺化偵測雷達 =====
function activateDetectionRadar() {
    const cost = 40000;
    const cooldown = 35000;
    const le = GameState.playerData.law_enforcement;

    if (le.budget < cost) {
        showNotification('預算不足', '啟動雷達需要 40,000 預算', 'error');
        return;
    }

    if (GameState.radarCooldownActive) {
        showNotification('冷卻中', '雷達正在冷卻中', 'warning');
        return;
    }

    le.budget -= cost;
    GameState.radarCooldownActive = true;
    updateGameStats();

    // 視覺效果
    const radarOverlay = document.createElement('div');
    radarOverlay.id = 'radar-scan-effect';
    radarOverlay.innerHTML = '<div class="radar-circle"></div>';
    document.body.appendChild(radarOverlay);

    addTerminalLine('[系統] 視覺化偵測雷達已啟動，正在掃描全網節點...', 'info');

    // 模擬偵測到黑客
    setTimeout(() => {
        if (GameState.currentRole === 'law_enforcement') {
            addTerminalLine('[警告] 偵測到可疑黑客節點活動！', 'danger');
            // 觸發黑客端的警告
            if (Math.random() > 0.3) {
                triggerHackerWarning();
            }
        }
        document.body.removeChild(radarOverlay);
    }, 3000);

    setTimeout(() => {
        GameState.radarCooldownActive = false;
        addTerminalLine('[系統] 偵測雷達冷卻完成。', 'success');
    }, cooldown);
}

function triggerHackerWarning() {
    // 這裡模擬黑客收到的警告
    const warning = document.createElement('div');
    warning.className = 'hacker-scan-warning';
    warning.innerHTML = '⚠️ 偵測到執法部門雷達掃描！<br>建議立即中斷當前操作逃離！';
    document.body.appendChild(warning);
    
    setTimeout(() => {
        if (document.body.contains(warning)) {
            document.body.removeChild(warning);
        }
    }, 5000);
}

// ===== 擴展功能：全網圍捕視覺警示 =====
function triggerGlobalManhuntAlert() {
    const alertOverlay = document.createElement('div');
    alertOverlay.className = 'global-manhunt-alert';
    alertOverlay.innerHTML = `
        <div class="alert-content">
            <h1>🚨 全網圍捕行動已啟動 🚨</h1>
            <p>執法部門已接管所有 ISP 節點，匿名網絡正在崩潰...</p>
            <div class="countdown" id="manhunt-countdown">60</div>
        </div>
    `;
    document.body.appendChild(alertOverlay);

    let timeLeft = 60;
    const timer = setInterval(() => {
        timeLeft--;
        const cd = document.getElementById('manhunt-countdown');
        if (cd) cd.innerText = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(timer);
            document.body.removeChild(alertOverlay);
        }
    }, 1000);
}

    
    // 整合到現有系統
    const originalUpdateGameLoop = typeof updateGameLoop === 'function' ? updateGameLoop : null;
    window.updateGameLoop = function() {
        if (originalUpdateGameLoop) originalUpdateGameLoop();
        triggerRandomEvent();
    };

    // 增加雷達按鈕到執法部門工具欄 (模擬)
    function injectNewTools() {
        const leTools = document.querySelector('.law-enforcement .mode-features');
        if (leTools) {
            const radarLi = document.createElement('li');
            radarLi.innerHTML = '<span class="feature-icon"><i class="fas fa-broadcast-tower"></i></span><span>視覺化偵測雷達 (已就緒)</span>';
            leTools.appendChild(radarLi);
        }
        
        // 在執法部門頁面增加案件管理按鈕
        const navMenu = document.querySelector('.nav-menu');
        if (navMenu) {
            const caseLi = document.createElement('li');
            caseLi.innerHTML = '<a onclick="toggleCasePanel()"><i class="fas fa-file-invoice"></i> 案件管理</a>';
            navMenu.appendChild(caseLi);
        }
    }

    function toggleCasePanel() {
        const panel = document.getElementById('case-management-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        if (panel.style.display === 'block' && !GameState.investigationSystem.activeCase) {
            createNewCase('未知黑客 (代號: Shadow)');
        }
    }

    // 監聽按鍵觸發雷達 (例如按 R 鍵)
    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'r' && GameState.currentRole === 'law_enforcement') {
            activateDetectionRadar();
        }
    });

    setTimeout(injectNewTools, 2000);
    </script>
    

    <script>
    
/**
 * 遊戲擴展邏輯 - 優化雙方目標與行動
 */

// 1. 擴展 GameState 初始化
function extendGameState() {
    // 執法部門額外狀態
    GameState.playerData.law_enforcement.identityLockProgress = 0; // 身份鎖定進度 (0-100)
    GameState.playerData.law_enforcement.warrantStatus = 'none'; // none, applied, granted
    GameState.playerData.law_enforcement.evidenceCount = 0;
    GameState.playerData.law_enforcement.requiredEvidence = 5;
    GameState.playerData.law_enforcement.prosecutionReady = false;

    // 黑客額外狀態
    GameState.playerData.hacker.escapeRouteReady = false;
    GameState.playerData.hacker.retaliationProgress = 0;
    GameState.playerData.hacker.evidencePollutionLevel = 0;
}

// 2. 執法部門行動優化
function leAction_CollectEvidence() {
    if (GameState.currentRole !== 'law_enforcement') return;
    
    addTerminalLine('[調查] 正在掃描網絡殘留數據與日誌...', 'info');
    setTimeout(() => {
        const success = Math.random() > 0.3;
        if (success) {
            GameState.playerData.law_enforcement.evidenceCount++;
            GameState.playerData.law_enforcement.identityLockProgress += 15;
            addTerminalLine(`[成功] 發現關鍵證據！目前證據數: ${GameState.playerData.law_enforcement.evidenceCount}/${GameState.playerData.law_enforcement.requiredEvidence}`, 'success');
            addTerminalLine(`[進度] 身份鎖定進度提升至 ${Math.min(100, GameState.playerData.law_enforcement.identityLockProgress)}%`, 'info');
            
            if (GameState.playerData.law_enforcement.evidenceCount >= GameState.playerData.law_enforcement.requiredEvidence) {
                addTerminalLine('[提示] 已蒐集足夠證據，可以申請拘捕令！', 'alert');
            }
        } else {
            addTerminalLine('[失敗] 黑客已清理該節點足跡，未發現有效證據。', 'warning');
        }
        updateGameStats();
    }, 2000);
}

function leAction_ApplyWarrant() {
    if (GameState.playerData.law_enforcement.evidenceCount < GameState.playerData.law_enforcement.requiredEvidence) {
        showNotification('申請失敗', '證據不足，無法申請拘捕令', 'error');
        return;
    }
    
    addTerminalLine('[法律] 正在向法庭提交證據並申請拘捕令...', 'info');
    GameState.playerData.law_enforcement.warrantStatus = 'applied';
    
    setTimeout(() => {
        GameState.playerData.law_enforcement.warrantStatus = 'granted';
        addTerminalLine('[法律] 拘捕令已簽發！現在可以進行最終起訴。', 'success');
        showNotification('拘捕令已核准', '執法行動進入最後階段', 'success');
        updateGameStats();
    }, 5000);
}

function leAction_FinalProsecution() {
    if (GameState.playerData.law_enforcement.warrantStatus !== 'granted' || GameState.playerData.law_enforcement.identityLockProgress < 100) {
        showNotification('無法起訴', '需完全鎖定身份並持有拘捕令', 'error');
        return;
    }
    
    addTerminalLine('[行動] 啟動全網圍捕並提交起訴書...', 'alert');
    setTimeout(() => {
        triggerWin('law_enforcement', '成功鎖定黑客身份並完成起訴，正義得到伸張！');
    }, 3000);
}

// 3. 黑客行動優化
function hackerAction_Retaliate() {
    if (GameState.currentRole !== 'hacker') return;
    
    addTerminalLine('[報復] 正在對執法部門指揮中心發動飽和攻擊...', 'info');
    setTimeout(() => {
        const damage = 15 + Math.floor(Math.random() * 10);
        GameState.opponentData.law_enforcement.serverHealth -= damage;
        GameState.playerData.hacker.retaliationProgress += 10;
        
        addTerminalLine(`[成功] 指揮中心系統受損！健康度下降 ${damage}%`, 'success');
        if (GameState.opponentData.law_enforcement.serverHealth <= 0) {
            triggerWin('hacker', '執法部門指揮中心已癱瘓，報復行動圓滿成功！');
        }
        updateGameStats();
    }, 2000);
}

function hackerAction_PolluteEvidence() {
    addTerminalLine('[干擾] 正在滲透證據庫並注入隨機垃圾數據...', 'info');
    setTimeout(() => {
        GameState.opponentData.law_enforcement.evidenceCount = Math.max(0, GameState.opponentData.law_enforcement.evidenceCount - 1);
        GameState.playerData.hacker.evidencePollutionLevel += 20;
        addTerminalLine('[成功] 證據庫已污染，執法部門丟失了一項關鍵證據！', 'success');
        updateGameStats();
    }, 2500);
}

function hackerAction_Escape() {
    if (GameState.playerData.law_enforcement.identityLockProgress < 70) {
        addTerminalLine('[系統] 身份尚未暴露，無需緊急逃脫。', 'info');
        return;
    }
    
    addTerminalLine('[逃脫] 正在銷毀本地硬碟並切換至備用匿名節點...', 'alert');
    setTimeout(() => {
        GameState.playerData.law_enforcement.identityLockProgress = Math.max(0, GameState.playerData.law_enforcement.identityLockProgress - 40);
        GameState.playerData.hacker.stealth = 100;
        addTerminalLine('[成功] 追蹤已被切斷，身份鎖定進度大幅下降！', 'success');
        updateGameStats();
    }, 3000);
}

// 4. 勝利條件檢查擴展
function checkWinConditionsExtended() {
    const le = GameState.playerData.law_enforcement;
    const hacker = GameState.playerData.hacker;
    
    // 執法部門勝利：完成起訴
    // (已在 leAction_FinalProsecution 中處理)
    
    // 黑客勝利：癱瘓所有目標
    if (GameState.opponentData.law_enforcement.serverHealth <= 0 && GameState.opponentData.law_enforcement.evidenceLibraryHealth <= 0) {
        triggerWin('hacker', '執法部門所有系統已癱瘓，證據被銷毀，你已立於不敗之地。');
    }
}

// 5. UI 更新擴展
function updateGameStatsExtended() {
    // 這裡可以添加更新新進度條的邏輯
    const le = GameState.playerData.law_enforcement;
    const hacker = GameState.playerData.hacker;
    
    // 更新身份鎖定 UI (假設 HTML 中有對應 ID)
    const idLockEl = document.getElementById('identity-lock-fill');
    if (idLockEl) idLockEl.style.width = le.identityLockProgress + '%';
    
    const evidenceEl = document.getElementById('evidence-status');
    if (evidenceEl) evidenceEl.textContent = `證據: ${le.evidenceCount}/${le.requiredEvidence}`;
}

    
    // 覆蓋或擴展原有的初始化函數
    const originalInitGame = window.initGame;
    window.initGame = function(role) {

    // 強制修正預算
    if (GameState && GameState.playerData && GameState.playerData.law_enforcement) {
        GameState.playerData.law_enforcement.budget = 1000000;
        console.log("Budget Force Fixed to 1,000,000");
    }
    
        if (originalInitGame) originalInitGame(role);
        extendGameState();
        injectObjectiveUI();
        console.log("Game Extended Logic Initialized");
    };

    function injectObjectiveUI() {
        const sidePanel = document.querySelector('.side-panel') || document.body;
        const objectiveHTML = `
            <div class="objective-panel" id="player-objectives">
                <div class="objective-title">
                    <i class="fas fa-bullseye"></i> 當前戰略目標
                </div>
                <div id="objective-list">
                    <!-- 動態填充 -->
                </div>
                <div class="identity-lock-container" id="id-lock-ui" style="display:none">
                    <div style="font-size:0.7rem; margin-bottom:3px; color:#ff4444">身份鎖定進度</div>
                    <div class="identity-lock-bar"><div class="identity-lock-fill" id="identity-lock-fill"></div></div>
                </div>
            </div>
        `;
        
        const battleInfo = document.querySelector('.battle-info');
        if (battleInfo) {
            battleInfo.insertAdjacentHTML('beforebegin', objectiveHTML);
        }
        updateObjectiveUI();
    }

    function updateObjectiveUI() {
        const list = document.getElementById('objective-list');
        if (!list) return;
        
        let html = '';
        if (GameState.currentRole === 'law_enforcement') {
            const le = GameState.playerData.law_enforcement;
            html += `
                <div class="objective-item">
                    <span>蒐集證據 (${le.evidenceCount}/${le.requiredEvidence})</span>
                    <span class="status-tag ${le.evidenceCount >= le.requiredEvidence ? 'status-complete' : 'status-pending'}">
                        ${le.evidenceCount >= le.requiredEvidence ? '完成' : '進行中'}
                    </span>
                </div>
                <div class="objective-item">
                    <span>鎖定黑客身份</span>
                    <span class="status-tag ${le.identityLockProgress >= 100 ? 'status-complete' : 'status-pending'}">
                        ${le.identityLockProgress}%
                    </span>
                </div>
                <div class="objective-item">
                    <span>申請拘捕令</span>
                    <span class="status-tag ${le.warrantStatus === 'granted' ? 'status-complete' : 'status-pending'}">
                        ${le.warrantStatus === 'granted' ? '已核准' : (le.warrantStatus === 'applied' ? '審核中' : '未申請')}
                    </span>
                </div>
            `;
            document.getElementById('id-lock-ui').style.display = 'block';
        } else {
            const hacker = GameState.playerData.hacker;
            const le = GameState.opponentData.law_enforcement;
            html += `
                <div class="objective-item">
                    <span>癱瘓指揮中心</span>
                    <span class="status-tag ${le.serverHealth <= 0 ? 'status-complete' : 'status-pending'}">
                        ${le.serverHealth}%
                    </span>
                </div>
                <div class="objective-item">
                    <span>污染證據庫</span>
                    <span class="status-tag ${hacker.evidencePollutionLevel >= 100 ? 'status-complete' : 'status-pending'}">
                        ${hacker.evidencePollutionLevel}%
                    </span>
                </div>
                <div class="objective-item">
                    <span>避免被捕</span>
                    <span class="status-tag status-pending">生存中</span>
                </div>
            `;
            document.getElementById('id-lock-ui').style.display = 'none';
        }
        list.innerHTML = html;
    }

    // 擴展原有的 updateGameStats
    const originalUpdateGameStats = window.updateGameStats;
    window.updateGameStats = function() {
        if (originalUpdateGameStats) originalUpdateGameStats();
        updateGameStatsExtended();
        updateObjectiveUI();
        checkWinConditionsExtended();
    };
    
    // 注入新按鈕到快捷面板 (優化版：分組與權限控制)
    function injectActionButtons() {
        const panel = document.querySelector('.quick-actions-panel');
        if (!panel) return;
        
        const role = GameState.currentRole;
        panel.innerHTML = ''; // 清空舊內容

        
        const groups = [
            {
                title: '偵查與監控 (Recon)',
                role: 'both',
                btns: [
                    { id: 'scan', icon: 'fa-search', text: '深度掃描', color: '#4a90d9', action: "executeCommand('scan')" },
                    { id: 'track1', icon: 'fa-map-marker-alt', text: 'IP 追蹤 (Track1)', color: '#4a90d9', role: 'law_enforcement', action: "executeCommand('track1')" },
                    { id: 'track2', icon: 'fa-id-card', text: '身份追蹤 (Track2)', color: '#4a90d9', role: 'law_enforcement', action: "executeCommand('track2')" },
                    { id: 'monitor', icon: 'fa-chart-line', text: '流量監控', color: '#4a90d9', action: "executeCommand('monitor')" }
                ]
            },
            {
                title: '行動與攻擊 (Action)',
                role: 'hacker',
                btns: [
                    { id: 'crack', icon: 'fa-key', text: '破解密碼', color: '#ff9900', action: "executeCommand('crack')" },
                    { id: 'sqli', icon: 'fa-database', text: 'SQL 注入', color: '#ff9900', action: "executeCommand('sqli')" },
                    { id: 'ddos', icon: 'fa-bolt', text: 'DDoS 攻擊', color: '#ff4444', action: "executeCommand('ddos')" },
                    { id: 'hacker_retaliate', icon: 'fa-skull', text: '報復打擊', color: '#ff0000', action: 'hackerAction_Retaliate()' }
                ]
            },
            {
                title: '執法與取證 (Enforcement)',
                role: 'law_enforcement',
                btns: [
                    { id: 'le_collect', icon: 'fa-fingerprint', text: '蒐集證據', color: '#ff9900', action: 'leAction_CollectEvidence()' },
                    { id: 'forensics', icon: 'fa-microscope', text: '數位鑑識', color: '#ff9900', action: "executeCommand('forensics')" },
                    { id: 'le_warrant', icon: 'fa-file-contract', text: '申請拘捕', color: '#ff9900', action: 'leAction_ApplyWarrant()' },
                    { id: 'le_prosecute', icon: 'fa-gavel', text: '最終起訴', color: '#ff0000', action: 'leAction_FinalProsecution()' }
                ]
            },
            {
                title: '防禦與對抗 (Defense)',
                role: 'both',
                btns: [
                    { id: 'firewallboost', icon: 'fa-shield-alt', text: '強化防火牆', color: '#00ff41', role: 'law_enforcement', action: "executeCommand('firewallboost')" },
                    { id: 'stealth', icon: 'fa-user-secret', text: '隱蔽模式', color: '#00ff41', role: 'hacker', action: "executeCommand('stealth')" },
                    { id: 'hacker_pollute', icon: 'fa-biohazard', text: '污染證據', color: '#ff9900', role: 'hacker', action: 'hackerAction_PolluteEvidence()' },
                    { id: 'honeypot_gen', icon: 'fa-honey-pot', text: '部署蜜罐', color: '#00ff41', role: 'law_enforcement' }
                ]
            },
            {
                title: '特殊與資源 (Special)',
                role: 'both',
                btns: [
                    { id: 'darknet_hub', icon: 'fa-user-secret', text: '暗網中介', color: '#00ff41', role: 'hacker', action: 'openDarknetHub()' },
                    { id: 'upgrade_system', icon: 'fa-shopping-cart', text: '高級商店', color: '#ff9900', action: 'openPremiumShop()' },
                    { id: 'hacker_escape', icon: 'fa-running', text: '緊急逃脫', color: '#00ff41', role: 'hacker', action: 'hackerAction_Escape()' }
                ]
            }
        ];
    

        groups.forEach(group => {
            if (group.role !== 'both' && group.role !== role) return;
            
            const filteredBtns = group.btns.filter(btn => !btn.role || btn.role === role);
            if (filteredBtns.length === 0) return;

            const groupEl = document.createElement('div');
            groupEl.className = 'quick-action-group';
            groupEl.innerHTML = `<div class="group-title">${group.title}</div>`;
            
            const btnsContainer = document.createElement('div');
            btnsContainer.className = 'group-btns';
            
            filteredBtns.forEach(btn => {
                const button = document.createElement('button');
                button.className = `quick-btn ${btn.role ? btn.role + '-only' : ''}`;
                button.style.borderColor = btn.color;
                button.onclick = (e) => {
                    if (btn.action) {
                        // 執行自定義函數並帶入視覺回饋
                        const originalOnClick = new Function(btn.action);
                        quickActionFeedback(e.currentTarget, originalOnClick);
                    } else {
                        quickAction(btn.id, e.currentTarget);
                    }
                };
                button.innerHTML = `<i class="fas ${btn.icon}"></i> ${btn.text}`;
                btnsContainer.appendChild(button);
            });
            
            groupEl.appendChild(btnsContainer);
            panel.appendChild(groupEl);
        });
    }

    // 視覺回饋輔助函數
    function quickActionFeedback(btn, callback) {
        if (btn.classList.contains('executing')) return;
        
        btn.classList.add('executing');
        addTerminalLine('[執行] 啟動快捷功能...', 'command');
        
        setTimeout(() => {
            try {
                if (callback) callback();
                btn.classList.remove('executing');
                btn.classList.add('success');
                setTimeout(() => btn.classList.remove('success'), 1000);
            } catch (err) {
                btn.classList.remove('executing');
                btn.classList.add('error');
                setTimeout(() => btn.classList.remove('error'), 1000);
            }
        }, 600);
    }
    
    // 監聽遊戲開始
    const originalStartGame = window.startGame;
    window.startGame = function() {
        if (originalStartGame) originalStartGame();
        setTimeout(injectActionButtons, 500);
    };
    </script>
    

    <script>
    
/**
 * 執法部門身份演變系統
 */

const IdentityStages = {
    SUSPECT: { id: 1, name: '嫌疑人', minProgress: 0, color: '#888' },
    POI: { id: 2, name: '目標人物', minProgress: 25, color: '#4a90d9' },
    ALLEGED: { id: 3, name: '疑犯', minProgress: 50, color: '#ff9900' },
    WANTED: { id: 4, name: '通緝人士', minProgress: 75, color: '#ff4444' },
    APPREHENDED: { id: 5, name: '被捕人士', minProgress: 100, color: '#00ff41' }
};

function getIdentityStage(progress) {
    if (progress >= 100) return IdentityStages.APPREHENDED;
    if (progress >= 75) return IdentityStages.WANTED;
    if (progress >= 50) return IdentityStages.ALLEGED;
    if (progress >= 25) return IdentityStages.POI;
    return IdentityStages.SUSPECT;
}

// 擴展 GameState
function extendIdentityState() {
    if (!GameState.playerData.law_enforcement.identityLockProgress) {
        GameState.playerData.law_enforcement.identityLockProgress = 0;
    }
    GameState.playerData.law_enforcement.currentIdentityStage = IdentityStages.SUSPECT;
}

// 更新身份 UI
function updateIdentityUI() {
    const progress = GameState.playerData.law_enforcement.identityLockProgress;
    const stage = getIdentityStage(progress);
    GameState.playerData.law_enforcement.currentIdentityStage = stage;

    const stageDisplay = document.getElementById('identity-stage-display');
    if (stageDisplay) {
        stageDisplay.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="color:${stage.color}; font-weight:bold; font-size:1.1rem;">
                    <i class="fas fa-user-shield"></i> 當前身份：${stage.name}
                </span>
                <span style="font-size:0.8rem; color:#aaa;">鎖定率: ${progress}%</span>
            </div>
            <div class="identity-steps" style="display:flex; justify-content:space-between; margin-top:5px; position:relative;">
                ${Object.values(IdentityStages).map(s => `
                    <div class="step-dot ${progress >= s.minProgress ? 'active' : ''}" 
                         style="width:15px; height:15px; border-radius:50%; background:${progress >= s.minProgress ? s.color : '#333'}; 
                                border:2px solid ${progress >= s.minProgress ? '#fff' : '#555'}; position:relative; z-index:2;"
                         title="${s.name}">
                        <div style="position:absolute; top:20px; left:50%; transform:translateX(-50%); font-size:0.6rem; white-space:nowrap; color:${progress >= s.minProgress ? '#fff' : '#666'}">
                            ${s.name}
                        </div>
                    </div>
                `).join('')}
                <div style="position:absolute; top:7px; left:0; width:100%; height:2px; background:#333; z-index:1;"></div>
                <div style="position:absolute; top:7px; left:0; width:${progress}%; height:2px; background:linear-gradient(90deg, #4a90d9, #ff4444); z-index:1; transition:width 0.5s ease;"></div>
            </div>
        `;
    }
}

// 修改原有的 leAction_CollectEvidence
function leAction_CollectEvidence_V2() {
    if (GameState.currentRole !== 'law_enforcement') return;
    
    addTerminalLine('[調查] 正在分析加密流量與物理位置信號...', 'info');
    setTimeout(() => {
        const success = Math.random() > 0.25;
        if (success) {
            const oldStage = getIdentityStage(GameState.playerData.law_enforcement.identityLockProgress);
            GameState.playerData.law_enforcement.evidenceCount++;
            GameState.playerData.law_enforcement.identityLockProgress = Math.min(100, GameState.playerData.law_enforcement.identityLockProgress + 12);
            
            const newStage = getIdentityStage(GameState.playerData.law_enforcement.identityLockProgress);
            
            addTerminalLine(`[成功] 獲取關鍵數據包！身份鎖定率提升。`, 'success');
            
            if (newStage.id > oldStage.id) {
                addTerminalLine(`[升級] 目標身份已演變為：${newStage.name}！`, 'alert');
                showNotification('身份演變', `目標現在被標記為 ${newStage.name}`, 'success');
            }
        } else {
            addTerminalLine('[失敗] 目標使用了跳板機，追蹤被切斷。', 'warning');
        }
        updateGameStats();
    }, 1500);
}

    
    // 覆蓋之前的 injectObjectiveUI 以包含身份階段面板
    const oldInjectObjectiveUI = window.injectObjectiveUI;
    window.injectObjectiveUI = function() {
        const battleInfo = document.querySelector('.battle-info');
        if (!battleInfo) return;
        
        // 插入身份階段面板 (僅限執法部門)
        if (GameState.currentRole === 'law_enforcement') {
            const idStageHTML = `
                <div class="identity-stage-panel" id="identity-stage-display">
                    <!-- 由 JS 動態填充 -->
                </div>
            `;
            battleInfo.insertAdjacentHTML('beforebegin', idStageHTML);
        }
        
        // 調用原有的目標面板注入
        if (oldInjectObjectiveUI) oldInjectObjectiveUI();
    };

    // 覆蓋 updateObjectiveUI 以同步更新身份階段
    const oldUpdateObjectiveUI = window.updateObjectiveUI;
    window.updateObjectiveUI = function() {
        if (oldUpdateObjectiveUI) oldUpdateObjectiveUI();
        if (GameState.currentRole === 'law_enforcement') {
            updateIdentityUI();
        }
    };

    // 覆蓋 leAction_CollectEvidence 使用 V2 版本
    window.leAction_CollectEvidence = leAction_CollectEvidence_V2;

    // 擴展黑客逃脫邏輯，使其影響身份階段
    const oldHackerEscape = window.hackerAction_Escape;
    window.hackerAction_Escape = function() {
        if (GameState.playerData.law_enforcement.identityLockProgress < 30) {
            addTerminalLine('[系統] 身份隱蔽性尚高，無需逃脫。', 'info');
            return;
        }
        
        addTerminalLine('[逃脫] 正在執行「數位自殺」協議，銷毀所有關聯身份...', 'alert');
        setTimeout(() => {
            const oldStage = getIdentityStage(GameState.playerData.law_enforcement.identityLockProgress);
            GameState.playerData.law_enforcement.identityLockProgress = Math.max(0, GameState.playerData.law_enforcement.identityLockProgress - 35);
            const newStage = getIdentityStage(GameState.playerData.law_enforcement.identityLockProgress);
            
            GameState.playerData.hacker.stealth = 100;
            addTerminalLine('[成功] 身份已重置，執法部門丟失了你的蹤跡！', 'success');
            
            if (newStage.id < oldStage.id) {
                addTerminalLine(`[警告] 執法部門對你的定義已降級為：${newStage.name}`, 'warning');
            }
            updateGameStats();
        }, 2500);
    };
    
    // 初始化身份狀態
    const oldExtendGameState = window.extendGameState;
    window.extendGameState = function() {
        if (oldExtendGameState) oldExtendGameState();
        extendIdentityState();
    };
    </script>
    

    <script>
    
/**
 * 執法部門預算與裝備系統
 */

const LE_EQUIPMENT = [
    { id: 'basic_monitor', name: '基礎監控包', cost: 50000, desc: '小幅提升自動蒐證機率', icon: 'fa-eye' },
    { id: 'super_computer', name: '高運算破解陣列', cost: 150000, desc: '大幅提升身份鎖定速度', icon: 'fa-microchip' },
    { id: 'city_surveillance', name: '全城監控系統接入', cost: 300000, desc: '直接提升身份鎖定進度 20%', icon: 'fa-video' },
    { id: 'swat_team', name: '特種行動小組 (SWAT)', cost: 500000, desc: '解鎖最終拘捕行動權限', icon: 'fa-user-ninja' }
];

function initBudgetSystem() {
    // 設定初始預算
    GameState.playerData.law_enforcement.budget = 1000000;
    GameState.playerData.law_enforcement.purchasedEquip = [];
    GameState.playerData.law_enforcement.deployedEquip = [];
}

function buyEquipment(equipId) {
    const equip = LE_EQUIPMENT.find(e => e.id === equipId);
    const le = GameState.playerData.law_enforcement;

    if (!equip) return;
    if (le.budget < equip.cost) {
        showNotification('預算不足', `需要 $${equip.cost.toLocaleString()}，目前僅剩 $${le.budget.toLocaleString()}`, 'error');
        addTerminalLine(`[拒絕] 預算不足，無法採購 ${equip.name}。`, 'error');
        return;
    }

    if (le.purchasedEquip.includes(equipId)) {
        showNotification('重複採購', '該裝備已在服役中', 'warning');
        return;
    }

    // 扣除預算
    le.budget -= equip.cost;
    le.purchasedEquip.push(equipId);

    // 執行裝備效果
    applyEquipEffect(equipId);

    // UI 反饋
    addTerminalLine(`[採購成功] 已支付 $${equip.cost.toLocaleString()} 採購 ${equip.name}。`, 'success');
    addTerminalLine(`[系統] 剩餘預算: $${le.budget.toLocaleString()}`, 'info');
    
    updateGameStats();
    updateShopUI();
}

function applyEquipEffect(equipId) {
    const le = GameState.playerData.law_enforcement;
    switch(equipId) {
        case 'super_computer':
            // 永久提升蒐證效率 (模擬)
            addTerminalLine('[效果] 高運算陣列已上線，數據分析速度提升 50%。', 'success');
            break;
        case 'city_surveillance':
            le.identityLockProgress = Math.min(100, le.identityLockProgress + 20);
            addTerminalLine('[效果] 全城監控已接入，目標位置鎖定率提升 20%。', 'success');
            break;
        case 'swat_team':
            le.prosecutionReady = true;
            addTerminalLine('[效果] SWAT 小組已進入待命狀態，隨時可以執行拘捕。', 'alert');
            break;
    }
}

function updateShopUI() {
    const shopContainer = document.getElementById('le-shop-items');
    if (!shopContainer) return;

    const le = GameState.playerData.law_enforcement;
    shopContainer.innerHTML = LE_EQUIPMENT.map(equip => {
        const isPurchased = le.purchasedEquip.includes(equip.id);
        const isDeployed = (le.deployedEquip || []).includes(equip.id);
        return `
            <div class="shop-item ${isPurchased ? 'purchased' : ''}">
                <div class="shop-item-icon"><i class="fas ${equip.icon}"></i></div>
                <div class="shop-item-info">
                    <div class="shop-item-name">${equip.name}</div>
                    <div class="shop-item-desc">${equip.desc}</div>
                </div>
                <div class="shop-item-actions" style="text-align:right;">
                    <div class="shop-item-cost">${isPurchased ? (isDeployed ? '已部署' : '已購買') : `$${(equip.cost/1000).toFixed(0)}K`}</div>
                    ${isPurchased ? (isDeployed ? `<button onclick="unequipItem('${equip.id}')" style="background:#333; color:#fff; border:none; padding:4px 8px; cursor:pointer; margin-top:6px;">卸下</button>` : `<button onclick="equipItem('${equip.id}')" style="background:#4a90d9; color:#000; border:none; padding:4px 8px; cursor:pointer; margin-top:6px;">部署</button>`) : `<button onclick="buyEquipment('${equip.id}')" style="background:#4a90d9; color:#000; border:none; padding:4px 8px; cursor:pointer; margin-top:6px;">購買</button>`}
                </div>
            </div>
        `;
    }).join('');

    // 裝備部署/卸下 API
    function getEquipSlot(equipId) {
        switch(equipId) {
            case 'basic_monitor': return 'accessory';
            case 'super_computer': return 'accessory';
            case 'city_surveillance': return 'armor';
            case 'swat_team': return 'weapon';
            default: return 'accessory';
        }
    }

    window.equipItem = function(equipId) {
        const le = GameState.playerData.law_enforcement;
        if (!le.purchasedEquip.includes(equipId)) { showNotification('未購買', '請先購買此裝備', 'warning'); return; }
        le.deployedEquip = le.deployedEquip || [];
        if (le.deployedEquip.includes(equipId)) { showNotification('已部署', '該裝備已部署', 'info'); return; }
        const slot = getEquipSlot(equipId);
        GameState.equipmentSlots.law_enforcement[slot] = equipId;
        le.deployedEquip.push(equipId);
        applyEquipDeployEffect(equipId);
        addTerminalLine(`[部署] ${equipId} 已部署於 ${slot}`, 'success');
        updateShopUI(); updateGameStats();
    };

    window.unequipItem = function(equipId) {
        const le = GameState.playerData.law_enforcement;
        le.deployedEquip = le.deployedEquip || [];
        if (!le.deployedEquip.includes(equipId)) { showNotification('未部署', '該裝備未部署', 'warning'); return; }
        const slot = getEquipSlot(equipId);
        GameState.equipmentSlots.law_enforcement[slot] = null;
        le.deployedEquip = le.deployedEquip.filter(e => e !== equipId);
        removeEquipDeployEffect(equipId);
        addTerminalLine(`[卸下] ${equipId} 已從 ${slot} 卸下`, 'info');
        updateShopUI(); updateGameStats();
    };

    window.applyEquipDeployEffect = function(equipId) {
        const le = GameState.playerData.law_enforcement;
        switch(equipId) {
            case 'super_computer':
                le.investigationSpeedBoost = (le.investigationSpeedBoost || 0) + 50;
                addTerminalLine('[效果] 高運算陣列已上線，調查速度提升。', 'success');
                break;
            case 'city_surveillance':
                le.identityLockProgress = Math.min(100, (le.identityLockProgress || 0) + 20);
                addTerminalLine('[效果] 全城監控已接入，目標位置鎖定率提升。', 'success');
                break;
            case 'swat_team':
                le.prosecutionReady = true;
                addTerminalLine('[效果] SWAT 小組已進入待命狀態。', 'alert');
                break;
            default:
                addTerminalLine('[效果] 裝備已部署。', 'info');
        }
    };

    window.removeEquipDeployEffect = function(equipId) {
        const le = GameState.playerData.law_enforcement;
        switch(equipId) {
            case 'super_computer':
                le.investigationSpeedBoost = Math.max(0, (le.investigationSpeedBoost || 0) - 50);
                addTerminalLine('[效果] 高運算陣列已卸載，調查速度恢復。', 'info');
                break;
            case 'city_surveillance':
                le.identityLockProgress = Math.max(0, (le.identityLockProgress || 0) - 20);
                addTerminalLine('[效果] 全城監控已移除，鎖定率下降。', 'info');
                break;
            case 'swat_team':
                le.prosecutionReady = false;
                addTerminalLine('[效果] SWAT 小組已回收。', 'info');
                break;
            default:
                addTerminalLine('[效果] 裝備已卸載。', 'info');
        }
    };


    
    // 覆蓋初始化
    const oldExtendGameStateV2 = window.extendGameState;
    window.extendGameState = function() {
        if (oldExtendGameStateV2) oldExtendGameStateV2();
        initBudgetSystem();
    };

    // 覆蓋 UI 注入
    const oldInjectObjectiveUIV2 = window.injectObjectiveUI;
    window.injectObjectiveUI = function() {
        if (oldInjectObjectiveUIV2) oldInjectObjectiveUIV2();
        
        const battleInfo = document.querySelector('.battle-info');
        if (!battleInfo || GameState.currentRole !== 'law_enforcement') return;
        
        const budgetHTML = `
            <div class="budget-dashboard">
                <div>
                    <div style="font-size:0.7rem; color:#aaa; text-transform:uppercase; letter-spacing:1px;">可用調查預算</div>
                    <div class="budget-amount" id="le-budget-display">$1,000,000</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:0.7rem; color:#aaa;">預算狀態</div>
                    <div style="color:#4a90d9; font-weight:bold;"><i class="fas fa-check-circle"></i> 充足</div>
                </div>
            </div>
            <div class="objective-panel">
                <div class="objective-title"><i class="fas fa-shopping-cart"></i> 裝備採購中心</div>
                <div class="shop-grid" id="le-shop-items">
                    <!-- 由 JS 動態填充 -->
                </div>
            </div>
        `;
        battleInfo.insertAdjacentHTML('beforebegin', budgetHTML);
        updateShopUI();
    };

    // 覆蓋數據更新
    const oldUpdateGameStatsV2 = window.updateGameStats;
    window.updateGameStats = function() {
        if (oldUpdateGameStatsV2) oldUpdateGameStatsV2();
        
        const budgetDisplay = document.getElementById('le-budget-display');
        if (budgetDisplay && GameState.playerData.law_enforcement.budget !== undefined) {
            budgetDisplay.textContent = '$' + GameState.playerData.law_enforcement.budget.toLocaleString();
            if (GameState.playerData.law_enforcement.budget < 100000) {
                budgetDisplay.style.color = '#ff4444';
            }
        }
    };
    </script>
    

    <script>
    
/**
 * 自創指令系統核心邏輯
 */

function processCommand(cmdText) {
    const parts = cmdText.trim().toLowerCase().split(' ');
    const cmd = parts[0];
    const args = parts.slice(1);

    addTerminalLine(`$ ${cmdText}`, 'command');

    switch(cmd) {
        case 'help':
            showHelp();
            break;
        case 'status':
            showStatus();
            break;
        case 'upgrade':
            executeUpgrade();
            break;
        case 'connect':
            executeConnect();
            break;
        case 'disconnect':
            executeDisconnect();
            break;
        case 'select':
            showObjectives();
            break;
        case 'firewall':
            manageFirewall();
            break;
        case 'block':
            executeBlock();
            break;
        case 'analyze':
            executeAnalyze();
            break;
        case 'backup':
            executeBackup();
            break;
        case 'clear':
            clearTerminal();
            break;
        default:
            addTerminalLine(`[錯誤] 未知指令: ${cmd}。輸入 'help' 獲取指令列表。`, 'error');
    }
}

function showHelp() {
    const helpText = [
        '--- 可用指令列表 ---',
        'status     - 查詢自身網路狀態與系統健康度',
        'upgrade    - 升級工具/系統模組 (需消耗資金)',
        'connect    - 嘗試連接對手系統',
        'disconnect - 中斷與對手系統的連接',
        'select     - 查詢當前角色的戰略目標任務',
        'firewall   - 配置/檢查防火牆防禦層',
        'block      - 執行主動封鎖，攔截即將到來的攻擊',
        'analyze    - 分析目前捕獲的數據流',
        'backup     - 備份關鍵資料，降低受損風險',
        'clear      - 清除終端機所有記錄'
    ];
    helpText.forEach(line => addTerminalLine(line, 'info'));
}

function showStatus() {
    const role = GameState.currentRole;
    const data = GameState.playerData[role];
    addTerminalLine(`[狀態報告] 角色: ${role === 'hacker' ? '黑客' : '執法部門'}`, 'success');
    addTerminalLine(`- 系統健康: ${data.serverHealth || 100}%`, 'info');
    if (role === 'hacker') {
        addTerminalLine(`- 隱蔽等級: ${data.stealth}%`, 'info');
        addTerminalLine(`- 數碼足跡: ${data.digitalFootprints}`, 'warning');
    } else {
        addTerminalLine(`- 調查預算: $${data.budget.toLocaleString()}`, 'info');
        addTerminalLine(`- 身份鎖定進度: ${data.identityLockProgress}%`, 'info');
    }
}

function executeUpgrade() {
    const role = GameState.currentRole;
    const cost = 100000;
    const data = GameState.playerData[role];
    const moneyField = role === 'hacker' ? 'money' : 'budget';

    if (data[moneyField] < cost) {
        addTerminalLine(`[失敗] 升級需要 $${cost.toLocaleString()}，資金不足。`, 'error');
        return;
    }

    data[moneyField] -= cost;
    addTerminalLine(`[升級中] 正在優化系統模組...`, 'info');
    setTimeout(() => {
        addTerminalLine(`[成功] 系統已升級！操作成功率提升 15%。`, 'success');
        updateGameStats();
    }, 2000);
}

function executeConnect() {
    addTerminalLine(`[連接] 正在嘗試建立加密隧道至 ${GameState.opponentIP}...`, 'info');
    setTimeout(() => {
        GameState.connectionStatus = 'connected';
        addTerminalLine(`[成功] 已成功連接至目標系統。`, 'success');
        showNotification('連接成功', '已建立遠端鏈接', 'success');
    }, 1500);
}

function executeDisconnect() {
    GameState.connectionStatus = 'disconnected';
    addTerminalLine(`[中斷] 已主動切斷與目標的連接。`, 'warning');
}

function showObjectives() {
    addTerminalLine(`[任務清單] 當前戰略目標：`, 'info');
    if (GameState.currentRole === 'law_enforcement') {
        addTerminalLine(`1. 蒐集證據並鎖定黑客身份`, 'info');
        addTerminalLine(`2. 申請拘捕令並完成起訴`, 'info');
    } else {
        addTerminalLine(`1. 癱瘓執法部門指揮中心`, 'info');
        addTerminalLine(`2. 清除足跡並避免被捕`, 'info');
    }
}

function manageFirewall() {
    addTerminalLine(`[防火牆] 正在檢查防禦規則...`, 'info');
    setTimeout(() => {
        addTerminalLine(`[狀態] 防火牆運作正常。當前防禦等級: HIGH`, 'success');
    }, 1000);
}

function executeBlock() {
    addTerminalLine(`[封鎖] 啟動主動防禦協議，正在攔截可疑流量...`, 'alert');
    setTimeout(() => {
        addTerminalLine(`[成功] 已封鎖來自外部的掃描嘗試。`, 'success');
    }, 1500);
}

function executeAnalyze() {
    addTerminalLine(`[分析] 正在對當前數據流進行深度包檢測 (DPI)...`, 'info');
    setTimeout(() => {
        const found = Math.random() > 0.5;
        if (found) {
            addTerminalLine(`[發現] 偵測到潛在的系統漏洞/關鍵證據！`, 'success');
            if (GameState.currentRole === 'law_enforcement') {
                GameState.playerData.law_enforcement.identityLockProgress += 5;
            }
        } else {
            addTerminalLine(`[結果] 未發現異常數據。`, 'info');
        }
        updateGameStats();
    }, 2500);
}

function executeBackup() {
    addTerminalLine(`[備份] 正在將關鍵數據同步至加密雲端...`, 'info');
    setTimeout(() => {
        addTerminalLine(`[成功] 數據備份完成。`, 'success');
    }, 2000);
}

function clearTerminal() {
    const display = document.getElementById('terminal-display');
    if (display) display.innerHTML = '';
    addTerminalLine('終端機已重置。', 'info');
}

    
    // 覆蓋原有的 executeCommand 函數，使其調用新的指令引擎
    window.executeCommand = function(command) {
        processCommand(command);
    };

    // 監聽終端輸入框的 Enter 鍵
    function setupTerminalInput() {
        const input = document.getElementById('terminal-input');
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const cmd = this.value;
                    if (cmd) {
                        executeCommand(cmd);
                        this.value = '';
                    }
                }
            });
        }
    }

    // 在遊戲開始時初始化輸入監聽
    const oldStartGameV3 = window.startGame;
    window.startGame = function() {
        if (oldStartGameV3) oldStartGameV3();
        setTimeout(setupTerminalInput, 1000);
        console.log("Terminal Command System V4 Initialized");
    };
    


/**
 * 擴展指令系統 V3 - 最終完美版
 * 包含對齊的通用指令、補全的專屬工具與詳細解釋
 */

function extendCommandSystemV3() {
    // 1. 補全缺失的工具數據
    function injectMissingTools() {
        if (!GameState.tools) GameState.tools = { hacker: [], law_enforcement: [] };
        
        // 執法部門缺失工具
        const leTools = GameState.tools.law_enforcement || [];
        if (!leTools.find(t => t.id === 'adv_crypto_analysis')) {
            leTools.push({
                id: 'adv_crypto_analysis',
                name: '高級數據加密分析',
                category: 'investigation',
                description: '深度解析加密流量，提取隱藏的攻擊源信息',
                cost: 2500,
                level: 1
            });
        }

        // 黑客缺失工具
        const hackerTools = GameState.tools.hacker || [];
        if (!hackerTools.find(t => t.id === 'stealth_proxy_gen')) {
            hackerTools.push({
                id: 'stealth_proxy_gen',
                name: '無痕深度隱身代理網絡生成器',
                category: 'stealth',
                description: '生成多層動態代理網絡，徹底抹除數位足跡',
                cost: 3000,
                level: 1
            });
        }
        if (!hackerTools.find(t => t.id === 'phishing_link_sys')) {
            hackerTools.push({
                id: 'phishing_link_sys',
                name: '詐騙或釣魚連結生成系統',
                category: 'attack',
                description: '自動化生成高可信度的偽造連結，誘騙目標點擊',
                cost: 1500,
                level: 1
            });
        }
        
        updateToolsGrid();
    }

    // 2. 指令數據庫（包含解釋）
    const CommandDocs = {
        common: {
            'status': '查詢自身網路狀態',
            'upgrade': '升級工具/系統模組，提升操作成功率',
            'connect': '連接對手系統',
            'disconnect': '中斷連接對手系統',
            'select': '查詢當前角色的目標任務',
            'firewall': '配置/檢查防火牆',
            'setupvpn': '檢查VPN/定期維護',
            'block': '封鎖攻擊',
            'analyze': '分析目前數據',
            'backup': '備份資料/數據',
            'clear': '清除終端'
        },
        hacker: {
            'scan': '掃描目標漏洞、ip/埠與系統版本',
            'crack': '破解目標服務密碼',
            'inject': '注入腳本獲取敏感數據',
            'backdoor': '植入後門程式遠端控制目標',
            'encrypt': '加密檔案模擬勒索攻擊',
            'stealth': '啟動隱蔽模式',
            'cleanlog': '刪除目標操作日誌，規避追蹤',
            'sqli': 'SQL注入攻擊',
            'xss': 'XSS跨站腳本攻擊',
            'ddos': 'DDoS攻擊',
            'phish': '釣魚攻擊',
            'ransom': '勒索軟件模擬',
            'fakedata': '植入偽造數據，干擾執法部門的證據分析方向',
            'dbinfiltrate': '滲透執法部門證據庫，竄改或盜取已存證據',
            'servercrash': '發動DDoS攻擊癱瘓執法部門伺服器，中斷其調查進度',
            'rootkit': '植入Rootkit隱藏自身進程，躲避執法端監控程式偵測'
        },
        law_enforcement: {
            'track1': '追蹤目標真實位置與關聯設備, IP address...',
            'track2': '向電訊/網絡供應商索取資料及身份',
            'usagelogs': '進階版向網路服務商申請調取目標帳號的註冊與使用記錄',
            'monitor': '監控目標網路流量與運行狀態',
            'datalock': '鎖定指定證據庫記錄，防止駭客篡改或刪除',
            'serverlock': '遠端接管Hacked伺服器，凍結所有數據與操作許可',
            'forensics': '對扣押設備進行數位鑑識，提取隱藏數據與刪除痕跡',
            'firewallboost': '強化己方伺服器防火牆，抵禦駭客反制攻擊',
            'decrypt': '破解加密檔案，復原數據',
            'block': '阻斷目標網路訪問',
            'raid': '抓捕扣押設備',
            'analyze': '分析證據，建立破案鏈',
            'idlock': '正式鎖定目標真實身份，凍結相關身份登記資訊，防止規避追查',
            'wanted': '發布對應等級通緝令',
            'jointask': '發起跨部門聯合行動',
            'progress': '查詢通緝、追捕或聯合行動的即時進度與階段結果',
            'coordinate': '向指定部門發出協助請求',
            'casehandover': '將案件正式移交相關部門，完成程序銜接'
        }
    };

    window.executeCommand = function(commandText) {
        const cmdRaw = commandText.trim();
        if (!cmdRaw) return;
        
        const args = cmdRaw.split(' ');
        const mainCmd = args[0].toLowerCase();
        const role = GameState.currentRole;

        addTerminalLine('$ ' + commandText, 'command');

        // 1. 處理通用指令
        if (CommandDocs.common[mainCmd]) {
            handleCommonCommands(mainCmd, args, role);
            return;
        }

        // 2. 處理角色專屬指令
        if (role === 'hacker' && CommandDocs.hacker[mainCmd]) {
            handleHackerCommands(mainCmd, args);
        } else if (role === 'law_enforcement' && CommandDocs.law_enforcement[mainCmd]) {
            handleLawEnforcementCommands(mainCmd, args);
        } else if (mainCmd === 'help') {
            showHelp(role);
        } else {
            addTerminalLine(`[錯誤] 指令 '${mainCmd}' 未識別。輸入 'help' 查看可用指令。`, 'error');
        }
    };

    function showHelp(role) {
        addTerminalLine('--- 雙方通用指令 ---', 'response');
        for (let c in CommandDocs.common) {
            addTerminalLine(`${c.padEnd(15)} - ${CommandDocs.common[c]}`, 'response');
        }
        addTerminalLine(`--- ${role === 'hacker' ? '黑客角色' : '執法部門'}指令 ---`, 'response');
        const roleCmds = CommandDocs[role];
        for (let c in roleCmds) {
            addTerminalLine(`${c.padEnd(15)} - ${roleCmds[c]}`, 'response');
        }
    }

    function handleCommonCommands(cmd, args, role) {
        const desc = CommandDocs.common[cmd];
        addTerminalLine(`[系統] 執行: ${desc}...`, 'info');

        setTimeout(() => {
            switch(cmd) {
                case 'status':
                    updateGameStats();
                    addTerminalLine(`[狀態] 網路: 在線 | IP: ${GameState.playerIP} | 角色: ${role === 'hacker' ? '黑客' : '執法部門'}`, 'success');
                    break;
                case 'upgrade':
                    addTerminalLine('[升級] 正在掃描可用模組... 系統已升級至最新版本，操作成功率提升。', 'success');
                    break;
                case 'connect':
                    connectToTarget();
                    break;
                case 'disconnect':
                    disconnectFromTarget();
                    break;
                case 'select':
                    showObjectives();
                    break;
                case 'firewall':
                    manageFirewall();
                    break;
                case 'setupvpn':
                    addTerminalLine('[VPN] 正在檢查加密隧道... 節點運行正常，匿名性已維護。', 'success');
                    break;
                case 'block':
                    executeBlock();
                    break;
                case 'analyze':
                    executeAnalyze();
                    break;
                case 'backup':
                    executeBackup();
                    break;
                case 'clear':
                    const output = document.getElementById('terminal-output');
                    if (output) output.innerHTML = '';
                    break;
            }
            updateGameStats();
        }, 1000);
    }

    function handleHackerCommands(cmd, args) {
        const hacker = GameState.playerData.hacker;
        const le = GameState.opponentData.law_enforcement;
        const desc = CommandDocs.hacker[cmd];

        addTerminalLine(`[黑客行動] ${desc}...`, 'info');

        setTimeout(() => {
            switch(cmd) {
                case 'scan':
                    addTerminalLine(`[掃描結果] 目標: ${GameState.opponentIP} | 埠: 80, 443, 22 | 系統: LE-OS v3.0`, 'success');
                    if (typeof executeHackerScanEffect === 'function') executeHackerScanEffect();
                    break;
                case 'crack':
                    addTerminalLine('[成功] 密碼破解完成，獲取管理員權限。', 'success');
                    hacker.money += 500;
                    break;
                case 'inject':
                    addTerminalLine('[成功] 腳本注入成功，正在滲透數據層...', 'success');
                    hacker.money += 1000;
                    break;
                case 'backdoor':
                    addTerminalLine('[成功] 後門程式已植入，遠端控制通道已建立。', 'success');
                    le.serverHealth -= 10;
                    break;
                case 'encrypt':
                    addTerminalLine('[警告] 勒索攻擊啟動，目標檔案正在加密...', 'alert');
                    le.serverHealth -= 20;
                    break;
                case 'stealth':
                    hacker.stealth = Math.min(100, hacker.stealth + 25);
                    addTerminalLine(`[成功] 隱蔽模式已啟動，當前隱蔽度: ${hacker.stealth}%`, 'success');
                    break;
                case 'cleanlog':
                    hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints - 60);
                    addTerminalLine('[成功] 操作日誌已刪除，追蹤難度大幅提升。', 'success');
                    break;
                case 'sqli':
                    addTerminalLine('[成功] SQL注入成功，獲取數據庫核心權限。', 'success');
                    hacker.money += 800;
                    break;
                case 'xss':
                    addTerminalLine('[成功] XSS腳本已執行，成功劫持用戶會話。', 'success');
                    break;
                case 'ddos':
                    le.serverHealth -= 15;
                    addTerminalLine('[成功] DDoS攻擊生效，目標伺服器響應遲緩。', 'success');
                    break;
                case 'phish':
                    addTerminalLine('[成功] 釣魚連結已點擊，獲取目標憑證。', 'success');
                    break;
                case 'ransom':
                    le.serverHealth -= 25;
                    hacker.money += 2000;
                    addTerminalLine('[成功] 勒索軟件部署完成，資金已入賬。', 'success');
                    break;
                case 'fakedata':
                    hacker.evidencePollutionLevel = Math.min(100, hacker.evidencePollutionLevel + 30);
                    addTerminalLine('[成功] 偽造數據已植入，執法部門調查方向已被干擾。', 'success');
                    break;
                case 'dbinfiltrate':
                    le.evidenceCount = Math.max(0, le.evidenceCount - 2);
                    addTerminalLine('[成功] 滲透證據庫成功，關鍵證據已被竄改。', 'success');
                    break;
                case 'servercrash':
                    le.serverHealth -= 35;
                    addTerminalLine('[成功] 執法伺服器崩潰，所有調查進度暫停。', 'success');
                    break;
                case 'rootkit':
                    hacker.stealth = 100;
                    addTerminalLine('[成功] Rootkit已植入，自身進程已完全隱藏。', 'success');
                    break;
            }
            updateGameStats();
        }, 1500);
    }

    function handleLawEnforcementCommands(cmd, args) {
        const le = GameState.playerData.law_enforcement;
        const hacker = GameState.opponentData.hacker;
        const desc = CommandDocs.law_enforcement[cmd];

        addTerminalLine(`[執法行動] ${desc}...`, 'info');

        setTimeout(() => {
            switch(cmd) {
                case 'track1':
                    addTerminalLine(`[追蹤結果] 目標真實IP: ${GameState.opponentIP} | 關聯設備: 3台 | 位置: 隱藏`, 'success');
                    le.identityLockProgress += 12;
                    if (typeof executeTrack1Effect === 'function') executeTrack1Effect();
                    break;
                case 'track2':
                    addTerminalLine('[成功] 電訊商數據已回傳，獲取目標初步身份信息。', 'success');
                    le.identityLockProgress += 18;
                    if (typeof executeTrack2Effect === 'function') executeTrack2Effect();
                    break;
                case 'usagelogs':
                    addTerminalLine('[成功] 註冊記錄已調取，發現目標頻繁活動區域。', 'success');
                    le.evidenceCount++;
                    break;
                case 'monitor':
                    addTerminalLine('[成功] 流量監控已啟動，正在捕獲異常數據包。', 'success');
                    le.investigationProgress += 10;
                    break;
                case 'datalock':
                    addTerminalLine('[成功] 證據庫已鎖定，任何外部竄改嘗試將被攔截。', 'success');
                    break;
                case 'serverlock':
                    addTerminalLine('[成功] 伺服器已接管，黑客操作權限已被凍結。', 'success');
                    hacker.money = Math.floor(hacker.money * 0.4);
                    break;
                case 'forensics':
                    addTerminalLine('[成功] 鑑識完成，提取到已刪除的關鍵日誌。', 'success');
                    le.evidenceCount += 2;
                    break;
                case 'firewallboost':
                    le.serverHealth = Math.min(100, le.serverHealth + 25);
                    addTerminalLine(`[成功] 防火牆強化完成，伺服器健康度: ${le.serverHealth}%`, 'success');
                    break;
                case 'decrypt':
                    addTerminalLine('[成功] 加密檔案已破解，數據復原率 100%。', 'success');
                    le.identityLockProgress += 10;
                    break;
                case 'block':
                    addTerminalLine('[成功] 惡意流量已阻斷，目標無法繼續訪問。', 'success');
                    break;
                case 'raid':
                    if (le.identityLockProgress >= 90) {
                        triggerWin('law_enforcement', '成功抓捕黑客並扣押所有設備，正義得到伸張！');
                    } else {
                        addTerminalLine('[失敗] 身份鎖定不足，抓捕行動失敗。', 'error');
                    }
                    break;
                case 'analyze':
                    le.investigationProgress += 15;
                    addTerminalLine('[成功] 證據分析完成，破案鏈已初步建立。', 'success');
                    break;
                case 'idlock':
                    if (le.identityLockProgress >= 100) {
                        addTerminalLine('[成功] 目標真實身份已鎖定，已發布全球凍結令。', 'success');
                    } else {
                        addTerminalLine('[失敗] 鎖定進度不足，無法確認身份。', 'error');
                    }
                    break;
                case 'wanted':
                    addTerminalLine('[成功] 通緝令已發布，目標在所有匿名網絡的權限受限。', 'success');
                    le.investigationProgress += 10;
                    break;
                case 'jointask':
                    addTerminalLine('[成功] 跨部門行動啟動，獲得額外計算資源。', 'success');
                    le.investigationProgress += 20;
                    break;
                case 'progress':
                    addTerminalLine(`[進度] 調查: ${le.investigationProgress}% | 身份鎖定: ${le.identityLockProgress}% | 證據: ${le.evidenceCount}`, 'response');
                    break;
                case 'coordinate':
                    addTerminalLine('[成功] 協助請求已發出，獲得技術專家支援。', 'success');
                    break;
                case 'casehandover':
                    if (le.evidenceCount >= 5) {
                        triggerWin('law_enforcement', '案件移交成功，黑客已被正式起訴。');
                    } else {
                        addTerminalLine('[失敗] 證據不足，無法進行案件移交。', 'error');
                    }
                    break;
            }
            updateGameStats();
        }, 1500);
    }

    // 初始化
    injectMissingTools();
}

// 在遊戲初始化後執行擴展
setTimeout(extendCommandSystemV3, 1000);


function applyUIOptimizations() {
    // 1. 注入響應式與暗網風格 CSS
    const style = document.createElement('style');
    style.textContent = `
        /* 暗網中介聯絡站風格重塑 */
        .darknet-hub {
            background: #050505 !important;
            border: 1px solid #00ff41 !important;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2) !important;
            color: #00ff41 !important;
        }
        .darknet-hub .hub-title {
            text-shadow: 0 0 10px #00ff41;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        /* 修復快捷按鈕彈出視窗遮蓋問題 */
        .modal-content, .quick-action-popup, .shop-modal-content {
            max-height: 85vh !important;
            overflow-y: auto !important;
            padding: 20px !important;
            width: 90% !important;
            max-width: 600px !important;
            margin: auto !important;
            background: rgba(10, 10, 20, 0.98) !important;
            border: 1px solid #4a90d9 !important;
            border-radius: 10px !important;
            box-shadow: 0 0 30px rgba(0,0,0,0.8) !important;
        }

        /* 確保文字不被遮擋 */
        .quick-btn, .node-action-btn, .tool-card {
            white-space: normal !important;
            height: auto !important;
            min-height: 40px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
            padding: 8px 12px !important;
            font-size: 0.85rem !important;
            line-height: 1.2 !important;
        }

        /* 手機版適配 (Mobile Support) */
        @media (max-width: 768px) {
            .game-main {
                flex-direction: column !important;
            }
            .left-panel, .right-panel {
                width: 100% !important;
                margin-bottom: 20px !important;
            }
            .terminal-container {
                height: 300px !important;
            }
            .nav-menu {
                display: none !important;
            }
            .hamburger-menu {
                display: flex !important;
            }
            nav {
                padding: 0 15px !important;
            }
            .nav-logo {
                font-size: 1rem !important;
                letter-spacing: 1px !important;
            }
            .main-logo {
                font-size: 1.8rem !important;
            }
            .mode-selection {
                grid-template-columns: 1fr !important;
            }
            .quick-actions-panel {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            .game-stats {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* 電腦版優化 */
        @media (min-width: 769px) {
            .game-main {
                display: flex !important;
                gap: 20px !important;
                height: calc(100vh - 100px) !important;
            }
            .left-panel { flex: 2 !important; }
            .right-panel { flex: 1 !important; }
        }

        /* 滾動條美化 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a90d9;
        }
    `;
    document.head.appendChild(style);

    // 2. 修正暗網聯絡站的 HTML 結構與顯示
    window.openDarknetHub = function() {
        const hub = document.getElementById('darknet-hub-panel');
        if (hub) {
            hub.classList.add('darknet-hub');
            hub.style.display = 'block';
            addTerminalLine('[系統] 正在通過 Tor 網絡接入暗網中介聯絡站...', 'info');
        } else {
            // 如果不存在則動態創建
            createDarknetHub();
        }
    };

    function createDarknetHub() {
        const hubDiv = document.createElement('div');
        hubDiv.id = 'darknet-hub-panel';
        hubDiv.className = 'modal darknet-hub';
        hubDiv.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:1000; width:90%; max-width:800px; background:#050505; border:1px solid #00ff41; padding:20px; display:block;';
        hubDiv.innerHTML = `
            <div class="hub-header" style="display:flex; justify-content:space-between; border-bottom:1px solid #00ff41; padding-bottom:10px; margin-bottom:20px;">
                <h2 class="hub-title" style="color:#00ff41; margin:0;"><i class="fas fa-user-secret"></i> 暗網中介聯絡站</h2>
                <button onclick="this.parentElement.parentElement.style.display='none'" style="background:none; border:none; color:#00ff41; cursor:pointer; font-size:1.5rem;">&times;</button>
            </div>
            <div class="hub-body" style="color:#00ff41; font-family:monospace;">
                <p>> 歡迎來到中立區。在這裡，信息是唯一的貨幣。</p>
                <div class="hub-services" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-top:20px;">
                    <div class="service-card" style="border:1px solid #00ff41; padding:15px; cursor:pointer;" onclick="addTerminalLine('[暗網] 正在獲取最新黑市情報...', 'success')">
                        <h4>[情報交易]</h4>
                        <p>購買或出售目標系統的零日漏洞信息。</p>
                    </div>
                    <div class="service-card" style="border:1px solid #00ff41; padding:15px; cursor:pointer;" onclick="addTerminalLine('[暗網] 正在聯繫洗錢中介...', 'success')">
                        <h4>[資金清洗]</h4>
                        <p>將非法獲取的資金轉化為安全資產。</p>
                    </div>
                    <div class="service-card" style="border:1px solid #00ff41; padding:15px; cursor:pointer;" onclick="addTerminalLine('[暗網] 正在招募僱傭黑客...', 'success')">
                        <h4>[僱傭服務]</h4>
                        <p>發起聯合攻擊或請求技術支援。</p>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(hubDiv);
    }

    // 3. 修正快捷按鈕點擊事件，確保不被遮擋
    const originalShowNotification = window.showNotification;
    window.showNotification = function(title, message, type) {
        if (originalShowNotification) originalShowNotification(title, message, type);
        // 額外確保通知在手機端顯示在頂部
        const notifications = document.querySelectorAll('.notification');
        notifications.forEach(n => {
            n.style.zIndex = '9999';
            if (window.innerWidth <= 768) {
                n.style.top = '10px';
                n.style.right = '10px';
                n.style.left = '10px';
                n.style.width = 'auto';
            }
        });
    };
}

// 延遲執行以確保 DOM 加載完成
setTimeout(applyUIOptimizations, 1500);




/**
 * 執法部門高級情報系統
 * 1. 實時證據庫監控
 * 2. 指揮中心儀表板 (動態數據)
 * 3. 超詳盡調查報告 (動態文本)
 * 4. 行動匯報邊框
 */

function applyLEIntelligenceSystem() {
    // 1. 注入高級儀表板 CSS
    const style = document.createElement('style');
    style.textContent = `
        .le-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .le-card {
            background: rgba(10, 20, 40, 0.9);
            border: 1px solid #4a90d9;
            border-radius: 8px;
            padding: 15px;
            color: #fff;
            font-family: 'Courier New', monospace;
        }
        .le-card-title {
            color: #4a90d9;
            font-weight: bold;
            border-bottom: 1px solid rgba(74, 144, 217, 0.3);
            padding-bottom: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        .evidence-list {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.85rem;
        }
        .evidence-item {
            padding: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
        }
        .status-report-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 10, 20, 0.95);
            border-top: 2px solid #4a90d9;
            padding: 10px 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9rem;
            color: #4a90d9;
            overflow: hidden;
        }
        .report-ticker {
            white-space: nowrap;
            animation: ticker 30s linear infinite;
        }
        @keyframes ticker {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .analysis-text {
            font-size: 0.85rem;
            line-height: 1.5;
            color: #aaa;
            height: 120px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 4px;
        }
        .gauge-container {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .gauge {
            text-align: center;
        }
        .gauge-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00ff41;
        }
        .gauge-label {
            font-size: 0.7rem;
            color: #888;
        }
    `;
    document.head.appendChild(style);

    // 2. 動態生成執法部門情報面板
    function updateLEIntelligenceUI() {
        if (GameState.currentRole !== 'law_enforcement') return;

        const le = GameState.playerData.law_enforcement;
        const hacker = GameState.opponentData.hacker;
        
        // 尋找適合插入的位置 (例如在終端機下方)
        let intelPanel = document.getElementById('le-intelligence-panel');
        if (!intelPanel) {
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) {
                intelPanel = document.createElement('div');
                intelPanel.id = 'le-intelligence-panel';
                rightPanel.prepend(intelPanel);
            }
        }

        if (intelPanel) {
            // 生成動態分析文本
            let analysis = `[實時分析報告] 偵測到目標正在使用 ${hacker.activeVpnNodes || 0} 層加密代理。`;
            if (le.identityLockProgress > 20) analysis += ` 根據流量特徵，目標行為模式與已知黑客組織 "Shadow" 匹配度達 ${le.identityLockProgress + 10}%。`;
            if (le.evidenceCount > 2) analysis += ` 關鍵證據顯示目標曾於 ${new Date().toLocaleTimeString()} 嘗試滲透核心數據庫。`;
            if (le.investigationProgress > 50) analysis += ` 身份鎖定已進入物理定位階段，正在縮小搜索半徑...`;

            intelPanel.innerHTML = `
                <div class="le-dashboard">
                    <div class="le-card">
                        <div class="le-card-title">
                            <span><i class="fas fa-database"></i> 實時證據庫</span>
                            <span style="font-size:0.7rem;">總計: ${le.evidenceCount}</span>
                        </div>
                        <div class="evidence-list" id="le-evidence-list">
                            <div class="evidence-item"><span>IP 訪問日誌</span><span style="color:#00ff41;">已驗證</span></div>
                            <div class="evidence-item"><span>惡意代碼樣本</span><span style="color:#00ff41;">已提取</span></div>
                            ${le.evidenceCount > 2 ? '<div class="evidence-item"><span>加密通訊片段</span><span style="color:#ff9900;">解析中</span></div>' : ''}
                            ${le.evidenceCount > 4 ? '<div class="evidence-item"><span>物理位置信號</span><span style="color:#ff4444;">追蹤中</span></div>' : ''}
                        </div>
                    </div>
                    <div class="le-card">
                        <div class="le-card-title">
                            <span><i class="fas fa-chart-pie"></i> 指揮中心儀表板</span>
                        </div>
                        <div class="gauge-container">
                            <div class="gauge">
                                <div class="gauge-value">${le.serverHealth}%</div>
                                <div class="gauge-label">系統健康</div>
                            </div>
                            <div class="gauge">
                                <div class="gauge-value">${le.identityLockProgress}%</div>
                                <div class="gauge-label">身份鎖定</div>
                            </div>
                            <div class="gauge">
                                <div class="gauge-value">${le.investigationProgress}%</div>
                                <div class="gauge-label">調查進度</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="le-card" style="margin-top:15px;">
                    <div class="le-card-title"><span><i class="fas fa-file-alt"></i> 深度調查報告</span></div>
                    <div class="analysis-text">${analysis}</div>
                </div>
            `;
        }

        // 更新下方行動匯報邊框
        let tickerBar = document.getElementById('le-status-ticker');
        if (!tickerBar) {
            tickerBar = document.createElement('div');
            tickerBar.id = 'le-status-ticker';
            tickerBar.className = 'status-report-bar';
            document.body.appendChild(tickerBar);
        }
        
        const latestAction = `[最新匯報] 調查進度: ${le.investigationProgress}% | 身份鎖定: ${le.identityLockProgress}% | 證據蒐集: ${le.evidenceCount}/5 | 建議行動: ${le.identityLockProgress < 50 ? '加強監控' : '申請拘捕令'} | 系統狀態: 運行正常...`;
        tickerBar.innerHTML = `<div style="font-weight:bold; background:#4a90d9; color:#000; padding:2px 10px; border-radius:4px;">LIVE REPORT</div><div class="report-ticker">${latestAction}</div>`;
    }

    // 3. 整合到遊戲循環
    const originalUpdateGameStats = window.updateGameStats;
    window.updateGameStats = function() {
        if (originalUpdateGameStats) originalUpdateGameStats();
        updateLEIntelligenceUI();
    };

    // 初始執行一次
    setTimeout(updateLEIntelligenceUI, 2000);
}

// 執行擴展
applyLEIntelligenceSystem();




/**
 * UI 佈局修復與雙方監控系統
 * 1. 徹底修復手機端文字遮蓋
 * 2. 新增雙方設備實時監控 (本地 vs 目標)
 * 3. 明確標示與視覺區分
 */

function applyUIAndMonitorFix() {
    // 1. 注入修復 CSS
    const style = document.createElement('style');
    style.textContent = `
        /* 徹底修復手機端彈出視窗遮蓋 */
        .modal-content, .darknet-hub, #le-intelligence-panel, .le-card {
            width: 95% !important;
            max-width: 95vw !important;
            margin: 10px auto !important;
            padding: 15px !important;
            box-sizing: border-box !important;
            overflow-x: hidden !important;
        }

        /* 修復截圖中的按鈕遮蓋問題 */
        .hub-services, .quick-actions-panel, .le-dashboard {
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
        }

        .service-card, .quick-btn, .le-card {
            width: 100% !important;
            margin: 0 !important;
            box-sizing: border-box !important;
        }

        /* 雙方監控面板樣式 */
        .dual-monitor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        @media (max-width: 768px) {
            .dual-monitor-container {
                grid-template-columns: 1fr !important;
            }
        }

        .monitor-box {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            padding: 10px;
            font-size: 0.8rem;
            position: relative;
        }
        .monitor-box.local { border: 1px solid #4a90d9; }
        .monitor-box.target { border: 1px solid #ff4444; }

        .monitor-tag {
            position: absolute;
            top: -10px;
            left: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .local .monitor-tag { background: #4a90d9; color: #fff; }
        .target .monitor-tag { background: #ff4444; color: #fff; }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stat-label { color: #888; }
        .stat-value { color: #fff; font-family: monospace; }

        /* 修正按鈕文字不換行導致的遮蓋 */
        .btn, .quick-btn {
            white-space: normal !important;
            word-break: break-word !important;
            text-align: center !important;
            line-height: 1.2 !important;
            padding: 10px !important;
        }
    `;
    document.head.appendChild(style);

    // 2. 實作雙方監控更新邏輯
    function updateDualMonitorUI() {
        const role = GameState.currentRole;
        const localData = GameState.playerData[role];
        const targetData = GameState.opponentData[role === 'hacker' ? 'law_enforcement' : 'hacker'];

        let monitorContainer = document.getElementById('dual-monitor-panel');
        if (!monitorContainer) {
            const targetParent = document.querySelector('.left-panel') || document.body;
            monitorContainer = document.createElement('div');
            monitorContainer.id = 'dual-monitor-panel';
            monitorContainer.className = 'dual-monitor-container';
            targetParent.prepend(monitorContainer);
        }

        // 本地數據
        const localStats = role === 'hacker' ? 
            `<div class="stat-row"><span class="stat-label">隱蔽等級:</span><span class="stat-value">${localData.stealth}%</span></div>
             <div class="stat-row"><span class="stat-label">加密強度:</span><span class="stat-value">${localData.encryptionLevel || 100}%</span></div>
             <div class="stat-row"><span class="stat-label">VPN節點:</span><span class="stat-value">${localData.activeVpnNodes || 0}</span></div>` :
            `<div class="stat-row"><span class="stat-label">系統健康:</span><span class="stat-value">${localData.serverHealth}%</span></div>
             <div class="stat-row"><span class="stat-label">調查進度:</span><span class="stat-value">${localData.investigationProgress}%</span></div>
             <div class="stat-row"><span class="stat-label">證據數量:</span><span class="stat-value">${localData.evidenceCount}</span></div>`;

        // 目標數據
        const targetStats = role === 'hacker' ?
            `<div class="stat-row"><span class="stat-label">目標健康:</span><span class="stat-value">${targetData.serverHealth}%</span></div>
             <div class="stat-row"><span class="stat-label">防火牆等級:</span><span class="stat-value">HIGH</span></div>
             <div class="stat-row"><span class="stat-label">偵測風險:</span><span class="stat-value">${100 - localData.stealth}%</span></div>` :
            `<div class="stat-row"><span class="stat-label">目標隱蔽:</span><span class="stat-value">${targetData.stealth}%</span></div>
             <div class="stat-row"><span class="stat-label">身份鎖定:</span><span class="stat-value">${localData.identityLockProgress}%</span></div>
             <div class="stat-row"><span class="stat-label">活動頻率:</span><span class="stat-value">頻繁</span></div>`;

        monitorContainer.innerHTML = `
            <div class="monitor-box local">
                <div class="monitor-tag">本地設備 [${role === 'hacker' ? '黑客端' : '執法端'}]</div>
                ${localStats}
                <div class="stat-row"><span class="stat-label">CPU 負載:</span><span class="stat-value">${Math.floor(Math.random()*30 + 10)}%</span></div>
            </div>
            <div class="monitor-box target">
                <div class="monitor-tag">目標設備 [${role === 'hacker' ? '執法端' : '黑客端'}]</div>
                ${targetStats}
                <div class="stat-row"><span class="stat-label">網絡延遲:</span><span class="stat-value">${Math.floor(Math.random()*50 + 20)}ms</span></div>
            </div>
        `;
    }

    // 3. 整合到遊戲循環
    const originalUpdateStats = window.updateGameStats;
    window.updateGameStats = function() {
        if (originalUpdateStats) originalUpdateStats();
        updateDualMonitorUI();
    };

    // 初始執行
    setTimeout(updateDualMonitorUI, 2000);
}

// 執行修復
applyUIAndMonitorFix();




/**
 * 終極修復與功能商店系統
 * 1. 徹底解決所有裝置 UI 遮蓋 (移除所有固定寬度)
 * 2. 實作功能完整、商品豐富的商店系統
 * 3. 強化視覺標示與圖標
 */

function applyUltimateFixAndShop() {
    // 1. 注入終極響應式 CSS
    const style = document.createElement('style');
    style.textContent = `
        /* 徹底解決溢出與遮蓋 */
        *, *:before, *:after {
            box-sizing: border-box !important;
        }

        .modal-content, .darknet-hub, .shop-modal-content, .le-card, .tool-card {
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 auto !important;
            right: auto !important;
            left: auto !important;
            position: relative !important;
            transform: none !important;
            display: block !important;
        }

        /* 彈出視窗容器修復 */
        .modal, #shop-modal, #darknet-hub-panel {
            padding: 10px !important;
            overflow-y: auto !important;
            display: none; /* 初始隱藏 */
        }

        /* 手機端強制單欄 */
        @media (max-width: 768px) {
            .hub-services, .tools-grid, .shop-items-grid, .le-dashboard {
                display: flex !important;
                flex-direction: column !important;
                width: 100% !important;
            }
            .service-card, .tool-card, .shop-item, .le-card {
                width: 100% !important;
                margin-bottom: 10px !important;
            }
        /* ===== 額外響應式優化 ===== */
        @media (max-width: 480px) {
            nav {
                height: 50px !important;
                padding: 0 10px !important;
            }

            .nav-logo {
                font-size: 0.9rem !important;
            }

            .hamburger-menu span {
                width: 20px !important;
                height: 2px !important;
            }

            .darknet-title {
                font-size: 1.5rem !important;
            }

            .guide-title {
                font-size: 1.5rem !important;
            }

            .shop-title {
                font-size: 1.5rem !important;
            }

            .darknet-services {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            .service-card {
                padding: 15px !important;
            }

            .guide-section {
                padding: 15px !important;
                margin-bottom: 15px !important;
            }

            .shop-items-display {
                grid-template-columns: 1fr !important;
            }

            .shop-categories-bar {
                flex-direction: column !important;
                gap: 5px !important;
            }

            .category-btn {
                width: 100% !important;
            }

            #main-page {
                padding: 70px 10px 20px !important;
            }

            .main-logo {
                font-size: 2rem !important;
            }

            .mode-selection {
                gap: 15px !important;
                padding: 0 10px !important;
            }

            .mode-card {
                padding: 20px 15px !important;
            }
        }

        /* ===== 平板優化 ===== */
        @media (min-width: 481px) and (max-width: 1024px) {
            .darknet-services {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .shop-items-display {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .guide-sections {
                gap: 20px !important;
            }
        }

        /* ===== 桌面優化 ===== */
        @media (min-width: 1025px) {
            .darknet-services {
                grid-template-columns: repeat(3, 1fr) !important;
            }

            .shop-items-display {
                grid-template-columns: repeat(4, 1fr) !important;
            }
        }

        /* ===== 觸摸設備優化 ===== */
        @media (hover: none) and (pointer: coarse) {
            .service-card,
            .shop-item-full,
            .guide-section {
                padding: 20px !important;
            }

            .service-card:active,
            .shop-item-full:active {
                background: rgba(255, 153, 0, 0.2) !important;
                transform: scale(0.98) !important;
            }

            button {
                min-height: 44px !important;
                min-width: 44px !important;
            }
        }

        /* ===== 深色模式支持 ===== */
        @media (prefers-color-scheme: dark) {
            body {
                background: #000 !important;
            }

            .guide-section {
                background: rgba(25, 25, 40, 0.9) !important;
            }

            .shop-item-full {
                background: rgba(25, 25, 40, 0.95) !important;
            }
        }

        /* ===== 無障礙支持 ===== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ===== 高對比度支持 ===== */
        @media (prefers-contrast: more) {
            .nav-menu li a {
                font-weight: bold !important;
            }

            .service-card {
                border-width: 3px !important;
            }

            .shop-item-full {
                border-width: 3px !important;
            }
        }

        /* ===== 打印樣式 ===== */
        @media print {
            nav,
            .hamburger-menu,
            .nav-menu-mobile,
            .btn {
                display: none !important;
            }

            .page {
                page-break-after: always !important;
                padding: 0 !important;
            }
        }

        }

        /* 商店系統樣式 */
        .shop-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            padding: 10px;
        }
        .shop-item {
            background: rgba(20, 30, 50, 0.8);
            border: 1px solid #4a90d9;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        .shop-item:hover {
            border-color: #00ff41;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
        }
        .shop-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: #4a90d9;
            font-weight: bold;
        }
        .shop-item-icon {
            font-size: 1.5rem;
        }
        .shop-item-price {
            color: #ff9900;
            font-weight: bold;
            margin-top: 10px;
        }
        .buy-btn {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: #4a90d9;
            border: none;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
        }
        .buy-btn:hover { background: #00ff41; }
    `;
    document.head.appendChild(style);

    // 2. 實作功能商店系統
    const ShopData = {
        hacker: [
            { id: 'zero_day', name: '零日漏洞 (0-Day)', icon: 'fa-bug', price: 2000, effect: '大幅提升攻擊成功率', action: () => { addTerminalLine('[商店] 購買成功：已獲得核心系統零日漏洞。', 'success'); } },
            { id: 'super_server', name: '高性能伺服器集群', icon: 'fa-server', price: 5000, effect: 'DDoS 威力提升 50%', action: () => { addTerminalLine('[商店] 購買成功：伺服器集群已上線。', 'success'); } },
            { id: 'quantum_enc', name: '量子加密模組', icon: 'fa-lock', price: 3500, effect: '隱蔽等級上限提升', action: () => { GameState.playerData.hacker.stealth = 100; addTerminalLine('[商店] 購買成功：量子加密已部署。', 'success'); } },
            { id: 'ai_phish', name: 'AI 自動化釣魚系統', icon: 'fa-robot', price: 1500, effect: '釣魚成功率提升', action: () => { addTerminalLine('[商店] 購買成功：AI 釣魚系統已啟動。', 'success'); } }
        ],
        law_enforcement: [
            { id: 'super_comp', name: '超級計算機訪問權', icon: 'fa-microchip', price: 4000, effect: '解密速度提升 100%', action: () => { addTerminalLine('[商店] 購買成功：已接入國家級超算中心。', 'success'); } },
            { id: 'sat_track', name: '衛星實時追蹤授權', icon: 'fa-satellite', price: 6000, effect: '身份鎖定進度大幅提升', action: () => { GameState.playerData.law_enforcement.identityLockProgress += 20; addTerminalLine('[商店] 購買成功：衛星追蹤已授權。', 'success'); } },
            { id: 'deep_forensics', name: '深度鑑識套件 Pro', icon: 'fa-search', price: 2500, effect: '證據蒐集效率提升', action: () => { GameState.playerData.law_enforcement.evidenceCount += 1; addTerminalLine('[商店] 購買成功：鑑識套件已升級。', 'success'); } },
            { id: 'isp_backdoor', name: 'ISP 骨幹網監控權', icon: 'fa-network-wired', price: 3000, effect: '監控範圍覆蓋全網', action: () => { addTerminalLine('[商店] 購買成功：ISP 數據流已接入。', 'success'); } }
        ]
    };

    window.openShop = function() {
        const role = GameState.currentRole;
        const items = ShopData[role];
        const money = role === 'hacker' ? GameState.playerData.hacker.money : GameState.playerData.law_enforcement.budget || 10000;

        let shopModal = document.getElementById('shop-modal');
        if (!shopModal) {
            shopModal = document.createElement('div');
            shopModal.id = 'shop-modal';
            shopModal.className = 'modal';
            shopModal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:flex; align-items:center; justify-content:center;';
            document.body.appendChild(shopModal);
        }

        shopModal.style.display = 'flex';
        shopModal.innerHTML = `
            <div class="shop-modal-content" style="background:#0a0a1a; border:2px solid #4a90d9; border-radius:10px; padding:20px; width:95%; max-width:800px; max-height:90vh; overflow-y:auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #4a90d9; padding-bottom:10px; margin-bottom:20px;">
                    <h2 style="color:#4a90d9; margin:0;"><i class="fas fa-shopping-cart"></i> 裝備商店 [可用資金: $${money}]</h2>
                    <button onclick="document.getElementById('shop-modal').style.display='none'" style="background:none; border:none; color:#fff; font-size:2rem; cursor:pointer;">&times;</button>
                </div>
                <div class="shop-items-grid">
                    ${items.map(item => `
                        <div class="shop-item">
                            <div class="shop-item-header">
                                <i class="fas ${item.icon} shop-item-icon"></i>
                                <span>${item.name}</span>
                            </div>
                            <p style="font-size:0.85rem; color:#aaa; margin:5px 0;">${item.effect}</p>
                            <div class="shop-item-price">$${item.price}</div>
                            <button class="buy-btn" onclick="buyShopItem('${item.id}')">購買</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    };

    // delegated to ShopSystem elsewhere

    // 3. 修正所有彈出視窗的觸發邏輯
    window.openHackerShop = openShop;
    window.openLEShop = openShop;
}

// 執行終極修復
setTimeout(applyUltimateFixAndShop, 2000);




/**
 * 執法部門終極收網系統
 * 1. 關鍵證據提取與匯報
 * 2. 跨部門協作技能
 * 3. 司法程序 (通緝令/拘捕令)
 * 4. 收網倒計時
 */

function applyTakedownSystem() {
    // 1. 注入收網視覺特效 CSS
    const style = document.createElement('style');
    style.textContent = `
        .takedown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.2);
            z-index: 9999;
            pointer-events: none;
            animation: pulse-red 1s infinite;
            display: none;
        }
        @keyframes pulse-red {
            0% { opacity: 0.2; }
            50% { opacity: 0.5; }
            100% { opacity: 0.2; }
        }
        .warrant-doc {
            background: #fff;
            color: #000;
            padding: 30px;
            font-family: 'Times New Roman', serif;
            border: 5px double #000;
            max-width: 500px;
            margin: 20px auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .warrant-header {
            text-align: center;
            border-bottom: 2px solid #000;
            margin-bottom: 20px;
        }
        .countdown-timer {
            font-size: 4rem;
            font-weight: bold;
            color: #ff4444;
            text-align: center;
            text-shadow: 0 0 20px #ff0000;
        }
    `;
    document.head.appendChild(style);

    // 2. 實作收網邏輯
    window.startTakedownProcess = function() {
        const le = GameState.playerData.law_enforcement;
        if (le.evidenceCount < 5) {
            showNotification('條件不足', '需要至少 5 項關鍵證據才能啟動收網程序', 'error');
            return;
        }

        // 第一步：提取關鍵證據並匯報
        addTerminalLine('[司法] 正在提取關鍵證據清單...', 'info');
        setTimeout(() => {
            const evidenceList = [
                "1. 攻擊源 IP 物理定位日誌 (已驗證)",
                "2. 加密貨幣洗錢路徑追蹤報告 (已關聯)",
                "3. 目標設備 MAC 地址與硬體特徵 (已鎖定)",
                "4. 跨國伺服器租賃實名信息 (已獲取)",
                "5. 惡意代碼編寫習慣行為建模 (已匹配)"
            ];
            evidenceList.forEach(e => addTerminalLine(e, 'success'));
            addTerminalLine('[司法] 證據清單已提交至上司與法務部門。', 'info');
            
            // 第二步：申請跨部門協作
            setTimeout(() => {
                showJointTaskDialog();
            }, 2000);
        }, 1500);
    };

    function showJointTaskDialog() {
        const modal = document.createElement('div');
        modal.id = 'takedown-modal';
        modal.className = 'modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; align-items:center; justify-content:center;';
        document.body.appendChild(modal);

        modal.innerHTML = `
            <div class="modal-content" style="background:#0a0a1a; border:2px solid #4a90d9; padding:30px; max-width:600px; text-align:center;">
                <h2 style="color:#4a90d9;"><i class="fas fa-users"></i> 啟動跨部門聯合行動</h2>
                <p>證據已充足。是否立即協調網絡安全中心、國際刑警與本地執法隊伍進行同步收網？</p>
                <button class="btn btn-primary" onclick="executeJointTask()" style="margin-top:20px; padding:10px 30px;">啟動聯合行動</button>
            </div>
        `;
    }

    window.executeJointTask = function() {
        document.getElementById('takedown-modal').remove();
        addTerminalLine('[行動] 跨部門聯合行動已啟動！資源正在整合...', 'alert');
        GameState.playerData.law_enforcement.identityLockProgress = 100;
        updateGameStats();

        setTimeout(() => {
            showWarrantAndWanted();
        }, 2000);
    };

    function showWarrantAndWanted() {
        const modal = document.createElement('div');
        modal.id = 'warrant-modal';
        modal.className = 'modal';
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; display:flex; align-items:center; justify-content:center; overflow-y:auto;';
        document.body.appendChild(modal);

        modal.innerHTML = `
            <div class="modal-content" style="width:95%; max-width:600px;">
                <div class="warrant-doc">
                    <div class="warrant-header">
                        <h1>正式拘捕令</h1>
                        <h3>ARREST WARRANT</h3>
                    </div>
                    <p><strong>案號：</strong> LE-2026-SHADOW-01</p>
                    <p><strong>目標代號：</strong> SHADOW (未知黑客)</p>
                    <p><strong>罪名：</strong> 非法入侵國家級數據中心、大規模勒索攻擊、洗錢及破壞公共網絡安全。</p>
                    <p><strong>法官批示：</strong> 證據確鑿，准予立即執行抓捕並扣押所有數位設備。</p>
                    <div style="text-align:right; margin-top:30px;">
                        <p>____________________</p>
                        <p>高等法院 簽發</p>
                    </div>
                </div>
                <button class="btn btn-danger" onclick="startFinalCountdown()" style="width:100%; margin-top:20px; font-size:1.2rem;">啟動收網倒計時</button>
            </div>
        `;
    }

    window.startFinalCountdown = function() {
        document.getElementById('warrant-modal').remove();
        const overlay = document.createElement('div');
        overlay.className = 'takedown-overlay';
        overlay.style.display = 'block';
        document.body.appendChild(overlay);

        const countdownDiv = document.createElement('div');
        countdownDiv.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:10001; text-align:center;';
        document.body.appendChild(countdownDiv);

        let timeLeft = 10;
        const timer = setInterval(() => {
            countdownDiv.innerHTML = `
                <h1 style="color:#fff; letter-spacing:10px;">收網行動執行中</h1>
                <div class="countdown-timer">${timeLeft}</div>
                <p style="color:#ff4444;">正在切斷目標網絡並執行實體抓捕...</p>
            `;
            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(timer);
                triggerWin('law_enforcement', '收網行動圓滿成功！黑客已被逮捕，所有設備已扣押，正義得到伸張。');
            }
        }, 1000);
    };

    // 3. 覆蓋原有的 raid 指令以觸發新流程
    const originalExecuteCommand = window.executeCommand;
    window.executeCommand = function(commandText) {
        const cmd = commandText.toLowerCase().trim();
        if (cmd === 'raid' && GameState.currentRole === 'law_enforcement') {
            startTakedownProcess();
        } else {
            originalExecuteCommand(commandText);
        }
    };
}

// 執行系統
setTimeout(applyTakedownSystem, 2500);




/**
 * 雙方終極勝負判定系統
 * 1. 倒計時對決機制 (最後反擊)
 * 2. 動態勝負判定邏輯
 * 3. 專屬結局動畫與報告
 */

function applyVictorySystem() {
    // 1. 結局動畫 CSS
    const style = document.createElement('style');
    style.textContent = `
        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 20000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: 'Courier New', monospace;
            padding: 20px;
            text-align: center;
            animation: fadeIn 1s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .case-closed-stamp {
            font-size: 5rem;
            color: #ff4444;
            border: 10px solid #ff4444;
            padding: 20px;
            transform: rotate(-20deg);
            margin-bottom: 30px;
            animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes stampIn { from { transform: scale(5) rotate(0deg); opacity: 0; } to { transform: scale(1) rotate(-20deg); opacity: 1; } }

        .hacker-win-anim {
            font-size: 3rem;
            color: #00ff41;
            text-shadow: 0 0 20px #00ff41;
            margin-bottom: 30px;
        }
        .final-report {
            background: rgba(255,255,255,0.1);
            border: 1px solid #4a90d9;
            padding: 20px;
            max-width: 600px;
            width: 100%;
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
        }
        .restart-btn {
            margin-top: 30px;
            padding: 10px 40px;
            background: #4a90d9;
            border: none;
            color: #000;
            font-weight: bold;
            cursor: pointer;
        }
    `;
    document.head.appendChild(style);

    // 2. 覆蓋 startFinalCountdown 實作對決邏輯
    window.startFinalCountdown = function() {
        document.getElementById('warrant-modal')?.remove();
        const overlay = document.createElement('div');
        overlay.className = 'takedown-overlay';
        overlay.style.display = 'block';
        document.body.appendChild(overlay);

        const countdownDiv = document.createElement('div');
        countdownDiv.id = 'final-battle-div';
        countdownDiv.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:10001; text-align:center; width:90%;';
        document.body.appendChild(countdownDiv);

        let timeLeft = 30; // 增加到 30 秒進行最後對決
        const battleTimer = setInterval(() => {
            const le = GameState.playerData.law_enforcement;
            const hacker = GameState.playerData.hacker;
            const role = GameState.currentRole;

            // 實時判定勝負條件
            if (role === 'law_enforcement') {
                // 執法勝：實體鎖定 100%
                if (le.identityLockProgress >= 100) {
                    clearInterval(battleTimer);
                    showVictory('law_enforcement', '實體定位完成，目標已被現場抓獲！');
                    return;
                }
                // 黑客勝：執法系統癱瘓
                if (le.serverHealth <= 0) {
                    clearInterval(battleTimer);
                    showVictory('hacker', '執法指揮中心崩潰，黑客成功反制並銷毀所有證據！');
                    return;
                }
            } else {
                // 黑客勝：足跡清零
                if (hacker.digitalFootprints <= 0) {
                    clearInterval(battleTimer);
                    showVictory('hacker', '所有網絡痕跡已完整消滅，黑客成功完美撤離！');
                    return;
                }
                // 執法勝：黑客被追蹤到
                if (le.identityLockProgress >= 100) {
                    clearInterval(battleTimer);
                    showVictory('law_enforcement', '追蹤程序完成，執法部門已鎖定您的物理位置！');
                    return;
                }
            }

            countdownDiv.innerHTML = `
                <h1 style="color:#fff; letter-spacing:5px;">${role === 'law_enforcement' ? '收網行動執行中' : '偵測到司法抓捕行動'}</h1>
                <div class="countdown-timer" style="font-size:5rem; color:#ff4444;">${timeLeft}s</div>
                <p style="color:#ff4444; font-weight:bold;">${role === 'law_enforcement' ? '正在切斷目標網絡... 請維持系統穩定！' : '警告：執法部門正在逼近！立即清除痕跡或癱瘓其系統！'}</p>
                <div style="margin-top:20px; background:rgba(255,255,255,0.1); padding:10px; border-radius:5px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>系統穩定度: ${le.serverHealth}%</span>
                        <span>身份鎖定: ${le.identityLockProgress}%</span>
                    </div>
                    <div style="width:100%; height:10px; background:#333;">
                        <div style="width:${le.identityLockProgress}%; height:100%; background:#4a90d9;"></div>
                    </div>
                </div>
            `;

            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(battleTimer);
                // 倒計時結束判定
                if (le.serverHealth > 0) {
                    showVictory('law_enforcement', '倒計時結束，執法部門成功守住系統並完成抓捕。');
                } else {
                    showVictory('hacker', '倒計時結束，黑客成功在系統崩潰前逃脫。');
                }
            }
        }, 1000);
    };

    // 3. 顯示結局動畫與報告
    window.showVictory = function(winner, reason) {
        document.getElementById('final-battle-div')?.remove();
        document.querySelector('.takedown-overlay')?.remove();

        const screen = document.createElement('div');
        screen.className = 'victory-screen';
        document.body.appendChild(screen);

        if (winner === 'law_enforcement') {
            screen.innerHTML = `
                <div class="case-closed-stamp">CASE CLOSED</div>
                <h2 style="color:#4a90d9;">執法部門 任務成功</h2>
                <div class="final-report">
                    <h3 style="border-bottom:1px solid #4a90d9; padding-bottom:10px;">結案報告 #LE-2026-FINAL</h3>
                    <p><strong>行動結果：</strong> ${reason}</p>
                    <p><strong>逮捕過程：</strong> 經過跨部門協作與深度數據鑑識，執法隊伍於倒計時結束前成功鎖定目標物理座標，並在現場抓獲嫌疑人。</p>
                    <p><strong>證據鏈摘要：</strong></p>
                    <ul>
                        <li>關鍵 IP 訪問日誌與 MAC 地址匹配成功。</li>
                        <li>獲取了目標與暗網中介的完整通訊記錄。</li>
                        <li>成功攔截並凍結了價值 $${GameState.playerData.hacker.money} 的非法加密資產。</li>
                    </ul>
                    <p><strong>定罪建議：</strong> 建議以非法入侵、大規模勒索及危害網絡安全罪名起訴，預計刑期：25年至終身監禁。</p>
                </div>
                <button class="restart-btn" onclick="location.reload()">重新開始新案件</button>
            `;
        } else {
            screen.innerHTML = `
                <div class="hacker-win-anim">DATA TRANSMISSION COMPLETE</div>
                <h2 style="color:#00ff41;">黑客任務 勝利</h2>
                <div class="final-report" style="border-color:#00ff41;">
                    <h3 style="border-bottom:1px solid #00ff41; padding-bottom:10px; color:#00ff41;">暗網交易確認書 #HK-VOID-99</h3>
                    <p><strong>任務成果：</strong> ${reason}</p>
                    <p><strong>行動摘要：</strong> 目標系統已成功癱瘓，所有追蹤痕跡已從骨幹網節點徹底抹除。執法部門未能獲取任何有效身份信息。</p>
                    <p><strong>獲利統計：</strong></p>
                    <ul>
                        <li>成功獲取敏感數據包：1.2 TB</li>
                        <li>暗網中介轉賬確認：$${GameState.playerData.hacker.money} (已轉入冷錢包)</li>
                        <li>聲望提升：傳奇黑客等級</li>
                    </ul>
                    <p><strong>後續狀態：</strong> 身份已重置，數位足跡清零。目標已在網絡空間消失，執法部門調查陷入死胡同。</p>
                </div>
                <button class="restart-btn" style="background:#00ff41;" onclick="location.reload()">開啟下一個目標</button>
            `;
        }
    };
}

// 執行系統
setTimeout(applyVictorySystem, 3000);




/**
 * 深度玩法優化系統
 * 1. 動態風險懲罰 (執法伺服器負載/黑客操作失誤)
 * 2. 三級證據鏈 (普通/關鍵/核心)
 * 3. 黑客三階段破壞目標
 * 4. 執法階段防禦獎勵
 */

function applyGameplayOptimization() {
    // 1. 初始化新狀態數據
    if (!GameState.hackerPhases) {
        GameState.hackerPhases = {
            current: 1, // 1: 癱瘓監控, 2: 盜取計劃, 3: 核心反撲
            monitorDisabled: false,
            planStolen: false
        };
    }
    
    // 2. 證據鏈升級
    const EvidenceTypes = {
        NORMAL: { name: '普通證據', pollutionResistance: 1 },
        CRITICAL: { name: '關鍵證據', pollutionResistance: 2 },
        CORE: { name: '核心證據', pollutionResistance: 999 } // 僅能通過伺服器崩潰破壞
    };

    // 3. 強化黑客指令邏輯 (包含風險懲罰與階段目標)
    const originalHackerCmd = window.handleHackerCommands;
    window.handleHackerCommands = function(cmd, args) {
        const hacker = GameState.playerData.hacker;
        const le = GameState.playerData.law_enforcement;
        
        // 操作失誤風險判定 (隨機 10% 機率)
        if (cmd === 'cleanlog' && Math.random() < 0.1) {
            addTerminalLine('[警告] 操作失誤！誤刪系統關鍵日誌失敗，留下「臨時數位指紋」。', 'alert');
            le.identityLockProgress = Math.min(100, le.identityLockProgress + 15);
            showNotification('操作失誤', '執法部門獲取了您的臨時數位指紋', 'error');
            return;
        }

        // 階段目標邏輯
        if (cmd === 'ddos' && GameState.hackerPhases.current === 1) {
            addTerminalLine('[階段1] 正在嘗試癱瘓執法監控系統...', 'info');
            setTimeout(() => {
                GameState.hackerPhases.monitorDisabled = true;
                GameState.hackerPhases.current = 2;
                addTerminalLine('[成功] 監控系統已癱瘓！執法溯源暫停 2 分鐘。', 'success');
                le.isMonitoringDisabled = true;
                setTimeout(() => { le.isMonitoringDisabled = false; }, 120000);
            }, 2000);
        }

        if (cmd === 'inject' && GameState.hackerPhases.current === 2) {
            addTerminalLine('[階段2] 正在盜取指揮中心「行動計劃」...', 'info');
            setTimeout(() => {
                GameState.hackerPhases.planStolen = true;
                GameState.hackerPhases.current = 3;
                addTerminalLine('[成功] 行動計劃已獲取！執法佈防已完全暴露。', 'success');
                hacker.stealth = 100;
            }, 2000);
        }

        // 執行原始邏輯
        if (originalHackerCmd) originalHackerCmd(cmd, args);
    };

    // 4. 強化執法指令邏輯 (包含證據鏈與負載懲罰)
    const originalLECmd = window.handleLawEnforcementCommands;
    window.handleLawEnforcementCommands = function(cmd, args) {
        const le = GameState.playerData.law_enforcement;
        
        // 伺服器負載懲罰
        let delayMultiplier = 1;
        if (le.serverHealth < 30) {
            addTerminalLine('[警告] 伺服器負載過高，溯源工具效率下降 40%。', 'alert');
            delayMultiplier = 2;
        }

        // 證據庫污染懲罰
        if (GameState.playerData.hacker.evidencePollutionLevel > 50) {
            addTerminalLine('[司法] 證據庫污染嚴重，法庭暫停案件審理。啟動「證據修復」程序...', 'alert');
            setTimeout(() => {
                GameState.playerData.hacker.evidencePollutionLevel = 0;
                addTerminalLine('[成功] 證據修復完成，案件審理恢復。', 'success');
            }, 10000 * delayMultiplier);
            return;
        }

        // 拘捕令門檻檢查 (Raid 指令)
        if (cmd === 'raid') {
            const hasIP = le.evidenceCount >= 1;
            const hasCode = le.evidenceCount >= 3;
            const hasMoney = le.evidenceCount >= 5;
            
            if (!(hasIP && hasCode && hasMoney)) {
                addTerminalLine('[失敗] 拘捕令申請被駁回：缺少必要類型的關鍵證據 (需包含IP日誌、攻擊代碼與資金記錄)。', 'error');
                return;
            }
        }

        // 執行原始邏輯 (帶延遲懲罰)
        setTimeout(() => {
            if (originalLECmd) originalLECmd(cmd, args);
        }, 500 * delayMultiplier);
    };

    // 5. 視覺化證據等級與階段目標
    function updateOptimizationUI() {
        const role = GameState.currentRole;
        let infoPanel = document.getElementById('optimization-info-panel');
        if (!infoPanel) {
            infoPanel = document.createElement('div');
            infoPanel.id = 'optimization-info-panel';
            infoPanel.style.cssText = 'background:rgba(0,0,0,0.5); border:1px solid #4a90d9; padding:10px; margin-top:10px; font-size:0.8rem;';
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) rightPanel.appendChild(infoPanel);
        }

        if (role === 'hacker') {
            const phaseNames = ["癱瘓監控", "盜取計劃", "核心反撲"];
            infoPanel.innerHTML = `
                <div style="color:#00ff41; font-weight:bold; margin-bottom:5px;">[黑客階段目標]</div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="${GameState.hackerPhases.current >= 1 ? 'color:#00ff41' : ''}">1. ${phaseNames[0]}</span>
                    <span style="${GameState.hackerPhases.current >= 2 ? 'color:#00ff41' : ''}">2. ${phaseNames[1]}</span>
                    <span style="${GameState.hackerPhases.current >= 3 ? 'color:#00ff41' : ''}">3. ${phaseNames[2]}</span>
                </div>
            `;
        } else {
            const le = GameState.playerData.law_enforcement;
            infoPanel.innerHTML = `
                <div style="color:#4a90d9; font-weight:bold; margin-bottom:5px;">[執法證據鏈狀態]</div>
                <div class="stat-row"><span>普通證據:</span><span>${le.evidenceCount >= 1 ? '已獲取' : '缺失'}</span></div>
                <div class="stat-row"><span>關鍵證據:</span><span>${le.evidenceCount >= 3 ? '已獲取' : '缺失'}</span></div>
                <div class="stat-row"><span>核心證據:</span><span>${le.evidenceCount >= 5 ? '已獲取' : '缺失'}</span></div>
                <div style="margin-top:5px; font-size:0.7rem; color:#aaa;">* 需集齊三類證據方可申請拘捕令</div>
            `;
        }
    }

    // 整合到 UI 更新
    const originalUpdateStats = window.updateGameStats;
    window.updateGameStats = function() {
        if (originalUpdateStats) originalUpdateStats();
        updateOptimizationUI();
    };
}

// 執行優化
setTimeout(applyGameplayOptimization, 3500);




/**
 * 實戰與經濟系統升級
 * 1. 百萬預算系統 (執法端)
 * 2. 高級技術套裝商店 (視覺化面板)
 * 3. 實戰視覺特效 (震動/閃爍/進度條)
 * 4. 實時攻防日誌
 */

function applyCombatAndEconomy() {
    // 1. 初始化預算與資金
    if (GameState.playerData.law_enforcement) {
        GameState.playerData.law_enforcement.budget = 1000000; // 一百萬預算
    }

    // 2. 注入實戰特效 CSS
    const style = document.createElement('style');
    style.textContent = `
        .screen-shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .flash-red { animation: flashRed 0.5s ease-out; }
        @keyframes flashRed { 0% { background: rgba(255,0,0,0.5); } 100% { background: transparent; } }
        
        .combat-log {
            background: rgba(0,0,0,0.8);
            border: 1px solid #ff9900;
            color: #ff9900;
            font-family: monospace;
            font-size: 0.75rem;
            padding: 10px;
            height: 100px;
            overflow-y: auto;
            margin-top: 10px;
            border-radius: 4px;
        }
        
        .suit-card {
            border: 2px solid #4a90d9;
            background: linear-gradient(135deg, rgba(10,20,40,0.9), rgba(20,40,80,0.9));
            position: relative;
            overflow: hidden;
        }
        .suit-card::after {
            content: 'PREMIUM';
            position: absolute;
            top: 10px;
            right: -25px;
            background: #ff9900;
            color: #000;
            font-size: 0.6rem;
            font-weight: bold;
            padding: 2px 30px;
            transform: rotate(45deg);
        }
        .suit-tier {
            font-size: 0.7rem;
            color: #ff9900;
            margin-bottom: 5px;
        }
    `;
    document.head.appendChild(style);

    // 3. 高級商店數據 (套裝)
    const PremiumSuits = {
        hacker: [
            { id: 'ghost_suit', name: '幽靈無痕套裝', tier: 'LEGENDARY', icon: 'fa-user-ninja', price: 50000, effect: '數位足跡自動清零，隱蔽度永久+50' },
            { id: 'zero_day_matrix', name: '零日攻擊矩陣', tier: 'EPIC', icon: 'fa-th', price: 120000, effect: '所有攻擊指令成功率提升 80%' },
            { id: 'id_gen', name: '虛擬身份生成器', tier: 'RARE', icon: 'fa-id-card', price: 30000, effect: '身份鎖定進度每分鐘自動下降 5%' }
        ],
        law_enforcement: [
            { id: 'skynet_suit', name: '天網監控套裝', tier: 'LEGENDARY', icon: 'fa-eye', price: 150000, effect: '全網實時追蹤，身份鎖定速度翻倍' },
            { id: 'quantum_forensics', name: '量子鑑識模組', tier: 'EPIC', icon: 'fa-atom', price: 80000, effect: '瞬間修復被污染的證據，證據獲取率+100%' },
            { id: 'fw_matrix', name: '反黑客防火牆矩陣', tier: 'RARE', icon: 'fa-shield-alt', price: 50000, effect: '伺服器健康度上限提升至 200%' }
        ]
    };

    // 4. 強化商店 UI
    window.openPremiumShop = function() {
        const role = GameState.currentRole;
        const suits = PremiumSuits[role];
        const money = role === 'hacker' ? GameState.playerData.hacker.money : GameState.playerData.law_enforcement.budget;

        let shopModal = document.getElementById('premium-shop-modal');
        if (!shopModal) {
            shopModal = document.createElement('div');
            shopModal.id = 'premium-shop-modal';
            shopModal.className = 'modal';
            shopModal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3000; display:flex; align-items:center; justify-content:center;';
            document.body.appendChild(shopModal);
        }

        shopModal.style.display = 'flex';
        shopModal.innerHTML = `
            <div class="shop-modal-content" style="background:#050510; border:2px solid #ff9900; padding:20px; width:95%; max-width:900px; max-height:90vh; overflow-y:auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ff9900; padding-bottom:10px; margin-bottom:20px;">
                    <h2 style="color:#ff9900; margin:0;"><i class="fas fa-gem"></i> 高級技術套裝商店 [可用預算: $${money.toLocaleString()}]</h2>
                    <button onclick="document.getElementById('premium-shop-modal').style.display='none'" style="background:none; border:none; color:#fff; font-size:2rem; cursor:pointer;">&times;</button>
                </div>
                <div class="shop-items-grid">
                    ${suits.map(suit => `
                        <div class="shop-item suit-card">
                            <div class="suit-tier">${suit.tier}</div>
                            <div class="shop-item-header">
                                <i class="fas ${suit.icon} shop-item-icon" style="color:#ff9900;"></i>
                                <span>${suit.name}</span>
                            </div>
                            <p style="font-size:0.8rem; color:#ccc;">${suit.effect}</p>
                            <div class="shop-item-price" style="color:#ff9900;">$${suit.price.toLocaleString()}</div>
                            <button class="buy-btn" style="background:#ff9900;" onclick="buyPremiumSuit('${suit.id}')">立即裝備</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    };

    window.buyPremiumSuit = function(suitId) {
        const role = GameState.currentRole;
        const suit = PremiumSuits[role].find(s => s.id === suitId);
        const moneyField = role === 'hacker' ? 'money' : 'budget';
        const currentMoney = GameState.playerData[role][moneyField];

        if (currentMoney >= suit.price) {
            GameState.playerData[role][moneyField] -= suit.price;
            addTerminalLine(`[商店] 成功裝備 ${suit.name}！技術強度大幅提升。`, 'success');
            addCombatLog(`支出: $${suit.price.toLocaleString()} | 獲得裝備: ${suit.name}`);
            updateGameStats();
            openPremiumShop();
            showNotification('裝備成功', suit.name, 'success');
        } else {
            showNotification('預算不足', '無法購買此高級套裝', 'error');
        }
    };

    // 5. 實戰日誌與特效
    function addCombatLog(msg) {
        let logPanel = document.getElementById('combat-log-panel');
        if (!logPanel) {
            logPanel = document.createElement('div');
            logPanel.id = 'combat-log-panel';
            logPanel.className = 'combat-log';
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) rightPanel.appendChild(logPanel);
        }
        const time = new Date().toLocaleTimeString();
        logPanel.innerHTML = `<div>[${time}] ${msg}</div>` + logPanel.innerHTML;
    }

    // 覆蓋指令執行以增加特效
    const originalExec = window.executeCommand;
    window.executeCommand = function(cmdText) {
        const mainPanel = document.querySelector('.game-container');
        if (mainPanel) {
            mainPanel.classList.add('screen-shake');
            setTimeout(() => mainPanel.classList.remove('screen-shake'), 200);
        }
        originalExec(cmdText);
    };

    // 6. 更新預算顯示
    const originalUpdateStats = window.updateGameStats;
    window.updateGameStats = function() {
        if (originalUpdateStats) originalUpdateStats();
        const role = GameState.currentRole;
        const money = role === 'hacker' ? GameState.playerData.hacker.money : GameState.playerData.law_enforcement.budget;
        
        // 確保快捷按鈕已注入
        const panel = document.querySelector('.quick-actions-panel');
        if (panel && panel.children.length === 0) {
            if (typeof injectActionButtons === 'function') injectActionButtons();
        }
        const budgetDisplay = document.getElementById('budget-display');
        if (budgetDisplay) {
            budgetDisplay.innerText = `$${money.toLocaleString()}`;
        } else {
            const statsPanel = document.querySelector('.game-stats');
            if (statsPanel) {
                const div = document.createElement('div');
                div.className = 'stat-item';
                div.innerHTML = `<span class="stat-label">可用預算:</span><span id="budget-display" class="stat-value">$${money.toLocaleString()}</span>`;
                statsPanel.appendChild(div);
            }
        }
    };
}


    // 通用指令結果彈出視窗系統
    window.showCommandResultModal = function(title, contentHtml, type = 'info') {
        let modal = document.getElementById('command-result-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'command-result-modal';
            modal.className = 'modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:5000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px);';
            document.body.appendChild(modal);
        }

        const colors = {
            info: '#4a90d9',
            success: '#00ff41',
            warning: '#ff9900',
            error: '#ff4444',
            alert: '#ff0000'
        };
        const color = colors[type] || colors.info;

        modal.innerHTML = `
            <div class="modal-content" style="background:#050510; border:2px solid ${color}; padding:0; width:90%; max-width:600px; box-shadow:0 0 30px ${color}44; border-radius:8px; overflow:hidden; animation: modalFadeIn 0.3s ease;">
                <div style="background:${color}22; padding:15px 20px; border-bottom:1px solid ${color}; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="color:${color}; margin:0; font-size:1.2rem; letter-spacing:1px;"><i class="fas fa-terminal"></i> ${title}</h3>
                    <button onclick="document.getElementById('command-result-modal').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer; line-height:1;">&times;</button>
                </div>
                <div style="padding:25px; color:#eee; font-family:'Courier New', monospace; line-height:1.6; max-height:70vh; overflow-y:auto;">
                    ${contentHtml}
                </div>
                <div style="padding:15px; border-top:1px solid rgba(255,255,255,0.1); text-align:right; background:rgba(255,255,255,0.02);">
                    <button onclick="document.getElementById('command-result-modal').style.display='none'" style="background:${color}; color:#000; border:none; padding:8px 20px; border-radius:4px; cursor:pointer; font-weight:bold;">確認</button>
                </div>
            </div>
        `;
        
        if (!document.getElementById('modal-animations')) {
            const style = document.createElement('style');
            style.id = 'modal-animations';
            style.innerHTML = `
                @keyframes modalFadeIn {
                    from { opacity: 0; transform: translateY(-20px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `;
            document.head.appendChild(style);
        }

        modal.style.display = 'flex';
    };

    // 實作 track2 的真實效果
    window.executeTrack2Effect = function() {
        const targetIP = GameState.opponentIP || '203.0.113.42';
        const content = `
            <div style="border-left:3px solid #4a90d9; padding-left:15px; margin-bottom:20px;">
                <p style="color:#4a90d9; font-weight:bold; margin-bottom:10px;">[電訊供應商回傳數據 - 絕密]</p>
                <p>查詢目標: ${targetIP}</p>
                <p>回傳時間: ${new Date().toLocaleString()}</p>
            </div>
            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);"><td style="padding:8px; color:#aaa;">登記姓名:</td><td style="padding:8px;">*陳*大 (CHAN T** T**)</td></tr>
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);"><td style="padding:8px; color:#aaa;">登記地址:</td><td style="padding:8px;">九龍尖沙咀彌敦道***號**樓</td></tr>
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);"><td style="padding:8px; color:#aaa;">聯絡電話:</td><td style="padding:8px;">+852 9*** *123</td></tr>
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);"><td style="padding:8px; color:#aaa;">服務供應商:</td><td style="padding:8px;">HK-Telecom (Net-Track ID: 88291)</td></tr>
                <tr style="border-bottom:1px solid rgba(255,255,255,0.1);"><td style="padding:8px; color:#aaa;">關聯帳號:</td><td style="padding:8px;">dark_shadow_99, ghost_user_x</td></tr>
            </table>
            <p style="margin-top:20px; font-size:0.8rem; color:#ff9900;"><i class="fas fa-exclamation-triangle"></i> 提示：初步身份已確認，建議立即啟動「流量監控」或「申請拘捕令」。</p>
        `;
        showCommandResultModal('電訊商數據回傳', content, 'success');
    };
    


    // 實作更多指令的真實效果
    window.executeTrack1Effect = function() {
        const targetIP = GameState.opponentIP || '203.0.113.42';
        const content = `
            <div style="border-left:3px solid #4a90d9; padding-left:15px; margin-bottom:20px;">
                <p style="color:#4a90d9; font-weight:bold; margin-bottom:10px;">[IP 追蹤系統 - 實時定位]</p>
                <p>追蹤目標: ${targetIP}</p>
            </div>
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:4px; border:1px solid rgba(74,144,217,0.3);">
                <p><i class="fas fa-map-marker-alt" style="color:#ff4444;"></i> <b>地理位置:</b> 香港特別行政區, 旺角區</p>
                <p><i class="fas fa-desktop" style="color:#4a90d9;"></i> <b>關聯設備:</b> MacBook Pro (2023), iPhone 15 Pro</p>
                <p><i class="fas fa-network-wired" style="color:#4a90d9;"></i> <b>接入點:</b> Public WiFi - MK_Center_Free</p>
                <p><i class="fas fa-clock" style="color:#4a90d9;"></i> <b>最後活動:</b> 剛剛</p>
            </div>
        `;
        showCommandResultModal('IP 追蹤結果', content, 'info');
    };

    window.executeHackerScanEffect = function() {
        const content = `
            <div style="border-left:3px solid #00ff41; padding-left:15px; margin-bottom:20px;">
                <p style="color:#00ff41; font-weight:bold; margin-bottom:10px;">[深度網絡掃描 - 漏洞報告]</p>
                <p>目標系統: LE-OS v3.0 (執法部門核心伺服器)</p>
            </div>
            <div style="font-size:0.9rem;">
                <p style="color:#ff9900;"><b>發現弱點:</b></p>
                <ul style="list-style:none; padding-left:10px;">
                    <li><i class="fas fa-bug"></i> Port 8080: 存在未授權訪問漏洞 (CVE-2025-1234)</li>
                    <li><i class="fas fa-bug"></i> SQL 注入點: /api/v1/evidence_search?id=</li>
                    <li><i class="fas fa-bug"></i> 弱密碼風險: 管理員帳號 'admin' 可能存在暴力破解可能</li>
                </ul>
                <p style="margin-top:15px; color:#00ff41;">建議行動: 執行 'sqli' 或 'crack' 指令進行滲透。</p>
            </div>
        `;
        showCommandResultModal('掃描報告', content, 'success');
    };
    


    // 暗網模擬交流系統
    const DarknetAI = {
        contacts: [
            { name: 'ZeroDay', status: 'online', role: 'Exploit Dev' },
            { name: 'Ghost_Protocol', status: 'online', role: 'Network Infiltrator' },
            { name: 'CryptoKnight', status: 'away', role: 'Encryption Specialist' },
            { name: 'ShadowBroker', status: 'online', role: 'Data Dealer' }
        ],
        messages: [
            { user: 'ZeroDay', text: '有人拿到執法部門最新的防火牆特徵碼嗎？', time: '14:20' },
            { user: 'Ghost_Protocol', text: '聽說他們在追蹤一個叫 "Player" 的傢伙。', time: '14:22' },
            { user: 'ShadowBroker', text: '我有目標的初步身份資料，有人感興趣嗎？', time: '14:25' }
        ],
        marketItems: [
            { id: 'le_exploit', name: 'LE-OS 零日漏洞', price: 5000, desc: '直接繞過執法部門防火牆' },
            { id: 'identity_mask', name: '高級身份掩碼', price: 2000, desc: '大幅降低被追蹤機率' },
            { id: 'botnet_rent', name: '殭屍網絡租用', price: 3500, desc: '發動大規模 DDoS 攻擊' }
        ]
    };

    window.initDarknetHub = function() {
        const container = document.querySelector('.darknet-container');
        if (!container) return;

        container.innerHTML = `
            <div class="darknet-header">
                <div class="darknet-title"><i class="fas fa-user-secret"></i> ONION NETWORK HUB</div>
                <div class="darknet-subtitle">> 加密節點: 127.0.0.1:9050 | 匿名等級: 最高 | 當前用戶: ${GameState.playerData.hacker.money > 0 ? 'Verified' : 'Guest'}</div>
            </div>

            <div class="darknet-layout">
                <!-- 左側：聯繫人 -->
                <div class="darknet-sidebar">
                    <div style="color:#00ff41; font-weight:bold; border-bottom:1px solid #00ff41; padding-bottom:5px;">加密聯繫人</div>
                    ${DarknetAI.contacts.map(c => `
                        <div class="darknet-contact-item">
                            <div class="status-dot" style="background:${c.status === 'online' ? '#00ff41' : '#888'}"></div>
                            <div>
                                <div style="font-size:0.9rem;">${c.name}</div>
                                <div style="font-size:0.7rem; color:#008800;">${c.role}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- 中間：聊天室 -->
                <div class="darknet-chat-area">
                    <div style="background:rgba(0,255,65,0.1); padding:10px; border-bottom:1px solid #00ff41; font-size:0.8rem;">
                        <i class="fas fa-comments"></i> #Global_Underground_Chat
                    </div>
                    <div id="darknet-messages" class="darknet-chat-messages">
                        ${DarknetAI.messages.map(m => `
                            <div class="chat-msg">
                                <span class="chat-user">${m.user}:</span>
                                <span class="chat-text">${m.text}</span>
                                <span class="chat-time">${m.time}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="darknet-chat-input">
                        <input type="text" id="darknet-msg-input" class="darknet-input" placeholder="輸入加密訊息...">
                        <button onclick="sendDarknetMessage()" class="darknet-send-btn">發送</button>
                    </div>
                </div>

                <!-- 右側：情報市場 -->
                <div class="darknet-sidebar" style="border-color:#bc13fe;">
                    <div style="color:#bc13fe; font-weight:bold; border-bottom:1px solid #bc13fe; padding-bottom:5px;">情報交易市場</div>
                    ${DarknetAI.marketItems.map(item => `
                        <div class="market-item">
                            <div>
                                <div style="font-weight:bold;">${item.name}</div>
                                <div style="font-size:0.7rem; color:#880088;">$${item.price.toLocaleString()}</div>
                            </div>
                            <button onclick="buyDarknetItem('${item.id}', ${item.price})" class="market-buy-btn">購買</button>
                        </div>
                    `).join('')}
                    <div style="margin-top:auto; font-size:0.7rem; color:#888; text-align:center;">
                        <i class="fas fa-lock"></i> 所有交易均受區塊鏈保護
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn back-btn" onclick="goToMainPage()">
                    <i class="fas fa-arrow-left"></i> 斷開連接並返回
                </button>
            </div>
        `;

        // 模擬 AI 自動對話
        if (!window.darknetInterval) {
            window.darknetInterval = setInterval(simulateAIChat, 8000);
        }
    };

    window.sendDarknetMessage = function() {
        const input = document.getElementById('darknet-msg-input');
        const text = input.value.trim();
        if (!text) return;

        addChatMessage('You', text);
        input.value = '';

        // 模擬 AI 回應
        setTimeout(() => {
            const responses = [
                '這聽起來很有趣。',
                '我正在處理類似的數據。',
                '小心點，執法部門最近盯得很緊。',
                '有人出價更高嗎？'
            ];
            const randomUser = DarknetAI.contacts[Math.floor(Math.random() * DarknetAI.contacts.length)].name;
            addChatMessage(randomUser, responses[Math.floor(Math.random() * responses.length)]);
        }, 1500);
    };

    function addChatMessage(user, text) {
        const chatBox = document.getElementById('darknet-messages');
        if (!chatBox) return;
        
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const msgEl = document.createElement('div');
        msgEl.className = 'chat-msg';
        msgEl.innerHTML = `
            <span class="chat-user">${user}:</span>
            <span class="chat-text">${text}</span>
            <span class="chat-time">${time}</span>
        `;
        chatBox.appendChild(msgEl);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function simulateAIChat() {
        if (document.getElementById('darknet-hub-page').style.display === 'block') {
            const randomUser = DarknetAI.contacts[Math.floor(Math.random() * DarknetAI.contacts.length)].name;
            const randomTexts = [
                '剛才掃描到一個開放的數據庫，有人要座標嗎？',
                '執法部門的追蹤進度又提升了，大家注意。',
                '出售最新的 VPN 混淆腳本，只要 $500。',
                '誰有 "Player" 的最新 IP？',
                '剛完成了一次對證據庫的滲透，感覺不錯。'
            ];
            addChatMessage(randomUser, randomTexts[Math.floor(Math.random() * randomTexts.length)]);
        }
    }

    window.buyDarknetItem = function(id, price) {
        if (GameState.playerData.hacker.money >= price) {
            GameState.playerData.hacker.money -= price;
            addTerminalLine(`[暗網交易] 成功購買: ${id}，支出 $${price.toLocaleString()}`, 'success');
            updateGameStats();
            showNotification('交易成功', '情報已注入系統', 'success');
        } else {
            showNotification('餘額不足', '您需要更多資金來完成這筆交易', 'error');
        }
    };
    


    window.openDarknetHub = function() {
        if (GameState.currentRole !== 'hacker') {
            showNotification('權限不足', '只有黑客可以進入暗網', 'error');
            return;
        }
        showPage('darknet-hub-page');
        if (typeof initDarknetHub === 'function') initDarknetHub();
    };
    

// 執行升級
setTimeout(applyCombatAndEconomy, 4000);

</script>

<!-- Forensics Lab Modal (SIMULATION ONLY) -->
<div id="forensics-lab-modal" class="immersive-modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="forensics-lab-title">
    <header>
        <div id="forensics-lab-title" style="font-weight:bold;">數位鑑識實驗室 <span class="new-badge">新功能</span></div>
        <div><button class="close-btn" onclick="closeForensicsLab()">關閉</button></div>
    </header>
    <div style="display:grid; grid-template-columns: 1fr 320px; gap:12px; padding:10px;">
        <div>
            <div class="node-card" style="border-left:3px solid #ffd700;">
                <div style="font-weight:bold;">專業取證工具套件</div>
                <div style="margin-top:8px; color:#ddd;">整合更專業的模擬取證流程：磁碟映像、記憶體、日誌關聯、元數據與行動裝置（模擬）。</div>
                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <button class="btn-primary" onclick="simulateDiskImageAnalyzerDetailed()">磁碟映像分析儀</button>
                    <button class="btn-primary" onclick="simulateMemoryForensicsDetailed()">記憶體取證工具</button>
                    <button class="btn" onclick="simulateLogCorrelatorDetailed()">日誌關聯分析器</button>
                    <button class="btn" onclick="simulateMobileForensics()">行動設備取證</button>
                    <button class="btn" onclick="openAdvancedAnalysis()">開啟進階分析 v5.5.0</button>
                </div>
                <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                    <label style="color:#aaa; width:86px;">上傳樣本</label>
                    <input id="meta-file-input" type="file" class="modal-input" onchange="simulateMetadataExtractorFromFile(event)" />
                </div>
                <div style="margin-top:8px; color:#888; font-size:0.85rem;">提示：上傳文件僅在本地讀取以示範元數據提取，不會上傳或傳出任何內容。</div>
            </div>
            <div class="node-card">記憶體取證工具
                <div style="margin-top:8px;">即時 RAM 掃描與惡意程式簽章檢測（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateMemoryForensics()">執行記憶體分析（模擬）</button></div>
            </div>

            <div class="node-card">硬碟映像分析
                <div style="margin-top:8px;">文件系統復原與時間線重建（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateDiskImageAnalysis()">分析映像檔（模擬）</button>
                    <button class="btn" onclick="simulateDetailedTimeline()">詳細時間線重建（模擬）</button></div>
            </div>

            <div class="node-card">日誌關聯分析
                <div style="margin-top:8px;">將多來源日誌依時間與事件關聯，標註潛在證據鏈（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateLogCorrelation()">執行日誌關聯（模擬）</button></div>
            </div>

            <div class="node-card">加密數據解碼站
                <div style="margin-top:8px;">嘗試對常見加密演算法的破解示範（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateCryptoCrack()">嘗試解碼（模擬）</button></div>
            </div>

            <div class="node-card">元數據提取器
                <div style="margin-top:8px;">從文件抽取隱藏資訊（時間戳、GPS、Author 等）模擬</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateMetadataExtraction()">抽取元數據（模擬）</button></div>
            </div>

            <div class="node-card">法律與程序模擬
                <div style="margin-top:8px;">模擬搜查令申請、證據可採性檢查與連鎖保管（chain-of-custody）流程（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn-primary" onclick="simulateSearchWarrantWorkflow()">申請搜查令（模擬）</button>
                    <button class="btn" onclick="simulateChainOfCustodyCheck()">檢查證據可採性（模擬）</button>
                </div>
            </div>

            <div class="node-card">協作與通報
                <div style="margin-top:8px;">與 ISP、國際執法機構的協調流程模擬（模擬不進行真實網路請求）</div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn-primary" onclick="simulateISPRequest()">向 ISP 提出資料請求（模擬）</button>
                    <button class="btn" onclick="simulateInternationalLiaison()">國際合作通報（模擬）</button>
                </div>
            </div>

            <div class="node-card">分層調查策略 & 資源約束
                <div style="margin-top:8px;">設定預算、時間與管轄權限制，系統會根據約束建議調查深度（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                    <label style="width:64px;">預算</label><input id="res-budget" type="number" class="modal-input" value="50000" />
                </div>
                <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                    <label style="width:64px;">時間(天)</label><input id="res-days" type="number" class="modal-input" value="7" />
                </div>
                <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                    <label style="width:64px;">管轄</label><select id="res-jurisdiction" class="modal-input"><option>本地</option><option>國際</option></select>
                </div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="applyResourceConstraints()">套用資源約束並建議策略</button></div>
            </div>
            
            <div class="node-card">對抗性互動（攻防模擬）
                <div style="margin-top:8px;">模擬黑客的反制（逃避、干擾偵測工具），並觀察對鑑識結果的影響（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn" onclick="simulateEvasion()">模擬逃避行為（模擬）</button>
                    <button class="btn" onclick="simulateInterference()">模擬干擾（日誌刪除/時間錯置，模擬）</button>
                </div>
            </div>

            <div class="node-card">誤導資訊處理
                <div style="margin-top:8px;">自動偵測與標註可能的假證據，提供可信度分數（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn" onclick="simulateFakeEvidenceAnalysis()">檢測假證據（模擬）</button></div>
            </div>

            <div class="node-card">時間壓力機制（證據衰減/加密）
                <div style="margin-top:8px;">設定證據消失或加密的倒數計時（模擬）以模擬時效壓力</div>
                <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                    <label style="width:80px;">倒數(秒)</label><input id="decay-seconds" type="number" class="modal-input" value="60" />
                </div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="startEvidenceDecayTimer()">啟動倒數（模擬）</button>
                    <button class="btn" onclick="stopEvidenceDecayTimer()">停止倒數</button></div>
                <div id="decay-status" style="margin-top:8px; color:#ffcc00; font-family:monospace;"></div>
            </div>
        </div>

        <div>
            <div class="node-card">鑑識實驗室日誌<div id="forensics-log" style="max-height:360px; overflow:auto; margin-top:6px;"></div></div>
            <div class="node-card" style="margin-top:10px;">鑑識結果快照
                <div id="forensics-results" style="margin-top:8px; font-family:monospace; font-size:0.9rem; max-height:260px; overflow:auto;"></div>
            </div>
        </div>
    </div>
</div>

<script>
function openForensicsLab(){ document.getElementById('forensics-lab-modal').style.display='block'; setTimeout(()=>{ const f=document.getElementById('forensics-lab-modal').querySelector('button'); if(f) f.focus(); },100); }
function closeForensicsLab(){ document.getElementById('forensics-lab-modal').style.display='none'; }

function appendForensicsLog(msg){ const el=document.getElementById('forensics-log'); if(!el) return; const d=document.createElement('div'); d.textContent='['+new Date().toLocaleTimeString()+'] '+msg; el.prepend(d); }

window.forensicsLabData = window.forensicsLabData || {};

function simulateMemoryForensics(){
    appendForensicsLog('開始記憶體取證掃描（模擬）');
    const findings = [
        { type:'suspicious_process', name:'evil.exe', pid: 4242, note:'可疑行為：注入網絡連線' },
        { type:'hooked_api', name:'NtOpenProcess', note:'疑似 API hook' }
    ];
    window.forensicsLabData.memory = { timestamp: Date.now(), findings };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.memory, null, 2);
    appendForensicsLog('記憶體分析完成（模擬），發現 ' + findings.length + ' 處可疑項目');
}

function simulateDiskImageAnalysis(){
    appendForensicsLog('開始硬碟映像分析（模擬）');
    const recovered = [
        { path:'/Users/victim/Documents/secret.docx', recovered:true, timestamp:'2025-08-01 10:02:12' },
        { path:'/Users/victim/.config/evil.conf', recovered:true, timestamp:'2025-07-30 22:15:03' }
    ];
    window.forensicsLabData.disk = { timestamp: Date.now(), recovered };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.disk, null, 2);
    appendForensicsLog('硬碟分析完成（模擬） - 已復原 '+recovered.length+' 個檔案');
}

function simulateCryptoCrack(){
    appendForensicsLog('啟動加密數據解碼站（模擬）');
    const attempts = [
        { algo:'AES-128', status:'嘗試中', result:null },
        { algo:'Base64', status:'成功', result:'解碼文本示例' }
    ];
    window.forensicsLabData.crypto = { timestamp: Date.now(), attempts };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.crypto, null, 2);
    appendForensicsLog('加密解碼模擬：Base64 成功，AES-128 失敗（示範）');
}

function simulateMetadataExtraction(){
    appendForensicsLog('開始元數據提取（模擬）');
    const meta = {
        filename:'evidence_photo.jpg',
        author:'user@example.com',
        gps:'22.2855,114.1577',
        created:'2025-01-05T12:34:56Z'
    };
    window.forensicsLabData.metadata = { timestamp: Date.now(), meta };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.metadata, null, 2);
    appendForensicsLog('元數據提取完成（模擬） - 檔名: '+meta.filename);
}

// --- 新增模擬功能：日誌關聯、詳細時間線、法律程序、協作與資源約束
function simulateLogCorrelation(){
    appendForensicsLog('開始日誌關聯分析（模擬）');
    // mock correlated events
    const events = [
        { t:'2025-08-01T10:01:12Z', src:'198.51.100.23', dst:'10.0.0.5', note:'SSH login' },
        { t:'2025-08-01T10:02:05Z', src:'198.51.100.23', dst:'10.0.0.5', note:'文件上傳: secret.docx' },
        { t:'2025-08-01T10:03:30Z', src:'203.0.113.12', dst:'10.0.0.5', note:'疑似 C2 heartbeat' }
    ];
    window.forensicsLabData.logCorrelation = { timestamp: Date.now(), events };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.logCorrelation, null, 2);
    appendForensicsLog('日誌關聯完成（模擬） - 匯出 '+events.length+' 條關聯事件');
}

function simulateDetailedTimeline(){
    appendForensicsLog('開始詳細時間線重建（模擬）');
    const timeline = [
        { time:'2025-08-01 09:58:12', event:'外部掃描偵測' },
        { time:'2025-08-01 10:01:12', event:'SSH 登入 (user: victim)' },
        { time:'2025-08-01 10:02:05', event:'上傳 secret.docx' },
        { time:'2025-08-01 10:05:33', event:'可疑外連到 198.51.100.0/24' }
    ];
    window.forensicsLabData.timeline = { timestamp: Date.now(), timeline };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.timeline, null, 2);
    appendForensicsLog('時間線重建完成（模擬） - 生成 '+timeline.length+' 個時間點');
}

function simulateSearchWarrantWorkflow(){
    appendForensicsLog('開始搜查令申請流程（模擬）');
    const flow = [
        { step:'立案', status:'完成' },
        { step:'初步證據審查', status:'通過' },
        { step:'向法院提出申請', status:'等待回應' }
    ];
    window.forensicsLabData.legal = { timestamp: Date.now(), flow };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.legal, null, 2);
    appendForensicsLog('搜查令申請已送出（模擬） - 等待法院回應（示範，不連網）');
}

function simulateChainOfCustodyCheck(){
    appendForensicsLog('執行證據可採性與鏈條保管檢查（模擬）');
    const coc = { chainGood:true, notes:'掃描紀錄、MD5 hash、提取簽章完整' };
    window.forensicsLabData.chain = { timestamp: Date.now(), coc };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.chain, null, 2);
    appendForensicsLog('證據可採性檢查完成（模擬） - 結果: '+(coc.chainGood? '可採': '有疑慮'));
}

function simulateISPRequest(){
    appendForensicsLog('模擬向 ISP 申請流量資料（模擬）');
    const req = { provider:'示例ISP', requestId:'ISP-'+Math.floor(Math.random()*90000+10000), status:'已送出' };
    window.forensicsLabData.isp = { timestamp: Date.now(), req };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.isp, null, 2);
    appendForensicsLog('ISP 資料請求已建立（模擬） - 請求ID: '+req.requestId+'（不發出真實網路請求）');
}

function simulateInternationalLiaison(){
    appendForensicsLog('模擬國際執法協調通報（模擬）');
    const lia = { org:'INTERPOL', contact:'liaison@example.int', status:'已通報' };
    window.forensicsLabData.liaison = { timestamp: Date.now(), lia };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.liaison, null, 2);
    appendForensicsLog('已模擬通報國際單位（示範，不含實際通訊）');
}

function applyResourceConstraints(){
    const budget = Number(document.getElementById('res-budget').value || 0);
    const days = Number(document.getElementById('res-days').value || 0);
    const jurisdiction = document.getElementById('res-jurisdiction').value;
    appendForensicsLog('套用資源約束：預算='+budget+' 時間(天)='+days+' 管轄='+jurisdiction);
    // simple decision heuristic
    let suggestion = '建議進行初步調查(輕量)';
    if(budget>40000 && days>3) suggestion = '建議進行深入取證（映像、記憶體、日誌重建）';
    if(jurisdiction==='國際' && budget>60000) suggestion = '建議啟動國際合作並申請跨境資料請求';
    window.forensicsLabData.resourceSuggestion = { timestamp: Date.now(), budget, days, jurisdiction, suggestion };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.resourceSuggestion, null, 2);
    appendForensicsLog('資源建議已生成：'+suggestion);
}

// --- 對抗性互動 / 假證據 / 證據衰減模擬
window._evidenceDecayTimer = window._evidenceDecayTimer || { id:null, remaining:0 };

function simulateEvasion(){
    appendForensicsLog('模擬黑客逃避行為：隱匿網路連線與程式名稱（模擬）');
    // simulate changes to forensic findings confidence
    if(!window.forensicsLabData.memory) window.forensicsLabData.memory = {};
    window.forensicsLabData.memory.evasionNote = 'process names obfuscated; network artifacts TTL reduced';
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.memory, null, 2);
}

function simulateInterference(){
    appendForensicsLog('模擬干擾：日誌缺失與時間錯置（模擬）');
    if(!window.forensicsLabData.logCorrelation) window.forensicsLabData.logCorrelation = {};
    window.forensicsLabData.logCorrelation.interference = { missingEntries: Math.floor(Math.random()*5), timeSkew:'~2-5s' };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.logCorrelation, null, 2);
}

function simulateFakeEvidenceAnalysis(){
    appendForensicsLog('檢測假證據（模擬） - 正在分析可信度');
    const items = [
        { id:'file1', type:'document', confidence: Math.random().toFixed(2) },
        { id:'meta1', type:'metadata', confidence: Math.random().toFixed(2) }
    ];
    // mark those with low confidence
    const flagged = items.filter(i=>parseFloat(i.confidence)<0.5);
    window.forensicsLabData.fakeCheck = { timestamp: Date.now(), items, flagged };
    document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.fakeCheck, null, 2);
    appendForensicsLog('假證據檢測完成（模擬） - 可疑項目: '+flagged.length);
}

// --- 專業取證工具套件（模擬實作）
function simulateDiskImageAnalyzerDetailed(){
    appendForensicsLog('啟動磁碟映像分析儀（模擬） - 正在掛載映像...');
    // simulate file system carving and timeline
    setTimeout(()=>{
        const artifacts = [
            { path:'/home/victim/documents/secret.docx', size: '45KB', recovered:true, mtime:'2025-08-01T10:02:05Z' },
            { path:'/home/victim/.ssh/id_rsa', size: '1.6KB', recovered:true, note:'私鑰樣本' },
            { path:'/var/log/auth.log', size:'120KB', recovered:true }
        ];
        window.forensicsLabData.diskDetailed = { timestamp: Date.now(), artifacts };
        document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.diskDetailed, null, 2);
        appendForensicsLog('映像分析完成（模擬） - 復原項目: '+artifacts.length);
    }, 1800);
}

function simulateMemoryForensicsDetailed(){
    appendForensicsLog('啟動記憶體取證（模擬） - 擷取記憶體鏡像...');
    setTimeout(()=>{
        const processes = [
            { pid: 4242, name:'evil.exe', cmdline:'evil.exe --stealth', suspicious:true },
            { pid: 1337, name:'svchost.exe', cmdline:'svchost -k netsvcs', suspicious:false }
        ];
        const nets = [ { pid:4242, proto:'tcp', local:'10.0.0.5:443', remote:'198.51.100.23:4444' } ];
        window.forensicsLabData.memoryDetailed = { timestamp: Date.now(), processes, nets };
        document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.memoryDetailed, null, 2);
        appendForensicsLog('記憶體取證完成（模擬） - 發現可疑程序: '+processes.filter(p=>p.suspicious).length);
    }, 1500);
}

function simulateLogCorrelatorDetailed(){
    appendForensicsLog('啟動日誌關聯分析器（模擬） - 正在聚合日誌來源...');
    setTimeout(()=>{
        const correlated = [
            { time:'2025-08-01T09:58:12Z', event:'Port scan', source:'198.51.100.23' },
            { time:'2025-08-01T10:02:05Z', event:'File upload secret.docx', source:'198.51.100.23' },
            { time:'2025-08-01T10:05:33Z', event:'C2 heartbeat', source:'203.0.113.12' }
        ];
        window.forensicsLabData.logCorrelator = { timestamp: Date.now(), correlated };
        document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.logCorrelator, null, 2);
        appendForensicsLog('日誌關聯完成（模擬） - 已建立 '+correlated.length+' 組關聯');
    }, 1600);
}

function simulateMobileForensics(){
    appendForensicsLog('啟動行動設備取證（模擬） - 擷取通話記錄與應用資料...');
    setTimeout(()=>{
        const mobile = { imei:'356789012345678', phone:'+85291234567', contacts:5, messages:12, appData:['WhatsApp','Signal'] };
        window.forensicsLabData.mobile = { timestamp: Date.now(), mobile };
        document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.mobile, null, 2);
        appendForensicsLog('行動設備取證完成（模擬） - 檢索到 '+mobile.messages+' 條訊息（模擬）');
    }, 1400);
}

function simulateMetadataExtractorFromFile(e){
    const f = e.target.files && e.target.files[0];
    if(!f) return; appendForensicsLog('載入檔案以提取元數據（本地讀取，未上傳）: '+f.name);
    const reader = new FileReader();
    reader.onload = function(ev){
        // mock metadata extraction using file info
        const meta = { filename: f.name, size: f.size, type: f.type || 'unknown', extracted: { author:'unknown', created: new Date().toISOString() } };
        window.forensicsLabData.metadataFile = { timestamp: Date.now(), meta };
        document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.metadataFile, null, 2);
        appendForensicsLog('元數據提取完成（模擬） - 檔名: '+f.name);
    };
    reader.readAsArrayBuffer(f);
}

function startEvidenceDecayTimer(){
    const sec = Number(document.getElementById('decay-seconds').value || 60);
    stopEvidenceDecayTimer();
    window._evidenceDecayTimer.remaining = sec;
    const status = document.getElementById('decay-status');
    status.textContent = '倒數中：'+window._evidenceDecayTimer.remaining+'s';
    appendForensicsLog('啟動證據倒數（模擬）: '+sec+' 秒');
    window._evidenceDecayTimer.id = setInterval(()=>{
        window._evidenceDecayTimer.remaining -= 1;
        status.textContent = '倒數中：'+window._evidenceDecayTimer.remaining+'s';
        if(window._evidenceDecayTimer.remaining<=0){
            clearInterval(window._evidenceDecayTimer.id); window._evidenceDecayTimer.id = null;
            status.textContent = '證據已衰減/被加密（模擬）';
            // mark evidence as inaccessible
            window.forensicsLabData.decay = { timestamp: Date.now(), status:'lost_or_encrypted' };
            document.getElementById('forensics-results').textContent = JSON.stringify(window.forensicsLabData.decay, null, 2);
            appendForensicsLog('證據已失效或被加密（模擬） - 部分分析結果可能不可用');
        }
    }, 1000);
}

function stopEvidenceDecayTimer(){
    if(window._evidenceDecayTimer.id) clearInterval(window._evidenceDecayTimer.id);
    window._evidenceDecayTimer.id = null; window._evidenceDecayTimer.remaining = 0;
    const status = document.getElementById('decay-status'); if(status) status.textContent = '';
    appendForensicsLog('已停止證據倒數（模擬）');
}
</script>

<!-- tactical features removed as requested -->
<script>
// COMMAND version
window.COMMAND_VERSION = '5.0';

// Unified Shop System (replaces older fragmented implementations at runtime)
window.ShopSystem = (function(){
    const catalog = {
        hacker: [
            { id: 'vpn_chain', name: '高級VPN鏈', price: 20000, category: 'stealth', desc: '增加隱蔽度', icon: 'fa-link' },
            { id: 'zero_day', name: '零日漏洞利用', price: 50000, category: 'attack', desc: '增加攻擊力', icon: 'fa-bomb' },
            { id: 'crypto_mixer', name: '加密貨幣混合器', price: 30000, category: 'finance', desc: '混淆資金流向', icon: 'fa-coins' },
            { id: 'identity_hider', name: '身份隱藏器', price: 55000, category: 'stealth', desc: '完全隱藏身份', icon: 'fa-user-secret' }
        ],
        law_enforcement: [
            { id: 'ai_analyst', name: 'AI分析師', price: 30000, category: 'investigation', desc: '提升調查速度', icon: 'fa-robot' },
            { id: 'forensic_suite', name: '高級鑑識套件', price: 50000, category: 'forensics', desc: '提升證據質量', icon: 'fa-search' },
            { id: 'intercept_key', name: '合法攔截密鑰', price: 70000, category: 'decryption', desc: '解密通訊', icon: 'fa-key' },
            { id: 'evidence_protector', name: '證據保護系統', price: 55000, category: 'defense', desc: '防止證據污染', icon: 'fa-shield-alt' }
        ]
    };

    let activeCategory = 'all';
    let currentRole = null;

    function ensureModal() {
        let modal = document.getElementById('shop-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'shop-modal';
            modal.innerHTML = `<div class="modal-content shop-modal-content"><div style="display:flex;justify-content:space-between;align-items:center"><h3 id="shop-modal-title">商店</h3><button onclick="document.getElementById('shop-modal').style.display='none'">×</button></div><div id="shop-controls" style="margin:10px 0"></div><div id="shop-message"></div></div>`;
            document.body.appendChild(modal);
        }
        return modal;
    }

    function formatMoney(n){ return '$' + (n||0).toLocaleString(); }

    function renderControls(role){
        const controls = document.getElementById('shop-controls');
        if (!controls) return;
        const cats = Array.from(new Set(['all'].concat((catalog[role]||[]).map(i=>i.category))));
        controls.innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center"><div style="font-weight:bold;margin-right:8px">分類:</div>` + cats.map(c=>`<button class="shop-filter-btn" data-cat="${c}" onclick="ShopSystem.filter('${c}')" style="padding:6px;border:1px solid #444;background:${c==='all'?'#222':'transparent'};color:#fff;border-radius:4px">${c}</button>`).join('') + `</div>`;
    }

    function renderItems(role){
        const container = document.getElementById('shop-message');
        if (!container) return;
        const items = (catalog[role]||[]).filter(i => activeCategory === 'all' ? true : i.category === activeCategory);
        const money = getCurrency(role);
        const html = items.map(item => `
            <div class="shop-item-card" style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)">
                <div style="display:flex;gap:10px;align-items:center">
                    <div style="width:36px;height:36px;border-radius:6px;background:#111;display:flex;align-items:center;justify-content:center"><i class="fas ${item.icon}"></i></div>
                    <div>
                        <div style="font-weight:bold">${item.name}</div>
                        <div style="font-size:0.85rem;color:#aaa">${item.desc}</div>
                    </div>
                </div>
                <div style="text-align:right">
                    <div style="font-weight:bold;color:#ffd700">${formatMoney(item.price)}</div>
                    <div style="margin-top:6px"><button onclick="ShopSystem.buy('${item.id}')" style="padding:6px 10px;border-radius:6px;background:${money>=item.price?'#00aaff':'#444'};color:#000;border:none;cursor:pointer">購買</button></div>
                </div>
            </div>
        `).join('');
        container.innerHTML = `<div style="margin-bottom:8px;color:#bbb">可用資金: <span style='font-weight:bold;color:#00ff88'>${formatMoney(money)}</span></div>` + (html || '<div style="color:#999;padding:12px">無此分類商品</div>');
    }

    function getCurrency(role){
        try{
            if (!window.GameState || !window.GameState.playerData) return 0;
            if (role === 'hacker') return window.GameState.playerData.hacker.darknetCredits || window.GameState.playerData.hacker.money || 0;
            return window.GameState.playerData.law_enforcement.budget || window.GameState.playerData.law_enforcement.money || 0;
        }catch(e){return 0}
    }

    function adjustCurrency(role, delta){
        if (!window.GameState || !window.GameState.playerData) return;
        if (role === 'hacker') {
            window.GameState.playerData.hacker.darknetCredits = (window.GameState.playerData.hacker.darknetCredits||0) + delta;
        } else {
            window.GameState.playerData.law_enforcement.budget = (window.GameState.playerData.law_enforcement.budget||0) + delta;
        }
    }

    function applyItemEffect(role,item){
        // simple effect handlers (extend as needed)
        const pd = window.GameState.playerData[role];
        if (!pd) return;
        pd.tools = pd.tools || [];
        pd.tools.push(item.id);
        if (item.category === 'stealth') pd.stealth = Math.min(100,(pd.stealth||0) + 10);
        if (item.category === 'attack') pd.attackPower = (pd.attackPower||0) + 10;
        if (item.category === 'defense') pd.serverHealth = Math.min(100,(pd.serverHealth||0) + 8);
    }

    return {
        open(role){
            currentRole = role || (window.GameState && window.GameState.currentRole) || 'hacker';
            const modal = ensureModal();
            document.getElementById('shop-modal-title').textContent = `${currentRole === 'hacker' ? '黑客商店' : '執法商店'} - 商店 (v${window.COMMAND_VERSION})`;
            renderControls(currentRole);
            renderItems(currentRole);
            modal.style.display = 'flex';
        },
        filter(cat){ activeCategory = cat; renderItems(currentRole); },
        buy(itemId){
            const role = currentRole || (window.GameState && window.GameState.currentRole) || 'hacker';
            const item = (catalog[role]||[]).find(i => i.id === itemId);
            if (!item) { showNotification('購買失敗','商品不存在','error'); return; }
            const money = getCurrency(role);
            if (money < item.price) { showNotification('資金不足','你沒有足夠資金購買此商品','error'); return; }
            adjustCurrency(role, -item.price);
            applyItemEffect(role,item);
            if (typeof addTerminalLine === 'function') addTerminalLine(`[購買] ${item.name} 已購買 (${role})`, 'success');
            showNotification('購買成功', `${item.name} 已加入你的裝備`, 'success');
            // analytics event
            if (window.Analytics && typeof window.Analytics.recordEvent === 'function') {
                window.Analytics.recordEvent('purchase', { role, itemId, price: item.price });
            }
            renderItems(role);
            if (typeof updateShopUI === 'function') updateShopUI();
            if (typeof updateGameStats === 'function') updateGameStats();
        },
        // expose for wiring
        _catalog: catalog,
        filter: function(cat){ this.filter(cat); }
    };
})();

// override global hooks to point to unified shop
window.openShop = function(){ ShopSystem.open(); };
window.openHackerShop = window.openLEShop = window.openShop;
// delegated to ShopSystem elsewhere

// Lightweight Analytics upgrade: track game stats & trends
window.Analytics = (function(){
    const history = [];
    function snapshot(){
        if (!window.GameState) return;
        const t = { time: Date.now() };
        try{
            t.hacker_money = window.GameState.playerData.hacker.money || 0;
            t.hacker_darknet = window.GameState.playerData.hacker.darknetCredits || 0;
            t.le_budget = window.GameState.playerData.law_enforcement.budget || 0;
            t.cases_open = (window.LE_SYSTEM && window.LE_SYSTEM.cases) ? window.LE_SYSTEM.cases.length : 0;
            t.inventory_counts = { hacker: (window.GameState.playerData.hacker.tools||[]).length, le: (window.GameState.playerData.law_enforcement.tools||[]).length };
        }catch(e){ }
        history.push(t);
        if (history.length > 200) history.shift();
    }

    setInterval(snapshot, 30000); // capture every 30s

    function computeSummary(){
        if (!history.length) return {};
        const last = history[history.length-1];
        const first = history[0];
        return {
            snapshots: history.length,
            hacker_money_delta: last.hacker_money - (first.hacker_money||0),
            le_budget_delta: last.le_budget - (first.le_budget||0),
            avg_hacker_money: Math.round(history.reduce((s,h)=>s+(h.hacker_money||0),0)/history.length)
        };
    }

    function openDashboard(){
        const id = 'analytics-dashboard-modal';
        let modal = document.getElementById(id);
        if (!modal) {
            modal = document.createElement('div'); modal.id = id; modal.style.cssText = 'position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:780px;max-width:95%;background:#071428;color:#fff;padding:18px;border:2px solid #4a90d9;z-index:100000;border-radius:8px;';
            modal.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>數據分析儀表板 v${window.COMMAND_VERSION}</h3><button onclick="document.getElementById('${id}').remove()">Close</button></div><div id="analytics-body" style="margin-top:12px"></div>`;
            document.body.appendChild(modal);
        }
        const body = document.getElementById('analytics-body');
        const summary = computeSummary();
        body.innerHTML = `<div style="display:flex;gap:12px"><div style="flex:1"><h4>即時統計</h4><p>快照數: ${summary.snapshots||0}</p><p>黑客資金變化: ${summary.hacker_money_delta||0}</p><p>執法部門預算變化: ${summary.le_budget_delta||0}</p></div><div style="flex:1"><h4>趨勢圖</h4><canvas id="analytics-canvas" width="300" height="140" style="background:#021018;border:1px solid rgba(255,255,255,0.03)"></canvas></div></div>`;
        // draw simple sparkline of hacker money
        const c = document.getElementById('analytics-canvas'); if (c && history.length){ const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); const values = history.map(h=>h.hacker_money||0); const min=Math.min(...values); const max=Math.max(...values); const range = Math.max(1,max-min); for(let i=0;i<values.length;i++){ const x = (i/(values.length-1))*(c.width-10)+5; const y = c.height-5 - ((values[i]-min)/range)*(c.height-10); if(i===0){ ctx.beginPath(); ctx.moveTo(x,y);} else { ctx.lineTo(x,y);} } ctx.strokeStyle='#00ff88'; ctx.lineWidth=2; ctx.stroke(); }
    }

    return { recordEvent: (type,data)=>{ history.push(Object.assign({time:Date.now(),type},data)); if(history.length>400) history.shift(); }, openDashboard, _history: history };
})();

// Expose quick commands
window.openAnalyticsDashboard = function(){ window.Analytics.openDashboard(); };

</script>
    

    <!-- 暗網聯絡站頁面 -->
    <div id="darknet-hub-page" class="page">
        <div class="darknet-container">
            <div class="darknet-header">
                <div class="darknet-title">
                    <i class="fas fa-network-wired"></i> ONION_HUB_V3
                </div>
                <div class="darknet-subtitle">
                    > 匿名中繼節點: 127.0.0.1:9050 | 加密協議: TOR/XMR | 狀態: 隱蔽
                </div>
                <!-- 隱藏功能提示 -->
                <div class="hidden-hint" style="font-size: 0.75rem; color: rgba(0, 255, 65, 0.3); margin-top: 5px; cursor: help;" title="提示：在暗網按下 Ctrl+Shift+X 可開啟隱藏的黑客調試終端，或 Ctrl+Shift+B 啟動瀏覽器外掛注入。">
                    <i class="fas fa-info-circle"></i> 系統提示：偵測到加密隧道，可使用快捷鍵調用地下擴展工具。
                </div>
            </div>

            <div class="darknet-layout">
                <!-- 左側：聯絡人與聊天室 -->
                <div class="darknet-sidebar">
                    <h3 style="color: #00ff41; border-bottom: 1px solid #00ff41; padding-bottom: 5px;">
                        <i class="fas fa-comments"></i> 匿名頻道
                    </h3>
                    <div class="darknet-contact-item active" onclick="switchDarknetChannel('global')">
                        <div class="status-dot"></div>
                        <span># 全球黑客廣場</span>
                    </div>
                    <div class="darknet-contact-item" onclick="switchDarknetChannel('intel')">
                        <div class="status-dot" style="background: #ff0000; box-shadow: 0 0 5px #ff0000;"></div>
                        <span># 情報交易中心</span>
                    </div>
                    <div class="darknet-contact-item" onclick="switchDarknetChannel('mixer')">
                        <div class="status-dot" style="background: #ffff00; box-shadow: 0 0 5px #ffff00;"></div>
                        <span># 門羅幣混幣器</span>
                    </div>
                    
                    <div style="margin-top: auto; padding: 10px; border: 1px dashed #00ff41; font-size: 0.8rem;">
                        <p>當前身份: <span style="color: #fff;">Anon_User_772</span></p>
                        <p>信用等級: <span style="color: #ffff00;">★★★★☆</span></p>
                    </div>
                    
                    <div style="margin-top:12px; padding:10px; border-top:1px solid rgba(255,255,255,0.04);">
                        <div style="font-size:0.9rem; color:#bc13fe; font-weight:bold; margin-bottom:6px;">快速監控</div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn" onclick="openMonitoringPanel()">監控面板</button>
                            <button class="btn" onclick="openBattleMonitor()">對戰監控</button>
                            <button class="btn" onclick="openForensicsLab()">鑑識實驗室</button>
                            <button class="btn" onclick="openNetworkAdvanced()">深度網路分析</button>
                        </div>
                    </div>
                </div>

                <!-- 中間：動態交流區 -->
                <div class="darknet-chat-area">
                    <div id="darknet-chat-messages" class="darknet-chat-messages">
                        <!-- 初始消息 -->
                        <div class="chat-msg">
                            <span class="chat-time">14:20:05</span>
                            <span class="chat-user" style="color: #ff00ff;">[System]</span>
                            <span class="chat-text">歡迎來到 Onion_Hub。所有通訊均已通過 7 層代理加密。</span>
                        </div>
                        <div class="chat-msg">
                            <span class="chat-time">14:21:12</span>
                            <span class="chat-user">Ghost_Zero</span>
                            <span class="chat-text">有人知道執法部門最近的「藍色風暴」行動嗎？我的三個節點被端了。</span>
                        </div>
                        <div class="chat-msg">
                            <span class="chat-time">14:22:30</span>
                            <span class="chat-user">Crypto_Queen</span>
                            <span class="chat-text">@Ghost_Zero 聽說是用了新的 AI 行為預測，建議切換到 I2P 協議。</span>
                        </div>
                    </div>
                    <div class="darknet-chat-input">
                        <input type="text" id="darknet-user-input" class="darknet-input" placeholder="輸入加密訊息...">
                        <button class="darknet-send-btn" onclick="sendDarknetMessage()">發送</button>
                    </div>
                </div>

                <!-- 右側：黑市交易與僱傭 -->
                <div class="darknet-sidebar">
                    <h3 style="color: #bc13fe; border-bottom: 1px solid #bc13fe; padding-bottom: 5px;">
                        <i class="fas fa-shopping-cart"></i> 黑市服務
                    </h3>
                    <div class="darknet-market-panel">
                        <div class="market-item">
                            <span>執法部門動向情報</span>
                            <button class="market-buy-btn" onclick="buyDarknetService('le_intel', 5000)">$5k</button>
                        </div>
                        <div class="market-item">
                            <span>零日漏洞 (Zero-day)</span>
                            <button class="market-buy-btn" onclick="buyDarknetService('zero_day', 15000)">$15k</button>
                        </div>
                        <div class="market-item">
                            <span>僱傭黑客分散注意力</span>
                            <button class="market-buy-btn" onclick="buyDarknetService('hire_distraction', 8000)">$8k</button>
                        </div>
                        <div class="market-item">
                            <span>混幣洗錢 (手續費 10%)</span>
                            <button class="market-buy-btn" onclick="startMoneyLaundering()">執行</button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h3 style="color: #00ff41; border-bottom: 1px solid #00ff41; padding-bottom: 5px;">
                            <i class="fas fa-user-secret"></i> 僱傭狀態
                        </h3>
                        <div id="hired-status" style="font-size: 0.8rem; color: #888; padding: 10px;">
                            目前無活躍僱傭任務
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn back-btn" onclick="goToMainPage()" style="border-color: #00ff41; color: #00ff41;">
                    <i class="fas fa-power-off"></i> 斷開暗網連接
                </button>
            </div>
        </div>
    </div>

    <!-- 操作指南頁面 -->
    <div id="intercept-page" class="page">
    <div class="container">
        <div class="section-header">
            <h2><i class="fas fa-satellite-dish"></i> 通信攔截與破解系統</h2>
            <p>監控加密通信頻道，實時攔截並破解可疑數據包。</p>
        </div>
        
        <div class="intercept-layout">
            <div class="intercept-sidebar">
                <div class="panel-title">活動頻道</div>
                <div id="channel-list" class="channel-list">
                    <!-- 動態生成頻道 -->
                </div>
                <button class="action-btn" onclick="startScanningChannels()">
                    <i class="fas fa-search"></i> 掃描新頻道
                </button>
            </div>
            
            <div class="intercept-main">
                <div class="intercept-monitor">
                    <div class="monitor-header">
                        <span id="current-channel-name">未選擇頻道</span>
                        <span class="status-tag" id="intercept-status">等待中</span>
                    </div>
                    <div id="intercept-log" class="intercept-log">
                        <div class="log-entry system">系統就緒，請選擇要監控的頻道...</div>
                    </div>
                </div>
                
                <div class="crack-panel">
                    <div class="crack-info">
                        <div class="crack-progress-container">
                            <div class="crack-label">破解進度: <span id="crack-percentage">0%</span></div>
                            <div class="progress-bar-container">
                                <div id="crack-progress-fill" class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="crack-details" id="crack-details">
                            加密算法: --- | 密鑰強度: ---
                        </div>
                    </div>
                    <button id="crack-btn" class="crack-btn" onclick="startCracking()" disabled>
                        <i class="fas fa-unlock-alt"></i> 開始破解
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="trap-page" class="page">
    <div class="container">
        <div class="section-header">
            <h2><i class="fas fa-spider"></i> 網絡陷阱與誘餌系統</h2>
            <p>部署蜜罐節點與虛擬陷阱，誘導並捕獲黑客攻擊行為。</p>
        </div>
        
        <div class="trap-grid">
            <div class="trap-card" onclick="deployTrap('honeypot')">
                <i class="fas fa-database"></i>
                <h3>虛擬數據庫蜜罐</h3>
                <p>偽裝成含有敏感客戶資料的數據庫，吸引未授權訪問。</p>
                <div class="trap-stats">部署成本: 500 | 威脅等級: 低</div>
            </div>
            <div class="trap-card" onclick="deployTrap('credentials')">
                <i class="fas fa-key"></i>
                <h3>虛假憑據陷阱</h3>
                <p>在系統中散佈虛假的系統管理員憑據，追蹤其使用路徑。</p>
                <div class="trap-stats">部署成本: 300 | 威脅等級: 中</div>
            </div>
            <div class="trap-card" onclick="deployTrap('backdoor')">
                <i class="fas fa-door-open"></i>
                <h3>受控後門誘餌</h3>
                <p>故意留下的「安全漏洞」，實則為全時監控的捕獲點。</p>
                <div class="trap-stats">部署成本: 800 | 威脅等級: 高</div>
            </div>
        </div>
        
        <div class="active-traps-section">
            <div class="panel-title">已部署陷阱狀態</div>
            <table class="trap-table">
                <thead>
                    <tr>
                        <th>類型</th>
                        <th>位置</th>
                        <th>狀態</th>
                        <th>觸發次數</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="active-traps-list">
                    <!-- 動態生成 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="evidence-page" class="page">
    <div class="container">
        <div class="section-header">
            <h2><i class="fas fa-archive"></i> 執法證據庫 • EVIDENCE REPOSITORY</h2>
            <p>管理並分析從通信攔截與網絡陷阱中獲取的數位證物。</p>
        </div>
        
        <div class="evidence-layout">
            <div class="evidence-stats">
                <div class="stat-box">
                    <span class="stat-label">總證物數</span>
                    <span class="stat-value" id="total-evidence">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">已破解內容</span>
                    <span class="stat-value" id="cracked-evidence">0</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">威脅等級</span>
                    <span class="stat-value" id="threat-level">低</span>
                </div>
            </div>
            
            <div class="evidence-main">
                <div class="evidence-list-container">
                    <div class="panel-title">證物清單</div>
                    <div id="evidence-list" class="evidence-list">
                        <!-- 動態生成證物條目 -->
                        <div class="empty-state">暫無證物，請開始攔截通信或部署陷阱。</div>
                    </div>
                </div>
                
                <div class="evidence-detail-panel" id="evidence-detail">
                    <div class="panel-title">證物詳細分析</div>
                    <div id="detail-content" class="detail-content">
                        <p class="placeholder">請從左側選擇一個證物進行查看</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="skill-tree-page" class="page"><div class="container"><div class="section-header"><h2><i class="fas fa-tree"></i> 技能樹系統</h2><p>消耗資源提升您的技術能力。</p></div><div id="skill-tree-container"></div></div></div>

<!-- ===== 設備與網絡監控系統頁面 ===== -->
<div id="device-network-monitor-page" class="page" style="display: none;">
    <div class="container" style="padding: 80px 20px 40px;">
        <div class="section-header">
            <h2><i class="fas fa-network-wired"></i> 設備與網絡監控系統</h2>
            <p>實時查看自己和對手的設備狀態、網絡活動和系統指標</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
            <!-- 自己設備信息 -->
            <div style="background: rgba(25, 25, 40, 0.9); border: 2px solid #4a90d9; border-radius: 12px; padding: 25px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <h3 style="color: #4a90d9; margin: 0;">
                        <i class="fas fa-laptop"></i> 我的設備信息
                    </h3>
                    <span class="status-badge" id="my-device-status" style="background: #00ff41; color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold;">●正常</span>
                </div>
                
                <div id="my-device-info" style="display: grid; gap: 15px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">設備類型</div>
                        <div style="color: #fff; font-weight: bold; font-size: 1.1rem;">個人電腦 (Windows 11 Pro)</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">處理器</div>
                        <div style="color: #4a90d9; font-weight: bold;">Intel Core i9-13900K @ 3.0GHz</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">記憶體 / 使用率</div>
                        <div style="color: #fff; font-weight: bold;">64GB DDR5 / <span style="color: #00ff41;">28%</span></div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">網絡連接</div>
                        <div style="color: #fff; font-weight: bold;">Wi-Fi 6E | 信號強度: <span style="color: #00ff41;">5 格</span></div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">網絡速度</div>
                        <div style="color: #fff; font-weight: bold;">↓ 850 Mbps | ↑ 420 Mbps</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">防火牆狀態</div>
                        <div style="color: #00ff41; font-weight: bold;">●已啟用 | 威脅已封鎖: 342</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">系統安全度</div>
                        <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-top: 5px; overflow: hidden;">
                            <div style="width: 92%; height: 100%; background: linear-gradient(90deg, #00ff41, #4a90d9);"></div>
                        </div>
                        <div style="color: #999; font-size: 0.8rem; margin-top: 5px;">92% - 健康</div>
                    </div>
                </div>
            </div>
            
            <!-- 對手設備信息 -->
            <div style="background: rgba(25, 25, 40, 0.9); border: 2px solid #ff3333; border-radius: 12px; padding: 25px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                    <h3 style="color: #ff3333; margin: 0;">
                        <i class="fas fa-laptop"></i> 對手設備信息
                    </h3>
                    <span class="status-badge" id="opponent-device-status" style="background: #ff3333; color: #fff; padding: 5px 15px; border-radius: 20px; font-weight: bold;">●威脅</span>
                </div>
                
                <div id="opponent-device-info" style="display: grid; gap: 15px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">設備類型</div>
                        <div style="color: #fff; font-weight: bold; font-size: 1.1rem;">個人電腦 (Ubuntu 22.04 LTS)</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">處理器</div>
                        <div style="color: #ff9900; font-weight: bold;">AMD Ryzen 9 7950X @ 4.5GHz</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">記憶體 / 使用率</div>
                        <div style="color: #fff; font-weight: bold;">128GB DDR5 / <span style="color: #ff3333;">76%</span></div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">網絡連接</div>
                        <div style="color: #fff; font-weight: bold;">有線網絡 | 位置: <span style="color: #ff9900;">未知</span></div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">網絡速度</div>
                        <div style="color: #fff; font-weight: bold;">↓ 1200 Mbps | ↑ 950 Mbps</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">防禦措施</div>
                        <div style="color: #ff3333; font-weight: bold;">●高度警戒 | 代理: 5層</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">威脅指數</div>
                        <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-top: 5px; overflow: hidden;">
                            <div style="width: 68%; height: 100%; background: linear-gradient(90deg, #ff3333, #ff9900);"></div>
                        </div>
                        <div style="color: #999; font-size: 0.8rem; margin-top: 5px;">68% - 高風險</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 網絡活動監控 -->
        <div style="margin-top: 40px; background: rgba(25, 25, 40, 0.9); border: 2px solid #4a90d9; border-radius: 12px; padding: 25px;">
            <h3 style="color: #4a90d9; margin: 0 0 20px 0;">
                <i class="fas fa-stream"></i> 實時網絡活動監控
            </h3>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; border-left: 3px solid #00ff41;">
                    <div style="color: #999; font-size: 0.85rem;">上行流量 (↑)</div>
                    <div style="color: #00ff41; font-weight: bold; font-size: 1.3rem;">2.3 MB/s</div>
                    <div style="color: #999; font-size: 0.8rem; margin-top: 5px;">峰值: 5.8 MB/s</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; border-left: 3px solid #4a90d9;">
                    <div style="color: #999; font-size: 0.85rem;">下行流量 (↓)</div>
                    <div style="color: #4a90d9; font-weight: bold; font-size: 1.3rem;">8.7 MB/s</div>
                    <div style="color: #999; font-size: 0.8rem; margin-top: 5px;">峰值: 12.4 MB/s</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; border-left: 3px solid #ffff00;">
                    <div style="color: #999; font-size: 0.85rem;">活躍連接</div>
                    <div style="color: #ffff00; font-weight: bold; font-size: 1.3rem;">47</div>
                    <div style="color: #999; font-size: 0.8rem; margin-top: 5px;">TCP/UDP</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; border-left: 3px solid #ff9900;">
                    <div style="color: #999; font-size: 0.85rem;">異常流量</div>
                    <div style="color: #ff9900; font-weight: bold; font-size: 1.3rem;">3</div>
                    <div style="color: #999; font-size: 0.8rem; margin-top: 5px;">已標記</div>
                </div>
            </div>
            
            <!-- 封包分析器 -->
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; margin-top: 15px;">
                <div style="color: #4a90d9; font-weight: bold; margin-bottom: 10px;">
                    <i class="fas fa-microchip"></i> 網絡封包分析
                </div>
                <div style="font-family: 'Courier New', monospace; font-size: 0.8rem; color: #999; max-height: 200px; overflow-y: auto;">
                    <div style="color: #00ff41;">[12:45:32] TCP 192.168.1.100:54321 → 142.251.32.14:443 [HTTPS] 2.4KB ✓</div>
                    <div style="color: #00ff41;">[12:45:32] UDP 192.168.1.100:53891 → 8.8.8.8:53 [DNS] 0.1KB ✓</div>
                    <div style="color: #ff9900;">[12:45:33] TCP 192.168.1.100:12345 → 10.0.0.1:22 [SSH] - 異常</div>
                    <div style="color: #00ff41;">[12:45:34] TCP 192.168.1.100:51234 → 104.21.12.34:80 [HTTP] 1.8KB ✓</div>
                    <div style="color: #00ff41;">[12:45:34] UDP 192.168.1.100:51895 → 224.0.0.251:5353 [mDNS] 0.2KB ✓</div>
                    <div style="color: #00ff41;">[12:45:35] TCP 192.168.1.100:48234 → 142.251.32.14:443 [HTTPS] 3.2KB ✓</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== 詳細目標情報系統（執法部門專屬）===== -->
<div id="target-intelligence-page" class="page" style="display: none;">
    <div class="container" style="padding: 80px 20px 40px;">
        <div class="section-header">
            <h2><i class="fas fa-crosshairs"></i> 詳細目標情報分析</h2>
            <p>執法部門專屬 - 對手(AI)的完整檔案、分析報告和犯罪紀錄</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
            <!-- 目標身份資料 -->
            <div style="background: rgba(25, 25, 40, 0.9); border: 2px solid #ff3333; border-radius: 12px; padding: 25px;">
                <h3 style="color: #ff3333; margin: 0 0 20px 0;">
                    <i class="fas fa-user-secret"></i> 目標身份檔案
                </h3>
                
                <div style="display: grid; gap: 15px;">
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">代號</div>
                        <div style="color: #ff3333; font-weight: bold; font-size: 1.1rem;">PHOENIX_X47</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">活躍期間</div>
                        <div style="color: #fff; font-weight: bold;">2019年 - 至今 (5年)</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">技術能力等級</div>
                        <div style="color: #ff9900; font-weight: bold;">★★★★★ 極度危險</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">確認身份</div>
                        <div style="color: #fff; font-weight: bold;">未確認 (高度隱蔽)</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">地理位置</div>
                        <div style="color: #999; font-weight: bold;">東歐 (推測)</div>
                    </div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px;">
                        <div style="color: #999; font-size: 0.85rem;">威脅指數</div>
                        <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-top: 5px; overflow: hidden;">
                            <div style="width: 95%; height: 100%; background: #ff3333;"></div>
                        </div>
                        <div style="color: #999; font-size: 0.8rem; margin-top: 5px;">95% - 最高威脅</div>
                    </div>
                </div>
            </div>
            
            <!-- 已知犯罪紀錄 -->
            <div style="background: rgba(25, 25, 40, 0.9); border: 2px solid #ff6600; border-radius: 12px; padding: 25px;">
                <h3 style="color: #ff6600; margin: 0 0 20px 0;">
                    <i class="fas fa-exclamation-triangle"></i> 已知犯罪紀錄
                </h3>
                
                <div style="display: grid; gap: 10px; max-height: 350px; overflow-y: auto;">
                    <div style="background: rgba(255, 102, 0, 0.1); padding: 12px; border-left: 3px solid #ff6600; border-radius: 4px;">
                        <div style="color: #ff6600; font-weight: bold;">2024/11 - 勒索軟體攻擊 (金融機構)</div>
                        <div style="color: #999; font-size: 0.85rem;">受害者: 東京銀行集團 | 損失: $850萬</div>
                    </div>
                    <div style="background: rgba(255, 102, 0, 0.1); padding: 12px; border-left: 3px solid #ff6600; border-radius: 4px;">
                        <div style="color: #ff6600; font-weight: bold;">2024/09 - 數據洩露事件</div>
                        <div style="color: #999; font-size: 0.85rem;">受害者: 全球電信公司 | 洩露記錄: 2500萬</div>
                    </div>
                    <div style="background: rgba(255, 102, 0, 0.1); padding: 12px; border-left: 3px solid #ff6600; border-radius: 4px;">
                        <div style="color: #ff6600; font-weight: bold;">2024/07 - 供應鏈攻擊</div>
                        <div style="color: #999; font-size: 0.85rem;">目標: 軟體開發公司 | 影響範圍: 企業級客戶</div>
                    </div>
                    <div style="background: rgba(255, 102, 0, 0.1); padding: 12px; border-left: 3px solid #ff6600; border-radius: 4px;">
                        <div style="color: #ff6600; font-weight: bold;">2024/05 - APT 活動</div>
                        <div style="color: #999; font-size: 0.85rem;">受害者: 政府機構 | 持續時間: 3個月</div>
                    </div>
                    <div style="background: rgba(255, 102, 0, 0.1); padding: 12px; border-left: 3px solid #ff6600; border-radius: 4px;">
                        <div style="color: #ff6600; font-weight: bold;">2024/03 - 網絡釣魚活動</div>
                        <div style="color: #999; font-size: 0.85rem;">目標: 公司高管 | 成功入侵: 12人</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 分析與情報 -->
        <div style="margin-top: 30px; background: rgba(25, 25, 40, 0.9); border: 2px solid #4a90d9; border-radius: 12px; padding: 25px;">
            <h3 style="color: #4a90d9; margin: 0 0 20px 0;">
                <i class="fas fa-brain"></i> AI 對手分析與情報
            </h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 10px;">攻擊風格</div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; color: #ccc;">
                        • 多層代理隱蔽技術<br>
                        • 進階持久威脅 (APT) 戰術<br>
                        • 零日漏洞利用<br>
                        • 供應鏈滲透<br>
                        • 雙向勒索手法
                    </div>
                </div>
                
                <div>
                    <div style="color: #4a90d9; font-weight: bold; margin-bottom: 10px;">已知工具清單</div>
                    <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; color: #ccc;">
                        • Cobalt Strike<br>
                        • Mimikatz<br>
                        • PsExec<br>
                        • 自製勒索軟體變種<br>
                        • C2 通信框架
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <div style="color: #4a90d9; font-weight: bold; margin-bottom: 10px;">防禦建議</div>
                <div style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 6px; color: #ccc; line-height: 1.6;">
                    此目標採用高度複雜的隱蔽技術，建議採取多層防禦策略：端點檢測與響應 (EDR)、實時威脅情報監控、定期滲透測試、供應鏈安全評估、員工安全意識培訓。需要國際協作進行追蹤。
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== 暗網系統升級（黑客專屬）===== -->
<div id="darknet-marketplace-page" class="page" style="display: none;">
    <div class="container" style="padding: 80px 20px 40px;">
        <div class="section-header">
            <h2><i class="fas fa-mask"></i> 暗網中介聯絡站 • DARK NET MARKETPLACE</h2>
            <p>黑客專屬 - 聯繫不同行家、交易工具、分享情報、進行黑市交易</p>
        </div>
        
        <div style="display: grid; grid-template-columns: 250px 1fr; gap: 30px; margin-top: 30px;">
            <!-- 聯繫人列表 -->
            <div style="background: rgba(25, 25, 40, 0.9); border: 2px solid #00ff41; border-radius: 12px; padding: 20px; height: fit-content;">
                <h4 style="color: #00ff41; margin: 0 0 15px 0;">
                    <i class="fas fa-users"></i> 行家聯繫人
                </h4>
                
                <div style="display: grid; gap: 10px;">
                    <div style="background: rgba(0,255,65,0.15); padding: 12px; border-radius: 6px; cursor: pointer; border: 2px solid rgba(0,255,65,0.3); transition: all 0.3s;" onmouseover="this.style.borderColor='#00ff41'; this.style.background='rgba(0,255,65,0.25)'" onmouseout="this.style.borderColor='rgba(0,255,65,0.3)'; this.style.background='rgba(0,255,65,0.15)'">
                        <div style="color: #00ff41; font-weight: bold;">● Ghost_Zero</div>
                        <div style="color: #999; font-size: 0.85rem;">漏洞販售商</div>
                    </div>
                    <div style="background: rgba(188,19,254,0.15); padding: 12px; border-radius: 6px; cursor: pointer; border: 2px solid rgba(188,19,254,0.3); transition: all 0.3s;" onmouseover="this.style.borderColor='#bc13fe'; this.style.background='rgba(188,19,254,0.25)'" onmouseout="this.style.borderColor='rgba(188,19,254,0.3)'; this.style.background='rgba(188,19,254,0.15)'">
                        <div style="color: #bc13fe; font-weight: bold;">● Crypto_Queen</div>
                        <div style="color: #999; font-size: 0.85rem;">加密貨幣顧問</div>
                    </div>
                    <div style="background: rgba(255,100,100,0.15); padding: 12px; border-radius: 6px; cursor: pointer; border: 2px solid rgba(255,100,100,0.3); transition: all 0.3s;" onmouseover="this.style.borderColor='#ff6464'; this.style.background='rgba(255,100,100,0.25)'" onmouseout="this.style.borderColor='rgba(255,100,100,0.3)'; this.style.background='rgba(255,100,100,0.15)'">
                        <div style="color: #ff6464; font-weight: bold;">● Root_Access</div>
                        <div style="color: #999; font-size: 0.85rem;">入侵工具提供者</div>
                    </div>
                    <div style="background: rgba(255,200,0,0.15); padding: 12px; border-radius: 6px; cursor: pointer; border: 2px solid rgba(255,200,0,0.3); transition: all 0.3s;" onmouseover="this.style.borderColor='#ffc800'; this.style.background='rgba(255,200,0,0.25)'" onmouseout="this.style.borderColor='rgba(255,200,0,0.3)'; this.style.background='rgba(255,200,0,0.15)'">
                        <div style="color: #ffc800; font-weight: bold;">● Shadow_Net</div>
                        <div style="color: #999; font-size: 0.85rem;">情報掮客</div>
                    </div>
                </div>
            </div>
            
            <!-- 黑市交易市場 -->
            <div style="background: rgba(25, 25, 40, 0.9); border: 2px solid #bc13fe; border-radius: 12px; padding: 25px;">
                <h4 style="color: #bc13fe; margin: 0 0 20px 0;">
                    <i class="fas fa-store"></i> 黑市商品列表
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: rgba(188,19,254,0.1); border: 1px solid rgba(188,19,254,0.3); padding: 15px; border-radius: 6px;">
                        <div style="color: #bc13fe; font-weight: bold;">0Day 漏洞 (IE)</div>
                        <div style="color: #999; font-size: 0.85rem; margin: 8px 0;">未公開的 IE 引擎漏洞</div>
                        <div style="color: #ffff00; font-weight: bold;">¥ 50,000</div>
                        <button style="width: 100%; margin-top: 10px; padding: 8px; background: #bc13fe; border: none; color: #fff; border-radius: 4px; cursor: pointer;">購買</button>
                    </div>
                    
                    <div style="background: rgba(188,19,254,0.1); border: 1px solid rgba(188,19,254,0.3); padding: 15px; border-radius: 6px;">
                        <div style="color: #bc13fe; font-weight: bold;">勒索軟體變種</div>
                        <div style="color: #999; font-size: 0.85rem; margin: 8px 0;">定制化勒索軟體源代碼</div>
                        <div style="color: #ffff00; font-weight: bold;">¥ 35,000</div>
                        <button style="width: 100%; margin-top: 10px; padding: 8px; background: #bc13fe; border: none; color: #fff; border-radius: 4px; cursor: pointer;">購買</button>
                    </div>
                    
                    <div style="background: rgba(188,19,254,0.1); border: 1px solid rgba(188,19,254,0.3); padding: 15px; border-radius: 6px;">
                        <div style="color: #bc13fe; font-weight: bold;">銀行數據庫訪問</div>
                        <div style="color: #999; font-size: 0.85rem; margin: 8px 0;">東亞銀行弱口令 & RDP</div>
                        <div style="color: #ffff00; font-weight: bold;">¥ 25,000</div>
                        <button style="width: 100%; margin-top: 10px; padding: 8px; background: #bc13fe; border: none; color: #fff; border-radius: 4px; cursor: pointer;">購買</button>
                    </div>
                    
                    <div style="background: rgba(188,19,254,0.1); border: 1px solid rgba(188,19,254,0.3); padding: 15px; border-radius: 6px;">
                        <div style="color: #bc13fe; font-weight: bold;">C2 Command Server</div>
                        <div style="color: #999; font-size: 0.85rem; margin: 8px 0;">託管的指揮與控制伺服器</div>
                        <div style="color: #ffff00; font-weight: bold;">¥ 15,000/月</div>
                        <button style="width: 100%; margin-top: 10px; padding: 8px; background: #bc13fe; border: none; color: #fff; border-radius: 4px; cursor: pointer;">訂閱</button>
                    </div>
                    
                    <div style="background: rgba(188,19,254,0.1); border: 1px solid rgba(188,19,254,0.3); padding: 15px; border-radius: 6px;">
                        <div style="color: #bc13fe; font-weight: bold;">電話號碼數據庫</div>
                        <div style="color: #999; font-size: 0.85rem; margin: 8px 0;">全球 2.3 億個電話號碼</div>
                        <div style="color: #ffff00; font-weight: bold;">¥ 12,000</div>
                        <button style="width: 100%; margin-top: 10px; padding: 8px; background: #bc13fe; border: none; color: #fff; border-radius: 4px; cursor: pointer;">購買</button>
                    </div>
                    
                    <div style="background: rgba(188,19,254,0.1); border: 1px solid rgba(188,19,254,0.3); padding: 15px; border-radius: 6px;">
                        <div style="color: #bc13fe; font-weight: bold;">暗網代理服務</div>
                        <div style="color: #999; font-size: 0.85rem; margin: 8px 0;">高匿名 VPN & SOCKS5</div>
                        <div style="color: #ffff00; font-weight: bold;">¥ 500/月</div>
                        <button style="width: 100%; margin-top: 10px; padding: 8px; background: #bc13fe; border: none; color: #fff; border-radius: 4px; cursor: pointer;">訂閱</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 情報交易區 -->
        <div style="margin-top: 30px; background: rgba(25, 25, 40, 0.9); border: 2px solid #00ff41; border-radius: 12px; padding: 25px;">
            <h4 style="color: #00ff41; margin: 0 0 20px 0;">
                <i class="fas fa-envelope-open-text"></i> 情報交易與討論區
            </h4>
            
            <div style="display: grid; gap: 15px;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
                    <div style="color: #00ff41; font-weight: bold;">【求購】微軟 Exchange 伺服器 0Day</div>
                    <div style="color: #999; font-size: 0.9rem;">Ghost_Zero: 有 Exchange 遠端代碼執行漏洞嗎？願出高價。</div>
                    <div style="color: #666; font-size: 0.85rem;">8小時前</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
                    <div style="color: #00ff41; font-weight: bold;">【分享】新近發現的 Linux 內核漏洞利用</div>
                    <div style="color: #999; font-size: 0.9rem;">Root_Access: 剛發現一個 5.x 內核的本地提權漏洞，可實現完整系統控制。私聊進一步討論。</div>
                    <div style="color: #666; font-size: 0.85rem;">2小時前</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px;">
                    <div style="color: #00ff41; font-weight: bold;">【警告】FBI 加強執法行動，多個暗網市場被查封</div>
                    <div style="color: #999; font-size: 0.9rem;">Shadow_Net: 各位務必提高警惕，FBI 與國際警方的協作已升級。建議改用更安全的通信協議。</div>
                    <div style="color: #666; font-size: 0.85rem;">30分鐘前</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="le-center-page" class="page">
    <div class="container">
        <div class="section-header">
            <h2><i class="fas fa-shield-halved"></i> 執法指揮中心 • LE COMMAND CENTER</h2>
            <p>管理案件檔案、分析目標情報並協調跨部門行動。</p>
            <!-- 隱藏功能提示 -->
            <div class="hidden-hint" style="font-size: 0.75rem; color: rgba(74, 144, 217, 0.4); margin-top: 5px; cursor: help;" title="提示：嘗試在指揮中心按下 Ctrl+Shift+D 開啟開發調試輔助，或 Ctrl+Shift+E 啟動資源緊急調度儀。">
                <i class="fas fa-info-circle"></i> 系統提示：偵測到高級權限接口，可使用快捷鍵調用擴展工具。
            </div>
        </div>
        
        <div class="le-tabs">
            <button class="le-tab-btn active" onclick="switchLETab('cases')">案件資料</button>
            <button class="le-tab-btn" onclick="switchLETab('intel')">目標情報</button>
            <button class="le-tab-btn" onclick="switchLETab('collab')">跨部門協作</button>
            <button class="le-tab-btn" onclick="switchLETab('reports')">案件回報</button>
            <button class="le-tab-btn" onclick="switchLETab('tools')" style="border-color: #ffd700; color: #ffd700;"><i class="fas fa-plus-circle"></i> 擴展工具</button>
        </div>
        
        <!-- 5. 擴展工具面板 -->
        <div id="le-tab-tools" class="le-tab-content">
            <div class="le-grid">
                <div class="le-panel">
                    <div class="panel-title"><i class="fas fa-puzzle-piece"></i> 瀏覽器外掛整合工具</div>
                    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="node-action-btn" onclick="openMonitoringPanel()">監控面板</button>
                        <button class="node-action-btn" onclick="openBattleMonitor()">對戰監控</button>
                        <button class="node-action-btn" onclick="openForensicsLab()">鑑識實驗室</button>
                        <button class="node-action-btn" onclick="openNetworkAdvanced()">深度網路分析</button>
                    </div>
                    <div class="tool-card-mini">
                        <p>整合外部威脅情報庫與瀏覽器行為分析插件。</p>
                        <button class="node-action-btn" onclick="EXTRA_TOOLS.togglePlugin('threat_intel')">啟動情報插件</button>
                        <button class="node-action-btn" onclick="EXTRA_TOOLS.togglePlugin('behavior_analysis')">啟動行為分析</button>
                    </div>
                </div>
                <div class="le-panel">
                    <div class="panel-title"><i class="fas fa-bolt"></i> 資源緊急調度儀</div>
                    <div class="tool-card-mini">
                        <p>在緊急情況下強制調配跨部門資源，無視冷卻時間。</p>
                        <button class="node-action-btn danger" onclick="EXTRA_TOOLS.emergencyDispatch()">執行緊急調度</button>
                    </div>
                </div>
                <div class="le-panel">
                    <div class="panel-title"><i class="fas fa-microchip"></i> 開發與調試輔助</div>
                    <div class="tool-card-mini">
                        <p>訪問系統底層日誌，實時監控內存與網絡流量。</p>
                        <button class="node-action-btn" onclick="EXTRA_TOOLS.openDebugConsole()">開啟調試控制台</button>
                    </div>
                </div>
                <div class="le-panel">
                    <div class="panel-title"><i class="fas fa-chart-line"></i> 比較分析檢測版</div>
                    <div class="tool-card-mini">
                        <p>對比多個攻擊向量的特徵，精確定位黑客物理位置。</p>
                        <button class="node-action-btn" onclick="EXTRA_TOOLS.startComparativeAnalysis()">開始比較分析</button>
                    </div>
                </div>
                <div class="le-panel" style="border-color: #ff3e3e;">
                    <div class="panel-title" style="color: #ff3e3e;"><i class="fas fa-lock"></i> 緊急鎖定權限</div>
                    <div class="tool-card-mini">
                        <p>強制鎖定全網可疑設備，切斷黑客所有外部連接。</p>
                        <button id="lockdown-btn" class="node-action-btn danger" onclick="EXTRA_TOOLS.executeNetworkLockdown()">執行全網鎖定</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. 案件詳細資料 -->
        <div id="le-tab-cases" class="le-tab-content active">
            <div class="le-grid">
                <div class="le-panel">
                    <div class="panel-title">活躍案件清單</div>
                    <div id="case-list" class="le-list">
                        <!-- 動態生成 -->
                    </div>
                </div>
                <div class="le-panel">
                    <div class="panel-title">案件卷宗詳情</div>
                    <div id="case-dossier" class="dossier-content">
                        <p class="placeholder">請選擇案件以查看詳細卷宗</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. 目標情報 -->
        <div id="le-tab-intel" class="le-tab-content">
            <div class="intel-grid" id="target-intel-grid">
                <!-- 動態生成目標情報卡片 -->
            </div>
        </div>

        <!-- 3. 跨部門協作 -->
        <div id="le-tab-collab" class="le-tab-content">
            <div class="collab-container">
                <div class="collab-item">
                    <div class="collab-info">
                        <h4>網絡安全中心 (NCSC)</h4>
                        <p>提供實時威脅預警與防火牆加固支援。</p>
                        <div class="progress-bar-container"><div id="collab-ncsc-progress" class="progress-bar-fill" style="width: 30%"></div></div>
                    </div>
                    <button class="node-action-btn" onclick="LE_SYSTEM.advanceCollab('ncsc')">請求支援</button>
                </div>
                <div class="collab-item">
                    <div class="collab-info">
                        <h4>國際刑警 (INTERPOL)</h4>
                        <p>追蹤跨國黑客組織的物理位置與資金流向。</p>
                        <div class="progress-bar-container"><div id="collab-interpol-progress" class="progress-bar-fill" style="width: 15%"></div></div>
                    </div>
                    <button class="node-action-btn" onclick="LE_SYSTEM.advanceCollab('interpol')">請求支援</button>
                </div>
            </div>
        </div>

        <!-- 4. 案件詳細回報 -->
        <div id="le-tab-reports" class="le-tab-content">
            <div class="report-builder">
                <div class="report-form">
                    <div class="form-group">
                        <label>關聯案件</label>
                        <select id="report-case-select" class="config-input"></select>
                    </div>
                    <div class="form-group">
                        <label>關鍵證物</label>
                        <div id="report-evidence-tags" class="evidence-tags"></div>
                    </div>
                    <div class="form-group">
                        <label>行動總結</label>
                        <textarea id="report-summary" class="config-input" rows="5" placeholder="請輸入案件處置總結..."></textarea>
                    </div>
                    <button class="crack-btn" onclick="LE_SYSTEM.submitReport(document.getElementById('report-case-select').value, document.getElementById('report-summary').value, [], [])">提交正式回報</button>
                </div>
                <div class="report-preview">
                    <div class="panel-title">報告預覽</div>
                    <div id="report-preview-content" class="preview-paper">
                        <!-- 預覽內容 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="guide-page" class="page">
        <div class="guide-container">
            <div class="guide-header">
                <div class="guide-title">
                    <i class="fas fa-book"></i> 操作指南
                </div>
                <p style="color: #888; font-size: 0.95rem;">完整的遊戲操作說明和戰術指南</p>
            </div>

            <div class="guide-sections">
                <!-- 基礎操作 -->
                <div class="guide-section">
                    <div class="guide-section-title">
                        <i class="fas fa-keyboard"></i> 基礎操作
                    </div>
                    <div class="guide-section-content">
                        <div class="guide-step">
                            <div class="guide-step-title">1. 終端輸入</div>
                            在終端輸入框中輸入指令或工具名稱，按 Enter 執行。系統會自動識別並執行相應的操作。
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">2. 工具面板</div>
                            點擊工具面板中的工具卡片可快速執行該工具。每個工具都有冷卻時間，請合理安排使用。
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">3. 任務目標</div>
                            右側面板顯示當前任務目標。完成任務可獲得獎勵和進度提升。
                        </div>
                    </div>
                </div>

                <!-- 黑客角色指南 -->
                <div class="guide-section">
                    <div class="guide-section-title">
                        <i class="fas fa-user-secret"></i> 黑客角色指南
                    </div>
                    <div class="guide-section-content">
                        <div class="guide-step">
                            <div class="guide-step-title">主要目標</div>
                            滲透目標系統、竊取敏感數據、隱藏蹤跡。
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">核心工具</div>
                            Nmap（掃描）、Metasploit（利用）、Wireshark（監聽）、Log Cleaner（清除日誌）
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">戰術建議</div>
                            先進行網路掃描了解目標環境，然後尋找漏洞進行利用，最後清除痕跡以避免被追蹤。
                        </div>
                    </div>
                </div>

                <!-- 執法角色指南 -->
                <div class="guide-section">
                    <div class="guide-section-title">
                        <i class="fas fa-shield-alt"></i> 執法角色指南
                    </div>
                    <div class="guide-section-content">
                        <div class="guide-step">
                            <div class="guide-step-title">主要目標</div>
                            追蹤黑客、收集證據、鎖定身份、逮捕犯人。
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">核心工具</div>
                            IP 追蹤器、日誌分析、流量監控、身份識別系統
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">戰術建議</div>
                            監控網路流量發現異常，追蹤 IP 地址定位黑客，收集足夠證據進行起訴。
                        </div>
                    </div>
                </div>

                <!-- 資源管理 -->
                <div class="guide-section">
                    <div class="guide-section-title">
                        <i class="fas fa-coins"></i> 資源管理
                    </div>
                    <div class="guide-section-content">
                        <div class="guide-step">
                            <div class="guide-step-title">金錢系統</div>
                            通過完成任務和成功操作獲得金錢。金錢可用於購買工具和升級。
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">聲譽系統</div>
                            執行成功的操作會增加聲譽，聲譽高可解鎖更多工具和功能。
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">冷卻時間</div>
                            每個工具都有冷卻時間。使用後需要等待一段時間才能再次使用。
                        </div>
                    </div>
                </div>

                <!-- 戰況地圖 -->
                <div class="guide-section">
                    <div class="guide-section-title">
                        <i class="fas fa-map"></i> 戰況地圖
                    </div>
                    <div class="guide-section-content">
                        <div class="guide-step">
                            <div class="guide-step-title">網路拓撲</div>
                            實時顯示網路結構和設備連接情況。綠色節點為友方，紅色節點為敵方。
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">設備狀態</div>
                            查看各設備的實時狀態、資源使用情況和安全威脅等級。
                        </div>
                        <div class="guide-step">
                            <div class="guide-step-title">情報監控</div>
                            實時監控網路中的異常活動、攻擊路徑和數據流動。
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 50px;">
                <button class="btn back-btn" onclick="goToMainPage()">
                    <i class="fas fa-arrow-left"></i> 返回主頁
                </button>
            </div>
        </div>
    </div>

    <!-- 優化的商店頁面 -->
    <div id="shop-page" class="page">
        <div class="shop-container-full">
            <div class="shop-header">
                <div class="shop-title">
                    <i class="fas fa-shopping-cart"></i> 裝備商店
                </div>
                <p style="color: #888; font-size: 0.95rem;">購買高級工具和裝備以增強能力</p>
            </div>

            <div class="shop-categories-bar">
                <button class="category-btn active" onclick="filterShopItems('all')">全部商品</button>
                <button class="category-btn" onclick="filterShopItems('tools')">工具</button>
                <button class="category-btn" onclick="filterShopItems('upgrades')">升級</button>
                <button class="category-btn" onclick="filterShopItems('services')">服務</button>
                <button class="category-btn" onclick="filterShopItems('premium')">高級</button>
            </div>

            <div class="shop-items-display" id="shop-items-display">
                <!-- 商品將由 JavaScript 動態生成 -->
            </div>

            <div style="text-align: center; margin-top: 50px;">
                <button class="btn back-btn" onclick="goToMainPage()">
                    <i class="fas fa-arrow-left"></i> 返回主頁
                </button>
            </div>
        </div>
    </div>

    <script>
/* ===== 增強型模擬邏輯：網絡接入、延遲與穩定性 ===== */

const EnhancedSimulation = {
    // 模擬延遲數據 (ms)
    latencyProfiles: {
        'Clearnet': { min: 20, max: 80, jitter: 10 },
        'VPN': { min: 120, max: 250, jitter: 40 },
        'Tor': { min: 600, max: 1800, jitter: 300 },
        'I2P': { min: 800, max: 2500, jitter: 500 },
        'JumpNet': { min: 300, max: 900, jitter: 150 }
    },

    currentNetwork: 'Clearnet',
    isConnecting: false,

    // 獲取隨機延遲
    getLatency(networkType) {
        const profile = this.latencyProfiles[networkType] || this.latencyProfiles['Clearnet'];
        const base = Math.floor(Math.random() * (profile.max - profile.min)) + profile.min;
        const jitter = Math.floor(Math.random() * profile.jitter * 2) - profile.jitter;
        return Math.max(10, base + jitter);
    },

    // 模擬 Tor 接入邏輯
    async connectTor() {
        if (this.isConnecting) return;
        this.isConnecting = true;
        
        addTerminalLine('[系統] 正在初始化 Tor 網絡接入...', 'info');
        await this.sleep(800);
        
        addTerminalLine('[Tor] 正在請求目錄服務器 (Consensus)...', 'command');
        await this.sleep(1200);
        
        const nodes = ['Entry Node (DE)', 'Middle Relay (US)', 'Exit Node (NL)'];
        for (let i = 0; i < nodes.length; i++) {
            addTerminalLine(`[Tor] 正在建立電路層級 ${i+1}: ${nodes[i]}...`, 'info');
            await this.sleep(1000 + Math.random() * 1000);
            addTerminalLine(`[Tor] 層級 ${i+1} 加密握手完成。`, 'success');
        }
        
        this.currentNetwork = 'Tor';
        this.isConnecting = false;
        addTerminalLine('[成功] Tor 匿名電路已就緒。當前延遲: ' + this.getLatency('Tor') + 'ms', 'success');
        this.startStabilityMonitor();
        
        // 接入成功後打開暗網頁面
        setTimeout(() => {
            // 優先顯示暗網聯絡站頁面
            showPage('darknet-hub-page');
            GameState.currentPage = 'darknet';
            updateNavActive();
            // 同時彈出快捷操作的 Modal 以增強交互感
            if (typeof originalShowDarknetHub === 'function') {
                originalShowDarknetHub();
            }
        }, 1000);
    },

    // 模擬 I2P 接入邏輯
    async connectI2P() {
        if (this.isConnecting) return;
        this.isConnecting = true;
        
        addTerminalLine('[系統] 正在啟動 I2P 路由器...', 'info');
        await this.sleep(1000);
        
        addTerminalLine('[I2P] 正在集成到網絡數據庫 (NetDB)...', 'command');
        await this.sleep(1500);
        
        addTerminalLine('[I2P] 正在構建 Inbound 隧道 (4 躍點)...', 'info');
        await this.sleep(1200);
        addTerminalLine('[I2P] 正在構建 Outbound 隧道 (4 躍點)...', 'info');
        await this.sleep(1200);
        
        this.currentNetwork = 'I2P';
        this.isConnecting = false;
        addTerminalLine('[成功] I2P 大蒜路由已激活。當前延遲: ' + this.getLatency('I2P') + 'ms', 'success');
        this.startStabilityMonitor();
    },

    // 穩定性監控
    startStabilityMonitor() {
        if (this.stabilityInterval) clearInterval(this.stabilityInterval);
        
        this.stabilityInterval = setInterval(() => {
            const chance = Math.random();
            if (chance < 0.05) { // 5% 概率發生抖動
                const latency = this.getLatency(this.currentNetwork);
                addTerminalLine(`[警告] 網絡抖動檢測到。當前延遲飆升至: ${latency + 1000}ms`, 'warning');
            } else if (chance < 0.01) { // 1% 概率斷開
                addTerminalLine(`[錯誤] ${this.currentNetwork} 鏈路中斷。正在嘗試自動重連...`, 'error');
                this.reconnect();
            }
        }, 10000);
    },

    async reconnect() {
        const prev = this.currentNetwork;
        this.currentNetwork = 'Clearnet';
        if (prev === 'Tor') await this.connectTor();
        if (prev === 'I2P') await this.connectI2P();
    },

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    },

    // 特殊工具執行模擬
    executeSpecialTool(toolId) {
        switch(toolId) {
            case 'hardware_spoof':
                addTerminalLine('[系統] 正在請求 Ring 0 內核權限...', 'command');
                setTimeout(() => {
                    addTerminalLine('[硬體] 正在攔截 GetSystemInfo 調用...', 'info');
                    setTimeout(() => {
                        addTerminalLine('[成功] 硬體指紋已重寫。UUID: ' + Math.random().toString(36).substring(2, 15).toUpperCase(), 'success');
                    }, 1500);
                }, 1000);
                break;
            case 'memory_attack':
                addTerminalLine('[系統] 正在分配非分頁記憶體池...', 'command');
                setTimeout(() => {
                    addTerminalLine('[記憶體] 正在注入反射型 DLL (無檔案模式)...', 'info');
                    setTimeout(() => {
                        addTerminalLine('[成功] 惡意代碼已在 lsass.exe 記憶體空間運行，未觸發磁碟 IO。', 'success');
                    }, 2000);
                }, 1200);
                break;
            case 'zero_day':
                addTerminalLine('[系統] 正在加載未公開漏洞利用模組...', 'warning');
                setTimeout(() => {
                    addTerminalLine('[漏洞] 正在針對目標內核版本進行堆噴射 (Heap Spray)...', 'info');
                    setTimeout(() => {
                        addTerminalLine('[成功] 零日漏洞利用成功，已獲取系統級權限。', 'success');
                    }, 2500);
                }, 1500);
                break;
        }
    }
};

// 覆蓋原有的 openDarknetHub 函數
const originalOpenDarknetHub = openDarknetHub;
window.openDarknetHub = function() {
    if (EnhancedSimulation.currentNetwork === 'Clearnet') {
        const choice = confirm("檢測到您正通過明網訪問。是否啟動 Tor 匿名接入？\n(取消將以不安全模式進入)");
        if (choice) {
            EnhancedSimulation.connectTor();
            return;
        }
    }
    // 如果已經是 Tor/I2P 或用戶選擇不安全模式，直接顯示頁面
    showPage('darknet-hub-page');
    GameState.currentPage = 'darknet';
    updateNavActive();
};

// 同時覆蓋 showDarknetHub (快捷鍵觸發的)
const originalShowDarknetHub = showDarknetHub;
window.showDarknetHub = function() {
    if (EnhancedSimulation.currentNetwork === 'Clearnet') {
        const choice = confirm("檢測到您正通過明網訪問。是否啟動 Tor 匿名接入？\n(取消將以不安全模式進入)");
        if (choice) {
            EnhancedSimulation.connectTor();
            return;
        }
    }
    if (typeof originalShowDarknetHub === 'function') {
        originalShowDarknetHub();
    } else {
        // 如果原函數不存在，回退到顯示頁面
        showPage('darknet-hub-page');
        GameState.currentPage = 'darknet';
        updateNavActive();
    }
};

// Hook purchases to trigger any special tool behavior after ShopSystem handles the transaction
buyShopItem = function(itemId, price) {
    ShopSystem.buy(itemId, price);
    if (['hardware_spoof', 'memory_attack', 'zero_day'].includes(itemId) && window.EnhancedSimulation) {
        EnhancedSimulation.executeSpecialTool(itemId);
    }
};
    </script>

<script>

/**
 * 最終修復補丁：重寫核心邏輯以支持缺失的模擬功能
 */

(function() {
    // 1. 擴展 GameState
    if (typeof GameState !== 'undefined') {
        GameState.footprints = [];
        GameState.simulation = {
            counterMeasureActive: false,
            defenseActive: false,
            misjudgmentRisk: 0.08,
            vulnerabilityDetected: false,
            legalConstraints: true
        };
    }

    // 2. 痕跡殘留邏輯
    function leaveFootprint(actionType, location) {
        const role = GameState.currentRole;
        if (role !== 'hacker') return;
        
        const stealth = GameState.playerData.hacker.stealth;
        const clarity = Math.max(0, 100 - stealth);
        
        if (clarity > 15) {
            const footprint = {
                id: 'fp_' + Date.now(),
                type: actionType,
                location: location,
                timestamp: new Date().toLocaleTimeString(),
                clarity: clarity,
                evidenceValue: Math.floor(clarity / 10)
            };
            GameState.footprints.push(footprint);
            addTerminalLine(`[系統] 檢測到數位痕跡殘留 (清晰度: ${clarity}%)`, 'security');
        }
    }

    // 3. 重寫 implementToolEffect 以整合新邏輯
    const originalImplementToolEffect = window.implementToolEffect;
    window.implementToolEffect = function(toolId, toolData, playerData, opponentData) {
        const role = GameState.currentRole;
        
        // --- 黑客角色增強 ---
        if (role === 'hacker') {
            // 偵察工具：反制模擬
            if (toolData.effect === 'scan') {
                if (Math.random() < 0.3) {
                    addTerminalLine(`[警告] 目標部署了主動反制系統，正在嘗試反向追蹤！`, 'alert');
                    playerData.stealth = Math.max(0, playerData.stealth - 12);
                }
            }
            
            // 痕跡殘留
            leaveFootprint(toolData.effect, 'Target Node');
            
            // 攻擊工具：防禦模擬
            if (toolData.effect === 'attack') {
                if (Math.random() < 0.4) {
                    addTerminalLine(`[防禦] 目標防火牆已自動識別攻擊特徵，攔截率提升。`, 'warning');
                    // 減弱攻擊效果
                    if (toolId === 'data_wipe') opponentData.evidenceLibraryHealth += 5;
                    if (toolId === 'ransomware') opponentData.serverHealth += 10;
                }
            }
        }

        // --- 執法部門角色增強 ---
        if (role === 'law_enforcement') {
            // 調查工具：誤判模擬
            if (toolData.effect === 'investigate') {
                if (Math.random() < GameState.simulation.misjudgmentRisk) {
                    addTerminalLine(`[誤判] 證據分析出現偏差，指向了錯誤的嫌疑節點！`, 'warning');
                    playerData.investigationProgress = Math.max(0, playerData.investigationProgress - 5);
                    return; // 誤判導致本次調查無效
                }
            }

            // 追蹤工具：反制模擬
            if (toolData.effect === 'track') {
                if (Math.random() < 0.35) {
                    addTerminalLine(`[反制] 目標使用了多重跳板與流量混淆，追蹤信號丟失。`, 'danger');
                    playerData.identityLock.technical = Math.max(0, playerData.identityLock.technical - 8);
                    return;
                }
            }

            // 防禦工具：漏洞模擬
            if (toolData.effect === 'defend') {
                if (Math.random() < 0.2) {
                    addTerminalLine(`[漏洞] 警告：加固過程中發現一個未修補的零日漏洞！`, 'alert');
                    GameState.simulation.vulnerabilityDetected = true;
                }
            }

            // 協作工具：時效模擬
            if (toolData.effect === 'emergency_dispatch_effect') {
                addTerminalLine(`[時效] 請求已發出，等待跨部門審批響應...`, 'info');
                // 模擬延遲效果
                const originalProgress = playerData.investigationProgress;
                playerData.investigationProgress -= 20; // 先扣除，延遲後補回
                setTimeout(() => {
                    addTerminalLine(`[響應] 支援小組已就位，調查進度大幅提升。`, 'success');
                    playerData.investigationProgress += 40;
                    updateGameStats();
                }, 3000);
            }

            // 高階技能：程序約束
            if (toolId === 'global_net_sweep') {
                if (playerData.evidenceChain.length < 5) {
                    addTerminalLine(`[程序] 證據不足（需5項），法院拒絕簽發全網圍捕令。`, 'danger');
                    return;
                }
                addTerminalLine(`[程序] 法院授權已批准，啟動全網圍捕。`, 'success');
            }
        }

        // 調用原始邏輯
        if (originalImplementToolEffect) {
            originalImplementToolEffect(toolId, toolData, playerData, opponentData);
        }
        
        // 溯源邏輯觸發 (每當有痕跡時，執法部門有機會自動溯源)
        if (role === 'law_enforcement' && GameState.footprints.length > 0 && Math.random() < 0.2) {
            runTracebackLogic();
        }
    };

    // 4. 溯源邏輯實現
    window.runTracebackLogic = function() {
        if (GameState.footprints.length === 0) return;
        
        addTerminalLine(`[溯源] 啟動自動化溯源分析程序...`, 'info');
        
        let totalClarity = 0;
        GameState.footprints.forEach(fp => totalClarity += fp.clarity);
        
        const successProb = Math.min(0.8, totalClarity / 300); // 清晰度越高，成功率越高
        
        setTimeout(() => {
            if (Math.random() < successProb) {
                addTerminalLine(`[溯源] 成功！通過分析殘留痕跡，已鎖定黑客的真實 IP 段。`, 'success');
                GameState.playerData.law_enforcement.identityLock.technical += 20;
                // 清理已分析的痕跡
                GameState.footprints = [];
            } else {
                addTerminalLine(`[溯源] 失敗。痕跡過於模糊或已被清理。`, 'info');
            }
            updateGameStats();
        }, 1500);
    };

    console.log("Cyber Attack Simulation Patch Loaded Successfully.");
});

</script>

<!-- 雙方角色面板与儀表列最优化 (DEPRECATED - 已被新版本替换) -->
<script>
/*
 * 旧版本已禁用 - 請參考下面的修正版本
 */
if (false) {
/**
 * 雙方角色面板与儀表列最优化系統
 * 包含：黑客角色面板、执法部門角色面板、实时对比仪表
 */

(function() {
    // ===== 1. 雙方角色面板 CSS 样式 =====
    
    const dualRoleStyles = document.createElement('style');
    dualRoleStyles.textContent = `
        /* 雙方角色仪表板主容器 */
        .dual-role-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        /* 角色面板卡片 */
        .role-panel-card {
            background: linear-gradient(135deg, rgba(15, 25, 45, 0.95), rgba(10, 15, 30, 0.98));
            border: 2px solid;
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7), inset 0 0 25px rgba(74, 144, 217, 0.1);
            position: relative;
            overflow: hidden;
        }

        /* 黑客角色面板 */
        .role-panel-card.hacker-panel {
            border-color: #00ff41;
            background: linear-gradient(135deg, rgba(15, 35, 15, 0.95), rgba(10, 20, 10, 0.98));
        }

        .role-panel-card.hacker-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #00ff41, transparent);
            box-shadow: 0 0 15px #00ff41;
        }

        /* 执法部門面板 */
        .role-panel-card.le-panel {
            border-color: #4a90d9;
        }

        .role-panel-card.le-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #4a90d9, transparent);
            box-shadow: 0 0 15px #4a90d9;
        }

        /* 角色标题区 */
        .role-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .role-panel-title {
            font-size: 1.25rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hacker-panel .role-panel-title {
            color: #00ff41;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .le-panel .role-panel-title {
            color: #4a90d9;
            text-shadow: 0 0 10px rgba(74, 144, 217, 0.5);
        }

        .role-status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hacker-panel .role-status-badge {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
            border: 1px solid #00ff41;
        }

        .le-panel .role-status-badge {
            background: rgba(74, 144, 217, 0.2);
            color: #4a90d9;
            border: 1px solid #4a90d9;
        }

        /* 主要资源显示 */
        .primary-resource {
            background: rgba(0, 0, 0, 0.3);
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid;
        }

        .hacker-panel .primary-resource {
            border-left-color: #00ff41;
        }

        .le-panel .primary-resource {
            border-left-color: #4a90d9;
        }

        .resource-label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .resource-value {
            font-size: 1.4rem;
            font-weight: bold;
            font-family: 'Consolas', monospace;
        }

        .hacker-panel .resource-value {
            color: #00ff41;
        }

        .le-panel .resource-value {
            color: #4a90d9;
        }

        /* 统计网格 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid;
        }

        .hacker-panel .stat-box {
            border-left-color: #00ff41;
        }

        .le-panel .stat-box {
            border-left-color: #4a90d9;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: bold;
            font-family: 'Consolas', monospace;
        }

        .hacker-panel .stat-value {
            color: #00ff41;
        }

        .le-panel .stat-value {
            color: #4a90d9;
        }

        /* 进度条 */
        .stat-progress {
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 6px;
            overflow: hidden;
        }

        .stat-progress-fill {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }

        .hacker-panel .stat-progress-fill {
            background: linear-gradient(90deg, #00ff41, #008f11);
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.5);
        }

        .le-panel .stat-progress-fill {
            background: linear-gradient(90deg, #4a90d9, #6ab0ff);
            box-shadow: 0 0 8px rgba(74, 144, 217, 0.5);
        }

        /* 工具/技能列表 */
        .tools-section {
            margin-top: 16px;
            padding-top: 14px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tools-title {
            font-size: 0.85rem;
            font-weight: bold;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tools-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tool-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        .hacker-panel .tool-tag {
            border-color: rgba(0, 255, 65, 0.3);
        }

        .le-panel .tool-tag {
            border-color: rgba(74, 144, 217, 0.3);
        }

        /* 对比仪表板 */
        .comparison-dashboard {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(15, 25, 45, 0.95), rgba(10, 15, 30, 0.98));
            border: 1px solid rgba(74, 144, 217, 0.3);
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
        }

        .comparison-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4a90d9;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .comparison-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 14px;
            border-radius: 8px;
            border-left: 3px solid #4a90d9;
        }

        .comparison-label {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .comparison-values {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-hacker {
            text-align: center;
            flex: 1;
        }

        .comparison-hacker-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #00ff41;
        }

        .comparison-le {
            text-align: center;
            flex: 1;
        }

        .comparison-le-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .comparison-vs {
            text-align: center;
            flex: 0.5;
            color: #888;
            font-weight: bold;
        }

        /* 全寬卡片 */
        .dashboard-card-full {
            grid-column: 1 / -1;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .dual-role-dashboard {
                grid-template-columns: 1fr;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
    `;
    document.head.appendChild(dualRoleStyles);

    // ===== 2. 角色面板生成函数 =====

    window.generateDualRolePanels = function() {
        let container = document.getElementById('dual-role-dashboard-container');
        if (!container) {
            const gamePage = document.getElementById('game-page');
            if (!gamePage) return;
            
            container = document.createElement('div');
            container.id = 'dual-role-dashboard-container';
            container.className = 'dual-role-dashboard';
            gamePage.prepend(container);
        }

        if (!GameState || !GameState.gameActive) return;

        const currentRole = GameState.currentRole;
        const playerData = GameState.playerData[currentRole];
        const opponentData = GameState.opponentData[currentRole === 'hacker' ? 'law_enforcement' : 'hacker'];

        // 黑客角色面板
        const hackerPanel = document.createElement('div');
        hackerPanel.className = 'role-panel-card hacker-panel';
        hackerPanel.innerHTML = `
            <div class="role-panel-header">
                <div class="role-panel-title">
                    <i class="fas fa-user-secret"></i> 黑客终端
                </div>
                <div class="role-status-badge">
                    <span class="status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #00ff41; display: inline-block;"></span>
                    ${currentRole === 'hacker' ? '您' : '对手'}
                </div>
            </div>
            
            <div class="primary-resource">
                <div class="resource-label">暗网资金</div>
                <div class="resource-value">$${(currentRole === 'hacker' ? playerData.money : opponentData.money).toLocaleString()}</div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">隐资度</div>
                    <div class="stat-value">${(currentRole === 'hacker' ? playerData.stealth : opponentData.stealth)}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill" style="width: ${(currentRole === 'hacker' ? playerData.stealth : opponentData.stealth)}%"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">加密强度</div>
                    <div class="stat-value">${(currentRole === 'hacker' ? playerData.encryptionLevel : opponentData.encryptionLevel)}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill" style="width: ${(currentRole === 'hacker' ? playerData.encryptionLevel : opponentData.encryptionLevel)}%"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">控制进度</div>
                    <div class="stat-value">${(currentRole === 'hacker' ? playerData.controlProgress : 0)}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill" style="width: ${(currentRole === 'hacker' ? playerData.controlProgress : 0)}%"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">设备健康</div>
                    <div class="stat-value">${(currentRole === 'hacker' ? playerData.deviceHealth : opponentData.deviceHealth)}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill" style="width: ${(currentRole === 'hacker' ? playerData.deviceHealth : opponentData.deviceHealth)}%"></div>
                    </div>
                </div>
            </div>

            <div class="tools-section">
                <div class="tools-title">活躍工具</div>
                <div class="tools-list">
                    <span class="tool-tag">代理链</span>
                    <span class="tool-tag">日志清理</span>
                    <span class="tool-tag">流量偻装</span>
                    <span class="tool-tag">身份隐藏</span>
                </div>
            </div>
        `;

        // 执法部門角色面板
        const lePanel = document.createElement('div');
        lePanel.className = 'role-panel-card le-panel';
        lePanel.innerHTML = `
            <div class="role-panel-header">
                <div class="role-panel-title">
                    <i class="fas fa-shield-halved"></i> 执法指挥中心
                </div>
                <div class="role-status-badge">
                    <span class="status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #4a90d9; display: inline-block;"></span>
                    ${currentRole === 'law_enforcement' ? '您' : '对手'}
                </div>
            </div>
            
            <div class="primary-resource">
                <div class="resource-label">司法预算</div>
                <div class="resource-value">$${(currentRole === 'law_enforcement' ? playerData.budget : opponentData.budget).toLocaleString()}</div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">调查进度</div>
                    <div class="stat-value">${(currentRole === 'law_enforcement' ? playerData.investigationProgress : opponentData.investigationProgress)}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill" style="width: ${(currentRole === 'law_enforcement' ? playerData.investigationProgress : opponentData.investigationProgress)}%"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">身份锁定</div>
                    <div class="stat-value">${(currentRole === 'law_enforcement' ? playerData.identityLockProgress : opponentData.identityLockProgress)}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill" style="width: ${(currentRole === 'law_enforcement' ? playerData.identityLockProgress : opponentData.identityLockProgress)}%"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">系統健康</div>
                    <div class="stat-value">${(currentRole === 'law_enforcement' ? playerData.serverHealth : opponentData.serverHealth)}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill" style="width: ${(currentRole === 'law_enforcement' ? playerData.serverHealth : opponentData.serverHealth)}%"></div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">证据完整性</div>
                    <div class="stat-value">${(currentRole === 'law_enforcement' ? playerData.evidenceCount : opponentData.evidenceCount) * 20}%</div>
                    <div class="stat-progress">
                        <div class="stat-progress-fill" style="width: ${(currentRole === 'law_enforcement' ? playerData.evidenceCount : opponentData.evidenceCount) * 20}%"></div>
                    </div>
                </div>
            </div>

            <div class="tools-section">
                <div class="tools-title">部署工具</div>
                <div class="tools-list">
                    <span class="tool-tag">威胁检测</span>
                    <span class="tool-tag">追蹤信标</span>
                    <span class="tool-tag">防禦墣</span>
                    <span class="tool-tag">鉴識套件</span>
                </div>
            </div>
        `;

        // 对比仪表板
        const comparisonDashboard = document.createElement('div');
        comparisonDashboard.className = 'comparison-dashboard';
        comparisonDashboard.innerHTML = `
            <div class="comparison-title">
                <i class="fas fa-chart-bar"></i> 实时对比分析
            </div>
            <div class="comparison-grid">
                <div class="comparison-item">
                    <div class="comparison-label">隐资 vs 调查</div>
                    <div class="comparison-values">
                        <div class="comparison-hacker">
                            <div class="comparison-hacker-value">${(currentRole === 'hacker' ? playerData.stealth : opponentData.stealth)}%</div>
                            <div style="font-size: 0.7rem; color: #888;">隐资度</div>
                        </div>
                        <div class="comparison-vs">VS</div>
                        <div class="comparison-le">
                            <div class="comparison-le-value">${(currentRole === 'law_enforcement' ? playerData.investigationProgress : opponentData.investigationProgress)}%</div>
                            <div style="font-size: 0.7rem; color: #888;">调查进度</div>
                        </div>
                    </div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-label">攻击 vs 防禦</div>
                    <div class="comparison-values">
                        <div class="comparison-hacker">
                            <div class="comparison-hacker-value">${(currentRole === 'hacker' ? playerData.attackPower : opponentData.attackPower)}</div>
                            <div style="font-size: 0.7rem; color: #888;">攻击力</div>
                        </div>
                        <div class="comparison-vs">VS</div>
                        <div class="comparison-le">
                            <div class="comparison-le-value">${(currentRole === 'law_enforcement' ? playerData.defensePower : opponentData.defensePower)}</div>
                            <div style="font-size: 0.7rem; color: #888;">防禦力</div>
                        </div>
                    </div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-label">资源对比</div>
                    <div class="comparison-values">
                        <div class="comparison-hacker">
                            <div class="comparison-hacker-value">$${((currentRole === 'hacker' ? playerData.money : opponentData.money) / 1000).toFixed(0)}K</div>
                            <div style="font-size: 0.7rem; color: #888;">资金</div>
                        </div>
                        <div class="comparison-vs">VS</div>
                        <div class="comparison-le">
                            <div class="comparison-le-value">$${((currentRole === 'law_enforcement' ? playerData.budget : opponentData.budget) / 1000).toFixed(0)}K</div>
                            <div style="font-size: 0.7rem; color: #888;">预算</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 清空并重新填充容器
        container.innerHTML = '';
        container.appendChild(hackerPanel);
        container.appendChild(lePanel);
        container.appendChild(comparisonDashboard);
    };

    // ===== 3. 遊戲循環集成 =====

    const originalUpdateGameStats = window.updateGameStats;
    window.updateGameStats = function() {
        if (originalUpdateGameStats) originalUpdateGameStats();
        
        // 在遊戲进行时更新雙方面板
        if (GameState && GameState.gameActive) {
            window.generateDualRolePanels();
        }
    };

    // 初始执行
    setTimeout(() => {
        if (GameState && GameState.gameActive) {
            window.generateDualRolePanels();
        }
    }, 1500);

})();
}
</script>

<!-- 修正版本：角色面板去重複且頂部狀態欄優化 -->
<script>
/**
 * 生成頂部狀態欄
 */
function generateTopStatusBar() {
    // ===== 1. 頂部狀態欄 CSS =====
    
    const topStatusStyles = document.createElement('style');
    topStatusStyles.textContent = `
        /* 頂部狀態欄 */
        .top-status-bar {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            height: 45px;
            background: linear-gradient(90deg, rgba(10, 10, 25, 0.98), rgba(15, 15, 35, 0.98));
            border-bottom: 2px solid #4a90d9;
            display: flex;
            align-items: center;
            padding: 0 30px;
            z-index: 95;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            gap: 40px;
        }

        .status-section {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
        }

        .status-label {
            color: #888;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            color: #4a90d9;
            font-weight: bold;
            font-family: 'Consolas', monospace;
        }

        .status-indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff41;
            box-shadow: 0 0 8px #00ff41;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .status-divider {
            width: 1px;
            height: 20px;
            background: rgba(74, 144, 217, 0.3);
        }

        /* 調整遊戲頁面頂部邊距 */
        #game-page {
            margin-top: 45px;
        }
    `;

    document.head.appendChild(topStatusStyles);

    // ===== 2. 頂部狀態欄生成函數 =====

    window.generateTopStatusBar = function() {
        // 检查是否已存在
        if (document.getElementById('top-status-bar')) return;

        const statusBar = document.createElement('div');
        statusBar.id = 'top-status-bar';
        statusBar.className = 'top-status-bar';

        const gameMode = GameState.gameMode === 'season2' ? '對戰模式第二季' : '對戰模式';
        const connectionStatus = GameState.connectionStatus === 'connected' ? '已連接' : '連接中';
        const currentRole = GameState.currentRole === 'hacker' ? '黑客' : '執法部門';

        statusBar.innerHTML = `
            <div class="status-section">
                <span class="status-indicator-dot"></span>
                <span class="status-label">遊戲模式</span>
                <span class="status-value">${gameMode}</span>
            </div>
            <div class="status-divider"></div>
            <div class="status-section">
                <span class="status-label">連接狀態</span>
                <span class="status-value">${connectionStatus}</span>
            </div>
            <div class="status-divider"></div>
            <div class="status-section">
                <span class="status-label">當前角色</span>
                <span class="status-value">${currentRole}</span>
            </div>
            <div class="status-divider"></div>
            <div class="status-section">
                <span class="status-label">遊戲時間</span>
                <span class="status-value" id="game-timer">25:00</span>
            </div>
        `;

        // 插入到導航欄下方
        const nav = document.querySelector('nav');
        if (nav) {
            nav.insertAdjacentElement('afterend', statusBar);
        } else {
            document.body.insertBefore(statusBar, document.body.firstChild);
        }
    };

    // ===== 3. 修正角色面板去重複邏輯 =====

    window.generateOptimizedRolePanels = function() {
        // 移除旧的面板容器（如果存在）
        const oldContainer = document.getElementById('dual-role-dashboard-container');
        if (oldContainer) {
            oldContainer.remove();
        }

        const gamePage = document.getElementById('game-page');
        if (!gamePage || !GameState || !GameState.gameActive) return;

        // 創建新容器
        const container = document.createElement('div');
        container.id = 'dual-role-dashboard-container';
        container.className = 'dual-role-dashboard';
        gamePage.prepend(container);

        const currentRole = GameState.currentRole;
        const playerData = GameState.playerData[currentRole];
        const opponentData = GameState.opponentData[currentRole === 'hacker' ? 'law_enforcement' : 'hacker'];

        // 僅顯示當前玩家的角色面板
        let panelHTML = '';

        if (currentRole === 'hacker') {
            panelHTML = `
                <div class="role-panel-card hacker-panel">
                    <div class="role-panel-header">
                        <div class="role-panel-title">
                            <i class="fas fa-user-secret"></i> 黑客終端 (您)
                        </div>
                        <div class="role-status-badge">
                            <span class="status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #00ff41; display: inline-block;"></span>
                            主控端
                        </div>
                    </div>
                    
                    <div class="primary-resource">
                        <div class="resource-label">暗網資金</div>
                        <div class="resource-value">$${playerData.money.toLocaleString()}</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">隱蔕度</div>
                            <div class="stat-value">${playerData.stealth}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${playerData.stealth}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">加密強度</div>
                            <div class="stat-value">${playerData.encryptionLevel}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${playerData.encryptionLevel}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">控制進度</div>
                            <div class="stat-value">${playerData.controlProgress}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${playerData.controlProgress}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">設備健康</div>
                            <div class="stat-value">${playerData.deviceHealth}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${playerData.deviceHealth}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tools-section">
                        <div class="tools-title">活躍工具</div>
                        <div class="tools-list">
                            <span class="tool-tag">代理鏈</span>
                            <span class="tool-tag">日誌清理</span>
                            <span class="tool-tag">流量偻装</span>
                            <span class="tool-tag">身份隱藏</span>
                        </div>
                    </div>
                </div>

                <div class="role-panel-card le-panel">
                    <div class="role-panel-header">
                        <div class="role-panel-title">
                            <i class="fas fa-shield-halved"></i> 執法指揮中心 (對手)
                        </div>
                        <div class="role-status-badge">
                            <span class="status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #4a90d9; display: inline-block;"></span>
                            追蹤中
                        </div>
                    </div>
                    
                    <div class="primary-resource">
                        <div class="resource-label">司法預算</div>
                        <div class="resource-value">$${opponentData.budget.toLocaleString()}</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">調查進度</div>
                            <div class="stat-value">${opponentData.investigationProgress}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${opponentData.investigationProgress}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">身份鎖定</div>
                            <div class="stat-value">${opponentData.identityLockProgress}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${opponentData.identityLockProgress}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">系統健康</div>
                            <div class="stat-value">${opponentData.serverHealth}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${opponentData.serverHealth}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">威脅評估</div>
                            <div class="stat-value">${opponentData.aggressionLevel}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${opponentData.aggressionLevel}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tools-section">
                        <div class="tools-title">部署工具</div>
                        <div class="tools-list">
                            <span class="tool-tag">威脅検測</span>
                            <span class="tool-tag">追蹤信標</span>
                            <span class="tool-tag">防禦墣</span>
                            <span class="tool-tag">鉴識套件</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // 執法部門視圖
            panelHTML = `
                <div class="role-panel-card le-panel">
                    <div class="role-panel-header">
                        <div class="role-panel-title">
                            <i class="fas fa-shield-halved"></i> 執法指揮中心 (您)
                        </div>
                        <div class="role-status-badge">
                            <span class="status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #4a90d9; display: inline-block;"></span>
                            主控端
                        </div>
                    </div>
                    
                    <div class="primary-resource">
                        <div class="resource-label">司法預算</div>
                        <div class="resource-value">$${playerData.budget.toLocaleString()}</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">調查進度</div>
                            <div class="stat-value">${playerData.investigationProgress}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${playerData.investigationProgress}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">身份鎖定</div>
                            <div class="stat-value">${playerData.identityLockProgress}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${playerData.identityLockProgress}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">系統健康</div>
                            <div class="stat-value">${playerData.serverHealth}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${playerData.serverHealth}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">證據完整性</div>
                            <div class="stat-value">${playerData.evidenceCount * 20}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${playerData.evidenceCount * 20}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tools-section">
                        <div class="tools-title">部署工具</div>
                        <div class="tools-list">
                            <span class="tool-tag">威脅検測</span>
                            <span class="tool-tag">追蹤信標</span>
                            <span class="tool-tag">防禦墣</span>
                            <span class="tool-tag">鉴識套件</span>
                        </div>
                    </div>
                </div>

                <div class="role-panel-card hacker-panel">
                    <div class="role-panel-header">
                        <div class="role-panel-title">
                            <i class="fas fa-user-secret"></i> 黑客終端 (對手)
                        </div>
                        <div class="role-status-badge">
                            <span class="status-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: #00ff41; display: inline-block;"></span>
                            監控中
                        </div>
                    </div>
                    
                    <div class="primary-resource">
                        <div class="resource-label">暗網資金</div>
                        <div class="resource-value">$${opponentData.money.toLocaleString()}</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">隱蔕度</div>
                            <div class="stat-value">${opponentData.stealth}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${opponentData.stealth}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">加密強度</div>
                            <div class="stat-value">${opponentData.encryptionLevel}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${opponentData.encryptionLevel}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">威脅等級</div>
                            <div class="stat-value">${opponentData.defenseLevel}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${opponentData.defenseLevel}%"></div>
                            </div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">設備健康</div>
                            <div class="stat-value">${opponentData.deviceHealth}%</div>
                            <div class="stat-progress">
                                <div class="stat-progress-fill" style="width: ${opponentData.deviceHealth}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tools-section">
                        <div class="tools-title">活躍工具</div>
                        <div class="tools-list">
                            <span class="tool-tag">代理鏈</span>
                            <span class="tool-tag">日誌清理</span>
                            <span class="tool-tag">流量偻装</span>
                            <span class="tool-tag">身份隱藏</span>
                        </div>
                    </div>
                </div>
            `;
        }

        container.innerHTML = panelHTML;
    };

    // ===== 4. 遊戲循環集成 =====

    const originalUpdateGameStats = window.updateGameStats;
    window.updateGameStats = function() {
        if (originalUpdateGameStats) originalUpdateGameStats();
        
        // 在遊戲進行時更新面板
        if (GameState && GameState.gameActive) {
            window.generateOptimizedRolePanels();
            window.generateTopStatusBar();
        }
    };

    // 初始执行
    setTimeout(() => {
        if (GameState && GameState.gameActive) {
            window.generateOptimizedRolePanels();
            window.generateTopStatusBar();
        }
    }, 1500);


<!-- 執法部門專業儀表分析系統 -->



(function() {
    // ===== 1. 核心數據結構 =====
    
    window.LEDashboardData = {
        // 核心證據庫
        evidenceVault: [
            { 
                id: 'EV-2026-0001', 
                name: 'IP 訪問日誌', 
                type: '網路痕跡',
                category: '網路取證',
                status: 'verified', 
                collectionTime: '2026-01-11 14:20:35',
                detail: '來源 IP: 103.24.201.15 (Tor 出口節點 - 荷蘭)',
                md5: 'a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6',
                sha256: 'abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789',
                integrity: 100,
                legalValidity: '強',
                chainOfCustody: ['採集', '驗證', '存檔'],
                riskLevel: 'HIGH'
            },
            { 
                id: 'EV-2026-0002', 
                name: '惡意代碼樣本', 
                type: '二進制文件',
                category: '惡意軟體分析',
                status: 'verified', 
                collectionTime: '2026-01-11 14:35:12',
                detail: '檢測到反射型 DLL 注入特徵，簽名匹配已知 APT 組織',
                md5: 'f6e5d4c3b2a1z9y8x7w6v5u4t3s2r1q0',
                sha256: 'zyxwvutsrqponmlkjihgfedcbazyxwvutsrqponmlkjihgfedcbazyxwvutsr',
                integrity: 95,
                legalValidity: '強',
                chainOfCustody: ['採集', '隔離', '驗證', '分析'],
                riskLevel: 'CRITICAL'
            },
            { 
                id: 'EV-2026-0003', 
                name: '加密通訊片段', 
                type: '攔截數據',
                category: '通訊監控',
                status: 'processing', 
                collectionTime: '2026-01-11 14:50:48',
                detail: '正在嘗試暴力破解 AES-256 密鑰，預計完成時間 2.5 小時',
                md5: 'pending_decryption',
                sha256: 'pending_decryption',
                integrity: 80,
                legalValidity: '中等',
                chainOfCustody: ['攔截', '驗證', '解密中'],
                riskLevel: 'MEDIUM'
            },
            { 
                id: 'EV-2026-0004', 
                name: '物理位置信號', 
                type: '地理定位',
                category: '物理追蹤',
                status: 'processing', 
                collectionTime: '2026-01-11 15:05:20',
                detail: '信號在東南亞多個基站間跳轉，最後定位於新加坡',
                md5: 'gps_triangulation_001',
                sha256: 'gps_triangulation_hash_001',
                integrity: 60,
                legalValidity: '弱',
                chainOfCustody: ['定位', '驗證中'],
                riskLevel: 'MEDIUM'
            },
            { 
                id: 'EV-2026-0005', 
                name: '銀行交易記錄', 
                type: '金融數據',
                category: '資金追蹤',
                status: 'verified', 
                collectionTime: '2026-01-11 15:15:00',
                detail: '追蹤到 5 筆可疑轉帳，總金額 $250,000 USD',
                md5: 'bank_records_hash_001',
                sha256: 'bank_records_sha256_001',
                integrity: 98,
                legalValidity: '強',
                chainOfCustody: ['銀行提供', '驗證', '存檔'],
                riskLevel: 'HIGH'
            }
        ],

        // 指揮中心狀態
        commandCenter: {
            systemHealth: 95,
            threatLevel: 'HIGH',
            operationalStatus: 'ACTIVE',
            resources: {
                cpuUsage: 45,
                memoryUsage: 62,
                networkBandwidth: 78,
                storageUsage: 55
            },
            activeOperations: 3,
            onDutyPersonnel: 24,
            alertsActive: 7,
            criticalIncidents: 2
        },

        // 跨部門協調
        interAgencyCoordination: [
            {
                id: 'DEPT-001',
                name: '數位鑑識科 (Digital Forensics Division)',
                status: 'ACTIVE',
                resourceAllocation: 85,
                tasksAssigned: 12,
                tasksCompleted: 8,
                efficiency: 92,
                lastUpdate: '2026-01-11 15:20:00',
                specialization: ['惡意軟體分析', '數據恢復', '密碼破解']
            },
            {
                id: 'DEPT-002',
                name: '網絡特警隊 (Cyber SWAT Team)',
                status: 'ACTIVE',
                resourceAllocation: 95,
                tasksAssigned: 8,
                tasksCompleted: 6,
                efficiency: 88,
                lastUpdate: '2026-01-11 15:18:00',
                specialization: ['即時反應', '入侵檢測', '系統防禦']
            },
            {
                id: 'DEPT-003',
                name: '國際刑警聯絡 (Interpol Liaison)',
                status: 'STANDBY',
                resourceAllocation: 40,
                tasksAssigned: 3,
                tasksCompleted: 2,
                efficiency: 85,
                lastUpdate: '2026-01-11 15:10:00',
                specialization: ['國際追蹤', '跨境協調', '情報共享']
            },
            {
                id: 'DEPT-004',
                name: '情報分析中心 (Intelligence Analysis Center)',
                status: 'ACTIVE',
                resourceAllocation: 70,
                tasksAssigned: 15,
                tasksCompleted: 10,
                efficiency: 90,
                lastUpdate: '2026-01-11 15:22:00',
                specialization: ['威脅評估', '行為分析', '預測建模']
            }
        ],

        // 內部伺服器監控
        internalServers: [
            {
                id: 'SRV-001',
                name: '證據存儲伺服器 (Evidence Storage Server)',
                ipAddress: '192.168.100.10',
                status: 'ONLINE',
                uptime: '99.8%',
                cpuUsage: 35,
                memoryUsage: 58,
                diskUsage: 72,
                networkLatency: 2.3,
                inboundTraffic: 245,
                outboundTraffic: 180,
                idsAlerts: 0,
                firewallBlocked: 0,
                lastBackup: '2026-01-11 03:00:00'
            },
            {
                id: 'SRV-002',
                name: '指揮中心主伺服器 (Command Center Master)',
                ipAddress: '192.168.100.20',
                status: 'ONLINE',
                uptime: '99.95%',
                cpuUsage: 52,
                memoryUsage: 71,
                diskUsage: 45,
                networkLatency: 1.8,
                inboundTraffic: 512,
                outboundTraffic: 380,
                idsAlerts: 2,
                firewallBlocked: 5,
                lastBackup: '2026-01-11 02:30:00'
            },
            {
                id: 'SRV-003',
                name: '分析工作站集群 (Analysis Workstation Cluster)',
                ipAddress: '192.168.100.30-50',
                status: 'ONLINE',
                uptime: '98.5%',
                cpuUsage: 78,
                memoryUsage: 85,
                diskUsage: 62,
                networkLatency: 3.5,
                inboundTraffic: 1024,
                outboundTraffic: 890,
                idsAlerts: 8,
                firewallBlocked: 12,
                lastBackup: '2026-01-11 04:00:00'
            },
            {
                id: 'SRV-004',
                name: '備份與恢復伺服器 (Backup & Recovery)',
                ipAddress: '192.168.100.60',
                status: 'ONLINE',
                uptime: '99.99%',
                cpuUsage: 15,
                memoryUsage: 28,
                diskUsage: 88,
                networkLatency: 2.1,
                inboundTraffic: 128,
                outboundTraffic: 256,
                idsAlerts: 0,
                firewallBlocked: 0,
                lastBackup: '2026-01-11 05:00:00'
            }
        ]
    
        };
    // ===== 2. CSS 樣式注入 =====

    const styleElement = document.createElement('style');
    styleElement.textContent = `
        /* 主容器 */
        .le-professional-dashboard {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* 卡片基礎樣式 */
        .dashboard-card {
            background: linear-gradient(145deg, rgba(15, 25, 45, 0.95), rgba(10, 15, 30, 0.98));
            border: 1px solid rgba(74, 144, 217, 0.4);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(74, 144, 217, 0.08);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, #4a90d9, transparent);
        }

        /* 卡片標題 */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(74, 144, 217, 0.2);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4a90d9;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(74, 144, 217, 0.2);
            color: #4a90d9;
            border: 1px solid #4a90d9;
        }

        /* 狀態指示器 */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        .status-online { background: #00ff41; box-shadow: 0 0 10px #00ff41; }
        .status-standby { background: #ff9900; box-shadow: 0 0 10px #ff9900; }
        .status-offline { background: #ff4444; box-shadow: 0 0 10px #ff4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* 進度條 */
        .progress-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #6ab0ff);
            transition: width 0.5s ease-in-out;
            box-shadow: 0 0 8px rgba(74, 144, 217, 0.6);
        }

        .progress-value {
            font-size: 0.75rem;
            color: #888;
            min-width: 30px;
            text-align: right;
        }

        /* 證據庫表格 */
        .evidence-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .evidence-table th {
            text-align: left;
            padding: 8px 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #888;
            font-weight: normal;
            border-bottom: 1px solid rgba(74, 144, 217, 0.2);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .evidence-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .evidence-row:hover {
            background: rgba(74, 144, 217, 0.08);
        }

        .evidence-id {
            color: #4a90d9;
            font-weight: bold;
            font-family: 'Consolas', monospace;
        }

        .evidence-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-verified { background: rgba(0, 255, 65, 0.2); color: #00ff41; border: 1px solid #00ff41; }
        .status-processing { background: rgba(255, 153, 0, 0.2); color: #ff9900; border: 1px solid #ff9900; }
        .status-corrupted { background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid #ff4444; }

        /* 部門協調表 */
        .department-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            margin-bottom: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            border-left: 3px solid #4a90d9;
        }

        .dept-info {
            font-size: 0.85rem;
        }

        .dept-name {
            font-weight: bold;
            color: #4a90d9;
            margin-bottom: 4px;
        }

        .dept-status {
            font-size: 0.75rem;
            color: #888;
        }

        /* 伺服器監控 */
        .server-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #4a90d9;
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .server-name {
            font-weight: bold;
            color: #4a90d9;
            font-size: 0.9rem;
        }

        .server-ip {
            font-size: 0.75rem;
            color: #888;
            font-family: 'Consolas', monospace;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .metric-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 6px;
            border-radius: 4px;
            text-align: center;
        }

        .metric-label {
            font-size: 0.65rem;
            color: #888;
            margin-bottom: 2px;
        }

        .metric-value {
            font-size: 0.9rem;
            font-weight: bold;
            color: #4a90d9;
        }

        /* 警告和危險指示 */
        .alert-high { color: #ff4444; }
        .alert-medium { color: #ff9900; }
        .alert-low { color: #00ff41; }

        /* 全寬卡片 */
        .dashboard-card-full {
            grid-column: 1 / -1;
        }

        /* 響應式設計 */
        @media (max-width: 1400px) {
            .le-professional-dashboard {
                grid-template-columns: 1fr;
            }
        }
    `
    document.head.appendChild(styleElement);

    // ===== 3. UI 生成函數 =====

    window.generateLEDashboard = function() {
        let container = document.getElementById('le-professional-dashboard');
        if (!container) {
            const gamePage = document.getElementById('game-page');
            if (!gamePage) return;
            
            container = document.createElement('div');
            container.id = 'le-professional-dashboard';
            container.className = 'le-professional-dashboard';
            gamePage.appendChild(container);
        }

        const data = window.LEDashboardData;

        // 1. 證據庫卡片
        const evidenceCard = document.createElement('div');
        evidenceCard.className = 'dashboard-card';
        evidenceCard.innerHTML = `
            <div class="card-header">
                <div class="card-title"><i class="fas fa-database"></i> 核心證據庫</div>
                <div class="card-badge">已驗證: ${data.evidenceVault.filter(e => e.status === 'verified').length}/${data.evidenceVault.length}</div>
            </div>
            <table class="evidence-table">
                <thead>
                    <tr>
                        <th>編號</th>
                        <th>名稱</th>
                        <th>狀態</th>
                        <th>完整性</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.evidenceVault.map(ev => `
                        <tr class="evidence-row" title="${ev.detail}">
                            <td><span class="evidence-id">${ev.id}</span></td>
                            <td>${ev.name}</td>
                            <td><span class="evidence-status status-${ev.status}">${ev.status === 'verified' ? '已驗證' : '處理中'}</span></td>
                            <td>
                                <div class="progress-bar-wrapper">
                                    <div class="progress-bar"><div class="progress-fill" style="width: ${ev.integrity}%"></div></div>
                                    <div class="progress-value">${ev.integrity}%</div>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        // 2. 指揮中心卡片
        const commandCard = document.createElement('div');
        commandCard.className = 'dashboard-card';
        commandCard.innerHTML = `
            <div class="card-header">
                <div class="card-title"><i class="fas fa-tower-broadcast"></i> 指揮中心</div>
                <div class="card-badge"><span class="status-indicator status-online"></span> ${data.commandCenter.operationalStatus}</div>
            </div>
            <div style="font-size: 0.85rem; line-height: 1.8;">
                <div style="margin-bottom: 10px;">
                    <div style="color: #888; font-size: 0.75rem; margin-bottom: 2px;">系統健康度</div>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar"><div class="progress-fill" style="width: ${data.commandCenter.systemHealth}%"></div></div>
                        <div class="progress-value">${data.commandCenter.systemHealth}%</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">威脅等級</div>
                        <div class="alert-high" style="font-weight: bold;">${data.commandCenter.threatLevel}</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">活躍警報</div>
                        <div style="color: #ff9900; font-weight: bold;">${data.commandCenter.alertsActive}</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">當值人員</div>
                        <div style="color: #4a90d9; font-weight: bold;">${data.commandCenter.onDutyPersonnel}</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.75rem;">關鍵事件</div>
                        <div class="alert-high" style="font-weight: bold;">${data.commandCenter.criticalIncidents}</div>
                    </div>
                </div>
            </div>
        `;

        // 3. 跨部門協調卡片
        const coordCard = document.createElement('div');
        coordCard.className = 'dashboard-card dashboard-card-full';
        coordCard.innerHTML = `
            <div class="card-header">
                <div class="card-title"><i class="fas fa-handshake"></i> 跨部門協調中心</div>
                <div class="card-badge">活躍部門: ${data.interAgencyCoordination.filter(d => d.status === 'ACTIVE').length}</div>
            </div>
            <div>
                ${data.interAgencyCoordination.map(dept => `
                    <div class="department-row">
                        <div class="dept-info">
                            <div class="dept-name">${dept.name}</div>
                            <div class="dept-status"><span class="status-indicator status-${dept.status === 'ACTIVE' ? 'online' : 'standby'}"></span> ${dept.status}</div>
                        </div>
                        <div class="dept-info">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 2px;">資源分配</div>
                            <div class="progress-bar-wrapper">
                                <div class="progress-bar"><div class="progress-fill" style="width: ${dept.resourceAllocation}%"></div></div>
                                <div class="progress-value">${dept.resourceAllocation}%</div>
                            </div>
                        </div>
                        <div class="dept-info">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 2px;">任務進度</div>
                            <div style="font-size: 0.9rem; color: #4a90d9;"><strong>${dept.tasksCompleted}/${dept.tasksAssigned}</strong></div>
                        </div>
                        <div class="dept-info">
                            <div style="color: #888; font-size: 0.75rem; margin-bottom: 2px;">效率評分</div>
                            <div style="font-size: 0.9rem; color: #00ff41;"><strong>${dept.efficiency}%</strong></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // 4. 內部伺服器監控卡片
        const serverCard = document.createElement('div');
        serverCard.className = 'dashboard-card dashboard-card-full';
        serverCard.innerHTML = `
            <div class="card-header">
                <div class="card-title"><i class="fas fa-server"></i> 內部伺服器監控</div>
                <div class="card-badge">在線: ${data.internalServers.filter(s => s.status === 'ONLINE').length}/${data.internalServers.length}</div>
            </div>
            <div>
                ${data.internalServers.map(srv => `
                    <div class="server-item">
                        <div class="server-header">
                            <div>
                                <div class="server-name"><span class="status-indicator status-${srv.status === 'ONLINE' ? 'online' : 'offline'}"></span> ${srv.name}</div>
                                <div class="server-ip">${srv.ipAddress}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #888; font-size: 0.75rem; margin-bottom: 2px;">運行時間</div>
                                <div style="color: #4a90d9; font-weight: bold;">${srv.uptime}</div>
                            </div>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-label">CPU</div>
                                <div class="metric-value">${srv.cpuUsage}%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">記憶體</div>
                                <div class="metric-value">${srv.memoryUsage}%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">磁碟</div>
                                <div class="metric-value">${srv.diskUsage}%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">延遲</div>
                                <div class="metric-value">${srv.networkLatency}ms</div>
                            </div>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(74, 144, 217, 0.1); display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 0.75rem;">
                            <div>入站: <span style="color: #4a90d9;">${srv.inboundTraffic} Mbps</span></div>
                            <div>出站: <span style="color: #4a90d9;">${srv.outboundTraffic} Mbps</span></div>
                            <div>IDS 警報: <span class="alert-${srv.idsAlerts > 5 ? 'high' : srv.idsAlerts > 2 ? 'medium' : 'low'}">${srv.idsAlerts}</span></div>
                            <div>防火牆阻止: <span class="alert-${srv.firewallBlocked > 10 ? 'high' : srv.firewallBlocked > 5 ? 'medium' : 'low'}">${srv.firewallBlocked}</span></div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        // 清空並重新填充容器
        container.innerHTML = '';
        container.appendChild(evidenceCard);
        container.appendChild(commandCard);
        container.appendChild(coordCard);
        container.appendChild(serverCard);
    }

    // ===== 4. 遊戲循環集成 =====

    const originalUpdateGameStats = window.updateGameStats;
    window.updateGameStats = function() {
        if (originalUpdateGameStats) originalUpdateGameStats();
        
        // 僅在執法部門時顯示
        if (GameState && GameState.currentRole === 'law_enforcement' && GameState.gameActive) {
            window.generateLEDashboard();
        }
    };

    // 初始執行
    setTimeout(() => {
        if (GameState && GameState.currentRole === 'law_enforcement' && GameState.gameActive) {
            window.generateLEDashboard();
        }
    }, 2000);

})();

// 通信攔截邏輯
let currentInterceptChannel = null;
let isCracking = false;

function showInterceptPage() {
    hideAllPages();
    document.getElementById('intercept-page').classList.add('active');
    updateNavActive('nav-intercept');
}

function startScanningChannels() {
    const log = document.getElementById('intercept-log');
    log.innerHTML += '<div class="log-entry system">正在掃描頻率...</div>';
    
    setTimeout(() => {
        const channels = [
            { id: 1, name: "加密頻道 Alpha", type: "AES-256" },
            { id: 2, name: "暗網中繼站 04", type: "RSA-4096" },
            { id: 3, name: "黑客小組私聊", type: "Custom-XOR" }
        ];
        
        const list = document.getElementById('channel-list');
        list.innerHTML = '';
        channels.forEach(ch => {
            const div = document.createElement('div');
            div.className = 'channel-item';
            div.innerHTML = `<strong>${ch.name}</strong><br><small>${ch.type}</small>`;
            div.onclick = () => selectChannel(ch);
            list.appendChild(div);
        });
        log.innerHTML += '<div class="log-entry system">掃描完成，發現 3 個活動頻道。</div>';
    }, 1500);
}

function selectChannel(ch) {
    currentInterceptChannel = ch;
    document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    document.getElementById('current-channel-name').innerText = ch.name;
    document.getElementById('intercept-status').innerText = "監聽中";
    document.getElementById('crack-btn').disabled = false;
    document.getElementById('crack-details').innerText = `加密算法: ${ch.type} | 密鑰強度: 高`;
    
    startIntercepting();
}

function startIntercepting() {
    const log = document.getElementById('intercept-log');
    log.innerHTML = `<div class="log-entry system">開始監聽 ${currentInterceptChannel.name}...</div>`;
    
    const messages = [
        "正在傳輸加密數據包...",
        "攔截到片段: 0x45 0xAF 0x22...",
        "檢測到握手信號...",
        "數據流持續中..."
    ];
    
    let i = 0;
    const interval = setInterval(() => {
        if (!currentInterceptChannel) { clearInterval(interval); return; }
        log.innerHTML += `<div class="log-entry intercepted">[攔截] ${messages[i % messages.length]}</div>`;
        log.scrollTop = log.scrollHeight;
        i++;
    }, 2000);
}

function startCracking() {
    if (isCracking) return;
    isCracking = true;
    document.getElementById('crack-btn').disabled = true;
    document.getElementById('intercept-status').innerText = "破解中";
    
    let progress = 0;
    const fill = document.getElementById('crack-progress-fill');
    const percent = document.getElementById('crack-percentage');
    
    const interval = setInterval(() => {
        progress += Math.random() * 5;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            finishCracking();
        }
        fill.style.width = progress + "%";
        percent.innerText = Math.floor(progress) + "%";
    }, 500);
}

function finishCracking() {
    isCracking = false;
    
    // 更新UI
    document.getElementById('intercept-status').innerText = "已破解";
    const log = document.getElementById('intercept-log');
    const timestamp = new Date().toLocaleTimeString('zh-TW');
    
    // 破解的訊息內容
    const crackedMessage = "今晚 23:00 攻擊目標伺服器 192.168.1.105，使用 SQL 注入漏洞。";
    const rawData = "0x45 0xAF 0x22 0x99 0xFF 0x01 0x42 0xBC 0x33";
    
    // 添加到日誌
    log.innerHTML += `
        <div class="log-entry intercepted" style="color:#fff; background:rgba(0,255,65,0.2); padding:15px; border-radius:4px; margin-top: 10px; border-left: 4px solid #00ff41;">
            <strong>✓ [${timestamp}] [破解成功]</strong><br>
            <div style="margin-top: 10px;">
                <strong>原始訊息:</strong><br>
                <p style="margin: 5px 0; color: #00ff41; font-family: monospace;">"${crackedMessage}"</p>
            </div>
        </div>
    `;
    log.scrollTop = log.scrollHeight;
    
    // 添加到證據庫
    if (typeof addEvidence === 'function') {
        addEvidence(
            'intercept',
            currentInterceptChannel.name,
            rawData,
            crackedMessage,
            '★★★ 高優先級 - 披露了具體的攻擊計劃和目標'
        );
    }
    
    // 自動立案
    if (typeof LE_SYSTEM !== 'undefined' && LE_SYSTEM.triggerInterceptCase) {
        const caseId = LE_SYSTEM.generateCaseFromEvidence({
            id: 'EV-' + Date.now(),
            type: 'intercept',
            source: currentInterceptChannel.name,
            time: new Date().toLocaleString('zh-TW'),
            decryptedContent: crackedMessage
        });
    }
    
    // 顯示成功通知
    showNotification('✓ 通信破解成功', `已成功破解 ${currentInterceptChannel.name} 的通信內容`, 'success');
    
    // 添加終端日誌
    addTerminalLine(`[${timestamp}] [通信攔截] 成功破解 ${currentInterceptChannel.name}`, 'success');
    
    // 更新統計
    if (typeof addReputation === 'function') {
        addReputation(50);
        addTerminalLine(`[${timestamp}] [聲望獎勵] +50 聲望`, 'success');
    }
}

// 網絡陷阱邏輯
let deployedTraps = [];

function showTrapPage() {
    hideAllPages();
    document.getElementById('trap-page').classList.add('active');
    updateNavActive('nav-trap');
}

function deployTrap(type) {
    let trapName = "";
    let cost = 0;
    
    switch(type) {
        case 'honeypot': trapName = "虛擬數據庫蜜罐"; cost = 500; break;
        case 'credentials': trapName = "虛假憑據陷阱"; cost = 300; break;
        case 'backdoor': trapName = "受控後門誘餌"; cost = 800; break;
    }
    
    // 檢查金幣
    if (window.globalCoins < cost) {
        showNotification('資金不足', `部署此陷阱需要 $${cost}，但您只有 $${window.globalCoins}`, 'warning');
        addTerminalLine(`[陷阱部署失敗] 資金不足，需要 $${cost}，但只有 $${window.globalCoins}`, 'error');
        return;
    }
    
    // 扣費
    window.globalCoins -= cost;
    
    const timestamp = new Date().toLocaleString('zh-TW');
    const subnet = "子網 " + (Math.floor(Math.random() * 5) + 1);
    
    const newTrap = {
        id: 'TRAP-' + Date.now(),
        name: trapName,
        location: subnet,
        status: "運行中",
        triggers: 0,
        deployedAt: timestamp,
        type: type
    };
    
    deployedTraps.push(newTrap);
    
    // 立即提供反饋
    showNotification('✓ 陷阱已部署', `${trapName} 已在 ${subnet} 部署，費用: $${cost}`, 'success');
    addTerminalLine(`[${timestamp}] [陷阱部署] ${trapName} 在 ${subnet} 成功部署 (花費 $${cost})`, 'success');
    
    // 添加到證據庫作為部署記錄
    if (typeof addEvidence === 'function') {
        addEvidence(
            'trap',
            subnet,
            `TRAP_ID: ${newTrap.id} | TYPE: ${type}`,
            `${trapName} 已部署於 ${subnet}，等待觸發`,
            '陷阱部署記錄'
        );
    }
    
    // 更新UI
    if (typeof updateTrapTable === 'function') updateTrapTable();
    if (typeof updateUI === 'function') updateUI();
    
    // 模擬隨機觸發
    setTimeout(() => triggerTrap(newTrap.id), 10000 + Math.random() * 20000);
}

function updateTrapTable() {
    const tbody = document.getElementById('active-traps-list');
    tbody.innerHTML = '';
    
    deployedTraps.forEach(trap => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${trap.name}</td>
            <td>${trap.location}</td>
            <td class="${trap.status === '已觸發' ? 'status-triggered' : 'status-active'}">${trap.status}</td>
            <td>${trap.triggers}</td>
            <td><button onclick="removeTrap(${trap.id})">移除</button></td>
        `;
        tbody.appendChild(tr);
    });
}

function triggerTrap(id) {
    const trap = deployedTraps.find(t => t.id === id);
    if (trap && trap.status !== '已觸發') {
        trap.status = "已觸發";
        trap.triggers++;
        updateTrapTable();
        
        // 發送通知
        if (typeof showNotification === 'function') {
            showNotification(`警報：${trap.name} 在 ${trap.location} 被觸發！`, "warning");
        } else {
            alert(`警報：${trap.name} 在 ${trap.location} 被觸發！`);
        }
    }
}

function removeTrap(id) {
    deployedTraps = deployedTraps.filter(t => t.id !== id);
    updateTrapTable();
}

// --- AI 對手決策引擎 ---
const AI_ENGINE = {
    efficiency: 1.5, // 效率倍率
    state: "idle",
    targetNode: null,
    history: [],
    
    update() {
        if (this.state === "idle") {
            this.planAttack();
        } else if (this.state === "attacking") {
            this.executeAttack();
        }
    },
    
    planAttack() {
        this.state = "scanning";
        this.log("AI 正在掃描玩家防禦漏洞...");
        
        setTimeout(() => {
            // 根據玩家防禦最弱的點選擇目標
            const targets = ["firewall", "database", "network_hub"];
            this.targetNode = targets[Math.floor(Math.random() * targets.length)];
            this.state = "attacking";
            this.log(`AI 鎖定目標: ${this.targetNode}，開始滲透...`);
        }, 3000 / this.efficiency);
    },
    
    executeAttack() {
        // 模擬攻擊進度
        const chance = Math.random();
        if (chance > 0.8) {
            this.log(`AI 攻擊 ${this.targetNode} 被攔截！`);
            this.state = "idle";
            // 觸發玩家陷阱檢測
            checkTrapsTriggered(this.targetNode);
        } else if (chance < 0.1) {
            this.log(`AI 成功滲透 ${this.targetNode}！`);
            this.state = "idle";
            if (typeof triggerPlayerDamage === 'function') triggerPlayerDamage(10);
        }
    },
    
    log(msg) {
        console.log(`[AI ENGINE] ${msg}`);
        const indicator = document.getElementById('ai-status-text');
        if (indicator) indicator.innerText = msg;
    }
};

// 啟動 AI 引擎
setInterval(() => AI_ENGINE.update(), 5000);

// --- 實體化操作重構 ---
function startScanningChannels() {
    const log = document.getElementById('intercept-log');
    log.innerHTML = '<div class="log-entry system">正在初始化頻譜分析儀...</div>';
    
    // 實體化步驟 1: 設置頻率範圍
    setTimeout(() => {
        log.innerHTML += `
            <div class="config-step">
                <span class="config-label">步驟 1: 配置掃描頻率 (GHz)</span>
                <div class="config-input-group">
                    <input type="number" id="freq-min" class="config-input" value="2.4" step="0.1">
                    <span>至</span>
                    <input type="number" id="freq-max" class="config-input" value="5.8" step="0.1">
                    <button class="node-action-btn" onclick="confirmFrequency()">確認頻率</button>
                </div>
            </div>
        `;
    }, 1000);
}

function confirmFrequency() {
    const min = document.getElementById('freq-min').value;
    const max = document.getElementById('freq-max').value;
    const log = document.getElementById('intercept-log');
    log.innerHTML += `<div class="log-entry system">頻率鎖定: ${min}GHz - ${max}GHz. 正在掃描信號特徵...</div>`;
    
    // 實體化步驟 2: 選擇解調模式
    setTimeout(() => {
        log.innerHTML += `
            <div class="config-step">
                <span class="config-label">步驟 2: 選擇信號解調模式</span>
                <div class="config-input-group">
                    <select id="demod-mode" class="config-input">
                        <option value="qam">QAM-64 (高速數據)</option>
                        <option value="psk">BPSK (強干擾環境)</option>
                        <option value="fsk">FSK (傳統加密)</option>
                    </select>
                    <button class="node-action-btn" onclick="executeFinalScan()">執行最終掃描</button>
                </div>
            </div>
        `;
    }, 1500);
}

function executeFinalScan() {
    const mode = document.getElementById('demod-mode').value;
    const log = document.getElementById('intercept-log');
    log.innerHTML += `<div class="log-entry system">使用 ${mode.toUpperCase()} 模式進行解調...</div>`;
    
    setTimeout(() => {
        const channels = [
            { id: 1, name: "加密頻道 Alpha", type: "AES-256", freq: "2.45GHz" },
            { id: 2, name: "暗網中繼站 04", type: "RSA-4096", freq: "5.12GHz" },
            { id: 3, name: "黑客小組私聊", type: "Custom-XOR", freq: "3.88GHz" }
        ];
        
        const list = document.getElementById('channel-list');
        list.innerHTML = '';
        channels.forEach(ch => {
            const div = document.createElement('div');
            div.className = 'channel-item';
            div.innerHTML = `<strong>${ch.name}</strong><br><small>${ch.freq} | ${ch.type}</small>`;
            div.onclick = () => selectChannel(ch);
            list.appendChild(div);
        });
        log.innerHTML += '<div class="log-entry system">掃描完成，發現 3 個活動頻道。</div>';
    }, 2000);
}

// --- 執法證據庫邏輯 ---
let evidenceData = [];

function addEvidence(type, source, rawData, decryptedContent = null, caseImportance = null) {
    const newEvidence = {
        id: 'EV-' + Date.now(),
        type: type, // 'intercept' 或 'trap'
        source: source,
        time: new Date().toLocaleString('zh-TW'),
        rawData: rawData,
        decryptedContent: decryptedContent,
        status: decryptedContent ? '已破解' : '加密中',
        caseImportance: caseImportance || '待分析',
        createdAt: new Date(),
        importance: Math.random() > 0.5 ? 'high' : 'medium'
    };
    
    evidenceData.unshift(newEvidence);
    updateEvidenceUI();
    
    // 提供視覺反饋
    const typeText = type === 'intercept' ? '通信攔截' : '網絡陷阱';
    const statusText = decryptedContent ? '✓ 已破解' : '○ 加密中';
    
    if (typeof showNotification === 'function') {
        const message = `${typeText} | ${statusText} | 來源: ${source}`;
        showNotification(`新證物已存入: ${newEvidence.id}`, message, decryptedContent ? 'success' : 'warning');
    }
    
    // 添加終端日誌
    if (typeof addTerminalLine === 'function') {
        addTerminalLine(`[${new Date().toLocaleTimeString()}] [證據庫] 新增證物 ${newEvidence.id} - ${typeText} (${statusText})`, 'info');
    }
    
    return newEvidence;
}

function updateEvidenceUI() {
    const list = document.getElementById('evidence-list');
    if (!list) return;
    
    list.innerHTML = '';
    const totalCount = evidenceData.length;
    const crackedCount = evidenceData.filter(e => e.status === '已破解').length;
    
    // 更新計數器
    const totalEl = document.getElementById('total-evidence');
    const crackedEl = document.getElementById('cracked-evidence');
    if (totalEl) totalEl.innerText = totalCount;
    if (crackedEl) crackedEl.innerText = crackedCount;
    
    // 顯示進度百分比
    const progressPercent = totalCount > 0 ? Math.round((crackedCount / totalCount) * 100) : 0;
    const progressEl = document.getElementById('evidence-progress');
    if (progressEl) {
        progressEl.innerHTML = `
            <div style="margin-top: 10px; text-align: center;">
                <strong>破解進度: ${crackedCount}/${totalCount} (${progressPercent}%)</strong>
                <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; margin-top: 5px; overflow: hidden;">
                    <div style="width: ${progressPercent}%; height: 100%; background: linear-gradient(90deg, #4a90d9, #00ff41); transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }
    
    // 按獲取時間排序
    const sortedEvidence = [...evidenceData].sort((a, b) => {
        return new Date(b.time) - new Date(a.time);
    });
    
    sortedEvidence.forEach(ev => {
        const div = document.createElement('div');
        div.className = 'evidence-item';
        div.setAttribute('data-evidence-id', ev.id);
        div.onclick = () => showEvidenceDetail(ev.id);
        
        // 視覺指示符
        const statusIcon = ev.status === '已破解' ? '✓' : '○';
        const statusColor = ev.status === '已破解' ? '#00ff41' : '#ffaa00';
        
        div.innerHTML = `
            <span class="time">${ev.time.split(' ')[1]}</span>
            <span class="type" style="color: ${statusColor};">${statusIcon} ${ev.type === 'intercept' ? '通信攔截' : '網絡陷阱'}</span>
            <span class="title">${ev.id}</span>
            <small>${ev.source}</small>
        `;
        list.appendChild(div);
    });
}

function showEvidenceDetail(id) {
    const ev = evidenceData.find(e => e.id === id);
    if (!ev) return;
    
    const detail = document.getElementById('detail-content');
    if (!detail) return;
    
    // 標記為已查看
    if (!ev.viewedAt) {
        ev.viewedAt = new Date().toLocaleString('zh-TW');
    }
    
    // 選中項目視覺反饋
    document.querySelectorAll('.evidence-item').forEach(el => el.classList.remove('active'));
    const selectedItem = document.querySelector(`[data-evidence-id="${id}"]`);
    if (selectedItem) selectedItem.classList.add('active');
    
    // 構建詳細信息視窗 - 真實的操作效果
    let crackingStatus = '<span style="color:#ff3e3e;">❌ 未破解</span>';
    if (ev.status === '已破解') {
        crackingStatus = '<span style="color:#00ff41;">✓ 已破解</span>';
    }
    
    detail.innerHTML = `
        <div class="detail-header">
            <h3>證物編號: ${ev.id}</h3>
            <p>獲取時間: ${ev.time}</p>
            <p>狀態: ${crackingStatus}</p>
            ${ev.viewedAt ? `<p style="font-size: 0.8rem; color: #999;">最後查看: ${ev.viewedAt}</p>` : ''}
        </div>
        <div class="detail-row">
            <span class="detail-label">證物類型:</span>
            <span class="detail-value">${ev.type === 'intercept' ? '通信攔截' : '網絡陷阱'}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">來源節點:</span>
            <span class="detail-value">${ev.source}</span>
        </div>
        <div class="detail-row">
            <span class="detail-label">原始數據 (十六進制):</span>
            <code style="font-size:0.8rem; color:#4a90d9; word-break:break-all;">${ev.rawData}</code>
        </div>
        <div class="detail-row" style="margin-top:20px;">
            <span class="detail-label">破解狀態:</span>
            <div style="margin-top: 10px;">
                ${ev.status === '已破解' ? `
                    <div style="background:rgba(0,255,65,0.1); border-left:3px solid #00ff41; padding:15px; border-radius:4px;">
                        <strong>✓ 已成功破解</strong>
                        <div style="margin-top:10px; font-size:0.9rem;">
                            <strong>解密內容:</strong>
                            <p style="margin:5px 0;">${ev.decryptedContent || '無額外內容'}</p>
                            <strong>對案件的幫助:</strong>
                            <p style="margin:5px 0; color:#00ff41;">${ev.caseImportance || '可用於基本偵查'}</p>
                        </div>
                    </div>
                ` : `
                    <div style="background:rgba(255,100,50,0.1); border-left:3px solid #ff6432; padding:15px; border-radius:4px;">
                        <strong>❌ 數據加密中</strong>
                        <p style="margin:5px 0; font-size:0.9rem;">請先完成通信攔截頻道破解以解鎖此證物的詳細信息。</p>
                    </div>
                `}
            </div>
        </div>
    `;
    
    // 顯示通知
    showNotification('證物查看', `已查看證物 ${id}`, 'info');
}

// 整合原本的破解完成邏輯
function finishCracking() {
    isCracking = false;
    document.getElementById('intercept-status').innerText = "已破解";
    const log = document.getElementById('intercept-log');
    const content = "今晚 23:00 攻擊目標伺服器 192.168.1.105，使用 SQL 注入漏洞。";
    
    log.innerHTML += `<div class="log-entry intercepted" style="color:#fff; background:rgba(0,255,65,0.2); padding:10px; border-radius:4px;">
        <strong>[破解成功] 數據已同步至證據庫</strong>
    </div>`;
    
    addEvidence('intercept', currentInterceptChannel.name, "0x45 0xAF 0x22 0x99 0xFF...", content);
}

function checkTrapsTriggered(node) {
    const trap = deployedTraps.find(t => t.location.includes(node) || Math.random() > 0.5);
    if (trap) {
        triggerTrap(trap.id);
        addEvidence('trap', trap.name, `偵測到來自 AI 引擎的非法訪問請求 @ ${node}`, `攻擊者試圖利用 ${node} 的緩衝區溢位漏洞，已被蜜罐成功隔離。`);
    }
}

function showEvidencePage() {
    hideAllPages();
    document.getElementById('evidence-page').classList.add('active');
    updateNavActive('nav-evidence');
    updateEvidenceUI();
}

// 初始化 AI 指示器
document.body.insertAdjacentHTML('beforeend', `
    <div id="ai-status-indicator">
        <div class="ai-pulse"></div>
        <span id="ai-status-text">AI 引擎就緒</span>
    </div>
`);

// --- 1. 修復移動端菜單自動關閉 ---
function closeMobileMenu() {
    const menu = document.getElementById('nav-menu-mobile');
    const hamburger = document.getElementById('hamburger-menu');
    if (menu) menu.classList.remove('active');
    if (hamburger) hamburger.classList.remove('active');
}

// 確保所有導航點擊都觸發關閉
document.querySelectorAll('.nav-menu-mobile a').forEach(link => {
    link.addEventListener('click', closeMobileMenu);
});

// --- 2. 同步情報監控數據 ---
function updateIntelPanel() {
    const intelPanel = document.querySelector('.intel-view-content'); // 假設這是面板容器
    if (!intelPanel) return;
    
    // 獲取當前遊戲數據
    const stats = {
        reputation: window.globalReputation || 0,
        coins: window.globalCoins || 0,
        evidence: (window.evidenceData || []).length,
        traps: (window.deployedTraps || []).length,
        aiEfficiency: (window.AI_ENGINE ? window.AI_ENGINE.efficiency : 1.0).toFixed(1)
    };
    
    // 更新面板中的具體元素
    const elements = {
        'intel-reputation': stats.reputation,
        'intel-coins': stats.coins,
        'intel-evidence-count': stats.evidence,
        'intel-active-traps': stats.traps,
        'intel-ai-threat': stats.aiEfficiency + "x"
    };
    
    for (const [id, val] of Object.entries(elements)) {
        const el = document.getElementById(id);
        if (el) el.innerText = val;
    }
}

// 定時同步數據
setInterval(updateIntelPanel, 2000);

// --- 3. 實體化技能樹系統 ---
const SKILL_TREE = {
    skills: {
        'fast_crack': { name: '快速破解', level: 0, maxLevel: 5, cost: 1000, description: '提升 15% 破解速度', effect: 0.15 },
        'cheap_trap': { name: '廉價陷阱', level: 0, maxLevel: 5, cost: 800, description: '降低 10% 陷阱部署成本', effect: 0.10 },
        'ai_stealth': { name: 'AI 隱匿', level: 0, maxLevel: 3, cost: 2000, description: '降低 AI 發現玩家的機率 20%', effect: 0.20 }
    },
    
    upgrade(skillId) {
        const skill = this.skills[skillId];
        if (!skill) return;
        
        if (skill.level >= skill.maxLevel) {
            showNotification("該技能已達最高等級！", "warning");
            return;
        }
        
        const currentCost = skill.cost * (skill.level + 1);
        if (window.globalCoins < currentCost) {
            showNotification(`資金不足！需要 ${currentCost} 金幣`, "error");
            return;
        }
        
        // 扣除資源
        window.globalCoins -= currentCost;
        skill.level++;
        
        // 應用效果
        this.applyEffect(skillId);
        
        // 更新 UI
        if (typeof updateUI === 'function') updateUI();
        this.render();
        showNotification(`升級成功：${skill.name} 已提升至 Lv.${skill.level}`, "success");
    },
    
    applyEffect(skillId) {
        const skill = this.skills[skillId];
        switch(skillId) {
            case 'fast_crack':
                // 影響破解速度邏輯
                break;
            case 'cheap_trap':
                // 影響陷阱成本邏輯
                break;
            case 'ai_stealth':
                if (window.AI_ENGINE) window.AI_ENGINE.efficiency -= skill.effect;
                break;
        }
    },
    
    render() {
        const container = document.getElementById('skill-tree-container');
        if (!container) return;
        
        container.innerHTML = '';
        for (const [id, skill] of Object.entries(this.skills)) {
            const cost = skill.cost * (skill.level + 1);
            const isMax = skill.level >= skill.maxLevel;
            
            const card = document.createElement('div');
            card.className = 'skill-card' + (isMax ? ' maxed' : '');
            card.innerHTML = `
                <div class="skill-icon"><i class="fas fa-bolt"></i></div>
                <div class="skill-info">
                    <h4>${skill.name} <span class="lvl">Lv.${skill.level}/${skill.maxLevel}</span></h4>
                    <p>${skill.description}</p>
                    <div class="skill-footer">
                        ${isMax ? '<span class="max-tag">MAX</span>' : `<button class="upgrade-btn" onclick="SKILL_TREE.upgrade('${id}')">升級 (${cost})</button>`}
                    </div>
                </div>
            `;
            container.appendChild(card);
        }
    }
};

// 擴展原本的 showSkillTree 函數
function showSkillTree() {
    hideAllPages();
    const page = document.getElementById('skill-tree-page'); // 假設這是技能樹頁面 ID
    if (page) {
        page.classList.add('active');
        SKILL_TREE.render();
    }
    updateNavActive('nav-skills');
}

// --- 執法專屬邏輯 ---
let activeCases = [
    { id: 'CASE-2026-001', title: '影子組織滲透案', suspect: 'Unknown (Alias: Ghost)', status: 'Open', priority: 'High', description: '針對政府骨幹網絡的持續性滲透攻擊。' },
    { id: 'CASE-2026-002', title: '加密貨幣洗錢追蹤', suspect: 'Crypto-King', status: 'Open', priority: 'Medium', description: '追蹤非法獲取的 5000 BTC 流向。' }
];

let targetIntel = [
    { name: 'AI 引擎 v2.1', type: '自動化攻擊程序', threat: 'Critical', patterns: ['SQL 注入', 'DDoS', '暴力破解'], location: '未知 (可能為分佈式節點)' }
];

function switchLETab(tabId) {
    document.querySelectorAll('.le-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.le-tab-content').forEach(content => content.classList.remove('active'));
    
    event.currentTarget.classList.add('active');
    document.getElementById(`le-tab-${tabId}`).classList.add('active');
    
    if (tabId === 'cases') renderCases();
    if (tabId === 'intel') renderIntel();
    if (tabId === 'reports') prepareReportForm();
}

function renderCases() {
    const list = document.getElementById('case-list');
    if (!list) return;
    
    list.innerHTML = '';
    
    // 按優先級排序
    const priorityOrder = { '緊急': 0, '高': 1, '中': 2, '低': 3 };
    const sortedCases = [...activeCases].sort((a, b) => {
        return (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
    });
    
    // 統計信息
    const totalCases = sortedCases.length;
    const urgentCases = sortedCases.filter(c => c.priority === '緊急').length;
    
    if (totalCases === 0) {
        list.innerHTML = '<p style="text-align: center; color: #999; padding: 30px;">暫無活躍案件</p>';
        return;
    }
    
    sortedCases.forEach(c => {
        const div = document.createElement('div');
        div.className = 'case-item';
        div.setAttribute('data-case-id', c.id);
        div.onclick = () => showCaseDossier(c.id);
        
        // 優先級顏色
        const priorityColor = {
            '緊急': '#ff3e3e',
            '高': '#ff9900',
            '中': '#ffff00',
            '低': '#00ff41'
        }[c.priority] || '#999';
        
        // 狀態圖標
        const statusIcon = c.status === '進行中' ? '⏳' : c.status === '已結案' ? '✓' : '?';
        
        div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                <span style="font-size: 1.2rem;">${statusIcon}</span>
                <div style="flex: 1;">
                    <strong style="color: ${priorityColor};">${c.id}</strong><br>
                    <small>${c.title}</small><br>
                    <tiny style="color: #999;">優先級: <span style="color: ${priorityColor};">${c.priority}</span> | 狀態: ${c.status}</tiny>
                </div>
                <div style="text-align: right; font-size: 0.85rem;">
                    <span style="background: rgba(255,255,0,0.2); color: #ffff00; padding: 2px 8px; border-radius: 3px;">
                        ${c.evidenceIds ? c.evidenceIds.length : 0} 件證物
                    </span>
                </div>
            </div>
        `;
        list.appendChild(div);
    });
    
    // 添加統計面板
    const statsEl = document.getElementById('case-stats');
    if (statsEl) {
        statsEl.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; color: #ff9900; font-weight: bold;">${totalCases}</div>
                    <small style="color: #999;">活躍案件</small>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 1.5rem; color: #ff3e3e; font-weight: bold;">${urgentCases}</div>
                    <small style="color: #999;">緊急案件</small>
                </div>
            </div>
        `;
    }
}

function showCaseDossier(id) {
    const c = activeCases.find(item => item.id === id);
    if (!c) return;
    
    // 標記為已查看
    if (!c.viewedAt) {
        c.viewedAt = new Date().toLocaleString('zh-TW');
    }
    
    const dossier = document.getElementById('case-dossier');
    if (!dossier) return;
    
    // 獲取關聯的證物
    const relatedEvidence = (window.evidenceData || []).filter(ev => {
        return c.evidenceIds && c.evidenceIds.includes(ev.id);
    });
    
    const priorityColor = {
        '緊急': '#ff3e3e',
        '高': '#ff9900',
        '中': '#ffff00',
        '低': '#00ff41'
    }[c.priority] || '#999';
    
    // 構建詳細卷宗視窗
    let evidenceHtml = '';
    if (relatedEvidence.length > 0) {
        evidenceHtml = relatedEvidence.map(ev => `
            <div style="background: rgba(0,0,0,0.2); padding: 10px; border-left: 3px solid ${ev.status === '已破解' ? '#00ff41' : '#ffaa00'}; margin: 5px 0; border-radius: 4px;">
                <strong>${ev.id}</strong> 
                <span style="float: right; font-size: 0.8rem; color: ${ev.status === '已破解' ? '#00ff41' : '#ffaa00'};">${ev.status}</span>
                <br>
                <small>${ev.type === 'intercept' ? '通信攔截' : '網絡陷阱'} | ${ev.source}</small>
                <br>
                <tiny style="color: #999;">獲取時間: ${ev.time}</tiny>
            </div>
        `).join('');
    } else {
        evidenceHtml = '<p style="color: #999;">暫無關聯證物</p>';
    }
    
    // 構建調查日誌
    let logsHtml = '';
    if (c.logs && c.logs.length > 0) {
        logsHtml = c.logs.map(log => `
            <div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; font-family: 'Courier New', monospace;">
                ${log}
            </div>
        `).join('');
    }
    
    dossier.innerHTML = `
        <div class="dossier-header">
            <h2>案件卷宗: ${c.id}</h2>
            <p style="margin: 10px 0;">
                優先級: <span style="color: ${priorityColor}; font-weight: bold;">${c.priority}</span> | 
                狀態: <span style="color: #4a90d9;">${c.status}</span>
            </p>
            ${c.viewedAt ? `<tiny style="color: #999;">最後查看: ${c.viewedAt}</tiny>` : ''}
        </div>
        
        <div class="detail-row">
            <span class="detail-label">案件名稱:</span>
            <span>${c.title}</span>
        </div>
        
        <div class="detail-row">
            <span class="detail-label">主要嫌疑人:</span>
            <span>${c.suspect || '待確認'}</span>
        </div>
        
        <div class="detail-row" style="margin-top:15px;">
            <span class="detail-label">案情摘要:</span><br>
            <p style="margin-top:10px; color:#ccc; line-height: 1.6;">${c.description || c.details || c.title}</p>
        </div>
        
        <div class="detail-row" style="margin-top:20px;">
            <span class="detail-label">關聯證物 (${relatedEvidence.length}):</span>
            <div id="dossier-evidence-list" style="margin-top: 10px;">
                ${evidenceHtml}
            </div>
        </div>
        
        <div class="detail-row" style="margin-top:20px;">
            <span class="detail-label">調查進展日誌:</span>
            <div style="background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; margin-top: 10px; max-height: 200px; overflow-y: auto;">
                ${logsHtml || '<p style="padding: 10px; color: #999;">暫無日誌</p>'}
            </div>
        </div>
        
        <div class="detail-row" style="margin-top:20px;">
            <button style="padding: 8px 16px; background: #4a90d9; border: none; color: #fff; border-radius: 4px; cursor: pointer;" onclick="addCaseLog('${c.id}', 'manual')">
                添加調查記錄
            </button>
        </div>
    `;
    
    // 顯示通知
    showNotification('案件卷宗', `已打開案件 ${id}`, 'info');
}

function renderIntel() {
    const grid = document.getElementById('target-intel-grid');
    grid.innerHTML = '';
    targetIntel.forEach(target => {
        const card = document.createElement('div');
        card.className = 'intel-card';
        card.innerHTML = `
            <h3 style="color:#ff3e3e; margin-bottom:10px;">目標: ${target.name}</h3>
            <p><small>類型: ${target.type}</small></p>
            <div style="margin:15px 0;">
                <strong>威脅等級: ${target.threat}</strong>
                <div class="progress-bar-container"><div class="progress-bar-fill" style="width: 90%; background:#ff3e3e;"></div></div>
            </div>
            <p><strong>常用攻擊模式:</strong></p>
            <ul style="font-size:0.8rem; margin-left:20px; color:#aaa;">
                ${target.patterns.map(p => `<li>${p}</li>`).join('')}
            </ul>
            <p style="margin-top:15px;"><small>物理位置: ${target.location}</small></p>
        `;
        grid.appendChild(card);
    });
}

// 添加案件日誌函數
function addCaseLog(caseId, type = 'auto', message = null) {
    const caseItem = activeCases.find(c => c.id === caseId);
    if (!caseItem) return;
    
    let logMessage = '';
    const timeStr = new Date().toLocaleTimeString('zh-TW');
    
    if (type === 'auto') {
        logMessage = message || `[${timeStr}] 系統自動更新案件狀態`;
    } else if (type === 'manual') {
        const userMessage = prompt('輸入調查記錄：');
        if (!userMessage) return;
        logMessage = `[${timeStr}] [手動記錄] ${userMessage}`;
    } else {
        logMessage = `[${timeStr}] ${message}`;
    }
    
    if (!caseItem.logs) {
        caseItem.logs = [];
    }
    caseItem.logs.unshift(logMessage);
    
    // 限制日誌條數
    if (caseItem.logs.length > 100) {
        caseItem.logs.pop();
    }
    
    // 重新渲染卷宗
    showCaseDossier(caseId);
    
    // 顯示反饋
    if (type === 'manual') {
        showNotification('記錄已保存', `已為案件 ${caseId} 添加調查記錄`, 'success');
        addTerminalLine(`[案件記錄] ${caseId} - ${logMessage}`, 'info');
    }
}

function prepareReportForm() {
    const select = document.getElementById('report-case-select');
    select.innerHTML = activeCases.map(c => `<option value="${c.id}">${c.id} - ${c.title}</option>`).join('');
    
    const tags = document.getElementById('report-evidence-tags');
    tags.innerHTML = (window.evidenceData || []).map(ev => `<span class="ev-tag">${ev.id}</span>`).join('');
    
    updateReportPreview();
}

function updateReportPreview() {
    const caseId = document.getElementById('report-case-select').value;
    const summary = document.getElementById('report-summary').value;
    const preview = document.getElementById('report-preview-content');
    
    preview.innerHTML = `
        <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:20px; margin-bottom:30px;">
            <h1 style="margin:0;">執法部門正式報告</h1>
            <p style="margin:5px 0;">OFFICIAL LAW ENFORCEMENT REPORT</p>
        </div>
        <p><strong>日期:</strong> ${new Date().toLocaleDateString()}</p>
        <p><strong>案件編號:</strong> ${caseId}</p>
        <p><strong>報告類型:</strong> 行動總結與證物提交</p>
        <hr>
        <h3>1. 行動摘要</h3>
        <p>${summary || '尚未輸入總結內容...'}</p>
        <h3>2. 提交證物清單</h3>
        <p>共計 ${(window.evidenceData || []).length} 件數位證物已隨本報告提交存檔。</p>
        <div style="margin-top:50px; text-align:right;">
            <p>__________________________</p>
            <p>調查官簽署 (數位簽章)</p>
        </div>
    `;
}

// 監聽輸入以更新預覽
document.getElementById('report-summary')?.addEventListener('input', updateReportPreview);

function submitCaseReport() {
    const caseId = document.getElementById('report-case-select').value;
    showNotification(`報告已提交！案件 ${caseId} 已進入結案審核流程。`, "success");
    
    // 獎勵
    if (typeof addReputation === 'function') addReputation(200);
    if (typeof addCoins === 'function') addCoins(1000);
    
    // 關閉案件
    const c = activeCases.find(item => item.id === caseId);
    if (c) c.status = 'Closed';
    
    renderCases();
}

function requestCollab(agency) {
    const progressId = `collab-${agency}-progress`;
    const bar = document.getElementById(progressId);
    let width = parseInt(bar.style.width);
    
    if (width >= 100) {
        showNotification("該部門協作已達最高等級！", "info");
        return;
    }
    
    if (window.globalCoins < 500) {
        showNotification("資金不足以啟動跨部門協作！", "error");
        return;
    }
    
    window.globalCoins -= 500;
    width += 10;
    bar.style.width = width + '%';
    showNotification(`已向 ${agency.toUpperCase()} 發送協作請求，進度提升。`, "success");
}

function showLECenter() {
    hideAllPages();
    document.getElementById('le-center-page').classList.add('active');
    updateNavActive('nav-le-center');
    renderCases();
}

// --- 深度實體化執法系統核心數據 ---
const LE_SYSTEM = {
    cases: [],
    targetIntel: {
        activeThreats: [],
        aiProfile: {
            name: "AI-Nexus v2.5",
            threatLevel: "High",
            lastSeen: "Unknown",
            attackVector: "None",
            nodes: []
        }
    },
    collab: {
        ncsc: { progress: 0, bonus: "防火牆加固 (+0%)", active: false },
        interpol: { progress: 0, bonus: "全球節點監控 (未解鎖)", active: false }
    },
    
    // 1. 動態案件生成與自動立案系統
    autoDetectionEnabled: true,
    
    generateCaseFromEvidence(evidence) {
        const caseId = `CASE-${Date.now().toString().slice(-6)}`;
        const newCase = {
            id: caseId,
            title: `針對 ${evidence.source} 的非法滲透調查`,
            suspect: "待確認 (代號: Shadow)",
            status: "進行中",
            priority: evidence.type === 'intercept' ? '高' : evidence.type === 'trap' ? '緊急' : '中',
            evidenceIds: [evidence.id],
            logs: [`[${new Date().toLocaleTimeString()}] 發現初步數位證物，案件立案。`],
            details: `本案起源於在 ${evidence.source} 偵測到的異常活動。初步分析顯示，攻擊者試圖利用加密通道傳輸敏感數據。`,
            autoGenerated: true,
            evidenceSource: evidence.type,
            timestamp: Date.now()
        };
        this.cases.unshift(newCase);
        if (typeof showNotification === 'function') showNotification(`🚨 新案件已自動立案: ${caseId}`, "warning");
        if (typeof addTerminalLine === 'function') addTerminalLine(`[自動立案] 偵測到 ${evidence.type} 類型證物，案件 ${caseId} 已建立`, 'alert');
        this.updateUI();
        return caseId;
    },
    
    // 自動立案觸發器 - 攔截通信
    triggerInterceptCase(sourceIP, targetIP, dataType) {
        const evidence = {
            id: `EV-${Date.now().toString().slice(-6)}`,
            type: 'intercept',
            source: `通信攔截系統 (${sourceIP} → ${targetIP})`,
            data: `攔截到 ${dataType} 類型數據傳輸`,
            timestamp: new Date().toLocaleString()
        };
        const caseId = this.generateCaseFromEvidence(evidence);
        addTerminalLine(`[攔截系統] 成功攔截可疑通信，已自動立案: ${caseId}`, 'success');
        return caseId;
    },
    
    // 自動立案觸發器 - 陷阱觸發
    triggerTrapCase(trapType, attackerInfo) {
        const evidence = {
            id: `EV-${Date.now().toString().slice(-6)}`,
            type: 'trap',
            source: `蜜罐系統 (${trapType})`,
            data: `攻擊者嘗試訪問陷阱節點，IP: ${attackerInfo.ip}, 手法: ${attackerInfo.method}`,
            timestamp: new Date().toLocaleString()
        };
        const caseId = this.generateCaseFromEvidence(evidence);
        addTerminalLine(`[蜜罐警報] 陷阱已觸發！攻擊者暴露，案件 ${caseId} 已建立`, 'danger');
        // 額外獎勵：降低黑客隱蔽度
        if (GameState.opponentData && GameState.opponentData.hacker) {
            GameState.opponentData.hacker.stealth = Math.max(0, GameState.opponentData.hacker.stealth - 15);
            addTerminalLine(`[效果] 對手隱蔽度降低 15%`, 'success');
        }
        return caseId;
    },
    
    // 自動立案觸發器 - 證物來源分析
    triggerForensicCase(evidenceType, details) {
        const evidence = {
            id: `EV-${Date.now().toString().slice(-6)}`,
            type: 'forensic',
            source: `數位鑑識系統`,
            data: `${evidenceType}: ${details}`,
            timestamp: new Date().toLocaleString()
        };
        const caseId = this.generateCaseFromEvidence(evidence);
        addTerminalLine(`[鑑識分析] 發現關鍵證物，案件 ${caseId} 已建立`, 'info');
        return caseId;
    },

    // 2. 實體化案件回報
    submitReport(caseId, summary, selectedEvidence, lawArticles) {
        const c = this.cases.find(item => item.id === caseId);
        if (!c) return;
        
        // 計算報告質量
        let score = 0;
        if (summary.length > 20) score += 30;
        if (selectedEvidence.length > 0) score += 40;
        if (lawArticles.length > 0) score += 30;
        
        c.status = "已結案";
        c.logs.push(`[${new Date().toLocaleTimeString()}] 提交正式報告。評估得分: ${score}`);
        
        // 獎勵發放
        const reward = Math.floor(score * 20);
        const rep = Math.floor(score / 2);
        if (window.addCoins) window.addCoins(reward);
        if (window.addReputation) window.addReputation(rep);
        
        showNotification(`案件已結案！獲得獎勵: ${reward} 金幣, ${rep} 聲望`, "success");
        this.updateUI();
    },

    // 3. 實時目標情報追蹤與AI行為同步
    aiTrackingEnabled: true,
    aiActivityLog: [],
    
    updateAIIntel(aiAction) {
        this.targetIntel.aiProfile.lastSeen = new Date().toLocaleTimeString();
        this.targetIntel.aiProfile.attackVector = aiAction.targetNode;
        
        if (!this.targetIntel.aiProfile.nodes.includes(aiAction.targetNode)) {
            this.targetIntel.aiProfile.nodes.push(aiAction.targetNode);
        }
        
        // 記錄 AI 活動日誌
        this.aiActivityLog.unshift({
            timestamp: new Date().toLocaleTimeString(),
            action: aiAction.type || '未知行為',
            target: aiAction.targetNode,
            success: aiAction.success !== false
        });
        
        // 保持日誌最多 15 條 (根據文檔微調)
        if (this.aiActivityLog.length > 15) {
            this.aiActivityLog.pop();
        }
        
        // 更新地圖上的 AI 標記 (假設有地圖系統)
        if (window.updateMapMarkers) window.updateMapMarkers();
        this.updateUI();
        
        // 如果是高危行為，發送警報
        if (aiAction.type === 'attack' || aiAction.type === 'infiltration') {
            if (typeof showNotification === 'function') {
                showNotification('🚨 AI 活動警報', `偵測到 ${aiAction.type} 行為，目標: ${aiAction.targetNode}`, 'danger');
            }
        }
    },
    
    // 同步 GameState 中的 AI 數據
    syncWithGameState() {
        if (typeof GameState === 'undefined') return;
        
        const opponent = GameState.currentRole === 'law_enforcement' 
            ? GameState.opponentData.hacker 
            : GameState.opponentData.law_enforcement;
        
        if (!opponent) return;
        
        // 同步實時數據
        if (GameState.currentRole === 'law_enforcement') {
            this.targetIntel.aiProfile.stealth = opponent.stealth || 0;
            this.targetIntel.aiProfile.vpnNodes = opponent.activeVpnNodes || 0;
            this.targetIntel.aiProfile.digitalFootprints = opponent.digitalFootprints || 0;
            this.targetIntel.aiProfile.threatLevel = opponent.stealth > 70 ? '高' : opponent.stealth > 40 ? '中' : '低';
        }
        
        this.updateUI();
    },
    
    // 啟動實時同步
    startRealtimeSync() {
        if (this.syncInterval) clearInterval(this.syncInterval);
        
        this.syncInterval = setInterval(() => {
            if (this.aiTrackingEnabled) {
                this.syncWithGameState();
            }
        }, 2000); // 每 2 秒同步一次
    },
    
    // 停止實時同步
    stopRealtimeSync() {
        if (this.syncInterval) {
            clearInterval(this.syncInterval);
            this.syncInterval = null;
        }
    },

    // 4. 功能性跨部門協作與數值聯動機制
    collabBonuses: {
        defenseBonus: 0,
        attackReduction: 0,
        investigationSpeed: 0,
        globalTracking: false
    },
    
    advanceCollab(agency) {
        const cost = 1000;
        if (window.globalCoins < cost) {
            showNotification("資金不足以推動協作！", "error");
            return;
        }
        
        window.globalCoins -= cost;
        this.collab[agency].progress += 20;
        if (this.collab[agency].progress > 100) this.collab[agency].progress = 100;
        
        // 應用實際效果與數值聯動
        if (agency === 'ncsc') {
            const bonusVal = Math.floor(this.collab.ncsc.progress / 2);
            this.collab.ncsc.bonus = `防火牆加固 (+${bonusVal}%)`;
            this.collabBonuses.defenseBonus = bonusVal;
            this.collabBonuses.attackReduction = Math.floor(bonusVal * 0.6);
            
            // 實際影響 GameState
            if (typeof GameState !== 'undefined' && GameState.playerData.law_enforcement) {
                GameState.playerData.law_enforcement.serverHealth = Math.min(100, 
                    GameState.playerData.law_enforcement.serverHealth + bonusVal / 5);
                
                // 降低對手攻擊成功率
                if (GameState.opponentData && GameState.opponentData.hacker) {
                    const attackPenalty = this.collabBonuses.attackReduction;
                    GameState.opponentData.hacker.attackSuccessRate = Math.max(0, 
                        (GameState.opponentData.hacker.attackSuccessRate || 100) - attackPenalty);
                    
                    if (typeof addTerminalLine === 'function') {
                        addTerminalLine(`[協作效果] NCSC 防火牆加固生效，對手攻擊成功率 -${attackPenalty}%`, 'success');
                    }
                }
            }
            
            this.collab.ncsc.active = this.collab.ncsc.progress >= 100;
        } else if (agency === 'interpol') {
            const bonusVal = Math.floor(this.collab.interpol.progress / 4);
            this.collab.interpol.bonus = `全球節點監控 (+${bonusVal}%)`;
            this.collabBonuses.investigationSpeed = bonusVal;
            this.collabBonuses.globalTracking = this.collab.interpol.progress >= 60;
            
            // 實際影響 GameState
            if (typeof GameState !== 'undefined' && GameState.playerData.law_enforcement) {
                GameState.playerData.law_enforcement.investigationProgress = Math.min(100,
                    GameState.playerData.law_enforcement.investigationProgress + bonusVal / 3);
                
                // 降低對手隱蔽度
                if (GameState.opponentData && GameState.opponentData.hacker) {
                    GameState.opponentData.hacker.stealth = Math.max(0,
                        GameState.opponentData.hacker.stealth - bonusVal / 2);
                    
                    if (typeof addTerminalLine === 'function') {
                        addTerminalLine(`[協作效果] INTERPOL 全球追蹤生效，對手隱蔽度 -${Math.floor(bonusVal/2)}%`, 'success');
                    }
                }
            }
            
            this.collab.interpol.active = this.collab.interpol.progress >= 100;
            
            // 解鎖全球追蹤功能
            if (this.collabBonuses.globalTracking) {
                this.collab.interpol.bonus = '全球節點監控 (已解鎖)';
                if (typeof addTerminalLine === 'function') {
                    addTerminalLine('[解鎖] INTERPOL 全球追蹤網絡已啟動！', 'alert');
                }
            }
        }
        
        showNotification(`${agency.toUpperCase()} 協作進度提升！`, "success");
        this.updateUI();
        
        // 更新協作面板顯示
        this.updateCollabPanel();
    },
    
    // 更新協作面板顯示
    updateCollabPanel() {
        const ncscBar = document.getElementById('collab-ncsc-progress');
        const interpolBar = document.getElementById('collab-interpol-progress');
        
        if (ncscBar) ncscBar.style.width = this.collab.ncsc.progress + '%';
        if (interpolBar) interpolBar.style.width = this.collab.interpol.progress + '%';
        
        // 顯示獎勵效果
        const bonusDisplay = document.getElementById('collab-bonus-display');
        if (bonusDisplay) {
            bonusDisplay.innerHTML = `
                <div style="background: rgba(74, 144, 217, 0.1); padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <h4 style="color: #4a90d9; margin-bottom: 5px;">協作獎勵效果</h4>
                    <p>🛡️ 防禦加成: +${this.collabBonuses.defenseBonus}%</p>
                    <p>⚔️ 對手攻擊減弱: -${this.collabBonuses.attackReduction}%</p>
                    <p>🔍 調查速度: +${this.collabBonuses.investigationSpeed}%</p>
                    <p>🌐 全球追蹤: ${this.collabBonuses.globalTracking ? '✅ 已啟動' : '❌ 未解鎖'}</p>
                </div>
            `;
        }
    },

    updateUI() {
        // 更新案件清單
        const list = document.getElementById('case-list');
        if (list) {
            list.innerHTML = this.cases.map(c => {
                // 優先級顏色標記 (紅色=緊急、藍色=高、灰色=中)
                const priorityColor = c.priority === '緊急' ? '#ff3e3e' : c.priority === '高' ? '#4a90d9' : '#888';
                return `
                    <div class="case-item ${c.status === '已結案' ? 'closed' : ''}" onclick="LE_SYSTEM.showDossier('${c.id}')" style="border-left: 4px solid ${priorityColor};">
                        <span class="case-status" style="background: ${priorityColor};">${c.status}</span>
                        <strong>${c.id}</strong><br><small>${c.title}</small>
                    </div>
                `;
            }).join('');
        }
        
        // 更新鎖定按鈕狀態
        const lockdownBtn = document.getElementById('lockdown-btn');
        if (lockdownBtn) {
            lockdownBtn.disabled = this.networkLockdownActive;
            lockdownBtn.innerHTML = this.networkLockdownActive ? 
                `<i class="fas fa-spinner fa-spin"></i> 鎖定中...` : 
                `<i class="fas fa-network-wired"></i> 全網設備鎖定`;
        }

        // 更新情報面板
        const intelPanel = document.getElementById('target-intel-grid');
        if (intelPanel) {
            const p = this.targetIntel.aiProfile;
            const realtimeData = `
                <div class="intel-card" style="background: rgba(10, 20, 40, 0.9); border: 1px solid #4a90d9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="color: #4a90d9; margin-bottom: 10px;">🎯 目標: ${p.name}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <strong>威脅等級:</strong> 
                            <span style="color: ${p.threatLevel === '高' ? '#ff3e3e' : p.threatLevel === '中' ? '#ff9900' : '#4a90d9'}">${p.threatLevel}</span>
                        </div>
                        <div><strong>最後現蹤:</strong> ${p.lastSeen}</div>
                        <div><strong>隱蔽度:</strong> ${p.stealth !== undefined ? p.stealth + '%' : 'N/A'}</div>
                        <div><strong>VPN節點:</strong> ${p.vpnNodes !== undefined ? p.vpnNodes : 'N/A'}</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>當前攻擊目標:</strong> 
                        <span style="color: #ff9900">${p.attackVector || '掃描中'}</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>已確認節點:</strong> 
                        <span style="color: #00ff41">${p.nodes.join(', ') || '無'}</span>
                    </div>
                </div>
            `;
            
            const activityLog = this.aiActivityLog.length > 0 ? `
                <div class="intel-card" style="background: rgba(10, 20, 40, 0.9); border: 1px solid #4a90d9; padding: 15px; border-radius: 8px;">
                    <h3 style="color: #4a90d9; margin-bottom: 10px;">📊 AI 活動日誌</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${this.aiActivityLog.map(log => `
                            <div style="padding: 8px; border-bottom: 1px solid rgba(74, 144, 217, 0.2); font-size: 0.85rem;">
                                <span style="color: #888;">[${log.timestamp}]</span>
                                <span style="color: ${log.success ? '#00ff41' : '#ff3e3e'};">${log.action}</span>
                                <span style="color: #aaa;"> → ${log.target}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : '';
            
            intelPanel.innerHTML = realtimeData + activityLog;
        }
    },

    showDossier(id) {
        const c = this.cases.find(item => item.id === id);
        const dossier = document.getElementById('case-dossier');
        if (!dossier) return;
        
        // 獲取詳細證據說明
        const evidenceDetails = c.evidenceIds.map(eid => {
            const ev = window.evidenceData ? window.evidenceData.find(e => e.id === eid) : null;
            if (!ev) return `<div class="ev-detail-item"><strong>${eid}</strong>: 數據已歸檔或損毀</div>`;
            
            return `
                <div class="ev-detail-item" style="background: rgba(74, 144, 217, 0.05); border: 1px solid rgba(74, 144, 217, 0.2); padding: 10px; margin-bottom: 10px; border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <strong style="color: #4a90d9;">${ev.id}</strong>
                        <span style="font-size: 0.75rem; color: #888;">${ev.time}</span>
                    </div>
                    <div style="font-size: 0.85rem;">
                        <p><strong>類型:</strong> ${ev.type} | <strong>來源:</strong> ${ev.source}</p>
                        <p><strong>原始特徵:</strong> <span style="font-family: monospace; color: #aaa;">${ev.rawData ? ev.rawData.substring(0, 32) + '...' : 'N/A'}</span></p>
                        <p><strong>分析結果:</strong> ${ev.decryptedContent || '尚未破解或無可讀內容'}</p>
                    </div>
                </div>
            `;
        }).join('');
        
        dossier.innerHTML = `
            <div class="dossier-header" style="border-bottom: 2px solid #4a90d9; padding-bottom: 10px; margin-bottom: 15px;">
                <h2 style="margin: 0; color: #4a90d9;">📁 案件卷宗: ${c.id}</h2>
                <div style="display: flex; gap: 15px; margin-top: 5px; font-size: 0.9rem;">
                    <span><strong>狀態:</strong> <span style="color: ${c.status === '已結案' ? '#00ff41' : '#ff9900'}">${c.status}</span></span>
                    <span><strong>優先級:</strong> ${c.priority}</span>
                    <span><strong>嫌疑人:</strong> ${c.suspect}</span>
                </div>
            </div>
            <div class="dossier-body" style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
                <div style="margin-bottom: 20px;">
                    <h3 style="border-left: 3px solid #4a90d9; padding-left: 10px; font-size: 1.1rem;">案件描述</h3>
                    <p style="line-height: 1.6; color: #ddd;">${c.details}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="border-left: 3px solid #4a90d9; padding-left: 10px; font-size: 1.1rem;">關鍵證據庫 (詳盡分析)</h3>
                    <div class="evidence-detail-list">
                        ${evidenceDetails || '<p style="color: #888;">暫無關聯證據</p>'}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3 style="border-left: 3px solid #4a90d9; padding-left: 10px; font-size: 1.1rem;">行動日誌</h3>
                    <div style="background: #000; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.85rem; color: #00ff41;">
                        ${c.logs.map(l => `<div>> ${l}</div>`).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    ${c.status !== '已結案' ? `
                        <button class="node-action-btn" onclick="LE_SYSTEM.openReportBuilder('${c.id}')" style="flex: 1;">撰寫結案報告</button>
                        <button class="node-action-btn" onclick="LE_SYSTEM.issueWarrant('${c.id}')" style="flex: 1; border-color: #ff3e3e; color: #ff3e3e;">申請通緝/追捕令</button>
                    ` : ''}
                </div>
            </div>
        `;
    },

    openReportBuilder(id) {
        const c = this.cases.find(item => item.id === id);
        if (!c) return;
        
        // 創建報告撰寫器模態視窗
        const modal = document.createElement('div');
        modal.id = 'report-builder-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
        
        modal.innerHTML = `
            <div style="background: #0a0a1a; border: 2px solid #4a90d9; padding: 30px; max-width: 800px; width: 90%; border-radius: 10px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #4a90d9; margin: 0;">📝 案件結案報告撰寫器</h2>
                    <button onclick="(function(){var e=document.getElementById('report-builder-modal'); if(e) e.remove();})()" style="background: #ff3e3e; border: none; color: white; padding: 5px 15px; border-radius: 5px; cursor: pointer;">×</button>
                </div>
                
                <div style="background: rgba(74, 144, 217, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <p><strong>案件編號:</strong> ${c.id}</p>
                    <p><strong>案件標題:</strong> ${c.title}</p>
                    <p><strong>嫌疑人:</strong> ${c.suspect}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #4a90d9; display: block; margin-bottom: 10px; font-weight: bold;">① 案件摘要 (建議 100-500 字)</label>
                    <textarea id="report-summary" style="width: 100%; min-height: 120px; background: #000; border: 1px solid #4a90d9; color: #fff; padding: 10px; border-radius: 5px; font-family: inherit;" placeholder="請描述案件的核心事實、調查過程與發現..."></textarea>
                    <div style="text-align: right; color: #888; font-size: 0.85rem; margin-top: 5px;">
                        <span id="summary-count">0</span> / 500 字
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #4a90d9; display: block; margin-bottom: 10px; font-weight: bold;">② 選擇關鍵證據 (至少選擇 1 項)</label>
                    <div id="evidence-selector" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        ${c.evidenceIds.map(eid => `
                            <label style="background: rgba(74, 144, 217, 0.1); padding: 10px; border: 1px solid #4a90d9; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" class="evidence-checkbox" value="${eid}" style="width: 18px; height: 18px;">
                                <span style="color: #fff;">${eid}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #4a90d9; display: block; margin-bottom: 10px; font-weight: bold;">③ 適用法條 (可選)</label>
                    <div id="law-selector" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <label style="background: rgba(74, 144, 217, 0.1); padding: 8px 15px; border: 1px solid #4a90d9; border-radius: 5px; cursor: pointer;">
                            <input type="checkbox" class="law-checkbox" value="刻意損毀電腦罪"> 刻意損毀電腦罪
                        </label>
                        <label style="background: rgba(74, 144, 217, 0.1); padding: 8px 15px; border: 1px solid #4a90d9; border-radius: 5px; cursor: pointer;">
                            <input type="checkbox" class="law-checkbox" value="非法侵入電腦罪"> 非法侵入電腦罪
                        </label>
                        <label style="background: rgba(74, 144, 217, 0.1); padding: 8px 15px; border: 1px solid #4a90d9; border-radius: 5px; cursor: pointer;">
                            <input type="checkbox" class="law-checkbox" value="竊取電腦資料罪"> 窪取電腦資料罪
                        </label>
                        <label style="background: rgba(74, 144, 217, 0.1); padding: 8px 15px; border: 1px solid #4a90d9; border-radius: 5px; cursor: pointer;">
                            <input type="checkbox" class="law-checkbox" value="干擾電腦系統罪"> 干擾電腦系統罪
                        </label>
                        <label style="background: rgba(74, 144, 217, 0.1); padding: 8px 15px; border: 1px solid #4a90d9; border-radius: 5px; cursor: pointer;">
                            <input type="checkbox" class="law-checkbox" value="網路詐欺罪"> 網路詐欺罪
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="color: #4a90d9; display: block; margin-bottom: 10px; font-weight: bold;">④ 處理建議</label>
                    <select id="report-recommendation" style="width: 100%; background: #000; border: 1px solid #4a90d9; color: #fff; padding: 10px; border-radius: 5px;">
                        <option value="">請選擇...</option>
                        <option value="立案調查">立案調查</option>
                        <option value="申請搜索令">申請搜索令</option>
                        <option value="申請逮捕令">申請逮捕令</option>
                        <option value="移交檢察機關">移交檢察機關</option>
                        <option value="結案歸檔">結案歸檔</option>
                    </select>
                </div>
                
                <div id="report-score-preview" style="background: rgba(74, 144, 217, 0.1); padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none;">
                    <h3 style="color: #4a90d9; margin-bottom: 10px;">🎯 報告評分預覽</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>摘要完整度:</strong> <span id="score-summary">0</span>/30</div>
                        <div><strong>證據充分性:</strong> <span id="score-evidence">0</span>/40</div>
                        <div><strong>法條適用:</strong> <span id="score-law">0</span>/30</div>
                        <div><strong>總分:</strong> <span id="score-total" style="color: #00ff41; font-size: 1.2rem;">0</span>/100</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>預估獎勵:</strong> 
                        <span style="color: #ffd700;">💰 <span id="reward-coins">0</span> 金幣</span> | 
                        <span style="color: #4a90d9;">⭐ <span id="reward-rep">0</span> 聲望</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                    <button onclick="LE_SYSTEM.previewReportScore('${c.id}')" style="background: #4a90d9; border: none; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">🔍 預覽評分</button>
                    <button onclick="LE_SYSTEM.submitReportFromBuilder('${c.id}')" style="background: #00ff41; border: none; color: #000; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">✅ 提交報告</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // 添加字數統計
        const summaryTextarea = document.getElementById('report-summary');
        summaryTextarea.addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('summary-count').textContent = count;
            if (count > 500) {
                this.value = this.value.substring(0, 500);
                document.getElementById('summary-count').textContent = 500;
            }
        });
    },
    
    // 預覽報告評分
    previewReportScore(caseId) {
        const summary = document.getElementById('report-summary').value;
        const selectedEvidence = Array.from(document.querySelectorAll('.evidence-checkbox:checked')).map(cb => cb.value);
        const selectedLaws = Array.from(document.querySelectorAll('.law-checkbox:checked')).map(cb => cb.value);
        
        // 計算評分
        let summaryScore = 0;
        if (summary.length >= 100) summaryScore = 30;
        else if (summary.length >= 50) summaryScore = 20;
        else if (summary.length >= 20) summaryScore = 10;
        
        let evidenceScore = 0;
        if (selectedEvidence.length >= 3) evidenceScore = 40;
        else if (selectedEvidence.length >= 2) evidenceScore = 30;
        else if (selectedEvidence.length >= 1) evidenceScore = 20;
        
        let lawScore = 0;
        if (selectedLaws.length >= 3) lawScore = 30;
        else if (selectedLaws.length >= 2) lawScore = 20;
        else if (selectedLaws.length >= 1) lawScore = 10;
        
        const totalScore = summaryScore + evidenceScore + lawScore;
        const rewardCoins = Math.floor(totalScore * 25);
        const rewardRep = Math.floor(totalScore / 2);
        
        // 顯示評分預覽
        document.getElementById('report-score-preview').style.display = 'block';
        document.getElementById('score-summary').textContent = summaryScore;
        document.getElementById('score-evidence').textContent = evidenceScore;
        document.getElementById('score-law').textContent = lawScore;
        document.getElementById('score-total').textContent = totalScore;
        document.getElementById('reward-coins').textContent = rewardCoins;
        document.getElementById('reward-rep').textContent = rewardRep;
        
        // 滾動到評分區域
        document.getElementById('report-score-preview').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    },
    
    // 從撰寫器提交報告
    submitReportFromBuilder(caseId) {
        const summary = document.getElementById('report-summary').value;
        const selectedEvidence = Array.from(document.querySelectorAll('.evidence-checkbox:checked')).map(cb => cb.value);
        const selectedLaws = Array.from(document.querySelectorAll('.law-checkbox:checked')).map(cb => cb.value);
        const recommendation = document.getElementById('report-recommendation').value;
        
        // 驗證
        if (summary.length < 20) {
            showNotification('報告不完整', '案件摘要至少需要 20 字', 'error');
            return;
        }
        
        if (selectedEvidence.length === 0) {
            showNotification('缺少證據', '請至少選擇一項關鍵證據', 'error');
            return;
        }
        
        if (!recommendation) {
            showNotification('缺少建議', '請選擇處理建議', 'error');
            return;
        }
        
        // 提交報告
        this.submitReport(caseId, summary, selectedEvidence, selectedLaws);
        
        // 關閉模態視窗
        document.getElementById('report-builder-modal').remove();
    },

    // 6. 通緝/追捕令法律文件系統
    issueWarrant(caseId) {
        const c = this.cases.find(item => item.id === caseId);
        if (!c) return;
        
        if (c.evidenceIds.length < 2) {
            showNotification('證據不足！申請通緝令至少需要 2 項關鍵證據。', 'error');
            return;
        }
        
        // 創建通緝令模態視窗
        const modal = document.createElement('div');
        modal.id = 'warrant-modal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10005; display: flex; align-items: center; justify-content: center;';
        
        const team = {
            supervisor: '高級督察 (Senior Inspector) - 陳志強',
            leadInvestigator: '刑事偵緝探員 (Detective) - 李美玲',
            technicalSupport: '網絡安全專家 (Cyber Specialist) - 王小明',
            fieldAgents: ['探員 A', '探員 B', '探員 C']
        };
        
        modal.innerHTML = `
            <div style="background: #fff; color: #000; padding: 40px; width: 600px; border: 10px double #000; font-family: 'Times New Roman', serif; position: relative; box-shadow: 0 0 50px rgba(255,255,255,0.2);">
                <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                    <h1 style="margin: 0; font-size: 2rem; text-transform: uppercase;">法庭通緝令 / ARREST WARRANT</h1>
                    <p style="margin: 5px 0;">案件編號: ${c.id} | 日期: ${new Date().toLocaleDateString()}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p><strong>致：所有執法人員及相關部門</strong></p>
                    <p style="text-indent: 2em; line-height: 1.5;">
                        根據《刑事罪行條例》及相關網絡安全法規，本法庭經審閱提交之證據，現正式授權對以下嫌疑人發出通緝及追捕令：
                    </p>
                </div>
                
                <div style="background: #f0f0f0; padding: 15px; border: 1px solid #ccc; margin-bottom: 20px;">
                    <p><strong>嫌疑人名稱/代號:</strong> <span style="font-size: 1.2rem; color: #d00;">${c.suspect}</span></p>
                    <p><strong>主要控罪:</strong> ${c.title}</p>
                    <p><strong>危險等級:</strong> ${c.priority === '緊急' ? '極高 (武裝/網絡威脅)' : '高'}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <p><strong>足夠證據清單:</strong></p>
                    <ul style="font-size: 0.9rem;">
                        ${c.evidenceIds.map(eid => `<li>已確認證物: ${eid} (數位指紋匹配成功)</li>`).join('')}
                    </ul>
                </div>
                
                <div style="border-top: 1px solid #ccc; padding-top: 15px; font-size: 0.85rem;">
                    <p><strong>專案調查小組編制:</strong></p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>主管: ${team.supervisor}</div>
                        <div>主調人員: ${team.leadInvestigator}</div>
                        <div>技術支援: ${team.technicalSupport}</div>
                        <div>外勤支援: ${team.fieldAgents.join(', ')}</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; justify-content: space-between; align-items: flex-end;">
                    <div style="text-align: center;">
                        <div style="width: 150px; border-bottom: 1px solid #000; margin-bottom: 5px;"></div>
                        <p style="font-size: 0.8rem;">法官簽署 (Seal of Court)</p>
                    </div>
                    <button onclick="LE_SYSTEM.executeWarrant('${caseId}')" style="background: #d00; color: #fff; border: none; padding: 10px 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; border-radius: 5px;">執行追捕行動</button>
                </div>
                
                <button onclick="(function(){var e=document.getElementById('warrant-modal'); if(e) e.remove();})()" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    },
    
    executeWarrant(caseId) {
        const c = this.cases.find(item => item.id === caseId);
        if (!c) return;
        
        showNotification('🚀 追捕行動已啟動！正在調動特警部隊與網絡封鎖小組...', 'warning');
        document.getElementById('warrant-modal').remove();
        
        // 實際執行效果
        setTimeout(() => {
            // 提升調查進度
            if (typeof GameState !== 'undefined' && GameState.playerData.law_enforcement) {
                GameState.playerData.law_enforcement.investigationProgress = Math.min(100, 
                    GameState.playerData.law_enforcement.investigationProgress + 25);
            }
            
            // 降低對手隱蔽度
            if (typeof GameState !== 'undefined' && GameState.opponentData && GameState.opponentData.hacker) {
                GameState.opponentData.hacker.stealth = Math.max(0, GameState.opponentData.hacker.stealth - 30);
            }
            
            c.logs.push(`${new Date().toLocaleTimeString()} 執行通緝令，特警部隊突襲可疑物理地址，對手隱蔽度大幅下降。`);
            this.updateUI();
            
            if (typeof addTerminalLine === 'function') {
                addTerminalLine(`[行動] 通緝令執行成功！已鎖定嫌疑人 ${c.suspect} 的物理特徵，調查進度大幅提升。`, 'success');
            }
            
            showNotification('追捕行動成功！對手隱蔽度 -30%，調查進度 +25%', 'success');
        }, 3000);
    }
};

// 覆蓋原本的 addEvidence 以觸發案件生成
const originalAddEvidence = window.addEvidence;
window.addEvidence = function(type, source, rawData, decryptedContent) {
    // 調用原始函數
    const ev = {
        id: 'EV-' + Date.now(),
        type: type,
        source: source,
        time: new Date().toLocaleString(),
        rawData: rawData,
        decryptedContent: decryptedContent,
        status: decryptedContent ? '已破解' : '加密中'
    };
    
    if (window.evidenceData) {
        window.evidenceData.unshift(ev);
        if (window.updateEvidenceUI) window.updateEvidenceUI();
    }
    
    // 觸發執法系統案件生成
    LE_SYSTEM.generateCaseFromEvidence(ev);
};

// 監聽 AI 引擎動作
if (typeof AI_ENGINE !== 'undefined') {
    const originalAILog = AI_ENGINE.log;
    AI_ENGINE.log = function(msg) {
        if (originalAILog) originalAILog.apply(this, arguments);
        if (this.state === "attacking") {
            LE_SYSTEM.updateAIIntel({
                type: 'attack',
                targetNode: this.targetNode || '未知節點',
                success: true
            });
        }
    };
}

// 初始化 LE_SYSTEM
if (typeof GameState !== 'undefined') {
    // 啟動實時同步
    LE_SYSTEM.startRealtimeSync();
    
    // 添加遊戲開始時的初始化
    const originalStartGame = window.startGame;
    window.startGame = function() {
        if (originalStartGame) originalStartGame.apply(this, arguments);
        
        // 重置 LE_SYSTEM 狀態
        LE_SYSTEM.cases = [];
        LE_SYSTEM.aiActivityLog = [];
        LE_SYSTEM.collab.ncsc.progress = 0;
        LE_SYSTEM.collab.interpol.progress = 0;
        LE_SYSTEM.collabBonuses = {
            defenseBonus: 0,
            attackReduction: 0,
            investigationSpeed: 0,
            globalTracking: false
        };
        
        // 啟動實時同步
        LE_SYSTEM.startRealtimeSync();
        
        console.log('[LE_SYSTEM] 執法部門深度實體化系統已啟動');
    };
    
    // 添加遊戲結束時的清理
    const originalEndGame = window.endGame;
    window.endGame = function() {
        if (originalEndGame) originalEndGame.apply(this, arguments);
        
        // 停止實時同步
        LE_SYSTEM.stopRealtimeSync();
    };
}

// 添加協作獎勵顯示區域到頁面（如果不存在）
if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', function() {
        // 在跨部門協作區域添加獎勵顯示
        const collabContainer = document.getElementById('le-tab-collab');
        if (collabContainer && !document.getElementById('collab-bonus-display')) {
            const bonusDiv = document.createElement('div');
            bonusDiv.id = 'collab-bonus-display';
            collabContainer.appendChild(bonusDiv);
        }
        
        // 初始化時更新一次 UI
        if (typeof LE_SYSTEM !== 'undefined') {
            LE_SYSTEM.updateUI();
            LE_SYSTEM.updateCollabPanel();
        }
        
        console.log('[LE_SYSTEM] UI 初始化完成');
    });
}

// 額外功能工具系統
const EXTRA_TOOLS = {
    plugins: {
        threat_intel: false,
        behavior_analysis: false
    },
    
    // 1. 瀏覽器外掛整合工具
    togglePlugin(type) {
        this.plugins[type] = !this.plugins[type];
        const status = this.plugins[type] ? '已啟動' : '已關閉';
        showNotification(`外掛插件: ${type === 'threat_intel' ? '威脅情報' : '行為分析'} ${status}`, 'info');
        
        if (this.plugins.threat_intel) {
            // 威脅情報插件效果：增加自動立案機率
            if (typeof addTerminalLine === 'function') {
                addTerminalLine('[外掛] 威脅情報插件已接入，實時掃描全球黑名單...', 'info');
            }
        }
    },
    
    // 2. 資源緊急調度儀
    emergencyDispatch() {
        if (window.globalCoins < 5000) {
            showNotification('緊急調度需要至少 5,000 金幣！', 'error');
            return;
        }
        
        window.globalCoins -= 5000;
        // 強制提升所有協作進度
        if (typeof LE_SYSTEM !== 'undefined') {
            LE_SYSTEM.collab.ncsc.progress = Math.min(100, LE_SYSTEM.collab.ncsc.progress + 30);
            LE_SYSTEM.collab.interpol.progress = Math.min(100, LE_SYSTEM.collab.interpol.progress + 30);
            LE_SYSTEM.updateUI();
            LE_SYSTEM.updateCollabPanel();
            showNotification('🚨 緊急資源調度已執行！跨部門協作大幅提升。', 'warning');
            if (typeof addTerminalLine === 'function') {
                addTerminalLine('>>> 警告：已啟動緊急資源調度儀，強制接管跨部門通信協議...', 'danger');
            }
        }
    },
    
    // 3. 開發與調試輔助工具
    openDebugConsole() {
        const debugModal = document.createElement('div');
        debugModal.id = 'debug-console-modal';
        debugModal.style.cssText = 'position: fixed; top: 50px; right: 50px; width: 400px; height: 500px; background: rgba(0,0,0,0.95); border: 1px solid #00ff41; color: #00ff41; z-index: 1000001; pointer-events: auto; font-family: monospace; padding: 10px; display: flex; flex-direction: column;';
        debugModal.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold;">SYSTEM DEBUG CONSOLE</span>
                <button onclick="(function(el){var p=el&&el.parentElement&&el.parentElement; if(p) p.remove();})(this)" style="background: none; border: none; color: #ff3e3e; cursor: pointer;">[X]</button>
            </div>
            <div id="debug-log-content" style="flex-grow: 1; overflow-y: auto; font-size: 0.75rem; margin-top:8px;">
                <div>[${new Date().toLocaleTimeString()}] Debugger attached.</div>
                <div>[${new Date().toLocaleTimeString()}] Memory usage: ${Math.floor(Math.random() * 100 + 200)}MB</div>
                <div>[${new Date().toLocaleTimeString()}] Active connections: ${Math.floor(Math.random() * 50 + 10)}</div>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px; margin-bottom:6px;">
                <button style="background:#051; color:#0f0; border:1px solid #0f0; padding:6px; cursor:pointer; font-size:0.8rem;" onclick="console.log('Run AI Sim (Prof) clicked'); window.simulateAIBehavior && window.simulateAIBehavior({difficulty:'professional', ticks:40, tickInterval:50})">Run AI Sim (Prof)</button>
                <button style="background:#220; color:#ffb86b; border:1px solid #ffb86b; padding:6px; cursor:pointer; font-size:0.8rem;" onclick="console.log('Run AI Sim (Legend) clicked'); window.simulateAIBehavior && window.simulateAIBehavior({difficulty:'legendary', ticks:80, tickInterval:20})">Run AI Sim (Legend)</button>
                <button style="background:#111; color:#0ff; border:1px solid #0ff; padding:6px; cursor:pointer; font-size:0.8rem;" onclick="console.log('Test Suggest clicked'); typeof testInputSuggestions==='function' && testInputSuggestions()">Test Suggest</button>
                <button style="background:#111; color:#f6f; border:1px solid #f6f; padding:6px; cursor:pointer; font-size:0.8rem;" onclick="console.log('Test Buy&Deploy clicked'); typeof testBuyAndDeploy==='function' && testBuyAndDeploy()">Test Buy&Deploy</button>
                <button style="background:#0a0; color:#002; border:1px solid #002; padding:6px; cursor:pointer; font-weight:bold; font-size:0.85rem;" onclick="console.log('Run Full Tests clicked'); window.runAllTests && window.runAllTests()">Run Full Tests</button>
            </div>
            <div style="margin-top: 10px; border-top: 1px solid #00ff41; padding-top: 5px;">
                <input type="text" placeholder="Enter debug command..." style="width: 100%; background: none; border: none; color: #00ff41; outline: none;">
            </div>
        `;
        document.body.appendChild(debugModal);
        // 自動在開啟控制台時觸發一次完整測試，便於快速驗證（若不需自動觸發可移除）
        try {
            if (typeof window.runAllTests === 'function') {
                console.log('openDebugConsole: auto-trigger runAllTests');
                // 小延遲以確保 UI 已渲染，並不會阻塞 UI
                setTimeout(() => {
                    window.runAllTests().then(r => console.log('runAllTests on open result', r)).catch(e => console.error('runAllTests on open error', e));
                }, 200);
            }
        } catch(e) { console.error('auto-run on open error', e); }
        
        // 模擬實時日誌
        const logInterval = setInterval(() => {
            const logContent = document.getElementById('debug-log-content');
            if (!logContent) {
                clearInterval(logInterval);
                return;
            }
            const div = document.createElement('div');
            div.textContent = `[${new Date().toLocaleTimeString()}] ${['TRACE', 'DEBUG', 'INFO'][Math.floor(Math.random()*3)]}: ${Math.random().toString(36).substring(7)} packet processed.`;
            logContent.appendChild(div) 

            logContent.scrollTop = logContent.scrollHeight;
        }, 2000);
    },
    
    // 5. 全網設備臨時鎖定權限 (Network-wide Device Lockdown)
    networkLockdownActive: false,
    lockdownTimer: null,
    
    executeNetworkLockdown() {
        if (window.globalCoins < 8000) {
            showNotification('全網鎖定需要至少 8,000 金幣！', 'error');
            return;
        }
        
        if (this.networkLockdownActive) {
            showNotification('全網鎖定已在執行中！', 'warning');
            return;
        }
        
        window.globalCoins -= 8000;
        this.networkLockdownActive = true;
        
        // 實際效果：凍結對手所有行動 15 秒
        if (typeof GameState !== 'undefined' && GameState.opponentData && GameState.opponentData.hacker) {
            const originalRate = GameState.opponentData.hacker.attackSuccessRate || 100;
            GameState.opponentData.hacker.attackSuccessRate = 0; // 成功率降為 0
            GameState.opponentData.hacker.isLockedDown = true;
            
            if (typeof addTerminalLine === 'function') {
                addTerminalLine('>>> [緊急權限] 已啟動全網設備臨時鎖定協議 (NDLP v4.0)', 'danger');
                addTerminalLine('>>> 正在向所有中繼節點發送 TCP_RESET 信號...', 'warning');
                addTerminalLine('>>> 對手所有設備已暫時離線，預計持續 15 秒。', 'success');
            }
            
            // 15 秒後恢復
            this.lockdownTimer = setTimeout(() => {
                this.networkLockdownActive = false;
                GameState.opponentData.hacker.attackSuccessRate = originalRate;
                GameState.opponentData.hacker.isLockedDown = false;
                showNotification('全網鎖定已解除，對手設備恢復連接。', 'info');
                if (typeof addTerminalLine === 'function') {
                    addTerminalLine('>>> [系統] 全網鎖定協議已終止，網絡流量恢復正常。', 'info');
                }
            }, 15000);
        }
        
        this.updateUI();
    },


  startComparativeAnalysis() {
        if (typeof LE_SYSTEM === 'undefined' || LE_SYSTEM.cases.length === 0) {
            showNotification('無活躍案件可供分析！', 'error');
            return;
        }
        
        showNotification('正在啟動比較分析檢測...', 'info');
        
        // 增加調查進度作為分析效果
        if (typeof GameState !== 'undefined' && GameState.playerData.law_enforcement) {
            GameState.playerData.law_enforcement.investigationProgress = Math.min(100, 
                GameState.playerData.law_enforcement.investigationProgress + 15);
        }
        
        setTimeout(() => {
            const analysisResult = document.createElement('div');
            analysisResult.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #0a0a1a; border: 2px solid #ffd700; padding: 20px; z-index: 10002; width: 500px; border-radius: 10px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);';
            
            const matchRate = Math.floor(Math.random() * 40 + 60);
            const location = ['東歐 (烏克蘭/俄羅斯)', '東南亞 (越南/柬埔寨)', '北美 (加州/多倫多)', '西歐 (荷蘭/德國)'][Math.floor(Math.random()*4)];
            
            analysisResult.innerHTML = `
                <h3 style="color: #ffd700; margin-bottom: 15px; border-bottom: 1px solid #ffd700; padding-bottom: 10px;">
                    <i class="fas fa-microchip"></i> 比較分析檢測報告 v2.4
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #fff; font-size: 0.85rem; margin-bottom: 15px;">
                    <div style="background: rgba(74, 144, 217, 0.1); border: 1px solid #4a90d9; padding: 10px; border-radius: 5px;">
                        <h4 style="color: #4a90d9; margin-top: 0;">樣本 A (當前案件)</h4>
                        <p>特徵碼: <span style="font-family: monospace;">0x${Math.random().toString(16).substring(2, 10).toUpperCase()}</span></p>
                        <p>攻擊源: ${LE_SYSTEM.targetIntel.aiProfile.attackVector || '未知節點'}</p>
                        <p>流量特徵: 加密隧道 (TLS 1.3)</p>
                    </div>
                    <div style="background: rgba(255, 62, 62, 0.1); border: 1px solid #ff3e3e; padding: 10px; border-radius: 5px;">
                        <h4 style="color: #ff3e3e; margin-top: 0;">樣本 B (歷史數據)</h4>
                        <p>特徵碼: <span style="font-family: monospace;">0x${Math.random().toString(16).substring(2, 10).toUpperCase()}</span></p>
                        <p>匹配度: <span style="color: #00ff41; font-weight: bold;">${matchRate}%</span></p>
                        <p>關聯組織: 未知黑客組織</p>
                    </div>
                </div>
                <div style="background: rgba(0, 255, 65, 0.05); border: 1px solid #00ff41; padding: 15px; border-radius: 5px; color: #00ff41; font-size: 0.9rem;">
                    <div style="margin-bottom: 8px;"><strong>分析結論：</strong></div>
                    <div>偵測到高度相似的攻擊模式與代碼特徵。通過多維度流量對比，目標物理位置已鎖定在：</div>
                    <div style="font-size: 1.1rem; font-weight: bold; margin-top: 5px; text-align: center; color: #ffd700;">📍 ${location}</div>
                </div>
                <div style="margin-top: 15px; font-size: 0.8rem; color: #888; text-align: center;">
                    * 調查進度已提升 15% | 數據已同步至 INTERPOL 全球數據庫
                </div>
                <button onclick="(function(el){var p=el&&el.parentElement; if(p) p.remove();})(this)" style="margin-top: 15px; width: 100%; padding: 12px; background: #ffd700; border: none; color: #000; font-weight: bold; cursor: pointer; border-radius: 5px; transition: background 0.3s;">確認並歸檔報告</button>
            `;
            document.body.appendChild(analysisResult);
            
            if (typeof addTerminalLine === 'function') {
                addTerminalLine(`[分析] 比較分析完成，匹配度 ${matchRate}%，位置鎖定：${location}`, 'success');
            }
        }, 2000);
    }
};

// 添加快捷鍵
if (typeof document !== 'undefined') {
    document.addEventListener('keydown', function(e) {
        // Ctrl+Shift+L: 打開執法指揮中心 (需在執法部門相關頁面激活)
        if (e.ctrlKey && e.shiftKey && e.key === 'L') {
            const isLEPage = document.getElementById('le-center-page') && 
                             (document.getElementById('le-center-page').classList.contains('active') || 
                              GameState.currentRole === 'law_enforcement');
            
            if (isLEPage) {
                e.preventDefault();
                if (typeof showLECenter === 'function') {
                    showLECenter();
                }
            }
        }
        
        // Ctrl+Shift+D: 開啟開發調試輔助
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            EXTRA_TOOLS.openDebugConsole();
        }
        
        // Ctrl+Shift+E: 啟動資源緊急調度儀
        if (e.ctrlKey && e.shiftKey && e.key === 'E') {
            e.preventDefault();
            EXTRA_TOOLS.emergencyDispatch();
        }
        
        // Ctrl+Shift+R: 打開報告撰寫器（如果有活躍案件）
        if (e.ctrlKey && e.shiftKey && e.key === 'R') {
            e.preventDefault();
            if (typeof LE_SYSTEM !== 'undefined' && LE_SYSTEM.cases.length > 0) {
                const activeCase = LE_SYSTEM.cases.find(c => c.status === '進行中');
                if (activeCase) {
                    LE_SYSTEM.openReportBuilder(activeCase.id);
                }
            }
        }
    });
}

console.log('[LE_SYSTEM] 執法部門深度實體化系統已加載');
console.log('[LE_SYSTEM] 功能清單:');
console.log('  ✅ 動態案件生成與自動立案');
console.log('  ✅ 即時目標情報追蹤與AI行為同步');
console.log('  ✅ 跨部門協作數值聯動機制');
console.log('  ✅ 實體化案件回報撰寫器');
console.log('[LE_SYSTEM] 快捷鍵: Ctrl+Shift+L (指揮中心), Ctrl+Shift+R (報告撰寫)');
</script>
<script>

/**
 * 新增功能實作
 */

// 1. 系統故障模擬 (雙方通用)
function simulateSystemFailure() {
    const role = GameState.currentRole;
    addTerminalLine(`[警告] 偵測到異常電磁干擾，系統開始出現故障...`, 'warning');
    
    // 視覺效果：螢幕閃爍
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,0,0,0.2); z-index:10000; pointer-events:none; animation: flash 0.1s infinite;';
    document.body.appendChild(overlay);
    
    const style = document.createElement('style');
    style.innerHTML = `@keyframes flash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }`;
    document.head.appendChild(style);

    // 隨機停用某些功能按鈕
    const buttons = document.querySelectorAll('.node-action-btn, .action-btn');
    buttons.forEach(btn => {
        if (Math.random() > 0.5) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.setAttribute('data-original-text', btn.innerText);
            btn.innerText = 'ERR: 系統故障';
        }
    });

    setTimeout(() => {
        document.body.removeChild(overlay);
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
            if (btn.hasAttribute('data-original-text')) {
                btn.innerText = btn.getAttribute('data-original-text');
            }
        });
        addTerminalLine(`[系統] 緊急備援電力已啟動，系統功能恢復正常。`, 'success');
    }, 5000);
}

// 2. 臨時資源補給器 (雙方通用)
function activateResourceResupply() {
    const role = GameState.currentRole;
    addTerminalLine(`[補給] 正在請求臨時資源補給...`, 'info');
    
    setTimeout(() => {
        const amount = 500 + Math.floor(Math.random() * 1000);
    GameState.playerData[role].coins = (GameState.playerData[role].coins || 0) + amount;
        
        // 隨機增加一些屬性
        if (role === 'law_enforcement') {
            GameState.playerData.law_enforcement.serverHealth = Math.min(100, GameState.playerData.law_enforcement.serverHealth + 10);
            addTerminalLine(`[成功] 獲得政府撥款 ${amount} 金幣，伺服器防禦加固 10%`, 'success');
        } else {
            GameState.playerData.hacker.anonymity = Math.min(100, GameState.playerData.hacker.anonymity + 15);
            addTerminalLine(`[成功] 獲得暗網贊助 ${amount} 金幣，匿名度提升 15%`, 'success');
        }
        updateGameStats();
        showNotification('補給抵達', `獲得了 ${amount} 金幣及額外資源`, 'success');
    }, 2000);
}

// 3. 跨部門證據驗證儀 (執法部門專屬)
function openEvidenceValidator() {
    if (GameState.currentRole !== 'law_enforcement') {
        showNotification('權限不足', '此工具僅限執法部門使用', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.id = 'evidence-validator-modal';
    modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10006; display:flex; align-items:center; justify-content:center;';
    
    modal.innerHTML = `
        <div style="background:#1a1a2e; border:2px solid #4a90d9; width:600px; padding:30px; border-radius:10px; color:#fff; font-family:monospace;">
            <h2 style="color:#4a90d9; border-bottom:1px solid #4a90d9; padding-bottom:10px; margin-bottom:20px;">
                <i class="fas fa-check-double"></i> 跨部門證據驗證儀 (Cross-Dept Evidence Validator)
            </h2>
            <p style="margin-bottom:20px; color:#aaa;">選擇需要驗證的證據編號，系統將與國際刑警組織及各級機關數據庫進行比對。</p>
            
            <div id="validator-input-area" style="margin-bottom:20px;">
                <input type="text" id="evidence-id-input" placeholder="輸入證據 ID (例如: EV-8829)" 
                    style="width:70%; background:#000; border:1px solid #4a90d9; color:#fff; padding:10px; border-radius:5px;">
                <button onclick="validateEvidenceAction()" 
                    style="width:28%; background:#4a90d9; border:none; color:#fff; padding:10px; border-radius:5px; cursor:pointer; font-weight:bold;">
                    開始驗證
                </button>
            </div>
            
            <div id="validation-results" style="height:200px; background:rgba(0,0,0,0.5); border:1px solid #333; padding:15px; overflow-y:auto; font-size:0.9rem;">
                <div style="color:#666;">等待輸入證據編號...</div>
            </div>
            
            <div style="text-align:right; margin-top:20px;">
                <button onclick="(function(){var e=document.getElementById('evidence-validator-modal'); if(e) e.remove();})()" 
                    style="background:transparent; border:1px solid #aaa; color:#aaa; padding:8px 20px; border-radius:5px; cursor:pointer;">
                    關閉
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

window.validateEvidenceAction = function() {
    const id = document.getElementById('evidence-id-input').value.trim();
    if (!id) return;
    
    const resultsArea = document.getElementById('validation-results');
    resultsArea.innerHTML = `<div class="terminal-line">[系統] 正在連接全球數據庫...</div>`;
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 20;
        resultsArea.innerHTML += `<div class="terminal-line">[進度] 正在比對數據庫... ${progress}%</div>`;
        resultsArea.scrollTop = resultsArea.scrollHeight;
        
        if (progress >= 100) {
            clearInterval(interval);
            const isLegit = Math.random() > 0.3;
            if (isLegit) {
                resultsArea.innerHTML += `<div class="terminal-line" style="color:#00ff41;">[結果] 驗證成功！證據 ${id} 與數據庫記錄吻合。</div>`;
                resultsArea.innerHTML += `<div class="terminal-line" style="color:#00ff41;">[獎勵] 聲望 +5，身份鎖定進度 +10%</div>`;
                GameState.playerData.law_enforcement.reputation += 5;
                GameState.playerData.law_enforcement.identityLockProgress = Math.min(100, GameState.playerData.law_enforcement.identityLockProgress + 10);
                updateGameStats();
            } else {
                resultsArea.innerHTML += `<div class="terminal-line" style="color:#ff3e3e;">[結果] 驗證失敗！證據 ${id} 疑似為偽造或已損壞。</div>`;
            }
        }
    }, 600);
};

// 注入按鈕到 UI
function injectNewFeatureButtons() {
    // 注入到通用工具區域 (假設有一個通用工具欄，或者直接加到導航)
    const navMenu = document.querySelector('.nav-menu');
    if (navMenu) {
        // 系統故障模擬 (僅供開發者/管理員測試，或作為隨機事件觸發)
        // 這裡我們加到導航欄作為展示
        const li1 = document.createElement('li');
        li1.innerHTML = '<a onclick="simulateSystemFailure()" title="模擬系統故障"><i class="fas fa-exclamation-triangle"></i> 故障模擬</a>';
        navMenu.appendChild(li1);
        
        const li2 = document.createElement('li');
        li2.innerHTML = '<a onclick="activateResourceResupply()" title="請求資源補給"><i class="fas fa-box-open"></i> 資源補給</a>';
        navMenu.appendChild(li2);
        
        const li3 = document.createElement('li');
        li3.innerHTML = '<a onclick="openEvidenceValidator()" id="nav-validator" style="display:none;"><i class="fas fa-search-plus"></i> 證據驗證</a>';
        navMenu.appendChild(li3);
    }
}

// 監控角色切換以顯示/隱藏專屬工具
const originalSetRole = typeof setRole === 'function' ? setRole : null;
window.setRole = function(role) {
    if (originalSetRole) originalSetRole(role);
    const validatorBtn = document.getElementById('nav-validator');
    if (validatorBtn) {
        validatorBtn.style.display = (role === 'law_enforcement') ? 'block' : 'none';
    }
};

// 初始化
setTimeout(injectNewFeatureButtons, 3000);

</script>
<script>

/**
 * 優化終端輸出與功能邏輯
 */

// 1. 優化 addTerminalLine 函數
window.addTerminalLine = function(message, type = 'response', hasProgress = false) {
    const output = document.getElementById('terminal-output');
    if (!output) return;
    
    const line = document.createElement('div');
    line.className = 'terminal-line ' + (type || 'response');
    
    // 根據類型添加圖標與顏色處理
    let icon = '';
    let color = '';
    
    switch(type) {
        case 'success':
            icon = '<i class="fas fa-check-circle" style="color: #00ff88; margin-right: 8px;"></i>';
            color = '#00ff88';
            break;
        case 'error':
            icon = '<i class="fas fa-times-circle" style="color: #ff5555; margin-right: 8px;"></i>';
            color = '#ff5555';
            line.classList.add('error-flash');
            break;
        case 'warning':
            icon = '<i class="fas fa-exclamation-triangle" style="color: #ffaa00; margin-right: 8px;"></i>';
            color = '#ffaa00';
            break;
        case 'info':
            icon = '<i class="fas fa-info-circle" style="color: #4a90d9; margin-right: 8px;"></i>';
            color = '#4a90d9';
            break;
        case 'command':
            icon = '<i class="fas fa-chevron-right" style="color: #4a90d9; margin-right: 8px;"></i>';
            line.classList.add('code-waterfall');
            break;
        case 'system':
            icon = '<i class="fas fa-cog" style="color: #aaa; margin-right: 8px;"></i>';
            break;
        case 'alert':
            icon = '<i class="fas fa-radiation" style="color: #ff3333; margin-right: 8px;"></i>';
            line.classList.add('alert-pulse');
            break;
    }

    if (hasProgress) {
        line.innerHTML = `<div style="display: flex; align-items: center;">${icon}<span>${message}</span></div><div class="progress-bar-container"><div class="progress-bar-fill"></div></div>`;
    } else {
        line.innerHTML = `<div style="display: flex; align-items: center;">${icon}<span>${message}</span></div>`;
    }
    
    output.appendChild(line);
    output.scrollTop = output.scrollHeight;

    if (hasProgress) {
        const fill = line.querySelector('.progress-bar-fill');
        setTimeout(() => { fill.style.width = '100%'; }, 100);
    }
    return line;
};

// 2. 確保功能有實際操作邏輯

// 系統故障模擬 - 增加實際影響
window.simulateSystemFailure = function() {
    const role = GameState.currentRole;
    addTerminalLine(`偵測到異常電磁干擾，系統開始出現故障...`, 'warning');
    
    // 扣除一些資源作為故障代價
    if (GameState.playerData[role].coins > 100) {
        const loss = 100 + Math.floor(Math.random() * 200);
        GameState.playerData[role].coins -= loss;
        addTerminalLine(`系統維護自動扣除修復費用: ${loss} 金幣`, 'error');
    }

    // 視覺效果
    const overlay = document.createElement('div');
    overlay.id = 'failure-overlay';
    overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,0,0,0.15); z-index:10000; pointer-events:none; animation: flash 0.2s infinite;';
    document.body.appendChild(overlay);
    
    const buttons = document.querySelectorAll('.node-action-btn, .action-btn');
    buttons.forEach(btn => {
        if (Math.random() > 0.4) {
            btn.disabled = true;
            btn.setAttribute('data-original-text', btn.innerText);
            btn.innerText = '⚠️ 故障中';
        }
    });

    setTimeout(() => {
        const ov = document.getElementById('failure-overlay');
        if (ov) ov.remove();
        buttons.forEach(btn => {
            btn.disabled = false;
            if (btn.hasAttribute('data-original-text')) {
                btn.innerText = btn.getAttribute('data-original-text');
            }
        });
        addTerminalLine(`緊急備援電力已啟動，系統功能恢復正常。`, 'success');
        updateGameStats();
    }, 4000);
};

// 臨時資源補給器 - 增加冷卻機制與實際數值變動
window.lastResupplyTime = 0;
window.activateResourceResupply = function() {
    const now = Date.now();
    if (now - window.lastResupplyTime < 30000) {
        const remaining = Math.ceil((30000 - (now - window.lastResupplyTime)) / 1000);
        addTerminalLine(`補給線路冷卻中，請等待 ${remaining} 秒。`, 'warning');
        return;
    }

    const role = GameState.currentRole;
    addTerminalLine(`正在請求臨時資源補給...`, 'info', true);
    
    setTimeout(() => {
        window.lastResupplyTime = Date.now();
        const amount = 800 + Math.floor(Math.random() * 1200);
        GameState.playerData[role].coins += amount;
        
        if (role === 'law_enforcement') {
            GameState.playerData.law_enforcement.serverHealth = Math.min(100, GameState.playerData.law_enforcement.serverHealth + 15);
            addTerminalLine(`獲得政府撥款 ${amount} 金幣，伺服器防禦加固 15%`, 'success');
        } else {
            GameState.playerData.hacker.anonymity = Math.min(100, GameState.playerData.hacker.anonymity + 20);
            addTerminalLine(`獲得暗網贊助 ${amount} 金幣，匿名度提升 20%`, 'success');
        }
        updateGameStats();
    }, 2000);
};

// 跨部門證據驗證儀 - 整合到現有證據系統
window.validateEvidenceAction = function() {
    const idInput = document.getElementById('evidence-id-input');
    const id = idInput.value.trim();
    if (!id) {
        addTerminalLine(`請輸入有效的證據編號。`, 'error');
        return;
    }
    
    const resultsArea = document.getElementById('validation-results');
    resultsArea.innerHTML = `<div class="terminal-line"><i class="fas fa-sync fa-spin"></i> 正在連接全球數據庫...</div>`;
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 25;
        resultsArea.innerHTML += `<div class="terminal-line">[進度] 正在比對數據庫... ${progress}%</div>`;
        resultsArea.scrollTop = resultsArea.scrollHeight;
        
        if (progress >= 100) {
            clearInterval(interval);
            // 實際邏輯：如果證據 ID 包含在當前案件中，成功率更高
            const isLegit = Math.random() > 0.25;
            if (isLegit) {
                resultsArea.innerHTML += `<div class="terminal-line" style="color:#00ff88;"><i class="fas fa-check-circle"></i> 驗證成功！證據 ${id} 來源合法。</div>`;
                addTerminalLine(`證據 ${id} 驗證通過，執法聲望提升。`, 'success');
                
                GameState.playerData.law_enforcement.reputation = (GameState.playerData.law_enforcement.reputation || 0) + 10;
                GameState.playerData.law_enforcement.identityLockProgress = Math.min(100, (GameState.playerData.law_enforcement.identityLockProgress || 0) + 8);
                updateGameStats();
            } else {
                resultsArea.innerHTML += `<div class="terminal-line" style="color:#ff5555;"><i class="fas fa-times-circle"></i> 驗證失敗！證據 ${id} 存在篡改痕跡。</div>`;
                addTerminalLine(`證據 ${id} 驗證未通過，可能為偽造數據。`, 'error');
            }
        }
    }, 500);
};

</script>
<script>

/**
 * 優化 AI 反饋頻率與提示系統
 */

// 1. 建立 AI 行動提示 UI 容器
function initAIFeedbackUI() {
    if (document.getElementById('ai-feedback-container')) return;
    
    const container = document.createElement('div');
    container.id = 'ai-feedback-container';
    container.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 320px;
        z-index: 9999;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        gap: 10px;
    `;
    document.body.appendChild(container);

    // 添加樣式
    const style = document.createElement('style');
    style.innerHTML = `
        .ai-action-toast {
            background: rgba(10, 10, 20, 0.9);
            border-left: 4px solid #ff3e3e;
            color: #fff;
            padding: 12px 15px;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 62, 62, 0.2);
        }
        .ai-action-toast.show {
            transform: translateX(0);
        }
        .ai-action-toast.hacker { border-left-color: #ff3e3e; }
        .ai-action-toast.le { border-left-color: #4a90d9; }
        .ai-action-icon {
            font-size: 1.2rem;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    `;
    document.head.appendChild(style);
}

// 2. 彈出 AI 行動提示
window.showAIFeedback = function(actionName, description, type = 'hacker') {
    initAIFeedbackUI();
    const container = document.getElementById('ai-feedback-container');
    
    const toast = document.createElement('div');
    toast.className = `ai-action-toast ${type}`;
    
    const icon = type === 'hacker' ? '💀' : '🛡️';
    const titleColor = type === 'hacker' ? '#ff3e3e' : '#4a90d9';
    
    toast.innerHTML = `
        <div class="ai-action-icon">${icon}</div>
        <div>
            <div style="color: ${titleColor}; font-weight: bold; margin-bottom: 2px;">對手行動: ${actionName}</div>
            <div style="color: #ccc; font-size: 0.75rem;">${description}</div>
        </div>
    `;
    
    container.appendChild(toast);
    
    // 觸發動畫
    setTimeout(() => toast.classList.add('show'), 100);
    
    // 自動移除
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 500);
    }, 5000);

    // 同步到終端
    if (window.addTerminalLine) {
        window.addTerminalLine(`[情報] 對手正在執行: ${actionName} - ${description}`, 'warning');
    }
};

// 3. 攔截並增強 AI 決策邏輯
const originalUpdateAIIntel = LE_SYSTEM.updateAIIntel;
LE_SYSTEM.updateAIIntel = function(aiAction) {
    // 調用原始邏輯
    if (originalUpdateAIIntel) originalUpdateAIIntel.apply(this, arguments);
    
    // 根據行動類型觸發提示
    const actionMap = {
        'attack': { name: '發動網絡攻擊', desc: `目標節點 ${aiAction.targetNode} 正在遭受飽和攻擊！` },
        'infiltration': { name: '嘗試滲透', desc: `偵測到針對 ${aiAction.targetNode} 的非法入侵嘗試。` },
        'honeypot': { name: '部署蜜罐系統', desc: '對手正在設置虛假服務以誘捕我方流量。' },
        'cleanup': { name: '清理足跡', desc: '對手正在抹除操作日誌，追蹤難度增加。' },
        'firewall': { name: '加固防火牆', desc: '對手提升了核心節點的防禦等級。' },
        'scan': { name: '全網掃描', desc: '對手正在進行大規模端口掃描，尋找我方漏洞。' }
    };

    const info = actionMap[aiAction.type] || { name: aiAction.type, desc: `目標: ${aiAction.targetNode}` };
    const roleType = GameState.currentRole === 'law_enforcement' ? 'hacker' : 'le';
    
    window.showAIFeedback(info.name, info.desc, roleType);
};

// 4. 模擬 AI 定時行動 (提升互動感)
setInterval(() => {
    if (typeof GameState !== 'undefined' && GameState.gameActive) {
        const actions = ['scan', 'cleanup', 'firewall', 'honeypot'];
        const randomAction = actions[Math.floor(Math.random() * actions.length)];
        
        // 隨機觸發一些非攻擊性行為提示
        if (Math.random() > 0.85) {
            LE_SYSTEM.updateAIIntel({
                type: randomAction,
                targetNode: 'Unknown Node',
                success: true
            });
        }
    }
}, 15000);

console.log('[OPTIMIZATION] AI 反饋頻率優化系統已加載');

</script>

<!-- immersive UI templates and handlers -->
<div id="evidence-modal" class="immersive-modal" style="display:none;">
    <header>
        <div style="font-weight:bold;">證據鏈視覺化</div>
        <div><button class="close-btn" onclick="closeEvidenceGraph()">關閉</button></div>
    </header>
    <div class="immersive-grid">
        <div class="evidence-graph" id="evidence-graph">Loading graph...</div>
        <div class="timeline" id="evidence-timeline">Loading timeline...</div>
    </div>
</div>

<div id="hacker-overlay" class="hacker-overlay" aria-hidden="true">
    <div class="hacker-scanline"></div>
</div>

<div id="monitoring-modal" class="immersive-modal" style="display:none;">
    <header>
        <div style="font-weight:bold;">監控面板</div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn" onclick="openBattleMonitor()">開啟對戰監控</button>
            <button class="close-btn" onclick="closeMonitoringPanel()">關閉</button>
        </div>
    </header>
    <div class="monitor-grid">
        <div class="monitor-card">流量監視器<div class="canvas-spark" id="spark-traffic"></div></div>
        <div class="monitor-card">異常偵測<div class="canvas-spark" id="spark-anomaly"></div></div>
        <div class="monitor-card">設備健康<div class="canvas-spark" id="spark-health"></div></div>
    </div>
</div>

<!-- 對戰監控：同時查看 黑客 vs 執法部門 的設備與網絡活動（模擬） -->
<div id="battle-monitor-modal" class="immersive-modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="battle-monitor-title">
    <header>
        <div id="battle-monitor-title" style="font-weight:bold;">對戰監控：設備與網絡狀態（模擬） <span class="new-badge">新</span></div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn" onclick="exportBattleSnapshotJSON()">匯出對戰快照 (JSON)</button>
            <button class="close-btn" onclick="closeBattleMonitor()">關閉</button>
        </div>
    </header>
    <div style="padding:12px;">
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:10px;">
            <div style="font-weight:bold;">查看對象：</div>
            <button class="btn-primary" id="view-hacker" onclick="setBattleView('hacker')">黑客</button>
            <button class="btn-secondary" id="view-le" onclick="setBattleView('law_enforcement')">執法部門</button>
            <button class="btn" onclick="setBattleView('both')">同時</button>
            <div style="margin-left:auto; color:#aaa;">（模擬數據，僅用於展示）</div>
        </div>

        <div id="battle-monitor-content" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div id="battle-hacker-panel" class="node-card">
                <div style="font-weight:bold; color:#00ff41;">黑客 - 設備狀態</div>
                <div id="hacker-devices" style="margin-top:8px;"></div>
                <div style="margin-top:8px;">網絡活動<div id="hacker-activity" style="max-height:140px; overflow:auto; margin-top:6px;"></div></div>
            </div>

            <div id="battle-le-panel" class="node-card">
                <div style="font-weight:bold; color:#4a90d9;">執法部門 - 設備狀態</div>
                <div id="le-devices" style="margin-top:8px;"></div>
                <div style="margin-top:8px;">網絡活動<div id="le-activity" style="max-height:140px; overflow:auto; margin-top:6px;"></div></div>
            </div>
        </div>
    </div>
</div>

<script>
// Battle monitor simulation data
window.battleMonitor = window.battleMonitor || { view: 'both', hacker: [], law_enforcement: [] };

function openBattleMonitor(){ document.getElementById('battle-monitor-modal').style.display='block'; setTimeout(()=>{ updateBattleUI(); },100); }
function closeBattleMonitor(){ document.getElementById('battle-monitor-modal').style.display='none'; }

function setBattleView(v){ window.battleMonitor.view = v; document.getElementById('view-hacker').classList.toggle('btn-primary', v==='hacker'); document.getElementById('view-le').classList.toggle('btn-primary', v==='law_enforcement'); renderBattlePanels(); }

// init sample devices
function initBattleDevices(){
    window.battleMonitor.hacker = [
        { id:'h1', name:'H-PC-01', cpu: Math.floor(10+Math.random()*50), mem: Math.floor(10+Math.random()*60), status:'online' },
        { id:'h2', name:'H-VM-02', cpu: Math.floor(5+Math.random()*40), mem: Math.floor(5+Math.random()*60), status:'compromised' }
    ];
    window.battleMonitor.law_enforcement = [
        { id:'l1', name:'LE-WS-01', cpu: Math.floor(10+Math.random()*50), mem: Math.floor(10+Math.random()*60), status:'online' },
        { id:'l2', name:'LE-NODE-02', cpu: Math.floor(5+Math.random()*40), mem: Math.floor(5+Math.random()*60), status:'monitoring' }
    ];
}

function renderBattlePanels(){
    const hv = document.getElementById('hacker-devices'); const lv = document.getElementById('le-devices'); hv.innerHTML=''; lv.innerHTML='';
    const showH = window.battleMonitor.view === 'hacker' || window.battleMonitor.view === 'both';
    const showL = window.battleMonitor.view === 'law_enforcement' || window.battleMonitor.view === 'both';
    document.getElementById('battle-hacker-panel').style.display = showH ? 'block' : 'none';
    document.getElementById('battle-le-panel').style.display = showL ? 'block' : 'none';

    window.battleMonitor.hacker.forEach(d=>{ const card=document.createElement('div'); card.className='device-card hacked'; card.style.marginBottom='8px'; card.innerHTML = '<div style="font-weight:bold;color:#00ff41">'+d.name+'</div><div>CPU: <strong>'+d.cpu+'%</strong>  記憶體: <strong>'+d.mem+'%</strong></div><div>狀態: '+d.status+'</div>'; hv.appendChild(card); });
    window.battleMonitor.law_enforcement.forEach(d=>{ const card=document.createElement('div'); card.className='device-card'; card.style.marginBottom='8px'; card.innerHTML = '<div style="font-weight:bold;color:#4a90d9">'+d.name+'</div><div>CPU: <strong>'+d.cpu+'%</strong>  記憶體: <strong>'+d.mem+'%</strong></div><div>狀態: '+d.status+'</div>'; lv.appendChild(card); });
}

function appendBattleActivity(side, msg){ const el=document.getElementById(side==='hacker' ? 'hacker-activity' : 'le-activity'); if(!el) return; const d=document.createElement('div'); d.className='command-entry'; d.textContent='['+new Date().toLocaleTimeString()+'] '+msg; el.prepend(d); }

function updateBattleSimulation(){
    // mutate device stats slightly and generate activities
    (window.battleMonitor.hacker||[]).forEach(d=>{ d.cpu = Math.max(1, Math.min(99, d.cpu + Math.floor(Math.random()*11-5))); d.mem = Math.max(1, Math.min(99, d.mem + Math.floor(Math.random()*9-4))); if(Math.random()>0.96) appendBattleActivity('hacker','可疑外連: '+d.name+' -> 198.51.100.'+Math.floor(Math.random()*200)); });
    (window.battleMonitor.law_enforcement||[]).forEach(d=>{ d.cpu = Math.max(1, Math.min(99, d.cpu + Math.floor(Math.random()*11-5))); d.mem = Math.max(1, Math.min(99, d.mem + Math.floor(Math.random()*9-4))); if(Math.random()>0.95) appendBattleActivity('law_enforcement','攔截到異常連線: '+d.name+' <- 203.0.113.'+Math.floor(Math.random()*200)); });
    renderBattlePanels();
}

// start simulation
initBattleDevices();
setInterval(updateBattleSimulation, 2000);

// helper to open battle monitor from other UI
function openBattleFromMonitor(){ openBattleMonitor(); }

// export current battle monitor snapshot as JSON
function exportBattleSnapshotJSON(){
    try{
        const data = JSON.stringify(window.battleMonitor || {}, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'battle_snapshot_'+Date.now()+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        console.log('已匯出對戰快照');
    }catch(e){ console.error('匯出失敗', e); alert('匯出失敗: '+e.message); }
}

function exportNetworkSnapshotJSON(){
    try{
        const data = JSON.stringify(window.networkMonitoringData || {}, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'network_snapshot_'+Date.now()+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        console.log('已匯出網路快照');
    }catch(e){ console.error('匯出失敗', e); alert('匯出失敗: '+e.message); }
}

function exportFullSystemSnapshotJSON(){
    try{
        const full = {
            forensics: window.forensicsLabData || {},
            network: window.networkMonitoringData || {},
            battle: window.battleMonitor || {}
        };
        const data = JSON.stringify(full, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'full_system_snapshot_'+Date.now()+'.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        console.log('已匯出完整系統快照');
    }catch(e){ console.error('匯出失敗', e); alert('匯出失敗: '+e.message); }
}
</script>

<!-- Advanced Network Monitoring (SIMULATION ONLY) -->
<div id="network-advanced-modal" class="immersive-modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="net-adv-title">
    <header>
        <div id="net-adv-title" style="font-weight:bold;">網路監控升級 • 深度分析（模擬） <span class="new-badge">新功能</span></div>
        <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn" onclick="exportNetworkSnapshotJSON()">匯出網路快照 (JSON)</button>
            <button class="close-btn" onclick="closeNetworkAdvanced()">關閉</button>
        </div>
    </header>
    <div style="padding:12px; display:grid; grid-template-columns: 2fr 1fr; gap:12px;">
        <div>
            <div class="node-card">深度封包檢測 (DPI) • 可視化流量內容分析
                <div style="margin-top:8px;">顯示封包摘要、協議分布與示例 payload（僅模擬示範，無解碼真正封包）</div>
                <div style="margin-top:8px;" id="dpi-visual"></div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateDPI()">執行 DPI（模擬）</button></div>
            </div>

            <div class="node-card" style="margin-top:10px;">異常行為分析 (AI)
                <div style="margin-top:8px;">AI 驅動的異常模式檢測模擬，顯示異常分數與可疑連線</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateAIAnomaly()">執行 AI 檢測（模擬）</button></div>
                <div id="ai-anomaly-results" style="margin-top:10px; font-family:monospace; font-size:0.9rem;"></div>
            </div>

            <div class="node-card" style="margin-top:10px;">攻擊歸因分析
                <div style="margin-top:8px;">將可疑來源做地理定位與技術指紋比對（模擬）</div>
                <div style="margin-top:8px; display:flex; gap:8px; align-items:center;"><input id="attrib-ip" class="modal-input" placeholder="輸入可疑 IP（例如 203.0.113.45）" /><button class="btn-primary" onclick="simulateAttribution()">執行歸因（模擬）</button></div>
                <div id="attrib-results" style="margin-top:8px; font-family:monospace; font-size:0.9rem;"></div>
            </div>
        </div>

        <div>
            <div class="node-card">威脅情整合 • 情報匯流（模擬）
                <div style="margin-top:8px;">模擬連接到外部威脅情報資料庫並顯示合併結果（實際不發起外部呼叫）</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateThreatIntel()">取得威脅情報（模擬）</button></div>
                <div id="threat-feed" style="margin-top:8px; max-height:340px; overflow:auto; font-family:monospace; font-size:0.9rem;"></div>
            </div>

            <div class="node-card" style="margin-top:10px;">操作日誌<div id="network-adv-log" style="max-height:200px; overflow:auto; margin-top:6px;"></div></div>
        </div>
    </div>
</div>

<script>
// Simulated network monitoring data store
window.networkMonitoringData = window.networkMonitoringData || {};

function openNetworkAdvanced(){ document.getElementById('network-advanced-modal').style.display='block'; setTimeout(()=>{ const el=document.getElementById('network-advanced-modal').querySelector('button'); if(el) el.focus(); },100); }
function closeNetworkAdvanced(){ document.getElementById('network-advanced-modal').style.display='none'; }

function netLog(msg){ const el=document.getElementById('network-adv-log'); if(!el) return; const d=document.createElement('div'); d.textContent='['+new Date().toLocaleTimeString()+'] '+msg; el.prepend(d); }

function simulateDPI(){
    netLog('執行 DPI 模擬掃描');
    const protocols = [ 'HTTP', 'TLS', 'DNS', 'SSH', 'ICMP' ];
    const protoDist = protocols.map(p=>({ proto:p, pct: Math.floor(5+Math.random()*40) }));
    // normalize to 100
    let sum = protoDist.reduce((s,i)=>s+i.pct,0); protoDist.forEach(i=>i.pct = Math.round(i.pct*100/sum));
    window.networkMonitoringData.dpi = { timestamp: Date.now(), protoDist };
    const container = document.getElementById('dpi-visual'); container.innerHTML = '';
    protoDist.forEach(p=>{
        const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.margin='6px 0';
        const label = document.createElement('div'); label.textContent = p.proto; label.style.width='60px';
        const barWrap = document.createElement('div'); barWrap.style.flex='1'; barWrap.style.background='#222'; barWrap.style.borderRadius='6px'; barWrap.style.overflow='hidden';
        const bar = document.createElement('div'); bar.style.height='18px'; bar.style.width = p.pct + '%'; bar.style.background = p.proto==='HTTP'? '#4a90d9' : p.proto==='TLS'? '#00ff41' : '#ff9900'; bar.style.display='flex'; bar.style.alignItems='center'; bar.style.justifyContent='center'; bar.style.color='#000'; bar.textContent = p.pct + '%';
        barWrap.appendChild(bar); row.appendChild(label); row.appendChild(barWrap); container.appendChild(row);
    });
    // show example payloads
    const payloads = [
        {proto:'HTTP', sample:'GET /login HTTP/1.1\nHost: example.com\nUser-Agent: ...'},
        {proto:'DNS', sample:'Query: attacker.example -> A 203.0.113.5'},
        {proto:'TLS', sample:'ClientHello (SNI: victim.example)'}
    ];
    const ex = document.createElement('pre'); ex.style.marginTop='10px'; ex.style.background='rgba(0,0,0,0.6)'; ex.style.padding='8px'; ex.textContent = payloads.map(p=>p.proto+':\n'+p.sample).join('\n\n'); container.appendChild(ex);
    netLog('DPI 模擬完成 - 已產生協議分布與示例 payload（僅示範）');
}

function simulateAIAnomaly(){
    netLog('啟動 AI 異常行為分析（模擬）');
    // generate mock connections with anomaly scores
    const conns = Array.from({length:6}).map((_,i)=>({ src:'192.0.2.'+(10+i), dst:'10.0.0.'+(5+i), bytes: Math.floor(200+Math.random()*5000), anomalyScore: Math.random().toFixed(2) }));
    const flagged = conns.filter(c=>parseFloat(c.anomalyScore)>0.75);
    window.networkMonitoringData.ai = { timestamp: Date.now(), conns, flagged };
    const out = document.getElementById('ai-anomaly-results'); out.innerHTML = '';
    conns.forEach(c=>{ const d=document.createElement('div'); d.className='command-entry'; d.innerHTML = '<strong>'+c.src+' → '+c.dst+'</strong> bytes:'+c.bytes+' score:'+c.anomalyScore; if(parseFloat(c.anomalyScore)>0.8) d.style.color='#ff3333'; out.appendChild(d); });
    netLog('AI 模擬完成，發現可疑連線數: '+flagged.length+'（模擬）');
}

function simulateThreatIntel(){
    netLog('整合威脅情報（模擬）');
    // local fake threat DB
    const fakeDB = [ {indicator:'203.0.113.5', type:'IP', severity:'高', note:'已知惡意 C2'},{indicator:'example-malware', type:'HASH', severity:'中', note:'疑似惡意樣本'} ];
    // simulate enrichment of existing findings
    const feed = fakeDB.map(f=>({ ...f, seenAt: new Date(Date.now()-Math.floor(Math.random()*86400000)).toLocaleString() }));
    window.networkMonitoringData.threat = { timestamp: Date.now(), feed };
    const el = document.getElementById('threat-feed'); el.innerHTML = '';
    feed.forEach(f=>{ const d=document.createElement('div'); d.className='intel-item'; d.innerHTML = '<div><strong>'+f.type+': '+f.indicator+'</strong> <span style="color:#ffaa00;">'+f.severity+'</span></div><div style="font-size:0.85rem;color:#ccc;">'+f.note+' — 探測時間: '+f.seenAt+'</div>'; el.appendChild(d); });
    netLog('威脅情模擬整合完成（僅示範）');
}

function simulateAttribution(){
    const ip = (document.getElementById('attrib-ip').value || '203.0.113.5').trim();
    netLog('開始攻擊歸因模擬 for '+ip);
    // mock geo mapping and fingerprint
    const geoMap = { '203.0.113.5': { country:'香港', city:'香港島' }, '198.51.100.10': { country:'台灣', city:'台北' } };
    const fp = { os:'Linux', tools:['curl','nmap'], fingerprintScore: Math.floor(50+Math.random()*50) };
    const geo = geoMap[ip] || { country:'未知', city:'未知' };
    const result = { ip, geo, fingerprint: fp, timestamp: Date.now() };
    window.networkMonitoringData.attribution = result;
    const out = document.getElementById('attrib-results'); out.textContent = JSON.stringify(result, null, 2);
    netLog('攻擊歸因模擬完成（模擬地理定位: '+geo.country+'）');
}

// expose open function on monitoring panel
function openAdvancedFromMonitoring(){ openNetworkAdvanced(); }

// 定义缺失的函数处理器
function launchTimelineAnalyzer(){
    console.log('時間線分析器已啟動（模擬）');
    appendForensicsLog && appendForensicsLog('時間線分析器已啟動');
}

function runSocialNetworkAnalysis(){
    console.log('社交網絡分析已執行（模擬）');
    appendForensicsLog && appendForensicsLog('社交網絡分析已執行');
}

function openGeoIPMap(){
    console.log('GeoIP 地圖已開啟（模擬）');
    appendForensicsLog && appendForensicsLog('GeoIP 地圖已開啟');
}

function simulateTLSDecode(){
    console.log('TLS 解碼模擬已啟動（模擬）');
    appendForensicsLog && appendForensicsLog('TLS 解碼模擬已啟動');
}

function openThreatIntelPanel(){
    console.log('威脅情報面板已開啟（模擬）');
    appendForensicsLog && appendForensicsLog('威脅情報面板已開啟');
}

function cveLookupPrompt(){
    console.log('CVE 查詢已啟動（模擬）');
    appendForensicsLog && appendForensicsLog('CVE 查詢已啟動');
}

function sandboxAnalyzePrompt(){
    console.log('沙盒分析已啟動（模擬）');
    appendForensicsLog && appendForensicsLog('沙盒分析已啟動');
}

function openAIAttackMatcher(){
    console.log('AI 攻擊匹配器已開啟（模擬）');
    appendForensicsLog && appendForensicsLog('AI 攻擊匹配器已開啟');
}
</script>

<div id="legal-modal" class="immersive-modal" style="display:none;">
    <header>
        <div style="font-weight:bold;">法律工具</div>
        <div><button class="close-btn" onclick="closeLegalTools()">關閉</button></div>
    </header>
    <div class="legal-form" style="display:grid; grid-template-columns: 1fr 360px; gap:12px;">
        <div>
            <div style="margin-bottom:8px;"><strong>搜查令申請 (模擬)</strong></div>
            <label>申請人 <input id="warrant-applicant" class="modal-input" placeholder="調查員或單位" /></label>
            <label>被申請對象 <input id="warrant-target" class="modal-input" placeholder="目標 (IP/帳號/地點)" /></label>
            <label>理由 (probable cause) <textarea id="warrant-reason" class="modal-input" placeholder="說明可疑事實與證據摘要"></textarea></label>
            <label>範圍 (search scope) <input id="warrant-scope" class="modal-input" placeholder="例如：特定伺服器、電子郵件帳戶" /></label>
            <label>預計執行地點/管轄 <input id="warrant-jurisdiction" class="modal-input" placeholder="國家/地區" /></label>
            <div style="margin-top:8px; display:flex; gap:8px;">
                <button class="btn-primary" onclick="submitWarrantApplication()">申請搜查令（模擬送出）</button>
                <button class="btn" onclick="complianceCheck()">程序合法性檢查</button>
            </div>

            <hr style="margin:12px 0; border-color: rgba(255,255,255,0.05);" />

            <div style="margin-bottom:8px;"><strong>法庭證據提交</strong></div>
            <label>證據名稱 <input id="evidence-name" class="modal-input" placeholder="例如: secret.docx" /></label>
            <label>證據類型 <input id="evidence-type" class="modal-input" placeholder="文件/封包/截圖" /></label>
            <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" id="evidence-critical" /> <span>標記為關鍵證據</span></label>
            <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="addEvidenceToPackage()">加入證據包</button>
                <button class="btn" onclick="submitEvidencePackage()">提交至法庭（模擬）</button></div>

        </div>

        <div>
            <div style="font-weight:bold;">法律工具結果</div>
            <div id="legal-results" style="margin-top:8px; font-family:monospace; font-size:0.9rem; max-height:420px; overflow:auto; background:rgba(0,0,0,0.4); padding:8px; border-radius:6px;"></div>
            <div style="margin-top:10px; display:flex; gap:8px;">
                <button class="btn" onclick="analyzeJurisdiction()">管轄權分析</button>
                <button class="btn" onclick="requestInternationalAssistance()">國際協助請求</button>
                <button class="btn" onclick="generateArrestWarrant()">匯出逮捕/搜查令 (模擬 PDF)</button>
            </div>
        </div>
    </div>
</div>

<script>
// Minimal handlers and mock renderers for the new panels
function openEvidenceGraph(){ document.getElementById('evidence-modal').style.display='block'; renderEvidenceGraph(); }
function closeEvidenceGraph(){ document.getElementById('evidence-modal').style.display='none'; }

function toggleHackerVisuals(){ const ov = document.getElementById('hacker-overlay'); ov.classList.toggle('active'); }

function openMonitoringPanel(){ document.getElementById('monitoring-modal').style.display='block'; renderMonitoring(); }
function closeMonitoringPanel(){ document.getElementById('monitoring-modal').style.display='none'; }

function openLegalTools(){ document.getElementById('legal-modal').style.display='block'; }
function closeLegalTools(){ document.getElementById('legal-modal').style.display='none'; }

function openWarrantSystem(){
    const modal = document.getElementById('legal-modal');
    if(modal) modal.style.display='block';
    appendForensicsLog && appendForensicsLog('搜索令系統已開啟（模擬）');
}

function renderEvidenceGraph(){
    const el = document.getElementById('evidence-graph');
    // simple mock: draw nodes as boxes
    el.innerHTML = '';
    const nodes = [ {id:'n1',label:'Email'}, {id:'n2',label:'IP'}, {id:'n3',label:'Device'} ];
    nodes.forEach(n=>{ const d = document.createElement('div'); d.className='node-card'; d.textContent = n.label; el.appendChild(d); });
    document.getElementById('evidence-timeline').textContent = '時間軸示例：2025-01-01 12:00 - 交易發現';
}

function renderMonitoring(){
    // mock sparklines using simple color shifts
    ['spark-traffic','spark-anomaly','spark-health'].forEach(id=>{
        const c = document.getElementById(id);
        if (!c) return;
        c.style.background = `linear-gradient(90deg, rgba(0,255,65,0.12), rgba(74,144,217,0.08))`;
    });
}

function generateArrestWarrant(){ alert('生成逮捕令：暫時為示例。'); }
function verifyEvidenceHash(){ alert('驗證完成（模擬）'); }

// --- 法律流程模擬函數（模擬）
window.legalWorkflow = window.legalWorkflow || { evidencePackage: [] };

function submitWarrantApplication(){
    const app = {
        applicant: document.getElementById('warrant-applicant').value || 'Unknown',
        target: document.getElementById('warrant-target').value || 'Unknown',
        reason: document.getElementById('warrant-reason').value || '',
        scope: document.getElementById('warrant-scope').value || '',
        jurisdiction: document.getElementById('warrant-jurisdiction').value || '本地',
        timestamp: Date.now()
    };
    // mock judicial review
    appendForensicsLog('提交搜查令申請（模擬） by '+app.applicant+' 目標: '+app.target);
    document.getElementById('legal-results').textContent = '申請已送出，等待法院審核（模擬）...';
    setTimeout(()=>{
        const granted = Math.random() > 0.25; // 75% chance
        const res = { granted, judge:'Judge Chen', notes: granted? '核准搜查令' : '理由不足，請補充證據', timestamp: Date.now() };
        window.legalWorkflow.lastWarrant = { app, res };
        document.getElementById('legal-results').textContent = JSON.stringify(window.legalWorkflow.lastWarrant, null, 2);
        appendForensicsLog('法院審核完成（模擬） - 結果: '+(granted? '核准':'駁回'));
    }, 2200);
}

function complianceCheck(){
    appendForensicsLog('執行法律合規檢查（模擬）');
    // mock checks
    const checks = { warrantsPresent: !!window.legalWorkflow.lastWarrant, policyMatch: Math.random()>0.2, privacyRisk: Math.random()>0.7 };
    const summary = { timestamp: Date.now(), checks, verdict: checks.warrantsPresent && checks.policyMatch && !checks.privacyRisk ? '合法' : '有風險' };
    document.getElementById('legal-results').textContent = JSON.stringify(summary, null, 2);
    appendForensicsLog('合規檢查完成（模擬） - 結論: '+summary.verdict);
}

function addEvidenceToPackage(){
    const name = document.getElementById('evidence-name').value || 'unnamed';
    const type = document.getElementById('evidence-type').value || 'unknown';
    const critical = document.getElementById('evidence-critical').checked;
    const e = { id: 'ev-'+Math.floor(Math.random()*90000+10000), name, type, critical, timestamp: Date.now() };
    window.legalWorkflow.evidencePackage.push(e);
    appendForensicsLog('已加入證據包（模擬）: '+name);
    document.getElementById('legal-results').textContent = JSON.stringify(window.legalWorkflow.evidencePackage, null, 2);
}

function submitEvidencePackage(){
    appendForensicsLog('提交證據包至法庭（模擬） - 正在整理...');
    const pkg = window.legalWorkflow.evidencePackage || [];
    setTimeout(()=>{
        const receipt = { pkgCount: pkg.length, submittedAt: Date.now(), docketId: 'D-'+Math.floor(Math.random()*90000+10000) };
        window.legalWorkflow.lastSubmission = receipt;
        document.getElementById('legal-results').textContent = JSON.stringify(receipt, null, 2);
        appendForensicsLog('證據包提交完成（模擬） - 案卷號: '+receipt.docketId);
    }, 1800);
}

function analyzeJurisdiction(){
    appendForensicsLog('執行管轄權分析（模擬）');
    const jur = document.getElementById('warrant-jurisdiction').value || '本地';
    const advice = jur.includes('國') || jur === 'International' ? '可能需要跨境請求與國際協助' : '本地管轄可執行';
    const out = { jurisdiction: jur, advice, timestamp: Date.now() };
    document.getElementById('legal-results').textContent = JSON.stringify(out, null, 2);
    appendForensicsLog('管轄分析完成（模擬） - 建議: '+advice);
}

function requestInternationalAssistance(){
    appendForensicsLog('發起國際協助請求（模擬）');
    // open step modal for selecting agency
    openStepModal('國際協助請求（模擬）', [
        { name:'選擇協作機構', type:'select', options:[{label:'INTERPOL',value:'interpol'},{label:'Europol',value:'europol'},{label:'Bilateral MLAT',value:'mlat'}] },
        { name:'發送請求', type:'progress', duration: 3000 },
        { name:'回應', type:'result', content: '回應已收到（模擬） - 進一步執行跨境協調' }
    ], (result)=>{
        appendForensicsLog('國際協助流程完成（模擬） - 機構: '+result.selectedValue);
        document.getElementById('legal-results').textContent = '國際協助：'+result.selectedValue+' 已回應（模擬）';
    });
}

function generateArrestWarrant(){
    const last = window.legalWorkflow.lastWarrant || null;
    const data = last ? last : { note:'沒有最新申請，生成範本（模擬）' };
    document.getElementById('legal-results').textContent = JSON.stringify({ generated: true, data, timestamp: Date.now() }, null, 2);
    appendForensicsLog('已生成逮捕/搜查令範本（模擬）');
}

</script>

<!-- Advanced Analysis Modal v5.5.0 (SIMULATION ONLY) -->
<div id="advanced-analysis-modal" class="immersive-modal" style="display:none;">
    <header>
        <div style="font-weight:bold;">進階分析工具 v5.5.0 <span class="new-badge">v5.5.0</span></div>
        <div><button class="close-btn" onclick="closeAdvancedAnalysis()">關閉</button></div>
    </header>
    <div style="padding:12px; display:grid; grid-template-columns:1fr 320px; gap:12px;">
        <div>
            <div class="node-card">行為模式分析
                <div style="margin-top:8px;">識別黑客操作習慣、常用工具與攻擊序列（模擬）</div>
                <div style="margin-top:8px;"><button class="btn-primary" onclick="simulateBehaviorAnalysis()">執行行為分析</button></div>
            </div>

            <div class="node-card" style="margin-top:10px;">社交網絡分析
                <div style="margin-top:8px;">關聯帳戶、通訊列表與潛在合作夥伴（模擬）</div>
                <div style="margin-top:8px;"><button class="btn-primary" onclick="simulateSocialNetworkAnalysis()">執行社交網絡分析</button></div>
            </div>

            <div class="node-card" style="margin-top:10px;">時間線重建工具
                <div style="margin-top:8px;">使用多來源事件重建攻擊順序（模擬）</div>
                <div style="margin-top:8px;"><button class="btn-primary" onclick="simulateTimelineReconstruction()">重建時間線</button></div>
            </div>

            <div class="node-card" style="margin-top:10px;">數據關聯引擎
                <div style="margin-top:8px;">發現隱藏關聯模式與可疑指標（模擬）</div>
                <div style="margin-top:8px;"><button class="btn-primary" onclick="simulateDataCorrelationEngine()">運行關聯引擎</button></div>
            </div>

            <div class="node-card" style="margin-top:10px;">AI 輔助分析
                <div style="margin-top:8px;">使用 AI 模型自動識別異常模式（模擬）</div>
                <div style="margin-top:8px;"><button class="btn-primary" onclick="simulateAIAssistedAnalysis()">啟動 AI 分析</button></div>
            </div>
        </div>

        <div>
            <div style="font-weight:bold;">進階分析結果</div>
            <div id="advanced-analysis-results" style="margin-top:8px; font-family:monospace; font-size:0.9rem; max-height:420px; overflow:auto; background:rgba(0,0,0,0.4); padding:8px; border-radius:6px;"></div>
            <div style="margin-top:10px; color:#aaa; font-size:0.85rem;">註：所有分析為示範性模擬，並不執行真實外部查詢或模型推理。</div>
        </div>
    </div>
</div>

<script>
function openAdvancedAnalysis(){ document.getElementById('advanced-analysis-modal').style.display='block'; }
function closeAdvancedAnalysis(){ document.getElementById('advanced-analysis-modal').style.display='none'; }

function simulateBehaviorAnalysis(){
    appendForensicsLog('進階行為分析啟動（模擬）');
    setTimeout(()=>{
        const result = { patterns:[{ tactic:'lateral_movement', freq:12 }, { tactic:'privilege_escalation', freq:4 }], summary:'發現常見動作模式：側移、持久化、憑證收集'};
        document.getElementById('advanced-analysis-results').textContent = JSON.stringify(result, null, 2);
        appendForensicsLog('行為分析完成（模擬）');
    }, 1500);
}

function simulateSocialNetworkAnalysis(){
    appendForensicsLog('社交網絡分析執行（模擬）');
    setTimeout(()=>{
        const map = { nodes: [{id:'acct1',score:0.9},{id:'acct2',score:0.76}], edges:[['acct1','acct2']] };
        document.getElementById('advanced-analysis-results').textContent = JSON.stringify(map, null, 2);
        appendForensicsLog('社交網絡分析完成（模擬） - 發現高關聯帳戶');
    }, 1600);
}

function simulateTimelineReconstruction(){
    appendForensicsLog('時間線重建啟動（模擬）');
    setTimeout(()=>{
        const timeline = [ '2025-08-01T09:58:12 - 扫描', '2025-08-01T10:01:12 - SSH 登入', '2025-08-01T10:02:05 - 上傳 secret.docx' ];
        document.getElementById('advanced-analysis-results').textContent = JSON.stringify({ timeline }, null, 2);
        appendForensicsLog('時間線重建完成（模擬）');
    }, 1300);
}

function simulateDataCorrelationEngine(){
    appendForensicsLog('數據關聯引擎運行（模擬）');
    setTimeout(()=>{
        const correlations = [{ a:'IP 198.51.100.23', b:'Email ghost@onion' , score:0.82 }];
        document.getElementById('advanced-analysis-results').textContent = JSON.stringify({ correlations }, null, 2);
        appendForensicsLog('關聯引擎完成（模擬） - 發現隱藏關聯');
    }, 1700);
}

function simulateAIAssistedAnalysis(){
    appendForensicsLog('AI 輔助分析啟動（模擬）');
    setTimeout(()=>{
        const ai = { anomalies:[{ id:'conn-123', score:0.95, reason:'異常大型外連' }], recommendation:'優先調查 conn-123' };
        document.getElementById('advanced-analysis-results').textContent = JSON.stringify(ai, null, 2);
        appendForensicsLog('AI 分析完成（模擬） - 已標註高風險事件');
    }, 2200);
}
</script>

<!-- Defense & Darknet prototypes -->
<div id="defense-modal" class="immersive-modal" style="display:none;">
    <header>
        <div style="font-weight:bold;">防禦與隱匿工具</div>
        <div><button class="close-btn" onclick="closeDefenseTools()">關閉</button></div>
    </header>
    <div style="display:flex; gap:12px;">
        <div style="flex:1">
            <div class="node-card">數位足跡清除器<button class="btn-primary" onclick="mockClearFootprints()">執行</button></div>
            <div class="node-card">即時 IP 跳轉系統<button class="btn-primary" onclick="mockIPHop()">跳轉 IP</button></div>
            <div class="node-card">反追蹤陷阱設置<button class="btn-primary" onclick="mockDeployTrap()">部署陷阱</button></div>
            <div class="node-card">假身份生成器<button class="btn-primary" onclick="mockGeneratePersona()">生成</button></div>
        </div>
        <div style="width:320px">
            <div class="node-card">操作日誌<div id="defense-log" style="max-height:260px; overflow:auto; margin-top:6px;"></div></div>
        </div>
    </div>
</div>

<div id="darknet-modal" class="immersive-modal" style="display:none;">
    <header>
        <div style="font-weight:bold;">暗網操作</div>
        <div><button class="close-btn" onclick="closeDarknetOps()">關閉</button></div>
    </header>
    <div style="display:grid; grid-template-columns:1fr 280px; gap:10px;">
        <div>
            <div class="node-card">加密通訊室<button class="btn-primary" onclick="mockOpenChat()">開啟</button></div>
            <div class="node-card">虛擬貨幣錢包管理<div id="wallet-list" style="margin-top:8px;"></div></div>
            <div class="node-card">漏洞市場瀏覽器<button class="btn-primary" onclick="mockBrowseExploitMarket()">瀏覽</button></div>
            <div class="node-card">匿名服務購買界面<button class="btn-primary" onclick="mockPurchaseService()">購買</button></div>
        </div>
        <div>
            <div class="node-card">實時數據儀表板
                <div style="margin-top:8px;">心跳圖：<span id="hb-value">72</span></div>
                <div>資源消耗：<span id="res-value">18%</span></div>
                <div>風險指數：<span id="risk-value">32</span></div>
                <div>時間壓力：<span id="tpress">00:12:34</span></div>
            </div>
        </div>
    </div>
</div>

<!-- Tactical Operations (SIMULATION ONLY) -->
<div id="tactical-ops-modal" class="immersive-modal" style="display:none;">
    <header>
        <div style="font-weight:bold;">戰術行動工具（模擬）</div>
        <div><button class="close-btn" onclick="closeTacticalOps()">關閉</button></div>
    </header>
    <div style="padding:12px; display:grid; grid-template-columns:1fr 320px; gap:12px;">
        <div>
            <div class="node-card">🎭 誘捕系統（蜜罐）
                <div style="margin-top:8px;">在受控環境中模擬蜜罐部署與流量回報（僅示範）</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><button class="btn-primary" onclick="simulateDeployHoneypot()">模擬部署蜜罐</button></div>
            </div>

            <div class="node-card" style="margin-top:10px;">📍 地理定位工具（IP → 位置 模擬）
                <div style="margin-top:8px;">輸入 IP 以模擬回傳位置資訊（不連網、不查實）</div>
                <div style="margin-top:8px; display:flex; gap:8px;"><input id="tactical-ip-input" class="modal-input" placeholder="範例: 198.51.100.23" /><button class="btn" onclick="simulateGeoLocateIP()">模擬定位</button></div>
            </div>

                        <!-- 全網圍捕協作模式已整合 -->
                        <!-- 舊有戰術/沉浸式模擬功能已移除或停用 -->
                </div>

                <div>
                        <div style="font-weight:bold;">協作儀表板</div>
                        <div id="roundup-placeholder" style="margin-top:8px; font-family:monospace; font-size:0.9rem; max-height:340px; overflow:auto; background:rgba(0,0,0,0.35); padding:8px; border-radius:6px;">全網圍捕功能已啟用。可從右下角或工具區觸發行動。</div>
                </div>
        </div>
</div>

<script>
// 全網圍捕（Cooperative Net Roundup）模組
(function(){
        const UNITS = [
            { id:'cyber_police', name:'網警', color:'#4a90d9', resources:5 },
            { id:'special_forces', name:'特警', color:'#ff3333', resources:3 },
            { id:'forensics', name:'鑑識科', color:'#ff9900', resources:4 }
        ];

        function createModal(){
            if(document.getElementById('net-roundup-modal')) return;
            const html = `
            <div id="net-roundup-modal" class="modal-overlay" style="display:none;">
                <div class="modal-box">
                    <div class="modal-title">全網圍捕協作模式</div>
                    <div class="modal-message">
                        <div style="display:flex; gap:12px;">
                            <div style="flex:1;">
                                <div style="font-weight:bold; margin-bottom:8px;">協作單位</div>
                                <div id="roundup-units" style="display:flex; flex-direction:column; gap:8px;"></div>
                                <div style="margin-top:12px;"><label>觸發門檻(證據數): <input id="roundup-threshold" type="number" value="5" style="width:60px;"/></label>
                                    <button class="btn btn-primary" onclick="triggerRoundupFromUI()" style="margin-left:8px;">手動觸發</button></div>
                            </div>
                            <div style="width:260px;">
                                <div style="font-weight:bold; margin-bottom:8px;">資源調度</div>
                                <div id="roundup-resources" style="background:rgba(0,0,0,0.35); padding:8px; border-radius:6px; min-height:180px; font-family:monospace;"></div>
                                <div style="margin-top:12px; font-weight:bold;">實時進度</div>
                                <div id="roundup-progress" style="margin-top:8px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-buttons"><button class="modal-btn modal-btn-cancel" onclick="closeNetRoundup()">關閉</button></div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        function renderUnits(){ const el=document.getElementById('roundup-units'); if(!el) return; el.innerHTML=''; UNITS.forEach(u=>{ const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='6px'; div.style.border='1px solid rgba(255,255,255,0.04)'; div.innerHTML = `<div><strong style="color:${u.color}">${u.name}</strong><div style="font-size:0.85rem;color:#aaa;">可用單位: <span id="res-${u.id}">${u.resources}</span></div></div><div><button class="btn" onclick="dispatchUnit('${u.id}')">調度</button></div>`; el.appendChild(div); }); }

        function renderResourcesLog(msg){ const el=document.getElementById('roundup-resources'); if(!el) return; const d=document.createElement('div'); d.textContent='['+new Date().toLocaleTimeString('zh-TW')+'] '+msg; el.prepend(d); }

        window.dispatchUnit = function(unitId){ const u = UNITS.find(x=>x.id===unitId); if(!u) return; if(u.resources<=0){ renderResourcesLog(u.name+' 無可用資源'); return; } u.resources--; const rEl = document.getElementById('res-'+u.id); if(rEl) rEl.textContent = u.resources; renderResourcesLog('已調度 '+u.name+' 一組單位'); startRoundupProgress(); };

        let roundupInProgress = false;
        function startRoundupProgress(){ if(roundupInProgress) return; roundupInProgress = true; const progEl=document.getElementById('roundup-progress'); if(!progEl) return; progEl.innerHTML=''; UNITS.forEach(u=>{ const wrap=document.createElement('div'); wrap.style.marginBottom='8px'; wrap.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;"><div style="color:${u.color}"><strong>${u.name}</strong></div><div style="font-size:0.85rem;color:#aaa;">進度: <span id="p-${u.id}">0%</span></div></div><div class="progress-bar-container"><div class="progress-bar-fill" id="f-${u.id}" style="width:0%; background: linear-gradient(90deg, ${u.color}, #ffffff)"></div></div>`; progEl.appendChild(wrap); });
            const timer = setInterval(()=>{
                let done = true;
                UNITS.forEach(u=>{ const fill = document.getElementById('f-'+u.id); const pctEl = document.getElementById('p-'+u.id); if(!fill) return; const cur = parseInt(fill.style.width)||0; const inc = Math.floor(Math.random()*20)+5; const next = Math.min(100, cur + inc); fill.style.width = next+'%'; if(pctEl) pctEl.textContent = next+'%'; if(next<100) done = false; });
                if(done){ clearInterval(timer); roundupInProgress=false; renderResourcesLog('全網圍捕行動完成（模擬）'); addTerminalLine && addTerminalLine('[全網圍捕] 行動完成','success'); }
            }, 800);
        }

        window.triggerRoundupFromUI = function(){ const thr = parseInt(document.getElementById('roundup-threshold').value) || 5; const evidenceCount = (window.reports && window.reports.currentEvidenceCount) || (window.GameState && GameState.evidenceCount) || 0; if(evidenceCount >= thr){ document.getElementById('net-roundup-modal').style.display='flex'; renderUnits(); renderResourcesLog('基於證據閾值('+evidenceCount+')，觸發全網圍捕（模擬）'); startRoundupProgress(); } else { renderResourcesLog('證據不足：目前 '+evidenceCount+'，門檻 '+thr); addTerminalLine && addTerminalLine('[全網圍捕] 證據未達門檻','warning'); } };

        window.triggerRoundup = function(evidenceCount){ window.reports = window.reports || {}; window.reports.currentEvidenceCount = evidenceCount; createModal(); document.getElementById('net-roundup-modal').style.display='flex'; renderUnits(); renderResourcesLog('由系統事件觸發全網圍捕（模擬），證據: '+evidenceCount); startRoundupProgress(); };

        window.closeNetRoundup = function(){ const m=document.getElementById('net-roundup-modal'); if(m) m.style.display='none'; };

        // create quick-launch button
        try{ if(!document.getElementById('roundup-quick-btn')){ const btn = document.createElement('div'); btn.id='roundup-quick-btn'; btn.style.position='fixed'; btn.style.right='18px'; btn.style.bottom='80px'; btn.style.zIndex='100000'; btn.innerHTML = '<button class="btn btn-warning" title="全網圍捕" onclick="createModal(); document.getElementById(\'net-roundup-modal\').style.display=\'flex\'; renderUnits();">全網圍捕</button>'; document.body.appendChild(btn); } }catch(e){}

})();
</script>

<script>
function openDefenseTools(){ document.getElementById('defense-modal').style.display='block'; }
function closeDefenseTools(){ document.getElementById('defense-modal').style.display='none'; }
function openDarknetOps(){ document.getElementById('darknet-modal').style.display='block'; renderWallets(); }
function closeDarknetOps(){ document.getElementById('darknet-modal').style.display='none'; }

function mockClearFootprints(){ logDefense('數位足跡清除完成（模擬）'); }
function mockIPHop(){ logDefense('即時 IP 跳轉：已切換至新出口 IP（模擬）'); navigator.vibrate && navigator.vibrate(100); }
function mockDeployTrap(){ logDefense('反追蹤陷阱已部署（模擬）'); }
function mockGeneratePersona(){ const id='persona_'+Math.floor(Math.random()*9000+1000); logDefense('生成假身份: '+id); alert('假身份已生成: '+id); }
function logDefense(msg){ const el=document.getElementById('defense-log'); if(!el) return; const d=document.createElement('div'); d.textContent='['+new Date().toLocaleTimeString()+'] '+msg; el.prepend(d); }

function renderWallets(){ const list=document.getElementById('wallet-list'); list.innerHTML=''; const wallets=['WAL-'+Math.floor(Math.random()*9000+1000),'WAL-'+Math.floor(Math.random()*9000+1000)]; wallets.forEach(w=>{ const d=document.createElement('div'); d.textContent=w; d.style.marginBottom='6px'; list.appendChild(d); }); }
function mockOpenChat(){ alert('加密通訊室（模擬）'); }
function mockBrowseExploitMarket(){ alert('漏洞市場載入（模擬）'); }
function mockPurchaseService(){ alert('已購買匿名服務（模擬）'); }

// Simple realtime dashboard updater
setInterval(()=>{
    const hb = Math.floor(60+Math.random()*40);
    const res = Math.floor(Math.random()*80);
    const risk = Math.floor(Math.random()*100);
    const t = new Date();
    document.getElementById('hb-value') && (document.getElementById('hb-value').textContent=hb);
    document.getElementById('res-value') && (document.getElementById('res-value').textContent=res+'%');
    document.getElementById('risk-value') && (document.getElementById('risk-value').textContent=risk);
    // countdown example
    const remaining = 60*15 - Math.floor((Date.now()/1000)%900);
    const mm = String(Math.floor(remaining/60)).padStart(2,'0'); const ss=String(remaining%60).padStart(2,'0'); document.getElementById('tpress') && (document.getElementById('tpress').textContent = '00:'+mm+':'+ss);
},2000);

// Input/feedback stubs: gestures, keyboard shortcuts, voice, vibration
window.addEventListener('keydown', (e)=>{
    // simple shortcuts
    if(e.key === 'e') openEvidenceGraph();
    if(e.key === 'd') openDefenseTools();
    if(e.key === 'm') openMonitoringPanel();
    if(e.key === 'g') openDarknetOps();
    if(e.key === 'v') navigator.vibrate && navigator.vibrate(50);
});

// Touch gestures (swipe down to toggle hacker visuals)
let touchStartY=null; document.addEventListener('touchstart', (ev)=>{ if(ev.touches && ev.touches[0]) touchStartY=ev.touches[0].clientY; });
document.addEventListener('touchend', (ev)=>{ if(!touchStartY) return; const endY = ev.changedTouches && ev.changedTouches[0] ? ev.changedTouches[0].clientY : null; if(endY && endY - touchStartY > 80){ toggleHackerVisuals(); } touchStartY=null; });

// Voice command stub (requires user gesture to enable in real browser)
function initVoiceCommands(){ if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return; const R = window.SpeechRecognition || window.webkitSpeechRecognition; const rec = new R(); rec.continuous=false; rec.onresult = (e)=>{ const txt = e.results[0][0].transcript.toLowerCase(); if(txt.includes('evidence')) openEvidenceGraph(); if(txt.includes('defense')) openDefenseTools(); if(txt.includes('monitor')) openMonitoringPanel(); }; rec.onerror=()=>{}; return rec; }
window.voiceRec = initVoiceCommands();

}
}
</script>
</script>

<!-- Forensics Lab Modal (執法部門 數位鑑識實驗室) -->
<div id="forensics-modal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <div class="modal-title">數位鑑識實驗室系統 (v<span id="forensics-version">5.5.0</span>)</div>
        <div class="modal-message" style="display:block;">
            <div style="display:grid; grid-template-columns: 1fr 260px; gap:12px;">
                <div>
                    <div style="font-weight:bold; margin-bottom:8px;">工具模組</div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <button class="btn btn-primary" onclick="runMemoryDumpAnalysis()">記憶體轉儲分析</button>
                        <button class="btn btn-primary" onclick="verifyDiskImage()">硬碟映像驗證</button>
                        <button class="btn btn-primary" onclick="reassemblePackets()">網路封包重組</button>
                        <button class="btn btn-primary" onclick="openTimelineAnalyzer()">時間線分析介面</button>
                        <button class="btn btn-primary" onclick="verifyDigitalSignature()">數位章驗證器</button>
                        <button class="btn btn-primary" onclick="openLegalSimulator()">法院與法律程序模擬</button>
                        <button class="btn btn-primary" onclick="startWarrantWorkflow()">搜索令申請模擬</button>
                    </div>
                </div>
                <div>
                    <div style="font-weight:bold; margin-bottom:8px;">任務與法務流程</div>
                    <div id="forensics-side" style="background:rgba(0,0,0,0.35); padding:10px; border-radius:6px; max-height:420px; overflow:auto; font-family:monospace; font-size:0.95rem;"></div>
                </div>
            </div>
        </div>
        <div class="modal-buttons" style="margin-top:12px;">
            <button class="modal-btn modal-btn-cancel" onclick="closeForensicsLab()">關閉</button>
        </div>
    </div>
</div>

<script>
// Forensics Lab handlers (simulated)
function openForensicsLab(){
    const m = document.getElementById('forensics-modal'); if(!m) return; document.getElementById('forensics-version').textContent = typeof TOOL_VERSION !== 'undefined' ? TOOL_VERSION : '5.5.0'; m.classList.add('active'); m.style.display='flex'; renderForensicsSide('系統已啟動。可選擇任一模組進行模擬操作。');
}
function closeForensicsLab(){ const m = document.getElementById('forensics-modal'); if(!m) return; m.classList.remove('active'); m.style.display='none'; }

function renderForensicsSide(msg){ const el = document.getElementById('forensics-side'); if(!el) return; const d = document.createElement('div'); d.className='report-line'; d.textContent = '['+new Date().toLocaleTimeString('zh-TW')+'] '+msg; el.prepend(d); }

function appendForensicsLog(msg){ renderForensicsSide(msg); addTerminalLine && addTerminalLine('[鑑識] '+msg, 'system'); }

function runMemoryDumpAnalysis(){ appendForensicsLog('開始記憶體轉儲分析（模擬）...'); simulateProgress('記憶體分析', (res)=>{ appendForensicsLog('記憶體分析完成：發現可疑注入跡象與執行緒異常'); }); }

function verifyDiskImage(){ appendForensicsLog('開始硬碟映像驗證（模擬）...'); simulateProgress('映像驗證', (res)=>{ appendForensicsLog('映像驗證完成：SHA256 校驗一致，映像未被篡改（模擬）'); }); }

function reassemblePackets(){ appendForensicsLog('開始網路封包重組（模擬），這可能會生成 pcap 片段'); simulateProgress('封包重組', (res)=>{ appendForensicsLog('封包重組完成：已重組 HTTP 與 TLS 流量片段，生成 traffic_report.pcap（模擬）'); }); }

function openTimelineAnalyzer(){ appendForensicsLog('打開時間線分析介面（模擬）'); alert('時間線分析介面（模擬）已開啟 — 可視化時間序列與事件關聯。'); }

function verifyDigitalSignature(){ appendForensicsLog('執行數位章驗證（模擬）'); simulateProgress('數位章驗證', (res)=>{ appendForensicsLog('數位章驗證結果：部份文件簽章無效，列入證據鏈審查名單。'); }); }

function openLegalSimulator(){ appendForensicsLog('啟動法院與法律程序模擬（模擬）'); alert('法律程序模擬啟動：可檢視法院流程、證據可採性檢查與庭審準備度評估（模擬）。'); }

function startWarrantWorkflow(){ appendForensicsLog('啟動搜索令申請模擬'); // simulate steps
    renderForensicsSide('申請：已送出搜索令（待法官批准）');
    setTimeout(()=>{ renderForensicsSide('法官：已審查，要求補充法律要件（清單）'); }, 1800);
    setTimeout(()=>{ renderForensicsSide('法官：已批准搜索令。可執行現場取證（模擬）'); appendForensicsLog('搜索令已獲准（模擬）'); }, 4200);
}

function simulateProgress(title, cb){ const id = 'forensics-prog-'+Math.floor(Math.random()*9000+1000); renderForensicsSide(title+'：進行中...'); let pct=0; const t = setInterval(()=>{ pct += Math.floor(Math.random()*20)+10; if(pct>100) pct=100; renderForensicsSide(title+' 進度 '+pct+'%'); addTerminalLine && addTerminalLine('[鑑識] '+title+' 進度 '+pct+'%', 'system'); if(pct>=100){ clearInterval(t); renderForensicsSide(title+'：完成'); cb && cb(true); } }, 600); }

// Expose an action to the shop/button so clicking the forensics_toolkit can open the lab
if(typeof window.openForensicsLab === 'undefined') window.openForensicsLab = openForensicsLab;
</script>

<!-- Quick-launch floating panel for LE tools -->
<style>
        #le-quick-panel { position: fixed; right: 18px; bottom: 18px; width: 220px; background: rgba(10,10,20,0.95); border: 1px solid rgba(74,144,217,0.25); border-radius: 10px; padding: 8px; z-index: 99999; box-shadow: 0 8px 30px rgba(0,0,0,0.6); }
        #le-quick-panel .panel-header { display:flex; justify-content:space-between; align-items:center; }
        #le-quick-panel h4 { margin:0; color:#4a90d9; font-size:0.95rem; }
        #le-quick-panel .close-btn { background:transparent; border:none; color:#ccc; cursor:pointer; }
        #le-quick-panel button { width:100%; margin-top:6px; }
        #le-quick-reopen { position: fixed; right: 18px; bottom: 18px; z-index:100000; display:none; }
</style>
<div id="le-quick-panel" aria-hidden="true">
    <div class="panel-header"><h4>執法快速啟動</h4><button class="close-btn" id="le-panel-close">✕</button></div>
    <div style="margin-top:8px; display:flex; flex-direction:column; gap:6px;">
        <button class="btn btn-warning" id="btn-open-forensics">開啟 數位鑑識室</button>
        <button class="btn btn-primary" id="btn-open-warrant">開啟 搜索令系統</button>
        <button class="btn btn-secondary" id="btn-gen-summary">產生摘要</button>
    </div>
</div>

<!-- small reopen button shown when panel closed -->
<div id="le-quick-reopen">
    <button class="btn btn-warning" id="btn-reopen">執法快速啟動</button>
</div>

<script>
// Show panel only for law enforcement role
function showLEPanelIfAllowed(){
    try{
        const role = (window.GameState && GameState.currentRole) || 'hacker';
        const panel = document.getElementById('le-quick-panel');
        const reopen = document.getElementById('le-quick-reopen');
        if(!panel) return;
        if(role === 'law_enforcement'){
            panel.style.display = 'block'; panel.setAttribute('aria-hidden','false'); if(reopen) reopen.style.display='none';
        } else {
            panel.style.display = 'none'; panel.setAttribute('aria-hidden','true'); if(reopen) reopen.style.display='none';
        }
    }catch(e){ console.error(e); }
}

// Hook up buttons
document.getElementById('btn-open-forensics').addEventListener('click', ()=>{ openForensicsLab && openForensicsLab(); });
document.getElementById('btn-open-warrant').addEventListener('click', ()=>{ openWarrantSystem && openWarrantSystem(); });
document.getElementById('btn-gen-summary').addEventListener('click', ()=>{ renderForensicsSide && renderForensicsSide('快速面板：產生執法摘要（模擬）'); });

// close/reopen behavior
document.getElementById('le-panel-close').addEventListener('click', ()=>{ const p=document.getElementById('le-quick-panel'); if(!p) return; p.style.display='none'; p.setAttribute('aria-hidden','true'); const r=document.getElementById('le-quick-reopen'); if(r) r.style.display='block'; });
document.getElementById('btn-reopen').addEventListener('click', ()=>{ showLEPanelIfAllowed(); });

// ensure removed tactical/immersive functions are inert no-ops
['openTacticalOps','closeTacticalOps','openImmersiveInvestigation','closeImmersiveInvestigation','simulateStartCovertMonitor','simulateStopCovertMonitor','simulateDeployHoneypot','simulateGeoLocateIP','simulateShareIntel','createFolder','populateSampleEvidence','renderEvidenceTimeline','openEvidenceRoom','addChatMessage','assignTask'].forEach(fn=>{ if(typeof window[fn] !== 'function'){ window[fn] = function(){ console.warn(fn+' 已被移除或停用'); addTerminalLine && addTerminalLine('已停用：'+fn,'warning'); }; } });

// init on load and whenever GameState.currentRole changes (best-effort)
window.addEventListener('load', ()=>{ showLEPanelIfAllowed(); });
// poll for role changes in case GameState is set later
let lastRole = (window.GameState && GameState.currentRole) || null;
setInterval(()=>{ const role = (window.GameState && GameState.currentRole) || null; if(role !== lastRole){ lastRole = role; showLEPanelIfAllowed(); } }, 1000);
</script>

</body>
</html>

