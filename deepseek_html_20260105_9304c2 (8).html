<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>對戰模式第二季 • 執法對決 SEASON 2 | Cyber Attack Simulation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== 基礎重置 ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', 'Consolas', 'Monaco', monospace;
        }

        body {
            background: #000;
            color: #fff;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            background: radial-gradient(ellipse at center, #0a0a0a 0%, #000000 100%);
        }

        /* ===== 屏幕效果 ===== */
        .screen-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .scanlines {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 100, 255, 0.03) 50%
            );
            background-size: 100% 4px;
        }

        /* ===== 頁面管理 ===== */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            transition: opacity 0.3s ease;
            display: none;
        }

        .page.active {
            display: block;
            opacity: 1;
            position: relative;
            z-index: 2;
        }

        .page.hidden {
            display: none;
            opacity: 0;
        }

        /* ===== 導航欄樣式 ===== */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(10, 10, 30, 0.95));
            border-bottom: 2px solid rgba(0, 100, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 100, 255, 0.2);
        }

        .nav-logo {
            font-size: 1.3rem;
            font-weight: bold;
            color: #4a90d9;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px rgba(74, 144, 217, 0.5);
        }

        .nav-logo:hover {
            filter: drop-shadow(0 0 15px rgba(74, 144, 217, 0.7));
        }

        .nav-menu {
            display: flex;
            gap: 30px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-menu li a {
            color: #aaa;
            text-decoration: none;
            font-size: 0.95rem;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 4px;
        }

        .nav-menu li a:hover {
            color: #4a90d9;
            background: rgba(74, 144, 217, 0.1);
            box-shadow: 0 0 10px rgba(74, 144, 217, 0.3);
        }

        .nav-menu li a.active {
            color: #4a90d9;
            border-bottom: 2px solid #4a90d9;
        }

        /* ===== 主頁面樣式 ===== */
        #main-page {
            background: linear-gradient(135deg, #0a0a1a 0%, #050510 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px 40px;
        }

        .main-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 0 20px;
        }

        .season-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff9900 0%, #ff6600 100%);
            color: #000;
            font-weight: bold;
            padding: 8px 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.5);
            text-transform: uppercase;
        }

        .main-logo {
            font-size: 3.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #4a90d9 0%, #357abd 25%, #6ab0ff 50%, #4a90d9 75%, #7bbfff 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(74, 144, 217, 0.6), 0 0 40px rgba(74, 144, 217, 0.3);
            margin-bottom: 20px;
            letter-spacing: 4px;
            animation: logoShine 4s ease-in-out infinite;
            text-align: center;
            filter: drop-shadow(0 0 25px rgba(74, 144, 217, 0.5));
        }

        @keyframes logoShine {
            0%, 100% {
                background-position: 0% 50%;
                filter: drop-shadow(0 0 25px rgba(74, 144, 217, 0.5));
            }
            50% {
                background-position: 100% 50%;
                filter: drop-shadow(0 0 40px rgba(74, 144, 217, 0.7));
            }
        }

        .main-subtitle {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 10px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-align: center;
        }

        .main-tagline {
            color: #666;
            font-size: 1rem;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto 40px;
            text-align: center;
        }

        /* ===== 模式選擇 ===== */
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            padding: 0 20px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .mode-selection {
                grid-template-columns: 1fr;
                max-width: 500px;
            }
        }

        .mode-card {
            background: rgba(25, 25, 40, 0.95);
            border-radius: 15px;
            padding: 35px 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.320, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .mode-card:hover::before {
            left: 100%;
        }

        .mode-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
        }

        .mode-card.hacker {
            border-color: #00ff41;
            box-shadow: 0 0 25px rgba(0, 255, 65, 0.2);
        }

        .mode-card.hacker:hover {
            box-shadow: 0 0 40px rgba(0, 255, 65, 0.4);
        }

        .mode-card.law-enforcement {
            border-color: #4a90d9;
            box-shadow: 0 0 25px rgba(74, 144, 217, 0.2);
        }

        .mode-card.law-enforcement:hover {
            box-shadow: 0 0 40px rgba(74, 144, 217, 0.4);
        }

        .mode-icon {
            font-size: 3.5rem;
            margin-bottom: 25px;
            text-align: center;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-card.hacker .mode-icon {
            color: #00ff41;
        }

        .mode-card.law-enforcement .mode-icon {
            color: #4a90d9;
        }

        .mode-title {
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .mode-card.hacker .mode-title {
            color: #00ff41;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        .mode-card.law-enforcement .mode-title {
            color: #4a90d9;
            text-shadow: 0 0 10px rgba(74, 144, 217, 0.5);
        }

        .mode-description {
            color: #bbb;
            line-height: 1.7;
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.05rem;
        }

        .mode-features {
            list-style: none;
            margin-bottom: 30px;
        }

        .mode-features li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            padding-left: 30px;
            display: flex;
            align-items: center;
        }

        .mode-features li:before {
            content: "⟩";
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .mode-card.hacker .mode-features li:before {
            color: #00ff41;
        }

        .mode-card.law-enforcement .mode-features li:before {
            color: #4a90d9;
        }

        .feature-icon {
            margin-right: 12px;
            font-size: 1rem;
            width: 22px;
            text-align: center;
        }

        .select-btn {
            display: block;
            width: 100%;
            padding: 18px;
            text-align: center;
            border-radius: 10px;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.320, 1);
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .select-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .select-btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .hacker-btn {
            background: rgba(0, 255, 65, 0.15);
            color: #00ff41;
            border: 2px solid #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        }

        .hacker-btn:hover {
            background: rgba(0, 255, 65, 0.25);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.5), inset 0 0 20px rgba(0, 255, 65, 0.1);
        }

        .law-enforcement-btn {
            background: rgba(74, 144, 217, 0.15);
            color: #4a90d9;
            border: 2px solid #4a90d9;
            box-shadow: 0 0 20px rgba(74, 144, 217, 0.2);
        }

        .law-enforcement-btn:hover {
            background: rgba(74, 144, 217, 0.25);
            box-shadow: 0 0 30px rgba(74, 144, 217, 0.5), inset 0 0 20px rgba(74, 144, 217, 0.1);
        }

        /* ===== 對戰設置頁面 ===== */
        #season2-setup-page .main-header {
            margin-bottom: 30px;
        }

        .setup-container {
            background: rgba(25, 25, 40, 0.95);
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 40px;
            border: 2px solid rgba(74, 144, 217, 0.3);
            box-shadow: 0 0 30px rgba(74, 144, 217, 0.2);
        }

        .setup-title {
            font-size: 1.8rem;
            margin-bottom: 30px;
            text-align: center;
            color: #4a90d9;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .setup-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setup-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #4a90d9;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 1.05rem;
        }

        .setting-input {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(74, 144, 217, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .setting-input:focus {
            outline: none;
            border-color: #4a90d9;
            box-shadow: 0 0 10px rgba(74, 144, 217, 0.3);
        }

        .setting-input::placeholder {
            color: #666;
        }

        .setting-note {
            color: #888;
            font-size: 0.9rem;
            margin-top: 8px;
            line-height: 1.5;
        }

        .difficulty-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .difficulty-card {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(74, 144, 217, 0.2);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .difficulty-card:hover {
            background: rgba(74, 144, 217, 0.1);
            border-color: rgba(74, 144, 217, 0.5);
        }

        .difficulty-card.selected {
            background: rgba(74, 144, 217, 0.2);
            border-color: #4a90d9;
            box-shadow: 0 0 15px rgba(74, 144, 217, 0.4);
        }

        .difficulty-level {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4a90d9;
        }

        .difficulty-desc {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .difficulty-time {
            color: #ff9900;
            font-weight: bold;
        }

        /* ===== 遊戲頁面通用樣式 ===== */
        .game-container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 80px 20px 20px;
            min-height: 100vh;
        }

        /* 黑客模式主題 */
        .hacker-ui {
            --primary-color: #00ff41;
            --secondary-color: #0088ff;
            --danger-color: #ff3333;
            --bg-color: rgba(10, 30, 20, 0.95);
            --panel-bg: rgba(5, 15, 10, 0.9);
            --text-color: #e0ffe0;
        }

        /* 執法部門主題 */
        .law-enforcement-ui {
            --primary-color: #4a90d9;
            --secondary-color: #6ab0ff;
            --danger-color: #ff3333;
            --bg-color: rgba(20, 20, 40, 0.95);
            --panel-bg: rgba(15, 15, 30, 0.9);
            --text-color: #e0e0ff;
        }

        /* 遊戲頭部 */
        .game-header {
            background: var(--bg-color);
            border-radius: 15px;
            padding: 25px 30px;
            margin-bottom: 30px;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .game-title-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .game-mode-icon {
            font-size: 3rem;
            color: var(--primary-color);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-shadow: 0 0 10px var(--primary-color);
            letter-spacing: 2px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff41;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background: #ff3333;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .target-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid var(--secondary-color);
        }

        .target-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .target-ip {
            font-family: 'Monaco', monospace;
            color: var(--primary-color);
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .game-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
            width: 100%;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px 25px;
            border: 1px solid var(--primary-color);
            min-width: 180px;
            flex: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* 執法部門專用統計卡片 */
        .evidence-stat {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px 25px;
            border: 1px solid #4a90d9;
            min-width: 180px;
            flex: 1;
        }

        .evidence-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .evidence-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4a90d9;
        }

        /* 主遊戲區域 */
        .game-main {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1400px) {
            .game-main {
                grid-template-columns: 1fr;
            }
        }

        /* 左側主面板 */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 終端機 */
        .terminal-container {
            background: rgba(5, 5, 5, 0.95);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }

        .terminal-header {
            background: linear-gradient(90deg, 
                rgba(0, 0, 0, 0.8), 
                rgba(20, 20, 30, 0.8));
            padding: 20px;
            border-bottom: 1px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .terminal-status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .terminal-body {
            padding: 25px;
            flex: 1;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            max-height: 500px;
        }

        .terminal-body::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-body::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .terminal-body::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .terminal-output {
            flex: 1;
            margin-bottom: 20px;
        }

        .terminal-line {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.3s ease;
            word-break: break-word;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .terminal-line.command {
            color: var(--primary-color);
            font-weight: bold;
            border-left: 3px solid var(--primary-color);
        }

        .terminal-line.response {
            color: var(--secondary-color);
        }

        .terminal-line.success {
            color: #00ff88;
            border-left: 3px solid #00ff88;
        }

        .terminal-line.error {
            color: #ff5555;
            border-left: 3px solid #ff5555;
        }

        .terminal-line.warning {
            color: #ffaa00;
            border-left: 3px solid #ffaa00;
        }

        .terminal-line.system {
            color: #aaa;
            font-style: italic;
        }

        .terminal-line.alert {
            color: #ff3333;
            background: rgba(255, 51, 51, 0.1);
            border-left: 3px solid #ff3333;
            animation: alertPulse 1s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .terminal-input-container {
            display: flex;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .terminal-prompt {
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 15px;
            min-width: 150px;
            font-family: 'Monaco', monospace;
        }

        .terminal-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.1rem;
            flex: 1;
            outline: none;
            caret-color: var(--primary-color);
            font-family: 'Monaco', monospace;
        }

        .input-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .suggestion-btn {
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: #ccc;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* 工具面板 */
        .tools-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
            min-height: 300px;
        }

        .tools-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tools-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn.active {
            background: var(--primary-color);
            color: black;
            border-color: var(--primary-color);
        }

        .category-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .tool-card {
            background: linear-gradient(135deg, rgba(0, 150, 255, 0.3), rgba(0, 100, 200, 0.3));
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #0099ff;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 150, 255, 0.5);
            background: linear-gradient(135deg, rgba(0, 180, 255, 0.5), rgba(0, 130, 230, 0.5));
            border-color: #00ccff;
        }

        .tool-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tool-card.disabled:hover {
            transform: none;
            box-shadow: none;
            background: rgba(30, 30, 40, 0.8);
        }

        .law-enforcement-ui .tool-card {
            background: linear-gradient(135deg, rgba(74, 144, 217, 0.3), rgba(53, 122, 189, 0.3));
            border-color: #4a90d9;
        }

        .law-enforcement-ui .tool-card:hover {
            border-color: #6ab0ff;
            box-shadow: 0 0 20px rgba(74, 144, 217, 0.7);
            background: linear-gradient(135deg, rgba(100, 170, 255, 0.5), rgba(74, 144, 217, 0.5));
        }

        .tool-icon {
            font-size: 2.5rem;
            color: #00ff99;
            margin-bottom: 15px;
        }

        .law-enforcement-ui .tool-icon {
            color: #6ab0ff;
        }

        .tool-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffffff;
            font-size: 1.1rem;
            text-shadow: 0 0 5px rgba(0, 255, 153, 0.5);
        }

        .law-enforcement-ui .tool-name {
            color: #ffffff;
            text-shadow: 0 0 5px rgba(74, 144, 217, 0.5);
        }

        .tool-desc {
            color: #cccccc;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .tool-cooldown {
            font-size: 0.8rem;
            color: #ffaa00;
            margin-top: 10px;
        }

        /* 右側面板 */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 對戰信息面板 */
        .battle-info {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
        }

        .battle-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .opponent-info {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .opponent-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .opponent-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .detail-value {
            font-family: 'Monaco', monospace;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* 證據面板（執法部門專用） */
        .evidence-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
        }

        .evidence-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .evidence-chain {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
            max-height: 250px;
            overflow-y: auto;
        }

        .evidence-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 4px solid #4a90d9;
            transition: all 0.3s;
        }

        .evidence-item.contaminated {
            border-left-color: #ff3333;
            background: rgba(255, 51, 51, 0.1);
        }

        .evidence-item.critical {
            border-left-color: #ff9900;
            background: rgba(255, 153, 0, 0.1);
        }

        .evidence-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #fff;
        }

        .evidence-desc {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .evidence-status {
            font-size: 0.8rem;
            color: #4a90d9;
        }

        .evidence-status.contaminated {
            color: #ff3333;
        }

        /* 身份鎖定面板（執法部門專用） */
        .identity-panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
        }

        .identity-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .identity-tiers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .identity-tier {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--secondary-color);
        }

        .tier-name {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .tier-progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .tier-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90d9, #6ab0ff);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .tier-percentage {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .tier-requirement {
            font-size: 0.8rem;
            color: #888;
            margin-top: 5px;
        }

        /* 逮捕令面板 */
        .warrant-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .warrant-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .warrant-label {
            font-size: 1rem;
            color: #aaa;
        }

        .warrant-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9900;
        }

        .warrant-progress {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .warrant-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9900, #ffcc00);
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .warrant-actions {
            display: flex;
            gap: 10px;
        }

        /* 控制按鈕 */
        .game-controls {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 25px;
            border: 2px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .control-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 2px solid;
            font-size: 1rem;
            letter-spacing: 1px;
            background: rgba(0, 0, 0, 0.3);
        }

        .btn:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 15px currentColor;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(255, 51, 51, 0.2);
            color: #ff3333;
            border-color: #ff3333;
        }

        .btn-success {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
            border-color: #00ff41;
        }

        .btn-warning {
            background: rgba(255, 153, 0, 0.2);
            color: #ff9900;
            border-color: #ff9900;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: #666;
        }

        /* 通知系統 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 30, 0.95);
            border-left: 4px solid;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.hacker {
            border-left-color: #00ff41;
        }

        .notification.law-enforcement {
            border-left-color: #4a90d9;
        }

        .notification.warning {
            border-left-color: #ffaa00;
        }

        .notification.danger {
            border-left-color: #ff3333;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-message {
            color: #ccc;
            line-height: 1.5;
        }

        /* ===== 響應式設計 ===== */
        @media (max-width: 1200px) {
            .game-main {
                grid-template-columns: 1fr;
            }
            
            .identity-tiers {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-logo {
                font-size: 2.5rem;
            }
            
            .mode-selection {
                grid-template-columns: 1fr;
                max-width: 500px;
                margin: 0 auto 30px;
            }

            .mode-card {
                padding: 25px 20px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .game-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .game-stats {
                justify-content: center;
            }
            
            .stat-card, .evidence-stat {
                min-width: 140px;
            }
            
            .tools-grid {
                grid-template-columns: 1fr;
            }
            
            .control-group {
                justify-content: center;
            }
            
            .difficulty-options {
                grid-template-columns: 1fr;
            }
            
            nav {
                padding: 0 15px;
            }
            
            .nav-menu {
                gap: 15px;
            }
            
            .nav-menu li a {
                padding: 6px 10px;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .main-logo {
                font-size: 2rem;
            }
            
            .mode-title {
                font-size: 1.5rem;
            }
            
            .game-title {
                font-size: 1.8rem;
            }
            
            .stat-card, .evidence-stat {
                min-width: 100%;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .setup-container {
                padding: 20px;
            }
        }

        /* ===== 自定義模態框 ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 2px solid #4a90d9;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(74, 144, 217, 0.3);
            position: relative;
        }

        .modal-title {
            color: #4a90d9;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-message {
            color: #ccc;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-input {
            width: 100%;
            padding: 14px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(74, 144, 217, 0.5);
            border-radius: 8px;
            color: #4a90d9;
            font-family: inherit;
            font-size: 16px;
            margin-bottom: 25px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #4a90d9;
            box-shadow: 0 0 10px rgba(74, 144, 217, 0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .modal-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .modal-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%);
            color: #fff;
        }

        .modal-btn-confirm:hover {
            box-shadow: 0 0 15px rgba(74, 144, 217, 0.5);
        }

        .modal-btn-danger {
            background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
            color: #fff;
        }

        .modal-btn-danger:hover {
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.5);
        }

        /* ===== 結果頁面 ===== */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .result-overlay.active {
            display: flex;
        }

        .result-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 95%;
            text-align: center;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.7);
            border: 3px solid;
            animation: resultPulse 2s infinite;
        }

        @keyframes resultPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(74, 144, 217, 0.5); }
            50% { box-shadow: 0 0 50px rgba(74, 144, 217, 0.8); }
        }

        .result-box.victory {
            border-color: #00ff41;
        }

        .result-box.defeat {
            border-color: #ff3333;
        }

        .result-box.arrest {
            border-color: #4a90d9;
        }

        .result-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 15px currentColor);
        }

        .result-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .result-box.victory .result-title {
            color: #00ff41;
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.5);
        }

        .result-box.defeat .result-title {
            color: #ff3333;
            text-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
        }

        .result-box.arrest .result-title {
            color: #4a90d9;
            text-shadow: 0 0 20px rgba(74, 144, 217, 0.5);
        }

        .result-message {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .result-stats {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
        }

        .result-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-stat:last-child {
            border-bottom: none;
        }

        .result-stat-label {
            color: #aaa;
        }

        .result-stat-value {
            color: #fff;
            font-weight: bold;
        }

        .result-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .result-btn {
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
            border: 2px solid;
        }

        .result-btn-primary {
            background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%);
            color: #fff;
            border-color: #4a90d9;
        }

        .result-btn-primary:hover {
            box-shadow: 0 0 20px rgba(74, 144, 217, 0.5);
        }

        .result-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: #666;
        }

        .result-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* 新增加的樣式 */
        .department-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .department-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .department-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-active {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }

        .status-inactive {
            background: rgba(255, 51, 51, 0.2);
            color: #ff3333;
        }

        .department-resources {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .resource-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .resource-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .resource-value {
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
        }

        .critical-evidence {
            background: rgba(255, 153, 0, 0.2);
            border-left: 4px solid #ff9900;
            animation: pulseCritical 2s infinite;
        }

        @keyframes pulseCritical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .evidence-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .evidence-action-btn {
            padding: 5px 10px;
            background: rgba(74, 144, 217, 0.3);
            border: 1px solid #4a90d9;
            border-radius: 4px;
            color: #fff;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .evidence-action-btn:hover {
            background: rgba(74, 144, 217, 0.5);
        }

        .arrest-countdown {
            background: rgba(255, 153, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            animation: pulseArrest 1s infinite;
        }

        @keyframes pulseArrest {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 153, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 153, 0, 0.8); }
        }

        .arrest-timer {
            font-size: 2rem;
            font-weight: bold;
            color: #ff9900;
            margin: 10px 0;
        }

        .server-health {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .health-bar {
            flex: 1;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff41, #00aa00);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .health-text {
            font-size: 0.9rem;
            color: #fff;
            min-width: 40px;
        }

        .investigation-report {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }

        .report-line {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .evidence-quality {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .quality-indicator {
            height: 8px;
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff3333, #ff9900, #00ff41);
            border-radius: 4px;
        }

        /* 新功能樣式 */
        .dynamic-intel-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .intel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .intel-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4a90d9;
        }

        .intel-verification {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }

        .intel-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .intel-item {
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid #4a90d9;
        }

        .intel-item.fake {
            border-left-color: #ff3333;
            background: rgba(255, 51, 51, 0.1);
        }

        .compromised-device {
            background: rgba(255, 153, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ff9900;
        }

        .device-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 4px;
        }

        .info-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 3px;
        }

        .info-value {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #fff;
        }

        .decryption-panel {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ff9900;
        }

        .decryption-progress {
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .decryption-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9900, #ffcc00);
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .network-sweep {
            background: rgba(74, 144, 217, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #4a90d9;
            animation: networkSweepPulse 2s infinite;
        }

        @keyframes networkSweepPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(74, 144, 217, 0.5); }
            50% { box-shadow: 0 0 20px rgba(74, 144, 217, 0.8); }
        }

        .fake-command-log {
            background: rgba(255, 51, 51, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ff3333;
            max-height: 150px;
            overflow-y: auto;
        }

        .command-entry {
            padding: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Monaco', monospace;
            font-size: 0.85rem;
        }

        .command-entry.fake {
            color: #ff3333;
        }

        .command-entry.real {
            color: #00ff41;
        }

        .advanced-tool-card {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.3), rgba(255, 102, 0, 0.3));
            border-color: #ff9900;
        }

        .advanced-tool-card:hover {
            border-color: #ffcc00;
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.7);
            background: linear-gradient(135deg, rgba(255, 180, 0, 0.5), rgba(255, 130, 0, 0.5));
        }

        .darknet-market {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #00ff41;
        }

        .market-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: rgba(0, 255, 65, 0.1);
            border-radius: 4px;
        }

        .gps-tracker {
            background: rgba(0, 150, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #0096ff;
        }

        .tracker-map {
            height: 100px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        .tracker-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff3333;
            animation: trackerPulse 1s infinite;
        }

        @keyframes trackerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        .signal-jammer {
            background: rgba(255, 0, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ff00ff;
            animation: jammerPulse 1.5s infinite;
        }

        @keyframes jammerPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 0, 255, 0.8); }
        }

        /* 截圖風格的版面樣式 */
        .target-system-info {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .system-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .system-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
        }

        .system-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .system-value {
            font-family: 'Monaco', monospace;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .attack-path-visualization {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--primary-color);
        }

        .path-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .path-timeline {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .path-event {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }

        .path-time {
            color: #aaa;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }

        .path-action {
            color: var(--primary-color);
            font-weight: bold;
        }

        .system-status-bars {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .status-bar {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .status-label {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .status-percentage {
            font-size: 0.8rem;
            color: #ff9900;
            margin-top: 5px;
        }

        /* 商店系統增強 */
        .shop-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        .shop-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .shop-category {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shop-category.active {
            background: #4a90d9;
            color: #000;
            border-color: #4a90d9;
        }

        .shop-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .shop-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .shop-item-name {
            color: #fff;
            font-weight: bold;
        }

        .shop-item-price {
            color: #ff9900;
            font-weight: bold;
        }

        .shop-item-desc {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .shop-item-effect {
            color: #00ff41;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        /* 充值系統 */
        .topup-section {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #ff9900;
        }

        .topup-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .topup-option {
            background: rgba(255, 153, 0, 0.2);
            border: 1px solid #ff9900;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .topup-option:hover {
            background: rgba(255, 153, 0, 0.4);
        }

        .topup-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9900;
        }

        .topup-price {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 5px;
        }

        /* 交易歷史 */
        .transaction-history {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .transaction-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }

        .transaction-type {
            font-weight: bold;
        }

        .transaction-type.purchase {
            color: #00ff41;
        }

        .transaction-type.topup {
            color: #ff9900;
        }

        .transaction-amount {
            color: #fff;
        }

        .transaction-time {
            color: #aaa;
            font-size: 0.8rem;
        }

        /* 任務目標面板 */
        .mission-panel {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-color);
        }

        .mission-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mission-item {
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mission-name {
            color: #ccc;
        }

        .mission-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .mission-complete {
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }

        .mission-incomplete {
            background: rgba(255, 153, 0, 0.2);
            color: #ff9900;
        }

        /* 攻擊/防禦視覺化 */
        .attack-defense-visualization {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--primary-color);
        }

        .visualization-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .progress-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-label {
            width: 120px;
            color: #aaa;
            font-size: 0.9rem;
        }

        .progress-container {
            flex: 1;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .attack-progress {
            background: linear-gradient(90deg, #ff3333, #ff9900);
        }

        .defense-progress {
            background: linear-gradient(90deg, #4a90d9, #6ab0ff);
        }

        .stealth-progress {
            background: linear-gradient(90deg, #00ff41, #00aa00);
        }

        /* 擴充的系統健康視覺化 */
        .health-visualization {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .health-card {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .health-card-title {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .health-card-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .health-card.high {
            border: 1px solid #00ff41;
            color: #00ff41;
        }

        .health-card.medium {
            border: 1px solid #ff9900;
            color: #ff9900;
        }

        .health-card.low {
            border: 1px solid #ff3333;
            color: #ff3333;
        }

        /* 實時目標信息顯示增強 */
        .target-realtime-info {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid var(--secondary-color);
        }

        .realtime-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .realtime-name {
            color: var(--primary-color);
            font-weight: bold;
        }

        .realtime-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }

        .realtime-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .realtime-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .realtime-label {
            font-size: 0.7rem;
            color: #aaa;
            margin-bottom: 3px;
        }

        .realtime-value {
            font-size: 0.9rem;
            color: #fff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- 導航欄 -->
    <nav id="navbar">
        <div class="nav-logo" onclick="goToMainPage()">
            <i class="fas fa-gavel"></i> 執法對決 SEASON 2
        </div>
        <ul class="nav-menu">
            <li><a onclick="goToMainPage()" id="nav-home">主頁</a></li>
            <li><a onclick="showSetupPage()" id="nav-season2">開始第二季對戰</a></li>
            <li><a onclick="showGuide()" id="nav-guide">操作指南</a></li>
            <li><a onclick="openShop()" id="nav-shop">商店</a></li>
            <li><a onclick="openTransactionHistory()" id="nav-history">交易記錄</a></li>
        </ul>
    </nav>

    <!-- 屏幕效果 -->
    <div class="screen-effects">
        <div class="scanlines"></div>
    </div>

    <!-- 通知系統 -->
    <div class="notification" id="notification">
        <div class="notification-title" id="notification-title">
            <i class="fas fa-info-circle"></i>
            <span id="notification-title-text">系統通知</span>
        </div>
        <div class="notification-message" id="notification-message"></div>
    </div>

    <!-- 主頁面 -->
    <div id="main-page" class="page active">
        <div class="main-header">
            <div class="season-badge">SEASON 2 • 執法對決</div>
            <div class="main-logo">黑客 vs 執法部門</div>
            <div class="main-subtitle">對戰模式第二季 • 高強度身份攻防戰</div>
            <div class="main-tagline">
                延續第一季的激烈對戰，第二季帶來全新的「黑客 vs 執法部門」對決！
                黑客需要隱藏身份逃脫追捕，執法部門則需調查證據鎖定身份。雙方都有強大的專屬工具和策略系統。
                這是一場真正的智力與技術的較量！
            </div>
        </div>

        <!-- 模式選擇 -->
        <div class="mode-selection">
            <!-- 黑客模式卡片 -->
            <div class="mode-card hacker">
                <div class="mode-icon">
                    <i class="fas fa-user-secret"></i>
                </div>
                <div class="mode-title">扮演黑客</div>
                <div class="mode-description">
                    作為頂尖黑客，你需要隱藏身份、清除數碼足跡、反制調查，並在必要時發動反擊。
                    使用全新專屬工具保護自己，逃脫執法部門的追捕。
                </div>
                <ul class="mode-features">
                    <li>
                        <span class="feature-icon"><i class="fas fa-eraser"></i></span>
                        <span>清除數碼足跡與流量偽裝</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-virus-slash"></i></span>
                        <span>證據污染與數據注入攻擊</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-mask"></i></span>
                        <span>身份隱藏與動態跳板網絡</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-bug"></i></span>
                        <span>干擾執法部門分析工具</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-skull-crossbones"></i></span>
                        <span>反擊執法部門系統</span>
                    </li>
                </ul>
                <button class="select-btn hacker-btn" onclick="selectRole('hacker')">
                    <i class="fas fa-skull-crossbones"></i>
                    <span>選擇黑客角色</span>
                </button>
            </div>

            <!-- 執法部門模式卡片 -->
            <div class="mode-card law-enforcement">
                <div class="mode-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="mode-title">執法部門</div>
                <div class="mode-description">
                    作為網絡安全執法部門，你需要調查黑客身份、收集證據鏈、鎖定目標，
                    並申請逮捕令進行最終拘捕。使用先進的調查工具和分析系統。
                </div>
                <ul class="mode-features">
                    <li>
                        <span class="feature-icon"><i class="fas fa-search"></i></span>
                        <span>高強度調查與證據分析</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-fingerprint"></i></span>
                        <span>三階層身份鎖定機制</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-users-cog"></i></span>
                        <span>跨部門協作與資源管理</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-file-contract"></i></span>
                        <span>逮捕令申請與執行系統</span>
                    </li>
                    <li>
                        <span class="feature-icon"><i class="fas fa-server"></i></span>
                        <span>指揮中心與證據庫防禦</span>
                    </li>
                </ul>
                <button class="select-btn law-enforcement-btn" onclick="selectRole('law_enforcement')">
                    <i class="fas fa-shield-alt"></i>
                    <span>選擇執法部門角色</span>
                </button>
            </div>
        </div>

        <!-- 版權聲明 -->
        <div class="copyright" style="text-align: center; padding: 40px 20px 20px; color: #666; font-size: 0.9rem; max-width: 800px; margin: 0 auto;">
            <div style="background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.2); border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center; color: #ff5555; font-size: 0.9rem; line-height: 1.5;">
                <strong>⚠️ 重要聲明：</strong><br>
                這是純粹的網絡安全教育模擬平台，所有操作均為模擬效果，不會影響真實系統。
                平台不會收集任何個人或私隱資料，也不建議進行真實的非法黑客行為。
                模擬器旨在幫助了解網絡攻防流程與執法調查過程。
            </div>
            
            <p>
                <strong>© 2025 對戰模式第二季 • 執法對決 SEASON 2</strong><br>
                版權所有 © 2025 Sam. T. 保留所有權利。<br>
                此平台為第一季對戰模式的續集版本，專為網絡安全教育而設計。
            </p>
        </div>
    </div>

    <!-- 對戰設置頁面 -->
    <div id="season2-setup-page" class="page">
        <div class="main-header">
            <div class="season-badge">SEASON 2 • 設置對戰</div>
            <div class="main-logo" id="setup-title">對戰設置</div>
            <div class="main-subtitle" id="setup-subtitle">配置你的第二季對戰參數</div>
        </div>

        <div class="setup-container">
            <div class="setup-title">
                <i class="fas fa-cogs"></i>
                <span>第二季對戰設置</span>
            </div>

            <!-- 角色選擇確認 -->
            <div class="setup-section">
                <div class="section-title">
                    <i class="fas fa-user-tag"></i>
                    <span>已選擇角色</span>
                </div>
                <div class="setting-group">
                    <div id="selected-role-display" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #4a90d9;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px; color: #4a90d9;">
                            <i class="fas fa-question-circle"></i>
                            <span id="selected-role-name">尚未選擇角色</span>
                        </div>
                        <div style="color: #aaa; font-size: 0.95rem;" id="selected-role-desc">
                            請返回主頁選擇角色
                        </div>
                    </div>
                </div>
            </div>

            <!-- 對戰設置 -->
            <div class="setup-section">
                <div class="section-title">
                    <i class="fas fa-network-wired"></i>
                    <span>網絡設置</span>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">你的虛擬IP地址：</label>
                    <input type="text" id="player-ip" class="setting-input" value="192.168.1.100" readonly>
                    <div class="setting-note">
                        這是你的唯一識別ID，在對戰中將用於識別你的設備。
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label">對手IP地址：</label>
                    <input type="text" id="opponent-ip" class="setting-input" placeholder="輸入對手IP地址 (例: 192.168.1.200)">
                    <div class="setting-note">
                        輸入對手的虛擬IP地址開始對戰。你可以選擇與AI對戰或與朋友對戰。
                    </div>
                </div>
            </div>

            <!-- AI難度設置 -->
            <div class="setup-section">
                <div class="section-title">
                    <i class="fas fa-robot"></i>
                    <span>AI對手難度</span>
                </div>
                
                <div class="setting-group">
                    <label class="setting-label">選擇AI難度級別：</label>
                    <div class="difficulty-options">
                        <div class="difficulty-card" onclick="selectDifficulty('rookie')">
                            <div class="difficulty-level" style="color: #00ff41;">新手級</div>
                            <div class="difficulty-desc">AI反應較慢，適合學習玩法</div>
                            <div class="difficulty-time">對戰時間: 30分鐘</div>
                        </div>
                        
                        <div class="difficulty-card selected" onclick="selectDifficulty('professional')">
                            <div class="difficulty-level" style="color: #4a90d9;">專業級</div>
                            <div class="difficulty-desc">標準AI對手，平衡的挑戰性</div>
                            <div class="difficulty-time">對戰時間: 25分鐘</div>
                        </div>
                        
                        <div class="difficulty-card" onclick="selectDifficulty('elite')">
                            <div class="difficulty-level" style="color: #ff9900;">精英級</div>
                            <div class="difficulty-desc">AI反應迅速，具有侵略性</div>
                            <div class="difficulty-time">對戰時間: 20分鐘</div>
                        </div>
                        
                        <div class="difficulty-card" onclick="selectDifficulty('legendary')">
                            <div class="difficulty-level" style="color: #ff3333;">傳奇級</div>
                            <div class="difficulty-desc">最高難度，AI使用高級策略</div>
                            <div class="difficulty-time">對戰時間: 15分鐘</div>
                        </div>
                    </div>
                    <div class="setting-note">
                        難度越高，AI對手的反應速度越快，使用的策略也越複雜。
                    </div>
                </div>
            </div>

            <!-- 開始對戰按鈕 -->
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="startSeason2Battle()" style="padding: 18px 50px; font-size: 1.2rem;">
                    <i class="fas fa-play-circle"></i>
                    <span>開始第二季對戰</span>
                </button>
                <div style="margin-top: 20px;">
                    <button class="btn back-btn" onclick="goToMainPage()">
                        <i class="fas fa-arrow-left"></i>
                        <span>返回主頁</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 遊戲頁面 -->
    <div id="game-page" class="page"></div>

    <!-- 自定義模態框 -->
    <div class="modal-overlay" id="custom-modal">
        <div class="modal-box">
            <div class="modal-title">
                <i class="fas fa-terminal"></i>
                <span id="modal-title-text">系統提示</span>
            </div>
            <div class="modal-message" id="modal-message"></div>
            <input type="text" class="modal-input" id="modal-input" style="display: none;">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">取消</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">確定</button>
            </div>
        </div>
    </div>

    <!-- 結果頁面 -->
    <div class="result-overlay" id="result-overlay">
        <div class="result-box" id="result-box">
            <div class="result-icon" id="result-icon"></div>
            <div class="result-title" id="result-title"></div>
            <div class="result-message" id="result-message"></div>
            <div class="result-stats" id="result-stats"></div>
            <div class="result-actions">
                <button class="result-btn result-btn-primary" onclick="goToMainPage()">
                    <i class="fas fa-home"></i> 返回主頁
                </button>
                <button class="result-btn result-btn-secondary" onclick="showSetupPage()">
                    <i class="fas fa-redo"></i> 重新對戰
                </button>
            </div>
        </div>
    </div>

    <!-- 商店頁面 -->
    <div class="modal-overlay" id="shop-modal">
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-title">
                <i class="fas fa-shopping-cart"></i>
                <span id="shop-title">商店</span>
            </div>
            <div class="modal-message" id="shop-message"></div>
        </div>
    </div>

    <!-- 交易歷史頁面 -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal-box" style="max-width: 800px;">
            <div class="modal-title">
                <i class="fas fa-history"></i>
                <span>交易歷史記錄</span>
            </div>
            <div class="modal-message" id="history-message"></div>
        </div>
    </div>

    <script>
        // ===== 全局變量 =====
        let GameState = {
            currentRole: null,
            currentPage: 'main',
            gameActive: false,
            connectionStatus: 'disconnected',
            playerIP: '192.168.1.100',
            opponentIP: '',
            difficulty: 'professional',
            gameMode: 'season2',
            
            // 交易記錄
            transactionHistory: [],
            
            // 玩家數據
            playerData: {
                hacker: {
                    money: 150000,
                    stealth: 60,
                    encryptionLevel: 40,
                    tools: [],
                    cooldowns: {},
                    attackPower: 15,
                    defensePower: 10,
                    controlProgress: 0,
                    digitalFootprints: 5,
                    compromisedEvidence: 0,
                    serverHealth: 100,
                    deviceHealth: 100,
                    criticalSystems: ['command_center', 'evidence_library', 'network_infrastructure'],
                    stolenDocuments: [],
                    decryptionProgress: 0,
                    compromisedDevices: [],
                    darknetCredits: 0,
                    activeVpnNodes: 3,
                    signalJamming: false,
                    realtimeIntel: [],
                    shopItems: [
                        { id: 'vpn_chain', name: '高級VPN鏈', price: 20000, effect: '+20%隱蔽度', category: 'stealth' },
                        { id: 'zero_day', name: '零日漏洞利用', price: 50000, effect: '+40攻擊力', category: 'attack' },
                        { id: 'crypto_mixer', name: '加密貨幣混合器', price: 30000, effect: '資金追蹤干擾', category: 'stealth' },
                        { id: 'ai_evasion', name: 'AI逃避工具', price: 40000, effect: '降低被偵測機率', category: 'stealth' },
                        { id: 'memory_attack', name: '記憶體無檔案攻擊套件', price: 60000, effect: '無痕跡攻擊', category: 'attack' },
                        { id: 'dynamic_proxy', name: '動態跳板網絡', price: 45000, effect: '隨機路由隱藏', category: 'stealth' },
                        { id: 'bait_server', name: '誘餌伺服器', price: 35000, effect: '誤導追蹤', category: 'counter' },
                        { id: 'fake_fingerprint', name: '偽造攻擊指紋工具', price: 55000, effect: '偽裝攻擊來源', category: 'counter' },
                        { id: 'signal_jammer', name: '協作頻道干擾器', price: 40000, effect: '阻斷通訊', category: 'counter' },
                        { id: 'darknet_access', name: '暗網委託市場介面', price: 70000, effect: '購買黑市工具', category: 'advanced' },
                        { id: 'phishing_kit', name: '社會工程釣魚生成器', price: 30000, effect: '欺騙目標', category: 'infiltration' },
                        { id: 'vulnerability_storage', name: '零漏洞儲存與部署模組', price: 80000, effect: '儲存攻擊工具', category: 'attack' },
                        { id: 'encryption_relay', name: '加密通道中繼器', price: 35000, effect: '加強加密通訊', category: 'stealth' },
                        { id: 'hardware_spoof', name: '硬體指紋偽造器', price: 50000, effect: '偽造設備識別', category: 'stealth' },
                        { id: 'node_crippler', name: '網路節點癱瘓工具', price: 65000, effect: '癱瘓網絡節點', category: 'attack' },
                        { id: 'ransomware', name: '高級勒索軟件', price: 75000, effect: '加密目標文件勒索', category: 'attack' },
                        { id: 'traffic_encryptor', name: '流量加密器', price: 45000, effect: '完全加密所有流量', category: 'stealth' },
                        { id: 'identity_hider', name: '身份隱藏器', price: 55000, effect: '完全隱藏真實身份', category: 'stealth' },
                        { id: 'file_wiper', name: '文件擦除器', price: 40000, effect: '完全刪除痕跡', category: 'counter' },
                        { id: 'backdoor_implant', name: '持久後門植入', price: 60000, effect: '永久系統訪問', category: 'infiltration' }
                    ]
                },
                law_enforcement: {
                    budget: 200000,
                    investigationProgress: 0,
                    evidenceChain: [],
                    criticalEvidence: [],
                    identityLock: {
                        technical: 0,
                        social: 0,
                        physical: 0
                    },
                    warrantProgress: 0,
                    warrantIssued: false,
                    arrestCountdown: null,
                    departments: {
                        cyber: { name: '網絡安全調查部門', active: true, resources: 100 },
                        criminal: { name: '刑事偵緝科', active: false, resources: 0 },
                        antiTerror: { name: '互聯網反恐科', active: false, resources: 0 },
                        forensic: { name: '數碼鑑證科', active: true, resources: 100 }
                    },
                    serverHealth: 100,
                    evidenceLibraryHealth: 100,
                    analysisToolsHealth: 100,
                    tools: [],
                    cooldowns: {},
                    dynamicIntel: [],
                    verifiedIntel: [],
                    networkSweepActive: false,
                    activeHoneypots: 0,
                    compromisedDevices: [],
                    gpsTracking: false,
                    signalBlocking: false,
                    realtimeTracking: [],
                    shopItems: [
                        { id: 'ai_analyst', name: 'AI分析師', price: 30000, effect: '+15%調查速度', category: 'investigation' },
                        { id: 'forensic_suite', name: '高級鑑識套件', price: 50000, effect: '證據質量提升', category: 'investigation' },
                        { id: 'interpol_access', name: '國際刑警資料庫訪問', price: 40000, effect: '全球追蹤能力', category: 'tracking' },
                        { id: 'cyber_swat', name: '網絡特警隊', price: 60000, effect: '即時反應部隊', category: 'defense' },
                        { id: 'digital_sandbox', name: '數碼鑑識沙盒', price: 55000, effect: '深度惡意軟件分析', category: 'investigation' },
                        { id: 'network_mapper', name: '網路流量繪圖儀', price: 45000, effect: '可視化流量分析', category: 'tracking' },
                        { id: 'social_analyzer', name: '社交圖譜分析器', price: 40000, effect: '社交網絡關聯分析', category: 'investigation' },
                        { id: 'threat_sensor', name: '全網威脅感測器', price: 60000, effect: '實時威脅檢測', category: 'defense' },
                        { id: 'emergency_shutdown', name: '緊急斷流', price: 35000, effect: '切斷網絡連接', category: 'defense' },
                        { id: 'intercept_key', name: '合法攔截密鑰', price: 70000, effect: '解密密碼通訊', category: 'decryption' },
                        { id: 'command_panel', name: '跨部門指揮面板', price: 50000, effect: '協調多部門行動', category: 'collaboration' },
                        { id: 'signal_blocker', name: '阻擋防止幹擾信號', price: 45000, effect: '防止通訊干擾', category: 'defense' },
                        { id: 'gps_tracker', name: '超強GPS衛星定位', price: 65000, effect: '精確位置追蹤', category: 'tracking' },
                        { id: 'cctv_access', name: '收集CCTV系統訪問', price: 40000, effect: '監控錄像分析', category: 'tracking' },
                        { id: 'password_cracker', name: '破解裝置加密密碼', price: 75000, effect: '強制解密密碼', category: 'decryption' },
                        { id: 'memory_forensics', name: '內存取證工具', price: 60000, effect: '分析內存攻擊痕跡', category: 'investigation' },
                        { id: 'blockchain_tracker', name: '區塊鏈追蹤系統', price: 80000, effect: '追蹤加密貨幣流向', category: 'tracking' },
                        { id: 'ai_predictor', name: 'AI行為預測系統', price: 90000, effect: '預測黑客行動', category: 'defense' },
                        { id: 'evidence_protector', name: '證據保護系統', price: 55000, effect: '防止證據污染', category: 'defense' },
                        { id: 'rapid_response', name: '快速反應小組', price: 70000, effect: '立即行動能力', category: 'defense' }
                    ]
                }
            },
            
            // 對手數據 (AI)
            opponentData: {
                hacker: {
                    money: 180000,
                    stealth: 70,
                    encryptionLevel: 50,
                    tools: ['nmap', 'metasploit', 'log_cleaner', 'spoofing', 'ddos'],
                    attackPattern: 'aggressive',
                    defenseLevel: 50,
                    digitalFootprints: 5,
                    compromisedEvidence: 0,
                    stolenDocuments: [],
                    activeVpnNodes: 4,
                    signalJamming: false,
                    serverHealth: 100,
                    deviceHealth: 100
                },
                law_enforcement: {
                    budget: 220000,
                    investigationProgress: 0,
                    evidenceChain: [],
                    identityLock: {
                        technical: 0,
                        social: 0,
                        physical: 0
                    },
                    departments: {
                        cyber: { active: true, resources: 100 },
                        criminal: { active: true, resources: 80 },
                        antiTerror: { active: false, resources: 0 },
                        forensic: { active: true, resources: 90 }
                    },
                    aggressionLevel: 40,
                    dynamicIntel: [],
                    networkSweepActive: false,
                    serverHealth: 100,
                    evidenceLibraryHealth: 100,
                    analysisToolsHealth: 100
                }
            },
            
            // 遊戲時間
            gameStartTime: null,
            gameTimeLimit: 1500, // 25分鐘 (預設更長時間)
            gameTimer: null,
            
            // 專屬工具配置 (增強版)
            tools: {
                hacker: {
                    reconnaissance: [
                        { id: "nmap", name: "Nmap掃描器", icon: "fa-search", desc: "掃描目標網絡拓撲和開放端口", cooldown: 5, effect: "scan", cost: 0 },
                        { id: "whois", name: "Whois深度查詢", icon: "fa-address-card", desc: "查詢目標域名註冊信息及歷史記錄", cooldown: 3, effect: "info", cost: 0 },
                        { id: "dns_enum", name: "DNS深度枚舉", icon: "fa-sitemap", desc: "枚舉目標DNS記錄、子域名和關聯服務", cooldown: 4, effect: "info", cost: 0 },
                        { id: "device_scanner", name: "設備掃描器", icon: "fa-mobile-alt", desc: "掃描目標網絡中的連接設備", cooldown: 6, effect: "scan", cost: 5000 },
                        { id: "port_scanner", name: "端口掃描器", icon: "fa-plug", desc: "深度掃描目標開放端口及服務", cooldown: 7, effect: "scan", cost: 3000 }
                    ],
                    stealth: [
                        { id: "log_cleaner", name: "智能日誌清理工具", icon: "fa-eraser", desc: "清除系統日誌、訪問記錄及審計追蹤", cooldown: 8, effect: "stealth", cost: 5000 },
                        { id: "traffic_disguise", name: "AI流量偽裝器", icon: "fa-mask", desc: "使用AI算法偽裝攻擊流量為正常業務流量", cooldown: 10, effect: "stealth", cost: 8000 },
                        { id: "proxy_chain", name: "多重動態代理鏈", icon: "fa-link", desc: "通過7層動態代理隱藏真實IP地址", cooldown: 6, effect: "stealth", cost: 6000 },
                        { id: "traffic_hider", name: "流量/身份隱藏器", icon: "fa-eye-slash", desc: "完全隱藏網絡流量和身份信息", cooldown: 12, effect: "stealth", cost: 15000 },
                        { id: "dynamic_jumpnet", name: "動態跳板網絡", icon: "fa-random", desc: "建立隨機路由的跳板網絡隱藏真實位置", cooldown: 15, effect: "stealth", cost: 20000 },
                        { id: "identity_hider", name: "身份隱藏器", icon: "fa-user-secret", desc: "完全隱藏真實身份信息", cooldown: 18, effect: "stealth", cost: 25000 },
                        { id: "traffic_encryptor", name: "流量加密器", icon: "fa-lock", desc: "完全加密所有網絡流量", cooldown: 14, effect: "stealth", cost: 22000 }
                    ],
                    counter_investigation: [
                        { id: "evidence_pollution", name: "智能證據污染攻擊", icon: "fa-virus", desc: "污染執法部門證據庫並植入混淆數據", cooldown: 15, effect: "counter", cost: 12000 },
                        { id: "analysis_jamming", name: "高級分析工具干擾", icon: "fa-bug", desc: "干擾執法部門的AI分析系統和機器學習模型", cooldown: 12, effect: "counter", cost: 10000 },
                        { id: "fake_command", name: "跨部門偽造協作指令", icon: "fa-file-signature", desc: "模仿執法系統向多部門發送虛假指令", cooldown: 20, effect: "counter", cost: 15000 },
                        { id: "data_injection", name: "數據注入攻擊", icon: "fa-syringe", desc: "向證據庫注入偽造數據污染證據鏈", cooldown: 18, effect: "counter", cost: 14000 },
                        { id: "signal_jammer", name: "協作頻道/信號干擾器", icon: "fa-wifi-slash", desc: "干擾執法部門的通訊和協作頻道", cooldown: 14, effect: "counter", cost: 16000 },
                        { id: "file_wiper", name: "文件擦除器", icon: "fa-trash", desc: "完全刪除系統痕跡和日誌", cooldown: 16, effect: "counter", cost: 18000 },
                        { id: "evidence_protector_breach", name: "證據保護系統破解", icon: "fa-shield-alt", desc: "破解證據保護系統", cooldown: 20, effect: "counter", cost: 20000 }
                    ],
                    attack: [
                        { id: "metasploit", name: "Metasploit框架", icon: "fa-crosshairs", desc: "利用已知系統漏洞進行精準攻擊", cooldown: 10, effect: "attack", cost: 10000 },
                        { id: "ddos", name: "DDoS攻擊集群", icon: "fa-bolt", desc: "發動大規模分散式阻斷服務攻擊", cooldown: 18, effect: "attack", cost: 20000 },
                        { id: "backdoor", name: "持久性後門植入", icon: "fa-door-open", desc: "創建多重隱藏後門維持持久訪問", cooldown: 15, effect: "attack", cost: 15000 },
                        { id: "data_wipe", name: "數據擦除攻擊", icon: "fa-trash", desc: "定向擦除執法部門證據庫數據", cooldown: 25, effect: "attack", cost: 30000 },
                        { id: "memory_attack", name: "記憶體無檔案攻擊套件", icon: "fa-memory", desc: "在記憶體中執行攻擊不留痕跡", cooldown: 20, effect: "attack", cost: 25000 },
                        { id: "server_cripple", name: "伺服器癱瘓攻擊", icon: "fa-server", desc: "針對性癱瘓執法部門伺服器", cooldown: 30, effect: "attack", cost: 40000 },
                        { id: "node_crippler", name: "網路節點癱瘓工具", icon: "fa-network-wired", desc: "癱瘓關鍵網絡節點和路由", cooldown: 22, effect: "attack", cost: 28000 },
                        { id: "ransomware", name: "高級勒索軟件", icon: "fa-lock", desc: "加密目標文件進行勒索", cooldown: 25, effect: "attack", cost: 35000 }
                    ],
                    infiltration: [
                        { id: "device_hack", name: "設備入侵", icon: "fa-laptop-code", desc: "入侵執法部門電腦和移動設備", cooldown: 16, effect: "infiltrate", cost: 18000 },
                        { id: "document_steal", name: "機密文件竊取", icon: "fa-file-steal", desc: "竊取執法部門機密文件和數據", cooldown: 20, effect: "infiltrate", cost: 22000 },
                        { id: "decryption_attack", name: "加密破解攻擊", icon: "fa-unlock-alt", desc: "破解加密文件和通訊", cooldown: 25, effect: "infiltrate", cost: 30000 },
                        { id: "browser_exploit", name: "瀏覽器漏洞利用", icon: "fa-window-maximize", desc: "利用瀏覽器漏洞獲取信息", cooldown: 14, effect: "infiltrate", cost: 16000 },
                        { id: "server_infiltration", name: "伺服器滲透", icon: "fa-server", desc: "深度滲透目標伺服器系統", cooldown: 22, effect: "infiltrate", cost: 28000 },
                        { id: "backdoor_implant", name: "持久後門植入", icon: "fa-door-closed", desc: "植入永久性後門系統", cooldown: 30, effect: "infiltrate", cost: 40000 }
                    ],
                    advanced: [
                        { id: "bait_server", name: "誘餌伺服器", icon: "fa-honey-pot", desc: "設置誘餌伺服器誤導追蹤", cooldown: 18, effect: "advanced", cost: 20000 },
                        { id: "fake_fingerprint", name: "偽造攻擊指紋工具", icon: "fa-fingerprint", desc: "偽造攻擊指紋和工具特徵", cooldown: 15, effect: "advanced", cost: 18000 },
                        { id: "phishing_generator", name: "社會工程釣魚生成器", icon: "fa-fish", desc: "生成釣魚攻擊和社會工程工具", cooldown: 12, effect: "advanced", cost: 15000 },
                        { id: "encryption_relay", name: "加密通道中繼器", icon: "fa-exchange-alt", desc: "建立加密中繼通道保護通訊", cooldown: 10, effect: "advanced", cost: 12000 },
                        { id: "hardware_spoof", name: "硬體指紋偽造器", icon: "fa-microchip", desc: "偽造硬體指紋和設備識別", cooldown: 16, effect: "advanced", cost: 22000 },
                        { id: "darknet_market", name: "暗網委託市場", icon: "fa-shopping-bag", desc: "訪問暗網市場購買黑市工具", cooldown: 30, effect: "advanced", cost: 50000 }
                    ]
                },
                law_enforcement: {
                    investigation: [
                        { id: "digital_forensics", name: "高級數碼鑑識沙盒", icon: "fa-search", desc: "深度分析惡意軟件、攻擊工具及行為模式", cooldown: 5, effect: "investigate", cost: 8000 },
                        { id: "network_mapping", name: "實時網絡流量繪圖儀", icon: "fa-project-diagram", desc: "可視化網絡流量、連接關係及異常模式", cooldown: 6, effect: "investigate", cost: 10000 },
                        { id: "log_analyzer", name: "AI日誌分析系統", icon: "fa-file-alt", desc: "使用AI分析系統日誌尋找異常行為", cooldown: 4, effect: "investigate", cost: 6000 },
                        { id: "memory_forensics", name: "內存取證分析", icon: "fa-memory", desc: "分析系統內存中的惡意代碼殘留", cooldown: 7, effect: "investigate", cost: 12000 },
                        { id: "social_analyzer", name: "社交圖譜分析器", icon: "fa-users", desc: "分析社交網絡關聯和行為模式", cooldown: 8, effect: "investigate", cost: 15000 },
                        { id: "behavior_analysis", name: "行為模式分析", icon: "fa-brain", desc: "分析黑客行為模式預測下一步", cooldown: 9, effect: "investigate", cost: 13000 }
                    ],
                    tracking: [
                        { id: "social_graph", name: "社交圖譜關聯分析器", icon: "fa-users", desc: "分析社交網絡關聯、時間線及行為模式", cooldown: 8, effect: "track", cost: 15000 },
                        { id: "ip_tracker", name: "全球IP追蹤系統", icon: "fa-map-marker-alt", desc: "追蹤IP地址的地理位置、ISP及歷史記錄", cooldown: 7, effect: "track", cost: 12000 },
                        { id: "crypto_tracker", name: "區塊鏈加密貨幣追蹤", icon: "fa-coins", desc: "追蹤加密貨幣交易記錄及資金流向", cooldown: 10, effect: "track", cost: 20000 },
                        { id: "osint_collector", name: "OSINT情報收集器", icon: "fa-globe", desc: "收集公開來源情報及網絡足跡", cooldown: 5, effect: "track", cost: 8000 },
                        { id: "gps_tracker", name: "超強GPS衛星定位", icon: "fa-satellite", desc: "精確追蹤目標地理位置", cooldown: 12, effect: "track", cost: 25000 },
                        { id: "cctv_access", name: "CCTV監控訪問", icon: "fa-video", desc: "訪問和分析監控錄像", cooldown: 10, effect: "track", cost: 18000 },
                        { id: "blockchain_tracker", name: "區塊鏈追蹤系統", icon: "fa-link", desc: "深度追蹤加密貨幣交易鏈", cooldown: 15, effect: "track", cost: 30000 }
                    ],
                    defense: [
                        { id: "honeypot", name: "智能主動蜜罐系統", icon: "fa-bug", desc: "部署陷阱伺服器誘捕黑客並收集攻擊特徵", cooldown: 12, effect: "defend", cost: 25000 },
                        { id: "network_sweep", name: "網絡圍捕行動", icon: "fa-network-wired", desc: "壓縮黑客可用匿名節點及跳板網絡", cooldown: 15, effect: "defend", cost: 30000 },
                        { id: "traffic_intercept", name: "合法流量深度攔截", icon: "fa-shield-alt", desc: "攔截和分析可疑流量進行取證", cooldown: 8, effect: "defend", cost: 18000 },
                        { id: "server_hardening", name: "指揮中心強化", icon: "fa-server", desc: "加強指揮中心伺服器安全防護", cooldown: 10, effect: "defend", cost: 20000 },
                        { id: "signal_blocker", name: "阻擋防止幹擾信號", icon: "fa-wifi", desc: "防止通訊干擾和信號阻斷", cooldown: 14, effect: "defend", cost: 22000 },
                        { id: "emergency_shutdown", name: "緊急斷流", icon: "fa-power-off", desc: "緊急切斷可疑網絡連接", cooldown: 20, effect: "defend", cost: 28000 },
                        { id: "evidence_protector", name: "證據保護系統", icon: "fa-shield-alt", desc: "保護證據庫免受污染", cooldown: 16, effect: "defend", cost: 24000 },
                        { id: "ai_predictor", name: "AI行為預測系統", icon: "fa-robot", desc: "預測黑客下一步行動", cooldown: 18, effect: "defend", cost: 32000 }
                    ],
                    collaboration: [
                        { id: "department_coord", name: "跨部門指揮協調面板", icon: "fa-users-cog", desc: "協調多部門聯合調查與資源共享", cooldown: 10, effect: "collaborate", cost: 15000 },
                        { id: "interpol_request", name: "國際刑警協作請求", icon: "fa-globe", desc: "請求國際執法部門協助及資料共享", cooldown: 20, effect: "collaborate", cost: 35000 },
                        { id: "warrant_request", name: "逮捕令申請系統", icon: "fa-file-contract", desc: "申請正式逮捕令及司法授權", cooldown: 25, effect: "collaborate", cost: 40000 },
                        { id: "joint_operation", name: "聯合行動協調", icon: "fa-handshake", desc: "組織跨部門聯合執法行動", cooldown: 30, effect: "collaborate", cost: 50000 },
                        { id: "command_panel", name: "跨部門指揮面板", icon: "fa-tv", desc: "協調多部門指揮和資源分配", cooldown: 12, effect: "collaborate", cost: 18000 },
                        { id: "resource_allocator", name: "資源分配系統", icon: "fa-cogs", desc: "智能分配部門資源", cooldown: 14, effect: "collaborate", cost: 20000 }
                    ],
                    decryption: [
                        { id: "password_cracker", name: "破解裝置加密密碼", icon: "fa-unlock", desc: "強制破解加密設備和文件", cooldown: 18, effect: "decrypt", cost: 32000 },
                        { id: "intercept_key", name: "合法攔截密鑰", icon: "fa-key", desc: "獲取合法攔截加密通訊的權限", cooldown: 25, effect: "decrypt", cost: 45000 },
                        { id: "decryption_suite", name: "高級解密套件", icon: "fa-code", desc: "解密各類加密文件和通訊", cooldown: 20, effect: "decrypt", cost: 38000 },
                        { id: "threat_analysis", name: "全網威脅感測器", icon: "fa-radar", desc: "檢測和分析全網威脅", cooldown: 15, effect: "decrypt", cost: 28000 },
                        { id: "encryption_breaker", name: "加密破解系統", icon: "fa-unlock-alt", desc: "深度破解高級加密系統", cooldown: 22, effect: "decrypt", cost: 40000 }
                    ],
                    attack: [
                        { id: "counter_attack", name: "反擊系統", icon: "fa-crosshairs", desc: "對黑客發動反擊", cooldown: 30, effect: "attack", cost: 50000 },
                        { id: "backtrace", name: "反向追蹤攻擊", icon: "fa-search-location", desc: "反向追蹤黑客位置", cooldown: 25, effect: "attack", cost: 45000 },
                        { id: "system_lockdown", name: "系統鎖定", icon: "fa-lock", desc: "鎖定黑客系統", cooldown: 20, effect: "attack", cost: 35000 },
                        { id: "rapid_response", name: "快速反應攻擊", icon: "fa-bolt", desc: "快速反應對黑客系統造成傷害", cooldown: 18, effect: "attack", cost: 30000 }
                    ]
                }
            },
            
            // 證據類型定義
            evidenceTypes: [
                { id: 'ip_logs', name: 'IP訪問日誌', category: 'technical', critical: false, value: 5 },
                { id: 'malware_sample', name: '惡意軟件樣本', category: 'technical', critical: true, value: 15 },
                { id: 'vpn_logs', name: 'VPN連接記錄', category: 'technical', critical: false, value: 8 },
                { id: 'social_post', name: '社交媒體發文', category: 'social', critical: false, value: 7 },
                { id: 'online_profile', name: '網絡身份檔案', category: 'social', critical: true, value: 12 },
                { id: 'crypto_transaction', name: '加密貨幣交易', category: 'social', critical: true, value: 18 },
                { id: 'device_fingerprint', name: '設備指紋', category: 'physical', critical: false, value: 10 },
                { id: 'location_data', name: '地理位置數據', category: 'physical', critical: true, value: 20 },
                { id: 'payment_record', name: '支付記錄', category: 'physical', critical: true, value: 25 },
                { id: 'browser_history', name: '瀏覽器歷史記錄', category: 'technical', critical: false, value: 6 },
                { id: 'email_record', name: '電子郵件記錄', category: 'social', critical: true, value: 15 },
                { id: 'device_spec', name: '設備規格信息', category: 'technical', critical: false, value: 8 },
                { id: 'network_traffic', name: '網絡流量數據', category: 'technical', critical: true, value: 22 },
                { id: 'encryption_key', name: '加密密鑰片段', category: 'technical', critical: true, value: 30 }
            ],
            
            // 動態情報類型
            intelTypes: [
                { id: 'ip_leak', name: 'IP地址洩露', category: 'technical', real: true },
                { id: 'social_leak', name: '社交媒體活動', category: 'social', real: true },
                { id: 'device_info', name: '設備信息', category: 'technical', real: true },
                { id: 'location_hint', name: '位置提示', category: 'physical', real: true },
                { id: 'fake_ip', name: '偽造IP地址', category: 'technical', real: false },
                { id: 'fake_social', name: '偽造社交資料', category: 'social', real: false },
                { id: 'fake_device', name: '偽造設備信息', category: 'technical', real: false },
                { id: 'fake_location', name: '偽造位置信息', category: 'physical', real: false }
            ],
            
            // 機密文件類型
            documentTypes: [
                { id: 'investigation_report', name: '調查報告', value: 50, encrypted: true },
                { id: 'warrant_docs', name: '逮捕令文件', value: 75, encrypted: true },
                { id: 'agent_list', name: '特工名單', value: 100, encrypted: true },
                { id: 'system_blueprint', name: '系統藍圖', value: 60, encrypted: true },
                { id: 'encryption_keys', name: '加密密鑰庫', value: 90, encrypted: true },
                { id: 'operation_plans', name: '行動計劃', value: 80, encrypted: true }
            ],
            
            // 被入侵設備類型
            deviceTypes: [
                { id: 'police_laptop', name: '警用筆記本電腦', os: 'Windows 11', specs: 'i7, 16GB RAM, 512GB SSD' },
                { id: 'server_rack', name: '伺服器機架', os: 'Linux Server', specs: 'Dual Xeon, 64GB RAM, 10TB RAID' },
                { id: 'mobile_device', name: '移動設備', os: 'Android/iOS', specs: 'Various models' },
                { id: 'network_router', name: '網絡路由器', os: 'Custom Firmware', specs: 'Enterprise grade' },
                { id: 'surveillance_cam', name: '監控攝像頭', os: 'Embedded Linux', specs: '4K, Night vision' }
            ],
            
            // 任務目標
            missions: {
                hacker: [
                    { id: 'stealth_high', name: '保持隱蔽度 > 80%', status: 'incomplete' },
                    { id: 'footprints_low', name: '數碼足跡 < 3', status: 'incomplete' },
                    { id: 'decrypt_docs', name: '解密至少2份機密文件', status: 'incomplete' },
                    { id: 'compromise_devices', name: '入侵至少3台設備', status: 'incomplete' },
                    { id: 'pollute_evidence', name: '污染至少5項證據', status: 'incomplete' }
                ],
                law_enforcement: [
                    { id: 'identity_lock', name: '三階層身份鎖定 > 80%', status: 'incomplete' },
                    { id: 'critical_evidence', name: '收集至少3項關鍵證據', status: 'incomplete' },
                    { id: 'verify_intel', name: '驗證至少5條情報', status: 'incomplete' },
                    { id: 'coordinate_depts', name: '協調所有部門', status: 'incomplete' },
                    { id: 'arrest_warrant', name: '申請逮捕令', status: 'incomplete' }
                ]
            }
        };

        // ===== 頁面導航函數 =====
        function goToMainPage() {
            showPage('main-page');
            GameState.currentPage = 'main';
            updateNavActive();
        }

        function showSetupPage() {
            if (!GameState.currentRole) {
                showNotification('請先選擇角色', '請返回主頁選擇黑客或執法部門角色。', 'warning');
                return;
            }
            
            showPage('season2-setup-page');
            GameState.currentPage = 'setup';
            updateNavActive();
            updateSetupPage();
        }

        function showGamePage() {
            showPage('game-page');
            GameState.currentPage = 'game';
            updateNavActive();
        }

        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.add('active');
                page.style.display = 'block';
                window.scrollTo(0, 0);
            }
        }

        function updateNavActive() {
            const navItems = document.querySelectorAll('.nav-menu li a');
            navItems.forEach(item => item.classList.remove('active'));
            
            switch(GameState.currentPage) {
                case 'main':
                    document.getElementById('nav-home').classList.add('active');
                    break;
                case 'setup':
                    document.getElementById('nav-season2').classList.add('active');
                    break;
                case 'game':
                    document.getElementById('nav-season2').classList.add('active');
                    break;
            }
        }

        // ===== 角色選擇函數 =====
        function selectRole(role) {
            GameState.currentRole = role;
            
            if (role === 'hacker') {
                showNotification('角色選擇確認', '你已選擇扮演黑客。你的目標是隱藏身份、反制調查，並逃脫執法部門的追捕。', 'hacker');
            } else if (role === 'law_enforcement') {
                showNotification('角色選擇確認', '你已選擇扮演執法部門。你的目標是調查黑客身份、收集證據鏈，並申請逮捕令進行拘捕。', 'law_enforcement');
            }
            
            showSetupPage();
        }

        // ===== 設置頁面更新 =====
        function updateSetupPage() {
            const roleDisplay = document.getElementById('selected-role-display');
            const roleName = document.getElementById('selected-role-name');
            const roleDesc = document.getElementById('selected-role-desc');
            const setupTitle = document.getElementById('setup-title');
            const setupSubtitle = document.getElementById('setup-subtitle');
            
            if (GameState.currentRole === 'hacker') {
                roleDisplay.style.borderColor = '#00ff41';
                roleName.innerHTML = '<i class="fas fa-user-secret"></i> 黑客角色';
                roleName.style.color = '#00ff41';
                roleDesc.textContent = '隱藏身份、清除足跡、反制調查、逃脫追捕、入侵系統';
                setupTitle.textContent = '黑客對戰設置';
                setupSubtitle.textContent = '配置你的黑客對戰參數';
            } else if (GameState.currentRole === 'law_enforcement') {
                roleDisplay.style.borderColor = '#4a90d9';
                roleName.innerHTML = '<i class="fas fa-shield-alt"></i> 執法部門角色';
                roleName.style.color = '#4a90d9';
                roleDesc.textContent = '調查身份、收集證據、鎖定目標、申請逮捕令、保護系統';
                setupTitle.textContent = '執法部門對戰設置';
                setupSubtitle.textContent = '配置你的執法調查參數';
            } else {
                roleDisplay.style.borderColor = '#666';
                roleName.innerHTML = '<i class="fas fa-question-circle"></i> 尚未選擇角色';
                roleName.style.color = '#666';
                roleDesc.textContent = '請返回主頁選擇角色';
            }
            
            // 設置預設對手IP
            if (GameState.currentRole === 'hacker') {
                document.getElementById('opponent-ip').value = '10.0.0.1';
                document.getElementById('opponent-ip').placeholder = '執法部門指揮中心 IP (例: 10.0.0.1)';
            } else {
                document.getElementById('opponent-ip').value = '192.168.1.200';
                document.getElementById('opponent-ip').placeholder = '黑客IP地址 (例: 192.168.1.200)';
            }
            
            // 選擇難度
            selectDifficulty('professional');
        }

        function selectDifficulty(level) {
            const cards = document.querySelectorAll('.difficulty-card');
            cards.forEach(card => card.classList.remove('selected'));
            
            event.currentTarget.classList.add('selected');
            
            GameState.difficulty = level;
            
            // 延長遊戲時間：20-30分鐘
            switch(level) {
                case 'rookie':
                    GameState.gameTimeLimit = 1800; // 30分鐘
                    break;
                case 'professional':
                    GameState.gameTimeLimit = 1500; // 25分鐘
                    break;
                case 'elite':
                    GameState.gameTimeLimit = 1200; // 20分鐘
                    break;
                case 'legendary':
                    GameState.gameTimeLimit = 900; // 15分鐘
                    break;
            }
        }

        // ===== 開始對戰函數 =====
        function startSeason2Battle() {
            const opponentIP = document.getElementById('opponent-ip').value.trim();
            
            if (!opponentIP) {
                showNotification('輸入錯誤', '請輸入對手的IP地址。', 'warning');
                return;
            }
            
            if (!GameState.currentRole) {
                showNotification('角色未選擇', '請返回主頁選擇角色。', 'warning');
                return;
            }
            
            GameState.opponentIP = opponentIP;
            GameState.gameActive = true;
            GameState.gameStartTime = Date.now();
            GameState.connectionStatus = 'connected';
            
            // 根據角色初始化遊戲數據
            if (GameState.currentRole === 'hacker') {
                GameState.playerData.hacker.money = 150000;
                GameState.playerData.hacker.stealth = 60;
                GameState.playerData.hacker.encryptionLevel = 40;
                GameState.playerData.hacker.digitalFootprints = 5;
                GameState.playerData.hacker.compromisedEvidence = 0;
                GameState.playerData.hacker.controlProgress = 0;
                GameState.playerData.hacker.serverHealth = 100;
                GameState.playerData.hacker.deviceHealth = 100;
                GameState.playerData.hacker.stolenDocuments = [];
                GameState.playerData.hacker.decryptionProgress = 0;
                GameState.playerData.hacker.compromisedDevices = [];
                GameState.playerData.hacker.darknetCredits = 0;
                GameState.playerData.hacker.activeVpnNodes = 3;
                GameState.playerData.hacker.signalJamming = false;
                GameState.playerData.hacker.realtimeIntel = [];
                
                // 初始化任務
                GameState.missions.hacker.forEach(mission => mission.status = 'incomplete');
                
                // 初始化對手數據 (執法部門AI)
                GameState.opponentData.law_enforcement.budget = 200000;
                GameState.opponentData.law_enforcement.investigationProgress = 0;
                GameState.opponentData.law_enforcement.identityLock = { technical: 0, social: 0, physical: 0 };
                GameState.opponentData.law_enforcement.evidenceChain = [];
                GameState.opponentData.law_enforcement.warrantProgress = 0;
                GameState.opponentData.law_enforcement.warrantIssued = false;
                GameState.opponentData.law_enforcement.serverHealth = 100;
                GameState.opponentData.law_enforcement.evidenceLibraryHealth = 100;
                GameState.opponentData.law_enforcement.analysisToolsHealth = 100;
                GameState.opponentData.law_enforcement.dynamicIntel = [];
                GameState.opponentData.law_enforcement.networkSweepActive = false;
            } else {
                GameState.playerData.law_enforcement.budget = 200000;
                GameState.playerData.law_enforcement.investigationProgress = 0;
                GameState.playerData.law_enforcement.identityLock = { technical: 0, social: 0, physical: 0 };
                GameState.playerData.law_enforcement.evidenceChain = [];
                GameState.playerData.law_enforcement.criticalEvidence = [];
                GameState.playerData.law_enforcement.warrantProgress = 0;
                GameState.playerData.law_enforcement.warrantIssued = false;
                GameState.playerData.law_enforcement.serverHealth = 100;
                GameState.playerData.law_enforcement.evidenceLibraryHealth = 100;
                GameState.playerData.law_enforcement.analysisToolsHealth = 100;
                GameState.playerData.law_enforcement.dynamicIntel = [];
                GameState.playerData.law_enforcement.verifiedIntel = [];
                GameState.playerData.law_enforcement.networkSweepActive = false;
                GameState.playerData.law_enforcement.activeHoneypots = 0;
                GameState.playerData.law_enforcement.compromisedDevices = [];
                GameState.playerData.law_enforcement.gpsTracking = false;
                GameState.playerData.law_enforcement.signalBlocking = false;
                GameState.playerData.law_enforcement.realtimeTracking = [];
                
                // 初始化任務
                GameState.missions.law_enforcement.forEach(mission => mission.status = 'incomplete');
                
                // 初始化對手數據 (黑客AI)
                GameState.opponentData.hacker.money = 180000;
                GameState.opponentData.hacker.stealth = 70;
                GameState.opponentData.hacker.encryptionLevel = 50;
                GameState.opponentData.hacker.digitalFootprints = 5;
                GameState.opponentData.hacker.compromisedEvidence = 0;
                GameState.opponentData.hacker.controlProgress = 0;
                GameState.opponentData.hacker.serverHealth = 100;
                GameState.opponentData.hacker.deviceHealth = 100;
                GameState.opponentData.hacker.stolenDocuments = [];
                GameState.opponentData.hacker.activeVpnNodes = 4;
            }
            
            showGamePage();
            initializeGameUI();
            startGameTimer();
            
            // 顯示歡迎訊息
            if (GameState.currentRole === 'hacker') {
                addTerminalLine('[系統] 第二季對戰開始 - 黑客模式', 'system');
                addTerminalLine('[系統] 目標: 執法部門指揮中心 (' + GameState.opponentIP + ')', 'system');
                addTerminalLine('[系統] 你的任務: 隱藏身份、清除數碼足跡、逃脫追捕、入侵系統', 'system');
                addTerminalLine('[提示] 使用工具分類中的工具執行操作', 'warning');
                addTerminalLine('[提示] 倒計時: ' + Math.floor(GameState.gameTimeLimit / 60) + '分鐘', 'alert');
            } else {
                addTerminalLine('[系統] 第二季對戰開始 - 執法部門模式', 'system');
                addTerminalLine('[系統] 目標: 黑客 (' + GameState.opponentIP + ')', 'system');
                addTerminalLine('[系統] 你的任務: 調查黑客身份、收集證據、申請逮捕令、保護系統', 'system');
                addTerminalLine('[提示] 使用工具分類中的工具執行調查', 'warning');
                addTerminalLine('[提示] 倒計時: ' + Math.floor(GameState.gameTimeLimit / 60) + '分鐘', 'alert');
            }
            
            // 生成初始動態情報
            generateDynamicIntel();
            
            // 初始目標信息
            updateTargetRealtimeInfo();
        }

        // ===== 遊戲UI初始化 =====
        function initializeGameUI() {
            const gamePage = document.getElementById('game-page');
            gamePage.innerHTML = '';
            
            // 根據角色確定UI主題
            const uiClass = GameState.currentRole === 'hacker' ? 'hacker-ui' : 'law-enforcement-ui';
            const primaryColor = GameState.currentRole === 'hacker' ? '#00ff41' : '#4a90d9';
            const roleName = GameState.currentRole === 'hacker' ? '黑客' : '執法部門';
            const opponentName = GameState.currentRole === 'hacker' ? '執法部門' : '黑客';
            
            // 構建遊戲界面
            gamePage.className = 'page active ' + uiClass;
            gamePage.innerHTML = `
                <div class="game-container">
                    <!-- 遊戲頭部 -->
                    <div class="game-header">
                        <div class="game-title-container">
                            <div class="game-mode-icon">
                                <i class="fas ${GameState.currentRole === 'hacker' ? 'fa-user-secret' : 'fa-shield-alt'}"></i>
                            </div>
                            <div class="game-title">${roleName} • 對戰模式第二季</div>
                        </div>
                        
                        <div class="connection-status">
                            <div class="status-indicator ${GameState.connectionStatus === 'connected' ? '' : 'disconnected'}"></div>
                            <span>${GameState.connectionStatus === 'connected' ? '已連接' : '未連接'}</span>
                        </div>
                        
                        <div class="target-info">
                            <div class="target-label">目標</div>
                            <div class="target-ip">${GameState.opponentIP} (${opponentName})</div>
                        </div>
                    </div>
                    
                    <!-- 截圖風格的目標系統信息 -->
                    <div class="target-system-info">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <div style="color: ${primaryColor}; font-weight: bold; font-size: 1.1rem;">目標信息</div>
                                <div style="color: #aaa; font-size: 0.9rem;">${GameState.currentRole === 'hacker' ? '執法部門指揮中心' : '黑客網絡系統'}</div>
                            </div>
                            <div style="padding: 5px 10px; background: rgba(0,255,65,0.2); border-radius: 12px; color: #00ff41; font-size: 0.8rem;">
                                在線
                            </div>
                        </div>
                        
                        <div class="system-details" id="system-details">
                            <!-- 系統詳細信息將由JavaScript動態生成 -->
                        </div>
                    </div>
                    
                    <!-- 攻擊路徑視覺化 -->
                    <div class="attack-path-visualization">
                        <div class="path-title">
                            <i class="fas fa-project-diagram"></i>
                            <span>攻擊路徑視覺化</span>
                        </div>
                        <div class="path-timeline" id="attack-path-timeline">
                            <!-- 攻擊路徑時間線將由JavaScript動態生成 -->
                        </div>
                    </div>
                    
                    <!-- 遊戲統計 -->
                    <div class="game-stats" id="game-stats">
                        <!-- 統計卡片將由JavaScript動態生成 -->
                    </div>
                    
                    <!-- 系統狀態條 -->
                    <div class="system-status-bars" id="system-status-bars">
                        <!-- 系統狀態條將由JavaScript動態生成 -->
                    </div>
                    
                    <!-- 主遊戲區域 -->
                    <div class="game-main">
                        <!-- 左側面板 -->
                        <div class="left-panel">
                            <!-- 終端機 -->
                            <div class="terminal-container">
                                <div class="terminal-header">
                                    <div class="terminal-title">
                                        <i class="fas fa-terminal"></i>
                                        <span>${GameState.currentRole === 'hacker' ? 'DARKNET TERMINAL v4.0' : 'LAW ENFORCEMENT COMMAND v3.0'}</span>
                                    </div>
                                    <div class="terminal-status">
                                        <i class="fas fa-clock"></i>
                                        <span id="game-timer">${Math.floor(GameState.gameTimeLimit / 60).toString().padStart(2, '0')}:00</span>
                                    </div>
                                </div>
                                <div class="terminal-body">
                                    <div class="terminal-output" id="terminal-output"></div>
                                    <div class="terminal-input-container">
                                        <div class="terminal-prompt">${GameState.currentRole === 'hacker' ? 'root@shadow:~#' : 'investigator@le:~#'}</div>
                                        <input type="text" class="terminal-input" id="terminal-input" placeholder="輸入指令或使用工具...">
                                    </div>
                                    <div class="input-suggestions" id="input-suggestions">
                                        <!-- 輸入建議將由JavaScript動態生成 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 工具面板 -->
                            <div class="tools-panel">
                                <div class="tools-title">
                                    <i class="fas fa-tools"></i>
                                    <span>專屬工具庫</span>
                                </div>
                                <div class="tools-categories" id="tool-categories">
                                    <!-- 工具分類將由JavaScript動態生成 -->
                                </div>
                                <div class="tools-grid" id="tools-grid">
                                    <!-- 工具將由JavaScript動態生成 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右側面板 -->
                        <div class="right-panel">
                            <!-- 任務目標面板 -->
                            <div class="mission-panel">
                                <div class="mission-title">
                                    <i class="fas fa-bullseye"></i>
                                    <span>任務目標</span>
                                </div>
                                <div class="mission-list" id="mission-list">
                                    <!-- 任務列表將由JavaScript動態生成 -->
                                </div>
                            </div>
                            
                            <!-- 攻擊/防禦視覺化 -->
                            <div class="attack-defense-visualization">
                                <div class="visualization-title">
                                    <i class="fas fa-chart-line"></i>
                                    <span>對抗狀態</span>
                                </div>
                                <div class="progress-bars" id="attack-defense-bars">
                                    <!-- 進度條將由JavaScript動態生成 -->
                                </div>
                            </div>
                            
                            <!-- 系統健康視覺化 -->
                            <div class="health-visualization" id="health-visualization">
                                <!-- 健康卡片將由JavaScript動態生成 -->
                            </div>
                            
                            <!-- 對戰信息面板 -->
                            <div class="battle-info">
                                <div class="battle-title">
                                    <i class="fas fa-info-circle"></i>
                                    <span>對戰信息</span>
                                </div>
                                
                                <!-- 實時目標信息顯示 -->
                                <div class="target-realtime-info" id="target-realtime-info">
                                    <!-- 實時目標信息將由JavaScript動態生成 -->
                                </div>
                                
                                <div id="special-panel">
                                    <!-- 特殊面板將根據角色顯示 -->
                                </div>
                            </div>
                            
                            <!-- 控制面板 -->
                            <div class="game-controls">
                                <div class="control-group">
                                    <button class="btn btn-primary" onclick="connectToTarget()">
                                        <i class="fas fa-plug"></i>
                                        <span>連接目標</span>
                                    </button>
                                    <button class="btn btn-secondary" onclick="disconnectFromTarget()">
                                        <i class="fas fa-plug"></i>
                                        <span>斷開連接</span>
                                    </button>
                                    ${GameState.currentRole === 'hacker' ? 
                                        '<button class="btn btn-warning" onclick="openHackerShop()"><i class="fas fa-shopping-cart"></i><span>黑客商店</span></button>' :
                                        '<button class="btn btn-warning" onclick="openLEShop()"><i class="fas fa-shopping-cart"></i><span>執法商店</span></button>'
                                    }
                                </div>
                                <div class="control-group">
                                    <button class="btn btn-warning" onclick="pauseGame()">
                                        <i class="fas fa-pause"></i>
                                        <span>暫停遊戲</span>
                                    </button>
                                    <button class="btn back-btn" onclick="goToMainPage()">
                                        <i class="fas fa-sign-out-alt"></i>
                                        <span>退出對戰</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 初始化遊戲UI組件
            updateSystemDetails();
            updateAttackPathTimeline();
            updateGameStats();
            updateSystemStatusBars();
            updateMissionList();
            updateAttackDefenseBars();
            updateHealthVisualization();
            updateTargetRealtimeInfo();
            updateToolCategories();
            updateToolsGrid(GameState.currentRole === 'hacker' ? 'reconnaissance' : 'investigation');
            updateSpecialPanel();
            
            // 設置終端輸入事件
            const terminalInput = document.getElementById('terminal-input');
            if (terminalInput) {
                terminalInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const command = this.value.trim();
                        if (command) {
                            executeCommand(command);
                            this.value = '';
                        }
                    }
                });
            }
        }

        // ===== 系統詳細信息更新 =====
        function updateSystemDetails() {
            const detailsContainer = document.getElementById('system-details');
            if (!detailsContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                detailsContainer.innerHTML = `
                    <div class="system-detail">
                        <div class="system-label">你的ID</div>
                        <div class="system-value">${GameState.playerIP}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">目標ID</div>
                        <div class="system-value">${GameState.opponentIP}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">隱蔽等級</div>
                        <div class="system-value">${hacker.stealth}%</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">加密等級</div>
                        <div class="system-value">${hacker.encryptionLevel}%</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">VPN節點</div>
                        <div class="system-value">${hacker.activeVpnNodes}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">數碼足跡</div>
                        <div class="system-value">${hacker.digitalFootprints}</div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                detailsContainer.innerHTML = `
                    <div class="system-detail">
                        <div class="system-label">你的ID</div>
                        <div class="system-value">${GameState.playerIP}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">目標ID</div>
                        <div class="system-value">${GameState.opponentIP}</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">調查進度</div>
                        <div class="system-value">${le.investigationProgress}%</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">身份鎖定</div>
                        <div class="system-value">${Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3)}%</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">關鍵證據</div>
                        <div class="system-value">${le.criticalEvidence.length}/3</div>
                    </div>
                    <div class="system-detail">
                        <div class="system-label">待驗證情報</div>
                        <div class="system-value">${le.dynamicIntel.length}</div>
                    </div>
                `;
            }
        }

        // ===== 攻擊路徑時間線更新 =====
        function updateAttackPathTimeline() {
            const timelineContainer = document.getElementById('attack-path-timeline');
            if (!timelineContainer) return;
            
            // 模擬攻擊路徑事件
            const now = new Date();
            const events = [
                { time: `${now.getHours().toString().padStart(2, '0')}:${(now.getMinutes()-2).toString().padStart(2, '0')}`, action: '初始連接建立' },
                { time: `${now.getHours().toString().padStart(2, '0')}:${(now.getMinutes()-1).toString().padStart(2, '0')}`, action: '端口掃描完成' },
                { time: `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`, action: '漏洞評估進行中' }
            ];
            
            timelineContainer.innerHTML = '';
            events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'path-event';
                eventElement.innerHTML = `
                    <div class="path-time">${event.time}</div>
                    <div class="path-action">${event.action}</div>
                `;
                timelineContainer.appendChild(eventElement);
            });
        }

        // ===== 遊戲統計更新 =====
        function updateGameStats() {
            const statsContainer = document.getElementById('game-stats');
            if (!statsContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">資金</div>
                        <div class="stat-value">$${hacker.money.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">隱蔽度</div>
                        <div class="stat-value">${hacker.stealth}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">數碼足跡</div>
                        <div class="stat-value">${hacker.digitalFootprints}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">入侵設備</div>
                        <div class="stat-value">${hacker.compromisedDevices.length}</div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                const identityAvg = Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3);
                
                statsContainer.innerHTML = `
                    <div class="evidence-stat">
                        <div class="evidence-label">調查預算</div>
                        <div class="evidence-value">$${le.budget.toLocaleString()}</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="evidence-label">身份鎖定</div>
                        <div class="evidence-value">${identityAvg}%</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="evidence-label">關鍵證據</div>
                        <div class="evidence-value">${le.criticalEvidence.length}</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="evidence-label">伺服器健康</div>
                        <div class="evidence-value">${le.serverHealth}%</div>
                    </div>
                `;
            }
        }

        // ===== 系統狀態條更新 =====
        function updateSystemStatusBars() {
            const statusBarsContainer = document.getElementById('system-status-bars');
            if (!statusBarsContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                statusBarsContainer.innerHTML = `
                    <div class="status-bar">
                        <div class="status-label">攻擊路徑</div>
                        <div class="status-value">7.5%</div>
                        <div class="status-percentage">進度</div>
                    </div>
                    <div class="status-bar">
                        <div class="status-label">加密等級</div>
                        <div class="status-value">${hacker.encryptionLevel}%</div>
                        <div class="status-percentage">強度</div>
                    </div>
                    <div class="status-bar">
                        <div class="status-label">檢測風險</div>
                        <div class="status-value">${100 - hacker.stealth}%</div>
                        <div class="status-percentage">風險</div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                statusBarsContainer.innerHTML = `
                    <div class="status-bar">
                        <div class="status-label">調查進度</div>
                        <div class="status-value">${le.investigationProgress}%</div>
                        <div class="status-percentage">進度</div>
                    </div>
                    <div class="status-bar">
                        <div class="status-label">證據質量</div>
                        <div class="status-value">${le.evidenceChain.length > 0 ? Math.min(100, le.evidenceChain.filter(e => !e.contaminated).length * 20) : 0}%</div>
                        <div class="status-percentage">質量</div>
                    </div>
                    <div class="status-bar">
                        <div class="status-label">系統防護</div>
                        <div class="status-value">${Math.round((le.serverHealth + le.evidenceLibraryHealth + le.analysisToolsHealth) / 3)}%</div>
                        <div class="status-percentage">防護</div>
                    </div>
                `;
            }
        }

        // ===== 任務列表更新 =====
        function updateMissionList() {
            const missionListContainer = document.getElementById('mission-list');
            if (!missionListContainer) return;
            
            const missions = GameState.missions[GameState.currentRole];
            missionListContainer.innerHTML = '';
            
            missions.forEach(mission => {
                const missionElement = document.createElement('div');
                missionElement.className = 'mission-item';
                missionElement.innerHTML = `
                    <div class="mission-name">${mission.name}</div>
                    <div class="mission-status ${mission.status === 'complete' ? 'mission-complete' : 'mission-incomplete'}">
                        ${mission.status === 'complete' ? '完成' : '進行中'}
                    </div>
                `;
                missionListContainer.appendChild(missionElement);
            });
        }

        // ===== 攻擊/防禦進度條更新 =====
        function updateAttackDefenseBars() {
            const barsContainer = document.getElementById('attack-defense-bars');
            if (!barsContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                const opponent = GameState.opponentData.law_enforcement;
                
                barsContainer.innerHTML = `
                    <div class="progress-item">
                        <div class="progress-label">攻擊強度</div>
                        <div class="progress-container">
                            <div class="progress-fill attack-progress" style="width: ${hacker.attackPower}%">${hacker.attackPower}%</div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">隱蔽等級</div>
                        <div class="progress-container">
                            <div class="progress-fill stealth-progress" style="width: ${hacker.stealth}%">${hacker.stealth}%</div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">調查壓力</div>
                        <div class="progress-container">
                            <div class="progress-fill defense-progress" style="width: ${opponent.investigationProgress}%">${opponent.investigationProgress}%</div>
                        </div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                const opponent = GameState.opponentData.hacker;
                
                barsContainer.innerHTML = `
                    <div class="progress-item">
                        <div class="progress-label">調查進度</div>
                        <div class="progress-container">
                            <div class="progress-fill attack-progress" style="width: ${le.investigationProgress}%">${le.investigationProgress}%</div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">系統防護</div>
                        <div class="progress-container">
                            <div class="progress-fill defense-progress" style="width: ${Math.round((le.serverHealth + le.evidenceLibraryHealth) / 2)}%">${Math.round((le.serverHealth + le.evidenceLibraryHealth) / 2)}%</div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">黑客隱蔽</div>
                        <div class="progress-container">
                            <div class="progress-fill stealth-progress" style="width: ${opponent.stealth}%">${opponent.stealth}%</div>
                        </div>
                    </div>
                `;
            }
        }

        // ===== 健康視覺化更新 =====
        function updateHealthVisualization() {
            const healthContainer = document.getElementById('health-visualization');
            if (!healthContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                
                // 確定健康等級
                const getHealthClass = (value) => {
                    if (value >= 70) return 'high';
                    if (value >= 40) return 'medium';
                    return 'low';
                };
                
                healthContainer.innerHTML = `
                    <div class="health-card ${getHealthClass(hacker.serverHealth)}">
                        <div class="health-card-title">主伺服器</div>
                        <div class="health-card-value">${hacker.serverHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(hacker.deviceHealth)}">
                        <div class="health-card-title">設備健康</div>
                        <div class="health-card-value">${hacker.deviceHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(hacker.stealth)}">
                        <div class="health-card-title">隱蔽系統</div>
                        <div class="health-card-value">${hacker.stealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(hacker.encryptionLevel)}">
                        <div class="health-card-title">加密系統</div>
                        <div class="health-card-value">${hacker.encryptionLevel}%</div>
                    </div>
                `;
            } else {
                const le = GameState.playerData.law_enforcement;
                
                // 確定健康等級
                const getHealthClass = (value) => {
                    if (value >= 70) return 'high';
                    if (value >= 40) return 'medium';
                    return 'low';
                };
                
                healthContainer.innerHTML = `
                    <div class="health-card ${getHealthClass(le.serverHealth)}">
                        <div class="health-card-title">指揮中心</div>
                        <div class="health-card-value">${le.serverHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(le.evidenceLibraryHealth)}">
                        <div class="health-card-title">證據庫</div>
                        <div class="health-card-value">${le.evidenceLibraryHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(le.analysisToolsHealth)}">
                        <div class="health-card-title">分析工具</div>
                        <div class="health-card-value">${le.analysisToolsHealth}%</div>
                    </div>
                    <div class="health-card ${getHealthClass(Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3))}">
                        <div class="health-card-title">身份鎖定</div>
                        <div class="health-card-value">${Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3)}%</div>
                    </div>
                `;
            }
        }

        // ===== 實時目標信息更新 =====
        function updateTargetRealtimeInfo() {
            const realtimeInfoContainer = document.getElementById('target-realtime-info');
            if (!realtimeInfoContainer) return;
            
            if (GameState.currentRole === 'hacker') {
                const opponent = GameState.opponentData.law_enforcement;
                const identityAvg = Math.round((opponent.identityLock.technical + opponent.identityLock.social + opponent.identityLock.physical) / 3);
                
                realtimeInfoContainer.innerHTML = `
                    <div class="realtime-title">
                        <div class="realtime-name">執法部門指揮中心</div>
                        <div class="realtime-status">在線</div>
                    </div>
                    <div class="realtime-details">
                        <div class="realtime-detail">
                            <div class="realtime-label">調查預算</div>
                            <div class="realtime-value">$${(opponent.budget/1000).toFixed(0)}K</div>
                        </div>
                        <div class="realtime-detail">
                            <div class="realtime-label">身份鎖定</div>
                            <div class="realtime-value">${identityAvg}%</div>
                        </div>
                        <div class="realtime-detail">
                            <div class="realtime-label">伺服器健康</div>
                            <div class="realtime-value">${opponent.serverHealth}%</div>
                        </div>
                    </div>
                `;
            } else {
                const opponent = GameState.opponentData.hacker;
                
                realtimeInfoContainer.innerHTML = `
                    <div class="realtime-title">
                        <div class="realtime-name">黑客網絡系統</div>
                        <div class="realtime-status">在線</div>
                    </div>
                    <div class="realtime-details">
                        <div class="realtime-detail">
                            <div class="realtime-label">隱蔽等級</div>
                            <div class="realtime-value">${opponent.stealth}%</div>
                        </div>
                        <div class="realtime-detail">
                            <div class="realtime-label">VPN節點</div>
                            <div class="realtime-value">${opponent.activeVpnNodes}</div>
                        </div>
                        <div class="realtime-detail">
                            <div class="realtime-label">數碼足跡</div>
                            <div class="realtime-value">${opponent.digitalFootprints}</div>
                        </div>
                    </div>
                `;
            }
        }

        // ===== 工具系統 =====
        function updateToolCategories() {
            const categoriesContainer = document.getElementById('tool-categories');
            if (!categoriesContainer) return;
            
            const toolCategories = GameState.currentRole === 'hacker' 
                ? ['reconnaissance', 'stealth', 'counter_investigation', 'attack', 'infiltration', 'advanced']
                : ['investigation', 'tracking', 'defense', 'collaboration', 'decryption', 'attack'];
            
            const categoryNames = {
                reconnaissance: { name: '偵察工具', icon: 'fa-binoculars' },
                stealth: { name: '隱蔽工具', icon: 'fa-mask' },
                counter_investigation: { name: '反制調查', icon: 'fa-virus-slash' },
                attack: { name: '攻擊工具', icon: 'fa-crosshairs' },
                infiltration: { name: '入侵工具', icon: 'fa-user-ninja' },
                advanced: { name: '高級工具', icon: 'fa-cogs' },
                investigation: { name: '調查工具', icon: 'fa-search' },
                tracking: { name: '追蹤工具', icon: 'fa-map-marker-alt' },
                defense: { name: '防禦工具', icon: 'fa-shield-alt' },
                collaboration: { name: '協作工具', icon: 'fa-users-cog' },
                decryption: { name: '解密工具', icon: 'fa-unlock-alt' }
            };
            
            categoriesContainer.innerHTML = '';
            toolCategories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.innerHTML = `<i class="fas ${categoryNames[category].icon}"></i> ${categoryNames[category].name}`;
                btn.onclick = () => updateToolsGrid(category);
                if (category === 'reconnaissance' || category === 'investigation') {
                    btn.classList.add('active');
                }
                categoriesContainer.appendChild(btn);
            });
        }

        function updateToolsGrid(category) {
            const toolsGrid = document.getElementById('tools-grid');
            if (!toolsGrid) return;
            
            // 更新分類按鈕活動狀態
            const categoryBtns = document.querySelectorAll('.category-btn');
            categoryBtns.forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // 獲取對應工具
            const tools = GameState.tools[GameState.currentRole][category];
            if (!tools) return;
            
            toolsGrid.innerHTML = '';
            tools.forEach(tool => {
                const toolCard = document.createElement('div');
                toolCard.className = 'tool-card';
                if (category === 'advanced' || tool.cost > 30000) {
                    toolCard.classList.add('advanced-tool-card');
                }
                toolCard.innerHTML = `
                    <div class="tool-icon">
                        <i class="fas ${tool.icon}"></i>
                    </div>
                    <div class="tool-name">${tool.name}</div>
                    <div class="tool-desc">${tool.desc}</div>
                    <div class="tool-cooldown">冷卻: ${tool.cooldown}秒 | 成本: $${tool.cost}</div>
                `;
                toolCard.onclick = () => useTool(tool.id, category);
                toolsGrid.appendChild(toolCard);
            });
        }

        function useTool(toolId, category) {
            if (!GameState.gameActive) {
                showNotification('遊戲未開始', '請先連接目標開始遊戲。', 'warning');
                return;
            }
            
            // 檢查冷卻
            const cooldowns = GameState.playerData[GameState.currentRole].cooldowns;
            if (cooldowns[toolId] && Date.now() - cooldowns[toolId] < 0) {
                showNotification('工具冷卻中', '這個工具還在冷卻時間，請稍後再試。', 'warning');
                return;
            }
            
            // 檢查資金/預算
            const tool = GameState.tools[GameState.currentRole][category].find(t => t.id === toolId);
            if (tool.cost > 0) {
                if (GameState.currentRole === 'hacker') {
                    if (GameState.playerData.hacker.money < tool.cost) {
                        showNotification('資金不足', '沒有足夠的資金使用此工具。', 'warning');
                        return;
                    }
                    GameState.playerData.hacker.money -= tool.cost;
                    addTransaction('purchase', `購買工具: ${tool.name}`, -tool.cost);
                } else {
                    if (GameState.playerData.law_enforcement.budget < tool.cost) {
                        showNotification('預算不足', '沒有足夠的預算使用此工具。', 'warning');
                        return;
                    }
                    GameState.playerData.law_enforcement.budget -= tool.cost;
                    addTransaction('purchase', `購買工具: ${tool.name}`, -tool.cost);
                }
            }
            
            // 根據工具ID執行相應操作
            let message = '';
            let success = true;
            let data = null;
            
            if (GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                const opponent = GameState.opponentData.law_enforcement;
                
                switch(toolId) {
                    case 'nmap':
                        message = '執行Nmap深度掃描... 發現目標網絡結構：防火牆、IDS、核心伺服器集群';
                        data = { ports: [22, 80, 443, 3389, 8080], services: ['SSH', 'HTTP', 'HTTPS', 'RDP', 'PROXY'] };
                        hacker.stealth -= 5;
                        hacker.digitalFootprints += 1;
                        break;
                    case 'device_scanner':
                        message = '掃描設備... 發現多個連接設備：警用筆記本、伺服器、移動設備';
                        const deviceCount = 3 + Math.floor(Math.random() * 3);
                        data = { devices: deviceCount };
                        hacker.stealth -= 3;
                        break;
                    case 'log_cleaner':
                        message = '執行智能日誌清理... 成功清除系統日誌、審計追蹤及安全記錄';
                        hacker.stealth += 15;
                        hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints - 2);
                        data = { stealthIncrease: 15, footprintsRemoved: 2 };
                        break;
                    case 'traffic_hider':
                        message = '使用流量/身份隱藏器... 完全隱藏網絡活動和身份信息';
                        hacker.stealth += 25;
                        hacker.activeVpnNodes += 2;
                        data = { stealthIncrease: 25, vpnNodes: 2 };
                        break;
                    case 'dynamic_jumpnet':
                        message = '建立動態跳板網絡... 隨機路由隱藏真實位置';
                        hacker.stealth += 20;
                        hacker.activeVpnNodes += 3;
                        data = { stealthIncrease: 20, vpnNodes: 3 };
                        break;
                    case 'identity_hider':
                        message = '使用身份隱藏器... 完全隱藏真實身份信息';
                        hacker.stealth += 30;
                        hacker.encryptionLevel += 20;
                        data = { stealthIncrease: 30, encryptionIncrease: 20 };
                        break;
                    case 'traffic_encryptor':
                        message = '使用流量加密器... 完全加密所有網絡流量';
                        hacker.encryptionLevel += 25;
                        hacker.stealth += 15;
                        data = { encryptionIncrease: 25, stealthIncrease: 15 };
                        break;
                    case 'evidence_pollution':
                        message = '執行智能證據污染攻擊... 成功污染執法部門證據庫，植入混淆數據';
                        hacker.compromisedEvidence += 2;
                        // 污染對手證據
                        if (opponent.evidenceChain.length > 0) {
                            opponent.evidenceChain.forEach(evidence => {
                                if (Math.random() > 0.5) evidence.contaminated = true;
                            });
                        }
                        data = { compromisedAdded: 2 };
                        break;
                    case 'data_injection':
                        message = '執行數據注入攻擊... 向證據庫注入偽造數據';
                        hacker.compromisedEvidence += 3;
                        // 添加偽造證據
                        const fakeEvidence = {
                            id: 'fake_' + Date.now(),
                            name: '偽造證據',
                            category: 'technical',
                            contaminated: true,
                            critical: false,
                            value: 0,
                            fake: true
                        };
                        opponent.evidenceChain.push(fakeEvidence);
                        data = { compromisedAdded: 3, fakeEvidence: true };
                        break;
                    case 'analysis_jamming':
                        message = '干擾高級分析工具... 執法部門AI分析系統效率降低40%';
                        opponent.analysisToolsHealth = Math.max(0, opponent.analysisToolsHealth - 15);
                        opponent.investigationProgress = Math.max(0, opponent.investigationProgress - 10);
                        data = { jamDuration: 30, analysisToolsDamage: 15, investigationReduction: 10 };
                        break;
                    case 'signal_jammer':
                        message = '啟動協作頻道干擾器... 阻斷執法部門通訊';
                        hacker.signalJamming = true;
                        opponent.signalBlocking = true;
                        data = { jammingActive: true };
                        break;
                    case 'fake_command':
                        message = '發送跨部門偽造協作指令... 誤導執法部門調查方向';
                        // 添加虛假情報
                        const fakeIntel = {
                            id: 'fake_intel_' + Date.now(),
                            type: GameState.intelTypes.find(t => !t.real),
                            timestamp: new Date().toLocaleTimeString(),
                            verified: false
                        };
                        opponent.dynamicIntel.push(fakeIntel);
                        data = { fakeCommandSent: true };
                        break;
                    case 'file_wiper':
                        message = '使用文件擦除器... 完全刪除系統痕跡和日誌';
                        hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints - 3);
                        hacker.stealth += 20;
                        data = { footprintsRemoved: 3, stealthIncrease: 20 };
                        break;
                    case 'metasploit':
                        message = '執行Metasploit精準攻擊... 嘗試利用CVE-2023-1234漏洞滲透目標';
                        hacker.stealth -= 15;
                        hacker.digitalFootprints += 3;
                        // 對伺服器造成傷害
                        opponent.serverHealth = Math.max(0, opponent.serverHealth - 10);
                        data = { stealthDecrease: 15, footprintsAdded: 3, damage: 10 };
                        break;
                    case 'server_cripple':
                        message = '發動伺服器癱瘓攻擊... 執法部門指揮中心遭受重創';
                        hacker.stealth -= 30;
                        hacker.digitalFootprints += 8;
                        opponent.serverHealth = Math.max(0, opponent.serverHealth - 40);
                        opponent.evidenceLibraryHealth = Math.max(0, opponent.evidenceLibraryHealth - 30);
                        opponent.analysisToolsHealth = Math.max(0, opponent.analysisToolsHealth - 25);
                        data = { stealthDecrease: 30, damage: 40 };
                        break;
                    case 'memory_attack':
                        message = '使用記憶體無檔案攻擊套件... 在記憶體中執行無痕跡攻擊';
                        hacker.stealth += 10; // 無痕跡攻擊
                        opponent.serverHealth = Math.max(0, opponent.serverHealth - 15);
                        data = { stealthIncrease: 10, damage: 15 };
                        break;
                    case 'node_crippler':
                        message = '使用網路節點癱瘓工具... 癱瘓關鍵網絡節點';
                        opponent.serverHealth = Math.max(0, opponent.serverHealth - 20);
                        opponent.networkSweepActive = false; // 中斷網絡圍捕
                        data = { damage: 20, networkSweepDisabled: true };
                        break;
                    case 'ransomware':
                        message = '部署高級勒索軟件... 加密目標文件進行勒索';
                        hacker.stealth -= 20;
                        hacker.digitalFootprints += 5;
                        opponent.evidenceLibraryHealth = Math.max(0, opponent.evidenceLibraryHealth - 35);
                        opponent.serverHealth = Math.max(0, opponent.serverHealth - 25);
                        // 獲取勒索資金
                        const ransomAmount = 20000 + Math.floor(Math.random() * 30000);
                        hacker.money += ransomAmount;
                        addTransaction('ransom', '勒索軟件收益', ransomAmount);
                        data = { stealthDecrease: 20, damage: 35, ransomEarned: ransomAmount };
                        break;
                    case 'device_hack':
                        message = '入侵執法部門設備... 成功獲取設備訪問權限';
                        const deviceType = GameState.deviceTypes[Math.floor(Math.random() * GameState.deviceTypes.length)];
                        hacker.compromisedDevices.push({...deviceType, accessLevel: 'root'});
                        hacker.stealth -= 8;
                        data = { deviceHacked: deviceType.name, accessLevel: 'root' };
                        break;
                    case 'document_steal':
                        if (hacker.compromisedDevices.length > 0) {
                            const docType = GameState.documentTypes[Math.floor(Math.random() * GameState.documentTypes.length)];
                            hacker.stolenDocuments.push({...docType, decryptionProgress: 0});
                            message = `竊取機密文件: ${docType.name} (價值: ${docType.value}分)`;
                            hacker.stealth -= 12;
                            data = { documentStolen: docType.name, value: docType.value };
                        } else {
                            message = '需要先入侵設備才能竊取文件';
                            success = false;
                        }
                        break;
                    case 'server_infiltration':
                        message = '執行伺服器深度滲透... 獲取核心系統訪問權限';
                        hacker.stealth -= 18;
                        hacker.digitalFootprints += 6;
                        opponent.serverHealth = Math.max(0, opponent.serverHealth - 15);
                        // 有機率獲取管理員權限
                        if (Math.random() > 0.7) {
                            message += ' | 成功獲取管理員權限';
                            data = { stealthDecrease: 18, damage: 15, adminAccess: true };
                        } else {
                            data = { stealthDecrease: 18, damage: 15 };
                        }
                        break;
                    case 'backdoor_implant':
                        message = '植入持久後門系統... 建立永久性訪問通道';
                        hacker.stealth -= 25;
                        hacker.digitalFootprints += 8;
                        // 增加攻擊力
                        hacker.attackPower += 20;
                        data = { stealthDecrease: 25, attackPowerIncrease: 20 };
                        break;
                    case 'decryption_attack':
                        if (hacker.stolenDocuments.length > 0) {
                            const doc = hacker.stolenDocuments[0];
                            doc.decryptionProgress += 25;
                            if (doc.decryptionProgress >= 100) {
                                doc.decrypted = true;
                                message = `成功解密文件: ${doc.name} (已解鎖內容)`;
                                hacker.decryptionProgress += doc.value;
                            } else {
                                message = `解密進度: ${doc.name} (${doc.decryptionProgress}%)`;
                            }
                            data = { decryptionProgress: doc.decryptionProgress };
                        } else {
                            message = '沒有需要解密的文件';
                            success = false;
                        }
                        break;
                    case 'browser_exploit':
                        message = '利用瀏覽器漏洞... 獲取瀏覽器歷史和設備信息';
                        // 添加瀏覽器相關證據到對手證據鏈
                        const browserEvidence = GameState.evidenceTypes.find(e => e.id === 'browser_history');
                        opponent.evidenceChain.push({...browserEvidence, contaminated: false});
                        // 也為自己添加設備信息
                        const deviceEvidence = GameState.evidenceTypes.find(e => e.id === 'device_spec');
                        opponent.evidenceChain.push({...deviceEvidence, contaminated: false});
                        hacker.stealth -= 10;
                        data = { evidenceAdded: 2, stealthDecrease: 10 };
                        break;
                    case 'bait_server':
                        message = '部署誘餌伺服器... 成功誤導執法部門追蹤';
                        hacker.stealth += 15;
                        // 添加虛假位置情報
                        const fakeLocation = {
                            id: 'fake_location_' + Date.now(),
                            type: GameState.intelTypes.find(t => t.id === 'fake_location'),
                            timestamp: new Date().toLocaleTimeString(),
                            location: '虛擬位置: 歐洲數據中心'
                        };
                        if (opponent.dynamicIntel) {
                            opponent.dynamicIntel.push(fakeLocation);
                        }
                        data = { stealthIncrease: 15, fakeLocationSet: true };
                        break;
                    case 'fake_fingerprint':
                        message = '使用偽造攻擊指紋工具... 成功偽裝攻擊來源';
                        hacker.stealth += 20;
                        // 添加虛假攻擊指紋
                        data = { stealthIncrease: 20, fingerprintSpoofed: true };
                        break;
                    case 'phishing_generator':
                        message = '生成社會工程釣魚攻擊... 欺騙目標點擊惡意鏈接';
                        // 有機率獲取登錄憑證
                        if (Math.random() > 0.7) {
                            hacker.stealth += 15;
                            data = { phishingSuccess: true, stealthIncrease: 15 };
                        } else {
                            data = { phishingAttempted: true };
                        }
                        break;
                    case 'hardware_spoof':
                        message = '使用硬體指紋偽造器... 成功偽造設備識別信息';
                        hacker.stealth += 25;
                        hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints - 3);
                        data = { stealthIncrease: 25, footprintsRemoved: 3 };
                        break;
                    case 'darknet_market':
                        message = '訪問暗網委託市場... 購買黑市工具和服務';
                        hacker.darknetCredits += 50;
                        // 隨機獲得一個黑市工具
                        const darknetTools = ['zero_day_exploit', 'advanced_backdoor', 'custom_malware'];
                        const toolGained = darknetTools[Math.floor(Math.random() * darknetTools.length)];
                        hacker.tools.push(toolGained);
                        data = { darknetCredits: 50, toolGained: toolGained };
                        break;
                    default:
                        message = '使用工具: ' + toolId;
                }
                
                // 確保數值在合理範圍內
                hacker.stealth = Math.max(0, Math.min(100, hacker.stealth));
                hacker.encryptionLevel = Math.max(0, Math.min(100, hacker.encryptionLevel));
                hacker.serverHealth = Math.max(0, Math.min(100, hacker.serverHealth));
                hacker.deviceHealth = Math.max(0, Math.min(100, hacker.deviceHealth));
                hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints);
                hacker.attackPower = Math.min(100, hacker.attackPower);
                
                // 更新任務狀態
                updateHackerMissions();
                
            } else {
                // 執法部門工具
                const le = GameState.playerData.law_enforcement;
                const opponent = GameState.opponentData.hacker;
                
                switch(toolId) {
                    case 'digital_forensics':
                        message = '執行高級數碼鑑識... 發現惡意軟件行為模式，技術鎖定+12%';
                        le.identityLock.technical += 12;
                        le.investigationProgress += 8;
                        // 有機率發現關鍵證據
                        if (Math.random() > 0.6) {
                            const evidence = GameState.evidenceTypes.find(e => e.id === 'malware_sample');
                            le.evidenceChain.push({...evidence, contaminated: false});
                            if (evidence.critical) le.criticalEvidence.push(evidence.id);
                            message += ' | 發現惡意軟件樣本（關鍵證據）';
                        }
                        data = { technicalLock: 12, investigationProgress: 8 };
                        break;
                    case 'social_analyzer':
                        message = '分析社交圖譜... 發現可疑社交網絡模式，社交鎖定+15%';
                        le.identityLock.social += 15;
                        le.investigationProgress += 10;
                        // 有機率發現關鍵證據
                        if (Math.random() > 0.7) {
                            const evidence = GameState.evidenceTypes.find(e => e.id === 'online_profile');
                            le.evidenceChain.push({...evidence, contaminated: false});
                            if (evidence.critical) le.criticalEvidence.push(evidence.id);
                            message += ' | 發現網絡身份檔案（關鍵證據）';
                        }
                        data = { socialLock: 15, investigationProgress: 10 };
                        break;
                    case 'network_mapping':
                        message = '繪製實時網絡流量圖... 發現異常外連模式，技術鎖定+8%';
                        le.identityLock.technical += 8;
                        le.investigationProgress += 6;
                        // 發現網絡流量數據
                        const trafficEvidence = GameState.evidenceTypes.find(e => e.id === 'network_traffic');
                        le.evidenceChain.push({...trafficEvidence, contaminated: false});
                        if (trafficEvidence.critical) le.criticalEvidence.push(trafficEvidence.id);
                        data = { technicalLock: 8, investigationProgress: 6, evidenceAdded: true };
                        break;
                    case 'gps_tracker':
                        message = '啟動超強GPS衛星定位... 追蹤目標地理位置';
                        le.gpsTracking = true;
                        le.identityLock.physical += 20;
                        // 發現位置數據
                        const locationEvidence = GameState.evidenceTypes.find(e => e.id === 'location_data');
                        le.evidenceChain.push({...locationEvidence, contaminated: false});
                        if (locationEvidence.critical) le.criticalEvidence.push(locationEvidence.id);
                        data = { gpsActive: true, physicalLock: 20, evidenceAdded: true };
                        break;
                    case 'cctv_access':
                        message = '訪問CCTV監控系統... 分析監控錄像尋找線索';
                        le.identityLock.physical += 15;
                        // 發現物理證據
                        data = { physicalLock: 15, cctvAnalyzed: true };
                        break;
                    case 'blockchain_tracker':
                        message = '使用區塊鏈追蹤系統... 深度追蹤加密貨幣流向';
                        le.identityLock.social += 18;
                        le.investigationProgress += 12;
                        // 發現加密貨幣交易證據
                        const cryptoEvidence = GameState.evidenceTypes.find(e => e.id === 'crypto_transaction');
                        le.evidenceChain.push({...cryptoEvidence, contaminated: false});
                        if (cryptoEvidence.critical) le.criticalEvidence.push(cryptoEvidence.id);
                        data = { socialLock: 18, investigationProgress: 12, evidenceAdded: true };
                        break;
                    case 'honeypot':
                        message = '部署智能主動蜜罐系統... 成功誘捕黑客攻擊';
                        le.activeHoneypots++;
                        const malwareEvidence = GameState.evidenceTypes.find(e => e.id === 'malware_sample');
                        le.evidenceChain.push({...malwareEvidence, contaminated: false, critical: true});
                        le.criticalEvidence.push(malwareEvidence.id);
                        le.identityLock.technical += 25;
                        // 獲取攻擊指紋
                        opponent.stealth -= 20;
                        data = { honeypots: le.activeHoneypots, technicalLock: 25, evidenceAdded: true };
                        break;
                    case 'network_sweep':
                        message = '發動網絡圍捕行動... 壓縮黑客可用匿名節點';
                        le.networkSweepActive = true;
                        opponent.activeVpnNodes = Math.max(1, opponent.activeVpnNodes - 2);
                        opponent.stealth -= 15;
                        data = { networkSweepActive: true, vpnNodesReduced: 2 };
                        break;
                    case 'signal_blocker':
                        message = '啟動阻擋防止幹擾信號... 防止通訊干擾';
                        le.signalBlocking = true;
                        opponent.signalJamming = false;
                        data = { signalBlockingActive: true, jammingBlocked: true };
                        break;
                    case 'emergency_shutdown':
                        message = '執行緊急斷流... 切斷可疑網絡連接';
                        opponent.stealth -= 25;
                        opponent.activeVpnNodes = Math.max(1, opponent.activeVpnNodes - 3);
                        data = { shutdownExecuted: true, stealthReduction: 25 };
                        break;
                    case 'evidence_protector':
                        message = '啟動證據保護系統... 保護證據庫免受污染';
                        // 清除現有證據污染
                        le.evidenceChain.forEach(evidence => {
                            evidence.contaminated = false;
                        });
                        le.evidenceLibraryHealth = Math.min(100, le.evidenceLibraryHealth + 20);
                        data = { evidenceProtected: true, libraryHealthIncrease: 20 };
                        break;
                    case 'ai_predictor':
                        message = '使用AI行為預測系統... 預測黑客下一步行動';
                        le.investigationProgress += 15;
                        // 有機率提前阻止攻擊
                        if (Math.random() > 0.6) {
                            opponent.stealth -= 10;
                            message += ' | 成功預測並阻止一次攻擊';
                            data = { investigationProgress: 15, attackPrevented: true };
                        } else {
                            data = { investigationProgress: 15 };
                        }
                        break;
                    case 'department_coord':
                        if (!le.departments.criminal.active) {
                            le.departments.criminal.active = true;
                            le.departments.criminal.resources = 100;
                            message = '協調刑事偵緝科加入調查。調查速度+25%，逮捕令進度+20%。';
                            le.warrantProgress += 20;
                        } else if (!le.departments.antiTerror.active) {
                            le.departments.antiTerror.active = true;
                            le.departments.antiTerror.resources = 100;
                            message = '協調互聯網反恐科加入調查。調查速度+40%，逮捕令進度+25%。';
                            le.warrantProgress += 25;
                        } else {
                            message = '所有部門已協調完畢。聯合調查效率最大化。';
                        }
                        data = { warrantProgress: le.warrantProgress };
                        break;
                    case 'command_panel':
                        message = '使用跨部門指揮面板... 協調所有部門聯合行動';
                        Object.values(le.departments).forEach(dept => {
                            if (dept.active) dept.resources = Math.min(100, dept.resources + 20);
                        });
                        le.investigationProgress += 15;
                        le.warrantProgress += 10;
                        data = { resourcesBoosted: true, investigationProgress: 15 };
                        break;
                    case 'resource_allocator':
                        message = '使用資源分配系統... 智能分配部門資源';
                        Object.values(le.departments).forEach(dept => {
                            if (dept.active) dept.resources = Math.min(100, dept.resources + 30);
                        });
                        le.investigationProgress += 20;
                        data = { resourcesMaximized: true, investigationProgress: 20 };
                        break;
                    case 'interpol_request':
                        message = '請求國際刑警協助... 獲得全球犯罪數據庫訪問權限';
                        le.identityLock.social += 20;
                        le.identityLock.physical += 15;
                        // 發現國際相關證據
                        data = { socialLock: 20, physicalLock: 15, interpolAccess: true };
                        break;
                    case 'warrant_request':
                        if (le.identityLock.technical >= 80 && le.identityLock.social >= 80 && le.identityLock.physical >= 80 && le.criticalEvidence.length >= 3) {
                            message = '申請逮捕令... 證據充足，逮捕令已簽發！開始收網行動。';
                            le.warrantIssued = true;
                            le.warrantProgress = 100;
                            startArrestCountdown();
                        } else {
                            message = '申請逮捕令失敗... 條件不足 (需要三階層均≥80%且至少3項關鍵證據)';
                            success = false;
                        }
                        break;
                    case 'password_cracker':
                        message = '使用破解裝置加密密碼工具... 嘗試解密密碼保護';
                        // 有機率破解加密
                        if (Math.random() > 0.5) {
                            const encryptionEvidence = GameState.evidenceTypes.find(e => e.id === 'encryption_key');
                            le.evidenceChain.push({...encryptionEvidence, contaminated: false});
                            if (encryptionEvidence.critical) le.criticalEvidence.push(encryptionEvidence.id);
                            le.identityLock.technical += 15;
                            message += ' | 成功獲取加密密鑰片段，技術鎖定+15%';
                        } else {
                            message += ' | 解密嘗試失敗';
                        }
                        data = { decryptionAttempted: true };
                        break;
                    case 'intercept_key':
                        message = '使用合法攔截密鑰... 獲取加密通訊攔截權限';
                        le.identityLock.technical += 18;
                        // 發現加密通訊證據
                        data = { technicalLock: 18, interceptEnabled: true };
                        break;
                    case 'encryption_breaker':
                        message = '使用加密破解系統... 深度破解高級加密系統';
                        le.identityLock.technical += 22;
                        le.investigationProgress += 18;
                        // 如果黑客有加密文件，嘗試解密
                        if (opponent.stolenDocuments.length > 0 && Math.random() > 0.7) {
                            message += ' | 成功解密黑客竊取的文件';
                            opponent.stolenDocuments.shift();
                            opponent.decryptionProgress = Math.max(0, opponent.decryptionProgress - 50);
                        }
                        data = { technicalLock: 22, investigationProgress: 18 };
                        break;
                    case 'threat_analysis':
                        message = '啟動全網威脅感測器... 檢測和分析網絡威脅';
                        le.investigationProgress += 12;
                        // 驗證動態情報
                        if (le.dynamicIntel.length > 0) {
                            const intelToVerify = le.dynamicIntel[0];
                            intelToVerify.verified = true;
                            le.verifiedIntel.push(intelToVerify);
                            message += ' | 驗證一條情報真實性';
                        }
                        data = { investigationProgress: 12, intelVerified: true };
                        break;
                    case 'behavior_analysis':
                        message = '執行行為模式分析... 分析黑客行為模式預測下一步';
                        le.investigationProgress += 14;
                        // 有機率獲取黑客位置信息
                        if (Math.random() > 0.6) {
                            le.identityLock.physical += 12;
                            message += ' | 預測到黑客可能位置，實體鎖定+12%';
                            data = { investigationProgress: 14, physicalLock: 12 };
                        } else {
                            data = { investigationProgress: 14 };
                        }
                        break;
                    case 'memory_forensics':
                        message = '使用內存取證工具... 分析內存攻擊痕跡';
                        le.identityLock.technical += 16;
                        // 發現內存攻擊證據
                        data = { technicalLock: 16, memoryForensics: true };
                        break;
                    case 'counter_attack':
                        message = '發動反擊系統... 對黑客系統造成嚴重傷害';
                        opponent.serverHealth = Math.max(0, opponent.serverHealth - 30);
                        opponent.deviceHealth = Math.max(0, opponent.deviceHealth - 25);
                        opponent.stealth -= 20;
                        le.investigationProgress += 10;
                        data = { damage: 30, stealthReduction: 20, investigationProgress: 10 };
                        break;
                    case 'backtrace':
                        message = '執行反向追蹤攻擊... 反向追蹤黑客真實位置';
                        opponent.stealth -= 35;
                        opponent.activeVpnNodes = Math.max(1, opponent.activeVpnNodes - 3);
                        le.identityLock.physical += 25;
                        le.identityLock.technical += 20;
                        data = { stealthReduction: 35, physicalLock: 25, technicalLock: 20 };
                        break;
                    case 'system_lockdown':
                        message = '執行系統鎖定... 鎖定黑客系統阻止進一步攻擊';
                        opponent.stealth -= 40;
                        opponent.attackPower = Math.max(0, opponent.attackPower - 30);
                        le.investigationProgress += 15;
                        data = { stealthReduction: 40, attackPowerReduction: 30, investigationProgress: 15 };
                        break;
                    case 'rapid_response':
                        message = '執行快速反應攻擊... 對黑客系統造成快速打擊';
                        opponent.serverHealth = Math.max(0, opponent.serverHealth - 25);
                        opponent.deviceHealth = Math.max(0, opponent.deviceHealth - 20);
                        le.warrantProgress += 15;
                        data = { damage: 25, warrantProgress: 15 };
                        break;
                    default:
                        message = '使用工具: ' + toolId;
                }
                
                // 確保數值在合理範圍內
                le.identityLock.technical = Math.min(100, le.identityLock.technical);
                le.identityLock.social = Math.min(100, le.identityLock.social);
                le.identityLock.physical = Math.min(100, le.identityLock.physical);
                le.investigationProgress = Math.min(100, le.investigationProgress);
                le.warrantProgress = Math.min(100, le.warrantProgress);
                le.serverHealth = Math.max(0, Math.min(100, le.serverHealth));
                le.evidenceLibraryHealth = Math.max(0, Math.min(100, le.evidenceLibraryHealth));
                le.analysisToolsHealth = Math.max(0, Math.min(100, le.analysisToolsHealth));
                
                // 更新任務狀態
                updateLawEnforcementMissions();
            }
            
            // 設置冷卻時間
            if (tool) {
                GameState.playerData[GameState.currentRole].cooldowns[toolId] = Date.now() + tool.cooldown * 1000;
            }
            
            // 顯示詳細結果
            if (success) {
                addTerminalLine(`[工具] ${message}`, 'command');
                if (data) {
                    const dataStr = JSON.stringify(data).replace(/[{}"]/g, '').replace(/,/g, ', ').replace(/:/g, ': ');
                    addTerminalLine(`[數據] ${dataStr}`, 'response');
                }
            } else {
                addTerminalLine(`[錯誤] ${message}`, 'error');
            }
            
            // 更新UI
            updateSystemDetails();
            updateGameStats();
            updateSystemStatusBars();
            updateAttackDefenseBars();
            updateHealthVisualization();
            updateTargetRealtimeInfo();
            updateMissionList();
            updateSpecialPanel();
            
            // AI對手的反應
            setTimeout(() => aiOpponentAction(), 1500);
            
            // 生成新的動態情報
            generateDynamicIntel();
        }

        // ===== 更新黑客任務狀態 =====
        function updateHackerMissions() {
            const hacker = GameState.playerData.hacker;
            const missions = GameState.missions.hacker;
            
            missions.forEach(mission => {
                switch(mission.id) {
                    case 'stealth_high':
                        mission.status = hacker.stealth > 80 ? 'complete' : 'incomplete';
                        break;
                    case 'footprints_low':
                        mission.status = hacker.digitalFootprints < 3 ? 'complete' : 'incomplete';
                        break;
                    case 'decrypt_docs':
                        const decryptedDocs = hacker.stolenDocuments.filter(doc => doc.decrypted).length;
                        mission.status = decryptedDocs >= 2 ? 'complete' : 'incomplete';
                        break;
                    case 'compromise_devices':
                        mission.status = hacker.compromisedDevices.length >= 3 ? 'complete' : 'incomplete';
                        break;
                    case 'pollute_evidence':
                        mission.status = hacker.compromisedEvidence >= 5 ? 'complete' : 'incomplete';
                        break;
                }
            });
        }

        // ===== 更新執法部門任務狀態 =====
        function updateLawEnforcementMissions() {
            const le = GameState.playerData.law_enforcement;
            const missions = GameState.missions.law_enforcement;
            
            missions.forEach(mission => {
                switch(mission.id) {
                    case 'identity_lock':
                        const identityAvg = Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3);
                        mission.status = identityAvg > 80 ? 'complete' : 'incomplete';
                        break;
                    case 'critical_evidence':
                        mission.status = le.criticalEvidence.length >= 3 ? 'complete' : 'incomplete';
                        break;
                    case 'verify_intel':
                        mission.status = le.verifiedIntel.length >= 5 ? 'complete' : 'incomplete';
                        break;
                    case 'coordinate_depts':
                        const activeDepts = Object.values(le.departments).filter(dept => dept.active).length;
                        mission.status = activeDepts >= 4 ? 'complete' : 'incomplete';
                        break;
                    case 'arrest_warrant':
                        mission.status = le.warrantIssued ? 'complete' : 'incomplete';
                        break;
                }
            });
        }

        // ===== 生成動態情報 =====
        function generateDynamicIntel() {
            if (!GameState.gameActive) return;
            
            // 30%機率生成新情報
            if (Math.random() < 0.3) {
                const intelType = GameState.intelTypes[Math.floor(Math.random() * GameState.intelTypes.length)];
                const intel = {
                    id: 'intel_' + Date.now(),
                    type: intelType,
                    timestamp: new Date().toLocaleTimeString(),
                    verified: false
                };
                
                // 根據當前角色添加情報
                if (GameState.currentRole === 'law_enforcement') {
                    GameState.playerData.law_enforcement.dynamicIntel.push(intel);
                    addTerminalLine(`[情報] 收到新情報: ${intelType.name} (${intelType.real ? '真實' : '可疑'})`, 'warning');
                } else {
                    // 對手的動態情報
                    if (GameState.opponentData.law_enforcement && GameState.opponentData.law_enforcement.dynamicIntel) {
                        GameState.opponentData.law_enforcement.dynamicIntel.push(intel);
                    }
                }
                
                updateSpecialPanel();
            }
        }

        // ===== 特殊面板更新 (根據角色) =====
        function updateSpecialPanel() {
            const specialPanel = document.getElementById('special-panel');
            if (!specialPanel) return;
            
            if (GameState.currentRole === 'law_enforcement') {
                const le = GameState.playerData.law_enforcement;
                
                // 部門面板
                let departmentsHTML = '';
                Object.values(le.departments).forEach(dept => {
                    departmentsHTML += `
                        <div class="department-panel">
                            <div class="department-header">
                                <div class="department-name">${dept.name}</div>
                                <div class="department-status ${dept.active ? 'status-active' : 'status-inactive'}">
                                    ${dept.active ? '活動中' : '未啟動'}
                                </div>
                            </div>
                            <div class="department-resources">
                                <div class="resource-item">
                                    <div class="resource-label">資源</div>
                                    <div class="resource-value">${dept.resources}%</div>
                                </div>
                                <div class="resource-item">
                                    <div class="resource-label">效率</div>
                                    <div class="resource-value">${dept.active ? '高' : '低'}</div>
                                </div>
                                <div class="resource-item">
                                    <div class="resource-label">狀態</div>
                                    <div class="resource-value">${dept.active ? '在線' : '離線'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // 動態情報面板
                let intelHTML = '';
                if (le.dynamicIntel.length > 0) {
                    intelHTML = `
                        <div class="dynamic-intel-panel">
                            <div class="intel-header">
                                <div class="intel-title">動態情報驗證系統</div>
                                <div class="intel-verification">待驗證: ${le.dynamicIntel.length}</div>
                            </div>
                            <div class="intel-list">
                    `;
                    
                    le.dynamicIntel.slice(-5).forEach((intel, index) => {
                        intelHTML += `
                            <div class="intel-item ${intel.type.real ? '' : 'fake'}">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${intel.type.name}</span>
                                    <span style="color: ${intel.type.real ? '#00ff41' : '#ff3333'}; font-size: 0.8rem;">
                                        ${intel.type.real ? '真實' : '可疑'}
                                    </span>
                                </div>
                                <div style="color: #888; font-size: 0.8rem;">${intel.timestamp}</div>
                                ${intel.verified ? '<div style="color: #00ff41; font-size: 0.8rem;">✅ 已驗證</div>' : ''}
                            </div>
                        `;
                    });
                    
                    intelHTML += `
                            </div>
                            <div style="margin-top: 10px;">
                                <button class="btn btn-primary" onclick="verifyIntel()" style="width: 100%; padding: 8px;">
                                    <i class="fas fa-check-circle"></i> 驗證情報
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // 網絡圍捕狀態
                let networkSweepHTML = '';
                if (le.networkSweepActive) {
                    networkSweepHTML = `
                        <div class="network-sweep">
                            <div style="color: #4a90d9; font-weight: bold;">
                                <i class="fas fa-network-wired"></i> 網絡圍捕進行中
                            </div>
                            <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                                壓縮黑客匿名節點，降低其隱蔽度
                            </div>
                        </div>
                    `;
                }
                
                // 信號干擾狀態
                let signalBlockingHTML = '';
                if (le.signalBlocking) {
                    signalBlockingHTML = `
                        <div class="signal-jammer">
                            <div style="color: #ff00ff; font-weight: bold;">
                                <i class="fas fa-wifi-slash"></i> 信號干擾防護激活
                            </div>
                            <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                                防止通訊干擾，保護協作頻道
                            </div>
                        </div>
                    `;
                }
                
                // GPS追蹤狀態
                let gpsTrackingHTML = '';
                if (le.gpsTracking) {
                    gpsTrackingHTML = `
                        <div class="gps-tracker">
                            <div style="color: #0096ff; font-weight: bold;">
                                <i class="fas fa-satellite"></i> GPS衛星追蹤激活
                            </div>
                            <div class="tracker-map">
                                <div class="tracker-dot" style="top: 60%; left: 40%;"></div>
                                <div class="tracker-dot" style="top: 30%; left: 70%;"></div>
                                <div class="tracker-dot" style="top: 80%; left: 20%;"></div>
                            </div>
                            <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                                追蹤多個可疑位置信號
                            </div>
                        </div>
                    `;
                }
                
                // 蜜罐狀態
                let honeypotHTML = '';
                if (le.activeHoneypots > 0) {
                    honeypotHTML = `
                        <div style="background: rgba(0,255,65,0.1); border-radius: 8px; padding: 10px; margin: 10px 0; border: 1px solid #00ff41;">
                            <div style="color: #00ff41; font-weight: bold;">
                                <i class="fas fa-bug"></i> 主動蜜罐: ${le.activeHoneypots}個活動中
                            </div>
                            <div style="color: #aaa; font-size: 0.9rem;">
                                已收集${le.activeHoneypots * 2}個攻擊指紋
                            </div>
                        </div>
                    `;
                }
                
                // 證據鏈面板
                let evidenceHTML = '';
                le.evidenceChain.forEach((evidence, index) => {
                    evidenceHTML += `
                        <div class="evidence-item ${evidence.contaminated ? 'contaminated' : ''} ${evidence.critical ? 'critical-evidence' : ''}">
                            <div class="evidence-name">${evidence.name}</div>
                            <div class="evidence-desc">類別: ${evidence.category} | 價值: ${evidence.value}分</div>
                            <div class="evidence-status ${evidence.contaminated ? 'contaminated' : ''}">
                                ${evidence.contaminated ? '已污染' : '有效'} | ${evidence.critical ? '關鍵證據' : '一般證據'}
                            </div>
                            ${evidence.contaminated ? 
                                '<div style="color: #ff3333; font-size: 0.8rem; margin-top: 5px;">⚠️ 此證據已被污染，使用會導致進度倒退</div>' : 
                                ''
                            }
                        </div>
                    `;
                });
                
                // 身份鎖定面板
                const identityAvg = Math.round((le.identityLock.technical + le.identityLock.social + le.identityLock.physical) / 3);
                
                // 調查報告
                let investigationReport = '';
                if (le.evidenceChain.length > 0) {
                    investigationReport = `
                        <div class="investigation-report">
                            <div class="report-line">[調查報告 ${new Date().toLocaleTimeString()}]</div>
                            <div class="report-line">總證據數: ${le.evidenceChain.length}</div>
                            <div class="report-line">關鍵證據: ${le.criticalEvidence.length}</div>
                            <div class="report-line">受污染證據: ${le.evidenceChain.filter(e => e.contaminated).length}</div>
                            <div class="report-line">技術鎖定: ${le.identityLock.technical}%</div>
                            <div class="report-line">社交鎖定: ${le.identityLock.social}%</div>
                            <div class="report-line">實體鎖定: ${le.identityLock.physical}%</div>
                        </div>
                    `;
                }
                
                // 伺服器健康狀態
                const serverHealthHTML = `
                    <div class="server-health">
                        <span>指揮中心:</span>
                        <div class="health-bar">
                            <div class="health-fill" style="width: ${le.serverHealth}%"></div>
                        </div>
                        <span class="health-text">${le.serverHealth}%</span>
                    </div>
                    <div class="server-health">
                        <span>證據庫:</span>
                        <div class="health-bar">
                            <div class="health-fill" style="width: ${le.evidenceLibraryHealth}%"></div>
                        </div>
                        <span class="health-text">${le.evidenceLibraryHealth}%</span>
                    </div>
                    <div class="server-health">
                        <span>分析工具:</span>
                        <div class="health-bar">
                            <div class="health-fill" style="width: ${le.analysisToolsHealth}%"></div>
                        </div>
                        <span class="health-text">${le.analysisToolsHealth}%</span>
                    </div>
                `;
                
                // 逮捕倒計時
                let arrestCountdownHTML = '';
                if (le.arrestCountdown) {
                    const timeLeft = Math.max(0, le.arrestCountdown - Math.floor((Date.now() - GameState.gameStartTime) / 1000));
                    if (timeLeft > 0) {
                        arrestCountdownHTML = `
                            <div class="arrest-countdown">
                                <div>收網行動倒計時</div>
                                <div class="arrest-timer">${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}</div>
                                <div>保護指揮中心和證據庫</div>
                            </div>
                        `;
                    }
                }
                
                specialPanel.innerHTML = `
                    ${intelHTML}
                    ${networkSweepHTML}
                    ${signalBlockingHTML}
                    ${gpsTrackingHTML}
                    ${honeypotHTML}
                    
                    <div class="evidence-panel">
                        <div class="evidence-title">
                            <i class="fas fa-file-contract"></i>
                            <span>證據鏈分析</span>
                        </div>
                        ${serverHealthHTML}
                        ${arrestCountdownHTML}
                        <div class="evidence-chain">
                            ${evidenceHTML || '<div style="color: #888; text-align: center; padding: 20px;">尚未收集到證據</div>'}
                        </div>
                        ${investigationReport}
                    </div>
                    
                    <div class="identity-panel">
                        <div class="identity-title">
                            <i class="fas fa-fingerprint"></i>
                            <span>身份鎖定系統</span>
                        </div>
                        
                        <div class="warrant-panel">
                            <div class="warrant-status">
                                <div class="warrant-label">逮捕令狀態</div>
                                <div class="warrant-value">${le.warrantIssued ? '✅ 已簽發' : '❌ 未簽發'}</div>
                            </div>
                            <div class="warrant-progress">
                                <div class="warrant-fill" style="width: ${le.warrantProgress}%">${le.warrantProgress}%</div>
                            </div>
                            <div style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                <div style="color: #aaa; font-size: 0.9rem;">逮捕令條件:</div>
                                <div style="color: ${le.identityLock.technical >= 80 ? '#00ff41' : '#ff3333'}; margin: 5px 0;">
                                    技術鎖定: ${le.identityLock.technical}% ${le.identityLock.technical >= 80 ? '✅' : '❌'}
                                </div>
                                <div style="color: ${le.identityLock.social >= 80 ? '#00ff41' : '#ff3333'}; margin: 5px 0;">
                                    社交鎖定: ${le.identityLock.social}% ${le.identityLock.social >= 80 ? '✅' : '❌'}
                                </div>
                                <div style="color: ${le.identityLock.physical >= 80 ? '#00ff41' : '#ff3333'}; margin: 5px 0;">
                                    實體鎖定: ${le.identityLock.physical}% ${le.identityLock.physical >= 80 ? '✅' : '❌'}
                                </div>
                                <div style="color: ${le.criticalEvidence.length >= 3 ? '#00ff41' : '#ff3333'}; margin: 5px 0;">
                                    關鍵證據: ${le.criticalEvidence.length}/3 ${le.criticalEvidence.length >= 3 ? '✅' : '❌'}
                                </div>
                            </div>
                            <div class="warrant-actions">
                                <button class="btn btn-primary" onclick="requestWarrant()" ${le.warrantIssued ? 'disabled' : ''}>
                                    <i class="fas fa-file-signature"></i> 申請逮捕令
                                </button>
                                <button class="btn btn-warning" onclick="coordinateDepartments()">
                                    <i class="fas fa-users-cog"></i> 跨部門協調
                                </button>
                            </div>
                        </div>
                        
                        ${departmentsHTML}
                    </div>
                `;
            } else {
                // 黑客的特殊面板
                const hacker = GameState.playerData.hacker;
                const opponent = GameState.opponentData.law_enforcement;
                
                // 被入侵設備面板
                let compromisedDevicesHTML = '';
                if (hacker.compromisedDevices.length > 0) {
                    compromisedDevicesHTML = `
                        <div class="compromised-device">
                            <div style="color: #ff9900; font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-laptop-code"></i> 已入侵設備 (${hacker.compromisedDevices.length})
                            </div>
                    `;
                    
                    hacker.compromisedDevices.slice(-3).forEach(device => {
                        compromisedDevicesHTML += `
                            <div style="background: rgba(255,255,255,0.05); padding: 8px; margin: 5px 0; border-radius: 4px;">
                                <div style="color: #fff; font-weight: bold;">${device.name}</div>
                                <div style="color: #aaa; font-size: 0.8rem;">OS: ${device.os}</div>
                                <div style="color: #00ff41; font-size: 0.8rem;">訪問級別: ${device.accessLevel}</div>
                            </div>
                        `;
                    });
                    
                    compromisedDevicesHTML += `
                        </div>
                    `;
                }
                
                // 竊取文件面板
                let stolenDocumentsHTML = '';
                if (hacker.stolenDocuments.length > 0) {
                    stolenDocumentsHTML = `
                        <div class="decryption-panel">
                            <div style="color: #ff9900; font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-file-steal"></i> 竊取文件 (${hacker.stolenDocuments.length})
                            </div>
                    `;
                    
                    hacker.stolenDocuments.forEach(doc => {
                        stolenDocumentsHTML += `
                            <div style="background: rgba(255,255,255,0.05); padding: 8px; margin: 5px 0; border-radius: 4px;">
                                <div style="color: #fff; font-weight: bold;">${doc.name}</div>
                                <div style="color: #aaa; font-size: 0.8rem;">價值: ${doc.value}分 | 加密: ${doc.encrypted ? '是' : '否'}</div>
                                ${doc.encrypted && !doc.decrypted ? `
                                    <div class="decryption-progress">
                                        <div class="decryption-fill" style="width: ${doc.decryptionProgress}%">${doc.decryptionProgress}%</div>
                                    </div>
                                ` : doc.decrypted ? 
                                    '<div style="color: #00ff41; font-size: 0.8rem;">✅ 已解密</div>' : 
                                    '<div style="color: #00ff41; font-size: 0.8rem;">未加密</div>'
                                }
                            </div>
                        `;
                    });
                    
                    stolenDocumentsHTML += `
                        </div>
                    `;
                }
                
                // 暗網市場面板
                let darknetMarketHTML = '';
                if (hacker.darknetCredits > 0) {
                    darknetMarketHTML = `
                        <div class="darknet-market">
                            <div style="color: #00ff41; font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-shopping-bag"></i> 暗網市場積分: ${hacker.darknetCredits}
                            </div>
                            <div class="market-item">
                                <span>零日漏洞</span>
                                <span>50積分</span>
                            </div>
                            <div class="market-item">
                                <span>定制惡意軟件</span>
                                <span>30積分</span>
                            </div>
                            <div class="market-item">
                                <span>高級後門</span>
                                <span>40積分</span>
                            </div>
                            <button class="btn btn-primary" onclick="accessDarknetMarket()" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-store"></i> 訪問暗網市場
                            </button>
                        </div>
                    `;
                }
                
                // 偽造命令日誌
                let fakeCommandLogHTML = '';
                if (opponent && opponent.dynamicIntel && opponent.dynamicIntel.filter(i => !i.type.real).length > 0) {
                    const fakeCommands = opponent.dynamicIntel.filter(i => !i.type.real);
                    fakeCommandLogHTML = `
                        <div class="fake-command-log">
                            <div style="color: #ff3333; font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-file-signature"></i> 偽造命令日誌 (${fakeCommands.length})
                            </div>
                    `;
                    
                    fakeCommands.slice(-3).forEach(cmd => {
                        fakeCommandLogHTML += `
                            <div class="command-entry fake">
                                [${cmd.timestamp}] 發送偽造指令: ${cmd.type.name}
                            </div>
                        `;
                    });
                    
                    fakeCommandLogHTML += `
                        </div>
                    `;
                }
                
                // 信號干擾狀態
                let signalJammingHTML = '';
                if (hacker.signalJamming) {
                    signalJammingHTML = `
                        <div class="signal-jammer">
                            <div style="color: #ff00ff; font-weight: bold;">
                                <i class="fas fa-wifi-slash"></i> 信號干擾激活
                            </div>
                            <div style="color: #aaa; font-size: 0.9rem; margin-top: 5px;">
                                干擾執法部門通訊和協作頻道
                            </div>
                        </div>
                    `;
                }
                
                // 實時情報面板
                let realtimeIntelHTML = '';
                if (hacker.realtimeIntel.length > 0) {
                    realtimeIntelHTML = `
                        <div class="dynamic-intel-panel">
                            <div class="intel-header">
                                <div class="intel-title">實時情報監控</div>
                                <div class="intel-verification">新情報: ${hacker.realtimeIntel.length}</div>
                            </div>
                            <div class="intel-list">
                    `;
                    
                    hacker.realtimeIntel.slice(-5).forEach(intel => {
                        realtimeIntelHTML += `
                            <div class="intel-item">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${intel.type}</span>
                                    <span style="color: #00ff41; font-size: 0.8rem;">${intel.risk}</span>
                                </div>
                                <div style="color: #888; font-size: 0.8rem;">${intel.time}</div>
                            </div>
                        `;
                    });
                    
                    realtimeIntelHTML += `
                            </div>
                        </div>
                    `;
                }
                
                // 系統健康狀態
                let systemsHTML = '';
                hacker.criticalSystems.forEach(system => {
                    systemsHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                            <span style="color: #aaa;">${system.replace(/_/g, ' ').toUpperCase()}</span>
                            <span style="color: #00ff41; font-weight: bold;">ONLINE</span>
                        </div>
                    `;
                });
                
                specialPanel.innerHTML = `
                    ${compromisedDevicesHTML}
                    ${stolenDocumentsHTML}
                    ${darknetMarketHTML}
                    ${fakeCommandLogHTML}
                    ${signalJammingHTML}
                    ${realtimeIntelHTML}
                    
                    <div class="evidence-panel">
                        <div class="evidence-title">
                            <i class="fas fa-shield-alt"></i>
                            <span>反制系統狀態</span>
                        </div>
                        <div style="padding: 15px;">
                            <div class="server-health">
                                <span>主伺服器健康:</span>
                                <div class="health-bar">
                                    <div class="health-fill" style="width: ${hacker.serverHealth}%"></div>
                                </div>
                                <span class="health-text">${hacker.serverHealth}%</span>
                            </div>
                            
                            <div class="server-health">
                                <span>設備健康:</span>
                                <div class="health-bar">
                                    <div class="health-fill" style="width: ${hacker.deviceHealth}%"></div>
                                </div>
                                <span class="health-text">${hacker.deviceHealth}%</span>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span style="color: #aaa;">隱蔽等級</span>
                                    <span style="color: ${hacker.stealth > 70 ? '#00ff41' : hacker.stealth > 40 ? '#ff9900' : '#ff3333'}; font-weight: bold;">${hacker.stealth}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span style="color: #aaa;">加密等級</span>
                                    <span style="color: ${hacker.encryptionLevel > 70 ? '#00ff41' : hacker.encryptionLevel > 40 ? '#ff9900' : '#ff3333'}; font-weight: bold;">${hacker.encryptionLevel}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span style="color: #aaa;">數碼足跡</span>
                                    <span style="color: ${hacker.digitalFootprints < 3 ? '#00ff41' : hacker.digitalFootprints < 6 ? '#ff9900' : '#ff3333'}; font-weight: bold;">${hacker.digitalFootprints}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span style="color: #aaa;">VPN節點</span>
                                    <span style="color: #0088ff; font-weight: bold;">${hacker.activeVpnNodes}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span style="color: #aaa;">解密進度</span>
                                    <span style="color: #ff9900; font-weight: bold;">${hacker.decryptionProgress}分</span>
                                </div>
                            </div>
                            
                            <div style="margin: 20px 0;">
                                <div style="color: #aaa; margin-bottom: 10px;">關鍵系統狀態:</div>
                                ${systemsHTML}
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <button class="btn btn-primary" onclick="cleanAllLogs()" style="width: 100%; margin-bottom: 10px;">
                                    <i class="fas fa-broom"></i> 緊急清除所有足跡 ($${20000})
                                </button>
                                <button class="btn btn-danger" onclick="launchCounterAttack()" style="width: 100%;">
                                    <i class="fas fa-skull-crossbones"></i> 發動全面反擊 ($${50000})
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ===== 執法部門特殊功能 =====
        function verifyIntel() {
            const le = GameState.playerData.law_enforcement;
            
            if (le.dynamicIntel.length === 0) {
                addTerminalLine('[錯誤] 沒有待驗證的情報。', 'error');
                return;
            }
            
            // 驗證第一條情報
            const intel = le.dynamicIntel[0];
            intel.verified = true;
            
            if (intel.type.real) {
                // 真實情報提供調查進度
                le.investigationProgress += 10;
                addTerminalLine(`[情報驗證] ${intel.type.name} 是真實情報。調查進度+10%。`, 'success');
                
                // 根據情報類別增加對應鎖定
                switch(intel.type.category) {
                    case 'technical':
                        le.identityLock.technical += 8;
                        addTerminalLine(`[情報] 技術鎖定+8%`, 'system');
                        break;
                    case 'social':
                        le.identityLock.social += 8;
                        addTerminalLine(`[情報] 社交鎖定+8%`, 'system');
                        break;
                    case 'physical':
                        le.identityLock.physical += 8;
                        addTerminalLine(`[情報] 實體鎖定+8%`, 'system');
                        break;
                }
            } else {
                // 虛假情報導致調查方向錯誤
                le.investigationProgress = Math.max(0, le.investigationProgress - 15);
                addTerminalLine(`[情報驗證] ${intel.type.name} 是虛假情報！調查方向錯誤，進度-15%。`, 'error');
            }
            
            // 移動到已驗證列表
            le.verifiedIntel.push(intel);
            le.dynamicIntel.shift();
            
            updateSpecialPanel();
            updateGameStats();
            updateMissionList();
        }

        function requestWarrant() {
            const le = GameState.playerData.law_enforcement;
            
            if (le.identityLock.technical >= 80 && le.identityLock.social >= 80 && le.identityLock.physical >= 80 && le.criticalEvidence.length >= 3) {
                le.warrantIssued = true;
                le.warrantProgress = 100;
                addTerminalLine('[系統] 逮捕令申請成功！法官已簽發正式逮捕令。', 'success');
                addTerminalLine('[系統] 開始收網行動倒計時...', 'alert');
                addTerminalLine('[證據報告] 已提交以下關鍵證據:', 'system');
                le.criticalEvidence.forEach((evidenceId, index) => {
                    const evidence = GameState.evidenceTypes.find(e => e.id === evidenceId);
                    if (evidence) {
                        addTerminalLine(`  ${index + 1}. ${evidence.name} (${evidence.value}分)`, 'system');
                    }
                });
                
                // 開始逮捕倒計時
                startArrestCountdown();
                updateSpecialPanel();
                updateMissionList();
            } else {
                addTerminalLine('[錯誤] 逮捕令申請失敗：條件不足。', 'error');
                addTerminalLine(`[狀態] 技術鎖定: ${le.identityLock.technical}% ${le.identityLock.technical >= 80 ? '✅' : '❌'}`, 'warning');
                addTerminalLine(`[狀態] 社交鎖定: ${le.identityLock.social}% ${le.identityLock.social >= 80 ? '✅' : '❌'}`, 'warning');
                addTerminalLine(`[狀態] 實體鎖定: ${le.identityLock.physical}% ${le.identityLock.physical >= 80 ? '✅' : '❌'}`, 'warning');
                addTerminalLine(`[狀態] 關鍵證據: ${le.criticalEvidence.length}/3 ${le.criticalEvidence.length >= 3 ? '✅' : '❌'}`, 'warning');
            }
        }

        function coordinateDepartments() {
            const le = GameState.playerData.law_enforcement;
            
            if (!le.departments.criminal.active) {
                le.departments.criminal.active = true;
                le.departments.criminal.resources = 100;
                le.warrantProgress += 20;
                addTerminalLine('[系統] 已協調刑事偵緝科加入調查。調查速度+25%，逮捕令進度+20%。', 'success');
                addTerminalLine('[部門] 刑事偵緝科特點: 實體追蹤、傳統調查方法、跨區域協作', 'system');
            } else if (!le.departments.antiTerror.active) {
                le.departments.antiTerror.active = true;
                le.departments.antiTerror.resources = 100;
                le.warrantProgress += 25;
                addTerminalLine('[系統] 已協調互聯網反恐科加入調查。調查速度+40%，逮捕令進度+25%。', 'success');
                addTerminalLine('[部門] 互聯網反恐科特點: 網絡監控、威脅情報、國際合作', 'system');
            } else {
                addTerminalLine('[信息] 所有可用部門已加入調查。聯合調查效率最大化。', 'system');
            }
            
            updateSpecialPanel();
            updateGameStats();
            updateMissionList();
        }

        // ===== 黑客特殊功能 =====
        function accessDarknetMarket() {
            const hacker = GameState.playerData.hacker;
            
            if (hacker.darknetCredits < 30) {
                showNotification('積分不足', '需要至少30暗網積分購買工具。', 'warning');
                return;
            }
            
            const darknetItems = [
                { name: '零日漏洞利用', cost: 50, effect: '攻擊力+50' },
                { name: '定制勒索軟件', cost: 40, effect: '加密目標文件' },
                { name: '高級持久化後門', cost: 45, effect: '永久系統訪問' },
                { name: '網絡監聽工具', cost: 35, effect: '監聽網絡通訊' }
            ];
            
            let marketHTML = '<div class="modal-title"><i class="fas fa-store"></i><span>暗網市場</span></div>';
            marketHTML += '<div class="modal-message">使用暗網積分購買黑市工具:</div>';
            
            darknetItems.forEach(item => {
                marketHTML += `
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid rgba(0,255,65,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #00ff41; font-weight: bold;">${item.name}</div>
                                <div style="color: #aaa; font-size: 0.9rem;">效果: ${item.effect}</div>
                            </div>
                            <div>
                                <div style="color: #ff9900; font-weight: bold;">${item.cost}積分</div>
                                <button onclick="buyDarknetItem('${item.name}')" style="padding: 8px 15px; background: rgba(0,255,65,0.2); border: 1px solid #00ff41; color: #00ff41; border-radius: 4px; cursor: pointer; margin-top: 5px;" ${hacker.darknetCredits < item.cost ? 'disabled' : ''}>
                                    購買
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            marketHTML += `<div style="color: #00ff41; margin-top: 15px;">你的積分: ${hacker.darknetCredits}</div>`;
            
            showCustomModal('暗網市場', marketHTML);
        }

        function buyDarknetItem(itemName) {
            const hacker = GameState.playerData.hacker;
            const item = {
                '零日漏洞利用': { cost: 50, effect: () => { hacker.attackPower += 50; } },
                '定制勒索軟件': { cost: 40, effect: () => { 
                    // 對對手造成傷害
                    if (GameState.opponentData.law_enforcement) {
                        GameState.opponentData.law_enforcement.serverHealth = Math.max(0, GameState.opponentData.law_enforcement.serverHealth - 25);
                    }
                } },
                '高級持久化後門': { cost: 45, effect: () => { 
                    hacker.stealth += 20;
                    hacker.activeVpnNodes += 2;
                } },
                '網絡監聽工具': { cost: 35, effect: () => { 
                    // 獲取情報
                    generateDynamicIntel();
                    generateDynamicIntel(); // 兩次獲取更多情報
                } }
            }[itemName];
            
            if (!item) return;
            
            if (hacker.darknetCredits < item.cost) {
                showNotification('積分不足', `需要 ${item.cost} 積分，但只有 ${hacker.darknetCredits} 積分。`, 'warning');
                return;
            }
            
            hacker.darknetCredits -= item.cost;
            item.effect();
            
            addTerminalLine(`[暗網] 購買了 ${itemName}，花費 ${item.cost} 積分`, 'success');
            addTransaction('darknet_purchase', `暗網購買: ${itemName}`, 0, item.cost + '積分');
            updateGameStats();
            updateSpecialPanel();
            document.getElementById('custom-modal').classList.remove('active');
        }

        function cleanAllLogs() {
            const hacker = GameState.playerData.hacker;
            
            if (hacker.money < 20000) {
                addTerminalLine('[錯誤] 資金不足！需要 $20,000 進行緊急清除。', 'error');
                return;
            }
            
            if (hacker.digitalFootprints <= 0) {
                addTerminalLine('[信息] 沒有數碼足跡需要清除。', 'system');
                return;
            }
            
            hacker.money -= 20000;
            hacker.stealth = Math.min(100, hacker.stealth + 30);
            hacker.digitalFootprints = 0;
            addTerminalLine('[系統] 緊急清除所有數碼足跡！隱蔽度+30%，所有足跡已清除。', 'success');
            addTerminalLine('[花費] 已扣除 $20,000 服務費用。', 'system');
            addTransaction('purchase', '緊急清除所有足跡', -20000);
            
            updateGameStats();
            updateSpecialPanel();
            updateMissionList();
        }

        function launchCounterAttack() {
            const hacker = GameState.playerData.hacker;
            
            if (hacker.money < 50000) {
                addTerminalLine('[錯誤] 資金不足！需要 $50,000 發動反擊。', 'error');
                return;
            }
            
            hacker.money -= 50000;
            hacker.stealth -= 30;
            hacker.digitalFootprints += 5;
            
            // 對執法部門造成重大傷害
            if (GameState.opponentData.law_enforcement) {
                const opponent = GameState.opponentData.law_enforcement;
                opponent.serverHealth = Math.max(0, opponent.serverHealth - 40);
                opponent.evidenceLibraryHealth = Math.max(0, opponent.evidenceLibraryHealth - 50);
                opponent.analysisToolsHealth = Math.max(0, opponent.analysisToolsHealth - 35);
                
                // 隨機刪除大量證據
                if (opponent.evidenceChain.length > 0) {
                    const removeCount = Math.min(5, Math.floor(opponent.evidenceChain.length * 0.7));
                    opponent.evidenceChain.splice(0, removeCount);
                    // 也刪除關鍵證據
                    opponent.criticalEvidence = [];
                }
                
                // 中斷網絡圍捕
                opponent.networkSweepActive = false;
                // 關閉GPS追蹤
                opponent.gpsTracking = false;
                // 破壞蜜罐
                opponent.activeHoneypots = 0;
                // 關閉信號防護
                opponent.signalBlocking = false;
            }
            
            addTerminalLine('[系統] 發動全面反擊！執法部門指揮中心遭受重創。', 'success');
            addTerminalLine('[攻擊] 伺服器傷害: -40% | 證據庫傷害: -50% | 分析工具傷害: -35%', 'alert');
            addTerminalLine('[攻擊] 網絡圍捕中斷 | GPS追蹤關閉 | 蜜罐破壞 | 信號防護關閉', 'alert');
            addTerminalLine('[代價] 隱蔽度-30%，足跡+5，資金-50,000', 'warning');
            addTransaction('purchase', '全面反擊行動', -50000);
            
            updateGameStats();
            updateTargetRealtimeInfo();
            updateSpecialPanel();
        }

        // ===== 商店功能 =====
        function openShop() {
            if (!GameState.currentRole) {
                showNotification('請先選擇角色', '請返回主頁選擇角色後再訪問商店。', 'warning');
                return;
            }
            
            if (GameState.currentRole === 'hacker') {
                openHackerShop();
            } else {
                openLEShop();
            }
        }

        function openHackerShop() {
            const hacker = GameState.playerData.hacker;
            const categories = ['stealth', 'attack', 'counter', 'infiltration', 'advanced'];
            const categoryNames = {
                stealth: '隱蔽工具',
                attack: '攻擊工具',
                counter: '反制工具',
                infiltration: '入侵工具',
                advanced: '高級工具'
            };
            
            let shopHTML = `
                <div class="shop-container">
                    <div class="modal-title">
                        <i class="fas fa-shopping-cart"></i>
                        <span>黑客商店</span>
                    </div>
                    <div class="modal-message">
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,255,65,0.1); border-radius: 8px; border: 1px solid rgba(0,255,65,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #00ff41; font-weight: bold;">你的資金</div>
                                    <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">$${hacker.money.toLocaleString()}</div>
                                </div>
                                <button class="modal-btn modal-btn-confirm" onclick="showTopupModal()" style="padding: 10px 20px;">
                                    <i class="fas fa-coins"></i> 充值
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-categories">
                            ${categories.map(cat => `
                                <div class="shop-category ${cat === 'stealth' ? 'active' : ''}" onclick="filterShopItems('${cat}')">
                                    ${categoryNames[cat]}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="shop-items-grid" id="shop-items-grid">
                            <!-- 商品將由JavaScript動態生成 -->
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('shop-title').textContent = '黑客商店';
            document.getElementById('shop-message').innerHTML = shopHTML;
            document.getElementById('shop-modal').classList.add('active');
            
            filterShopItems('stealth');
        }

        function openLEShop() {
            const le = GameState.playerData.law_enforcement;
            const categories = ['investigation', 'tracking', 'defense', 'collaboration', 'decryption'];
            const categoryNames = {
                investigation: '調查工具',
                tracking: '追蹤工具',
                defense: '防禦工具',
                collaboration: '協作工具',
                decryption: '解密工具'
            };
            
            let shopHTML = `
                <div class="shop-container">
                    <div class="modal-title">
                        <i class="fas fa-shopping-cart"></i>
                        <span>執法部門商店</span>
                    </div>
                    <div class="modal-message">
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(74,144,217,0.1); border-radius: 8px; border: 1px solid rgba(74,144,217,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #4a90d9; font-weight: bold;">你的預算</div>
                                    <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">$${le.budget.toLocaleString()}</div>
                                </div>
                                <button class="modal-btn modal-btn-confirm" onclick="showTopupModal()" style="padding: 10px 20px;">
                                    <i class="fas fa-coins"></i> 申請額外預算
                                </button>
                            </div>
                        </div>
                        
                        <div class="shop-categories">
                            ${categories.map(cat => `
                                <div class="shop-category ${cat === 'investigation' ? 'active' : ''}" onclick="filterShopItems('${cat}')">
                                    ${categoryNames[cat]}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="shop-items-grid" id="shop-items-grid">
                            <!-- 商品將由JavaScript動態生成 -->
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('shop-title').textContent = '執法部門商店';
            document.getElementById('shop-message').innerHTML = shopHTML;
            document.getElementById('shop-modal').classList.add('active');
            
            filterShopItems('investigation');
        }

        function filterShopItems(category) {
            const shopItemsGrid = document.getElementById('shop-items-grid');
            if (!shopItemsGrid) return;
            
            // 更新分類按鈕活動狀態
            const categoryBtns = document.querySelectorAll('.shop-category');
            categoryBtns.forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const player = GameState.playerData[GameState.currentRole];
            const items = player.shopItems.filter(item => item.category === category);
            
            shopItemsGrid.innerHTML = '';
            
            if (items.length === 0) {
                shopItemsGrid.innerHTML = '<div style="color: #888; text-align: center; padding: 40px; grid-column: 1 / -1;">此分類暫無商品</div>';
                return;
            }
            
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'shop-item';
                itemElement.innerHTML = `
                    <div class="shop-item-header">
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-price">$${item.price}</div>
                    </div>
                    <div class="shop-item-desc">${item.effect}</div>
                    <div class="shop-item-effect">效果: ${item.effect}</div>
                    <button onclick="buyShopItem('${item.id}')" class="modal-btn modal-btn-confirm" style="width: 100%; padding: 10px; ${player[GameState.currentRole === 'hacker' ? 'money' : 'budget'] < item.price ? 'opacity: 0.5; cursor: not-allowed;' : ''}" ${player[GameState.currentRole === 'hacker' ? 'money' : 'budget'] < item.price ? 'disabled' : ''}>
                        購買
                    </button>
                `;
                shopItemsGrid.appendChild(itemElement);
            });
        }

        function buyShopItem(itemId) {
            const player = GameState.playerData[GameState.currentRole];
            const item = player.shopItems.find(i => i.id === itemId);
            
            if (!item) return;
            
            const resourceKey = GameState.currentRole === 'hacker' ? 'money' : 'budget';
            
            if (player[resourceKey] < item.price) {
                showNotification('資金不足', `需要 $${item.price}，但你只有 $${player[resourceKey]}。`, 'warning');
                return;
            }
            
            player[resourceKey] -= item.price;
            addTransaction('purchase', `購買: ${item.name}`, -item.price);
            
            // 應用物品效果
            if (GameState.currentRole === 'hacker') {
                const hacker = player;
                switch(itemId) {
                    case 'vpn_chain':
                        hacker.stealth = Math.min(100, hacker.stealth + 20);
                        break;
                    case 'zero_day':
                        hacker.attackPower += 40;
                        break;
                    case 'crypto_mixer':
                        hacker.stealth += 15;
                        break;
                    case 'ai_evasion':
                        hacker.stealth += 25;
                        hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints - 2);
                        break;
                    case 'memory_attack':
                        hacker.stealth += 15;
                        hacker.attackPower += 30;
                        break;
                    case 'dynamic_proxy':
                        hacker.activeVpnNodes += 4;
                        hacker.stealth += 18;
                        break;
                    case 'bait_server':
                        hacker.stealth += 12;
                        break;
                    case 'fake_fingerprint':
                        hacker.stealth += 22;
                        break;
                    case 'signal_jammer':
                        hacker.signalJamming = true;
                        break;
                    case 'darknet_access':
                        hacker.darknetCredits += 100;
                        break;
                    case 'phishing_kit':
                        hacker.stealth += 10;
                        break;
                    case 'vulnerability_storage':
                        hacker.attackPower += 25;
                        break;
                    case 'encryption_relay':
                        hacker.stealth += 20;
                        break;
                    case 'hardware_spoof':
                        hacker.stealth += 28;
                        hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints - 3);
                        break;
                    case 'node_crippler':
                        hacker.attackPower += 35;
                        break;
                    case 'ransomware':
                        hacker.attackPower += 30;
                        break;
                    case 'traffic_encryptor':
                        hacker.encryptionLevel += 25;
                        hacker.stealth += 15;
                        break;
                    case 'identity_hider':
                        hacker.stealth += 30;
                        hacker.encryptionLevel += 20;
                        break;
                    case 'file_wiper':
                        hacker.stealth += 20;
                        hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints - 3);
                        break;
                    case 'backdoor_implant':
                        hacker.attackPower += 25;
                        hacker.stealth += 15;
                        break;
                }
                
                // 更新UI
                updateGameStats();
                updateSystemDetails();
                updateSystemStatusBars();
                updateAttackDefenseBars();
                updateHealthVisualization();
                
                addTerminalLine(`[商店] 購買了 ${item.name}，效果: ${item.effect}`, 'success');
                
            } else {
                const le = player;
                switch(itemId) {
                    case 'ai_analyst':
                        le.investigationProgress += 15;
                        break;
                    case 'forensic_suite':
                        le.identityLock.technical += 20;
                        le.identityLock.social += 10;
                        break;
                    case 'interpol_access':
                        le.identityLock.social += 25;
                        le.identityLock.physical += 20;
                        break;
                    case 'cyber_swat':
                        le.serverHealth = Math.min(100, le.serverHealth + 30);
                        le.evidenceLibraryHealth = Math.min(100, le.evidenceLibraryHealth + 30);
                        break;
                    case 'digital_sandbox':
                        le.identityLock.technical += 25;
                        break;
                    case 'network_mapper':
                        le.investigationProgress += 12;
                        break;
                    case 'social_analyzer':
                        le.identityLock.social += 22;
                        break;
                    case 'threat_sensor':
                        le.investigationProgress += 18;
                        break;
                    case 'emergency_shutdown':
                        le.serverHealth = Math.min(100, le.serverHealth + 20);
                        break;
                    case 'intercept_key':
                        le.identityLock.technical += 30;
                        break;
                    case 'command_panel':
                        Object.values(le.departments).forEach(dept => {
                            if (dept.active) dept.resources = Math.min(100, dept.resources + 30);
                        });
                        break;
                    case 'signal_blocker':
                        le.signalBlocking = true;
                        break;
                    case 'gps_tracker':
                        le.gpsTracking = true;
                        le.identityLock.physical += 25;
                        break;
                    case 'cctv_access':
                        le.identityLock.physical += 18;
                        break;
                    case 'password_cracker':
                        le.identityLock.technical += 28;
                        break;
                    case 'memory_forensics':
                        le.identityLock.technical += 20;
                        break;
                    case 'blockchain_tracker':
                        le.identityLock.social += 25;
                        le.investigationProgress += 15;
                        break;
                    case 'ai_predictor':
                        le.investigationProgress += 20;
                        break;
                    case 'evidence_protector':
                        le.evidenceLibraryHealth = Math.min(100, le.evidenceLibraryHealth + 25);
                        break;
                    case 'rapid_response':
                        le.serverHealth = Math.min(100, le.serverHealth + 20);
                        le.evidenceLibraryHealth = Math.min(100, le.evidenceLibraryHealth + 20);
                        break;
                }
                
                // 更新UI
                updateGameStats();
                updateSystemDetails();
                updateSystemStatusBars();
                updateAttackDefenseBars();
                updateHealthVisualization();
                
                addTerminalLine(`[商店] 購買了 ${item.name}，效果: ${item.effect}`, 'success');
            }
            
            // 重新過濾商品以更新購買按鈕狀態
            const activeCategory = document.querySelector('.shop-category.active');
            if (activeCategory) {
                filterShopItems(activeCategory.textContent.trim());
            }
        }

        // ===== 充值系統 =====
        function showTopupModal() {
            const player = GameState.currentRole === 'hacker' ? GameState.playerData.hacker : GameState.playerData.law_enforcement;
            const resourceName = GameState.currentRole === 'hacker' ? '資金' : '預算';
            const currencySymbol = GameState.currentRole === 'hacker' ? '$' : '$';
            
            let topupHTML = `
                <div class="modal-title">
                    <i class="fas fa-coins"></i>
                    <span>充值${resourceName}</span>
                </div>
                <div class="modal-message">
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,153,0,0.1); border-radius: 8px; border: 1px solid rgba(255,153,0,0.3);">
                        <div style="text-align: center;">
                            <div style="color: #ff9900; font-weight: bold;">當前${resourceName}</div>
                            <div style="color: #fff; font-size: 1.8rem; font-weight: bold;">${currencySymbol}${player[GameState.currentRole === 'hacker' ? 'money' : 'budget'].toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div class="topup-section">
                        <div style="color: #ff9900; font-weight: bold; margin-bottom: 15px;">選擇充值金額:</div>
                        <div class="topup-options">
                            <div class="topup-option" onclick="processTopup(10000)">
                                <div class="topup-amount">${currencySymbol}10,000</div>
                                <div class="topup-price">快速補充</div>
                            </div>
                            <div class="topup-option" onclick="processTopup(50000)">
                                <div class="topup-amount">${currencySymbol}50,000</div>
                                <div class="topup-price">標準補充</div>
                            </div>
                            <div class="topup-option" onclick="processTopup(100000)">
                                <div class="topup-amount">${currencySymbol}100,000</div>
                                <div class="topup-price">高級補充</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; color: #aaa; font-size: 0.9rem; text-align: center;">
                        注意: 這是模擬充值，不會收取真實貨幣。
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('custom-modal').classList.remove('active')">
                        取消
                    </button>
                </div>
            `;
            
            showCustomModal(`充值${resourceName}`, topupHTML);
        }

        function processTopup(amount) {
            const player = GameState.currentRole === 'hacker' ? GameState.playerData.hacker : GameState.playerData.law_enforcement;
            const resourceKey = GameState.currentRole === 'hacker' ? 'money' : 'budget';
            const resourceName = GameState.currentRole === 'hacker' ? '資金' : '預算';
            
            player[resourceKey] += amount;
            addTransaction('topup', `${resourceName}充值`, amount);
            
            addTerminalLine(`[系統] 成功充值 ${resourceName} $${amount.toLocaleString()}`, 'success');
            showNotification('充值成功', `已成功充值 $${amount.toLocaleString()} ${resourceName}。`, 'success');
            
            document.getElementById('custom-modal').classList.remove('active');
            
            // 如果商店打開，更新顯示
            if (document.getElementById('shop-modal').classList.contains('active')) {
                const activeCategory = document.querySelector('.shop-category.active');
                if (activeCategory) {
                    filterShopItems(activeCategory.textContent.trim());
                }
            }
            
            // 更新遊戲UI
            updateGameStats();
            updateSystemDetails();
        }

        // ===== 交易記錄系統 =====
        function openTransactionHistory() {
            let historyHTML = `
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    <span>交易歷史記錄</span>
                </div>
                <div class="modal-message">
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(74,144,217,0.1); border-radius: 8px; border: 1px solid rgba(74,144,217,0.3);">
                        <div style="text-align: center;">
                            <div style="color: #4a90d9; font-weight: bold;">總交易記錄</div>
                            <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${GameState.transactionHistory.length} 筆</div>
                        </div>
                    </div>
                    
                    <div class="transaction-history">
            `;
            
            if (GameState.transactionHistory.length === 0) {
                historyHTML += `
                    <div style="color: #888; text-align: center; padding: 40px;">
                        暫無交易記錄
                    </div>
                `;
            } else {
                // 顯示最近的交易記錄
                GameState.transactionHistory.slice().reverse().forEach((transaction, index) => {
                    if (index < 20) { // 只顯示最近20條記錄
                        const amountColor = transaction.amount > 0 ? '#00ff41' : transaction.amount < 0 ? '#ff3333' : '#aaa';
                        const amountSign = transaction.amount > 0 ? '+' : '';
                        
                        historyHTML += `
                            <div class="transaction-item">
                                <div>
                                    <div class="transaction-type ${transaction.type}">${transaction.description}</div>
                                    <div class="transaction-time">${transaction.time}</div>
                                </div>
                                <div class="transaction-amount" style="color: ${amountColor};">${amountSign}${transaction.amount !== 0 ? '$' : ''}${transaction.amount !== 0 ? transaction.amount.toLocaleString() : transaction.extraInfo || '0'}</div>
                            </div>
                        `;
                    }
                });
            }
            
            historyHTML += `
                    </div>
                    
                    <div style="margin-top: 20px; color: #aaa; font-size: 0.9rem; text-align: center;">
                        顯示最近20筆交易記錄
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('history-modal').classList.remove('active')">
                        關閉
                    </button>
                </div>
            `;
            
            document.getElementById('history-message').innerHTML = historyHTML;
            document.getElementById('history-modal').classList.add('active');
        }

        function addTransaction(type, description, amount, extraInfo = '') {
            const transaction = {
                id: 'tx_' + Date.now(),
                type: type,
                description: description,
                amount: amount,
                time: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString(),
                extraInfo: extraInfo
            };
            
            GameState.transactionHistory.push(transaction);
            
            // 限制交易記錄數量
            if (GameState.transactionHistory.length > 100) {
                GameState.transactionHistory = GameState.transactionHistory.slice(-100);
            }
        }

        // ===== 逮捕倒計時 =====
        function startArrestCountdown() {
            if (GameState.currentRole !== 'law_enforcement') return;
            
            const le = GameState.playerData.law_enforcement;
            le.arrestCountdown = 180; // 3分鐘倒計時
            
            addTerminalLine(`[系統] 收網行動開始！你有${le.arrestCountdown}秒時間完成拘捕。`, 'alert');
            addTerminalLine(`[任務] 保護指揮中心 (${le.serverHealth}%) 和證據庫 (${le.evidenceLibraryHealth}%)`, 'warning');
            addTerminalLine(`[任務] 防止黑客逃脫 (隱蔽度需保持<90%)`, 'warning');
            
            updateSpecialPanel();
        }

        // ===== AI對手行動 =====
        function aiOpponentAction() {if
            if (!GameState.gameActive) return;
            
            // 根據難度調整AI行動頻率
            let actionChance = 0.3;
            switch(GameState.difficulty) {
                case 'rookie': actionChance = 0.2; break;
                case 'professional': actionChance = 0.3; break;
                case 'elite': actionChance = 0.4; break;
                case 'legendary': actionChance = 0.5; break;
            }
            
            if (Math.random() < actionChance) {
                if (GameState.currentRole === 'hacker') {
                    // AI執法部門行動
                    const le = GameState.opponentData.law_enforcement;
                    const hacker = GameState.playerData.hacker;
                    
                    // 根據難度選擇行動類型
                    const actions = [];
                    if (le.identityLock.technical < 80) actions.push('investigate');
                    if (le.identityLock.social < 80) actions.push('track');
                    if (le.evidenceChain.length < 5) actions.push('evidence');
                    if (le.serverHealth < 70) actions.push('defend');
                    if (hacker.stealth > 60) actions.push('sweep');
                    if (hacker.compromisedDevices.length > 0) actions.push('counter');
                    if (le.analysisToolsHealth < 80) actions.push('repair');
                    
                    if (actions.length > 0) {
                        const action = actions[Math.floor(Math.random() * actions.length)];
                        let message = '';
                        
                        switch(action) {
                            case 'investigate':
                                le.identityLock.technical = Math.min(100, le.identityLock.technical + 10);
                                le.investigationProgress = Math.min(100, le.investigationProgress + 6);
                                message = '[AI執法] 深度技術調查，技術鎖定+10%';
                                break;
                            case 'track':
                                le.identityLock.social = Math.min(100, le.identityLock.social + 9);
                                le.investigationProgress = Math.min(100, le.investigationProgress + 5);
                                message = '[AI執法] 社交網絡追蹤，社交鎖定+9%';
                                break;
                            case 'evidence':
                                const evidenceTypes = GameState.evidenceTypes.filter(e => !e.critical);
                                if (evidenceTypes.length > 0) {
                                    const evidence = evidenceTypes[Math.floor(Math.random() * evidenceTypes.length)];
                                    le.evidenceChain.push({...evidence, contaminated: false});
                                    message = `[AI執法] 收集到新證據: ${evidence.name}`;
                                }
                                break;
                            case 'defend':
                                le.serverHealth = Math.min(100, le.serverHealth + 20);
                                le.evidenceLibraryHealth = Math.min(100, le.evidenceLibraryHealth + 15);
                                message = '[AI執法] 加強系統防護，健康度恢復';
                                break;
                            case 'sweep':
                                if (!le.networkSweepActive) {
                                    le.networkSweepActive = true;
                                    hacker.activeVpnNodes = Math.max(1, hacker.activeVpnNodes - 1);
                                    hacker.stealth = Math.max(0, hacker.stealth - 12);
                                    message = '[AI執法] 發動網絡圍捕，壓縮匿名節點';
                                }
                                break;
                            case 'counter':
                                // 嘗試清除被入侵設備
                                if (hacker.compromisedDevices.length > 0 && Math.random() > 0.7) {
                                    hacker.compromisedDevices.shift();
                                    message = '[AI執法] 發現並清除了被入侵設備';
                                }
                                break;
                            case 'repair':
                                le.analysisToolsHealth = Math.min(100, le.analysisToolsHealth + 25);
                                message = '[AI執法] 修復分析工具，效率恢復';
                                break;
                        }
                        
                        if (message) {
                            addTerminalLine(message, 'warning');
                        }
                        
                        // 檢查是否達到逮捕條件
                        if (le.identityLock.technical >= 80 && le.identityLock.social >= 80 && le.identityLock.physical >= 80 && 
                            le.evidenceChain.filter(e => e.critical).length >= 3 && !le.warrantIssued) {
                            le.warrantIssued = true;
                            addTerminalLine('[AI執法] 已自動申請逮捕令！收網行動開始。', 'alert');
                            startArrestCountdown();
                        }
                    }
                    
                } else {
                    // AI黑客行動
                    const hacker = GameState.opponentData.hacker;
                    const le = GameState.playerData.law_enforcement;
                    
                    // 根據遊戲狀態選擇行動
                    const actions = [];
                    if (hacker.stealth < 80) actions.push('stealth');
                    if (le.warrantIssued) actions.push('counter', 'attack');
                    if (le.serverHealth > 50) actions.push('attack');
                    if (le.evidenceChain.length > 3) actions.push('counter');
                    if (le.investigationProgress > 40) actions.push('infiltrate');
                    if (le.networkSweepActive) actions.push('evade');
                    if (hacker.serverHealth < 70) actions.push('repair');
                    
                    if (actions.length > 0) {
                        const action = actions[Math.floor(Math.random() * actions.length)];
                        let message = '';
                        
                        switch(action) {
                            case 'stealth':
                                hacker.stealth = Math.min(100, hacker.stealth + 12);
                                hacker.digitalFootprints = Math.max(0, hacker.digitalFootprints - 1);
                                message = '[AI黑客] 深度隱蔽行動，隱蔽度+12%';
                                break;
                            case 'attack':
                                if (Math.random() > 0.5) {
                                    // 攻擊伺服器
                                    le.serverHealth = Math.max(0, le.serverHealth - 15);
                                    message = '[AI黑客] 強力攻擊指揮中心，健康度-15%';
                                } else {
                                    // 攻擊證據庫
                                    le.evidenceLibraryHealth = Math.max(0, le.evidenceLibraryHealth - 20);
                                    message = '[AI黑客] 攻擊證據庫，健康度-20%';
                                }
                                hacker.stealth = Math.max(0, hacker.stealth - 10);
                                hacker.digitalFootprints += 3;
                                break;
                            case 'counter':
                                hacker.compromisedEvidence++;
                                // 污染玩家證據
                                if (le.evidenceChain.length > 0) {
                                    const randomIndex = Math.floor(Math.random() * le.evidenceChain.length);
                                    le.evidenceChain[randomIndex].contaminated = true;
                                    // 從關鍵證據中移除
                                    if (le.evidenceChain[randomIndex].critical) {
                                        const index = le.criticalEvidence.indexOf(le.evidenceChain[randomIndex].id);
                                        if (index > -1) le.criticalEvidence.splice(index, 1);
                                    }
                                    message = '[AI黑客] 深度污染證據，證據有效性降低';
                                }
                                break;
                            case 'infiltrate':
                                // 嘗試入侵設備
                                if (Math.random() > 0.6) {
                                    const deviceType = GameState.deviceTypes[Math.floor(Math.random() * GameState.deviceTypes.length)];
                                    hacker.compromisedDevices = hacker.compromisedDevices || [];
                                    hacker.compromisedDevices.push({...deviceType, accessLevel: 'limited'});
                                    message = `[AI黑客] 入侵設備: ${deviceType.name}`;
                                }
                                break;
                            case 'evade':
                                // 逃避網絡圍捕
                                if (le.networkSweepActive) {
                                    hacker.activeVpnNodes++;
                                    hacker.stealth += 8;
                                    message = '[AI黑客] 逃避網絡圍捕，恢復隱蔽度';
                                }
                                break;
                            case 'repair':
                                hacker.serverHealth = Math.min(100, hacker.serverHealth + 20);
                                hacker.deviceHealth = Math.min(100, hacker.deviceHealth + 15);
                                message = '[AI黑客] 修復系統，健康度恢復';
                                break;
                        }
                        
                        if (message) {
                            addTerminalLine(message, 'warning');
                        }
                    }
                }
                
                // 更新UI
                updateTargetRealtimeInfo();
                updateAttackDefenseBars();
                updateHealthVisualization();
                updateSpecialPanel();
            }
        }

        // ===== 終端系統 =====
        function addTerminalLine(text, type = 'system') {
            const terminalOutput = document.getElementById('terminal-output');
            if (!terminalOutput) return;
            
            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            line.textContent = text;
            
            terminalOutput.appendChild(line);
            
            // 自動滾動到底部
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
            
            // 限制行數
            const lines = terminalOutput.querySelectorAll('.terminal-line');
            if (lines.length > 50) {
                lines[0].remove();
            }
        }

        function executeCommand(command) {
            addTerminalLine(`${GameState.currentRole === 'hacker' ? 'root@shadow:~#' : 'investigator@le:~#'} ${command}`, 'command');
            
            const cmd = command.toLowerCase();
            
            if (cmd === 'help' || cmd === '?') {
                addTerminalLine('[幫助] 可用指令:', 'system');
                addTerminalLine('  status - 顯示當前狀態', 'system');
                addTerminalLine('  clear - 清除終端內容', 'system');
                addTerminalLine('  tools - 顯示可用工具列表', 'system');
                addTerminalLine('  connect - 連接目標', 'system');
                addTerminalLine('  disconnect - 斷開連接', 'system');
                addTerminalLine('  shop - 打開商店', 'system');
                addTerminalLine('  history - 查看交易記錄', 'system');
                addTerminalLine('  missions - 查看任務目標', 'system');
                if (GameState.currentRole === 'law_enforcement') {
                    addTerminalLine('  report - 生成調查報告', 'system');
                    addTerminalLine('  verify - 驗證情報', 'system');
                }
                if (GameState.currentRole === 'hacker') {
                    addTerminalLine('  darknet - 訪問暗網市場', 'system');
                    addTerminalLine('  decrypt - 解密密文件', 'system');
                }
            } else if (cmd === 'status') {
                if (GameState.currentRole === 'hacker') {
                    const hacker = GameState.playerData.hacker;
                    addTerminalLine('[狀態] 黑客狀態:', 'system');
                    addTerminalLine(`  資金: $${hacker.money.toLocaleString()}`, 'system');
                    addTerminalLine(`  隱蔽度: ${hacker.stealth}%`, 'system');
                    addTerminalLine(`  加密等級: ${hacker.encryptionLevel}%`, 'system');
                    addTerminalLine(`  數碼足跡: ${hacker.digitalFootprints}`, 'system');
                    addTerminalLine(`  攻擊力: ${hacker.attackPower}`, 'system');
                    addTerminalLine(`  VPN節點: ${hacker.activeVpnNodes}`, 'system');
                    addTerminalLine(`  入侵設備: ${hacker.compromisedDevices.length}`, 'system');
                    addTerminalLine(`  解密進度: ${hacker.decryptionProgress}分`, 'system');
                    addTerminalLine(`  暗網積分: ${hacker.darknetCredits}`, 'system');
                    addTerminalLine(`  伺服器健康: ${hacker.serverHealth}%`, 'system');
                    addTerminalLine(`  設備健康: ${hacker.deviceHealth}%`, 'system');
                } else {
                    const le = GameState.playerData.law_enforcement;
                    addTerminalLine('[狀態] 執法部門狀態:', 'system');
                    addTerminalLine(`  預算: $${le.budget.toLocaleString()}`, 'system');
                    addTerminalLine(`  調查進度: ${le.investigationProgress}%`, 'system');
                    addTerminalLine(`  身份鎖定: 技術${le.identityLock.technical}% 社交${le.identityLock.social}% 實體${le.identityLock.physical}%`, 'system');
                    addTerminalLine(`  關鍵證據: ${le.criticalEvidence.length}/3`, 'system');
                    addTerminalLine(`  伺服器健康: ${le.serverHealth}%`, 'system');
                    addTerminalLine(`  證據庫健康: ${le.evidenceLibraryHealth}%`, 'system');
                    addTerminalLine(`  分析工具健康: ${le.analysisToolsHealth}%`, 'system');
                    addTerminalLine(`  動態情報: ${le.dynamicIntel.length}條待驗證`, 'system');
                    addTerminalLine(`  已驗證情報: ${le.verifiedIntel.length}條`, 'system');
                }
            } else if (cmd === 'clear') {
                const terminalOutput = document.getElementById('terminal-output');
                if (terminalOutput) terminalOutput.innerHTML = '';
            } else if (cmd === 'tools') {
                addTerminalLine('[工具] 請使用工具面板中的分類查看和選擇工具。', 'system');
            } else if (cmd === 'connect') {
                connectToTarget();
            } else if (cmd === 'disconnect') {
                disconnectFromTarget();
            } else if (cmd === 'shop') {
                openShop();
            } else if (cmd === 'history') {
                openTransactionHistory();
            } else if (cmd === 'missions') {
                showMissionStatus();
            } else if (cmd === 'report' && GameState.currentRole === 'law_enforcement') {
                generateInvestigationReport();
            } else if (cmd === 'verify' && GameState.currentRole === 'law_enforcement') {
                verifyIntel();
            } else if (cmd === 'darknet' && GameState.currentRole === 'hacker') {
                accessDarknetMarket();
            } else if (cmd === 'decrypt' && GameState.currentRole === 'hacker') {
                const hacker = GameState.playerData.hacker;
                if (hacker.stolenDocuments.length > 0) {
                    const doc = hacker.stolenDocuments[0];
                    if (doc.encrypted && !doc.decrypted) {
                        doc.decryptionProgress += 33;
                        if (doc.decryptionProgress >= 100) {
                            doc.decrypted = true;
                            hacker.decryptionProgress += doc.value;
                            addTerminalLine(`[解密] 成功解密文件: ${doc.name}，獲得${doc.value}分`, 'success');
                            updateMissionList();
                        } else {
                            addTerminalLine(`[解密] ${doc.name} 解密進度: ${doc.decryptionProgress}%`, 'system');
                        }
                        updateSpecialPanel();
                    } else {
                        addTerminalLine('[解密] 沒有需要解密的加密文件', 'error');
                    }
                } else {
                    addTerminalLine('[解密] 沒有需要解密的文件', 'error');
                }
            } else {
                addTerminalLine(`[錯誤] 未知指令: ${command}。輸入 "help" 查看可用指令。`, 'error');
            }
        }

        function showMissionStatus() {
            const missions = GameState.missions[GameState.currentRole];
            addTerminalLine('[任務狀態] ================', 'system');
            missions.forEach(mission => {
                const statusIcon = mission.status === 'complete' ? '✅' : '🟡';
                addTerminalLine(`  ${statusIcon} ${mission.name}`, 'system');
            });
            addTerminalLine('[任務結束] ================', 'system');
        }

        function generateInvestigationReport() {
            const le = GameState.playerData.law_enforcement;
            
            addTerminalLine('[調查報告] ================', 'system');
            addTerminalLine(`生成時間: ${new Date().toLocaleString()}`, 'system');
            addTerminalLine(`調查進度: ${le.investigationProgress}%`, 'system');
            addTerminalLine(`身份鎖定進度:`, 'system');
            addTerminalLine(`  技術鎖定: ${le.identityLock.technical}% ${le.identityLock.technical >= 80 ? '✅ 達成' : '❌ 未達成'}`, 'system');
            addTerminalLine(`  社交鎖定: ${le.identityLock.social}% ${le.identityLock.social >= 80 ? '✅ 達成' : '❌ 未達成'}`, 'system');
            addTerminalLine(`  實體鎖定: ${le.identityLock.physical}% ${le.identityLock.physical >= 80 ? '✅ 達成' : '❌ 未達成'}`, 'system');
            addTerminalLine(`證據收集狀況:`, 'system');
            addTerminalLine(`  總證據數: ${le.evidenceChain.length}`, 'system');
            addTerminalLine(`  關鍵證據: ${le.criticalEvidence.length}/3 ${le.criticalEvidence.length >= 3 ? '✅ 達成' : '❌ 未達成'}`, 'system');
            addTerminalLine(`  受污染證據: ${le.evidenceChain.filter(e => e.contaminated).length}`, 'system');
            addTerminalLine(`系統狀態:`, 'system');
            addTerminalLine(`  指揮中心健康: ${le.serverHealth}%`, 'system');
            addTerminalLine(`  證據庫健康: ${le.evidenceLibraryHealth}%`, 'system');
            addTerminalLine(`  分析工具健康: ${le.analysisToolsHealth}%`, 'system');
            addTerminalLine(`  網絡圍捕: ${le.networkSweepActive ? '✅ 進行中' : '❌ 未激活'}`, 'system');
            addTerminalLine(`  GPS追蹤: ${le.gpsTracking ? '✅ 激活' : '❌ 未激活'}`, 'system');
            addTerminalLine(`  信號防護: ${le.signalBlocking ? '✅ 激活' : '❌ 未激活'}`, 'system');
            addTerminalLine(`情報系統:`, 'system');
            addTerminalLine(`  動態情報: ${le.dynamicIntel.length}條`, 'system');
            addTerminalLine(`  已驗證情報: ${le.verifiedIntel.length}條`, 'system');
            addTerminalLine(`部門協作:`, 'system');
            Object.values(le.departments).forEach(dept => {
                addTerminalLine(`  ${dept.name}: ${dept.active ? '✅ 活動中' : '❌ 未啟動'} (資源: ${dept.resources}%)`, 'system');
            });
            addTerminalLine(`逮捕令狀態: ${le.warrantIssued ? '✅ 已簽發' : '❌ 未簽發'}`, 'system');
            addTerminalLine('[報告結束] ================', 'system');
        }

        // ===== 連接管理 =====
        function connectToTarget() {
            if (GameState.connectionStatus === 'connected') {
                showNotification('已連接', '已經連接到目標系統。', 'system');
                return;
            }
            
            GameState.connectionStatus = 'connecting';
            addTerminalLine('[系統] 正在連接目標系統...', 'system');
            
            setTimeout(() => {
                GameState.connectionStatus = 'connected';
                addTerminalLine('[系統] 成功連接到目標系統！', 'success');
                
                const statusIndicator = document.querySelector('.status-indicator
                                                               // ===== 通知系統 =====
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const titleElement = document.getElementById('notification-title-text');
            const messageElement = document.getElementById('notification-message');
            const iconElement = notification.querySelector('.notification-title i');
            
            notification.className = 'notification';
            notification.classList.add(type);
            
            // 設置圖標
            let iconClass = 'fas fa-info-circle';
            if (type === 'hacker') iconClass = 'fas fa-user-secret';
            else if (type === 'law_enforcement') iconClass = 'fas fa-shield-alt';
            else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            else if (type === 'danger') iconClass = 'fas fa-skull-crossbones';
            else if (type === 'success') iconClass = 'fas fa-check-circle';
            
            iconElement.className = iconClass;
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            notification.classList.add('show');
            
            // 5秒後自動隱藏
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function showCustomModal(title, content, onConfirm = null, onCancel = null) {
            document.getElementById('modal-title-text').textContent = title;
            document.getElementById('modal-message').innerHTML = content;
            
            const modal = document.getElementById('custom-modal');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            const input = document.getElementById('modal-input');
            
            // 默認隱藏輸入框
            input.style.display = 'none';
            
            // 設置確認按鈕
            if (onConfirm) {
                confirmBtn.style.display = 'block';
                confirmBtn.onclick = () => {
                    onConfirm();
                    modal.classList.remove('active');
                };
            } else {
                confirmBtn.style.display = 'none';
            }
            
            // 設置取消按鈕
            if (onCancel) {
                cancelBtn.style.display = 'block';
                cancelBtn.onclick = () => {
                    onCancel();
                    modal.classList.remove('active');
                };
            } else {
                cancelBtn.style.display = 'block';
                cancelBtn.onclick = () => modal.classList.remove('active');
            }
            
            modal.classList.add('active');
        }

        // ===== 初始化 =====
        window.onload = function() {
            // 初始設置
            updateNavActive();
            
            // 預設一些通知
            setTimeout(() => {
                showNotification('歡迎來到對戰模式第二季', '選擇你的角色，開始這場黑客與執法部門的對決！', 'info');
            }, 1000);
        };

        console.log('對戰模式第二季 • 執法對決 SEASON 2 加載完成！');
        console.log('© 2025 Sam. T. 版權所有');
    </script>
</body>
</html>
